{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/client.ts"],"sourcesContent":["import { Pool } from 'pg';\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,\n});\n\nexport async function query<T = any>(text: string, params?: any[]): Promise<T[]> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rows as T[];\n  } finally {\n    client.release();\n  }\n}\n\nexport async function queryOne<T = any>(text: string, params?: any[]): Promise<T | null> {\n  const rows = await query<T>(text, params);\n  return rows[0] || null;\n}\n\nexport async function execute(text: string, params?: any[]): Promise<number> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rowCount || 0;\n  } finally {\n    client.release();\n  }\n}\n\nexport { pool };\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,sCAAwC,0BAAgC;AAC/E;AAEO,eAAe,MAAe,IAAY,EAAE,MAAc;IAC/D,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,IAAI;IACpB,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe,SAAkB,IAAY,EAAE,MAAc;IAClE,MAAM,OAAO,MAAM,MAAS,MAAM;IAClC,OAAO,IAAI,CAAC,EAAE,IAAI;AACpB;AAEO,eAAe,QAAQ,IAAY,EAAE,MAAc;IACxD,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,QAAQ,IAAI;IAC5B,SAAU;QACR,OAAO,OAAO;IAChB;AACF"}},
    {"offset": {"line": 108, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/admin/invoices/route.ts"],"sourcesContent":["import { query } from \"@/lib/db/client\"\nimport { NextResponse } from \"next/server\"\n\nexport async function GET(request: Request) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const status = searchParams.get(\"status\")\n    const vendorId = searchParams.get(\"vendor_id\")\n\n    let sql = `\n      SELECT \n        i.*,\n        v.name as merchant_name,\n        b.name as branch_name,\n        u.username as created_by_username\n      FROM invoices i\n      LEFT JOIN vendors v ON v.id = i.vendor_id\n      LEFT JOIN branches b ON b.id = i.branch_id\n      LEFT JOIN users u ON u.id = i.created_by\n      WHERE 1=1\n    `\n    const params: any[] = []\n    let paramIndex = 1\n\n    if (status) {\n      sql += ` AND i.status = $${paramIndex}`\n      params.push(status)\n      paramIndex++\n    }\n\n    if (vendorId) {\n      sql += ` AND i.vendor_id = $${paramIndex}`\n      params.push(vendorId)\n      paramIndex++\n    }\n\n    sql += \" ORDER BY i.created_at DESC\"\n\n    const invoices = await query(sql, params)\n\n    return NextResponse.json(invoices)\n  } catch (error: any) {\n    console.error(\"[Admin] Error fetching invoices:\", error)\n    return NextResponse.json({ error: error.message }, { status: 500 })\n  }\n}\n\nexport async function POST(request: Request) {\n  try {\n    const body = await request.json()\n    const { vendor_id, branch_id, issue_date, due_date, notes, line_items, created_by } = body\n\n    if (!vendor_id) {\n      return NextResponse.json({ error: \"Vendor is required\" }, { status: 400 })\n    }\n\n    const invoiceNumber = `INV-${new Date().getFullYear()}-${Date.now().toString().slice(-6)}`\n    \n    let subtotal = 0\n    if (line_items && Array.isArray(line_items)) {\n      subtotal = line_items.reduce((sum: number, item: any) => {\n        const lineSubtotal = item.quantity * item.unit_price\n        const discountAmount = lineSubtotal * ((item.discount || 0) / 100)\n        return sum + (lineSubtotal - discountAmount)\n      }, 0)\n    }\n    const taxAmount = subtotal * 0.16\n    const totalAmount = subtotal + taxAmount\n\n    const result = await query(\n      `INSERT INTO invoices (invoice_number, vendor_id, branch_id, issue_date, due_date, subtotal, tax_amount, total_amount, notes, created_by)\n       VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)\n       RETURNING *`,\n      [invoiceNumber, vendor_id, branch_id, issue_date || new Date(), due_date, subtotal, taxAmount, totalAmount, notes, created_by]\n    )\n\n    const invoice = result[0]\n\n    if (line_items && Array.isArray(line_items)) {\n      for (const item of line_items) {\n        const lineSubtotal = item.quantity * item.unit_price\n        const discountAmount = lineSubtotal * ((item.discount || 0) / 100)\n        const lineAmount = lineSubtotal - discountAmount\n        await query(\n          `INSERT INTO invoice_line_items (invoice_id, description, quantity, unit_price, tax_rate, amount, discount)\n           VALUES ($1, $2, $3, $4, $5, $6, $7)`,\n          [invoice.id, item.description, item.quantity, item.unit_price, item.tax_rate || 16, lineAmount, item.discount || 0]\n        )\n      }\n    }\n\n    const vendorResult = await query(`SELECT name, email FROM vendors WHERE id = $1`, [vendor_id])\n    const vendor = vendorResult[0]\n\n    if (vendor) {\n      const userResult = await query(`SELECT id FROM users WHERE email = $1`, [vendor.email])\n      const vendorUser = userResult[0]\n      \n      if (vendorUser) {\n        await query(\n          `INSERT INTO notifications (user_id, type, title, message, reference_id)\n           VALUES ($1, $2, $3, $4, $5)`,\n          [\n            vendorUser.id,\n            'invoice',\n            'New Invoice',\n            `Invoice ${invoiceNumber} for KES ${totalAmount.toLocaleString()} has been created`,\n            invoice.id\n          ]\n        )\n      }\n    }\n\n    await query(\n      `INSERT INTO notifications (user_id, type, title, message, reference_id)\n       VALUES (NULL, $1, $2, $3, $4)`,\n      [\n        'invoice',\n        'Invoice Created',\n        `Invoice ${invoiceNumber} for ${vendor?.name || 'Unknown'} - KES ${totalAmount.toLocaleString()}`,\n        invoice.id\n      ]\n    )\n\n    return NextResponse.json(invoice)\n  } catch (error: any) {\n    console.error(\"[Admin] Error creating invoice:\", error)\n    return NextResponse.json({ error: error.message }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}