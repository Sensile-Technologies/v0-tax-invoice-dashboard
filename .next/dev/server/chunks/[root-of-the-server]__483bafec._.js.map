{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 110, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/receipt/image/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\nimport puppeteer from \"puppeteer\"\nimport QRCode from \"qrcode\"\nimport { execSync } from \"child_process\"\n\nfunction getChromiumPath(): string {\n  if (process.env.PUPPETEER_EXECUTABLE_PATH) {\n    return process.env.PUPPETEER_EXECUTABLE_PATH\n  }\n  try {\n    const path = execSync('which chromium').toString().trim()\n    if (path) return path\n  } catch {}\n  try {\n    const path = execSync('which chromium-browser').toString().trim()\n    if (path) return path\n  } catch {}\n  try {\n    const path = execSync('which google-chrome').toString().trim()\n    if (path) return path\n  } catch {}\n  return '/usr/bin/chromium'\n}\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nfunction generateReceiptHTML(sale: any, qrCodeDataUrl: string): string {\n  const unitPrice = parseFloat(sale.unit_price) || 0\n  const quantity = parseFloat(sale.quantity) || 0\n  const totalAmount = parseFloat(sale.total_amount) || 0\n  const discountAmount = parseFloat(sale.discount_amount) || 0\n  const taxableAmount = totalAmount / 1.16\n  const vatAmount = totalAmount - taxableAmount\n  \n  const saleDate = new Date(sale.sale_date)\n  const dateStr = saleDate.toLocaleDateString('en-KE', { year: 'numeric', month: '2-digit', day: '2-digit' })\n  const timeStr = saleDate.toLocaleTimeString('en-KE', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false })\n  \n  const co2PerLitre = sale.fuel_type?.toLowerCase().includes('diesel') ? 2.68 : 2.31\n  const totalCo2 = quantity * co2PerLitre\n  \n  const kraPin = sale.kra_pin || 'P052344628B'\n  \n  const receiptNo = sale.kra_cu_inv?.split('/')[1] || sale.invoice_number?.replace('INV-', '') || String(sale.id).substring(0, 8)\n\n  return `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"UTF-8\">\n  <style>\n    * { margin: 0; padding: 0; box-sizing: border-box; }\n    body {\n      font-family: 'Courier New', monospace;\n      font-size: 14px;\n      line-height: 1.4;\n      width: 384px;\n      background: white;\n      color: black;\n      padding: 8px;\n    }\n    .center { text-align: center; }\n    .bold { font-weight: bold; }\n    .header { font-size: 18px; font-weight: bold; margin-bottom: 6px; }\n    .shop-name { font-size: 16px; font-weight: bold; margin-bottom: 4px; }\n    .divider { border-top: 1px dashed #000; margin: 8px 0; }\n    .row { display: flex; justify-content: space-between; margin: 3px 0; }\n    .label { width: 40%; }\n    .value { width: 58%; text-align: left; }\n    .section-title { font-weight: bold; text-align: center; margin: 6px 0; font-size: 13px; }\n    .tax-table { width: 100%; font-size: 12px; margin: 6px 0; }\n    .tax-table th, .tax-table td { text-align: left; padding: 2px 4px; }\n    .qr-section { text-align: center; margin: 10px 0; }\n    .qr-section img { width: 180px; height: 180px; }\n    .qr-label { font-size: 11px; margin-top: 4px; }\n    .footer { font-size: 12px; text-align: center; margin-top: 8px; }\n    .total-row { font-weight: bold; font-size: 16px; }\n  </style>\n</head>\n<body>\n  <div class=\"center header\">TAX INVOICE</div>\n  <div class=\"center shop-name\">${sale.branch_name || 'Flow360 Station'}</div>\n  ${sale.branch_address ? `<div class=\"center\">${sale.branch_address}</div>` : ''}\n  ${sale.branch_phone ? `<div class=\"center\">Tel: ${sale.branch_phone}</div>` : ''}\n  <div class=\"center bold\">PIN: ${kraPin}</div>\n  \n  <div class=\"divider\"></div>\n  <div class=\"center\" style=\"font-size: 12px;\">Welcome to our shop</div>\n  <div class=\"divider\"></div>\n  \n  <div class=\"section-title\">BUYER INFORMATION</div>\n  <div class=\"row\"><span class=\"label\">Buyer PIN:</span><span class=\"value\">${sale.customer_pin || 'NOT PROVIDED'}</span></div>\n  <div class=\"row\"><span class=\"label\">Buyer Name:</span><span class=\"value\">${sale.customer_name || 'Walk-in Customer'}</span></div>\n  \n  <div class=\"divider\"></div>\n  <div class=\"section-title\">PRODUCT DETAILS</div>\n  <div class=\"row\"><span class=\"label\">Item Code:</span><span class=\"value\">${sale.item_code || sale.fuel_type || 'N/A'}</span></div>\n  <div class=\"row\"><span class=\"label\">Description:</span><span class=\"value\">${sale.item_name || sale.fuel_type || 'Fuel'}</span></div>\n  <div class=\"row\"><span class=\"label\">Dispenser:</span><span class=\"value\">D${sale.dispenser_number || '0'}N${sale.nozzle_number || '1'}</span></div>\n  <div class=\"row\"><span class=\"label\">Unit Price:</span><span class=\"value\">KES ${unitPrice.toFixed(2)}</span></div>\n  <div class=\"row\"><span class=\"label\">Quantity:</span><span class=\"value\">${quantity.toFixed(3)} L</span></div>\n  <div class=\"row\"><span class=\"label\">Discount:</span><span class=\"value\">(${discountAmount.toFixed(2)})</span></div>\n  <div class=\"row total-row\"><span class=\"label\">Total:</span><span class=\"value\">KES ${totalAmount.toFixed(2)}</span></div>\n  \n  <div class=\"divider\"></div>\n  <div class=\"section-title\">TAX BREAKDOWN</div>\n  <table class=\"tax-table\">\n    <tr><th>Rate</th><th>Taxable</th><th>VAT</th></tr>\n    <tr><td>EX</td><td>KES 0.00</td><td>KES 0.00</td></tr>\n    <tr><td>16%</td><td>KES ${taxableAmount.toFixed(2)}</td><td>KES ${vatAmount.toFixed(2)}</td></tr>\n    <tr><td>0%</td><td>KES 0.00</td><td>KES 0.00</td></tr>\n  </table>\n  \n  <div class=\"divider\"></div>\n  <div class=\"row\"><span class=\"label\">Date:</span><span class=\"value\">${dateStr}</span></div>\n  <div class=\"row\"><span class=\"label\">Time:</span><span class=\"value\">${timeStr}</span></div>\n  \n  <div class=\"divider\"></div>\n  <div class=\"row\" style=\"font-size: 12px;\"><span class=\"label\">SCU ID:</span><span class=\"value\">${sale.kra_scu_id || 'N/A'}</span></div>\n  <div class=\"row\" style=\"font-size: 12px;\"><span class=\"label\">CU INV NO:</span><span class=\"value\">${sale.kra_cu_inv || 'N/A'}</span></div>\n  <div class=\"row\" style=\"font-size: 12px;\"><span class=\"label\">Internal Data:</span><span class=\"value\">${sale.kra_internal_data || sale.invoice_number || 'N/A'}</span></div>\n  \n  <div class=\"divider\"></div>\n  <div class=\"section-title\">KRA eTIMS Verification</div>\n  <div class=\"qr-section\">\n    <img src=\"${qrCodeDataUrl}\" alt=\"QR Code\" />\n    <div class=\"qr-label\">Scan to verify with KRA eTIMS</div>\n  </div>\n  \n  <div class=\"divider\"></div>\n  <div class=\"row\"><span class=\"label\">Receipt No:</span><span class=\"value\">${receiptNo}</span></div>\n  <div class=\"row\"><span class=\"label\">Served by:</span><span class=\"value\">${sale.cashier_name || 'System'}</span></div>\n  <div class=\"row\"><span class=\"label\">Payment:</span><span class=\"value\">${sale.payment_method || 'Cash'}</span></div>\n  \n  <div class=\"divider\"></div>\n  <div class=\"section-title\">Carbon Emission Details</div>\n  <div class=\"row\"><span class=\"label\">CO2 Per Litre:</span><span class=\"value\">${co2PerLitre.toFixed(2)} kg</span></div>\n  <div class=\"row\"><span class=\"label\">Total CO2:</span><span class=\"value\">${totalCo2.toFixed(2)} kg</span></div>\n  \n  <div class=\"divider\"></div>\n  <div class=\"footer bold\">THANK YOU FOR SHOPPING WITH US</div>\n  <div class=\"footer\">Powered by Flow360</div>\n  <div class=\"divider\"></div>\n  <div class=\"footer bold\">END OF LEGAL RECEIPT</div>\n</body>\n</html>\n`\n}\n\nexport async function POST(request: Request) {\n  try {\n    const body = await request.json()\n    const { sale_id, branch_id } = body\n\n    if (!sale_id || !branch_id) {\n      return NextResponse.json({ error: \"Missing sale_id or branch_id\" }, { status: 400 })\n    }\n\n    const client = await pool.connect()\n    try {\n      const saleResult = await client.query(\n        `SELECT s.*, b.name as branch_name, b.kra_pin, b.bhf_id, b.address as branch_address,\n                b.phone as branch_phone,\n                n.nozzle_number, d.dispenser_number,\n                i.item_name, i.item_code\n         FROM sales s\n         LEFT JOIN branches b ON s.branch_id = b.id\n         LEFT JOIN nozzles n ON s.nozzle_id = n.id\n         LEFT JOIN dispensers d ON n.dispenser_id = d.id\n         LEFT JOIN items i ON UPPER(s.fuel_type) = UPPER(i.item_name) AND i.branch_id = s.branch_id\n         WHERE s.id = $1`,\n        [sale_id]\n      )\n\n      if (saleResult.rows.length === 0) {\n        return NextResponse.json({ error: \"Sale not found\" }, { status: 404 })\n      }\n\n      const sale = saleResult.rows[0]\n      \n      const kraPin = sale.kra_pin || 'P052344628B'\n      const bhfId = sale.bhf_id || '03'\n      const rcptSign = sale.kra_rcpt_sign || ''\n      const qrData = `${kraPin}${bhfId}${rcptSign}`\n      const qrUrl = `https://etims-sbx.kra.go.ke/common/link/etims/receipt/indexEtimsReceiptData?Data=${qrData}`\n      \n      const qrCodeDataUrl = await QRCode.toDataURL(qrUrl, {\n        width: 200,\n        margin: 1,\n        errorCorrectionLevel: 'M'\n      })\n      \n      const html = generateReceiptHTML(sale, qrCodeDataUrl)\n      \n      const chromiumPath = getChromiumPath()\n      console.log('[Receipt Image API] Using Chromium at:', chromiumPath)\n      \n      const browser = await puppeteer.launch({\n        headless: true,\n        executablePath: chromiumPath,\n        args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage', '--disable-gpu']\n      })\n      \n      const page = await browser.newPage()\n      await page.setViewport({ width: 384, height: 800 })\n      await page.setContent(html, { waitUntil: 'networkidle0' })\n      \n      const bodyHandle = await page.$('body')\n      const boundingBox = await bodyHandle?.boundingBox()\n      await bodyHandle?.dispose()\n      \n      const height = boundingBox ? Math.ceil(boundingBox.height) + 20 : 800\n      \n      await page.setViewport({ width: 384, height })\n      \n      const screenshotBuffer = await page.screenshot({\n        type: 'png',\n        fullPage: true,\n        omitBackground: false\n      })\n      \n      await browser.close()\n      \n      const base64Image = Buffer.from(screenshotBuffer).toString('base64')\n\n      return NextResponse.json({\n        success: true,\n        receipt_image: base64Image,\n        content_type: 'image/png',\n        width: 384,\n        sale_id: sale_id,\n        invoice_number: sale.invoice_number\n      })\n    } finally {\n      client.release()\n    }\n  } catch (error: any) {\n    console.error(\"[Receipt Image API Error]:\", error)\n    return NextResponse.json({ error: error.message || \"Failed to generate receipt image\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}