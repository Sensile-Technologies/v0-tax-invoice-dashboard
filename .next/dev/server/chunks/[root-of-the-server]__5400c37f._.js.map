{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/client.ts"],"sourcesContent":["import { Pool } from 'pg';\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,\n});\n\nexport async function query<T = any>(text: string, params?: any[]): Promise<T[]> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rows as T[];\n  } finally {\n    client.release();\n  }\n}\n\nexport async function queryOne<T = any>(text: string, params?: any[]): Promise<T | null> {\n  const rows = await query<T>(text, params);\n  return rows[0] || null;\n}\n\nexport async function execute(text: string, params?: any[]): Promise<number> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rowCount || 0;\n  } finally {\n    client.release();\n  }\n}\n\nexport async function getClient() {\n  return await pool.connect();\n}\n\nexport { pool };\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,sCAAwC,0BAAgC;AAC/E;AAEO,eAAe,MAAe,IAAY,EAAE,MAAc;IAC/D,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,IAAI;IACpB,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe,SAAkB,IAAY,EAAE,MAAc;IAClE,MAAM,OAAO,MAAM,MAAS,MAAM;IAClC,OAAO,IAAI,CAAC,EAAE,IAAI;AACpB;AAEO,eAAe,QAAQ,IAAY,EAAE,MAAc;IACxD,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,QAAQ,IAAI;IAC5B,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe;IACpB,OAAO,MAAM,KAAK,OAAO;AAC3B"}},
    {"offset": {"line": 113, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/index.ts"],"sourcesContent":["export * from './client';\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 127, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/api-logger.ts"],"sourcesContent":["import { query } from \"@/lib/db\"\n\nexport interface ApiLogEntry {\n  endpoint: string\n  method: string\n  payload?: any\n  response?: any\n  statusCode?: number\n  error?: string\n  durationMs?: number\n  branchId?: string\n  externalEndpoint?: string\n  logType?: string\n}\n\nfunction deriveLogType(endpoint: string): string {\n  if (endpoint.includes('saveSales')) return 'kra_save_sales'\n  if (endpoint.includes('saveStockItems')) return 'kra_stock_items'\n  if (endpoint.includes('saveStockMaster')) return 'kra_stock_master'\n  if (endpoint.includes('selectInitInfo')) return 'kra_initialize'\n  if (endpoint.includes('saveItem')) return 'kra_save_item'\n  return 'kra_api'\n}\n\nfunction deriveStatus(response: any, statusCode?: number, error?: string): string {\n  if (error) return 'error'\n  if (!response) return 'error'\n  if (response.resultCd === '000' || response.resultCd === '0') return 'success'\n  if (statusCode && statusCode >= 200 && statusCode < 300 && !response.resultCd) return 'success'\n  return 'error'\n}\n\nexport async function logApiCall(entry: ApiLogEntry) {\n  if (!entry.branchId) {\n    console.warn(\"[API Logger] No branchId provided, skipping log\")\n    return\n  }\n\n  try {\n    const logType = entry.logType || deriveLogType(entry.endpoint)\n    const status = deriveStatus(entry.response, entry.statusCode, entry.error)\n\n    console.log(`[API Logger] Logging ${entry.endpoint} for branch ${entry.branchId} with status ${status}`)\n\n    await query(`\n      INSERT INTO branch_logs (branch_id, log_type, endpoint, request_payload, response_payload, status)\n      VALUES ($1, $2, $3, $4, $5, $6)\n    `, [\n      entry.branchId,\n      logType,\n      entry.endpoint,\n      JSON.stringify(entry.payload || {}),\n      JSON.stringify(entry.response || { error: entry.error }),\n      status\n    ])\n    \n    console.log(`[API Logger] Successfully logged ${entry.endpoint}`)\n  } catch (error) {\n    console.error(\"[API Logger] Failed to log API call:\", error)\n    console.error(\"[API Logger] Entry was:\", JSON.stringify({\n      branchId: entry.branchId,\n      endpoint: entry.endpoint,\n      statusCode: entry.statusCode\n    }))\n  }\n}\n\nexport function createApiLogger(endpoint: string, method = \"POST\") {\n  const startTime = Date.now()\n\n  return {\n    success: async (payload: any, response: any, branchId?: string, externalEndpoint?: string) => {\n      const duration = Date.now() - startTime\n      await logApiCall({\n        endpoint,\n        method,\n        payload,\n        response,\n        statusCode: 200,\n        durationMs: duration,\n        branchId,\n        externalEndpoint,\n      })\n    },\n    error: async (payload: any, error: any, statusCode = 500, branchId?: string, externalEndpoint?: string) => {\n      const duration = Date.now() - startTime\n      await logApiCall({\n        endpoint,\n        method,\n        payload,\n        error: error?.message || String(error),\n        statusCode,\n        durationMs: duration,\n        branchId,\n        externalEndpoint,\n      })\n    },\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;;;;;;;AAeA,SAAS,cAAc,QAAgB;IACrC,IAAI,SAAS,QAAQ,CAAC,cAAc,OAAO;IAC3C,IAAI,SAAS,QAAQ,CAAC,mBAAmB,OAAO;IAChD,IAAI,SAAS,QAAQ,CAAC,oBAAoB,OAAO;IACjD,IAAI,SAAS,QAAQ,CAAC,mBAAmB,OAAO;IAChD,IAAI,SAAS,QAAQ,CAAC,aAAa,OAAO;IAC1C,OAAO;AACT;AAEA,SAAS,aAAa,QAAa,EAAE,UAAmB,EAAE,KAAc;IACtE,IAAI,OAAO,OAAO;IAClB,IAAI,CAAC,UAAU,OAAO;IACtB,IAAI,SAAS,QAAQ,KAAK,SAAS,SAAS,QAAQ,KAAK,KAAK,OAAO;IACrE,IAAI,cAAc,cAAc,OAAO,aAAa,OAAO,CAAC,SAAS,QAAQ,EAAE,OAAO;IACtF,OAAO;AACT;AAEO,eAAe,WAAW,KAAkB;IACjD,IAAI,CAAC,MAAM,QAAQ,EAAE;QACnB,QAAQ,IAAI,CAAC;QACb;IACF;IAEA,IAAI;QACF,MAAM,UAAU,MAAM,OAAO,IAAI,cAAc,MAAM,QAAQ;QAC7D,MAAM,SAAS,aAAa,MAAM,QAAQ,EAAE,MAAM,UAAU,EAAE,MAAM,KAAK;QAEzE,QAAQ,GAAG,CAAC,CAAC,qBAAqB,EAAE,MAAM,QAAQ,CAAC,YAAY,EAAE,MAAM,QAAQ,CAAC,aAAa,EAAE,QAAQ;QAEvG,MAAM,IAAA,8HAAK,EAAC,CAAC;;;IAGb,CAAC,EAAE;YACD,MAAM,QAAQ;YACd;YACA,MAAM,QAAQ;YACd,KAAK,SAAS,CAAC,MAAM,OAAO,IAAI,CAAC;YACjC,KAAK,SAAS,CAAC,MAAM,QAAQ,IAAI;gBAAE,OAAO,MAAM,KAAK;YAAC;YACtD;SACD;QAED,QAAQ,GAAG,CAAC,CAAC,iCAAiC,EAAE,MAAM,QAAQ,EAAE;IAClE,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,wCAAwC;QACtD,QAAQ,KAAK,CAAC,2BAA2B,KAAK,SAAS,CAAC;YACtD,UAAU,MAAM,QAAQ;YACxB,UAAU,MAAM,QAAQ;YACxB,YAAY,MAAM,UAAU;QAC9B;IACF;AACF;AAEO,SAAS,gBAAgB,QAAgB,EAAE,SAAS,MAAM;IAC/D,MAAM,YAAY,KAAK,GAAG;IAE1B,OAAO;QACL,SAAS,OAAO,SAAc,UAAe,UAAmB;YAC9D,MAAM,WAAW,KAAK,GAAG,KAAK;YAC9B,MAAM,WAAW;gBACf;gBACA;gBACA;gBACA;gBACA,YAAY;gBACZ,YAAY;gBACZ;gBACA;YACF;QACF;QACA,OAAO,OAAO,SAAc,OAAY,aAAa,GAAG,EAAE,UAAmB;YAC3E,MAAM,WAAW,KAAK,GAAG,KAAK;YAC9B,MAAM,WAAW;gBACf;gBACA;gBACA;gBACA,OAAO,OAAO,WAAW,OAAO;gBAChC;gBACA,YAAY;gBACZ;gBACA;YACF;QACF;IACF;AACF"}},
    {"offset": {"line": 224, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/kra-url-helper.ts"],"sourcesContent":["export function buildKraBaseUrl(\n  serverAddress: string | null | undefined,\n  serverPort: string | null | undefined\n): string {\n  const DEFAULT_SERVER = '5.189.171.160'\n  const DEFAULT_PORT = '8088'\n  \n  if (!serverAddress) {\n    return `http://${DEFAULT_SERVER}:${serverPort || DEFAULT_PORT}`\n  }\n  \n  let address = serverAddress.trim()\n  \n  const hasScheme = /^https?:\\/\\//i.test(address)\n  if (hasScheme) {\n    address = address.replace(/^https?:\\/\\//i, '')\n  }\n  \n  address = address.replace(/\\/+$/, '')\n  \n  const hasPort = /:\\d+$/.test(address)\n  \n  if (hasPort) {\n    return `http://${address}`\n  }\n  \n  return `http://${address}:${serverPort || DEFAULT_PORT}`\n}\n"],"names":[],"mappings":";;;;AAAO,SAAS,gBACd,aAAwC,EACxC,UAAqC;IAErC,MAAM,iBAAiB;IACvB,MAAM,eAAe;IAErB,IAAI,CAAC,eAAe;QAClB,OAAO,CAAC,OAAO,EAAE,eAAe,CAAC,EAAE,cAAc,cAAc;IACjE;IAEA,IAAI,UAAU,cAAc,IAAI;IAEhC,MAAM,YAAY,gBAAgB,IAAI,CAAC;IACvC,IAAI,WAAW;QACb,UAAU,QAAQ,OAAO,CAAC,iBAAiB;IAC7C;IAEA,UAAU,QAAQ,OAAO,CAAC,QAAQ;IAElC,MAAM,UAAU,QAAQ,IAAI,CAAC;IAE7B,IAAI,SAAS;QACX,OAAO,CAAC,OAAO,EAAE,SAAS;IAC5B;IAEA,OAAO,CAAC,OAAO,EAAE,QAAQ,CAAC,EAAE,cAAc,cAAc;AAC1D"}},
    {"offset": {"line": 252, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/kra/issue-invoice/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { query } from \"@/lib/db\"\nimport { logApiCall } from \"@/lib/api-logger\"\nimport { buildKraBaseUrl } from \"@/lib/kra-url-helper\"\n\nconst PAYMENT_TYPE_CODES: Record<string, string> = {\n  'cash': '01',\n  'credit': '02', \n  'mobile_money': '03',\n  'mpesa': '03',\n  'bank_transfer': '04',\n  'card': '05',\n  'cheque': '06',\n  'other': '07'\n}\n\nfunction formatKraDateTime(date: Date = new Date()): string {\n  const year = date.getFullYear()\n  const month = String(date.getMonth() + 1).padStart(2, '0')\n  const day = String(date.getDate()).padStart(2, '0')\n  const hours = String(date.getHours()).padStart(2, '0')\n  const minutes = String(date.getMinutes()).padStart(2, '0')\n  const seconds = String(date.getSeconds()).padStart(2, '0')\n  return `${year}${month}${day}${hours}${minutes}${seconds}`\n}\n\nfunction formatKraDate(date: Date = new Date()): string {\n  const year = date.getFullYear()\n  const month = String(date.getMonth() + 1).padStart(2, '0')\n  const day = String(date.getDate()).padStart(2, '0')\n  return `${year}${month}${day}`\n}\n\nfunction toFixed2(num: number): string {\n  return (Math.round(num * 100) / 100).toFixed(2)\n}\n\nfunction calculateTax(amount: number, taxType: string = \"B\"): { taxblAmt: number, taxAmt: number, taxRt: number } {\n  if (taxType === \"A\") {\n    const taxRt = 16\n    const taxblAmt = amount / (1 + taxRt / 100)\n    const taxAmt = amount - taxblAmt\n    return { taxblAmt: Math.round(taxblAmt * 100) / 100, taxAmt: Math.round(taxAmt * 100) / 100, taxRt }\n  } else if (taxType === \"B\") {\n    const taxRt = 16\n    return { taxblAmt: amount, taxAmt: Math.round(amount * 0.16 * 100) / 100, taxRt }\n  } else if (taxType === \"C\") {\n    const taxRt = 8\n    return { taxblAmt: amount, taxAmt: Math.round(amount * 0.08 * 100) / 100, taxRt }\n  }\n  return { taxblAmt: amount, taxAmt: 0, taxRt: 0 }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const {\n      branch_id,\n      amount,\n      nozzle_id,\n      fuel_type,\n      customer_pin,\n      payment_method,\n      discount_type,\n      discount_value,\n      is_loyalty_sale,\n      loyalty_customer_name\n    } = body\n\n    if (!branch_id || !amount || !nozzle_id) {\n      return NextResponse.json({ success: false, error: \"Missing required fields\" }, { status: 400 })\n    }\n\n    const branchResult = await query(`\n      SELECT id, bhf_id, kra_pin, device_token, server_address, server_port, \n             COALESCE(invoice_number, 0) as invoice_number,\n             COALESCE(sr_number, 0) as sr_number\n      FROM branches\n      WHERE id = $1\n    `, [branch_id])\n\n    if (branchResult.length === 0) {\n      return NextResponse.json({ success: false, error: \"Branch not found\" }, { status: 404 })\n    }\n\n    const branch = branchResult[0]\n    \n    if (!branch.kra_pin) {\n      return NextResponse.json({ success: false, error: \"KRA PIN not configured for this branch\" }, { status: 400 })\n    }\n\n    // Step 1: Get basic nozzle info\n    const nozzleResult = await query(`\n      SELECT n.id, i.item_name as fuel_type, n.item_id,\n             COALESCE(n.initial_meter_reading, 0) as initial_meter_reading,\n             i.item_code, i.class_code, i.item_name, i.package_unit, i.quantity_unit, i.tax_type\n      FROM nozzles n\n      JOIN items i ON n.item_id = i.id\n      WHERE n.id = $1\n    `, [nozzle_id])\n\n    if (nozzleResult.length === 0) {\n      return NextResponse.json({ success: false, error: \"Nozzle not found\" }, { status: 404 })\n    }\n\n    let nozzle = nozzleResult[0]\n    let unitPrice = 0\n\n    // Step 2: Get price STRICTLY from branch_items - this is the authoritative source\n    // First try by nozzle's item_id if it exists\n    if (nozzle.item_id) {\n      const branchPriceResult = await query(`\n        SELECT bi.sale_price\n        FROM branch_items bi\n        WHERE bi.branch_id = $1 AND bi.item_id = $2 AND bi.is_available = true\n      `, [branch_id, nozzle.item_id])\n      \n      if (branchPriceResult.length > 0 && branchPriceResult[0].sale_price) {\n        unitPrice = parseFloat(branchPriceResult[0].sale_price)\n      }\n    }\n\n    // Step 3: If no price found yet, try to find by fuel type name in branch_items\n    if (unitPrice <= 0 && nozzle.fuel_type) {\n      const priceByFuelTypeResult = await query(`\n        SELECT bi.sale_price, i.id as item_id, i.item_code, i.class_code, i.item_name,\n               i.package_unit, i.quantity_unit, i.tax_type\n        FROM branch_items bi\n        JOIN items i ON bi.item_id = i.id\n        WHERE bi.branch_id = $1\n          AND bi.is_available = true\n          AND (\n            UPPER(i.item_name) = UPPER($2) \n            OR i.item_name ILIKE $3\n            OR (UPPER($2) = 'PETROL' AND (UPPER(i.item_name) LIKE '%PETROL%' OR UPPER(i.item_name) LIKE '%SUPER%'))\n            OR (UPPER($2) = 'DIESEL' AND UPPER(i.item_name) LIKE '%DIESEL%')\n            OR (UPPER($2) = 'KEROSENE' AND UPPER(i.item_name) LIKE '%KEROSENE%')\n          )\n        ORDER BY bi.updated_at DESC NULLS LAST\n        LIMIT 1\n      `, [branch_id, nozzle.fuel_type, `%${nozzle.fuel_type}%`])\n      \n      if (priceByFuelTypeResult.length > 0 && priceByFuelTypeResult[0].sale_price) {\n        const foundItem = priceByFuelTypeResult[0]\n        unitPrice = parseFloat(foundItem.sale_price)\n        // Update nozzle with item details if we found a match\n        if (!nozzle.item_id) {\n          nozzle = {\n            ...nozzle,\n            item_id: foundItem.item_id,\n            item_code: foundItem.item_code,\n            class_code: foundItem.class_code,\n            item_name: foundItem.item_name,\n            package_unit: foundItem.package_unit,\n            quantity_unit: foundItem.quantity_unit,\n            tax_type: foundItem.tax_type\n          }\n        }\n      }\n    }\n\n    if (!nozzle.item_id) {\n      return NextResponse.json({ success: false, error: `Nozzle \"${nozzle.fuel_type}\" is not mapped to an item. Please assign an item to this nozzle first.` }, { status: 400 })\n    }\n\n    if (unitPrice <= 0) {\n      return NextResponse.json({ \n        success: false, \n        error: `No branch-specific price found for \"${nozzle.fuel_type}\". Please go to Inventory Management and set a price for this item in branch_items.` \n      }, { status: 400 })\n    }\n\n    let discountAmount = 0\n    if (discount_value && discount_value > 0) {\n      if (discount_type === \"percentage\") {\n        discountAmount = (amount * Math.min(discount_value, 100)) / 100\n      } else {\n        discountAmount = Math.min(discount_value, amount)\n      }\n    }\n\n    const totalAmount = Math.max(amount - discountAmount, 0)\n    const quantity = totalAmount / unitPrice\n    \n    // Get current meter reading from latest sale or previous shift's closing reading\n    const lastReadingResult = await query(\n      `SELECT COALESCE(\n        (SELECT meter_reading_after FROM sales \n         WHERE nozzle_id = $1 AND meter_reading_after IS NOT NULL \n         ORDER BY created_at DESC LIMIT 1),\n        (SELECT sr.closing_reading FROM shift_readings sr \n         JOIN shifts s ON sr.shift_id = s.id \n         WHERE sr.nozzle_id = $1 AND s.status = 'completed' \n         ORDER BY s.end_time DESC NULLS LAST LIMIT 1),\n        (SELECT initial_meter_reading FROM nozzles WHERE id = $1),\n        0\n      ) as last_reading`,\n      [nozzle_id]\n    )\n    const currentMeterReading = parseFloat(lastReadingResult[0]?.last_reading) || 0\n    const meterReadingAfter = currentMeterReading + quantity\n    \n    const kraBaseUrl = buildKraBaseUrl(branch.server_address, branch.server_port)\n    const responses: any = {\n      saveSales: null,\n      saveStockItems: null,\n      saveStockMaster: null\n    }\n\n    const newInvoiceNo = branch.invoice_number + 1\n    await query(`UPDATE branches SET invoice_number = $1 WHERE id = $2`, [newInvoiceNo, branch_id])\n    const trdInvcNo = `CIV-${String(newInvoiceNo).padStart(6, '0')}`\n\n    const now = new Date()\n    const cfmDt = formatKraDateTime(now)\n    const salesDt = formatKraDate(now)\n    const pmtTyCd = PAYMENT_TYPE_CODES[payment_method?.toLowerCase()] || \"01\"\n\n    const itemCd = nozzle.item_code || \"ITEM001\"\n    const itemClsCd = nozzle.class_code || \"15100000\"\n    const itemNm = nozzle.item_name || fuel_type || \"Fuel\"\n    const pkgUnitCd = nozzle.package_unit || \"NT\"\n    const qtyUnitCd = nozzle.quantity_unit || \"LTR\"\n    const taxTyCd = nozzle.tax_type || \"B\"\n    \n    const { taxblAmt, taxAmt, taxRt } = calculateTax(totalAmount, taxTyCd)\n\n    const saveSalesPayload = {\n      tin: branch.kra_pin,\n      bhfId: branch.bhf_id || \"00\",\n      trdInvcNo: trdInvcNo,\n      invcNo: String(newInvoiceNo),\n      orgInvcNo: 0,\n      custTin: customer_pin || null,\n      custNm: is_loyalty_sale ? loyalty_customer_name : \"Walk-in Customer\",\n      salesTyCd: \"N\",\n      rcptTyCd: \"S\",\n      pmtTyCd: pmtTyCd,\n      salesSttsCd: \"02\",\n      cfmDt: cfmDt,\n      salesDt: salesDt,\n      stockRlsDt: cfmDt,\n      cnclReqDt: null,\n      cnclDt: null,\n      rfdDt: null,\n      rfdRsnCd: null,\n      totItemCnt: 1,\n      taxblAmtA: taxTyCd === \"A\" ? toFixed2(taxblAmt) : \"0.00\",\n      taxblAmtB: taxTyCd === \"B\" ? toFixed2(taxblAmt) : \"0.00\",\n      taxblAmtC: taxTyCd === \"C\" ? toFixed2(taxblAmt) : \"0.00\",\n      taxblAmtD: \"0.00\",\n      taxblAmtE: \"0.00\",\n      taxRtA: taxTyCd === \"A\" ? toFixed2(taxRt) : \"0.00\",\n      taxRtB: taxTyCd === \"B\" ? toFixed2(taxRt) : \"0.00\",\n      taxRtC: taxTyCd === \"C\" ? toFixed2(taxRt) : \"0.00\",\n      taxRtD: \"0.00\",\n      taxRtE: \"0.00\",\n      taxAmtA: taxTyCd === \"A\" ? toFixed2(taxAmt) : \"0.00\",\n      taxAmtB: taxTyCd === \"B\" ? toFixed2(taxAmt) : \"0.00\",\n      taxAmtC: taxTyCd === \"C\" ? toFixed2(taxAmt) : \"0.00\",\n      taxAmtD: \"0.00\",\n      taxAmtE: \"0.00\",\n      totTaxblAmt: toFixed2(taxblAmt),\n      totTaxAmt: toFixed2(taxAmt),\n      totAmt: toFixed2(totalAmount),\n      prchrAcptcYn: \"N\",\n      remark: null,\n      regrNm: \"Admin\",\n      regrId: \"Admin\",\n      modrNm: \"Admin\",\n      modrId: \"Admin\",\n      receipt: {\n        custTin: customer_pin || null,\n        custMblNo: null,\n        rcptPbctDt: null,\n        trdeNm: null,\n        adrs: null,\n        topMsg: null,\n        btmMsg: null,\n        prchrAcptcYn: \"Y\"\n      },\n      itemList: [\n        {\n          itemSeq: 1,\n          itemCd: itemCd,\n          itemClsCd: itemClsCd,\n          itemNm: itemNm,\n          bcd: null,\n          pkgUnitCd: pkgUnitCd,\n          pkg: 1,\n          qtyUnitCd: qtyUnitCd,\n          qty: parseFloat(quantity.toFixed(2)),\n          prc: unitPrice,\n          splyAmt: toFixed2(totalAmount),\n          dcRt: discountAmount > 0 ? parseFloat(((discountAmount / amount) * 100).toFixed(2)) : 0.0,\n          dcAmt: discountAmount,\n          isrccCd: null,\n          isrccNm: null,\n          isrcRt: 0,\n          isrcAmt: 0,\n          taxTyCd: taxTyCd,\n          taxblAmt: toFixed2(taxblAmt),\n          taxAmt: toFixed2(taxAmt),\n          totAmt: toFixed2(totalAmount)\n        }\n      ]\n    }\n\n    let startTime = Date.now()\n    try {\n      const controller = new AbortController()\n      const timeoutId = setTimeout(() => controller.abort(), 30000)\n      \n      const response = await fetch(`${kraBaseUrl}/trnsSales/saveSales`, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"Accept\": \"application/json\",\n          ...(branch.device_token ? { \"DeviceSerialNo\": branch.device_token } : {})\n        },\n        body: JSON.stringify(saveSalesPayload),\n        signal: controller.signal\n      })\n\n      clearTimeout(timeoutId)\n      responses.saveSales = await response.json()\n      \n      await logApiCall({\n        endpoint: \"/trnsSales/saveSales\",\n        method: \"POST\",\n        payload: saveSalesPayload,\n        response: responses.saveSales,\n        statusCode: response.status,\n        durationMs: Date.now() - startTime,\n        branchId: branch_id,\n        externalEndpoint: `${kraBaseUrl}/trnsSales/saveSales`\n      })\n    } catch (err: any) {\n      responses.saveSales = {\n        resultCd: err.name === 'AbortError' ? \"TIMEOUT\" : \"NETWORK_ERROR\",\n        resultMsg: err.message || \"Failed to connect to KRA\",\n        resultDt: new Date().toISOString()\n      }\n      await logApiCall({\n        endpoint: \"/trnsSales/saveSales\",\n        method: \"POST\",\n        payload: saveSalesPayload,\n        response: responses.saveSales,\n        statusCode: 0,\n        durationMs: Date.now() - startTime,\n        branchId: branch_id,\n        error: err.message,\n        externalEndpoint: `${kraBaseUrl}/trnsSales/saveSales`\n      })\n    }\n\n    const saveSalesSuccess = responses.saveSales?.resultCd === \"000\" || responses.saveSales?.resultCd === \"0\"\n    \n    if (!saveSalesSuccess) {\n      return NextResponse.json({\n        success: false,\n        invoiceNumber: trdInvcNo,\n        error: responses.saveSales?.resultMsg || \"Failed to save sales to KRA\",\n        responses: {\n          saveSales: responses.saveSales,\n          saveStockItems: null,\n          saveStockMaster: null\n        },\n        summary: {\n          saveSales: responses.saveSales?.resultMsg || \"Failed\",\n          saveStockItems: \"Skipped - saveSales failed\",\n          saveStockMaster: \"Skipped - saveSales failed\"\n        }\n      })\n    }\n\n    const newSarNo = branch.sr_number + 1\n    await query(`UPDATE branches SET sr_number = $1 WHERE id = $2`, [newSarNo, branch_id])\n\n    const activeShiftResult = await query(`\n      SELECT id FROM shifts \n      WHERE branch_id = $1 AND status = 'active' \n      ORDER BY start_time DESC LIMIT 1\n    `, [branch_id])\n    const activeShiftId = activeShiftResult.length > 0 ? activeShiftResult[0].id : null\n\n    const kraData = responses.saveSales?.data || {}\n    // Use intrlData as CU invoice number (this is what KRA returns as the unique invoice identifier)\n    const cuInvNo = kraData.intrlData || kraData.curRcptNo || null\n    await query(\n      `INSERT INTO sales (\n        branch_id, shift_id, nozzle_id, fuel_type, quantity, unit_price, \n        total_amount, payment_method, customer_name, customer_pin,\n        invoice_number, transmission_status, meter_reading_after,\n        is_loyalty_sale, loyalty_customer_name, loyalty_customer_pin, \n        sale_date, created_at,\n        kra_status, kra_rcpt_sign, kra_scu_id, kra_cu_inv, kra_internal_data\n      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, NOW(), NOW(), $17, $18, $19, $20, $21)`,\n      [\n        branch_id,\n        activeShiftId,\n        nozzle_id,\n        fuel_type || nozzle.fuel_type,\n        quantity,\n        unitPrice,\n        totalAmount,\n        payment_method || 'cash',\n        is_loyalty_sale ? loyalty_customer_name : 'Walk-in Customer',\n        customer_pin || null,\n        trdInvcNo,\n        'transmitted',\n        meterReadingAfter,\n        is_loyalty_sale || false,\n        is_loyalty_sale ? loyalty_customer_name : null,\n        is_loyalty_sale ? customer_pin : null,\n        'success',\n        kraData.rcptSign || null,\n        kraData.sdcId || null,\n        cuInvNo,\n        kraData.intrlData || null\n      ]\n    )\n    \n    // Note: We don't update nozzle's initial_meter_reading here\n    // The meter_reading_after is stored in the sales record\n    // Opening readings come from previous shift's closing reading in shift_readings table\n\n    const splyAmt = Math.round(quantity * unitPrice * 100) / 100\n    const stockTaxAmt = Math.round(splyAmt * 0.16 * 100) / 100\n\n    const saveStockItemsPayload = {\n      tin: branch.kra_pin,\n      bhfId: branch.bhf_id || \"00\",\n      sarNo: newSarNo,\n      orgSarNo: 0,\n      regTyCd: \"M\",\n      custTin: null,\n      custNm: null,\n      custBhfId: null,\n      sarTyCd: \"11\",\n      ocrnDt: formatKraDate(),\n      totItemCnt: 1,\n      totTaxblAmt: toFixed2(splyAmt),\n      totTaxAmt: toFixed2(stockTaxAmt),\n      totAmt: toFixed2(splyAmt),\n      remark: null,\n      regrId: \"Admin\",\n      regrNm: \"Admin\",\n      modrNm: \"Admin\",\n      modrId: \"Admin\",\n      itemList: [\n        {\n          itemSeq: 1,\n          itemCd: itemCd,\n          itemClsCd: itemClsCd,\n          itemNm: itemNm,\n          bcd: null,\n          pkgUnitCd: pkgUnitCd,\n          pkg: Math.ceil(quantity),\n          qtyUnitCd: qtyUnitCd,\n          qty: parseFloat(quantity.toFixed(2)),\n          itemExprDt: null,\n          prc: unitPrice,\n          splyAmt: toFixed2(splyAmt),\n          totDcAmt: 0,\n          taxblAmt: toFixed2(splyAmt),\n          taxTyCd: taxTyCd,\n          taxAmt: toFixed2(stockTaxAmt),\n          totAmt: toFixed2(splyAmt)\n        }\n      ]\n    }\n\n    startTime = Date.now()\n    try {\n      const controller = new AbortController()\n      const timeoutId = setTimeout(() => controller.abort(), 15000)\n      \n      const response = await fetch(`${kraBaseUrl}/stock/saveStockItems`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(saveStockItemsPayload),\n        signal: controller.signal\n      })\n\n      clearTimeout(timeoutId)\n      responses.saveStockItems = await response.json()\n      \n      await logApiCall({\n        endpoint: \"/stock/saveStockItems\",\n        method: \"POST\",\n        payload: saveStockItemsPayload,\n        response: responses.saveStockItems,\n        statusCode: response.status,\n        durationMs: Date.now() - startTime,\n        branchId: branch_id,\n        externalEndpoint: `${kraBaseUrl}/stock/saveStockItems`\n      })\n    } catch (err: any) {\n      responses.saveStockItems = {\n        resultCd: err.name === 'AbortError' ? \"TIMEOUT\" : \"NETWORK_ERROR\",\n        resultMsg: err.message || \"Failed to connect to KRA\",\n        resultDt: new Date().toISOString()\n      }\n      await logApiCall({\n        endpoint: \"/stock/saveStockItems\",\n        method: \"POST\",\n        payload: saveStockItemsPayload,\n        response: responses.saveStockItems,\n        statusCode: 0,\n        durationMs: Date.now() - startTime,\n        branchId: branch_id,\n        error: err.message,\n        externalEndpoint: `${kraBaseUrl}/stock/saveStockItems`\n      })\n    }\n\n    const tankResult = await query(`\n      SELECT t.current_stock FROM tanks t\n      LEFT JOIN items i ON t.item_id = i.id\n      WHERE t.branch_id = $1 AND (t.kra_item_cd = $2 OR UPPER(i.item_name) = UPPER($3))\n      LIMIT 1\n    `, [branch_id, itemCd, itemNm])\n    \n    const currentStock = tankResult.length > 0 ? parseFloat(tankResult[0].current_stock) || 0 : 0\n\n    const saveStockMasterPayload = {\n      tin: branch.kra_pin,\n      bhfId: branch.bhf_id || \"00\",\n      itemCd: itemCd,\n      rsdQty: currentStock,\n      regrId: \"Admin\",\n      regrNm: \"Admin\",\n      modrNm: \"Admin\",\n      modrId: \"Admin\"\n    }\n\n    startTime = Date.now()\n    try {\n      const controller = new AbortController()\n      const timeoutId = setTimeout(() => controller.abort(), 15000)\n      \n      const response = await fetch(`${kraBaseUrl}/stockMaster/saveStockMaster`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(saveStockMasterPayload),\n        signal: controller.signal\n      })\n\n      clearTimeout(timeoutId)\n      responses.saveStockMaster = await response.json()\n      \n      await logApiCall({\n        endpoint: \"/stockMaster/saveStockMaster\",\n        method: \"POST\",\n        payload: saveStockMasterPayload,\n        response: responses.saveStockMaster,\n        statusCode: response.status,\n        durationMs: Date.now() - startTime,\n        branchId: branch_id,\n        externalEndpoint: `${kraBaseUrl}/stockMaster/saveStockMaster`\n      })\n    } catch (err: any) {\n      responses.saveStockMaster = {\n        resultCd: err.name === 'AbortError' ? \"TIMEOUT\" : \"NETWORK_ERROR\",\n        resultMsg: err.message || \"Failed to connect to KRA\",\n        resultDt: new Date().toISOString()\n      }\n      await logApiCall({\n        endpoint: \"/stockMaster/saveStockMaster\",\n        method: \"POST\",\n        payload: saveStockMasterPayload,\n        response: responses.saveStockMaster,\n        statusCode: 0,\n        durationMs: Date.now() - startTime,\n        branchId: branch_id,\n        error: err.message,\n        externalEndpoint: `${kraBaseUrl}/stockMaster/saveStockMaster`\n      })\n    }\n\n    const saveStockItemsSuccess = responses.saveStockItems?.resultCd === \"000\" || responses.saveStockItems?.resultCd === \"0\"\n    const saveStockMasterSuccess = responses.saveStockMaster?.resultCd === \"000\" || responses.saveStockMaster?.resultCd === \"0\"\n\n    return NextResponse.json({\n      success: true,\n      invoiceNumber: trdInvcNo,\n      responses: {\n        saveSales: responses.saveSales,\n        saveStockItems: responses.saveStockItems,\n        saveStockMaster: responses.saveStockMaster\n      },\n      summary: {\n        saveSales: \"Success\",\n        saveStockItems: saveStockItemsSuccess ? \"Success\" : responses.saveStockItems?.resultMsg || \"Failed\",\n        saveStockMaster: saveStockMasterSuccess ? \"Success\" : responses.saveStockMaster?.resultMsg || \"Failed\"\n      }\n    })\n\n  } catch (error: any) {\n    console.error(\"[Issue Invoice API] Error:\", error)\n    return NextResponse.json({ \n      success: false, \n      error: error.message || \"Failed to issue invoice\" \n    }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}