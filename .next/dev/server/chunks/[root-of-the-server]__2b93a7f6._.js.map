{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/customers/statement/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const customerId = searchParams.get('customer_id')\n    const branchId = searchParams.get('branch_id')\n    const startDate = searchParams.get('start_date')\n    const endDate = searchParams.get('end_date')\n\n    if (!customerId) {\n      return NextResponse.json(\n        { error: \"Customer ID is required\" },\n        { status: 400 }\n      )\n    }\n\n    // Get customer details\n    const customerResult = await pool.query(\n      `SELECT id, cust_nm, cust_tin, tel_no, email, adrs FROM customers WHERE id = $1`,\n      [customerId]\n    )\n\n    if (customerResult.rows.length === 0) {\n      return NextResponse.json(\n        { error: \"Customer not found\" },\n        { status: 404 }\n      )\n    }\n\n    const customer = customerResult.rows[0]\n\n    // Build sales query with date filters\n    let salesQuery = `\n      SELECT \n        s.id,\n        s.created_at as date,\n        s.invoice_number,\n        s.fuel_type,\n        s.quantity,\n        s.total_price as amount,\n        s.payment_method,\n        s.status,\n        b.name as branch_name\n      FROM sales s\n      LEFT JOIN branches b ON s.branch_id = b.id\n      WHERE (s.customer_id = $1 OR s.customer_pin = $2 OR s.customer_name = $3)\n    `\n    const params: any[] = [customerId, customer.cust_tin, customer.cust_nm]\n\n    if (branchId) {\n      params.push(branchId)\n      salesQuery += ` AND s.branch_id = $${params.length}`\n    }\n\n    if (startDate) {\n      params.push(startDate)\n      salesQuery += ` AND s.created_at >= $${params.length}::date`\n    }\n\n    if (endDate) {\n      params.push(endDate)\n      salesQuery += ` AND s.created_at <= $${params.length}::date + interval '1 day'`\n    }\n\n    salesQuery += ` ORDER BY s.created_at DESC`\n\n    const salesResult = await pool.query(salesQuery, params)\n\n    // Calculate totals\n    const transactions = salesResult.rows\n    const totalAmount = transactions.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0)\n    const totalQuantity = transactions.reduce((sum, t) => sum + parseFloat(t.quantity || 0), 0)\n\n    // Get payment breakdown\n    const paymentBreakdown: Record<string, number> = {}\n    transactions.forEach(t => {\n      const method = t.payment_method || 'unknown'\n      paymentBreakdown[method] = (paymentBreakdown[method] || 0) + parseFloat(t.amount || 0)\n    })\n\n    return NextResponse.json({\n      success: true,\n      data: {\n        customer: {\n          id: customer.id,\n          name: customer.cust_nm,\n          pin: customer.cust_tin,\n          phone: customer.tel_no,\n          email: customer.email,\n          address: customer.adrs\n        },\n        transactions,\n        summary: {\n          totalTransactions: transactions.length,\n          totalAmount,\n          totalQuantity,\n          paymentBreakdown,\n          periodStart: startDate || null,\n          periodEnd: endDate || null\n        }\n      }\n    })\n\n  } catch (error: any) {\n    console.error(\"Error generating customer statement:\", error)\n    return NextResponse.json(\n      { error: \"Failed to generate statement\", details: error.message },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;AAC5C;AAEO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,aAAa,aAAa,GAAG,CAAC;QACpC,MAAM,WAAW,aAAa,GAAG,CAAC;QAClC,MAAM,YAAY,aAAa,GAAG,CAAC;QACnC,MAAM,UAAU,aAAa,GAAG,CAAC;QAEjC,IAAI,CAAC,YAAY;YACf,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA0B,GACnC;gBAAE,QAAQ;YAAI;QAElB;QAEA,uBAAuB;QACvB,MAAM,iBAAiB,MAAM,KAAK,KAAK,CACrC,CAAC,8EAA8E,CAAC,EAChF;YAAC;SAAW;QAGd,IAAI,eAAe,IAAI,CAAC,MAAM,KAAK,GAAG;YACpC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAqB,GAC9B;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,WAAW,eAAe,IAAI,CAAC,EAAE;QAEvC,sCAAsC;QACtC,IAAI,aAAa,CAAC;;;;;;;;;;;;;;IAclB,CAAC;QACD,MAAM,SAAgB;YAAC;YAAY,SAAS,QAAQ;YAAE,SAAS,OAAO;SAAC;QAEvE,IAAI,UAAU;YACZ,OAAO,IAAI,CAAC;YACZ,cAAc,CAAC,oBAAoB,EAAE,OAAO,MAAM,EAAE;QACtD;QAEA,IAAI,WAAW;YACb,OAAO,IAAI,CAAC;YACZ,cAAc,CAAC,sBAAsB,EAAE,OAAO,MAAM,CAAC,MAAM,CAAC;QAC9D;QAEA,IAAI,SAAS;YACX,OAAO,IAAI,CAAC;YACZ,cAAc,CAAC,sBAAsB,EAAE,OAAO,MAAM,CAAC,yBAAyB,CAAC;QACjF;QAEA,cAAc,CAAC,2BAA2B,CAAC;QAE3C,MAAM,cAAc,MAAM,KAAK,KAAK,CAAC,YAAY;QAEjD,mBAAmB;QACnB,MAAM,eAAe,YAAY,IAAI;QACrC,MAAM,cAAc,aAAa,MAAM,CAAC,CAAC,KAAK,IAAM,MAAM,WAAW,EAAE,MAAM,IAAI,IAAI;QACrF,MAAM,gBAAgB,aAAa,MAAM,CAAC,CAAC,KAAK,IAAM,MAAM,WAAW,EAAE,QAAQ,IAAI,IAAI;QAEzF,wBAAwB;QACxB,MAAM,mBAA2C,CAAC;QAClD,aAAa,OAAO,CAAC,CAAA;YACnB,MAAM,SAAS,EAAE,cAAc,IAAI;YACnC,gBAAgB,CAAC,OAAO,GAAG,CAAC,gBAAgB,CAAC,OAAO,IAAI,CAAC,IAAI,WAAW,EAAE,MAAM,IAAI;QACtF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,MAAM;gBACJ,UAAU;oBACR,IAAI,SAAS,EAAE;oBACf,MAAM,SAAS,OAAO;oBACtB,KAAK,SAAS,QAAQ;oBACtB,OAAO,SAAS,MAAM;oBACtB,OAAO,SAAS,KAAK;oBACrB,SAAS,SAAS,IAAI;gBACxB;gBACA;gBACA,SAAS;oBACP,mBAAmB,aAAa,MAAM;oBACtC;oBACA;oBACA;oBACA,aAAa,aAAa;oBAC1B,WAAW,WAAW;gBACxB;YACF;QACF;IAEF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,wCAAwC;QACtD,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;YAAgC,SAAS,MAAM,OAAO;QAAC,GAChE;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}