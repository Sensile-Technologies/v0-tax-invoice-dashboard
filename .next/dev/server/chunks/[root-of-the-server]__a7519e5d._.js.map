{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/client.ts"],"sourcesContent":["import { Pool } from 'pg';\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,\n});\n\nexport async function query<T = any>(text: string, params?: any[]): Promise<T[]> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rows as T[];\n  } finally {\n    client.release();\n  }\n}\n\nexport async function queryOne<T = any>(text: string, params?: any[]): Promise<T | null> {\n  const rows = await query<T>(text, params);\n  return rows[0] || null;\n}\n\nexport async function execute(text: string, params?: any[]): Promise<number> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rowCount || 0;\n  } finally {\n    client.release();\n  }\n}\n\nexport { pool };\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,sCAAwC,0BAAgC;AAC/E;AAEO,eAAe,MAAe,IAAY,EAAE,MAAc;IAC/D,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,IAAI;IACpB,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe,SAAkB,IAAY,EAAE,MAAc;IAClE,MAAM,OAAO,MAAM,MAAS,MAAM;IAClC,OAAO,IAAI,CAAC,EAAE,IAAI;AACpB;AAEO,eAAe,QAAQ,IAAY,EAAE,MAAc;IACxD,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,QAAQ,IAAI;IAC5B,SAAU;QACR,OAAO,OAAO;IAChB;AACF"}},
    {"offset": {"line": 108, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/index.ts"],"sourcesContent":["export * from './client';\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 120, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/kra-url-helper.ts"],"sourcesContent":["export function buildKraBaseUrl(\n  serverAddress: string | null | undefined,\n  serverPort: string | null | undefined\n): string {\n  const DEFAULT_SERVER = '5.189.171.160'\n  const DEFAULT_PORT = '8088'\n  \n  if (!serverAddress) {\n    return `http://${DEFAULT_SERVER}:${serverPort || DEFAULT_PORT}`\n  }\n  \n  let address = serverAddress.trim()\n  \n  const hasScheme = /^https?:\\/\\//i.test(address)\n  if (hasScheme) {\n    address = address.replace(/^https?:\\/\\//i, '')\n  }\n  \n  address = address.replace(/\\/+$/, '')\n  \n  const hasPort = /:\\d+$/.test(address)\n  \n  if (hasPort) {\n    return `http://${address}`\n  }\n  \n  return `http://${address}:${serverPort || DEFAULT_PORT}`\n}\n"],"names":[],"mappings":";;;;AAAO,SAAS,gBACd,aAAwC,EACxC,UAAqC;IAErC,MAAM,iBAAiB;IACvB,MAAM,eAAe;IAErB,IAAI,CAAC,eAAe;QAClB,OAAO,CAAC,OAAO,EAAE,eAAe,CAAC,EAAE,cAAc,cAAc;IACjE;IAEA,IAAI,UAAU,cAAc,IAAI;IAEhC,MAAM,YAAY,gBAAgB,IAAI,CAAC;IACvC,IAAI,WAAW;QACb,UAAU,QAAQ,OAAO,CAAC,iBAAiB;IAC7C;IAEA,UAAU,QAAQ,OAAO,CAAC,QAAQ;IAElC,MAAM,UAAU,QAAQ,IAAI,CAAC;IAE7B,IAAI,SAAS;QACX,OAAO,CAAC,OAAO,EAAE,SAAS;IAC5B;IAEA,OAAO,CAAC,OAAO,EAAE,QAAQ,CAAC,EAAE,cAAc,cAAc;AAC1D"}},
    {"offset": {"line": 148, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/items/%5Bid%5D/resend-kra/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { query } from \"@/lib/db\"\nimport { buildKraBaseUrl } from \"@/lib/kra-url-helper\"\n\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  const startTime = Date.now()\n  \n  try {\n    const { id } = await params\n\n    if (!id) {\n      return NextResponse.json(\n        { error: \"Item ID is required\" },\n        { status: 400 }\n      )\n    }\n\n    const { searchParams } = new URL(request.url)\n    const branchId = searchParams.get('branchId')\n\n    let itemResult\n    \n    if (branchId) {\n      itemResult = await query(`\n        SELECT i.*, \n               bi.sale_price as branch_sale_price,\n               bi.purchase_price as branch_purchase_price,\n               COALESCE(b.kra_pin, v.kra_pin) as kra_pin, \n               b.bhf_id, b.id as branch_id,\n               COALESCE(b.server_address, '5.189.171.160') as server_address,\n               COALESCE(b.server_port, '8088') as server_port\n        FROM items i\n        JOIN vendors v ON v.id = i.vendor_id\n        JOIN branch_items bi ON bi.item_id = i.id AND bi.branch_id = $2\n        JOIN branches b ON b.id = bi.branch_id\n        WHERE i.id = $1\n      `, [id, branchId])\n    } else {\n      itemResult = await query(`\n        SELECT i.*, COALESCE(b.kra_pin, v.kra_pin) as kra_pin, b.bhf_id,\n               COALESCE(b.server_address, '5.189.171.160') as server_address,\n               COALESCE(b.server_port, '8088') as server_port\n        FROM items i\n        JOIN vendors v ON v.id = i.vendor_id\n        JOIN branches b ON b.id = i.branch_id\n        WHERE i.id = $1\n      `, [id])\n    }\n\n    if (itemResult.length === 0) {\n      return NextResponse.json(\n        { error: \"Item not found or not assigned to the specified branch\" },\n        { status: 404 }\n      )\n    }\n\n    const item = itemResult[0]\n\n    if (!item.branch_id) {\n      return NextResponse.json(\n        { error: \"Item does not have a branch assigned. For catalog items, specify branchId parameter.\" },\n        { status: 400 }\n      )\n    }\n\n    if (!item.kra_pin) {\n      return NextResponse.json(\n        { error: \"Vendor KRA PIN not configured\" },\n        { status: 400 }\n      )\n    }\n\n    console.log(`[Items API] Resending item ${id} to KRA directly`)\n\n    const effectiveSalePrice = item.branch_sale_price || item.sale_price || 0\n    \n    const kraPayload = {\n      tin: item.kra_pin,\n      bhfId: item.bhf_id || \"00\",\n      itemCd: item.item_code,\n      itemClsCd: item.class_code || \"99000000\",\n      itemTyCd: item.item_type || \"2\",\n      itemNm: item.item_name,\n      itemStdNm: null,\n      orgnNatCd: item.origin || \"KE\",\n      pkgUnitCd: item.package_unit || \"NT\",\n      qtyUnitCd: item.quantity_unit || \"U\",\n      taxTyCd: item.tax_type || \"B\",\n      btchNo: item.batch_number || null,\n      bcd: item.sku || null,\n      dftPrc: effectiveSalePrice,\n      grpPrcL1: effectiveSalePrice,\n      grpPrcL2: effectiveSalePrice,\n      grpPrcL3: effectiveSalePrice,\n      grpPrcL4: effectiveSalePrice,\n      grpPrcL5: null,\n      addInfo: null,\n      sftyQty: null,\n      isrcAplcbYn: \"N\",\n      useYn: item.status === \"active\" ? \"Y\" : \"N\",\n      regrNm: \"Admin\",\n      regrId: \"Admin\",\n      modrNm: \"Admin\",\n      modrId: \"Admin\"\n    }\n\n    const kraBaseUrl = buildKraBaseUrl(item.server_address, item.server_port)\n    const kraEndpoint = `${kraBaseUrl}/items/saveItems`\n    \n    console.log(`[Items API] Calling KRA endpoint: ${kraEndpoint}`)\n    console.log(`[Items API] Request payload:`, JSON.stringify(kraPayload, null, 2))\n\n    let kraResponse: any\n    let httpStatusCode = 200\n\n    try {\n      const controller = new AbortController()\n      const timeoutId = setTimeout(() => controller.abort(), 15000)\n\n      const response = await fetch(kraEndpoint, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify(kraPayload),\n        signal: controller.signal\n      })\n\n      clearTimeout(timeoutId)\n      httpStatusCode = response.status\n      kraResponse = await response.json()\n    } catch (fetchError: any) {\n      if (fetchError.name === 'AbortError') {\n        kraResponse = {\n          resultCd: \"TIMEOUT\",\n          resultMsg: \"Request timed out after 15 seconds\",\n          resultDt: new Date().toISOString()\n        }\n      } else {\n        kraResponse = {\n          resultCd: \"NETWORK_ERROR\",\n          resultMsg: `Network error: ${fetchError.message}`,\n          resultDt: new Date().toISOString()\n        }\n      }\n      httpStatusCode = 0\n    }\n\n    const duration = Date.now() - startTime\n    console.log(`[Items API] KRA Response (${duration}ms):`, JSON.stringify(kraResponse, null, 2))\n\n    try {\n      const logStatus = (kraResponse.resultCd === \"000\" || kraResponse.resultCd === \"0\") ? \"success\" : \"error\"\n      await query(`\n        INSERT INTO branch_logs (branch_id, log_type, endpoint, request_payload, response_payload, status)\n        VALUES ($1, $2, $3, $4, $5, $6)\n      `, [\n        item.branch_id,\n        \"kra_save_item\",\n        kraEndpoint,\n        JSON.stringify(kraPayload),\n        JSON.stringify(kraResponse),\n        logStatus\n      ])\n      console.log(`[Items API] Logged API call to branch_logs for branch ${item.branch_id}`)\n    } catch (logError) {\n      console.error(\"[Items API] Failed to log API call:\", logError)\n    }\n\n    const isSuccess = kraResponse.resultCd === \"000\" || kraResponse.resultCd === \"0\"\n    const status = isSuccess ? \"success\" : \"rejected\"\n\n    await query(`\n      UPDATE items \n      SET kra_status = $1, \n          kra_response = $2, \n          kra_last_synced_at = NOW()\n      WHERE id = $3\n    `, [status, JSON.stringify(kraResponse), id])\n\n    if (branchId) {\n      await query(`\n        UPDATE branch_items \n        SET kra_status = $1, \n            kra_response = $2, \n            kra_last_synced_at = NOW()\n        WHERE item_id = $3 AND branch_id = $4\n      `, [status, JSON.stringify(kraResponse), id, branchId])\n    }\n\n    return NextResponse.json({\n      success: isSuccess,\n      kraResponse,\n      message: isSuccess \n        ? \"Item successfully submitted to KRA\" \n        : `KRA submission failed: ${kraResponse.resultMsg || 'Unknown error'}`\n    })\n\n  } catch (error: any) {\n    console.error(\"[Items API] Error resending item to KRA:\", error)\n    return NextResponse.json(\n      { error: \"Failed to resend item to KRA\", details: error.message },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":"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"}}]
}