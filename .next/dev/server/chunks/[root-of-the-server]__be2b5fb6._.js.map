{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/client.ts"],"sourcesContent":["import { Pool } from 'pg';\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,\n});\n\nexport async function query<T = any>(text: string, params?: any[]): Promise<T[]> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rows as T[];\n  } finally {\n    client.release();\n  }\n}\n\nexport async function queryOne<T = any>(text: string, params?: any[]): Promise<T | null> {\n  const rows = await query<T>(text, params);\n  return rows[0] || null;\n}\n\nexport async function execute(text: string, params?: any[]): Promise<number> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rowCount || 0;\n  } finally {\n    client.release();\n  }\n}\n\nexport { pool };\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,sCAAwC,0BAAgC;AAC/E;AAEO,eAAe,MAAe,IAAY,EAAE,MAAc;IAC/D,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,IAAI;IACpB,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe,SAAkB,IAAY,EAAE,MAAc;IAClE,MAAM,OAAO,MAAM,MAAS,MAAM;IAClC,OAAO,IAAI,CAAC,EAAE,IAAI;AACpB;AAEO,eAAe,QAAQ,IAAY,EAAE,MAAc;IACxD,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,QAAQ,IAAI;IAC5B,SAAU;QACR,OAAO,OAAO;IAChB;AACF"}},
    {"offset": {"line": 108, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/index.ts"],"sourcesContent":["export * from './client';\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 122, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/pump-callback/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { query } from \"@/lib/db\"\n\ninterface PumpTransactionPacket {\n  Id: number\n  Type: string\n  Data: {\n    DateTimeStart: string\n    DateTime: string\n    Pump: number\n    Nozzle: number\n    FuelGradeId: number\n    FuelGradeName: string\n    Transaction: number\n    Volume: number\n    TCVolume: number\n    Price: number\n    Amount: number\n    TotalVolume: number\n    TotalAmount: number\n    Tag: string\n    UserId: number\n    ConfigurationId: string\n  }\n}\n\ninterface PumpCallbackPayload {\n  Protocol: string\n  PtsId: string\n  Packets: PumpTransactionPacket[]\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const payload: PumpCallbackPayload = await request.json()\n    \n    console.log(\"=\".repeat(60))\n    console.log(\"[PUMP CALLBACK] Received payload at:\", new Date().toISOString())\n    console.log(\"[PUMP CALLBACK] Protocol:\", payload.Protocol)\n    console.log(\"[PUMP CALLBACK] PtsId:\", payload.PtsId)\n    console.log(\"[PUMP CALLBACK] Packets count:\", payload.Packets?.length || 0)\n    console.log(\"[PUMP CALLBACK] Full payload:\", JSON.stringify(payload, null, 2))\n    console.log(\"=\".repeat(60))\n\n    const responsePackets = []\n\n    for (const packet of payload.Packets || []) {\n      console.log(`[PUMP CALLBACK] Processing packet Id: ${packet.Id}, Type: ${packet.Type}`)\n      \n      if (packet.Type === \"UploadPumpTransaction\" && packet.Data) {\n        const data = packet.Data\n        \n        console.log(`[PUMP CALLBACK] Transaction details:`)\n        console.log(`  - Pump: ${data.Pump}, Nozzle: ${data.Nozzle}`)\n        console.log(`  - Fuel: ${data.FuelGradeName} (ID: ${data.FuelGradeId})`)\n        console.log(`  - Volume: ${data.Volume}L, Amount: KES ${data.Amount}`)\n        console.log(`  - Price: KES ${data.Price}`)\n        console.log(`  - Transaction ID: ${data.Transaction}`)\n        console.log(`  - DateTime: ${data.DateTime}`)\n        \n        try {\n          await query(`\n            INSERT INTO pump_transactions (\n              packet_id, pts_id, pump_number, nozzle_number, \n              fuel_grade_id, fuel_grade_name, transaction_id,\n              volume, tc_volume, price, amount,\n              total_volume, total_amount, tag, user_id,\n              configuration_id, transaction_start, transaction_end,\n              created_at\n            ) VALUES (\n              $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, NOW()\n            )\n            ON CONFLICT (pts_id, transaction_id) DO NOTHING\n          `, [\n            packet.Id,\n            payload.PtsId,\n            data.Pump,\n            data.Nozzle,\n            data.FuelGradeId,\n            data.FuelGradeName,\n            data.Transaction,\n            data.Volume,\n            data.TCVolume,\n            data.Price,\n            data.Amount,\n            data.TotalVolume,\n            data.TotalAmount,\n            data.Tag,\n            data.UserId,\n            data.ConfigurationId,\n            data.DateTimeStart,\n            data.DateTime\n          ])\n          \n          console.log(`[PUMP CALLBACK] Transaction ${data.Transaction} saved to database`)\n        } catch (dbError: any) {\n          console.error(`[PUMP CALLBACK] Database error:`, dbError.message)\n        }\n      }\n\n      responsePackets.push({\n        Id: packet.Id,\n        Message: \"OK\",\n        Type: packet.Type\n      })\n    }\n\n    const response = {\n      Protocol: payload.Protocol || \"jsonPTS\",\n      Packets: responsePackets\n    }\n\n    console.log(\"[PUMP CALLBACK] Sending response:\", JSON.stringify(response, null, 2))\n    console.log(\"=\".repeat(60))\n\n    return NextResponse.json(response)\n  } catch (error: any) {\n    console.error(\"[PUMP CALLBACK] Error processing callback:\", error.message)\n    console.error(\"[PUMP CALLBACK] Stack:\", error.stack)\n    \n    return NextResponse.json({\n      Protocol: \"jsonPTS\",\n      Packets: [{\n        Id: 0,\n        Message: \"ERROR\",\n        Type: \"Error\"\n      }]\n    }, { status: 500 })\n  }\n}\n\nexport async function GET() {\n  return NextResponse.json({\n    status: \"active\",\n    endpoint: \"/api/pump-callback\",\n    description: \"Pump transaction callback endpoint for automated sales\",\n    expectedPayload: {\n      Protocol: \"jsonPTS\",\n      PtsId: \"string\",\n      Packets: [{\n        Id: \"number\",\n        Type: \"UploadPumpTransaction\",\n        Data: {\n          Pump: \"number\",\n          Nozzle: \"number\",\n          FuelGradeName: \"string\",\n          Volume: \"number\",\n          Amount: \"number\"\n        }\n      }]\n    }\n  })\n}\n"],"names":[],"mappings":"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"}}]
}