{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/client.ts"],"sourcesContent":["import { Pool } from 'pg';\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,\n});\n\nexport async function query<T = any>(text: string, params?: any[]): Promise<T[]> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rows as T[];\n  } finally {\n    client.release();\n  }\n}\n\nexport async function queryOne<T = any>(text: string, params?: any[]): Promise<T | null> {\n  const rows = await query<T>(text, params);\n  return rows[0] || null;\n}\n\nexport async function execute(text: string, params?: any[]): Promise<number> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rowCount || 0;\n  } finally {\n    client.release();\n  }\n}\n\nexport { pool };\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,sCAAwC,0BAAgC;AAC/E;AAEO,eAAe,MAAe,IAAY,EAAE,MAAc;IAC/D,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,IAAI;IACpB,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe,SAAkB,IAAY,EAAE,MAAc;IAClE,MAAM,OAAO,MAAM,MAAS,MAAM;IAClC,OAAO,IAAI,CAAC,EAAE,IAAI;AACpB;AAEO,eAAe,QAAQ,IAAY,EAAE,MAAc;IACxD,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,QAAQ,IAAI;IAC5B,SAAU;QACR,OAAO,OAAO;IAChB;AACF"}},
    {"offset": {"line": 108, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/index.ts"],"sourcesContent":["export * from './client';\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 120, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/kra-url-helper.ts"],"sourcesContent":["export function buildKraBaseUrl(\n  serverAddress: string | null | undefined,\n  serverPort: string | null | undefined\n): string {\n  const DEFAULT_SERVER = '5.189.171.160'\n  const DEFAULT_PORT = '8088'\n  \n  if (!serverAddress) {\n    return `http://${DEFAULT_SERVER}:${serverPort || DEFAULT_PORT}`\n  }\n  \n  let address = serverAddress.trim()\n  \n  const hasScheme = /^https?:\\/\\//i.test(address)\n  if (hasScheme) {\n    address = address.replace(/^https?:\\/\\//i, '')\n  }\n  \n  address = address.replace(/\\/+$/, '')\n  \n  const hasPort = /:\\d+$/.test(address)\n  \n  if (hasPort) {\n    return `http://${address}`\n  }\n  \n  return `http://${address}:${serverPort || DEFAULT_PORT}`\n}\n"],"names":[],"mappings":";;;;AAAO,SAAS,gBACd,aAAwC,EACxC,UAAqC;IAErC,MAAM,iBAAiB;IACvB,MAAM,eAAe;IAErB,IAAI,CAAC,eAAe;QAClB,OAAO,CAAC,OAAO,EAAE,eAAe,CAAC,EAAE,cAAc,cAAc;IACjE;IAEA,IAAI,UAAU,cAAc,IAAI;IAEhC,MAAM,YAAY,gBAAgB,IAAI,CAAC;IACvC,IAAI,WAAW;QACb,UAAU,QAAQ,OAAO,CAAC,iBAAiB;IAC7C;IAEA,UAAU,QAAQ,OAAO,CAAC,QAAQ;IAElC,MAAM,UAAU,QAAQ,IAAI,CAAC;IAE7B,IAAI,SAAS;QACX,OAAO,CAAC,OAAO,EAAE,SAAS;IAC5B;IAEA,OAAO,CAAC,OAAO,EAAE,QAAQ,CAAC,EAAE,cAAc,cAAc;AAC1D"}},
    {"offset": {"line": 148, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/kra/initialize/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { query } from \"@/lib/db\"\nimport { buildKraBaseUrl } from \"@/lib/kra-url-helper\"\nimport { cookies } from \"next/headers\"\n\nasync function getSessionUser(): Promise<{ id: string; role?: string; vendor_id?: string; branch_id?: string } | null> {\n  try {\n    const cookieStore = await cookies()\n    const sessionCookie = cookieStore.get(\"user_session\")\n    if (!sessionCookie?.value) return null\n    \n    const session = JSON.parse(sessionCookie.value)\n    return session.id ? session : null\n  } catch {\n    return null\n  }\n}\n\nasync function getUserAuthInfo(userId: string): Promise<{ vendorId: string | null; role: string | null; assignedBranchId: string | null; isVendorOwner: boolean }> {\n  const userResult = await query<any>(\n    `SELECT u.role, v.id as vendor_id FROM users u \n     LEFT JOIN vendors v ON v.email = u.email \n     WHERE u.id = $1`,\n    [userId]\n  )\n  if (userResult && userResult.length > 0 && userResult[0].vendor_id) {\n    return { vendorId: userResult[0].vendor_id, role: userResult[0].role || 'vendor', assignedBranchId: null, isVendorOwner: true }\n  }\n  \n  const staffResult = await query<any>(\n    `SELECT s.branch_id, s.role, b.vendor_id FROM staff s\n     JOIN branches b ON s.branch_id = b.id\n     WHERE s.user_id = $1 AND b.vendor_id IS NOT NULL`,\n    [userId]\n  )\n  if (staffResult && staffResult.length > 0) {\n    return { \n      vendorId: staffResult[0].vendor_id, \n      role: staffResult[0].role, \n      assignedBranchId: staffResult[0].branch_id,\n      isVendorOwner: false \n    }\n  }\n  \n  return { vendorId: null, role: null, assignedBranchId: null, isVendorOwner: false }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const session = await getSessionUser()\n    if (!session) {\n      return NextResponse.json({ error: \"Unauthorized. Please log in.\" }, { status: 401 })\n    }\n\n    const authInfo = await getUserAuthInfo(session.id)\n\n    const body = await request.json()\n    const { branch_id } = body\n\n    if (!branch_id) {\n      return NextResponse.json({ error: \"Branch ID is required\" }, { status: 400 })\n    }\n\n    const branchOwnerCheck = await query<any>(\n      `SELECT vendor_id FROM branches WHERE id = $1`,\n      [branch_id]\n    )\n    if (branchOwnerCheck.length === 0) {\n      return NextResponse.json({ error: \"Branch not found\" }, { status: 404 })\n    }\n    if (authInfo.vendorId && branchOwnerCheck[0].vendor_id !== authInfo.vendorId) {\n      return NextResponse.json({ error: \"Access denied to this branch\" }, { status: 403 })\n    }\n    \n    const restrictedRoles = ['supervisor', 'manager', 'cashier']\n    if (authInfo.role && restrictedRoles.includes(authInfo.role.toLowerCase())) {\n      if (authInfo.assignedBranchId !== branch_id) {\n        return NextResponse.json({ error: \"Access denied. You can only access your assigned branch.\" }, { status: 403 })\n      }\n    }\n\n    const branchResult = await query<any>(`\n      SELECT \n        b.id,\n        b.bhf_id,\n        b.device_serial_number,\n        b.server_address,\n        b.server_port,\n        b.kra_pin,\n        v.kra_pin as vendor_kra_pin\n      FROM branches b\n      LEFT JOIN vendors v ON b.vendor_id = v.id\n      WHERE b.id = $1\n    `, [branch_id])\n\n    const branch = branchResult[0]\n    const tin = branch.kra_pin || branch.vendor_kra_pin\n    const bhfId = branch.bhf_id\n    const dvcSrlNo = branch.device_serial_number\n\n    if (!tin) {\n      return NextResponse.json({ error: \"KRA PIN not configured for this branch\" }, { status: 400 })\n    }\n    if (!bhfId) {\n      return NextResponse.json({ error: \"BHF ID not configured for this branch\" }, { status: 400 })\n    }\n    if (!dvcSrlNo) {\n      return NextResponse.json({ error: \"Device Serial Number not configured for this branch\" }, { status: 400 })\n    }\n\n    const kraBaseUrl = buildKraBaseUrl(branch.server_address, branch.server_port)\n    const endpoint = `${kraBaseUrl}/initializer/selectInitInfo`\n\n    const payload = {\n      tin,\n      bhfId,\n      dvcSrlNo\n    }\n\n    let responseData: any\n    let status = \"success\"\n\n    try {\n      const kraResponse = await fetch(endpoint, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\"\n        },\n        body: JSON.stringify(payload)\n      })\n\n      responseData = await kraResponse.json()\n      \n      if (!kraResponse.ok) {\n        status = \"error\"\n      }\n    } catch (fetchError: any) {\n      status = \"error\"\n      responseData = { error: fetchError.message || \"Failed to connect to KRA server\" }\n    }\n\n    await query(`\n      INSERT INTO branch_logs (branch_id, log_type, endpoint, request_payload, response_payload, status)\n      VALUES ($1, $2, $3, $4, $5, $6)\n    `, [branch_id, \"kra_initialize\", endpoint, JSON.stringify(payload), JSON.stringify(responseData), status])\n\n    return NextResponse.json({\n      success: status === \"success\",\n      endpoint,\n      request: payload,\n      response: responseData\n    })\n  } catch (error: any) {\n    console.error(\"Error in KRA initialize:\", error)\n    return NextResponse.json({ error: error.message || \"Failed to initialize\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}