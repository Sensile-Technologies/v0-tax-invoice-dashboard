{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/client.ts"],"sourcesContent":["import { Pool } from 'pg';\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,\n});\n\nexport async function query<T = any>(text: string, params?: any[]): Promise<T[]> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rows as T[];\n  } finally {\n    client.release();\n  }\n}\n\nexport async function queryOne<T = any>(text: string, params?: any[]): Promise<T | null> {\n  const rows = await query<T>(text, params);\n  return rows[0] || null;\n}\n\nexport async function execute(text: string, params?: any[]): Promise<number> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rowCount || 0;\n  } finally {\n    client.release();\n  }\n}\n\nexport async function getClient() {\n  return await pool.connect();\n}\n\nexport { pool };\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,sCAAwC,0BAAgC;AAC/E;AAEO,eAAe,MAAe,IAAY,EAAE,MAAc;IAC/D,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,IAAI;IACpB,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe,SAAkB,IAAY,EAAE,MAAc;IAClE,MAAM,OAAO,MAAM,MAAS,MAAM;IAClC,OAAO,IAAI,CAAC,EAAE,IAAI;AACpB;AAEO,eAAe,QAAQ,IAAY,EAAE,MAAc;IACxD,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,QAAQ,IAAI;IAC5B,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe;IACpB,OAAO,MAAM,KAAK,OAAO;AAC3B"}},
    {"offset": {"line": 113, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/branches/list/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { query } from \"@/lib/db/client\";\nimport { cookies } from \"next/headers\";\n\nasync function getSessionUserId(): Promise<string | null> {\n  try {\n    const cookieStore = await cookies();\n    const sessionCookie = cookieStore.get(\"user_session\");\n    if (!sessionCookie?.value) return null;\n    \n    const session = JSON.parse(sessionCookie.value);\n    // SECURITY: Only trust the user ID from cookie, derive everything else from database\n    return session.id || null;\n  } catch {\n    return null;\n  }\n}\n\nasync function getVendorIdFromUser(userId: string): Promise<string | null> {\n  // Try to get vendor_id from user's vendor record\n  const vendorResult = await query(\n    `SELECT v.id as vendor_id FROM users u \n     JOIN vendors v ON v.email = u.email \n     WHERE u.id = $1`,\n    [userId]\n  );\n  if (vendorResult && vendorResult.length > 0) {\n    return vendorResult[0].vendor_id;\n  }\n  \n  // Try to get vendor_id from user's staff record\n  const staffResult = await query(\n    `SELECT DISTINCT b.vendor_id FROM staff s\n     JOIN branches b ON s.branch_id = b.id\n     WHERE s.user_id = $1 AND b.vendor_id IS NOT NULL`,\n    [userId]\n  );\n  if (staffResult && staffResult.length > 0) {\n    return staffResult[0].vendor_id;\n  }\n  \n  return null;\n}\n\nasync function getUserRoleAndBranch(userId: string): Promise<{ role: string | null; branchId: string | null }> {\n  const result = await query(\n    `SELECT COALESCE(s.role, u.role) as role, s.branch_id\n     FROM users u \n     LEFT JOIN staff s ON s.user_id = u.id\n     WHERE u.id = $1`,\n    [userId]\n  );\n  if (result && result.length > 0) {\n    return { role: result[0].role, branchId: result[0].branch_id };\n  }\n  return { role: null, branchId: null };\n}\n\nexport async function GET(request: Request) {\n  try {\n    // SECURITY: Get user ID from httpOnly session cookie\n    const userId = await getSessionUserId();\n    \n    if (!userId) {\n      return NextResponse.json(\n        { error: 'Unauthorized. Please log in.' },\n        { status: 401 }\n      );\n    }\n    \n    // SECURITY: Always derive vendor_id and role from database (never trust cookie values)\n    const vendorId = await getVendorIdFromUser(userId);\n    const { role, branchId } = await getUserRoleAndBranch(userId);\n    \n    const restrictedRoles = ['supervisor', 'manager'];\n    const isRestricted = role && restrictedRoles.includes(role.toLowerCase());\n    \n    // For managers/supervisors, only return their assigned branch\n    if (isRestricted && branchId) {\n      const branches = await query(\n        `SELECT * FROM branches WHERE id = $1 AND status IN ('active', 'pending_onboarding')`,\n        [branchId]\n      );\n      return NextResponse.json(branches || []);\n    }\n    \n    // SECURITY: Must have vendor_id to list branches\n    if (!vendorId) {\n      return NextResponse.json([]);\n    }\n    \n    const { searchParams } = new URL(request.url);\n    const name = searchParams.get(\"name\");\n    \n    // Build query with vendor filter\n    let sql = \"SELECT * FROM branches WHERE status IN ('active', 'pending_onboarding') AND vendor_id = $1\";\n    const params: any[] = [vendorId];\n    let paramIndex = 2;\n    \n    if (name) {\n      sql += ` AND LOWER(name) LIKE LOWER($${paramIndex})`;\n      params.push(`%${name}%`);\n      paramIndex++;\n    }\n    \n    sql += \" ORDER BY name\";\n    \n    const branches = await query(sql, params);\n    \n    return NextResponse.json(branches || []);\n  } catch (error: any) {\n    console.error(\"Error fetching branches:\", error);\n    return NextResponse.json({ error: error.message }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;;;;;AAEA,eAAe;IACb,IAAI;QACF,MAAM,cAAc,MAAM,IAAA,4IAAO;QACjC,MAAM,gBAAgB,YAAY,GAAG,CAAC;QACtC,IAAI,CAAC,eAAe,OAAO,OAAO;QAElC,MAAM,UAAU,KAAK,KAAK,CAAC,cAAc,KAAK;QAC9C,qFAAqF;QACrF,OAAO,QAAQ,EAAE,IAAI;IACvB,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEA,eAAe,oBAAoB,MAAc;IAC/C,iDAAiD;IACjD,MAAM,eAAe,MAAM,IAAA,8HAAK,EAC9B,CAAC;;oBAEe,CAAC,EACjB;QAAC;KAAO;IAEV,IAAI,gBAAgB,aAAa,MAAM,GAAG,GAAG;QAC3C,OAAO,YAAY,CAAC,EAAE,CAAC,SAAS;IAClC;IAEA,gDAAgD;IAChD,MAAM,cAAc,MAAM,IAAA,8HAAK,EAC7B,CAAC;;qDAEgD,CAAC,EAClD;QAAC;KAAO;IAEV,IAAI,eAAe,YAAY,MAAM,GAAG,GAAG;QACzC,OAAO,WAAW,CAAC,EAAE,CAAC,SAAS;IACjC;IAEA,OAAO;AACT;AAEA,eAAe,qBAAqB,MAAc;IAChD,MAAM,SAAS,MAAM,IAAA,8HAAK,EACxB,CAAC;;;oBAGe,CAAC,EACjB;QAAC;KAAO;IAEV,IAAI,UAAU,OAAO,MAAM,GAAG,GAAG;QAC/B,OAAO;YAAE,MAAM,MAAM,CAAC,EAAE,CAAC,IAAI;YAAE,UAAU,MAAM,CAAC,EAAE,CAAC,SAAS;QAAC;IAC/D;IACA,OAAO;QAAE,MAAM;QAAM,UAAU;IAAK;AACtC;AAEO,eAAe,IAAI,OAAgB;IACxC,IAAI;QACF,qDAAqD;QACrD,MAAM,SAAS,MAAM;QAErB,IAAI,CAAC,QAAQ;YACX,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA+B,GACxC;gBAAE,QAAQ;YAAI;QAElB;QAEA,uFAAuF;QACvF,MAAM,WAAW,MAAM,oBAAoB;QAC3C,MAAM,EAAE,IAAI,EAAE,QAAQ,EAAE,GAAG,MAAM,qBAAqB;QAEtD,MAAM,kBAAkB;YAAC;YAAc;SAAU;QACjD,MAAM,eAAe,QAAQ,gBAAgB,QAAQ,CAAC,KAAK,WAAW;QAEtE,8DAA8D;QAC9D,IAAI,gBAAgB,UAAU;YAC5B,MAAM,WAAW,MAAM,IAAA,8HAAK,EAC1B,CAAC,mFAAmF,CAAC,EACrF;gBAAC;aAAS;YAEZ,OAAO,gJAAY,CAAC,IAAI,CAAC,YAAY,EAAE;QACzC;QAEA,iDAAiD;QACjD,IAAI,CAAC,UAAU;YACb,OAAO,gJAAY,CAAC,IAAI,CAAC,EAAE;QAC7B;QAEA,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,OAAO,aAAa,GAAG,CAAC;QAE9B,iCAAiC;QACjC,IAAI,MAAM;QACV,MAAM,SAAgB;YAAC;SAAS;QAChC,IAAI,aAAa;QAEjB,IAAI,MAAM;YACR,OAAO,CAAC,6BAA6B,EAAE,WAAW,CAAC,CAAC;YACpD,OAAO,IAAI,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC;YACvB;QACF;QAEA,OAAO;QAEP,MAAM,WAAW,MAAM,IAAA,8HAAK,EAAC,KAAK;QAElC,OAAO,gJAAY,CAAC,IAAI,CAAC,YAAY,EAAE;IACzC,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,MAAM,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IACnE;AACF"}}]
}