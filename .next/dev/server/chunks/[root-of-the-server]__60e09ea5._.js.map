{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/client.ts"],"sourcesContent":["import { Pool } from 'pg';\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,\n});\n\nexport async function query<T = any>(text: string, params?: any[]): Promise<T[]> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rows as T[];\n  } finally {\n    client.release();\n  }\n}\n\nexport async function queryOne<T = any>(text: string, params?: any[]): Promise<T | null> {\n  const rows = await query<T>(text, params);\n  return rows[0] || null;\n}\n\nexport async function execute(text: string, params?: any[]): Promise<number> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rowCount || 0;\n  } finally {\n    client.release();\n  }\n}\n\nexport async function getClient() {\n  return await pool.connect();\n}\n\nexport { pool };\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,sCAAwC,0BAAgC;AAC/E;AAEO,eAAe,MAAe,IAAY,EAAE,MAAc;IAC/D,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,IAAI;IACpB,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe,SAAkB,IAAY,EAAE,MAAc;IAClE,MAAM,OAAO,MAAM,MAAS,MAAM;IAClC,OAAO,IAAI,CAAC,EAAE,IAAI;AACpB;AAEO,eAAe,QAAQ,IAAY,EAAE,MAAc;IACxD,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,QAAQ,IAAI;IAC5B,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe;IACpB,OAAO,MAAM,KAAK,OAAO;AAC3B"}},
    {"offset": {"line": 113, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/branches/list/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { query } from \"@/lib/db/client\";\nimport { cookies } from \"next/headers\";\n\nasync function getSessionUserId(): Promise<string | null> {\n  try {\n    const cookieStore = await cookies();\n    const sessionCookie = cookieStore.get(\"user_session\");\n    if (!sessionCookie?.value) return null;\n    \n    const session = JSON.parse(sessionCookie.value);\n    // SECURITY: Only trust the user ID from cookie, derive everything else from database\n    return session.id || null;\n  } catch {\n    return null;\n  }\n}\n\nasync function getVendorIdFromUser(userId: string): Promise<string | null> {\n  // Try to get vendor_id from user's vendor record\n  const vendorResult = await query(\n    `SELECT v.id as vendor_id FROM users u \n     JOIN vendors v ON v.email = u.email \n     WHERE u.id = $1`,\n    [userId]\n  );\n  if (vendorResult && vendorResult.length > 0) {\n    return vendorResult[0].vendor_id;\n  }\n  \n  // Try to get vendor_id from user's staff record\n  const staffResult = await query(\n    `SELECT DISTINCT b.vendor_id FROM staff s\n     JOIN branches b ON s.branch_id = b.id\n     WHERE s.user_id = $1 AND b.vendor_id IS NOT NULL`,\n    [userId]\n  );\n  if (staffResult && staffResult.length > 0) {\n    return staffResult[0].vendor_id;\n  }\n  \n  return null;\n}\n\nasync function getUserRoleAndBranch(userId: string): Promise<{ role: string | null; branchId: string | null }> {\n  const result = await query(\n    `SELECT COALESCE(s.role, u.role) as role, s.branch_id\n     FROM users u \n     LEFT JOIN staff s ON s.user_id = u.id\n     WHERE u.id = $1`,\n    [userId]\n  );\n  if (result && result.length > 0) {\n    return { role: result[0].role, branchId: result[0].branch_id };\n  }\n  return { role: null, branchId: null };\n}\n\nexport async function GET(request: Request) {\n  try {\n    // SECURITY: Get user ID from httpOnly session cookie\n    const userId = await getSessionUserId();\n    \n    if (!userId) {\n      return NextResponse.json(\n        { error: 'Unauthorized. Please log in.' },\n        { status: 401 }\n      );\n    }\n    \n    // SECURITY: Always derive vendor_id and role from database (never trust cookie values)\n    const vendorId = await getVendorIdFromUser(userId);\n    const { role, branchId } = await getUserRoleAndBranch(userId);\n    \n    const restrictedRoles = ['supervisor', 'manager'];\n    const isRestricted = role && restrictedRoles.includes(role.toLowerCase());\n    \n    // For managers/supervisors, only return their assigned branch with stats\n    if (isRestricted && branchId) {\n      const today = new Date();\n      const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);\n      const startOfLastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);\n      const endOfLastMonth = new Date(today.getFullYear(), today.getMonth(), 0);\n      \n      const branches = await query(\n        `SELECT b.*,\n          COALESCE((\n            SELECT SUM(s.total_amount) \n            FROM sales s \n            WHERE s.branch_id = b.id \n              AND s.created_at >= $2\n          ), 0) as mtd_revenue,\n          COALESCE((\n            SELECT SUM(s.total_amount) \n            FROM sales s \n            WHERE s.branch_id = b.id \n              AND s.created_at >= $3 \n              AND s.created_at <= $4\n          ), 0) as last_month_revenue,\n          COALESCE((\n            SELECT SUM(s.total_amount) \n            FROM sales s \n            JOIN shifts sh ON s.shift_id = sh.id \n            WHERE s.branch_id = b.id \n              AND sh.status = 'active'\n          ), 0) as current_shift_revenue\n        FROM branches b \n        WHERE b.id = $1 AND b.status IN ('active', 'pending_onboarding')`,\n        [branchId, startOfMonth.toISOString(), startOfLastMonth.toISOString(), endOfLastMonth.toISOString()]\n      );\n      \n      const branchesWithStats = (branches || []).map((branch: any) => {\n        const mtdRevenue = parseFloat(branch.mtd_revenue) || 0;\n        const lastMonthRevenue = parseFloat(branch.last_month_revenue) || 0;\n        let growth = 0;\n        if (lastMonthRevenue > 0) {\n          growth = Math.round(((mtdRevenue - lastMonthRevenue) / lastMonthRevenue) * 100);\n        } else if (mtdRevenue > 0) {\n          growth = 100;\n        }\n        return {\n          ...branch,\n          monthToDateRevenue: mtdRevenue,\n          currentShiftRevenue: parseFloat(branch.current_shift_revenue) || 0,\n          performance: `${growth >= 0 ? '+' : ''}${growth}%`\n        };\n      });\n      \n      return NextResponse.json(branchesWithStats);\n    }\n    \n    // SECURITY: Must have vendor_id to list branches\n    if (!vendorId) {\n      return NextResponse.json([]);\n    }\n    \n    const { searchParams } = new URL(request.url);\n    const name = searchParams.get(\"name\");\n    \n    // Build query with vendor filter and per-branch stats\n    const today = new Date();\n    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);\n    const startOfLastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);\n    const endOfLastMonth = new Date(today.getFullYear(), today.getMonth(), 0);\n    \n    let sql = `\n      SELECT b.*,\n        COALESCE((\n          SELECT SUM(s.total_amount) \n          FROM sales s \n          WHERE s.branch_id = b.id \n            AND s.created_at >= $2\n        ), 0) as mtd_revenue,\n        COALESCE((\n          SELECT SUM(s.total_amount) \n          FROM sales s \n          WHERE s.branch_id = b.id \n            AND s.created_at >= $3 \n            AND s.created_at <= $4\n        ), 0) as last_month_revenue,\n        COALESCE((\n          SELECT SUM(s.total_amount) \n          FROM sales s \n          JOIN shifts sh ON s.shift_id = sh.id \n          WHERE s.branch_id = b.id \n            AND sh.status = 'active'\n        ), 0) as current_shift_revenue\n      FROM branches b \n      WHERE b.status IN ('active', 'pending_onboarding') AND b.vendor_id = $1`;\n    const params: any[] = [vendorId, startOfMonth.toISOString(), startOfLastMonth.toISOString(), endOfLastMonth.toISOString()];\n    let paramIndex = 5;\n    \n    if (name) {\n      sql += ` AND LOWER(b.name) LIKE LOWER($${paramIndex})`;\n      params.push(`%${name}%`);\n      paramIndex++;\n    }\n    \n    sql += \" ORDER BY b.name\";\n    \n    const branches = await query(sql, params);\n    \n    // Calculate growth percentage for each branch\n    const branchesWithStats = (branches || []).map((branch: any) => {\n      const mtdRevenue = parseFloat(branch.mtd_revenue) || 0;\n      const lastMonthRevenue = parseFloat(branch.last_month_revenue) || 0;\n      let growth = 0;\n      if (lastMonthRevenue > 0) {\n        growth = Math.round(((mtdRevenue - lastMonthRevenue) / lastMonthRevenue) * 100);\n      } else if (mtdRevenue > 0) {\n        growth = 100;\n      }\n      return {\n        ...branch,\n        monthToDateRevenue: mtdRevenue,\n        currentShiftRevenue: parseFloat(branch.current_shift_revenue) || 0,\n        performance: `${growth >= 0 ? '+' : ''}${growth}%`\n      };\n    });\n    \n    return NextResponse.json(branchesWithStats);\n  } catch (error: any) {\n    console.error(\"Error fetching branches:\", error);\n    return NextResponse.json({ error: error.message }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;;;;;AAEA,eAAe;IACb,IAAI;QACF,MAAM,cAAc,MAAM,IAAA,4IAAO;QACjC,MAAM,gBAAgB,YAAY,GAAG,CAAC;QACtC,IAAI,CAAC,eAAe,OAAO,OAAO;QAElC,MAAM,UAAU,KAAK,KAAK,CAAC,cAAc,KAAK;QAC9C,qFAAqF;QACrF,OAAO,QAAQ,EAAE,IAAI;IACvB,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEA,eAAe,oBAAoB,MAAc;IAC/C,iDAAiD;IACjD,MAAM,eAAe,MAAM,IAAA,8HAAK,EAC9B,CAAC;;oBAEe,CAAC,EACjB;QAAC;KAAO;IAEV,IAAI,gBAAgB,aAAa,MAAM,GAAG,GAAG;QAC3C,OAAO,YAAY,CAAC,EAAE,CAAC,SAAS;IAClC;IAEA,gDAAgD;IAChD,MAAM,cAAc,MAAM,IAAA,8HAAK,EAC7B,CAAC;;qDAEgD,CAAC,EAClD;QAAC;KAAO;IAEV,IAAI,eAAe,YAAY,MAAM,GAAG,GAAG;QACzC,OAAO,WAAW,CAAC,EAAE,CAAC,SAAS;IACjC;IAEA,OAAO;AACT;AAEA,eAAe,qBAAqB,MAAc;IAChD,MAAM,SAAS,MAAM,IAAA,8HAAK,EACxB,CAAC;;;oBAGe,CAAC,EACjB;QAAC;KAAO;IAEV,IAAI,UAAU,OAAO,MAAM,GAAG,GAAG;QAC/B,OAAO;YAAE,MAAM,MAAM,CAAC,EAAE,CAAC,IAAI;YAAE,UAAU,MAAM,CAAC,EAAE,CAAC,SAAS;QAAC;IAC/D;IACA,OAAO;QAAE,MAAM;QAAM,UAAU;IAAK;AACtC;AAEO,eAAe,IAAI,OAAgB;IACxC,IAAI;QACF,qDAAqD;QACrD,MAAM,SAAS,MAAM;QAErB,IAAI,CAAC,QAAQ;YACX,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA+B,GACxC;gBAAE,QAAQ;YAAI;QAElB;QAEA,uFAAuF;QACvF,MAAM,WAAW,MAAM,oBAAoB;QAC3C,MAAM,EAAE,IAAI,EAAE,QAAQ,EAAE,GAAG,MAAM,qBAAqB;QAEtD,MAAM,kBAAkB;YAAC;YAAc;SAAU;QACjD,MAAM,eAAe,QAAQ,gBAAgB,QAAQ,CAAC,KAAK,WAAW;QAEtE,yEAAyE;QACzE,IAAI,gBAAgB,UAAU;YAC5B,MAAM,QAAQ,IAAI;YAClB,MAAM,eAAe,IAAI,KAAK,MAAM,WAAW,IAAI,MAAM,QAAQ,IAAI;YACrE,MAAM,mBAAmB,IAAI,KAAK,MAAM,WAAW,IAAI,MAAM,QAAQ,KAAK,GAAG;YAC7E,MAAM,iBAAiB,IAAI,KAAK,MAAM,WAAW,IAAI,MAAM,QAAQ,IAAI;YAEvE,MAAM,WAAW,MAAM,IAAA,8HAAK,EAC1B,CAAC;;;;;;;;;;;;;;;;;;;;;;wEAsB+D,CAAC,EACjE;gBAAC;gBAAU,aAAa,WAAW;gBAAI,iBAAiB,WAAW;gBAAI,eAAe,WAAW;aAAG;YAGtG,MAAM,oBAAoB,CAAC,YAAY,EAAE,EAAE,GAAG,CAAC,CAAC;gBAC9C,MAAM,aAAa,WAAW,OAAO,WAAW,KAAK;gBACrD,MAAM,mBAAmB,WAAW,OAAO,kBAAkB,KAAK;gBAClE,IAAI,SAAS;gBACb,IAAI,mBAAmB,GAAG;oBACxB,SAAS,KAAK,KAAK,CAAC,AAAC,CAAC,aAAa,gBAAgB,IAAI,mBAAoB;gBAC7E,OAAO,IAAI,aAAa,GAAG;oBACzB,SAAS;gBACX;gBACA,OAAO;oBACL,GAAG,MAAM;oBACT,oBAAoB;oBACpB,qBAAqB,WAAW,OAAO,qBAAqB,KAAK;oBACjE,aAAa,GAAG,UAAU,IAAI,MAAM,KAAK,OAAO,CAAC,CAAC;gBACpD;YACF;YAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;QAC3B;QAEA,iDAAiD;QACjD,IAAI,CAAC,UAAU;YACb,OAAO,gJAAY,CAAC,IAAI,CAAC,EAAE;QAC7B;QAEA,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,OAAO,aAAa,GAAG,CAAC;QAE9B,sDAAsD;QACtD,MAAM,QAAQ,IAAI;QAClB,MAAM,eAAe,IAAI,KAAK,MAAM,WAAW,IAAI,MAAM,QAAQ,IAAI;QACrE,MAAM,mBAAmB,IAAI,KAAK,MAAM,WAAW,IAAI,MAAM,QAAQ,KAAK,GAAG;QAC7E,MAAM,iBAAiB,IAAI,KAAK,MAAM,WAAW,IAAI,MAAM,QAAQ,IAAI;QAEvE,IAAI,MAAM,CAAC;;;;;;;;;;;;;;;;;;;;;;;6EAuB8D,CAAC;QAC1E,MAAM,SAAgB;YAAC;YAAU,aAAa,WAAW;YAAI,iBAAiB,WAAW;YAAI,eAAe,WAAW;SAAG;QAC1H,IAAI,aAAa;QAEjB,IAAI,MAAM;YACR,OAAO,CAAC,+BAA+B,EAAE,WAAW,CAAC,CAAC;YACtD,OAAO,IAAI,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC;YACvB;QACF;QAEA,OAAO;QAEP,MAAM,WAAW,MAAM,IAAA,8HAAK,EAAC,KAAK;QAElC,8CAA8C;QAC9C,MAAM,oBAAoB,CAAC,YAAY,EAAE,EAAE,GAAG,CAAC,CAAC;YAC9C,MAAM,aAAa,WAAW,OAAO,WAAW,KAAK;YACrD,MAAM,mBAAmB,WAAW,OAAO,kBAAkB,KAAK;YAClE,IAAI,SAAS;YACb,IAAI,mBAAmB,GAAG;gBACxB,SAAS,KAAK,KAAK,CAAC,AAAC,CAAC,aAAa,gBAAgB,IAAI,mBAAoB;YAC7E,OAAO,IAAI,aAAa,GAAG;gBACzB,SAAS;YACX;YACA,OAAO;gBACL,GAAG,MAAM;gBACT,oBAAoB;gBACpB,qBAAqB,WAAW,OAAO,qBAAqB,KAAK;gBACjE,aAAa,GAAG,UAAU,IAAI,MAAM,KAAK,OAAO,CAAC,CAAC;YACpD;QACF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;IAC3B,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,MAAM,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IACnE;AACF"}}]
}