{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/branches/whatsapp-directors/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\nimport { cookies } from \"next/headers\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nasync function getSession() {\n  const cookieStore = await cookies()\n  const sessionCookie = cookieStore.get(\"user_session\")\n  if (!sessionCookie) return null\n  try {\n    return JSON.parse(sessionCookie.value)\n  } catch {\n    return null\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  const client = await pool.connect()\n  \n  try {\n    const session = await getSession()\n    if (!session) {\n      return NextResponse.json({ success: false, error: \"Unauthorized\" }, { status: 401 })\n    }\n\n    const { searchParams } = new URL(request.url)\n    const branchId = searchParams.get('branch_id')\n\n    if (!branchId) {\n      return NextResponse.json({ success: false, error: \"branch_id is required\" }, { status: 400 })\n    }\n\n    const result = await client.query(\n      `SELECT whatsapp_directors FROM branches WHERE id = $1`,\n      [branchId]\n    )\n\n    if (result.rows.length === 0) {\n      return NextResponse.json({ success: false, error: \"Branch not found\" }, { status: 404 })\n    }\n\n    let directors: string[] = []\n    try {\n      const raw = result.rows[0].whatsapp_directors\n      directors = raw ? (typeof raw === 'string' ? JSON.parse(raw) : raw) : []\n    } catch {\n      directors = []\n    }\n\n    return NextResponse.json({ success: true, directors })\n\n  } catch (error) {\n    console.error(\"Error fetching branch WhatsApp directors:\", error)\n    return NextResponse.json({ success: false, error: \"Failed to fetch directors\" }, { status: 500 })\n  } finally {\n    client.release()\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  const client = await pool.connect()\n  \n  try {\n    const session = await getSession()\n    if (!session) {\n      return NextResponse.json({ success: false, error: \"Unauthorized\" }, { status: 401 })\n    }\n\n    const body = await request.json()\n    const { branch_id, directors } = body\n\n    if (!branch_id) {\n      return NextResponse.json({ success: false, error: \"branch_id is required\" }, { status: 400 })\n    }\n\n    if (!Array.isArray(directors)) {\n      return NextResponse.json({ success: false, error: \"directors must be an array\" }, { status: 400 })\n    }\n\n    const validDirectors = directors.filter((d: string) => \n      typeof d === 'string' && d.match(/^\\+?[0-9]{10,15}$/)\n    )\n\n    await client.query(\n      `UPDATE branches SET whatsapp_directors = $1, updated_at = NOW() WHERE id = $2`,\n      [JSON.stringify(validDirectors), branch_id]\n    )\n\n    return NextResponse.json({ success: true, directors: validDirectors })\n\n  } catch (error) {\n    console.error(\"Error updating branch WhatsApp directors:\", error)\n    return NextResponse.json({ success: false, error: \"Failed to update directors\" }, { status: 500 })\n  } finally {\n    client.release()\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;;;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;AAC5C;AAEA,eAAe;IACb,MAAM,cAAc,MAAM,IAAA,4IAAO;IACjC,MAAM,gBAAgB,YAAY,GAAG,CAAC;IACtC,IAAI,CAAC,eAAe,OAAO;IAC3B,IAAI;QACF,OAAO,KAAK,KAAK,CAAC,cAAc,KAAK;IACvC,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,eAAe,IAAI,OAAoB;IAC5C,MAAM,SAAS,MAAM,KAAK,OAAO;IAEjC,IAAI;QACF,MAAM,UAAU,MAAM;QACtB,IAAI,CAAC,SAAS;YACZ,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAO,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpF;QAEA,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,WAAW,aAAa,GAAG,CAAC;QAElC,IAAI,CAAC,UAAU;YACb,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAO,OAAO;YAAwB,GAAG;gBAAE,QAAQ;YAAI;QAC7F;QAEA,MAAM,SAAS,MAAM,OAAO,KAAK,CAC/B,CAAC,qDAAqD,CAAC,EACvD;YAAC;SAAS;QAGZ,IAAI,OAAO,IAAI,CAAC,MAAM,KAAK,GAAG;YAC5B,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAO,OAAO;YAAmB,GAAG;gBAAE,QAAQ;YAAI;QACxF;QAEA,IAAI,YAAsB,EAAE;QAC5B,IAAI;YACF,MAAM,MAAM,OAAO,IAAI,CAAC,EAAE,CAAC,kBAAkB;YAC7C,YAAY,MAAO,OAAO,QAAQ,WAAW,KAAK,KAAK,CAAC,OAAO,MAAO,EAAE;QAC1E,EAAE,OAAM;YACN,YAAY,EAAE;QAChB;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM;QAAU;IAEtD,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,6CAA6C;QAC3D,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAO,OAAO;QAA4B,GAAG;YAAE,QAAQ;QAAI;IACjG,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe,KAAK,OAAoB;IAC7C,MAAM,SAAS,MAAM,KAAK,OAAO;IAEjC,IAAI;QACF,MAAM,UAAU,MAAM;QACtB,IAAI,CAAC,SAAS;YACZ,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAO,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpF;QAEA,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,SAAS,EAAE,SAAS,EAAE,GAAG;QAEjC,IAAI,CAAC,WAAW;YACd,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAO,OAAO;YAAwB,GAAG;gBAAE,QAAQ;YAAI;QAC7F;QAEA,IAAI,CAAC,MAAM,OAAO,CAAC,YAAY;YAC7B,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAO,OAAO;YAA6B,GAAG;gBAAE,QAAQ;YAAI;QAClG;QAEA,MAAM,iBAAiB,UAAU,MAAM,CAAC,CAAC,IACvC,OAAO,MAAM,YAAY,EAAE,KAAK,CAAC;QAGnC,MAAM,OAAO,KAAK,CAChB,CAAC,6EAA6E,CAAC,EAC/E;YAAC,KAAK,SAAS,CAAC;YAAiB;SAAU;QAG7C,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM,WAAW;QAAe;IAEtE,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,6CAA6C;QAC3D,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAO,OAAO;QAA6B,GAAG;YAAE,QAAQ;QAAI;IAClG,SAAU;QACR,OAAO,OAAO;IAChB;AACF"}}]
}