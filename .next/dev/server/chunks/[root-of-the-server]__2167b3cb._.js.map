{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/shifts/list/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const branchId = searchParams.get('branch_id')\n    const dateFrom = searchParams.get('date_from')\n    const dateTo = searchParams.get('date_to')\n    const search = searchParams.get('search')\n    const userId = searchParams.get('user_id')\n    const limit = parseInt(searchParams.get('limit') || '50')\n    const offset = parseInt(searchParams.get('offset') || '0')\n\n    let vendorId: string | null = null\n    let userBranchId: string | null = null\n    let userRole: string | null = null\n    \n    if (userId) {\n      const userVendorResult = await pool.query(\n        `SELECT v.id as vendor_id, 'vendor' as role FROM users u \n         JOIN vendors v ON v.email = u.email \n         WHERE u.id = $1`,\n        [userId]\n      )\n      if (userVendorResult.rows.length > 0) {\n        vendorId = userVendorResult.rows[0].vendor_id\n        userRole = 'vendor'\n      } else {\n        const staffResult = await pool.query(\n          `SELECT s.branch_id, s.role, b.vendor_id FROM staff s\n           JOIN branches b ON s.branch_id = b.id\n           WHERE s.user_id = $1 AND b.vendor_id IS NOT NULL`,\n          [userId]\n        )\n        if (staffResult.rows.length > 0) {\n          vendorId = staffResult.rows[0].vendor_id\n          userBranchId = staffResult.rows[0].branch_id\n          userRole = staffResult.rows[0].role\n        }\n      }\n    }\n\n    let query = `\n      SELECT \n        s.id,\n        s.branch_id,\n        s.staff_id,\n        s.start_time,\n        s.end_time,\n        s.opening_cash,\n        s.closing_cash,\n        s.total_sales,\n        s.status,\n        s.notes,\n        s.created_at,\n        b.name as branch_name,\n        st.full_name as staff_name,\n        st.username as staff_username,\n        COALESCE(nr.total_opening_reading, nz.total_nozzle_reading, 0) as total_opening_reading,\n        COALESCE(nr.total_closing_reading, nz.total_nozzle_reading, 0) as total_closing_reading\n      FROM shifts s\n      LEFT JOIN branches b ON s.branch_id = b.id\n      LEFT JOIN staff st ON s.staff_id = st.id\n      LEFT JOIN LATERAL (\n        SELECT \n          SUM(COALESCE(CAST(opening_reading AS numeric), 0)) as total_opening_reading,\n          SUM(COALESCE(CAST(closing_reading AS numeric), 0)) as total_closing_reading\n        FROM shift_readings sr\n        WHERE sr.shift_id = s.id AND sr.reading_type = 'nozzle'\n      ) nr ON true\n      LEFT JOIN LATERAL (\n        SELECT \n          SUM(COALESCE(initial_meter_reading, 0)) as total_nozzle_reading\n        FROM nozzles n\n        WHERE n.branch_id = s.branch_id AND n.status = 'active'\n      ) nz ON true\n      WHERE 1=1\n    `\n    const params: any[] = []\n\n    if (vendorId) {\n      params.push(vendorId)\n      query += ` AND b.vendor_id = $${params.length}`\n    }\n\n    // Supervisors and managers can only see their own branch (overrides any branchId param)\n    if (userRole && ['supervisor', 'manager'].includes(userRole) && userBranchId) {\n      params.push(userBranchId)\n      query += ` AND s.branch_id = $${params.length}`\n    } else if (branchId) {\n      // Filter by specific branch when provided (for all users viewing a specific branch)\n      params.push(branchId)\n      query += ` AND s.branch_id = $${params.length}`\n    }\n\n    if (dateFrom) {\n      params.push(dateFrom)\n      query += ` AND s.start_time >= $${params.length}::timestamp`\n    }\n\n    if (dateTo) {\n      params.push(dateTo + ' 23:59:59')\n      query += ` AND s.start_time <= $${params.length}::timestamp`\n    }\n\n    if (search) {\n      params.push(`%${search}%`)\n      query += ` AND (st.full_name ILIKE $${params.length} OR st.username ILIKE $${params.length} OR b.name ILIKE $${params.length})`\n    }\n\n    const countQuery = query.replace(/SELECT[\\s\\S]*?FROM/, 'SELECT COUNT(*) as total FROM')\n    const countResult = await pool.query(countQuery, params)\n    const total = parseInt(countResult.rows[0]?.total || '0')\n\n    query += ` ORDER BY s.start_time DESC LIMIT $${params.length + 1} OFFSET $${params.length + 2}`\n    params.push(limit, offset)\n\n    const result = await pool.query(query, params)\n\n    const shifts = result.rows.map(shift => {\n      const openingCash = parseFloat(shift.opening_cash) || 0\n      const closingCash = parseFloat(shift.closing_cash) || 0\n      const totalSales = parseFloat(shift.total_sales) || 0\n      const expectedCash = openingCash + totalSales\n      const variance = closingCash - expectedCash\n      const totalOpeningReading = parseFloat(shift.total_opening_reading) || 0\n      const totalClosingReading = parseFloat(shift.total_closing_reading) || 0\n\n      return {\n        ...shift,\n        opening_cash: openingCash,\n        closing_cash: closingCash,\n        total_sales: totalSales,\n        variance: variance,\n        total_opening_reading: totalOpeningReading,\n        total_closing_reading: totalClosingReading,\n        cashier: shift.staff_name || shift.staff_username || 'Unknown'\n      }\n    })\n\n    return NextResponse.json({\n      success: true,\n      data: shifts,\n      pagination: {\n        total,\n        limit,\n        offset,\n        hasMore: offset + shifts.length < total\n      }\n    })\n\n  } catch (error: any) {\n    console.error(\"Error fetching shifts list:\", error)\n    return NextResponse.json(\n      { error: \"Failed to fetch shifts\", details: error.message },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":"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"}}]
}