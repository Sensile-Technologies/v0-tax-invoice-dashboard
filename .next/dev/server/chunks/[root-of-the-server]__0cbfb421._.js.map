{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/purchases/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\nimport { cookies } from \"next/headers\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nasync function getVendorIdFromBranch(branchId: string): Promise<string | null> {\n  const result = await pool.query(\n    `SELECT vendor_id FROM branches WHERE id = $1`,\n    [branchId]\n  )\n  return result.rows[0]?.vendor_id || null\n}\n\nasync function getVendorIdFromSession(): Promise<string | null> {\n  try {\n    const cookieStore = await cookies()\n    const sessionCookie = cookieStore.get(\"user_session\")\n    if (!sessionCookie?.value) return null\n    \n    const session = JSON.parse(sessionCookie.value)\n    const userId = session.id\n    if (!userId) return null\n\n    const userVendor = await pool.query(\n      `SELECT v.id FROM users u \n       JOIN vendors v ON v.email = u.email \n       WHERE u.id = $1`,\n      [userId]\n    )\n    if (userVendor.rows.length > 0) {\n      return userVendor.rows[0].id\n    }\n\n    const staffVendor = await pool.query(\n      `SELECT DISTINCT b.vendor_id FROM staff s\n       JOIN branches b ON s.branch_id = b.id\n       WHERE s.user_id = $1 AND b.vendor_id IS NOT NULL`,\n      [userId]\n    )\n    if (staffVendor.rows.length > 0) {\n      return staffVendor.rows[0].vendor_id\n    }\n\n    return null\n  } catch {\n    return null\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const branchId = searchParams.get(\"branch_id\")\n    const vendorIdParam = searchParams.get(\"vendor_id\")\n    const status = searchParams.get(\"status\")\n    const dateFrom = searchParams.get(\"date_from\")\n    const dateTo = searchParams.get(\"date_to\")\n    const search = searchParams.get(\"search\")\n    const limit = parseInt(searchParams.get(\"limit\") || \"100\")\n\n    let vendorId = vendorIdParam\n    if (!vendorId && branchId) {\n      vendorId = await getVendorIdFromBranch(branchId)\n    }\n    if (!vendorId) {\n      vendorId = await getVendorIdFromSession()\n    }\n\n    let query = `\n      SELECT \n        pt.id,\n        pt.branch_id,\n        pt.invc_no,\n        pt.spplr_nm as supplier_name,\n        pt.spplr_tin as supplier_tin,\n        pt.pchs_dt as purchase_date,\n        pt.tot_item_cnt as item_count,\n        pt.tot_amt as total_amount,\n        pt.tot_tax_amt as tax_amount,\n        pt.tot_taxbl_amt as taxable_amount,\n        pt.pchs_stts_cd as status_code,\n        pt.pchs_ty_cd as purchase_type,\n        pt.pmt_ty_cd as payment_type,\n        pt.remark,\n        pt.created_at,\n        CASE \n          WHEN pt.pchs_stts_cd = '02' THEN 'approved'\n          WHEN pt.pchs_stts_cd = '03' THEN 'rejected'\n          WHEN pt.pchs_stts_cd = '04' THEN 'cancelled'\n          ELSE 'pending'\n        END as status\n      FROM purchase_transactions pt\n      WHERE 1=1\n    `\n\n    const params: any[] = []\n    let paramIndex = 1\n\n    if (branchId) {\n      query += ` AND pt.branch_id = $${paramIndex}`\n      params.push(branchId)\n      paramIndex++\n    }\n\n    if (status) {\n      const statusCode = status === 'approved' ? '02' : status === 'rejected' ? '03' : status === 'cancelled' ? '04' : '01'\n      query += ` AND pt.pchs_stts_cd = $${paramIndex}`\n      params.push(statusCode)\n      paramIndex++\n    }\n\n    if (dateFrom) {\n      query += ` AND pt.pchs_dt >= $${paramIndex}`\n      params.push(dateFrom)\n      paramIndex++\n    }\n\n    if (dateTo) {\n      query += ` AND pt.pchs_dt <= $${paramIndex}`\n      params.push(dateTo)\n      paramIndex++\n    }\n\n    if (search) {\n      query += ` AND (pt.spplr_nm ILIKE $${paramIndex} OR CAST(pt.invc_no AS TEXT) ILIKE $${paramIndex})`\n      params.push(`%${search}%`)\n      paramIndex++\n    }\n\n    query += ` ORDER BY pt.created_at DESC LIMIT $${paramIndex}`\n    params.push(limit)\n\n    const result = await pool.query(query, params)\n\n    const purchases = result.rows.map(row => ({\n      id: row.id,\n      po_number: `PO-${String(row.invc_no || '').padStart(4, '0')}`,\n      supplier: row.supplier_name || 'Unknown Supplier',\n      supplier_tin: row.supplier_tin,\n      date: row.purchase_date ? new Date(row.purchase_date).toISOString().split('T')[0] : null,\n      items: row.item_count || 0,\n      amount: parseFloat(row.total_amount) || 0,\n      tax_amount: parseFloat(row.tax_amount) || 0,\n      status: row.status,\n      purchase_type: row.purchase_type,\n      payment_type: row.payment_type,\n      remark: row.remark,\n      created_at: row.created_at,\n      source: 'transaction'\n    }))\n\n    // Also fetch accepted purchase orders from purchase_orders table\n    let poQuery = `\n      SELECT \n        po.id,\n        po.po_number,\n        po.status,\n        po.approval_status,\n        po.issued_at,\n        po.accepted_at,\n        po.notes,\n        po.created_at,\n        po.branch_id,\n        b.name as branch_name,\n        vp.name as supplier_name,\n        vp.tin as supplier_tin,\n        (SELECT COUNT(*) FROM purchase_order_items WHERE purchase_order_id = po.id) as item_count,\n        (SELECT COALESCE(SUM(total_amount), 0) FROM purchase_order_items WHERE purchase_order_id = po.id) as total_amount,\n        (SELECT COALESCE(SUM(quantity), 0) FROM purchase_order_items WHERE purchase_order_id = po.id) as total_volume\n      FROM purchase_orders po\n      LEFT JOIN vendor_partners vp ON po.supplier_id = vp.id\n      LEFT JOIN branches b ON po.branch_id = b.id\n      WHERE po.status = 'accepted'\n    `\n    const poParams: any[] = []\n    let poParamIndex = 1\n\n    if (vendorId) {\n      poQuery += ` AND po.vendor_id = $${poParamIndex}`\n      poParams.push(vendorId)\n      poParamIndex++\n    }\n\n    if (branchId) {\n      poQuery += ` AND po.branch_id = $${poParamIndex}`\n      poParams.push(branchId)\n      poParamIndex++\n    }\n\n    if (search) {\n      poQuery += ` AND (po.po_number ILIKE $${poParamIndex} OR vp.name ILIKE $${poParamIndex})`\n      poParams.push(`%${search}%`)\n      poParamIndex++\n    }\n\n    poQuery += ` ORDER BY po.accepted_at DESC`\n\n    const poResult = await pool.query(poQuery, poParams)\n\n    const acceptedPOs = poResult.rows.map(row => ({\n      id: row.id,\n      po_number: row.po_number,\n      supplier: row.supplier_name || 'Unknown Supplier',\n      supplier_tin: row.supplier_tin,\n      branch_id: row.branch_id,\n      branch_name: row.branch_name,\n      date: row.accepted_at ? new Date(row.accepted_at).toISOString().split('T')[0] : \n            row.issued_at ? new Date(row.issued_at).toISOString().split('T')[0] : null,\n      items: parseInt(row.item_count) || 0,\n      amount: parseFloat(row.total_amount) || 0,\n      tax_amount: 0,\n      volume: parseFloat(row.total_volume) || 0,\n      status: 'accepted',\n      purchase_type: 'LOCAL',\n      payment_type: null,\n      remark: row.notes,\n      created_at: row.created_at,\n      source: 'purchase_order'\n    }))\n\n    // Combine both lists, with accepted POs first\n    const allPurchases = [...acceptedPOs, ...purchases]\n\n    return NextResponse.json({\n      success: true,\n      purchases: allPurchases,\n      count: allPurchases.length\n    })\n  } catch (error) {\n    console.error(\"Error fetching purchases:\", error)\n    return NextResponse.json(\n      { success: false, error: \"Failed to fetch purchases\" },\n      { status: 500 }\n    )\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const {\n      branch_id,\n      tin,\n      bhf_id,\n      supplier_name,\n      supplier_tin,\n      purchase_date,\n      purchase_type,\n      payment_type,\n      items,\n      total_amount,\n      tax_amount,\n      remark\n    } = body\n\n    const result = await pool.query(`\n      INSERT INTO purchase_transactions (\n        branch_id, tin, bhf_id, spplr_nm, spplr_tin, pchs_dt,\n        pchs_ty_cd, pmt_ty_cd, tot_item_cnt, tot_amt, tot_tax_amt,\n        tot_taxbl_amt, pchs_stts_cd, remark, created_at, updated_at\n      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, '01', $13, NOW(), NOW())\n      RETURNING *\n    `, [\n      branch_id, tin, bhf_id, supplier_name, supplier_tin, purchase_date,\n      purchase_type, payment_type, items?.length || 0, total_amount,\n      tax_amount, (total_amount || 0) - (tax_amount || 0), remark\n    ])\n\n    return NextResponse.json({\n      success: true,\n      purchase: result.rows[0],\n      message: \"Purchase order created successfully\"\n    })\n  } catch (error) {\n    console.error(\"Error creating purchase:\", error)\n    return NextResponse.json(\n      { success: false, error: \"Failed to create purchase\" },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":"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"}}]
}