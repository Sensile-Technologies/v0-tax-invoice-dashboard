{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/client.ts"],"sourcesContent":["import { Pool } from 'pg';\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,\n});\n\nexport async function query<T = any>(text: string, params?: any[]): Promise<T[]> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rows as T[];\n  } finally {\n    client.release();\n  }\n}\n\nexport async function queryOne<T = any>(text: string, params?: any[]): Promise<T | null> {\n  const rows = await query<T>(text, params);\n  return rows[0] || null;\n}\n\nexport async function execute(text: string, params?: any[]): Promise<number> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rowCount || 0;\n  } finally {\n    client.release();\n  }\n}\n\nexport async function getClient() {\n  return await pool.connect();\n}\n\nexport { pool };\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,sCAAwC,0BAAgC;AAC/E;AAEO,eAAe,MAAe,IAAY,EAAE,MAAc;IAC/D,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,IAAI;IACpB,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe,SAAkB,IAAY,EAAE,MAAc;IAClE,MAAM,OAAO,MAAM,MAAS,MAAM;IAClC,OAAO,IAAI,CAAC,EAAE,IAAI;AACpB;AAEO,eAAe,QAAQ,IAAY,EAAE,MAAc;IACxD,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,QAAQ,IAAI;IAC5B,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe;IACpB,OAAO,MAAM,KAAK,OAAO;AAC3B"}},
    {"offset": {"line": 113, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/index.ts"],"sourcesContent":["export * from './client';\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 127, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/api-logger.ts"],"sourcesContent":["import { query } from \"@/lib/db\"\n\nexport interface ApiLogEntry {\n  endpoint: string\n  method: string\n  payload?: any\n  response?: any\n  statusCode?: number\n  error?: string\n  durationMs?: number\n  branchId?: string\n  externalEndpoint?: string\n  logType?: string\n}\n\nfunction deriveLogType(endpoint: string): string {\n  if (endpoint.includes('saveSales')) return 'kra_save_sales'\n  if (endpoint.includes('saveStockItems')) return 'kra_stock_items'\n  if (endpoint.includes('saveStockMaster')) return 'kra_stock_master'\n  if (endpoint.includes('selectInitInfo')) return 'kra_initialize'\n  if (endpoint.includes('saveItem')) return 'kra_save_item'\n  return 'kra_api'\n}\n\nfunction deriveStatus(response: any, statusCode?: number, error?: string): string {\n  if (error) return 'error'\n  if (!response) return 'error'\n  if (response.resultCd === '000' || response.resultCd === '0') return 'success'\n  if (statusCode && statusCode >= 200 && statusCode < 300 && !response.resultCd) return 'success'\n  return 'error'\n}\n\nexport async function logApiCall(entry: ApiLogEntry) {\n  if (!entry.branchId) {\n    console.warn(\"[API Logger] No branchId provided, skipping log\")\n    return\n  }\n\n  try {\n    const logType = entry.logType || deriveLogType(entry.endpoint)\n    const status = deriveStatus(entry.response, entry.statusCode, entry.error)\n\n    console.log(`[API Logger] Logging ${entry.endpoint} for branch ${entry.branchId} with status ${status}`)\n\n    await query(`\n      INSERT INTO branch_logs (branch_id, log_type, endpoint, request_payload, response_payload, status)\n      VALUES ($1, $2, $3, $4, $5, $6)\n    `, [\n      entry.branchId,\n      logType,\n      entry.endpoint,\n      JSON.stringify(entry.payload || {}),\n      JSON.stringify(entry.response || { error: entry.error }),\n      status\n    ])\n    \n    console.log(`[API Logger] Successfully logged ${entry.endpoint}`)\n  } catch (error) {\n    console.error(\"[API Logger] Failed to log API call:\", error)\n    console.error(\"[API Logger] Entry was:\", JSON.stringify({\n      branchId: entry.branchId,\n      endpoint: entry.endpoint,\n      statusCode: entry.statusCode\n    }))\n  }\n}\n\nexport function createApiLogger(endpoint: string, method = \"POST\") {\n  const startTime = Date.now()\n\n  return {\n    success: async (payload: any, response: any, branchId?: string, externalEndpoint?: string) => {\n      const duration = Date.now() - startTime\n      await logApiCall({\n        endpoint,\n        method,\n        payload,\n        response,\n        statusCode: 200,\n        durationMs: duration,\n        branchId,\n        externalEndpoint,\n      })\n    },\n    error: async (payload: any, error: any, statusCode = 500, branchId?: string, externalEndpoint?: string) => {\n      const duration = Date.now() - startTime\n      await logApiCall({\n        endpoint,\n        method,\n        payload,\n        error: error?.message || String(error),\n        statusCode,\n        durationMs: duration,\n        branchId,\n        externalEndpoint,\n      })\n    },\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;;;;;;;AAeA,SAAS,cAAc,QAAgB;IACrC,IAAI,SAAS,QAAQ,CAAC,cAAc,OAAO;IAC3C,IAAI,SAAS,QAAQ,CAAC,mBAAmB,OAAO;IAChD,IAAI,SAAS,QAAQ,CAAC,oBAAoB,OAAO;IACjD,IAAI,SAAS,QAAQ,CAAC,mBAAmB,OAAO;IAChD,IAAI,SAAS,QAAQ,CAAC,aAAa,OAAO;IAC1C,OAAO;AACT;AAEA,SAAS,aAAa,QAAa,EAAE,UAAmB,EAAE,KAAc;IACtE,IAAI,OAAO,OAAO;IAClB,IAAI,CAAC,UAAU,OAAO;IACtB,IAAI,SAAS,QAAQ,KAAK,SAAS,SAAS,QAAQ,KAAK,KAAK,OAAO;IACrE,IAAI,cAAc,cAAc,OAAO,aAAa,OAAO,CAAC,SAAS,QAAQ,EAAE,OAAO;IACtF,OAAO;AACT;AAEO,eAAe,WAAW,KAAkB;IACjD,IAAI,CAAC,MAAM,QAAQ,EAAE;QACnB,QAAQ,IAAI,CAAC;QACb;IACF;IAEA,IAAI;QACF,MAAM,UAAU,MAAM,OAAO,IAAI,cAAc,MAAM,QAAQ;QAC7D,MAAM,SAAS,aAAa,MAAM,QAAQ,EAAE,MAAM,UAAU,EAAE,MAAM,KAAK;QAEzE,QAAQ,GAAG,CAAC,CAAC,qBAAqB,EAAE,MAAM,QAAQ,CAAC,YAAY,EAAE,MAAM,QAAQ,CAAC,aAAa,EAAE,QAAQ;QAEvG,MAAM,IAAA,8HAAK,EAAC,CAAC;;;IAGb,CAAC,EAAE;YACD,MAAM,QAAQ;YACd;YACA,MAAM,QAAQ;YACd,KAAK,SAAS,CAAC,MAAM,OAAO,IAAI,CAAC;YACjC,KAAK,SAAS,CAAC,MAAM,QAAQ,IAAI;gBAAE,OAAO,MAAM,KAAK;YAAC;YACtD;SACD;QAED,QAAQ,GAAG,CAAC,CAAC,iCAAiC,EAAE,MAAM,QAAQ,EAAE;IAClE,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,wCAAwC;QACtD,QAAQ,KAAK,CAAC,2BAA2B,KAAK,SAAS,CAAC;YACtD,UAAU,MAAM,QAAQ;YACxB,UAAU,MAAM,QAAQ;YACxB,YAAY,MAAM,UAAU;QAC9B;IACF;AACF;AAEO,SAAS,gBAAgB,QAAgB,EAAE,SAAS,MAAM;IAC/D,MAAM,YAAY,KAAK,GAAG;IAE1B,OAAO;QACL,SAAS,OAAO,SAAc,UAAe,UAAmB;YAC9D,MAAM,WAAW,KAAK,GAAG,KAAK;YAC9B,MAAM,WAAW;gBACf;gBACA;gBACA;gBACA;gBACA,YAAY;gBACZ,YAAY;gBACZ;gBACA;YACF;QACF;QACA,OAAO,OAAO,SAAc,OAAY,aAAa,GAAG,EAAE,UAAmB;YAC3E,MAAM,WAAW,KAAK,GAAG,KAAK;YAC9B,MAAM,WAAW;gBACf;gBACA;gBACA;gBACA,OAAO,OAAO,WAAW,OAAO;gBAChC;gBACA,YAAY;gBACZ;gBACA;YACF;QACF;IACF;AACF"}},
    {"offset": {"line": 224, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/kra-url-helper.ts"],"sourcesContent":["export function buildKraBaseUrl(\n  serverAddress: string | null | undefined,\n  serverPort: string | null | undefined\n): string {\n  const DEFAULT_SERVER = '5.189.171.160'\n  const DEFAULT_PORT = '8088'\n  \n  if (!serverAddress) {\n    return `http://${DEFAULT_SERVER}:${serverPort || DEFAULT_PORT}`\n  }\n  \n  let address = serverAddress.trim()\n  \n  const hasScheme = /^https?:\\/\\//i.test(address)\n  if (hasScheme) {\n    address = address.replace(/^https?:\\/\\//i, '')\n  }\n  \n  address = address.replace(/\\/+$/, '')\n  \n  const hasPort = /:\\d+$/.test(address)\n  \n  if (hasPort) {\n    return `http://${address}`\n  }\n  \n  return `http://${address}:${serverPort || DEFAULT_PORT}`\n}\n"],"names":[],"mappings":";;;;AAAO,SAAS,gBACd,aAAwC,EACxC,UAAqC;IAErC,MAAM,iBAAiB;IACvB,MAAM,eAAe;IAErB,IAAI,CAAC,eAAe;QAClB,OAAO,CAAC,OAAO,EAAE,eAAe,CAAC,EAAE,cAAc,cAAc;IACjE;IAEA,IAAI,UAAU,cAAc,IAAI;IAEhC,MAAM,YAAY,gBAAgB,IAAI,CAAC;IACvC,IAAI,WAAW;QACb,UAAU,QAAQ,OAAO,CAAC,iBAAiB;IAC7C;IAEA,UAAU,QAAQ,OAAO,CAAC,QAAQ;IAElC,MAAM,UAAU,QAAQ,IAAI,CAAC;IAE7B,IAAI,SAAS;QACX,OAAO,CAAC,OAAO,EAAE,SAAS;IAC5B;IAEA,OAAO,CAAC,OAAO,EAAE,QAAQ,CAAC,EAAE,cAAc,cAAc;AAC1D"}},
    {"offset": {"line": 252, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/kra-stock-sync.ts"],"sourcesContent":["import { query } from \"@/lib/db\"\nimport { logApiCall } from \"@/lib/api-logger\"\nimport { buildKraBaseUrl } from \"@/lib/kra-url-helper\"\n\nconst DEFAULT_KRA_URL = process.env.KRA_VSCU_URL || \"http://5.189.171.160:8088\"\n\ninterface BranchKraConfig {\n  tin: string\n  bhfId: string\n  serverAddress: string\n  serverPort: string\n}\n\nasync function getBranchKraConfig(branchId: string): Promise<BranchKraConfig | null> {\n  const result = await query(`\n    SELECT b.kra_pin as tin, b.bhf_id, \n           COALESCE(b.server_address, '5.189.171.160') as server_address, \n           COALESCE(b.server_port, '8088') as server_port\n    FROM branches b\n    WHERE b.id = $1\n  `, [branchId])\n  \n  if (result.length === 0 || !result[0].tin) return null\n  return { \n    tin: result[0].tin, \n    bhfId: result[0].bhf_id || \"00\",\n    serverAddress: result[0].server_address,\n    serverPort: result[0].server_port\n  }\n}\n\ninterface StockSyncItem {\n  itemCode: string\n  itemClassCode: string\n  itemName: string\n  packageUnit: string\n  quantityUnit: string\n  quantity: number\n  unitPrice: number\n  taxType: string\n}\n\ninterface StockSyncResult {\n  success: boolean\n  saveStockItemsResponse?: any\n  saveStockMasterResponses?: any[]\n  error?: string\n}\n\nasync function getBranchKraInfo(branchId: string): Promise<{ tin: string, bhfId: string } | null> {\n  const result = await query(`\n    SELECT kra_pin as tin, bhf_id \n    FROM branches \n    WHERE id = $1\n  `, [branchId])\n  \n  if (result.length === 0 || !result[0].tin) return null\n  return { tin: result[0].tin, bhfId: result[0].bhf_id || \"00\" }\n}\n\nasync function getNextSarNo(branchId: string): Promise<number> {\n  const result = await query(`\n    UPDATE branches \n    SET sr_number = COALESCE(sr_number, 0) + 1,\n        updated_at = NOW()\n    WHERE id = $1\n    RETURNING sr_number\n  `, [branchId])\n  \n  if (result.length === 0) {\n    throw new Error(`Branch ${branchId} not found`)\n  }\n  \n  return result[0].sr_number\n}\n\nfunction formatKraDate(date: Date = new Date()): string {\n  const year = date.getFullYear()\n  const month = String(date.getMonth() + 1).padStart(2, '0')\n  const day = String(date.getDate()).padStart(2, '0')\n  return `${year}${month}${day}`\n}\n\nfunction toFixed2(num: number): string {\n  return (Math.round(num * 100) / 100).toFixed(2)\n}\n\nfunction calculateTaxAmount(amount: number, taxType: string = \"B\"): number {\n  if (taxType === \"B\") {\n    return Math.round(amount * 0.16 * 100) / 100\n  } else if (taxType === \"A\") {\n    return Math.round((amount / 1.16) * 0.16 * 100) / 100\n  } else if (taxType === \"C\") {\n    return Math.round(amount * 0.08 * 100) / 100\n  }\n  return 0\n}\n\nasync function callSaveStockItems(\n  branchId: string,\n  sarTyCd: string,\n  items: StockSyncItem[]\n): Promise<{ success: boolean; response: any; sarNo: number }> {\n  const startTime = Date.now()\n  \n  const kraConfig = await getBranchKraConfig(branchId)\n  if (!kraConfig) {\n    return { \n      success: false, \n      response: { resultCd: \"CONFIG_ERROR\", resultMsg: \"Branch KRA info not configured\" },\n      sarNo: 0 \n    }\n  }\n  \n  const kraInfo = { tin: kraConfig.tin, bhfId: kraConfig.bhfId }\n  const kraBaseUrl = buildKraBaseUrl(kraConfig.serverAddress, kraConfig.serverPort)\n  \n  const sarNo = await getNextSarNo(branchId)\n  \n  let totTaxblAmt = 0\n  let totTaxAmt = 0\n  let totAmt = 0\n  \n  const itemList = items.map((item, index) => {\n    const splyAmt = Math.round(item.quantity * item.unitPrice * 100) / 100\n    const taxAmt = calculateTaxAmount(splyAmt, item.taxType)\n    \n    totTaxblAmt += splyAmt\n    totTaxAmt += taxAmt\n    totAmt += splyAmt\n    \n    return {\n      itemSeq: index + 1,\n      itemCd: item.itemCode,\n      itemClsCd: item.itemClassCode || \"15100000\",\n      itemNm: item.itemName,\n      bcd: null,\n      pkgUnitCd: item.packageUnit || \"NT\",\n      pkg: Math.ceil(item.quantity),\n      qtyUnitCd: item.quantityUnit || \"LTR\",\n      qty: parseFloat(item.quantity.toFixed(2)),\n      itemExprDt: null,\n      prc: item.unitPrice,\n      splyAmt: toFixed2(splyAmt),\n      totDcAmt: 0,\n      taxblAmt: toFixed2(splyAmt),\n      taxTyCd: item.taxType || \"B\",\n      taxAmt: toFixed2(taxAmt),\n      totAmt: toFixed2(splyAmt)\n    }\n  })\n  \n  const payload = {\n    tin: kraInfo.tin,\n    bhfId: kraInfo.bhfId,\n    sarNo,\n    orgSarNo: 0,\n    regTyCd: \"M\",\n    custTin: null,\n    custNm: null,\n    custBhfId: null,\n    sarTyCd,\n    ocrnDt: formatKraDate(),\n    totItemCnt: itemList.length,\n    totTaxblAmt: toFixed2(totTaxblAmt),\n    totTaxAmt: toFixed2(totTaxAmt),\n    totAmt: toFixed2(totAmt),\n    remark: null,\n    regrId: \"Admin\",\n    regrNm: \"Admin\",\n    modrNm: \"Admin\",\n    modrId: \"Admin\",\n    itemList\n  }\n  \n  console.log(`[KRA Stock Sync] Calling saveStockItems with sarTyCd=${sarTyCd}`)\n  console.log(`[KRA Stock Sync] Payload:`, JSON.stringify(payload, null, 2))\n  \n  let response: any\n  let httpStatus = 200\n  \n  try {\n    const controller = new AbortController()\n    const timeoutId = setTimeout(() => controller.abort(), 15000)\n    \n    const res = await fetch(`${kraBaseUrl}/stock/saveStockItems`, {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify(payload),\n      signal: controller.signal\n    })\n    \n    clearTimeout(timeoutId)\n    httpStatus = res.status\n    response = await res.json()\n  } catch (fetchError: any) {\n    response = {\n      resultCd: fetchError.name === 'AbortError' ? \"TIMEOUT\" : \"NETWORK_ERROR\",\n      resultMsg: fetchError.message || \"Failed to connect to KRA\",\n      resultDt: new Date().toISOString()\n    }\n    httpStatus = 0\n  }\n  \n  const duration = Date.now() - startTime\n  console.log(`[KRA Stock Sync] saveStockItems response (${duration}ms):`, JSON.stringify(response, null, 2))\n  \n  await logApiCall({\n    endpoint: \"/stock/saveStockItems\",\n    method: \"POST\",\n    payload,\n    response,\n    statusCode: httpStatus,\n    durationMs: duration,\n    branchId,\n    externalEndpoint: `${kraBaseUrl}/stock/saveStockItems`\n  })\n  \n  const isSuccess = response?.resultCd === \"000\" || response?.resultCd === \"0\"\n  return { success: isSuccess, response, sarNo }\n}\n\nasync function callSaveStockMaster(\n  branchId: string,\n  itemCode: string\n): Promise<{ success: boolean; response: any }> {\n  const startTime = Date.now()\n  \n  const kraConfig = await getBranchKraConfig(branchId)\n  if (!kraConfig) {\n    return { \n      success: false, \n      response: { resultCd: \"CONFIG_ERROR\", resultMsg: \"Branch KRA info not configured\" }\n    }\n  }\n  \n  const kraInfo = { tin: kraConfig.tin, bhfId: kraConfig.bhfId }\n  const kraBaseUrl = buildKraBaseUrl(kraConfig.serverAddress, kraConfig.serverPort)\n  \n  const tankResult = await query(`\n    SELECT t.current_stock \n    FROM tanks t\n    JOIN items i ON t.item_id = i.id\n    WHERE i.item_code = $1 AND t.branch_id = $2\n    LIMIT 1\n  `, [itemCode, branchId])\n  \n  const currentStock = tankResult.length > 0 ? parseFloat(tankResult[0].current_stock) || 0 : 0\n  \n  const payload = {\n    tin: kraInfo.tin,\n    bhfId: kraInfo.bhfId,\n    itemCd: itemCode,\n    rsdQty: currentStock,\n    regrId: \"Admin\",\n    regrNm: \"Admin\",\n    modrNm: \"Admin\",\n    modrId: \"Admin\"\n  }\n  \n  console.log(`[KRA Stock Sync] Calling saveStockMaster for item ${itemCode}`)\n  console.log(`[KRA Stock Sync] Payload:`, JSON.stringify(payload, null, 2))\n  \n  let response: any\n  let httpStatus = 200\n  \n  try {\n    const controller = new AbortController()\n    const timeoutId = setTimeout(() => controller.abort(), 15000)\n    \n    const res = await fetch(`${kraBaseUrl}/stockMaster/saveStockMaster`, {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify(payload),\n      signal: controller.signal\n    })\n    \n    clearTimeout(timeoutId)\n    httpStatus = res.status\n    response = await res.json()\n  } catch (fetchError: any) {\n    response = {\n      resultCd: fetchError.name === 'AbortError' ? \"TIMEOUT\" : \"NETWORK_ERROR\",\n      resultMsg: fetchError.message || \"Failed to connect to KRA\",\n      resultDt: new Date().toISOString()\n    }\n    httpStatus = 0\n  }\n  \n  const duration = Date.now() - startTime\n  console.log(`[KRA Stock Sync] saveStockMaster response for ${itemCode} (${duration}ms):`, JSON.stringify(response, null, 2))\n  \n  await logApiCall({\n    endpoint: \"/stockMaster/saveStockMaster\",\n    method: \"POST\",\n    payload,\n    response,\n    statusCode: httpStatus,\n    durationMs: duration,\n    branchId,\n    externalEndpoint: `${kraBaseUrl}/stockMaster/saveStockMaster`\n  })\n  \n  const isSuccess = response?.resultCd === \"000\" || response?.resultCd === \"0\"\n  return { success: isSuccess, response }\n}\n\nexport async function syncStockAfterSale(\n  branchId: string,\n  items: StockSyncItem[]\n): Promise<StockSyncResult> {\n  try {\n    console.log(`[KRA Stock Sync] Starting stock sync after sale for branch ${branchId}`)\n    \n    const stockItemsResult = await callSaveStockItems(branchId, \"11\", items)\n    \n    if (!stockItemsResult.success) {\n      console.log(`[KRA Stock Sync] saveStockItems failed, skipping saveStockMaster`)\n      return {\n        success: false,\n        saveStockItemsResponse: stockItemsResult.response,\n        error: stockItemsResult.response?.resultMsg || \"saveStockItems failed\"\n      }\n    }\n    \n    const stockMasterResponses: any[] = []\n    for (const item of items) {\n      const masterResult = await callSaveStockMaster(branchId, item.itemCode)\n      stockMasterResponses.push({\n        itemCode: item.itemCode,\n        ...masterResult\n      })\n    }\n    \n    console.log(`[KRA Stock Sync] Stock sync after sale completed successfully`)\n    return {\n      success: true,\n      saveStockItemsResponse: stockItemsResult.response,\n      saveStockMasterResponses: stockMasterResponses\n    }\n    \n  } catch (error: any) {\n    console.error(`[KRA Stock Sync] Error during stock sync after sale:`, error)\n    return {\n      success: false,\n      error: error.message || \"Internal error during stock sync\"\n    }\n  }\n}\n\nexport async function syncStockAfterCreditNote(\n  branchId: string,\n  items: StockSyncItem[]\n): Promise<StockSyncResult> {\n  try {\n    console.log(`[KRA Stock Sync] Starting stock sync after credit note for branch ${branchId}`)\n    \n    const stockItemsResult = await callSaveStockItems(branchId, \"03\", items)\n    \n    if (!stockItemsResult.success) {\n      console.log(`[KRA Stock Sync] saveStockItems failed for credit note, skipping saveStockMaster`)\n      return {\n        success: false,\n        saveStockItemsResponse: stockItemsResult.response,\n        error: stockItemsResult.response?.resultMsg || \"saveStockItems failed\"\n      }\n    }\n    \n    const stockMasterResponses: any[] = []\n    for (const item of items) {\n      const masterResult = await callSaveStockMaster(branchId, item.itemCode)\n      stockMasterResponses.push({\n        itemCode: item.itemCode,\n        ...masterResult\n      })\n    }\n    \n    console.log(`[KRA Stock Sync] Stock sync after credit note completed successfully`)\n    return {\n      success: true,\n      saveStockItemsResponse: stockItemsResult.response,\n      saveStockMasterResponses: stockMasterResponses\n    }\n    \n  } catch (error: any) {\n    console.error(`[KRA Stock Sync] Error during stock sync after credit note:`, error)\n    return {\n      success: false,\n      error: error.message || \"Internal error during stock sync\"\n    }\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 610, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/kra-sales-api.ts"],"sourcesContent":["import { query } from \"@/lib/db\"\nimport { logApiCall } from \"@/lib/api-logger\"\nimport { syncStockAfterSale, syncStockAfterCreditNote } from \"@/lib/kra-stock-sync\"\nimport { buildKraBaseUrl } from \"@/lib/kra-url-helper\"\n\nconst DEFAULT_KRA_URL = process.env.KRA_VSCU_URL || \"http://5.189.171.160:8088\"\n\ninterface KraSaleData {\n  branch_id: string\n  invoice_number: string\n  receipt_number: string\n  fuel_type: string\n  quantity: number\n  unit_price: number\n  total_amount: number\n  payment_method: string\n  customer_name?: string\n  customer_pin?: string\n  sale_date: string\n  tank_id?: string\n}\n\ninterface KraResponse {\n  resultCd: string\n  resultMsg: string\n  resultDt: string\n  data?: any\n}\n\ninterface BranchConfig {\n  id: string\n  bhf_id: string\n  kra_pin: string\n  device_token: string\n  server_address: string\n  server_port: string\n  invoice_number: number\n}\n\nconst PAYMENT_TYPE_CODES: Record<string, string> = {\n  'cash': '01',\n  'credit': '02', \n  'mobile_money': '03',\n  'mpesa': '03',\n  'bank_transfer': '04',\n  'card': '05',\n  'cheque': '06',\n  'other': '07'\n}\n\nasync function getBranchConfig(branchId: string): Promise<BranchConfig | null> {\n  try {\n    const result = await query(`\n      SELECT id, bhf_id, kra_pin, device_token, server_address, server_port, COALESCE(invoice_number, 0) as invoice_number\n      FROM branches\n      WHERE id = $1\n    `, [branchId])\n\n    if (result.length === 0) {\n      return null\n    }\n\n    return result[0] as BranchConfig\n  } catch (error) {\n    console.error(\"[KRA Sales API] Error fetching branch config:\", error)\n    return null\n  }\n}\n\nasync function getNextInvoiceNo(branchId: string): Promise<number> {\n  const result = await query(`\n    UPDATE branches \n    SET invoice_number = COALESCE(invoice_number, 0) + 1 \n    WHERE id = $1 \n    RETURNING invoice_number\n  `, [branchId])\n  return result[0]?.invoice_number || 1\n}\n\nasync function getItemInfoByFuelType(branchId: string, fuelType: string): Promise<any> {\n  // ONLY use branch_items for pricing - no fallback to items table\n  const result = await query(`\n    SELECT i.item_code, i.class_code, i.item_name, i.package_unit, \n           i.quantity_unit, i.tax_type, \n           bi.sale_price, \n           bi.purchase_price\n    FROM items i\n    INNER JOIN branch_items bi ON i.id = bi.item_id AND bi.branch_id = $1\n    WHERE (UPPER(i.item_name) = UPPER($2) OR i.item_name ILIKE $3)\n    AND bi.sale_price IS NOT NULL AND bi.sale_price > 0\n    ORDER BY i.created_at DESC\n    LIMIT 1\n  `, [branchId, fuelType, `%${fuelType}%`])\n  \n  return result.length > 0 ? result[0] : null\n}\n\nfunction formatKraDateTime(date: Date = new Date()): string {\n  const year = date.getFullYear()\n  const month = String(date.getMonth() + 1).padStart(2, '0')\n  const day = String(date.getDate()).padStart(2, '0')\n  const hours = String(date.getHours()).padStart(2, '0')\n  const minutes = String(date.getMinutes()).padStart(2, '0')\n  const seconds = String(date.getSeconds()).padStart(2, '0')\n  return `${year}${month}${day}${hours}${minutes}${seconds}`\n}\n\nfunction formatKraDate(date: Date = new Date()): string {\n  const year = date.getFullYear()\n  const month = String(date.getMonth() + 1).padStart(2, '0')\n  const day = String(date.getDate()).padStart(2, '0')\n  return `${year}${month}${day}`\n}\n\nfunction toFixed2(num: number): string {\n  return (Math.round(num * 100) / 100).toFixed(2)\n}\n\nfunction calculateTax(amount: number, taxType: string = \"B\"): { taxblAmt: number, taxAmt: number, taxRt: number } {\n  if (taxType === \"A\") {\n    const taxRt = 16\n    const taxblAmt = amount / (1 + taxRt / 100)\n    const taxAmt = amount - taxblAmt\n    return { taxblAmt: Math.round(taxblAmt * 100) / 100, taxAmt: Math.round(taxAmt * 100) / 100, taxRt }\n  } else if (taxType === \"B\") {\n    const taxRt = 16\n    return { taxblAmt: amount, taxAmt: Math.round(amount * 0.16 * 100) / 100, taxRt }\n  } else if (taxType === \"C\") {\n    const taxRt = 8\n    return { taxblAmt: amount, taxAmt: Math.round(amount * 0.08 * 100) / 100, taxRt }\n  } else if (taxType === \"D\" || taxType === \"E\") {\n    return { taxblAmt: 0, taxAmt: 0, taxRt: 0 }\n  }\n  return { taxblAmt: amount, taxAmt: 0, taxRt: 0 }\n}\n\nexport async function callKraSaveSales(saleData: KraSaleData): Promise<{\n  success: boolean\n  kraResponse: KraResponse | null\n  error?: string\n}> {\n  const startTime = Date.now()\n  \n  try {\n    const branchConfig = await getBranchConfig(saleData.branch_id)\n    \n    if (!branchConfig) {\n      const errorMsg = \"Branch configuration not found\"\n      console.log(`[KRA Sales API] ${errorMsg}`)\n      return { success: false, kraResponse: null, error: errorMsg }\n    }\n\n    if (!branchConfig.kra_pin) {\n      const errorMsg = \"KRA PIN not configured for this branch\"\n      console.log(`[KRA Sales API] ${errorMsg}`)\n      return { \n        success: false, \n        kraResponse: {\n          resultCd: \"CONFIG_ERROR\",\n          resultMsg: errorMsg,\n          resultDt: new Date().toISOString()\n        }, \n        error: errorMsg \n      }\n    }\n\n    const itemInfo = await getItemInfoByFuelType(saleData.branch_id, saleData.fuel_type)\n    const invcNo = await getNextInvoiceNo(saleData.branch_id)\n    \n    if (!itemInfo) {\n      const errorMsg = `No item found for fuel type: ${saleData.fuel_type}`\n      console.log(`[KRA Sales API] ${errorMsg}`)\n      return { \n        success: false, \n        kraResponse: {\n          resultCd: \"ITEM_NOT_FOUND\",\n          resultMsg: errorMsg,\n          resultDt: new Date().toISOString()\n        }, \n        error: errorMsg \n      }\n    }\n    \n    const itemCd = itemInfo.item_code\n    const itemClsCd = itemInfo.class_code || \"15100000\"\n    const itemNm = itemInfo.item_name\n    const pkgUnitCd = itemInfo.package_unit || \"NT\"\n    const qtyUnitCd = itemInfo.quantity_unit || \"LTR\"\n    const taxTyCd = itemInfo.tax_type || \"B\"\n    \n    const prc = Number(itemInfo.sale_price) || 0\n    const qty = saleData.quantity\n    const totAmt = qty * prc\n    \n    console.log(`[KRA Sales API] Item lookup: ${itemNm}, item_code: ${itemCd}, sale_price from DB: ${prc}, qty: ${qty}, totAmt: ${totAmt}`)\n    \n    const { taxblAmt, taxAmt, taxRt } = calculateTax(totAmt, taxTyCd)\n    \n    const now = new Date()\n    const cfmDt = formatKraDateTime(now)\n    const salesDt = formatKraDate(now)\n    \n    const pmtTyCd = PAYMENT_TYPE_CODES[saleData.payment_method?.toLowerCase()] || \"01\"\n    \n    const trdInvcNo = `CIV-${String(invcNo).padStart(6, '0')}`\n\n    const kraPayload = {\n      tin: branchConfig.kra_pin,\n      bhfId: branchConfig.bhf_id || \"00\",\n      trdInvcNo: trdInvcNo,\n      invcNo: String(invcNo),\n      orgInvcNo: 0,\n      custTin: saleData.customer_pin || null,\n      custNm: saleData.customer_name || \"Walk-in Customer\",\n      salesTyCd: \"N\",\n      rcptTyCd: \"S\",\n      pmtTyCd: pmtTyCd,\n      salesSttsCd: \"02\",\n      cfmDt: cfmDt,\n      salesDt: salesDt,\n      stockRlsDt: cfmDt,\n      cnclReqDt: null,\n      cnclDt: null,\n      rfdDt: null,\n      rfdRsnCd: null,\n      totItemCnt: 1,\n      \n      taxblAmtA: taxTyCd === \"A\" ? toFixed2(taxblAmt) : \"0.00\",\n      taxblAmtB: taxTyCd === \"B\" ? toFixed2(taxblAmt) : \"0.00\",\n      taxblAmtC: taxTyCd === \"C\" ? toFixed2(taxblAmt) : \"0.00\",\n      taxblAmtD: \"0.00\",\n      taxblAmtE: \"0.00\",\n      \n      taxRtA: taxTyCd === \"A\" ? toFixed2(taxRt) : \"0.00\",\n      taxRtB: taxTyCd === \"B\" ? toFixed2(taxRt) : \"0.00\",\n      taxRtC: taxTyCd === \"C\" ? toFixed2(taxRt) : \"0.00\",\n      taxRtD: \"0.00\",\n      taxRtE: \"0.00\",\n      \n      taxAmtA: taxTyCd === \"A\" ? toFixed2(taxAmt) : \"0.00\",\n      taxAmtB: taxTyCd === \"B\" ? toFixed2(taxAmt) : \"0.00\",\n      taxAmtC: taxTyCd === \"C\" ? toFixed2(taxAmt) : \"0.00\",\n      taxAmtD: \"0.00\",\n      taxAmtE: \"0.00\",\n      \n      totTaxblAmt: toFixed2(taxblAmt),\n      totTaxAmt: toFixed2(taxAmt),\n      totAmt: toFixed2(totAmt),\n      \n      prchrAcptcYn: \"N\",\n      remark: null,\n      regrNm: \"Admin\",\n      regrId: \"Admin\",\n      modrNm: \"Admin\",\n      modrId: \"Admin\",\n      \n      receipt: {\n        custTin: saleData.customer_pin || null,\n        custMblNo: null,\n        rcptPbctDt: null,\n        trdeNm: null,\n        adrs: null,\n        topMsg: null,\n        btmMsg: null,\n        prchrAcptcYn: \"Y\"\n      },\n      \n      itemList: [\n        {\n          itemSeq: 1,\n          itemCd: itemCd,\n          itemClsCd: itemClsCd,\n          itemNm: itemNm,\n          bcd: null,\n          pkgUnitCd: pkgUnitCd,\n          pkg: 1,\n          qtyUnitCd: qtyUnitCd,\n          qty: parseFloat(qty.toFixed(2)),\n          prc: prc,\n          splyAmt: toFixed2(qty),\n          dcRt: 0.0,\n          dcAmt: 0.0,\n          isrccCd: null,\n          isrccNm: null,\n          isrcRt: 0,\n          isrcAmt: 0,\n          taxTyCd: taxTyCd,\n          taxblAmt: toFixed2(taxblAmt),\n          taxAmt: toFixed2(taxAmt),\n          totAmt: toFixed2(totAmt)\n        }\n      ]\n    }\n\n    const kraBaseUrl = buildKraBaseUrl(branchConfig.server_address, branchConfig.server_port)\n    const kraEndpoint = `${kraBaseUrl}/trnsSales/saveSales`\n    \n    console.log(`[KRA Sales API] Calling endpoint: ${kraEndpoint}`)\n    console.log(`[KRA Sales API] Request payload:`, JSON.stringify(kraPayload, null, 2))\n\n    let kraResponse: KraResponse\n    let httpStatusCode = 200\n\n    try {\n      const controller = new AbortController()\n      const timeoutId = setTimeout(() => controller.abort(), 30000)\n      \n      const response = await fetch(kraEndpoint, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"Accept\": \"application/json\",\n          ...(branchConfig.device_token ? { \"DeviceSerialNo\": branchConfig.device_token } : {})\n        },\n        body: JSON.stringify(kraPayload),\n        signal: controller.signal\n      })\n\n      clearTimeout(timeoutId)\n      httpStatusCode = response.status\n      kraResponse = await response.json()\n      \n      console.log(`[KRA Sales API] HTTP Status: ${response.status}`)\n      console.log(`[KRA Sales API] KRA Result Code: ${kraResponse.resultCd}`)\n      console.log(`[KRA Sales API] KRA Result Message: ${kraResponse.resultMsg}`)\n      console.log(`[KRA Sales API] Response body:`, JSON.stringify(kraResponse, null, 2))\n    } catch (fetchError: any) {\n      httpStatusCode = 0\n      if (fetchError.name === 'AbortError') {\n        kraResponse = {\n          resultCd: \"TIMEOUT\",\n          resultMsg: \"Request timed out after 30 seconds\",\n          resultDt: new Date().toISOString()\n        }\n      } else {\n        kraResponse = {\n          resultCd: \"NETWORK_ERROR\",\n          resultMsg: fetchError.message || \"Failed to connect to KRA backend\",\n          resultDt: new Date().toISOString()\n        }\n      }\n      \n      console.log(`[KRA Sales API] Network error:`, fetchError.message)\n      console.log(`[KRA Sales API] Response (network error):`, JSON.stringify(kraResponse, null, 2))\n    }\n\n    const durationMs = Date.now() - startTime\n    const isSuccess = kraResponse.resultCd === \"000\" || kraResponse.resultCd === \"0\"\n\n    await logApiCall({\n      endpoint: \"/trnsSales/saveSales\",\n      method: \"POST\",\n      payload: kraPayload,\n      response: kraResponse,\n      statusCode: httpStatusCode || 500,\n      durationMs,\n      branchId: saleData.branch_id,\n      externalEndpoint: kraEndpoint\n    })\n\n    if (isSuccess) {\n      console.log(`[KRA Sales API] saveSales successful, now syncing stock with KRA`)\n      \n      try {\n        const stockSyncResult = await syncStockAfterSale(saleData.branch_id, [{\n          itemCode: itemCd,\n          itemClassCode: itemClsCd,\n          itemName: itemNm,\n          packageUnit: pkgUnitCd,\n          quantityUnit: qtyUnitCd,\n          quantity: qty,\n          unitPrice: prc,\n          taxType: taxTyCd\n        }])\n        \n        if (stockSyncResult.success) {\n          console.log(`[KRA Sales API] Stock sync completed successfully`)\n        } else {\n          console.log(`[KRA Sales API] Stock sync failed: ${stockSyncResult.error}`)\n        }\n      } catch (stockError: any) {\n        console.error(`[KRA Sales API] Error during stock sync:`, stockError.message)\n      }\n    }\n    \n    return {\n      success: isSuccess,\n      kraResponse\n    }\n\n  } catch (error: any) {\n    const errorResponse: KraResponse = {\n      resultCd: \"SYSTEM_ERROR\",\n      resultMsg: error.message || \"System error calling KRA API\",\n      resultDt: new Date().toISOString()\n    }\n\n    console.error(`[KRA Sales API] System error:`, error)\n\n    const durationMs = Date.now() - startTime\n    \n    await logApiCall({\n      endpoint: \"/trnsSales/saveSales\",\n      method: \"POST\",\n      payload: { saleData, errorContext: \"System error before KRA call\" },\n      response: errorResponse,\n      statusCode: 500,\n      durationMs,\n      branchId: saleData.branch_id,\n      error: error.message,\n      externalEndpoint: `${DEFAULT_KRA_URL}/trnsSales/saveSales`\n    })\n\n    return {\n      success: false,\n      kraResponse: errorResponse,\n      error: error.message\n    }\n  }\n}\n\nexport async function callKraTestSalesEndpoint(saleData: KraSaleData): Promise<{\n  success: boolean\n  kraResponse: KraResponse | null\n  error?: string\n}> {\n  return callKraSaveSales(saleData)\n}\n\ninterface CreditNoteData {\n  branch_id: string\n  original_sale_id: string\n  original_invoice_no: number\n  refund_reason_code: string\n  customer_tin?: string\n  customer_name?: string\n  items: Array<{\n    item_code: string\n    item_class_code: string\n    item_name: string\n    package_unit: string\n    quantity_unit: string\n    quantity: number\n    price: number\n    tax_type: string\n  }>\n}\n\nconst REFUND_REASON_CODES: Record<string, string> = {\n  'defective': '01',\n  'wrong_item': '02',\n  'customer_request': '03',\n  'price_error': '04',\n  'duplicate': '05',\n  'other': '06'\n}\n\nexport async function callKraCreditNote(creditNoteData: CreditNoteData): Promise<{\n  success: boolean\n  kraResponse: KraResponse | null\n  creditNoteNumber?: string\n  invcNo?: number\n  error?: string\n}> {\n  const startTime = Date.now()\n  \n  try {\n    const branchConfig = await getBranchConfig(creditNoteData.branch_id)\n    \n    if (!branchConfig) {\n      return { success: false, kraResponse: null, error: \"Branch configuration not found\" }\n    }\n\n    if (!branchConfig.kra_pin) {\n      return { \n        success: false, \n        kraResponse: {\n          resultCd: \"CONFIG_ERROR\",\n          resultMsg: \"KRA PIN not configured for this branch\",\n          resultDt: new Date().toISOString()\n        }, \n        error: \"KRA PIN not configured\" \n      }\n    }\n\n    const invcNo = await getNextInvoiceNo(creditNoteData.branch_id)\n    const trdInvcNo = `CR${invcNo}`\n    \n    const now = new Date()\n    const cfmDt = formatKraDateTime(now)\n    const salesDt = formatKraDate(now)\n    \n    const rfdRsnCd = REFUND_REASON_CODES[creditNoteData.refund_reason_code?.toLowerCase()] || \"06\"\n    \n    let totTaxblAmtB = 0\n    let totTaxAmtB = 0\n    let totAmt = 0\n    \n    const itemList = creditNoteData.items.map((item, index) => {\n      const splyAmt = item.quantity * item.price\n      const taxblAmt = splyAmt / 1.16\n      const taxAmt = splyAmt - taxblAmt\n      \n      totTaxblAmtB += taxblAmt\n      totTaxAmtB += taxAmt\n      totAmt += splyAmt\n      \n      return {\n        itemSeq: index + 1,\n        itemCd: item.item_code,\n        itemClsCd: item.item_class_code || \"99013001\",\n        itemNm: item.item_name,\n        bcd: null,\n        pkgUnitCd: item.package_unit || \"BF\",\n        pkg: item.quantity,\n        qtyUnitCd: item.quantity_unit || \"L\",\n        qty: item.quantity,\n        prc: item.price,\n        splyAmt: toFixed2(splyAmt),\n        dcRt: 0.0,\n        dcAmt: 0.0,\n        isrccCd: null,\n        isrccNm: null,\n        isrcRt: null,\n        isrcAmt: null,\n        taxTyCd: item.tax_type || \"B\",\n        taxblAmt: toFixed2(taxblAmt),\n        taxAmt: toFixed2(taxAmt),\n        totAmt: toFixed2(splyAmt)\n      }\n    })\n\n    const kraPayload = {\n      tin: branchConfig.kra_pin,\n      bhfId: branchConfig.bhf_id || \"00\",\n      trdInvcNo: trdInvcNo,\n      invcNo: invcNo,\n      orgInvcNo: creditNoteData.original_invoice_no,\n      custTin: creditNoteData.customer_tin || null,\n      custNm: creditNoteData.customer_name || \"Walk-in Customer\",\n      salesTyCd: \"N\",\n      rcptTyCd: \"R\",\n      pmtTyCd: \"01\",\n      salesSttsCd: \"02\",\n      cfmDt: cfmDt,\n      salesDt: salesDt,\n      stockRlsDt: cfmDt,\n      cnclReqDt: null,\n      cnclDt: null,\n      rfdDt: cfmDt,\n      rfdRsnCd: rfdRsnCd,\n      totItemCnt: itemList.length,\n      taxblAmtA: \"0.00\",\n      taxblAmtB: toFixed2(totTaxblAmtB),\n      taxblAmtC: \"0.00\",\n      taxblAmtD: \"0.00\",\n      taxblAmtE: \"0.00\",\n      taxRtA: \"0.00\",\n      taxRtB: \"16.00\",\n      taxRtC: \"0.00\",\n      taxRtD: \"0.00\",\n      taxRtE: \"0.00\",\n      taxAmtA: \"0.00\",\n      taxAmtB: toFixed2(totTaxAmtB),\n      taxAmtC: \"0.00\",\n      taxAmtD: \"0.00\",\n      taxAmtE: \"0.00\",\n      totTaxblAmt: toFixed2(totTaxblAmtB),\n      totTaxAmt: toFixed2(totTaxAmtB),\n      totAmt: toFixed2(totAmt),\n      prchrAcptcYn: \"N\",\n      remark: null,\n      regrNm: \"Admin\",\n      regrId: \"Admin\",\n      modrNm: \"Admin\",\n      modrId: \"Admin\",\n      receipt: {\n        custTin: creditNoteData.customer_tin || null,\n        custMblNo: null,\n        rcptPbctDt: cfmDt,\n        trdeNm: null,\n        adrs: null,\n        topMsg: null,\n        btmMsg: null,\n        prchrAcptcYn: \"N\"\n      },\n      itemList: itemList\n    }\n\n    const kraBaseUrl = buildKraBaseUrl(branchConfig.server_address, branchConfig.server_port)\n    const kraEndpoint = `${kraBaseUrl}/trnsSales/saveSales`\n    \n    console.log(`[KRA Credit Note API] Calling endpoint: ${kraEndpoint}`)\n    console.log(`[KRA Credit Note API] Request payload:`, JSON.stringify(kraPayload, null, 2))\n\n    let kraResponse: KraResponse\n    let httpStatusCode = 200\n\n    try {\n      const controller = new AbortController()\n      const timeoutId = setTimeout(() => controller.abort(), 30000)\n      \n      const response = await fetch(kraEndpoint, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"Accept\": \"application/json\",\n          ...(branchConfig.device_token ? { \"DeviceSerialNo\": branchConfig.device_token } : {})\n        },\n        body: JSON.stringify(kraPayload),\n        signal: controller.signal\n      })\n\n      clearTimeout(timeoutId)\n      httpStatusCode = response.status\n      kraResponse = await response.json()\n      \n      console.log(`[KRA Credit Note API] HTTP Status: ${response.status}`)\n      console.log(`[KRA Credit Note API] Response:`, JSON.stringify(kraResponse, null, 2))\n    } catch (fetchError: any) {\n      httpStatusCode = 0\n      kraResponse = {\n        resultCd: fetchError.name === 'AbortError' ? \"TIMEOUT\" : \"NETWORK_ERROR\",\n        resultMsg: fetchError.message || \"Failed to connect to KRA backend\",\n        resultDt: new Date().toISOString()\n      }\n      console.log(`[KRA Credit Note API] Network error:`, fetchError.message)\n    }\n\n    const durationMs = Date.now() - startTime\n\n    await logApiCall({\n      endpoint: \"/trnsSales/saveSales\",\n      method: \"POST\",\n      payload: kraPayload,\n      response: kraResponse,\n      statusCode: httpStatusCode || 500,\n      durationMs,\n      branchId: creditNoteData.branch_id,\n      externalEndpoint: kraEndpoint\n    })\n\n    const isSuccess = kraResponse.resultCd === \"000\" || kraResponse.resultCd === \"0\"\n    \n    if (isSuccess) {\n      console.log(`[KRA Credit Note API] saveSales successful for credit note, now syncing stock with KRA`)\n      \n      try {\n        const stockItems = creditNoteData.items.map(item => ({\n          itemCode: item.item_code,\n          itemClassCode: item.item_class_code,\n          itemName: item.item_name,\n          packageUnit: item.package_unit,\n          quantityUnit: item.quantity_unit,\n          quantity: item.quantity,\n          unitPrice: item.price,\n          taxType: item.tax_type\n        }))\n        \n        const stockSyncResult = await syncStockAfterCreditNote(creditNoteData.branch_id, stockItems)\n        \n        if (stockSyncResult.success) {\n          console.log(`[KRA Credit Note API] Stock sync completed successfully for credit note`)\n        } else {\n          console.log(`[KRA Credit Note API] Stock sync failed for credit note: ${stockSyncResult.error}`)\n        }\n      } catch (stockError: any) {\n        console.error(`[KRA Credit Note API] Error during stock sync for credit note:`, stockError.message)\n      }\n    }\n    \n    return {\n      success: isSuccess,\n      kraResponse,\n      creditNoteNumber: trdInvcNo,\n      invcNo: invcNo\n    }\n\n  } catch (error: any) {\n    console.error(`[KRA Credit Note API] System error:`, error)\n    return {\n      success: false,\n      kraResponse: {\n        resultCd: \"SYSTEM_ERROR\",\n        resultMsg: error.message || \"System error calling KRA API\",\n        resultDt: new Date().toISOString()\n      },\n      error: error.message\n    }\n  }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1226, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/shifts/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { Pool, PoolClient } from \"pg\"\nimport { callKraSaveSales } from \"@/lib/kra-sales-api\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nfunction splitIntoAmountDenominations(totalAmount: number): number[] {\n  const denominations: number[] = []\n  let remaining = totalAmount\n\n  const validDenoms = [2500, 2000, 1500, 1000, 500, 300, 200, 100]\n\n  while (remaining >= 100) {\n    const maxDenom = validDenoms.find(d => d <= remaining) || 100\n    const availableDenoms = validDenoms.filter(d => d >= 100 && d <= maxDenom && d <= remaining)\n    \n    if (availableDenoms.length === 0) break\n    \n    const randomDenom = availableDenoms[Math.floor(Math.random() * availableDenoms.length)]\n    denominations.push(randomDenom)\n    remaining -= randomDenom\n  }\n\n  if (remaining > 0 && remaining < 100 && denominations.length > 0) {\n    denominations[denominations.length - 1] += remaining\n  }\n\n  return denominations\n}\n\ninterface SaleForKra {\n  id: string\n  branch_id: string\n  invoice_number: string\n  receipt_number: string\n  fuel_type: string\n  quantity: number\n  unit_price: number\n  total_amount: number\n}\n\nasync function generateBulkSalesFromMeterDiff(\n  client: PoolClient,\n  shiftId: string,\n  branchId: string,\n  staffId: string | null,\n  branchName: string,\n  nozzleReadings: Array<{ nozzle_id: string; opening_reading: number; closing_reading: number }>\n): Promise<{ invoicesCreated: number; totalVolume: number; totalAmount: number; salesForKra: SaleForKra[] }> {\n  \n  const branchCode = branchName.substring(0, 3).toUpperCase().replace(/\\s/g, '')\n  let invoicesCreated = 0\n  let totalVolume = 0\n  let totalAmount = 0\n  let invoiceIndex = 1\n  const salesForKra: SaleForKra[] = []\n\n  for (const reading of nozzleReadings) {\n    const openingReading = parseFloat(String(reading.opening_reading)) || 0\n    const closingReading = parseFloat(String(reading.closing_reading)) || 0\n    const meterDifference = closingReading - openingReading\n\n    if (meterDifference <= 0) continue\n\n    const nozzleInfo = await client.query(\n      `SELECT i.item_name as fuel_type, n.item_id, COALESCE(bi.sale_price, 0) as sale_price\n       FROM nozzles n\n       JOIN items i ON n.item_id = i.id\n       LEFT JOIN branch_items bi ON bi.item_id = n.item_id AND bi.branch_id = $1\n       WHERE n.id = $2`,\n      [branchId, reading.nozzle_id]\n    )\n\n    if (nozzleInfo.rows.length === 0) continue\n\n    const { fuel_type, sale_price } = nozzleInfo.rows[0]\n    const unitPrice = parseFloat(sale_price) || 0\n\n    if (unitPrice <= 0) {\n      console.log(`[BULK SALES] Skipping nozzle ${reading.nozzle_id} - no price configured`)\n      continue\n    }\n\n    // Get invoiced quantity: sum of sales already created on APK for this nozzle during this shift\n    const invoicedResult = await client.query(\n      `SELECT COALESCE(SUM(quantity), 0) as invoiced_quantity\n       FROM sales\n       WHERE shift_id = $1 AND nozzle_id = $2 AND is_automated = false`,\n      [shiftId, reading.nozzle_id]\n    )\n    const invoicedQuantity = parseFloat(invoicedResult.rows[0]?.invoiced_quantity) || 0\n\n    // Bulk volume = meter difference - invoiced quantity (what was already sold via APK)\n    const bulkVolume = meterDifference - invoicedQuantity\n\n    if (bulkVolume <= 0) {\n      console.log(`[BULK SALES] Nozzle ${reading.nozzle_id}: meter diff ${meterDifference}L, invoiced ${invoicedQuantity}L, no bulk needed`)\n      continue\n    }\n\n    console.log(`[BULK SALES] Nozzle ${reading.nozzle_id}: meter diff ${meterDifference}L - invoiced ${invoicedQuantity}L = bulk ${bulkVolume}L`)\n\n    // Bulk sale = bulk volume  price per litre\n    const nozzleTotalAmount = bulkVolume * unitPrice\n    const amountDenominations = splitIntoAmountDenominations(Math.floor(nozzleTotalAmount))\n\n    for (const invoiceAmount of amountDenominations) {\n      const quantity = invoiceAmount / unitPrice\n      const timestamp = Date.now().toString(36).toUpperCase()\n      const invoiceNumber = `BLK-${branchCode}-${timestamp}-${String(invoiceIndex).padStart(4, '0')}`\n      const receiptNumber = `RCP-${timestamp}-${Math.random().toString(36).substring(2, 6).toUpperCase()}`\n\n      const saleResult = await client.query(\n        `INSERT INTO sales (\n          branch_id, shift_id, staff_id, nozzle_id,\n          invoice_number, receipt_number, sale_date,\n          fuel_type, quantity, unit_price, total_amount,\n          payment_method, is_automated, source_system,\n          transmission_status, created_at\n        ) VALUES (\n          $1, $2, $3, $4, $5, $6, NOW(),\n          $7, $8, $9, $10,\n          'cash', true, 'meter_diff_bulk',\n          'pending', NOW()\n        ) RETURNING id`,\n        [branchId, shiftId, staffId, reading.nozzle_id, invoiceNumber, receiptNumber,\n         fuel_type, parseFloat(quantity.toFixed(2)), unitPrice, invoiceAmount]\n      )\n\n      salesForKra.push({\n        id: saleResult.rows[0]?.id,\n        branch_id: branchId,\n        invoice_number: invoiceNumber,\n        receipt_number: receiptNumber,\n        fuel_type,\n        quantity: parseFloat(quantity.toFixed(2)),\n        unit_price: unitPrice,\n        total_amount: invoiceAmount\n      })\n\n      invoicesCreated++\n      totalVolume += quantity\n      totalAmount += invoiceAmount\n      invoiceIndex++\n    }\n  }\n\n  console.log(`[BULK SALES] Generated ${invoicesCreated} invoices, ${totalVolume.toFixed(2)}L, KES ${totalAmount}`)\n  return { invoicesCreated, totalVolume, totalAmount, salesForKra }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const { branch_id, start_time, opening_cash, notes, staff_id, user_id } = body\n\n    if (!branch_id) {\n      return NextResponse.json(\n        { error: \"Branch ID is required\" },\n        { status: 400 }\n      )\n    }\n\n    const existingShift = await pool.query(\n      `SELECT id FROM shifts WHERE branch_id = $1 AND status = 'active'`,\n      [branch_id]\n    )\n\n    if (existingShift.rows.length > 0) {\n      return NextResponse.json(\n        { error: \"An active shift already exists for this branch\" },\n        { status: 400 }\n      )\n    }\n\n    let resolvedStaffId = staff_id\n    if (!resolvedStaffId && user_id) {\n      const staffResult = await pool.query(\n        `SELECT id FROM staff WHERE user_id = $1`,\n        [user_id]\n      )\n      if (staffResult.rows.length > 0) {\n        resolvedStaffId = staffResult.rows[0].id\n      }\n    }\n\n    const result = await pool.query(\n      `INSERT INTO shifts (branch_id, staff_id, start_time, status, opening_cash, notes, created_at)\n       VALUES ($1, $2, $3, 'active', $4, $5, NOW())\n       RETURNING *`,\n      [branch_id, resolvedStaffId || null, start_time || new Date().toISOString(), opening_cash || 0, notes || null]\n    )\n\n    return NextResponse.json({\n      success: true,\n      data: result.rows[0]\n    })\n\n  } catch (error: any) {\n    console.error(\"Error starting shift:\", error)\n    return NextResponse.json(\n      { error: \"Failed to start shift\", details: error.message },\n      { status: 500 }\n    )\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const branchId = searchParams.get('branch_id')\n    const status = searchParams.get('status')\n\n    let query = 'SELECT * FROM shifts WHERE 1=1'\n    const params: any[] = []\n\n    if (branchId) {\n      params.push(branchId)\n      query += ` AND branch_id = $${params.length}`\n    }\n\n    if (status) {\n      params.push(status)\n      query += ` AND status = $${params.length}`\n    }\n\n    query += ' ORDER BY created_at DESC LIMIT 1'\n\n    const result = await pool.query(query, params)\n\n    return NextResponse.json({\n      success: true,\n      data: result.rows[0] || null\n    })\n\n  } catch (error: any) {\n    console.error(\"Error fetching shift:\", error)\n    return NextResponse.json(\n      { error: \"Failed to fetch shift\", details: error.message },\n      { status: 500 }\n    )\n  }\n}\n\nexport async function PATCH(request: NextRequest) {\n  const client = await pool.connect()\n  try {\n    const body = await request.json()\n    const { id, end_time, closing_cash, total_sales, notes, status, nozzle_readings, tank_stocks } = body\n\n    if (!id) {\n      client.release()\n      return NextResponse.json(\n        { error: \"Shift ID is required\" },\n        { status: 400 }\n      )\n    }\n\n    await client.query('BEGIN')\n\n    // Check if this is an active shift being ended\n    const shiftStatusCheck = await client.query(\n      `SELECT status FROM shifts WHERE id = $1`,\n      [id]\n    )\n    \n    if (shiftStatusCheck.rows.length === 0) {\n      await client.query('ROLLBACK')\n      client.release()\n      return NextResponse.json(\n        { error: \"Shift not found\" },\n        { status: 404 }\n      )\n    }\n\n    const currentStatus = shiftStatusCheck.rows[0].status\n    const targetStatus = status || 'completed'\n    \n    // Require nozzle readings when ending an active shift (transitioning to completed)\n    if (currentStatus === 'active' && targetStatus === 'completed') {\n      if (!nozzle_readings || !Array.isArray(nozzle_readings) || nozzle_readings.length === 0) {\n        await client.query('ROLLBACK')\n        client.release()\n        return NextResponse.json(\n          { error: \"Nozzle meter readings are required to end a shift. Please enter closing readings for all nozzles.\" },\n          { status: 400 }\n        )\n      }\n    }\n\n    const shiftCheck = await client.query(\n      `SELECT s.*, b.name as branch_name FROM shifts s\n       JOIN branches b ON s.branch_id = b.id\n       WHERE s.id = $1`,\n      [id]\n    )\n\n    if (shiftCheck.rows.length === 0) {\n      await client.query('ROLLBACK')\n      client.release()\n      return NextResponse.json(\n        { error: \"Shift not found\" },\n        { status: 404 }\n      )\n    }\n\n    const currentShift = shiftCheck.rows[0]\n    const branchId = currentShift.branch_id\n    const branchName = currentShift.branch_name || 'BRN'\n    const staffId = currentShift.staff_id\n    const endTimeValue = end_time || new Date().toISOString()\n\n    const nozzlesResult = await client.query(\n      `SELECT id, initial_meter_reading FROM nozzles WHERE branch_id = $1`,\n      [branchId]\n    )\n    const nozzleBaseReadings: Record<string, number> = {}\n    for (const n of nozzlesResult.rows) {\n      nozzleBaseReadings[n.id] = parseFloat(n.initial_meter_reading) || 0\n    }\n\n    const prevNozzleReadings = await client.query(\n      `SELECT nozzle_id, closing_reading FROM shift_readings \n       WHERE branch_id = $1 AND reading_type = 'nozzle' AND nozzle_id IS NOT NULL\n       ORDER BY created_at DESC`,\n      [branchId]\n    )\n    for (const r of prevNozzleReadings.rows) {\n      if (!nozzleBaseReadings[r.nozzle_id] || parseFloat(r.closing_reading) > nozzleBaseReadings[r.nozzle_id]) {\n        nozzleBaseReadings[r.nozzle_id] = parseFloat(r.closing_reading)\n      }\n    }\n\n    const tanksResult = await client.query(\n      `SELECT id, current_stock FROM tanks WHERE branch_id = $1`,\n      [branchId]\n    )\n    const tankBaseStocks: Record<string, number> = {}\n    for (const t of tanksResult.rows) {\n      tankBaseStocks[t.id] = parseFloat(t.current_stock) || 0\n    }\n\n    if (nozzle_readings && nozzle_readings.length > 0) {\n      for (const reading of nozzle_readings) {\n        if (reading.nozzle_id && !isNaN(reading.closing_reading)) {\n          const openingReading = nozzleBaseReadings[reading.nozzle_id] || 0\n          if (reading.closing_reading < openingReading) {\n            await client.query('ROLLBACK')\n            client.release()\n            return NextResponse.json(\n              { error: `Nozzle closing reading (${reading.closing_reading}) cannot be less than opening reading (${openingReading})` },\n              { status: 400 }\n            )\n          }\n        }\n      }\n    }\n\n    const result = await client.query(\n      `UPDATE shifts \n       SET end_time = $1, closing_cash = $2, total_sales = $3, notes = $4, status = $5, updated_at = NOW()\n       WHERE id = $6\n       RETURNING *`,\n      [endTimeValue, closing_cash || 0, total_sales || 0, notes || null, status || 'completed', id]\n    )\n\n    const shift = result.rows[0]\n\n    await client.query(\n      `DELETE FROM shift_readings WHERE shift_id = $1`,\n      [id]\n    )\n\n    const savedNozzleReadings: Array<{ nozzle_id: string; opening_reading: number; closing_reading: number }> = []\n    \n    if (nozzle_readings && nozzle_readings.length > 0) {\n      for (const reading of nozzle_readings) {\n        if (reading.nozzle_id && !isNaN(reading.closing_reading)) {\n          const openingReading = nozzleBaseReadings[reading.nozzle_id] || 0\n          await client.query(\n            `INSERT INTO shift_readings (shift_id, branch_id, reading_type, nozzle_id, opening_reading, closing_reading)\n             VALUES ($1, $2, 'nozzle', $3, $4, $5)`,\n            [id, branchId, reading.nozzle_id, openingReading, reading.closing_reading]\n          )\n          savedNozzleReadings.push({\n            nozzle_id: reading.nozzle_id,\n            opening_reading: openingReading,\n            closing_reading: reading.closing_reading\n          })\n        }\n      }\n    }\n\n    let bulkSalesResult = { invoicesCreated: 0, totalVolume: 0, totalAmount: 0, salesForKra: [] as SaleForKra[] }\n    if (savedNozzleReadings.length > 0) {\n      bulkSalesResult = await generateBulkSalesFromMeterDiff(\n        client, id, branchId, staffId, branchName, savedNozzleReadings\n      )\n      \n      if (bulkSalesResult.totalAmount > 0) {\n        await client.query(\n          `UPDATE shifts SET total_sales = $1 WHERE id = $2`,\n          [bulkSalesResult.totalAmount, id]\n        )\n      }\n    }\n\n    if (tank_stocks && tank_stocks.length > 0) {\n      for (const stock of tank_stocks) {\n        if (stock.tank_id && !isNaN(stock.closing_reading)) {\n          const openingStock = tankBaseStocks[stock.tank_id] || 0\n          const stockReceived = stock.stock_received || 0\n\n          await client.query(\n            `INSERT INTO shift_readings (shift_id, branch_id, reading_type, tank_id, opening_reading, closing_reading, stock_received)\n             VALUES ($1, $2, 'tank', $3, $4, $5, $6)`,\n            [id, branchId, stock.tank_id, openingStock, stock.closing_reading, stockReceived]\n          )\n\n          await client.query(\n            `UPDATE tanks SET current_stock = $1, updated_at = NOW() WHERE id = $2`,\n            [stock.closing_reading, stock.tank_id]\n          )\n        }\n      }\n    }\n\n    const newShiftResult = await client.query(\n      `INSERT INTO shifts (branch_id, start_time, status, opening_cash, notes, created_at)\n       VALUES ($1, $2, 'active', $3, NULL, NOW())\n       RETURNING *`,\n      [branchId, endTimeValue, closing_cash || 0]\n    )\n    const newShift = newShiftResult.rows[0]\n\n    await client.query('COMMIT')\n\n    // Submit bulk sales to KRA AFTER the transaction is committed\n    // This ensures database records exist before external API calls\n    if (bulkSalesResult.salesForKra.length > 0) {\n      console.log(`[BULK SALES] Submitting ${bulkSalesResult.salesForKra.length} sales to KRA...`)\n      for (const sale of bulkSalesResult.salesForKra) {\n        try {\n          const kraResult = await callKraSaveSales({\n            branch_id: sale.branch_id,\n            invoice_number: sale.invoice_number,\n            receipt_number: sale.receipt_number,\n            fuel_type: sale.fuel_type,\n            quantity: sale.quantity,\n            unit_price: sale.unit_price,\n            total_amount: sale.total_amount,\n            payment_method: 'cash',\n            customer_name: 'Walk-in Customer',\n            customer_pin: '',\n            sale_date: new Date().toISOString()\n          })\n\n          const kraData = kraResult.kraResponse?.data || {}\n          const kraStatus = kraResult.success ? 'success' : 'failed'\n          const transmissionStatus = kraResult.success ? 'transmitted' : 'failed'\n\n          await pool.query(\n            `UPDATE sales SET \n              kra_status = $1,\n              kra_rcpt_sign = $2,\n              kra_scu_id = $3,\n              kra_cu_inv = $4,\n              kra_internal_data = $5,\n              transmission_status = $6,\n              updated_at = NOW()\n            WHERE id = $7`,\n            [\n              kraStatus,\n              kraData.rcptSign || null,\n              kraData.sdcId || null,\n              kraData.rcptNo ? `${kraData.sdcId || ''}/${kraData.rcptNo}` : null,\n              kraData.intrlData || null,\n              transmissionStatus,\n              sale.id\n            ]\n          )\n\n          console.log(`[BULK SALES] Invoice ${sale.invoice_number} - KRA ${kraResult.success ? 'SUCCESS' : 'FAILED'}`)\n        } catch (kraError: any) {\n          console.error(`[BULK SALES] KRA submission error for ${sale.invoice_number}:`, kraError.message)\n          await pool.query(\n            `UPDATE sales SET \n              kra_status = 'failed',\n              kra_error = $1,\n              transmission_status = 'failed',\n              updated_at = NOW()\n            WHERE id = $2`,\n            [kraError.message || 'KRA submission error', sale.id]\n          )\n        }\n      }\n    }\n\n    return NextResponse.json({\n      success: true,\n      data: shift,\n      newShift: newShift,\n      bulkSales: {\n        invoicesCreated: bulkSalesResult.invoicesCreated,\n        totalVolume: bulkSalesResult.totalVolume,\n        totalAmount: bulkSalesResult.totalAmount\n      }\n    })\n\n  } catch (error: any) {\n    await client.query('ROLLBACK')\n    console.error(\"Error updating shift:\", error)\n    return NextResponse.json(\n      { error: \"Failed to update shift\", details: error.message },\n      { status: 500 }\n    )\n  } finally {\n    client.release()\n  }\n}\n"],"names":[],"mappings":"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"}}]
}