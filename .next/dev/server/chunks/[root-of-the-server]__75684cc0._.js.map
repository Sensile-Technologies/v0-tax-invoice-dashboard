{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/banking-accounts/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\nimport { cookies } from \"next/headers\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nasync function getSession() {\n  const cookieStore = await cookies()\n  const sessionCookie = cookieStore.get(\"user_session\")\n  if (!sessionCookie) return null\n  try {\n    return JSON.parse(sessionCookie.value)\n  } catch {\n    return null\n  }\n}\n\nasync function getVendorId(client: any, session: any) {\n  const userResult = await client.query(\n    `SELECT u.id, COALESCE(s.role, u.role) as role, v.id as vendor_id, s.branch_id\n     FROM users u\n     LEFT JOIN vendors v ON v.email = u.email\n     LEFT JOIN staff s ON s.user_id = u.id\n     WHERE u.id = $1`,\n    [session.id]\n  )\n\n  if (userResult.rows.length === 0) {\n    return null\n  }\n\n  const user = userResult.rows[0]\n  let vendorId = user.vendor_id\n\n  if (!vendorId && user.branch_id) {\n    const branchResult = await client.query(\n      'SELECT vendor_id FROM branches WHERE id = $1',\n      [user.branch_id]\n    )\n    vendorId = branchResult.rows[0]?.vendor_id\n  }\n\n  return vendorId\n}\n\nexport async function GET(request: NextRequest) {\n  const client = await pool.connect()\n  \n  try {\n    const session = await getSession()\n    if (!session) {\n      return NextResponse.json({ success: false, error: \"Unauthorized\" }, { status: 401 })\n    }\n\n    const vendorId = await getVendorId(client, session)\n    if (!vendorId) {\n      return NextResponse.json({ success: false, error: \"Vendor not found\" }, { status: 404 })\n    }\n\n    const result = await client.query(\n      `SELECT id, account_name, account_number, bank_name, branch_name, is_default, is_active, created_at, updated_at\n       FROM banking_accounts\n       WHERE vendor_id = $1\n       ORDER BY is_default DESC, account_name`,\n      [vendorId]\n    )\n\n    return NextResponse.json({\n      success: true,\n      data: result.rows\n    })\n\n  } catch (error) {\n    console.error(\"Error fetching banking accounts:\", error)\n    return NextResponse.json({ success: false, error: \"Failed to fetch banking accounts\" }, { status: 500 })\n  } finally {\n    client.release()\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  const client = await pool.connect()\n  \n  try {\n    const session = await getSession()\n    if (!session) {\n      return NextResponse.json({ success: false, error: \"Unauthorized\" }, { status: 401 })\n    }\n\n    const body = await request.json()\n    const { account_name, account_number, bank_name, branch_name } = body\n\n    if (!account_name?.trim()) {\n      return NextResponse.json({ success: false, error: \"Account name is required\" }, { status: 400 })\n    }\n\n    const vendorId = await getVendorId(client, session)\n    if (!vendorId) {\n      return NextResponse.json({ success: false, error: \"Vendor not found\" }, { status: 404 })\n    }\n\n    const result = await client.query(\n      `INSERT INTO banking_accounts (vendor_id, account_name, account_number, bank_name, branch_name, is_default)\n       VALUES ($1, $2, $3, $4, $5, false)\n       RETURNING id, account_name, account_number, bank_name, branch_name, is_default, is_active, created_at`,\n      [vendorId, account_name.trim(), account_number?.trim() || null, bank_name?.trim() || null, branch_name?.trim() || null]\n    )\n\n    return NextResponse.json({\n      success: true,\n      data: result.rows[0]\n    })\n\n  } catch (error) {\n    console.error(\"Error creating banking account:\", error)\n    return NextResponse.json({ success: false, error: \"Failed to create banking account\" }, { status: 500 })\n  } finally {\n    client.release()\n  }\n}\n\nexport async function PUT(request: NextRequest) {\n  const client = await pool.connect()\n  \n  try {\n    const session = await getSession()\n    if (!session) {\n      return NextResponse.json({ success: false, error: \"Unauthorized\" }, { status: 401 })\n    }\n\n    const body = await request.json()\n    const { id, account_name, account_number, bank_name, branch_name, is_active } = body\n\n    if (!id) {\n      return NextResponse.json({ success: false, error: \"Account ID is required\" }, { status: 400 })\n    }\n\n    const vendorId = await getVendorId(client, session)\n    if (!vendorId) {\n      return NextResponse.json({ success: false, error: \"Vendor not found\" }, { status: 404 })\n    }\n\n    const accountCheck = await client.query(\n      'SELECT id, is_default FROM banking_accounts WHERE id = $1 AND vendor_id = $2',\n      [id, vendorId]\n    )\n\n    if (accountCheck.rows.length === 0) {\n      return NextResponse.json({ success: false, error: \"Account not found\" }, { status: 404 })\n    }\n\n    const result = await client.query(\n      `UPDATE banking_accounts \n       SET account_name = COALESCE($1, account_name),\n           account_number = $2,\n           bank_name = $3,\n           branch_name = $4,\n           is_active = COALESCE($5, is_active),\n           updated_at = CURRENT_TIMESTAMP\n       WHERE id = $6 AND vendor_id = $7\n       RETURNING id, account_name, account_number, bank_name, branch_name, is_default, is_active, created_at, updated_at`,\n      [account_name?.trim(), account_number?.trim() || null, bank_name?.trim() || null, branch_name?.trim() || null, is_active, id, vendorId]\n    )\n\n    return NextResponse.json({\n      success: true,\n      data: result.rows[0]\n    })\n\n  } catch (error) {\n    console.error(\"Error updating banking account:\", error)\n    return NextResponse.json({ success: false, error: \"Failed to update banking account\" }, { status: 500 })\n  } finally {\n    client.release()\n  }\n}\n\nexport async function DELETE(request: NextRequest) {\n  const client = await pool.connect()\n  \n  try {\n    const session = await getSession()\n    if (!session) {\n      return NextResponse.json({ success: false, error: \"Unauthorized\" }, { status: 401 })\n    }\n\n    const { searchParams } = new URL(request.url)\n    const id = searchParams.get('id')\n\n    if (!id) {\n      return NextResponse.json({ success: false, error: \"Account ID is required\" }, { status: 400 })\n    }\n\n    const vendorId = await getVendorId(client, session)\n    if (!vendorId) {\n      return NextResponse.json({ success: false, error: \"Vendor not found\" }, { status: 404 })\n    }\n\n    const accountCheck = await client.query(\n      'SELECT id, is_default FROM banking_accounts WHERE id = $1 AND vendor_id = $2',\n      [id, vendorId]\n    )\n\n    if (accountCheck.rows.length === 0) {\n      return NextResponse.json({ success: false, error: \"Account not found\" }, { status: 404 })\n    }\n\n    if (accountCheck.rows[0].is_default) {\n      return NextResponse.json({ success: false, error: \"Cannot delete the default Cashdrop account\" }, { status: 400 })\n    }\n\n    await client.query(\n      'DELETE FROM banking_accounts WHERE id = $1 AND vendor_id = $2',\n      [id, vendorId]\n    )\n\n    return NextResponse.json({ success: true })\n\n  } catch (error) {\n    console.error(\"Error deleting banking account:\", error)\n    return NextResponse.json({ success: false, error: \"Failed to delete banking account\" }, { status: 500 })\n  } finally {\n    client.release()\n  }\n}\n"],"names":[],"mappings":"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"}}]
}