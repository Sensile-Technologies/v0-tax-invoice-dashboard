{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/shifts/%5Bid%5D/details/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const { id } = await params\n\n    const shiftResult = await pool.query(\n      `SELECT s.*, b.name as branch_name, st.full_name as staff_name, st.username as staff_username\n       FROM shifts s\n       LEFT JOIN branches b ON s.branch_id = b.id\n       LEFT JOIN staff st ON s.staff_id = st.id\n       WHERE s.id = $1`,\n      [id]\n    )\n\n    if (shiftResult.rows.length === 0) {\n      return NextResponse.json({ error: \"Shift not found\" }, { status: 404 })\n    }\n\n    const shift = shiftResult.rows[0]\n\n    const readingsResult = await pool.query(\n      `SELECT sr.*, \n              n.nozzle_number, \n              d.name as dispenser_name,\n              i.item_name as fuel_type,\n              t.name as tank_name,\n              ti.item_name as tank_fuel_type,\n              u.username as incoming_attendant_name\n       FROM shift_readings sr\n       LEFT JOIN nozzles n ON sr.nozzle_id = n.id\n       LEFT JOIN dispensers d ON n.dispenser_id = d.id\n       LEFT JOIN items i ON n.item_id = i.id\n       LEFT JOIN tanks t ON sr.tank_id = t.id\n       LEFT JOIN items ti ON t.item_id = ti.id\n       LEFT JOIN users u ON sr.incoming_attendant_id = u.id\n       WHERE sr.shift_id = $1\n       ORDER BY sr.reading_type, n.nozzle_number`,\n      [id]\n    )\n\n    const collectionsResult = await pool.query(\n      `SELECT ac.*, \n              COALESCE(st.full_name, st.username, u.username) as staff_name\n       FROM attendant_collections ac\n       LEFT JOIN staff st ON ac.staff_id = st.id\n       LEFT JOIN users u ON st.user_id = u.id\n       WHERE ac.shift_id = $1\n       ORDER BY ac.staff_id, ac.payment_method`,\n      [id]\n    )\n\n    const expensesResult = await pool.query(\n      `SELECT se.*, ea.name as expense_account_name\n       FROM shift_expenses se\n       LEFT JOIN expense_accounts ea ON se.expense_account_id = ea.id\n       WHERE se.shift_id = $1\n       ORDER BY se.created_at`,\n      [id]\n    )\n\n    const bankingResult = await pool.query(\n      `SELECT sb.*, ba.account_name, ba.bank_name, ba.account_number\n       FROM shift_banking sb\n       LEFT JOIN banking_accounts ba ON sb.banking_account_id = ba.id\n       WHERE sb.shift_id = $1\n       ORDER BY sb.created_at`,\n      [id]\n    )\n\n    const salesResult = await pool.query(\n      `SELECT COUNT(*) as count, \n              COALESCE(SUM(total_amount), 0) as total_amount,\n              COALESCE(SUM(quantity), 0) as total_quantity\n       FROM sales\n       WHERE branch_id = $1 \n         AND created_at >= $2 \n         AND ($3::timestamp IS NULL OR created_at <= $3)`,\n      [shift.branch_id, shift.start_time, shift.end_time]\n    )\n\n    const nozzleReadings = readingsResult.rows.filter(r => r.reading_type === 'nozzle')\n    const tankReadings = readingsResult.rows.filter(r => r.reading_type === 'tank')\n\n    const collectionsGrouped: Record<string, { staff_id: string; staff_name: string; payments: Record<string, number> }> = {}\n    for (const c of collectionsResult.rows) {\n      if (!collectionsGrouped[c.staff_id]) {\n        collectionsGrouped[c.staff_id] = {\n          staff_id: c.staff_id,\n          staff_name: c.staff_name || 'Unknown',\n          payments: {}\n        }\n      }\n      collectionsGrouped[c.staff_id].payments[c.payment_method] = parseFloat(c.amount) || 0\n    }\n\n    return NextResponse.json({\n      success: true,\n      shift: {\n        ...shift,\n        cashier: shift.staff_name || shift.staff_username || 'Unknown'\n      },\n      nozzleReadings: nozzleReadings.map(r => ({\n        id: r.id,\n        nozzle_id: r.nozzle_id,\n        nozzle_number: r.nozzle_number,\n        dispenser_name: r.dispenser_name,\n        fuel_type: r.fuel_type,\n        opening_reading: parseFloat(r.opening_reading) || 0,\n        closing_reading: parseFloat(r.closing_reading) || 0,\n        meter_difference: (parseFloat(r.closing_reading) || 0) - (parseFloat(r.opening_reading) || 0),\n        rtt: parseFloat(r.rtt) || 0,\n        self_fueling: parseFloat(r.self_fueling) || 0,\n        prepaid_sale: parseFloat(r.prepaid_sale) || 0,\n        incoming_attendant_name: r.incoming_attendant_name\n      })),\n      tankReadings: tankReadings.map(r => ({\n        id: r.id,\n        tank_id: r.tank_id,\n        tank_name: r.tank_name,\n        fuel_type: r.tank_fuel_type,\n        opening_reading: parseFloat(r.opening_reading) || 0,\n        closing_reading: parseFloat(r.closing_reading) || 0,\n        stock_received: parseFloat(r.stock_received) || 0\n      })),\n      collections: Object.values(collectionsGrouped),\n      expenses: expensesResult.rows.map(e => ({\n        id: e.id,\n        expense_account_name: e.expense_account_name,\n        amount: parseFloat(e.amount) || 0,\n        description: e.description\n      })),\n      banking: bankingResult.rows.map(b => ({\n        id: b.id,\n        account_name: b.account_name,\n        bank_name: b.bank_name,\n        account_number: b.account_number,\n        amount: parseFloat(b.amount) || 0,\n        notes: b.notes\n      })),\n      salesSummary: {\n        count: parseInt(salesResult.rows[0]?.count) || 0,\n        total_amount: parseFloat(salesResult.rows[0]?.total_amount) || 0,\n        total_quantity: parseFloat(salesResult.rows[0]?.total_quantity) || 0\n      }\n    })\n\n  } catch (error: any) {\n    console.error(\"Error fetching shift details:\", error)\n    return NextResponse.json(\n      { error: \"Failed to fetch shift details\", details: error.message },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":"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"}}]
}