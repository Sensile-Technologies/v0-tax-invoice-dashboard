{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/branches/earning-rules/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\nimport { cookies } from \"next/headers\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nasync function getSession() {\n  const cookieStore = await cookies()\n  const sessionCookie = cookieStore.get(\"user_session\")\n  if (!sessionCookie) return null\n  try {\n    return JSON.parse(sessionCookie.value)\n  } catch {\n    return null\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const session = await getSession()\n    if (!session) {\n      return NextResponse.json({ success: false, error: \"Unauthorized\" }, { status: 401 })\n    }\n\n    const { searchParams } = new URL(request.url)\n    const branchId = searchParams.get(\"branch_id\")\n\n    if (!branchId) {\n      return NextResponse.json({ success: false, error: \"branch_id is required\" }, { status: 400 })\n    }\n\n    const result = await pool.query(\n      `SELECT \n        id,\n        name,\n        loyalty_earn_type,\n        loyalty_points_per_litre,\n        loyalty_points_per_amount,\n        loyalty_amount_threshold,\n        redemption_points_per_ksh,\n        min_redemption_points,\n        max_redemption_percent\n      FROM branches WHERE id = $1`,\n      [branchId]\n    )\n\n    if (result.rows.length === 0) {\n      return NextResponse.json({ success: false, error: \"Branch not found\" }, { status: 404 })\n    }\n\n    return NextResponse.json({\n      success: true,\n      data: result.rows[0]\n    })\n  } catch (error: any) {\n    console.error(\"Error fetching earning rules:\", error)\n    return NextResponse.json({ success: false, error: error.message }, { status: 500 })\n  }\n}\n\nexport async function PUT(request: NextRequest) {\n  try {\n    const session = await getSession()\n    if (!session) {\n      return NextResponse.json({ success: false, error: \"Unauthorized\" }, { status: 401 })\n    }\n\n    const body = await request.json()\n    const { \n      branch_id, \n      loyalty_earn_type, \n      loyalty_points_per_litre, \n      loyalty_points_per_amount, \n      loyalty_amount_threshold,\n      redemption_points_per_ksh,\n      min_redemption_points,\n      max_redemption_percent\n    } = body\n\n    if (!branch_id) {\n      return NextResponse.json({ success: false, error: \"branch_id is required\" }, { status: 400 })\n    }\n\n    if (!loyalty_earn_type || !['per_litre', 'per_amount'].includes(loyalty_earn_type)) {\n      return NextResponse.json({ success: false, error: \"loyalty_earn_type must be 'per_litre' or 'per_amount'\" }, { status: 400 })\n    }\n\n    // Validate numeric values - use nullish coalescing (??) not OR (||) to allow 0 values\n    const pointsPerLitre = Number(loyalty_points_per_litre ?? 1)\n    const pointsPerAmount = Number(loyalty_points_per_amount ?? 1)\n    const amountThreshold = Number(loyalty_amount_threshold ?? 100)\n    const pointsPerKsh = Number(redemption_points_per_ksh ?? 1)\n    const minPoints = Number(min_redemption_points ?? 100)\n    const maxPercent = Number(max_redemption_percent ?? 50)\n\n    // Validate: points must be >= 0, threshold must be >= 1 to avoid division by zero\n    if (pointsPerLitre < 0) {\n      return NextResponse.json({ success: false, error: \"Points per litre must be 0 or greater\" }, { status: 400 })\n    }\n    if (pointsPerAmount < 0) {\n      return NextResponse.json({ success: false, error: \"Points per amount must be 0 or greater\" }, { status: 400 })\n    }\n    if (amountThreshold < 1) {\n      return NextResponse.json({ success: false, error: \"Amount threshold must be at least 1\" }, { status: 400 })\n    }\n    if (pointsPerKsh < 1) {\n      return NextResponse.json({ success: false, error: \"Points per KSH must be at least 1\" }, { status: 400 })\n    }\n    if (minPoints < 0) {\n      return NextResponse.json({ success: false, error: \"Minimum redemption points must be 0 or greater\" }, { status: 400 })\n    }\n    if (maxPercent < 0 || maxPercent > 100) {\n      return NextResponse.json({ success: false, error: \"Max redemption percent must be between 0 and 100\" }, { status: 400 })\n    }\n\n    const result = await pool.query(\n      `UPDATE branches SET\n        loyalty_earn_type = $1,\n        loyalty_points_per_litre = $2,\n        loyalty_points_per_amount = $3,\n        loyalty_amount_threshold = $4,\n        redemption_points_per_ksh = $5,\n        min_redemption_points = $6,\n        max_redemption_percent = $7,\n        updated_at = NOW()\n      WHERE id = $8\n      RETURNING id, name, loyalty_earn_type, loyalty_points_per_litre, loyalty_points_per_amount, loyalty_amount_threshold, redemption_points_per_ksh, min_redemption_points, max_redemption_percent`,\n      [\n        loyalty_earn_type,\n        pointsPerLitre,\n        pointsPerAmount,\n        amountThreshold,\n        pointsPerKsh,\n        minPoints,\n        maxPercent,\n        branch_id\n      ]\n    )\n\n    if (result.rows.length === 0) {\n      return NextResponse.json({ success: false, error: \"Branch not found\" }, { status: 404 })\n    }\n\n    return NextResponse.json({\n      success: true,\n      message: \"Earning rules updated successfully\",\n      data: result.rows[0]\n    })\n  } catch (error: any) {\n    console.error(\"Error updating earning rules:\", error)\n    return NextResponse.json({ success: false, error: error.message }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}