{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/headquarters/items/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\nimport { cookies } from \"next/headers\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nasync function getSession() {\n  const cookieStore = await cookies()\n  const sessionCookie = cookieStore.get(\"user_session\")\n  if (!sessionCookie) return null\n  try {\n    return JSON.parse(sessionCookie.value)\n  } catch {\n    return null\n  }\n}\n\nfunction generateItemCode(\n  origin: string,\n  itemType: string,\n  packageUnit: string,\n  quantityUnit: string,\n  itemCount: number\n): string {\n  const paddedCount = String(itemCount).padStart(7, '0')\n  return `${origin}${itemType}${packageUnit}${quantityUnit}${paddedCount}`\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const session = await getSession()\n    if (!session) {\n      return NextResponse.json({ success: false, error: \"Unauthorized\" }, { status: 401 })\n    }\n\n    const client = await pool.connect()\n    try {\n      const userResult = await client.query(\n        `SELECT u.id, u.role as user_role, s.role as staff_role, v.id as vendor_id\n         FROM users u\n         LEFT JOIN vendors v ON v.email = u.email\n         LEFT JOIN staff s ON s.user_id = u.id\n         LEFT JOIN branches b ON b.id = s.branch_id\n         WHERE u.id = $1`,\n        [session.id]\n      )\n      \n      if (userResult.rows.length === 0) {\n        return NextResponse.json({ success: false, error: \"User not found\" }, { status: 404 })\n      }\n\n      const user = userResult.rows[0]\n      const vendorId = user.vendor_id || (await client.query(\n        'SELECT vendor_id FROM branches b JOIN staff s ON s.branch_id = b.id WHERE s.user_id = $1 LIMIT 1',\n        [session.id]\n      )).rows[0]?.vendor_id\n      \n      // Check for HQ access: user must be vendor/director in users table OR director in staff table\n      const hasHqAccess = ['director', 'vendor'].includes(user.user_role) || \n                          (user.staff_role && user.staff_role.toLowerCase() === 'director')\n      \n      if (!hasHqAccess) {\n        return NextResponse.json({ success: false, error: \"Access denied. HQ access required.\" }, { status: 403 })\n      }\n\n      if (!vendorId) {\n        return NextResponse.json({ success: false, error: \"Vendor not found\" }, { status: 404 })\n      }\n\n      const result = await client.query(\n        `SELECT i.*, \n         b.name as branch_name,\n         (SELECT COUNT(*) FROM branch_items bi WHERE bi.item_id = i.id) as assigned_branches\n         FROM items i \n         LEFT JOIN branches b ON i.branch_id = b.id\n         WHERE i.vendor_id = $1 OR i.branch_id IN (SELECT id FROM branches WHERE vendor_id = $1)\n         ORDER BY i.created_at DESC`,\n        [vendorId]\n      )\n\n      return NextResponse.json({\n        success: true,\n        items: result.rows\n      })\n\n    } finally {\n      client.release()\n    }\n\n  } catch (error) {\n    console.error(\"Error fetching HQ items:\", error)\n    return NextResponse.json({ success: false, error: \"Failed to fetch items\" }, { status: 500 })\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  const client = await pool.connect()\n  \n  try {\n    const session = await getSession()\n    if (!session) {\n      return NextResponse.json({ success: false, error: \"Unauthorized\" }, { status: 401 })\n    }\n\n    const userResult = await client.query(\n      `SELECT u.id, u.role as user_role, s.role as staff_role, v.id as vendor_id\n       FROM users u\n       LEFT JOIN vendors v ON v.email = u.email\n       LEFT JOIN staff s ON s.user_id = u.id\n       WHERE u.id = $1`,\n      [session.id]\n    )\n    \n    if (userResult.rows.length === 0) {\n      return NextResponse.json({ success: false, error: \"User not found\" }, { status: 404 })\n    }\n\n    const user = userResult.rows[0]\n    const vendorId = user.vendor_id || (await client.query(\n      'SELECT vendor_id FROM branches b JOIN staff s ON s.branch_id = b.id WHERE s.user_id = $1 LIMIT 1',\n      [session.id]\n    )).rows[0]?.vendor_id\n    \n    // Check for HQ access: user must be vendor/director in users table OR director in staff table\n    const hasHqAccess = ['director', 'vendor'].includes(user.user_role) || \n                        (user.staff_role && user.staff_role.toLowerCase() === 'director')\n    \n    if (!hasHqAccess) {\n      return NextResponse.json({ success: false, error: \"Access denied. Only HQ can create items.\" }, { status: 403 })\n    }\n\n    if (!vendorId) {\n      return NextResponse.json({ success: false, error: \"Vendor not found\" }, { status: 404 })\n    }\n\n    const body = await request.json()\n    const {\n      itemName,\n      description,\n      itemType,\n      classCode,\n      taxType,\n      origin,\n      batchNumber,\n      purchasePrice,\n      salePrice,\n      sku,\n      quantityUnit,\n      packageUnit\n    } = body\n\n    if (!itemName || !itemType || !classCode || !taxType || !origin || !quantityUnit || !packageUnit) {\n      return NextResponse.json(\n        { success: false, error: \"Missing required fields\" },\n        { status: 400 }\n      )\n    }\n\n    await client.query('BEGIN')\n\n    const vendorResult = await client.query(\n      'SELECT item_count FROM vendors WHERE id = $1 FOR UPDATE',\n      [vendorId]\n    )\n\n    if (vendorResult.rows.length === 0) {\n      await client.query('ROLLBACK')\n      return NextResponse.json({ success: false, error: \"Vendor not found\" }, { status: 404 })\n    }\n\n    const currentItemCount = vendorResult.rows[0].item_count || 0\n    const newItemCount = currentItemCount + 1\n\n    const itemCode = generateItemCode(\n      origin,\n      itemType,\n      packageUnit,\n      quantityUnit,\n      newItemCount\n    )\n\n    const existingItem = await client.query(\n      'SELECT id FROM items WHERE item_code = $1 AND vendor_id = $2',\n      [itemCode, vendorId]\n    )\n\n    if (existingItem.rows.length > 0) {\n      await client.query('ROLLBACK')\n      return NextResponse.json(\n        { success: false, error: \"Item code already exists. Please try again.\" },\n        { status: 409 }\n      )\n    }\n\n    const insertResult = await client.query(\n      `INSERT INTO items (\n        vendor_id, branch_id, item_code, item_name, description,\n        item_type, class_code, tax_type, origin, batch_number,\n        purchase_price, sale_price, sku, quantity_unit, package_unit,\n        status, created_at, updated_at\n      ) VALUES (\n        $1, NULL, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14,\n        'active', NOW(), NOW()\n      ) RETURNING *`,\n      [\n        vendorId,\n        itemCode,\n        itemName,\n        description || null,\n        itemType,\n        classCode,\n        taxType,\n        origin,\n        batchNumber || null,\n        purchasePrice || 0,\n        salePrice || 0,\n        sku || null,\n        quantityUnit,\n        packageUnit\n      ]\n    )\n\n    await client.query(\n      'UPDATE vendors SET item_count = $1 WHERE id = $2',\n      [newItemCount, vendorId]\n    )\n\n    await client.query('COMMIT')\n\n    return NextResponse.json({\n      success: true,\n      item: insertResult.rows[0],\n      itemCode: itemCode,\n      message: `Item created successfully with code: ${itemCode}`\n    })\n\n  } catch (error) {\n    await client.query('ROLLBACK')\n    console.error(\"Error creating HQ item:\", error)\n    return NextResponse.json({ success: false, error: \"Failed to create item\" }, { status: 500 })\n  } finally {\n    client.release()\n  }\n}\n\nexport async function PUT(request: NextRequest) {\n  const client = await pool.connect()\n  \n  try {\n    const session = await getSession()\n    if (!session) {\n      return NextResponse.json({ success: false, error: \"Unauthorized\" }, { status: 401 })\n    }\n\n    const userResult = await client.query(\n      `SELECT u.id, COALESCE(s.role, u.role) as role, v.id as vendor_id\n       FROM users u\n       LEFT JOIN vendors v ON v.email = u.email\n       LEFT JOIN staff s ON s.user_id = u.id\n       WHERE u.id = $1`,\n      [session.id]\n    )\n    \n    if (userResult.rows.length === 0) {\n      return NextResponse.json({ success: false, error: \"User not found\" }, { status: 404 })\n    }\n\n    const user = userResult.rows[0]\n    const vendorId = user.vendor_id || (await client.query(\n      'SELECT vendor_id FROM branches b JOIN staff s ON s.branch_id = b.id WHERE s.user_id = $1 LIMIT 1',\n      [session.id]\n    )).rows[0]?.vendor_id\n    \n    if (!['director', 'vendor'].includes(user.role)) {\n      return NextResponse.json({ success: false, error: \"Access denied. Only HQ can edit items.\" }, { status: 403 })\n    }\n\n    if (!vendorId) {\n      return NextResponse.json({ success: false, error: \"Vendor not found\" }, { status: 404 })\n    }\n\n    const body = await request.json()\n    const { id, itemName, description, purchasePrice, salePrice, status } = body\n\n    if (!id) {\n      return NextResponse.json({ success: false, error: \"Item ID required\" }, { status: 400 })\n    }\n\n    const itemCheck = await client.query(\n      'SELECT id FROM items WHERE id = $1 AND vendor_id = $2',\n      [id, vendorId]\n    )\n\n    if (itemCheck.rows.length === 0) {\n      return NextResponse.json({ success: false, error: \"Item not found\" }, { status: 404 })\n    }\n\n    const updateResult = await client.query(\n      `UPDATE items SET\n        item_name = COALESCE($1, item_name),\n        description = COALESCE($2, description),\n        purchase_price = COALESCE($3, purchase_price),\n        sale_price = COALESCE($4, sale_price),\n        status = COALESCE($5, status),\n        updated_at = NOW()\n      WHERE id = $6 AND vendor_id = $7\n      RETURNING *`,\n      [itemName, description, purchasePrice, salePrice, status, id, vendorId]\n    )\n\n    return NextResponse.json({\n      success: true,\n      item: updateResult.rows[0]\n    })\n\n  } catch (error) {\n    console.error(\"Error updating HQ item:\", error)\n    return NextResponse.json({ success: false, error: \"Failed to update item\" }, { status: 500 })\n  } finally {\n    client.release()\n  }\n}\n"],"names":[],"mappings":"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"}}]
}