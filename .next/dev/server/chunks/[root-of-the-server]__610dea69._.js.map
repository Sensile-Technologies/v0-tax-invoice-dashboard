{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/customers/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const branchId = searchParams.get('branch_id')\n    const search = searchParams.get('search')\n    const page = parseInt(searchParams.get('page') || '1')\n    const pageSize = parseInt(searchParams.get('pageSize') || '50')\n    const offset = (page - 1) * pageSize\n\n    let baseQuery = `\n      FROM customers c\n      INNER JOIN customer_branches cb ON c.id = cb.customer_id\n      WHERE c.use_yn = 'Y' AND cb.status = 'active'\n    `\n    const params: any[] = []\n    let branchParamIndex: number | null = null\n\n    if (branchId) {\n      params.push(branchId)\n      branchParamIndex = params.length\n      baseQuery += ` AND cb.branch_id = $${branchParamIndex}`\n    }\n\n    if (search) {\n      params.push(`%${search}%`)\n      baseQuery += ` AND (c.cust_nm ILIKE $${params.length} OR c.cust_tin ILIKE $${params.length} OR c.tel_no ILIKE $${params.length})`\n    }\n\n    const countResult = await pool.query(\n      `SELECT COUNT(DISTINCT c.id) ${baseQuery}`,\n      params\n    )\n    const total = parseInt(countResult.rows[0].count)\n\n    const dataParams = [...params, pageSize, offset]\n    const limitParamIndex = dataParams.length - 1\n    const offsetParamIndex = dataParams.length\n    \n    // Build branch-scoped aggregates with parameterized branch_id (reuses the same param index)\n    const branchCondition = branchParamIndex ? ` AND lt.branch_id = $${branchParamIndex}` : ''\n    const result = await pool.query(\n      `SELECT DISTINCT c.id, c.cust_nm, c.cust_tin, c.cust_no, c.tel_no, c.email,\n        COALESCE((SELECT SUM(lt.points_earned) FROM loyalty_transactions lt WHERE (lt.customer_name = c.cust_nm OR lt.customer_pin = c.cust_tin)${branchCondition}), 0) as total_points,\n        COALESCE((SELECT COUNT(*) FROM loyalty_transactions lt WHERE (lt.customer_name = c.cust_nm OR lt.customer_pin = c.cust_tin)${branchCondition}), 0) as total_purchases,\n        (SELECT MAX(lt.transaction_date) FROM loyalty_transactions lt WHERE (lt.customer_name = c.cust_nm OR lt.customer_pin = c.cust_tin)${branchCondition}) as last_activity\n       ${baseQuery} ORDER BY c.cust_nm LIMIT $${limitParamIndex} OFFSET $${offsetParamIndex}`,\n      dataParams\n    )\n\n    return NextResponse.json({\n      success: true,\n      data: result.rows,\n      pagination: {\n        page,\n        pageSize,\n        total,\n        totalPages: Math.ceil(total / pageSize)\n      }\n    })\n\n  } catch (error: any) {\n    console.error(\"Error fetching customers:\", error)\n    return NextResponse.json(\n      { error: \"Failed to fetch customers\", details: error.message },\n      { status: 500 }\n    )\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  const client = await pool.connect()\n  try {\n    const body = await request.json()\n    const { cust_nm, cust_tin, cust_no, tel_no, email, branch_id, vendor_id, tin, bhf_id } = body\n\n    if (!cust_nm) {\n      return NextResponse.json(\n        { error: \"Customer name is required\" },\n        { status: 400 }\n      )\n    }\n\n    await client.query('BEGIN')\n\n    let customerId: string\n    let existingCustomer = null\n\n    if (cust_tin) {\n      const existingResult = await client.query(\n        'SELECT id FROM customers WHERE cust_tin = $1',\n        [cust_tin]\n      )\n      existingCustomer = existingResult.rows[0]\n    }\n\n    if (!existingCustomer && tel_no) {\n      const existingResult = await client.query(\n        'SELECT id FROM customers WHERE tel_no = $1',\n        [tel_no]\n      )\n      existingCustomer = existingResult.rows[0]\n    }\n\n    if (existingCustomer) {\n      customerId = existingCustomer.id\n    } else {\n      // tin and bhf_id are NOT NULL - use provided values or defaults\n      const effectiveTin = tin || cust_tin || ''\n      const effectiveBhfId = bhf_id || '00'\n      \n      const insertResult = await client.query(\n        `INSERT INTO customers (cust_nm, cust_tin, cust_no, tel_no, email, tin, bhf_id, use_yn)\n         VALUES ($1, $2, $3, $4, $5, $6, $7, 'Y')\n         RETURNING id`,\n        [cust_nm, cust_tin || '', cust_no || null, tel_no || null, email || null, effectiveTin, effectiveBhfId]\n      )\n      customerId = insertResult.rows[0].id\n    }\n\n    if (branch_id) {\n      await client.query(\n        `INSERT INTO customer_branches (customer_id, branch_id, vendor_id, status)\n         VALUES ($1, $2, $3, 'active')\n         ON CONFLICT (customer_id, branch_id) DO UPDATE SET status = 'active'`,\n        [customerId, branch_id, vendor_id || null]\n      )\n    }\n\n    await client.query('COMMIT')\n\n    return NextResponse.json({\n      success: true,\n      message: existingCustomer ? 'Customer linked to branch' : 'Customer created and linked to branch',\n      data: { id: customerId }\n    })\n\n  } catch (error: any) {\n    await client.query('ROLLBACK')\n    console.error(\"Error creating customer:\", error)\n    return NextResponse.json(\n      { error: \"Failed to create customer\", details: error.message },\n      { status: 500 }\n    )\n  } finally {\n    client.release()\n  }\n}\n\nexport async function PUT(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const { id, cust_nm, cust_tin, tel_no, email, adrs } = body\n\n    if (!id) {\n      return NextResponse.json(\n        { error: \"Customer ID is required\" },\n        { status: 400 }\n      )\n    }\n\n    const result = await pool.query(\n      `UPDATE customers \n       SET cust_nm = COALESCE($1, cust_nm),\n           cust_tin = COALESCE($2, cust_tin),\n           tel_no = COALESCE($3, tel_no),\n           email = COALESCE($4, email),\n           adrs = COALESCE($5, adrs),\n           updated_at = NOW()\n       WHERE id = $6\n       RETURNING *`,\n      [cust_nm, cust_tin, tel_no, email, adrs, id]\n    )\n\n    if (result.rows.length === 0) {\n      return NextResponse.json(\n        { error: \"Customer not found\" },\n        { status: 404 }\n      )\n    }\n\n    return NextResponse.json({\n      success: true,\n      message: \"Customer updated successfully\",\n      data: result.rows[0]\n    })\n\n  } catch (error: any) {\n    console.error(\"Error updating customer:\", error)\n    return NextResponse.json(\n      { error: \"Failed to update customer\", details: error.message },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":";;;;;;;;AAAA;AACA;;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;AAC5C;AAEO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,WAAW,aAAa,GAAG,CAAC;QAClC,MAAM,SAAS,aAAa,GAAG,CAAC;QAChC,MAAM,OAAO,SAAS,aAAa,GAAG,CAAC,WAAW;QAClD,MAAM,WAAW,SAAS,aAAa,GAAG,CAAC,eAAe;QAC1D,MAAM,SAAS,CAAC,OAAO,CAAC,IAAI;QAE5B,IAAI,YAAY,CAAC;;;;IAIjB,CAAC;QACD,MAAM,SAAgB,EAAE;QACxB,IAAI,mBAAkC;QAEtC,IAAI,UAAU;YACZ,OAAO,IAAI,CAAC;YACZ,mBAAmB,OAAO,MAAM;YAChC,aAAa,CAAC,qBAAqB,EAAE,kBAAkB;QACzD;QAEA,IAAI,QAAQ;YACV,OAAO,IAAI,CAAC,CAAC,CAAC,EAAE,OAAO,CAAC,CAAC;YACzB,aAAa,CAAC,uBAAuB,EAAE,OAAO,MAAM,CAAC,sBAAsB,EAAE,OAAO,MAAM,CAAC,oBAAoB,EAAE,OAAO,MAAM,CAAC,CAAC,CAAC;QACnI;QAEA,MAAM,cAAc,MAAM,KAAK,KAAK,CAClC,CAAC,4BAA4B,EAAE,WAAW,EAC1C;QAEF,MAAM,QAAQ,SAAS,YAAY,IAAI,CAAC,EAAE,CAAC,KAAK;QAEhD,MAAM,aAAa;eAAI;YAAQ;YAAU;SAAO;QAChD,MAAM,kBAAkB,WAAW,MAAM,GAAG;QAC5C,MAAM,mBAAmB,WAAW,MAAM;QAE1C,4FAA4F;QAC5F,MAAM,kBAAkB,mBAAmB,CAAC,qBAAqB,EAAE,kBAAkB,GAAG;QACxF,MAAM,SAAS,MAAM,KAAK,KAAK,CAC7B,CAAC;gJACyI,EAAE,gBAAgB;mIAC/B,EAAE,gBAAgB;0IACX,EAAE,gBAAgB;OACrJ,EAAE,UAAU,2BAA2B,EAAE,gBAAgB,SAAS,EAAE,kBAAkB,EACvF;QAGF,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,MAAM,OAAO,IAAI;YACjB,YAAY;gBACV;gBACA;gBACA;gBACA,YAAY,KAAK,IAAI,CAAC,QAAQ;YAChC;QACF;IAEF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,6BAA6B;QAC3C,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;YAA6B,SAAS,MAAM,OAAO;QAAC,GAC7D;YAAE,QAAQ;QAAI;IAElB;AACF;AAEO,eAAe,KAAK,OAAoB;IAC7C,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,OAAO,EAAE,QAAQ,EAAE,OAAO,EAAE,MAAM,EAAE,KAAK,EAAE,SAAS,EAAE,SAAS,EAAE,GAAG,EAAE,MAAM,EAAE,GAAG;QAEzF,IAAI,CAAC,SAAS;YACZ,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA4B,GACrC;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,OAAO,KAAK,CAAC;QAEnB,IAAI;QACJ,IAAI,mBAAmB;QAEvB,IAAI,UAAU;YACZ,MAAM,iBAAiB,MAAM,OAAO,KAAK,CACvC,gDACA;gBAAC;aAAS;YAEZ,mBAAmB,eAAe,IAAI,CAAC,EAAE;QAC3C;QAEA,IAAI,CAAC,oBAAoB,QAAQ;YAC/B,MAAM,iBAAiB,MAAM,OAAO,KAAK,CACvC,8CACA;gBAAC;aAAO;YAEV,mBAAmB,eAAe,IAAI,CAAC,EAAE;QAC3C;QAEA,IAAI,kBAAkB;YACpB,aAAa,iBAAiB,EAAE;QAClC,OAAO;YACL,gEAAgE;YAChE,MAAM,eAAe,OAAO,YAAY;YACxC,MAAM,iBAAiB,UAAU;YAEjC,MAAM,eAAe,MAAM,OAAO,KAAK,CACrC,CAAC;;qBAEY,CAAC,EACd;gBAAC;gBAAS,YAAY;gBAAI,WAAW;gBAAM,UAAU;gBAAM,SAAS;gBAAM;gBAAc;aAAe;YAEzG,aAAa,aAAa,IAAI,CAAC,EAAE,CAAC,EAAE;QACtC;QAEA,IAAI,WAAW;YACb,MAAM,OAAO,KAAK,CAChB,CAAC;;6EAEoE,CAAC,EACtE;gBAAC;gBAAY;gBAAW,aAAa;aAAK;QAE9C;QAEA,MAAM,OAAO,KAAK,CAAC;QAEnB,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,SAAS,mBAAmB,8BAA8B;YAC1D,MAAM;gBAAE,IAAI;YAAW;QACzB;IAEF,EAAE,OAAO,OAAY;QACnB,MAAM,OAAO,KAAK,CAAC;QACnB,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;YAA6B,SAAS,MAAM,OAAO;QAAC,GAC7D;YAAE,QAAQ;QAAI;IAElB,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,EAAE,EAAE,OAAO,EAAE,QAAQ,EAAE,MAAM,EAAE,KAAK,EAAE,IAAI,EAAE,GAAG;QAEvD,IAAI,CAAC,IAAI;YACP,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA0B,GACnC;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,SAAS,MAAM,KAAK,KAAK,CAC7B,CAAC;;;;;;;;kBAQW,CAAC,EACb;YAAC;YAAS;YAAU;YAAQ;YAAO;YAAM;SAAG;QAG9C,IAAI,OAAO,IAAI,CAAC,MAAM,KAAK,GAAG;YAC5B,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAqB,GAC9B;gBAAE,QAAQ;YAAI;QAElB;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,SAAS;YACT,MAAM,OAAO,IAAI,CAAC,EAAE;QACtB;IAEF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;YAA6B,SAAS,MAAM,OAAO;QAAC,GAC7D;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}