module.exports = [
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/pg [external] (pg, esm_import)", ((__turbopack_context__) => {
"use strict";

return __turbopack_context__.a(async (__turbopack_handle_async_dependencies__, __turbopack_async_result__) => { try {

const mod = await __turbopack_context__.y("pg");

__turbopack_context__.n(mod);
__turbopack_async_result__();
} catch(e) { __turbopack_async_result__(e); } }, true);}),
"[externals]/fs [external] (fs, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("fs", () => require("fs"));

module.exports = mod;
}),
"[externals]/path [external] (path, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("path", () => require("path"));

module.exports = mod;
}),
"[externals]/worker_threads [external] (worker_threads, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("worker_threads", () => require("worker_threads"));

module.exports = mod;
}),
"[externals]/util [external] (util, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("util", () => require("util"));

module.exports = mod;
}),
"[externals]/stream [external] (stream, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("stream", () => require("stream"));

module.exports = mod;
}),
"[externals]/zlib [external] (zlib, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}),
"[externals]/assert [external] (assert, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("assert", () => require("assert"));

module.exports = mod;
}),
"[externals]/buffer [external] (buffer, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("buffer", () => require("buffer"));

module.exports = mod;
}),
"[project]/app/api/receipt/generate/route.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

return __turbopack_context__.a(async (__turbopack_handle_async_dependencies__, __turbopack_async_result__) => { try {

__turbopack_context__.s([
    "POST",
    ()=>POST
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$externals$5d2f$pg__$5b$external$5d$__$28$pg$2c$__esm_import$29$__ = __turbopack_context__.i("[externals]/pg [external] (pg, esm_import)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$jspdf$2f$dist$2f$jspdf$2e$node$2e$min$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/jspdf/dist/jspdf.node.min.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$qrcode$2f$lib$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/qrcode/lib/index.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2d$tz$2f$dist$2f$esm$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__$3c$locals$3e$__ = __turbopack_context__.i("[project]/node_modules/date-fns-tz/dist/esm/index.js [app-route] (ecmascript) <locals>");
var __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2d$tz$2f$dist$2f$esm$2f$formatInTimeZone$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/node_modules/date-fns-tz/dist/esm/formatInTimeZone/index.js [app-route] (ecmascript)");
var __turbopack_async_dependencies__ = __turbopack_handle_async_dependencies__([
    __TURBOPACK__imported__module__$5b$externals$5d2f$pg__$5b$external$5d$__$28$pg$2c$__esm_import$29$__
]);
[__TURBOPACK__imported__module__$5b$externals$5d2f$pg__$5b$external$5d$__$28$pg$2c$__esm_import$29$__] = __turbopack_async_dependencies__.then ? (await __turbopack_async_dependencies__)() : __turbopack_async_dependencies__;
;
;
;
;
;
const pool = new __TURBOPACK__imported__module__$5b$externals$5d2f$pg__$5b$external$5d$__$28$pg$2c$__esm_import$29$__["Pool"]({
    connectionString: process.env.DATABASE_URL
});
async function POST(request) {
    try {
        const body = await request.json();
        const { sale_id, branch_id, is_copy = false, mark_original_printed = false } = body;
        if (!sale_id || !branch_id) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: "Missing sale_id or branch_id"
            }, {
                status: 400
            });
        }
        const client = await pool.connect();
        try {
            const saleResult = await client.query(`SELECT s.*, b.name as branch_name, b.kra_pin, b.bhf_id, b.address as branch_address,
                b.phone as branch_phone,
                n.nozzle_number, d.dispenser_number,
                i.item_name, i.item_code,
                st.full_name as served_by_name,
                orig.kra_cu_inv as original_cu_invoice,
                orig.invoice_number as original_invoice_number
         FROM sales s
         LEFT JOIN branches b ON s.branch_id = b.id
         LEFT JOIN nozzles n ON s.nozzle_id = n.id
         LEFT JOIN dispensers d ON n.dispenser_id = d.id
         LEFT JOIN items i ON s.item_id = i.id
         LEFT JOIN staff st ON s.staff_id = st.id
         LEFT JOIN sales orig ON s.original_sale_id = orig.id
         WHERE s.id = $1`, [
                sale_id
            ]);
            if (saleResult.rows.length === 0) {
                return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    error: "Sale not found"
                }, {
                    status: 404
                });
            }
            const sale = saleResult.rows[0];
            const itemName = sale.item_name || sale.fuel_type || 'Fuel';
            const itemCode = sale.item_code || sale.fuel_type || 'FUEL';
            const isCreditNote = sale.sale_type === 'credit_note' || sale.invoice_number?.includes('-CR') || parseFloat(sale.total_amount) < 0;
            const pageWidth = 80;
            const doc = new __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$jspdf$2f$dist$2f$jspdf$2e$node$2e$min$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"]({
                unit: 'mm',
                format: [
                    pageWidth,
                    280
                ]
            });
            let y = 8;
            const leftMargin = 5;
            const rightMargin = pageWidth - 5;
            const contentWidth = rightMargin - leftMargin;
            const drawLine = ()=>{
                doc.setDrawColor(0);
                doc.setLineWidth(0.1);
                doc.line(leftMargin, y, rightMargin, y);
                y += 3;
            };
            const drawDottedLine = ()=>{
                doc.setDrawColor(150);
                doc.setLineWidth(0.1);
                for(let x = leftMargin; x < rightMargin; x += 2){
                    doc.line(x, y, x + 1, y);
                }
                y += 3;
            };
            // If printing original, mark it as printed
            if (mark_original_printed && !sale.original_printed) {
                await client.query(`UPDATE sales SET original_printed = TRUE WHERE id = $1`, [
                    sale_id
                ]);
            }
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            // Add INVOICE COPY header if this is a copy
            if (is_copy) {
                doc.setTextColor(128, 128, 128);
                doc.text("*** INVOICE COPY ***", pageWidth / 2, y, {
                    align: "center"
                });
                y += 5;
                doc.setTextColor(0, 0, 0);
            }
            doc.text(isCreditNote ? "CREDIT NOTE" : "TAX INVOICE", pageWidth / 2, y, {
                align: "center"
            });
            y += 6;
            doc.setFontSize(10);
            doc.text(sale.branch_name || "Flow360 Station", pageWidth / 2, y, {
                align: "center"
            });
            y += 4;
            doc.setFontSize(8);
            doc.setFont("helvetica", "normal");
            if (sale.branch_address) {
                doc.text(sale.branch_address, pageWidth / 2, y, {
                    align: "center"
                });
                y += 3;
            }
            if (sale.branch_phone) {
                doc.text(`Tel: ${sale.branch_phone}`, pageWidth / 2, y, {
                    align: "center"
                });
                y += 3;
            }
            doc.setFont("helvetica", "bold");
            doc.text(`PIN: ${sale.kra_pin || 'P052344628B'}`, pageWidth / 2, y, {
                align: "center"
            });
            y += 5;
            drawLine();
            doc.setFontSize(7);
            doc.setFont("helvetica", "normal");
            if (isCreditNote) {
                const originalCuInv = sale.original_cu_invoice || sale.original_kra_cu_inv || sale.original_invoice_number || "N/A";
                doc.text("REFERENCING ORIGINAL CU INVOICE NO.#:", pageWidth / 2, y, {
                    align: "center"
                });
                y += 3;
                doc.setFont("helvetica", "bold");
                doc.text(String(originalCuInv), pageWidth / 2, y, {
                    align: "center"
                });
                doc.setFont("helvetica", "normal");
            } else {
                doc.text("Welcome to our shop", pageWidth / 2, y, {
                    align: "center"
                });
            }
            y += 4;
            drawLine();
            doc.setFontSize(8);
            doc.setFont("helvetica", "bold");
            doc.text("BUYER INFORMATION", pageWidth / 2, y, {
                align: "center"
            });
            y += 4;
            doc.setFontSize(7);
            doc.setFont("helvetica", "normal");
            // Use loyalty customer fields first (stored directly in sales table), then fall back to customer_pin/name
            const buyerPin = sale.loyalty_customer_pin || sale.customer_pin || "NOT PROVIDED";
            const buyerName = sale.loyalty_customer_name || sale.customer_name || "Walk-in Customer";
            doc.text(`Buyer PIN:`, leftMargin, y);
            doc.text(String(buyerPin), leftMargin + 22, y);
            y += 3;
            doc.text(`Buyer Name:`, leftMargin, y);
            doc.text(String(buyerName), leftMargin + 22, y);
            y += 4;
            drawLine();
            doc.setFontSize(8);
            doc.setFont("helvetica", "bold");
            doc.text("PRODUCT DETAILS", pageWidth / 2, y, {
                align: "center"
            });
            y += 4;
            doc.setFontSize(7);
            doc.setFont("helvetica", "normal");
            const unitPrice = parseFloat(sale.unit_price) || 0;
            const quantity = parseFloat(sale.quantity) || 0;
            const totalAmount = parseFloat(sale.total_amount) || 0;
            const taxableAmount = totalAmount / 1.16;
            const vatAmount = totalAmount - taxableAmount;
            doc.text(`Item Code:`, leftMargin, y);
            doc.text(itemCode, leftMargin + 22, y);
            y += 3;
            doc.text(`Description:`, leftMargin, y);
            doc.text(itemName, leftMargin + 22, y);
            y += 3;
            doc.text(`Dispenser:`, leftMargin, y);
            doc.text(`D${sale.dispenser_number || '0'}N${sale.nozzle_number || '1'}`, leftMargin + 22, y);
            y += 3;
            doc.text(`Unit Price:`, leftMargin, y);
            doc.text(`KES ${unitPrice.toFixed(2)}`, leftMargin + 22, y);
            y += 3;
            doc.text(`Quantity:`, leftMargin, y);
            doc.text(`${quantity.toFixed(3)} L`, leftMargin + 22, y);
            y += 3;
            doc.text(`Discount:`, leftMargin, y);
            doc.text("(0.00)", leftMargin + 22, y);
            y += 4;
            doc.setFont("helvetica", "bold");
            doc.text(`Total:`, leftMargin, y);
            doc.text(`KES ${totalAmount.toFixed(2)}`, leftMargin + 22, y);
            y += 5;
            drawLine();
            doc.setFontSize(8);
            doc.text("TAX BREAKDOWN", pageWidth / 2, y, {
                align: "center"
            });
            y += 4;
            doc.setFontSize(6);
            doc.setFont("helvetica", "bold");
            doc.text("Rate", leftMargin, y);
            doc.text("Taxable", leftMargin + 20, y);
            doc.text("VAT", leftMargin + 45, y);
            y += 3;
            drawDottedLine();
            doc.setFont("helvetica", "normal");
            doc.text("EX", leftMargin, y);
            doc.text("KES 0.00", leftMargin + 20, y);
            doc.text("KES 0.00", leftMargin + 45, y);
            y += 3;
            doc.text("16%", leftMargin, y);
            doc.text(`KES ${taxableAmount.toFixed(2)}`, leftMargin + 20, y);
            doc.text(`KES ${vatAmount.toFixed(2)}`, leftMargin + 45, y);
            y += 3;
            doc.text("0%", leftMargin, y);
            doc.text("KES 0.00", leftMargin + 20, y);
            doc.text("KES 0.00", leftMargin + 45, y);
            y += 4;
            drawLine();
            doc.setFontSize(7);
            const saleTimestamp = new Date(sale.created_at || sale.sale_date);
            const dateStr = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2d$tz$2f$dist$2f$esm$2f$formatInTimeZone$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["formatInTimeZone"])(saleTimestamp, 'Africa/Nairobi', 'dd/MM/yyyy');
            const timeStr = (0, __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$date$2d$fns$2d$tz$2f$dist$2f$esm$2f$formatInTimeZone$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["formatInTimeZone"])(saleTimestamp, 'Africa/Nairobi', 'HH:mm:ss');
            doc.text(`Date:`, leftMargin, y);
            doc.text(dateStr, leftMargin + 22, y);
            y += 3;
            doc.text(`Time:`, leftMargin, y);
            doc.text(timeStr, leftMargin + 22, y);
            y += 4;
            drawLine();
            doc.setFontSize(6);
            doc.text(`SCU ID:`, leftMargin, y);
            doc.text(sale.kra_scu_id || "N/A", leftMargin + 18, y);
            y += 3;
            doc.text(`CU INV NO:`, leftMargin, y);
            doc.text(sale.kra_cu_inv || "N/A", leftMargin + 18, y);
            y += 3;
            doc.text(`Internal Data:`, leftMargin, y);
            doc.text(sale.kra_internal_data || sale.invoice_number || "N/A", leftMargin + 18, y);
            y += 4;
            drawLine();
            const kraPin = sale.kra_pin || 'P052344628B';
            const bhfId = sale.bhf_id || '03';
            const rcptSign = sale.kra_rcpt_sign || '';
            const qrData = `${kraPin}${bhfId}${rcptSign}`;
            const kraPortal = ("TURBOPACK compile-time falsy", 0) ? "TURBOPACK unreachable" : 'etims-sbx.kra.go.ke';
            const qrUrl = `https://${kraPortal}/common/link/etims/receipt/indexEtimsReceiptData?Data=${qrData}`;
            doc.setFontSize(8);
            doc.setFont("helvetica", "bold");
            doc.text("KRA eTIMS Verification", pageWidth / 2, y, {
                align: "center"
            });
            y += 5;
            try {
                const qrDataUrl = await __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$qrcode$2f$lib$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"].toDataURL(qrUrl, {
                    width: 150,
                    margin: 1,
                    errorCorrectionLevel: 'M'
                });
                const qrSize = 30;
                const qrX = (pageWidth - qrSize) / 2;
                doc.addImage(qrDataUrl, 'PNG', qrX, y, qrSize, qrSize);
                y += qrSize + 3;
            } catch (qrError) {
                console.error("QR Code generation error:", qrError);
                doc.setFontSize(6);
                doc.setFont("helvetica", "normal");
                doc.text("QR Code unavailable", pageWidth / 2, y + 10, {
                    align: "center"
                });
                y += 20;
            }
            doc.setFontSize(5);
            doc.setFont("helvetica", "normal");
            doc.text("Scan to verify with KRA eTIMS", pageWidth / 2, y, {
                align: "center"
            });
            y += 4;
            drawLine();
            doc.setFontSize(7);
            const receiptNo = sale.kra_cu_inv?.split('/')[1] || sale.invoice_number?.replace('INV-', '') || String(sale.id).substring(0, 8);
            doc.text(`Receipt No:`, leftMargin, y);
            doc.text(receiptNo, leftMargin + 22, y);
            y += 3;
            doc.text(`Served by:`, leftMargin, y);
            doc.text(sale.served_by_name || sale.cashier_name || "Attendant", leftMargin + 22, y);
            y += 3;
            doc.text(`Payment:`, leftMargin, y);
            doc.text(sale.payment_method || "Cash", leftMargin + 22, y);
            y += 4;
            drawLine();
            doc.setFontSize(8);
            doc.setFont("helvetica", "bold");
            doc.text("Carbon Emission Details", pageWidth / 2, y, {
                align: "center"
            });
            y += 4;
            doc.setFontSize(7);
            doc.setFont("helvetica", "normal");
            const co2PerLitre = sale.fuel_type?.toLowerCase().includes('diesel') ? 2.68 : 2.31;
            const totalCo2 = quantity * co2PerLitre;
            doc.text(`CO2 Per Litre:`, leftMargin, y);
            doc.text(`${co2PerLitre.toFixed(2)} kg`, leftMargin + 22, y);
            y += 3;
            doc.text(`Total CO2:`, leftMargin, y);
            doc.text(`${totalCo2.toFixed(2)} kg`, leftMargin + 22, y);
            y += 4;
            drawLine();
            doc.setFontSize(9);
            doc.setFont("helvetica", "bold");
            doc.text("THANK YOU FOR SHOPPING WITH US", pageWidth / 2, y, {
                align: "center"
            });
            y += 5;
            doc.setFontSize(7);
            doc.setFont("helvetica", "normal");
            doc.text("Powered by Flow360", pageWidth / 2, y, {
                align: "center"
            });
            y += 4;
            drawLine();
            doc.setFontSize(7);
            doc.setFont("helvetica", "bold");
            doc.text("END OF LEGAL RECEIPT", pageWidth / 2, y, {
                align: "center"
            });
            const pdfBuffer = Buffer.from(doc.output('arraybuffer'));
            return new __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"](pdfBuffer, {
                status: 200,
                headers: {
                    'Content-Type': 'application/pdf',
                    'Content-Disposition': `attachment; filename="receipt-${sale.invoice_number || sale.id}.pdf"`
                }
            });
        } finally{
            client.release();
        }
    } catch (error) {
        console.error("[Receipt Generate API Error]:", error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: error.message || "Failed to generate receipt"
        }, {
            status: 500
        });
    }
}
__turbopack_async_result__();
} catch(e) { __turbopack_async_result__(e); } }, false);}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__cace8927._.js.map