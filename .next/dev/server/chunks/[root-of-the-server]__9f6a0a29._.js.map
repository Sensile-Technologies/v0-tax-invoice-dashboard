{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/client.ts"],"sourcesContent":["import { Pool } from 'pg';\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,\n});\n\nexport async function query<T = any>(text: string, params?: any[]): Promise<T[]> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rows as T[];\n  } finally {\n    client.release();\n  }\n}\n\nexport async function queryOne<T = any>(text: string, params?: any[]): Promise<T | null> {\n  const rows = await query<T>(text, params);\n  return rows[0] || null;\n}\n\nexport async function execute(text: string, params?: any[]): Promise<number> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rowCount || 0;\n  } finally {\n    client.release();\n  }\n}\n\nexport async function getClient() {\n  return await pool.connect();\n}\n\nexport { pool };\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,sCAAwC,0BAAgC;AAC/E;AAEO,eAAe,MAAe,IAAY,EAAE,MAAc;IAC/D,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,IAAI;IACpB,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe,SAAkB,IAAY,EAAE,MAAc;IAClE,MAAM,OAAO,MAAM,MAAS,MAAM;IAClC,OAAO,IAAI,CAAC,EAAE,IAAI;AACpB;AAEO,eAAe,QAAQ,IAAY,EAAE,MAAc;IACxD,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,QAAQ,IAAI;IAC5B,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe;IACpB,OAAO,MAAM,KAAK,OAAO;AAC3B"}},
    {"offset": {"line": 113, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/index.ts"],"sourcesContent":["export * from './client';\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 127, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/credit-transactions/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { query } from '@/lib/db'\nimport { cookies } from 'next/headers'\n\nasync function getSession() {\n  const cookieStore = await cookies()\n  const sessionCookie = cookieStore.get(\"user_session\")\n  if (!sessionCookie) return null\n  try {\n    return JSON.parse(sessionCookie.value)\n  } catch {\n    return null\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  const { searchParams } = new URL(request.url)\n  const branchId = searchParams.get('branch_id')\n  const startDate = searchParams.get('start_date')\n  const endDate = searchParams.get('end_date')\n\n  if (!branchId) {\n    return NextResponse.json({ success: false, error: 'Branch ID required' }, { status: 400 })\n  }\n\n  try {\n    const session = await getSession()\n    if (!session?.id) {\n      return NextResponse.json({ success: false, error: 'Unauthorized' }, { status: 401 })\n    }\n\n    const dateFilter = startDate && endDate \n      ? `AND DATE(s.sale_date) BETWEEN $2 AND $3`\n      : ''\n    const dateParams = startDate && endDate ? [branchId, startDate, endDate] : [branchId]\n\n    const creditSalesQuery = `\n      SELECT \n        s.id,\n        'sale' as credit_type,\n        s.sale_date as transaction_date,\n        DATE(s.sale_date) as day,\n        s.invoice_number,\n        s.customer_name,\n        s.vehicle_number,\n        s.total_amount as credit_amount,\n        COALESCE(i.item_name, s.fuel_type) as item_name,\n        s.quantity,\n        s.unit_price,\n        COALESCE(\n          (SELECT SUM(cp.payment_amount) FROM credit_payments cp WHERE cp.source_id = s.id AND cp.credit_type = 'sale'),\n          0\n        ) as paid_amount\n      FROM sales s\n      LEFT JOIN items i ON s.item_id = i.id\n      WHERE s.branch_id = $1\n        AND s.payment_method = 'credit'\n        AND (s.is_credit_note = false OR s.is_credit_note IS NULL)\n        ${dateFilter}\n      ORDER BY s.sale_date DESC\n    `\n\n    const creditSales = await query(creditSalesQuery, dateParams)\n\n    const collectionDateFilter = startDate && endDate \n      ? `AND DATE(ac.created_at) BETWEEN $2 AND $3`\n      : ''\n\n    const creditCollectionsQuery = `\n      SELECT \n        ac.id,\n        'collection' as credit_type,\n        ac.created_at as transaction_date,\n        DATE(ac.created_at) as day,\n        sh.id as shift_id,\n        u.full_name as staff_name,\n        ac.amount as credit_amount,\n        COALESCE(\n          (SELECT SUM(cp.payment_amount) FROM credit_payments cp WHERE cp.source_id = ac.id AND cp.credit_type = 'collection'),\n          0\n        ) as paid_amount\n      FROM attendant_collections ac\n      JOIN shifts sh ON ac.shift_id = sh.id\n      LEFT JOIN users u ON ac.staff_id = u.id\n      WHERE ac.branch_id = $1\n        AND ac.payment_method = 'credit'\n        ${collectionDateFilter}\n      ORDER BY ac.created_at DESC\n    `\n\n    const creditCollections = await query(creditCollectionsQuery, dateParams)\n\n    const allTransactions = [\n      ...creditSales.map((s: any) => ({\n        ...s,\n        credit_amount: parseFloat(s.credit_amount) || 0,\n        paid_amount: parseFloat(s.paid_amount) || 0,\n        outstanding: (parseFloat(s.credit_amount) || 0) - (parseFloat(s.paid_amount) || 0)\n      })),\n      ...creditCollections.map((c: any) => ({\n        ...c,\n        credit_amount: parseFloat(c.credit_amount) || 0,\n        paid_amount: parseFloat(c.paid_amount) || 0,\n        outstanding: (parseFloat(c.credit_amount) || 0) - (parseFloat(c.paid_amount) || 0)\n      }))\n    ].sort((a, b) => new Date(b.transaction_date).getTime() - new Date(a.transaction_date).getTime())\n\n    const dailyTotals: Record<string, { \n      date: string, \n      total_credit: number, \n      total_paid: number, \n      outstanding: number,\n      transactions: any[] \n    }> = {}\n\n    for (const tx of allTransactions) {\n      const day = tx.day\n      if (!dailyTotals[day]) {\n        dailyTotals[day] = { \n          date: day, \n          total_credit: 0, \n          total_paid: 0, \n          outstanding: 0,\n          transactions: [] \n        }\n      }\n      dailyTotals[day].total_credit += tx.credit_amount\n      dailyTotals[day].total_paid += tx.paid_amount\n      dailyTotals[day].outstanding += tx.outstanding\n      dailyTotals[day].transactions.push(tx)\n    }\n\n    const dailySummary = Object.values(dailyTotals).sort((a, b) => \n      new Date(b.date).getTime() - new Date(a.date).getTime()\n    )\n\n    const overallTotals = {\n      total_credit: allTransactions.reduce((sum, tx) => sum + tx.credit_amount, 0),\n      total_paid: allTransactions.reduce((sum, tx) => sum + tx.paid_amount, 0),\n      outstanding: allTransactions.reduce((sum, tx) => sum + tx.outstanding, 0)\n    }\n\n    return NextResponse.json({\n      success: true,\n      data: {\n        daily: dailySummary,\n        totals: overallTotals,\n        transaction_count: allTransactions.length\n      }\n    })\n  } catch (error) {\n    console.error('Error fetching credit transactions:', error)\n    return NextResponse.json({ success: false, error: 'Failed to fetch credit transactions' }, { status: 500 })\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const session = await getSession()\n    if (!session?.id) {\n      return NextResponse.json({ success: false, error: 'Unauthorized' }, { status: 401 })\n    }\n\n    const body = await request.json()\n    const { \n      branch_id, \n      credit_type, \n      source_id, \n      source_date, \n      payment_amount, \n      payment_reference, \n      payment_notes \n    } = body\n\n    if (!branch_id || !credit_type || !source_id || !payment_amount) {\n      return NextResponse.json({ \n        success: false, \n        error: 'Missing required fields: branch_id, credit_type, source_id, payment_amount' \n      }, { status: 400 })\n    }\n\n    const paymentNum = parseFloat(payment_amount)\n    if (isNaN(paymentNum) || paymentNum <= 0) {\n      return NextResponse.json({ \n        success: false, \n        error: 'Payment amount must be greater than 0' \n      }, { status: 400 })\n    }\n\n    let originalAmount = 0\n    let actualSourceDate = source_date\n\n    if (credit_type === 'sale') {\n      const saleResult = await query(\n        `SELECT total_amount, DATE(sale_date) as day FROM sales \n         WHERE id = $1 AND branch_id = $2 AND payment_method = 'credit'`,\n        [source_id, branch_id]\n      )\n      if (saleResult.length === 0) {\n        return NextResponse.json({ \n          success: false, \n          error: 'Credit sale not found or access denied' \n        }, { status: 404 })\n      }\n      originalAmount = parseFloat(saleResult[0].total_amount) || 0\n      actualSourceDate = saleResult[0].day\n    } else if (credit_type === 'collection') {\n      const collectionResult = await query(\n        `SELECT amount, DATE(created_at) as day FROM attendant_collections \n         WHERE id = $1 AND branch_id = $2 AND payment_method = 'credit'`,\n        [source_id, branch_id]\n      )\n      if (collectionResult.length === 0) {\n        return NextResponse.json({ \n          success: false, \n          error: 'Credit collection not found or access denied' \n        }, { status: 404 })\n      }\n      originalAmount = parseFloat(collectionResult[0].amount) || 0\n      actualSourceDate = collectionResult[0].day\n    } else {\n      return NextResponse.json({ \n        success: false, \n        error: 'Invalid credit_type. Must be \"sale\" or \"collection\"' \n      }, { status: 400 })\n    }\n\n    const existingPayments = await query(\n      `SELECT COALESCE(SUM(payment_amount), 0) as total_paid \n       FROM credit_payments \n       WHERE source_id = $1 AND credit_type = $2`,\n      [source_id, credit_type]\n    )\n    \n    const totalPaid = parseFloat(existingPayments[0]?.total_paid || 0)\n    const outstanding = originalAmount - totalPaid\n    \n    if (paymentNum > outstanding + 0.01) {\n      return NextResponse.json({ \n        success: false, \n        error: `Payment exceeds outstanding amount. Outstanding: ${outstanding.toFixed(2)}` \n      }, { status: 400 })\n    }\n\n    const userResult = await query(\n      `SELECT u.id, v.id as vendor_id, s.branch_id as staff_branch_id\n       FROM users u\n       LEFT JOIN vendors v ON v.email = u.email\n       LEFT JOIN staff s ON s.user_id = u.id\n       WHERE u.id = $1`,\n      [session.id]\n    )\n    \n    let vendorId = userResult[0]?.vendor_id || null\n    if (!vendorId && userResult[0]?.staff_branch_id) {\n      const branchResult = await query(\n        'SELECT vendor_id FROM branches WHERE id = $1',\n        [userResult[0].staff_branch_id]\n      )\n      vendorId = branchResult[0]?.vendor_id || null\n    }\n\n    const result = await query(\n      `INSERT INTO credit_payments (\n        branch_id, vendor_id, credit_type, source_id, source_date, \n        credit_amount, payment_amount, payment_reference, payment_notes, recorded_by\n      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10)\n      RETURNING *`,\n      [\n        branch_id,\n        vendorId,\n        credit_type,\n        source_id,\n        actualSourceDate || new Date().toISOString().split('T')[0],\n        originalAmount,\n        paymentNum,\n        payment_reference || null,\n        payment_notes || null,\n        session.id\n      ]\n    )\n\n    return NextResponse.json({ success: true, data: result[0] })\n  } catch (error) {\n    console.error('Error recording credit payment:', error)\n    return NextResponse.json({ success: false, error: 'Failed to record payment' }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}