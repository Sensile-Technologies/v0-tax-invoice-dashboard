{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\"\nimport { cookies } from \"next/headers\"\n\nexport async function createClient() {\n  const cookieStore = await cookies()\n\n  return createServerClient(process.env.NEXT_PUBLIC_SUPABASE_URL!, process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!, {\n    cookies: {\n      getAll() {\n        return cookieStore.getAll()\n      },\n      setAll(cookiesToSet) {\n        try {\n          cookiesToSet.forEach(({ name, value, options }) => {\n            cookieStore.set(name, value, options)\n          })\n        } catch (error) {\n          // Handle cookies in Server Components\n        }\n      },\n    },\n  })\n}\n"],"names":[],"mappings":";;;;AAAA;AAAA;AACA;;;AAEO,eAAe;IACpB,MAAM,cAAc,MAAM,IAAA,4IAAO;IAEjC,OAAO,IAAA,iMAAkB,EAAC,QAAQ,GAAG,CAAC,wBAAwB,EAAG,QAAQ,GAAG,CAAC,6BAA6B,EAAG;QAC3G,SAAS;YACP;gBACE,OAAO,YAAY,MAAM;YAC3B;YACA,QAAO,YAAY;gBACjB,IAAI;oBACF,aAAa,OAAO,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,OAAO,EAAE;wBAC5C,YAAY,GAAG,CAAC,MAAM,OAAO;oBAC/B;gBACF,EAAE,OAAO,OAAO;gBACd,sCAAsC;gBACxC;YACF;QACF;IACF;AACF"}},
    {"offset": {"line": 78, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/api-logger.ts"],"sourcesContent":["import { createClient } from \"@/lib/supabase/server\"\n\nexport interface ApiLogEntry {\n  endpoint: string\n  method: string\n  payload?: any\n  response?: any\n  statusCode?: number\n  error?: string\n  durationMs?: number\n  branchId?: string\n  externalEndpoint?: string\n}\n\nexport async function logApiCall(entry: ApiLogEntry) {\n  try {\n    const supabase = await createClient()\n\n    await supabase.from(\"api_logs\").insert({\n      endpoint: entry.endpoint,\n      method: entry.method,\n      payload: entry.payload || null,\n      response: entry.response || null,\n      status_code: entry.statusCode || null,\n      error: entry.error || null,\n      duration_ms: entry.durationMs || null,\n      branch_id: entry.branchId || null,\n      user_agent: entry.externalEndpoint || null,\n    })\n  } catch (error) {\n    console.error(\"[v0] Failed to log API call:\", error)\n  }\n}\n\nexport function createApiLogger(endpoint: string, method = \"POST\") {\n  const startTime = Date.now()\n\n  return {\n    success: async (payload: any, response: any, branchId?: string, externalEndpoint?: string) => {\n      const duration = Date.now() - startTime\n      await logApiCall({\n        endpoint,\n        method,\n        payload,\n        response,\n        statusCode: 200,\n        durationMs: duration,\n        branchId,\n        externalEndpoint,\n      })\n    },\n    error: async (payload: any, error: any, statusCode = 500, branchId?: string, externalEndpoint?: string) => {\n      const duration = Date.now() - startTime\n      await logApiCall({\n        endpoint,\n        method,\n        payload,\n        error: error?.message || String(error),\n        statusCode,\n        durationMs: duration,\n        branchId,\n        externalEndpoint,\n      })\n    },\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;;AAcO,eAAe,WAAW,KAAkB;IACjD,IAAI;QACF,MAAM,WAAW,MAAM,IAAA,2IAAY;QAEnC,MAAM,SAAS,IAAI,CAAC,YAAY,MAAM,CAAC;YACrC,UAAU,MAAM,QAAQ;YACxB,QAAQ,MAAM,MAAM;YACpB,SAAS,MAAM,OAAO,IAAI;YAC1B,UAAU,MAAM,QAAQ,IAAI;YAC5B,aAAa,MAAM,UAAU,IAAI;YACjC,OAAO,MAAM,KAAK,IAAI;YACtB,aAAa,MAAM,UAAU,IAAI;YACjC,WAAW,MAAM,QAAQ,IAAI;YAC7B,YAAY,MAAM,gBAAgB,IAAI;QACxC;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gCAAgC;IAChD;AACF;AAEO,SAAS,gBAAgB,QAAgB,EAAE,SAAS,MAAM;IAC/D,MAAM,YAAY,KAAK,GAAG;IAE1B,OAAO;QACL,SAAS,OAAO,SAAc,UAAe,UAAmB;YAC9D,MAAM,WAAW,KAAK,GAAG,KAAK;YAC9B,MAAM,WAAW;gBACf;gBACA;gBACA;gBACA;gBACA,YAAY;gBACZ,YAAY;gBACZ;gBACA;YACF;QACF;QACA,OAAO,OAAO,SAAc,OAAY,aAAa,GAAG,EAAE,UAAmB;YAC3E,MAAM,WAAW,KAAK,GAAG,KAAK;YAC9B,MAAM,WAAW;gBACf;gBACA;gBACA;gBACA,OAAO,OAAO,WAAW,OAAO;gBAChC;gBACA,YAAY;gBACZ;gBACA;YACF;QACF;IACF;AACF"}},
    {"offset": {"line": 139, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/kra/codes/route.ts"],"sourcesContent":["import { createClient } from \"@/lib/supabase/server\"\nimport { NextResponse } from \"next/server\"\nimport { createApiLogger } from \"@/lib/api-logger\"\n\nexport async function POST(request: Request) {\n  const logger = createApiLogger(\"/api/kra/codes\", \"POST\")\n\n  let kraPayload: any = null\n  let kraEndpoint = \"\"\n\n  try {\n    const supabase = await createClient()\n\n    let backendUrl = request.headers.get(\"x-backend-url\") || \"http://20.224.40.56:8088\"\n    backendUrl = backendUrl.replace(/\\/$/, \"\")\n\n    console.log(\"[v0] Backend URL:\", backendUrl)\n\n    const { data: branches } = await supabase\n      .from(\"branches\")\n      .select(\"id, bhf_id, name\")\n      .eq(\"bhf_id\", \"03\")\n      .limit(1)\n      .single()\n\n    if (!branches || !branches.bhf_id) {\n      throw new Error(\"Thika Greens branch (BHF ID: 03) not found. Please configure it first.\")\n    }\n\n    kraPayload = {\n      tin: \"P052344628B\",\n      bhfId: \"03\",\n      lastReqDt: \"20180328000000\",\n    }\n\n    console.log(\"[v0] Pulling code list with payload:\", kraPayload)\n\n    kraEndpoint = `${backendUrl}/code/selectCodes`\n    console.log(\"[v0] Calling KRA API:\", kraEndpoint)\n\n    const controller = new AbortController()\n    const timeoutId = setTimeout(() => controller.abort(), 30000)\n\n    const fetchOptions: RequestInit = {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        Accept: \"application/json\",\n      },\n      body: JSON.stringify(kraPayload),\n      signal: controller.signal,\n    }\n\n    const response = await fetch(kraEndpoint, fetchOptions).finally(() => clearTimeout(timeoutId))\n\n    console.log(\"[v0] KRA API response status:\", response.status)\n\n    const responseText = await response.text()\n    console.log(\"[v0] KRA API raw response:\", responseText.substring(0, 500))\n\n    if (responseText.trim().startsWith(\"<!DOCTYPE\") || responseText.trim().startsWith(\"<html\")) {\n      throw new Error(\n        `Backend returned HTML instead of JSON. This usually means the endpoint doesn't exist or there's a routing error. Response: ${responseText.substring(0, 200)}`,\n      )\n    }\n\n    let result\n    try {\n      result = JSON.parse(responseText)\n    } catch (parseError) {\n      throw new Error(`Failed to parse backend response as JSON: ${responseText.substring(0, 200)}`)\n    }\n\n    if (!response.ok) {\n      throw new Error(`KRA API error: ${response.status} ${response.statusText} - ${JSON.stringify(result)}`)\n    }\n\n    console.log(\"[v0] Parsed result keys:\", Object.keys(result))\n\n    // Save to local database\n    if (result.data && Array.isArray(result.data)) {\n      console.log(\"[v0] Saving\", result.data.length, \"code list items to database\")\n\n      for (const item of result.data) {\n        await supabase.from(\"code_lists\").upsert(\n          {\n            cd_cls: item.cdCls,\n            cd: item.cd,\n            cd_nm: item.cdNm,\n            cd_desc: item.cdDesc,\n            use_yn: item.useYn || \"Y\",\n            user_dfn_cd1: item.userDfnCd1,\n            user_dfn_cd2: item.userDfnCd2,\n            user_dfn_cd3: item.userDfnCd3,\n            last_req_dt: new Date(),\n          },\n          { onConflict: \"cd_cls,cd\" },\n        )\n      }\n    }\n\n    await logger.success(kraPayload, result, branches.id, kraEndpoint)\n\n    return NextResponse.json({\n      resultCd: \"000\",\n      resultMsg: \"Successfully pulled code list from KRA\",\n      resultDt: new Date().toISOString(),\n      data: result.data || [],\n    })\n  } catch (error: any) {\n    console.error(\"[v0] Get codes error:\", error.message)\n    console.error(\"[v0] Full error:\", error)\n\n    let errorMessage = error.message\n\n    if (error.message.includes(\"fetch failed\") || error.name === \"FetchError\") {\n      errorMessage =\n        \"Failed to connect to KRA backend. Common causes:\\n\" +\n        \"1. Backend server may not be running or accessible\\n\" +\n        \"2. URL/Port configuration may be incorrect\\n\" +\n        \"3. Network/firewall may be blocking the connection\\n\" +\n        \"4. Check if backend requires HTTP or HTTPS\\n\\n\" +\n        \"Current configuration: \" +\n        kraEndpoint\n    }\n\n    const errorResponse = {\n      resultCd: \"999\",\n      resultMsg: errorMessage,\n      resultDt: new Date().toISOString(),\n    }\n\n    await logger.error(kraPayload, error, 500, undefined, kraEndpoint)\n\n    return NextResponse.json(errorResponse, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}