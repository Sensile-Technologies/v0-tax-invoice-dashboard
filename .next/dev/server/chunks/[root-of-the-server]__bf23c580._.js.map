{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/mobile/invoices/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const branchId = searchParams.get(\"branch_id\")\n    const dateFrom = searchParams.get(\"date_from\")\n    const dateTo = searchParams.get(\"date_to\")\n    const limit = parseInt(searchParams.get(\"limit\") || \"100\")\n\n    const client = await pool.connect()\n    try {\n      let sql = `\n        SELECT \n          s.id,\n          s.invoice_number,\n          s.customer_name,\n          s.customer_pin,\n          s.sale_date,\n          s.fuel_type,\n          s.quantity,\n          s.unit_price,\n          s.total_amount,\n          s.payment_method,\n          s.kra_scu_id as cu_serial_number,\n          s.kra_cu_inv as cu_invoice_no,\n          s.kra_internal_data as intrl_data,\n          s.kra_rcpt_sign as receipt_signature,\n          b.name as branch_name,\n          b.address as branch_address,\n          b.phone as branch_phone,\n          b.kra_pin as branch_pin,\n          b.bhf_id as bhf_id,\n          u.username as cashier_name,\n          CASE \n            WHEN s.payment_method = 'credit' THEN 'pending'\n            ELSE 'paid'\n          END as status\n        FROM sales s\n        LEFT JOIN branches b ON s.branch_id = b.id\n        LEFT JOIN users u ON s.staff_id = u.id\n        WHERE 1=1\n      `\n      const params: any[] = []\n      let paramIndex = 1\n\n      if (branchId) {\n        sql += ` AND s.branch_id = $${paramIndex}`\n        params.push(branchId)\n        paramIndex++\n      }\n\n      if (dateFrom) {\n        sql += ` AND DATE(s.sale_date) >= $${paramIndex}`\n        params.push(dateFrom)\n        paramIndex++\n      }\n\n      if (dateTo) {\n        sql += ` AND DATE(s.sale_date) <= $${paramIndex}`\n        params.push(dateTo)\n        paramIndex++\n      }\n\n      sql += ` ORDER BY s.sale_date DESC LIMIT $${paramIndex}`\n      params.push(limit)\n\n      const result = await client.query(sql, params)\n      \n      return NextResponse.json({\n        sales: result.rows\n      })\n    } finally {\n      client.release()\n    }\n  } catch (error) {\n    console.error(\"Error fetching mobile invoices:\", error)\n    return NextResponse.json({ sales: [] })\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const {\n      customer_name,\n      customer_phone,\n      items,\n      subtotal,\n      tax,\n      total,\n      user_id,\n      branch_id\n    } = body\n\n    const client = await pool.connect()\n    try {\n      const invoiceNumber = `INV-${Date.now().toString(36).toUpperCase()}`\n\n      const result = await client.query(`\n        INSERT INTO invoices (\n          invoice_number,\n          customer_name,\n          customer_phone,\n          branch_id,\n          subtotal,\n          tax_amount,\n          total_amount,\n          status,\n          created_by\n        )\n        VALUES ($1, $2, $3, $4, $5, $6, $7, 'pending', $8)\n        RETURNING *\n      `, [\n        invoiceNumber,\n        customer_name || 'Walk-in Customer',\n        customer_phone,\n        branch_id || null,\n        subtotal,\n        tax,\n        total,\n        user_id || null\n      ])\n\n      const invoice = result.rows[0]\n\n      if (items && items.length > 0 && invoice) {\n        for (const item of items) {\n          await client.query(`\n            INSERT INTO invoice_line_items (\n              invoice_id,\n              product_id,\n              product_name,\n              quantity,\n              unit_price,\n              discount,\n              total\n            )\n            VALUES ($1, $2, $3, $4, $5, $6, $7)\n          `, [\n            invoice.id,\n            item.product_id,\n            item.product_name,\n            item.quantity,\n            item.unit_price,\n            item.discount || 0,\n            item.total\n          ])\n        }\n      }\n\n      return NextResponse.json(invoice)\n    } finally {\n      client.release()\n    }\n  } catch (error) {\n    console.error(\"Error creating mobile invoice:\", error)\n    return NextResponse.json({ error: \"Failed to create invoice\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;AAC5C;AAEO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,WAAW,aAAa,GAAG,CAAC;QAClC,MAAM,WAAW,aAAa,GAAG,CAAC;QAClC,MAAM,SAAS,aAAa,GAAG,CAAC;QAChC,MAAM,QAAQ,SAAS,aAAa,GAAG,CAAC,YAAY;QAEpD,MAAM,SAAS,MAAM,KAAK,OAAO;QACjC,IAAI;YACF,IAAI,MAAM,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;MA8BX,CAAC;YACD,MAAM,SAAgB,EAAE;YACxB,IAAI,aAAa;YAEjB,IAAI,UAAU;gBACZ,OAAO,CAAC,oBAAoB,EAAE,YAAY;gBAC1C,OAAO,IAAI,CAAC;gBACZ;YACF;YAEA,IAAI,UAAU;gBACZ,OAAO,CAAC,2BAA2B,EAAE,YAAY;gBACjD,OAAO,IAAI,CAAC;gBACZ;YACF;YAEA,IAAI,QAAQ;gBACV,OAAO,CAAC,2BAA2B,EAAE,YAAY;gBACjD,OAAO,IAAI,CAAC;gBACZ;YACF;YAEA,OAAO,CAAC,kCAAkC,EAAE,YAAY;YACxD,OAAO,IAAI,CAAC;YAEZ,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,KAAK;YAEvC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,OAAO,OAAO,IAAI;YACpB;QACF,SAAU;YACR,OAAO,OAAO;QAChB;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,mCAAmC;QACjD,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,EAAE;QAAC;IACvC;AACF;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EACJ,aAAa,EACb,cAAc,EACd,KAAK,EACL,QAAQ,EACR,GAAG,EACH,KAAK,EACL,OAAO,EACP,SAAS,EACV,GAAG;QAEJ,MAAM,SAAS,MAAM,KAAK,OAAO;QACjC,IAAI;YACF,MAAM,gBAAgB,CAAC,IAAI,EAAE,KAAK,GAAG,GAAG,QAAQ,CAAC,IAAI,WAAW,IAAI;YAEpE,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,CAAC;;;;;;;;;;;;;;MAcnC,CAAC,EAAE;gBACD;gBACA,iBAAiB;gBACjB;gBACA,aAAa;gBACb;gBACA;gBACA;gBACA,WAAW;aACZ;YAED,MAAM,UAAU,OAAO,IAAI,CAAC,EAAE;YAE9B,IAAI,SAAS,MAAM,MAAM,GAAG,KAAK,SAAS;gBACxC,KAAK,MAAM,QAAQ,MAAO;oBACxB,MAAM,OAAO,KAAK,CAAC,CAAC;;;;;;;;;;;UAWpB,CAAC,EAAE;wBACD,QAAQ,EAAE;wBACV,KAAK,UAAU;wBACf,KAAK,YAAY;wBACjB,KAAK,QAAQ;wBACb,KAAK,UAAU;wBACf,KAAK,QAAQ,IAAI;wBACjB,KAAK,KAAK;qBACX;gBACH;YACF;YAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;QAC3B,SAAU;YACR,OAAO,OAAO;QAChB;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,kCAAkC;QAChD,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA2B,GAAG;YAAE,QAAQ;QAAI;IAChF;AACF"}}]
}