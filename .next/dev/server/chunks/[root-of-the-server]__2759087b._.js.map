{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/mobile/sales/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nexport async function GET(request: Request) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const branchId = searchParams.get(\"branch_id\")\n\n    if (!branchId) {\n      return NextResponse.json({ error: \"Branch ID required\" }, { status: 400 })\n    }\n\n    const client = await pool.connect()\n    try {\n      const today = new Date().toISOString().split('T')[0]\n\n      const salesResult = await client.query(\n        `SELECT * FROM sales \n         WHERE branch_id = $1 \n         AND sale_date::date = $2::date\n         ORDER BY sale_date DESC \n         LIMIT 50`,\n        [branchId, today]\n      )\n\n      const shiftResult = await client.query(\n        `SELECT * FROM shifts \n         WHERE branch_id = $1 AND status = 'active' \n         ORDER BY start_time DESC \n         LIMIT 1`,\n        [branchId]\n      )\n\n      const nozzlesResult = await client.query(\n        `SELECT id, name, fuel_type FROM nozzles \n         WHERE branch_id = $1 AND status = 'active'`,\n        [branchId]\n      )\n\n      const fuelPricesResult = await client.query(\n        `SELECT fuel_type, price FROM fuel_prices \n         WHERE branch_id = $1 \n         ORDER BY effective_date DESC`,\n        [branchId]\n      )\n\n      return NextResponse.json({\n        sales: salesResult.rows,\n        shift: shiftResult.rows[0] || null,\n        nozzles: nozzlesResult.rows,\n        fuel_prices: fuelPricesResult.rows,\n      })\n    } finally {\n      client.release()\n    }\n  } catch (error) {\n    console.error(\"[Mobile Sales API Error]:\", error)\n    return NextResponse.json({ error: \"Failed to fetch sales data\" }, { status: 500 })\n  }\n}\n\nexport async function POST(request: Request) {\n  try {\n    const body = await request.json()\n    const {\n      branch_id,\n      shift_id,\n      nozzle_id,\n      fuel_type,\n      amount,\n      payment_method,\n      customer_name,\n      vehicle_number,\n    } = body\n\n    if (!branch_id || !fuel_type || !amount) {\n      return NextResponse.json(\n        { error: \"Branch ID, fuel type, and amount are required\" },\n        { status: 400 }\n      )\n    }\n\n    const client = await pool.connect()\n    try {\n      const priceResult = await client.query(\n        `SELECT price FROM fuel_prices \n         WHERE branch_id = $1 AND fuel_type = $2 \n         ORDER BY effective_date DESC \n         LIMIT 1`,\n        [branch_id, fuel_type]\n      )\n\n      if (priceResult.rows.length === 0) {\n        return NextResponse.json(\n          { error: `No price configured for ${fuel_type}` },\n          { status: 400 }\n        )\n      }\n\n      const unitPrice = parseFloat(priceResult.rows[0].price)\n      const totalAmount = parseFloat(amount)\n      const quantity = totalAmount / unitPrice\n\n      const invoiceNumber = `INV-${Date.now()}`\n      const receiptNumber = `RCP-${Date.now()}`\n\n      const result = await client.query(\n        `INSERT INTO sales (\n          branch_id, shift_id, nozzle_id, fuel_type, quantity, \n          unit_price, total_amount, payment_method, customer_name, \n          vehicle_number, invoice_number, receipt_number, sale_date\n        ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, NOW())\n        RETURNING *`,\n        [\n          branch_id,\n          shift_id || null,\n          nozzle_id || null,\n          fuel_type,\n          quantity,\n          unitPrice,\n          totalAmount,\n          payment_method || 'cash',\n          customer_name || null,\n          vehicle_number || null,\n          invoiceNumber,\n          receiptNumber,\n        ]\n      )\n\n      return NextResponse.json({ \n        success: true, \n        sale: result.rows[0] \n      })\n    } finally {\n      client.release()\n    }\n  } catch (error) {\n    console.error(\"[Mobile Sales API Error]:\", error)\n    return NextResponse.json({ error: \"Failed to record sale\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}