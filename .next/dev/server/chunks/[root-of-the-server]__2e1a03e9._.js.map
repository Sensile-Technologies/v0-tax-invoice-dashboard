{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/shifts/attendants/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\nimport { cookies } from \"next/headers\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nexport async function GET(request: NextRequest) {\n  try {\n    const cookieStore = await cookies()\n    const sessionCookie = cookieStore.get(\"user_session\")\n    \n    if (!sessionCookie?.value) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 })\n    }\n    \n    let session\n    try {\n      session = JSON.parse(sessionCookie.value)\n    } catch {\n      return NextResponse.json({ error: \"Invalid session\" }, { status: 401 })\n    }\n    \n    const { searchParams } = new URL(request.url)\n    const shiftId = searchParams.get(\"shift_id\")\n    const branchId = searchParams.get(\"branch_id\")\n\n    if (!shiftId || !branchId) {\n      return NextResponse.json(\n        { error: \"shift_id and branch_id are required\" },\n        { status: 400 }\n      )\n    }\n\n    const accessCheck = await pool.query(\n      `SELECT 1 FROM shifts s\n       JOIN branches b ON s.branch_id = b.id\n       WHERE s.id = $1 AND s.branch_id = $2\n       AND (b.vendor_id = $3 OR s.branch_id = $4)`,\n      [shiftId, branchId, session.vendor_id, session.branch_id]\n    )\n    \n    if (accessCheck.rows.length === 0) {\n      return NextResponse.json({ error: \"Access denied\" }, { status: 403 })\n    }\n\n    const attendantsResult = await pool.query(\n      `SELECT DISTINCT s.staff_id, st.id, st.full_name, st.username\n       FROM sales s\n       JOIN staff st ON s.staff_id = st.id\n       WHERE s.shift_id = $1 AND s.branch_id = $2 AND s.staff_id IS NOT NULL\n       ORDER BY st.full_name`,\n      [shiftId, branchId]\n    )\n\n    const attendants = attendantsResult.rows.map((row) => ({\n      id: row.id,\n      name: row.full_name || row.username || \"Unknown\"\n    }))\n\n    const appPaymentsResult = await pool.query(\n      `SELECT staff_id, SUM(total_amount) as total\n       FROM sales\n       WHERE shift_id = $1 AND branch_id = $2 \n         AND staff_id IS NOT NULL\n         AND payment_method IN ('mpesa', 'card', 'mobile_money')\n       GROUP BY staff_id`,\n      [shiftId, branchId]\n    )\n\n    const appPayments: Record<string, number> = {}\n    for (const row of appPaymentsResult.rows) {\n      appPayments[row.staff_id] = parseFloat(row.total) || 0\n    }\n\n    return NextResponse.json({\n      success: true,\n      attendants,\n      appPayments\n    })\n  } catch (error: any) {\n    console.error(\"Error fetching shift attendants:\", error)\n    return NextResponse.json(\n      { error: \"Failed to fetch attendants\", details: error.message },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;AAC5C;AAEO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,cAAc,MAAM,IAAA,4IAAO;QACjC,MAAM,gBAAgB,YAAY,GAAG,CAAC;QAEtC,IAAI,CAAC,eAAe,OAAO;YACzB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpE;QAEA,IAAI;QACJ,IAAI;YACF,UAAU,KAAK,KAAK,CAAC,cAAc,KAAK;QAC1C,EAAE,OAAM;YACN,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAkB,GAAG;gBAAE,QAAQ;YAAI;QACvE;QAEA,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,UAAU,aAAa,GAAG,CAAC;QACjC,MAAM,WAAW,aAAa,GAAG,CAAC;QAElC,IAAI,CAAC,WAAW,CAAC,UAAU;YACzB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAsC,GAC/C;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,cAAc,MAAM,KAAK,KAAK,CAClC,CAAC;;;iDAG0C,CAAC,EAC5C;YAAC;YAAS;YAAU,QAAQ,SAAS;YAAE,QAAQ,SAAS;SAAC;QAG3D,IAAI,YAAY,IAAI,CAAC,MAAM,KAAK,GAAG;YACjC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAgB,GAAG;gBAAE,QAAQ;YAAI;QACrE;QAEA,MAAM,mBAAmB,MAAM,KAAK,KAAK,CACvC,CAAC;;;;4BAIqB,CAAC,EACvB;YAAC;YAAS;SAAS;QAGrB,MAAM,aAAa,iBAAiB,IAAI,CAAC,GAAG,CAAC,CAAC,MAAQ,CAAC;gBACrD,IAAI,IAAI,EAAE;gBACV,MAAM,IAAI,SAAS,IAAI,IAAI,QAAQ,IAAI;YACzC,CAAC;QAED,MAAM,oBAAoB,MAAM,KAAK,KAAK,CACxC,CAAC;;;;;wBAKiB,CAAC,EACnB;YAAC;YAAS;SAAS;QAGrB,MAAM,cAAsC,CAAC;QAC7C,KAAK,MAAM,OAAO,kBAAkB,IAAI,CAAE;YACxC,WAAW,CAAC,IAAI,QAAQ,CAAC,GAAG,WAAW,IAAI,KAAK,KAAK;QACvD;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT;YACA;QACF;IACF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,oCAAoC;QAClD,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;YAA8B,SAAS,MAAM,OAAO;QAAC,GAC9D;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}