{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/client.ts"],"sourcesContent":["import { Pool } from 'pg';\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,\n});\n\nexport async function query<T = any>(text: string, params?: any[]): Promise<T[]> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rows as T[];\n  } finally {\n    client.release();\n  }\n}\n\nexport async function queryOne<T = any>(text: string, params?: any[]): Promise<T | null> {\n  const rows = await query<T>(text, params);\n  return rows[0] || null;\n}\n\nexport async function execute(text: string, params?: any[]): Promise<number> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rowCount || 0;\n  } finally {\n    client.release();\n  }\n}\n\nexport async function getClient() {\n  return await pool.connect();\n}\n\nexport { pool };\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,sCAAwC,0BAAgC;AAC/E;AAEO,eAAe,MAAe,IAAY,EAAE,MAAc;IAC/D,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,IAAI;IACpB,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe,SAAkB,IAAY,EAAE,MAAc;IAClE,MAAM,OAAO,MAAM,MAAS,MAAM;IAClC,OAAO,IAAI,CAAC,EAAE,IAAI;AACpB;AAEO,eAAe,QAAQ,IAAY,EAAE,MAAc;IACxD,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,QAAQ,IAAI;IAC5B,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe;IACpB,OAAO,MAAM,KAAK,OAAO;AAC3B"}},
    {"offset": {"line": 113, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/index.ts"],"sourcesContent":["export * from './client';\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 127, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/vendors/partners/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { query } from \"@/lib/db\"\nimport { cookies } from \"next/headers\"\n\nasync function getUserVendorId(userId: string): Promise<string | null> {\n  // Check if user belongs to this vendor via email match\n  const userVendor = await query(\n    `SELECT v.id FROM users u \n     JOIN vendors v ON v.email = u.email \n     WHERE u.id = $1`,\n    [userId]\n  )\n  if (userVendor && userVendor.length > 0) {\n    return userVendor[0].id\n  }\n\n  // Check via staff/branch association\n  const staffVendor = await query(\n    `SELECT DISTINCT b.vendor_id FROM staff s\n     JOIN branches b ON s.branch_id = b.id\n     WHERE s.user_id = $1 AND b.vendor_id IS NOT NULL`,\n    [userId]\n  )\n  if (staffVendor && staffVendor.length > 0) {\n    return staffVendor[0].vendor_id\n  }\n\n  // Check via branch ownership\n  const branchVendor = await query(\n    `SELECT DISTINCT vendor_id FROM branches WHERE user_id = $1 AND vendor_id IS NOT NULL`,\n    [userId]\n  )\n  if (branchVendor && branchVendor.length > 0) {\n    return branchVendor[0].vendor_id\n  }\n\n  return null\n}\n\nasync function getSessionUserId(): Promise<string | null> {\n  try {\n    const cookieStore = await cookies()\n    const sessionCookie = cookieStore.get(\"user_session\")\n    if (!sessionCookie?.value) return null\n    \n    const session = JSON.parse(sessionCookie.value)\n    return session.id || null\n  } catch {\n    return null\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const partnerType = searchParams.get(\"partner_type\")\n\n    // Get user from session and derive vendor_id server-side\n    const userId = await getSessionUserId()\n    if (!userId) {\n      return NextResponse.json({ success: false, error: \"Unauthorized\" }, { status: 401 })\n    }\n\n    const vendorId = await getUserVendorId(userId)\n    if (!vendorId) {\n      return NextResponse.json({ success: false, error: \"No vendor found for user\" }, { status: 403 })\n    }\n\n    let sql = `\n      SELECT * FROM vendor_partners \n      WHERE vendor_id = $1\n    `\n    const params: any[] = [vendorId]\n\n    if (partnerType && (partnerType === 'supplier' || partnerType === 'transporter')) {\n      sql += ` AND partner_type = $2`\n      params.push(partnerType)\n    }\n\n    sql += ` ORDER BY name`\n\n    const partners = await query(sql, params)\n    return NextResponse.json({ success: true, data: partners })\n  } catch (error) {\n    console.error(\"Error fetching partners:\", error)\n    return NextResponse.json({ success: false, error: \"Failed to fetch partners\" }, { status: 500 })\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    // Get user from session and derive vendor_id server-side\n    const userId = await getSessionUserId()\n    if (!userId) {\n      return NextResponse.json({ success: false, error: \"Unauthorized\" }, { status: 401 })\n    }\n\n    const vendorId = await getUserVendorId(userId)\n    if (!vendorId) {\n      return NextResponse.json({ success: false, error: \"No vendor found for user\" }, { status: 403 })\n    }\n\n    const body = await request.json()\n    const { partner_type, name, tin, physical_address, contact_person, phone } = body\n\n    if (!partner_type || !name) {\n      return NextResponse.json({ \n        success: false, \n        error: \"partner_type and name are required\" \n      }, { status: 400 })\n    }\n\n    if (!['supplier', 'transporter'].includes(partner_type)) {\n      return NextResponse.json({ \n        success: false, \n        error: \"partner_type must be 'supplier' or 'transporter'\" \n      }, { status: 400 })\n    }\n\n    const result = await query(\n      `INSERT INTO vendor_partners (vendor_id, partner_type, name, tin, physical_address, contact_person, phone)\n       VALUES ($1, $2, $3, $4, $5, $6, $7)\n       RETURNING *`,\n      [vendorId, partner_type, name, tin || null, physical_address || null, contact_person || null, phone || null]\n    )\n\n    return NextResponse.json({ success: true, data: result[0] })\n  } catch (error: any) {\n    console.error(\"Error creating partner:\", error)\n    if (error.code === '23505') {\n      return NextResponse.json({ \n        success: false, \n        error: \"A partner with this TIN already exists for this vendor\" \n      }, { status: 400 })\n    }\n    return NextResponse.json({ success: false, error: \"Failed to create partner\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}