{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/dispensers/assign-tanks/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const { dispenser_id, tank_ids, branch_id } = body\n\n    if (!dispenser_id) {\n      return NextResponse.json(\n        { success: false, error: \"dispenser_id is required\" },\n        { status: 400 }\n      )\n    }\n\n    // Filter out any null/undefined/empty tank_ids\n    const tankIdsArray = (tank_ids || []).filter((id: any) => id && typeof id === 'string' && id.trim() !== '')\n\n    console.log(\"Assigning tanks:\", { dispenser_id, tankIdsArray, rawTankIds: tank_ids })\n\n    await pool.query('DELETE FROM dispenser_tanks WHERE dispenser_id = $1', [dispenser_id])\n\n    let fuelTypes: string[] = []\n    let itemId: string | null = null\n\n    if (tankIdsArray.length > 0) {\n      const tanksResult = await pool.query(\n        'SELECT id, fuel_type, item_id FROM tanks WHERE id = ANY($1::uuid[])',\n        [tankIdsArray]\n      )\n      \n      fuelTypes = [...new Set(tanksResult.rows.map((t: any) => t.fuel_type))]\n      const tankWithItem = tanksResult.rows.find((t: any) => t.item_id)\n      if (tankWithItem) {\n        itemId = tankWithItem.item_id\n      }\n\n      // Insert only valid tank IDs that exist in the database\n      for (const tank of tanksResult.rows) {\n        await pool.query(\n          'INSERT INTO dispenser_tanks (dispenser_id, tank_id) VALUES ($1, $2) ON CONFLICT DO NOTHING',\n          [dispenser_id, tank.id]\n        )\n      }\n    }\n\n    const fuelType = fuelTypes.length > 0 ? fuelTypes.join(\"/\") : \"Pending\"\n    const primaryTankId = tankIdsArray.length > 0 ? tankIdsArray[0] : null\n\n    await pool.query(\n      'UPDATE dispensers SET fuel_type = $1, tank_id = $2, item_id = $3, updated_at = NOW() WHERE id = $4',\n      [fuelType, primaryTankId, itemId, dispenser_id]\n    )\n\n    const dispenserResult = await pool.query('SELECT dispenser_number FROM dispensers WHERE id = $1', [dispenser_id])\n    const dispenserNumber = dispenserResult.rows[0]?.dispenser_number || 1\n\n    let nozzlesCreated = 0\n    if (tankIdsArray.length > 0) {\n      const existingNozzlesResult = await pool.query(\n        'SELECT tank_id FROM nozzles WHERE dispenser_id = $1',\n        [dispenser_id]\n      )\n      const existingTankIds = existingNozzlesResult.rows.map((n: any) => n.tank_id)\n\n      const tanksResultForNozzles = await pool.query(\n        'SELECT id, fuel_type, item_id FROM tanks WHERE id = ANY($1::uuid[])',\n        [tankIdsArray]\n      )\n\n      for (let i = 0; i < tanksResultForNozzles.rows.length; i++) {\n        const tank = tanksResultForNozzles.rows[i]\n        \n        if (!existingTankIds.includes(tank.id)) {\n          const nozzleNumber = i + 1\n\n          await pool.query(\n            `INSERT INTO nozzles (branch_id, dispenser_id, tank_id, nozzle_number, fuel_type, item_id, status, initial_meter_reading)\n             VALUES ($1, $2, $3, $4, $5, $6, 'active', 0)`,\n            [branch_id, dispenser_id, tank.id, nozzleNumber, tank.fuel_type, tank.item_id]\n          )\n          nozzlesCreated++\n        }\n      }\n    }\n\n    return NextResponse.json({\n      success: true,\n      message: \"Tanks assigned successfully\",\n      nozzlesCreated,\n      fuelType,\n      itemId\n    })\n\n  } catch (error: any) {\n    console.error(\"Error assigning tanks to dispenser:\", error)\n    return NextResponse.json(\n      { success: false, error: \"Failed to assign tanks\", details: error.message },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;AAC5C;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,YAAY,EAAE,QAAQ,EAAE,SAAS,EAAE,GAAG;QAE9C,IAAI,CAAC,cAAc;YACjB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,SAAS;gBAAO,OAAO;YAA2B,GACpD;gBAAE,QAAQ;YAAI;QAElB;QAEA,+CAA+C;QAC/C,MAAM,eAAe,CAAC,YAAY,EAAE,EAAE,MAAM,CAAC,CAAC,KAAY,MAAM,OAAO,OAAO,YAAY,GAAG,IAAI,OAAO;QAExG,QAAQ,GAAG,CAAC,oBAAoB;YAAE;YAAc;YAAc,YAAY;QAAS;QAEnF,MAAM,KAAK,KAAK,CAAC,uDAAuD;YAAC;SAAa;QAEtF,IAAI,YAAsB,EAAE;QAC5B,IAAI,SAAwB;QAE5B,IAAI,aAAa,MAAM,GAAG,GAAG;YAC3B,MAAM,cAAc,MAAM,KAAK,KAAK,CAClC,uEACA;gBAAC;aAAa;YAGhB,YAAY;mBAAI,IAAI,IAAI,YAAY,IAAI,CAAC,GAAG,CAAC,CAAC,IAAW,EAAE,SAAS;aAAG;YACvE,MAAM,eAAe,YAAY,IAAI,CAAC,IAAI,CAAC,CAAC,IAAW,EAAE,OAAO;YAChE,IAAI,cAAc;gBAChB,SAAS,aAAa,OAAO;YAC/B;YAEA,wDAAwD;YACxD,KAAK,MAAM,QAAQ,YAAY,IAAI,CAAE;gBACnC,MAAM,KAAK,KAAK,CACd,8FACA;oBAAC;oBAAc,KAAK,EAAE;iBAAC;YAE3B;QACF;QAEA,MAAM,WAAW,UAAU,MAAM,GAAG,IAAI,UAAU,IAAI,CAAC,OAAO;QAC9D,MAAM,gBAAgB,aAAa,MAAM,GAAG,IAAI,YAAY,CAAC,EAAE,GAAG;QAElE,MAAM,KAAK,KAAK,CACd,sGACA;YAAC;YAAU;YAAe;YAAQ;SAAa;QAGjD,MAAM,kBAAkB,MAAM,KAAK,KAAK,CAAC,yDAAyD;YAAC;SAAa;QAChH,MAAM,kBAAkB,gBAAgB,IAAI,CAAC,EAAE,EAAE,oBAAoB;QAErE,IAAI,iBAAiB;QACrB,IAAI,aAAa,MAAM,GAAG,GAAG;YAC3B,MAAM,wBAAwB,MAAM,KAAK,KAAK,CAC5C,uDACA;gBAAC;aAAa;YAEhB,MAAM,kBAAkB,sBAAsB,IAAI,CAAC,GAAG,CAAC,CAAC,IAAW,EAAE,OAAO;YAE5E,MAAM,wBAAwB,MAAM,KAAK,KAAK,CAC5C,uEACA;gBAAC;aAAa;YAGhB,IAAK,IAAI,IAAI,GAAG,IAAI,sBAAsB,IAAI,CAAC,MAAM,EAAE,IAAK;gBAC1D,MAAM,OAAO,sBAAsB,IAAI,CAAC,EAAE;gBAE1C,IAAI,CAAC,gBAAgB,QAAQ,CAAC,KAAK,EAAE,GAAG;oBACtC,MAAM,eAAe,IAAI;oBAEzB,MAAM,KAAK,KAAK,CACd,CAAC;yDAC4C,CAAC,EAC9C;wBAAC;wBAAW;wBAAc,KAAK,EAAE;wBAAE;wBAAc,KAAK,SAAS;wBAAE,KAAK,OAAO;qBAAC;oBAEhF;gBACF;YACF;QACF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,SAAS;YACT;YACA;YACA;QACF;IAEF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,uCAAuC;QACrD,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,SAAS;YAAO,OAAO;YAA0B,SAAS,MAAM,OAAO;QAAC,GAC1E;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}