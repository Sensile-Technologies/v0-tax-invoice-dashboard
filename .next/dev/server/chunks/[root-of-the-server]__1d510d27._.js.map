{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/client.ts"],"sourcesContent":["import { Pool } from 'pg';\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,\n});\n\nexport async function query<T = any>(text: string, params?: any[]): Promise<T[]> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rows as T[];\n  } finally {\n    client.release();\n  }\n}\n\nexport async function queryOne<T = any>(text: string, params?: any[]): Promise<T | null> {\n  const rows = await query<T>(text, params);\n  return rows[0] || null;\n}\n\nexport async function execute(text: string, params?: any[]): Promise<number> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rowCount || 0;\n  } finally {\n    client.release();\n  }\n}\n\nexport { pool };\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,sCAAwC,0BAAgC;AAC/E;AAEO,eAAe,MAAe,IAAY,EAAE,MAAc;IAC/D,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,IAAI;IACpB,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe,SAAkB,IAAY,EAAE,MAAc;IAClE,MAAM,OAAO,MAAM,MAAS,MAAM;IAClC,OAAO,IAAI,CAAC,EAAE,IAAI;AACpB;AAEO,eAAe,QAAQ,IAAY,EAAE,MAAc;IACxD,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,QAAQ,IAAI;IAC5B,SAAU;QACR,OAAO,OAAO;IAChB;AACF"}},
    {"offset": {"line": 108, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/index.ts"],"sourcesContent":["export * from './client';\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 122, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/headquarters/purchase-orders/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { query, pool } from \"@/lib/db\"\nimport { cookies } from \"next/headers\"\n\nasync function getUserVendorId(userId: string): Promise<string | null> {\n  const userVendor = await query(\n    `SELECT v.id FROM users u \n     JOIN vendors v ON v.email = u.email \n     WHERE u.id = $1`,\n    [userId]\n  )\n  if (userVendor && userVendor.length > 0) {\n    return userVendor[0].id\n  }\n\n  const staffVendor = await query(\n    `SELECT DISTINCT b.vendor_id FROM staff s\n     JOIN branches b ON s.branch_id = b.id\n     WHERE s.user_id = $1 AND b.vendor_id IS NOT NULL`,\n    [userId]\n  )\n  if (staffVendor && staffVendor.length > 0) {\n    return staffVendor[0].vendor_id\n  }\n\n  const branchVendor = await query(\n    `SELECT DISTINCT vendor_id FROM branches WHERE user_id = $1 AND vendor_id IS NOT NULL`,\n    [userId]\n  )\n  if (branchVendor && branchVendor.length > 0) {\n    return branchVendor[0].vendor_id\n  }\n\n  return null\n}\n\nasync function getSessionUserId(): Promise<string | null> {\n  try {\n    const cookieStore = await cookies()\n    const sessionCookie = cookieStore.get(\"user_session\")\n    if (!sessionCookie?.value) return null\n    \n    const session = JSON.parse(sessionCookie.value)\n    return session.id || null\n  } catch {\n    return null\n  }\n}\n\nasync function getNextPONumber(vendorId: string): Promise<string> {\n  const client = await pool.connect()\n  try {\n    await client.query('BEGIN')\n    \n    const result = await client.query(\n      `INSERT INTO vendor_po_sequences (vendor_id, next_po_number)\n       VALUES ($1, 2)\n       ON CONFLICT (vendor_id) \n       DO UPDATE SET next_po_number = vendor_po_sequences.next_po_number + 1\n       RETURNING next_po_number - 1 as current_number`,\n      [vendorId]\n    )\n    \n    await client.query('COMMIT')\n    \n    const poNumber = result.rows[0].current_number\n    return `PO-${String(poNumber).padStart(5, '0')}`\n  } catch (error) {\n    await client.query('ROLLBACK')\n    throw error\n  } finally {\n    client.release()\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const userId = await getSessionUserId()\n    if (!userId) {\n      return NextResponse.json({ success: false, error: \"Unauthorized\" }, { status: 401 })\n    }\n\n    const vendorId = await getUserVendorId(userId)\n    if (!vendorId) {\n      return NextResponse.json({ success: false, error: \"No vendor found for user\" }, { status: 403 })\n    }\n\n    const { searchParams } = new URL(request.url)\n    const branchId = searchParams.get(\"branch_id\")\n    const status = searchParams.get(\"status\")\n    const limit = parseInt(searchParams.get(\"limit\") || \"100\")\n\n    let sql = `\n      SELECT \n        po.*,\n        b.name as branch_name,\n        vp.name as supplier_name,\n        tp.name as transporter_name,\n        u.full_name as created_by_name,\n        au.full_name as approved_by_name,\n        (SELECT COUNT(*) FROM purchase_order_items WHERE purchase_order_id = po.id) as item_count,\n        (SELECT COALESCE(SUM(total_amount), 0) FROM purchase_order_items WHERE purchase_order_id = po.id) as total_amount\n      FROM purchase_orders po\n      LEFT JOIN branches b ON po.branch_id = b.id\n      LEFT JOIN vendor_partners vp ON po.supplier_id = vp.id\n      LEFT JOIN vendor_partners tp ON po.transporter_id = tp.id\n      LEFT JOIN users u ON po.created_by = u.id\n      LEFT JOIN users au ON po.approved_by = au.id\n      WHERE po.vendor_id = $1\n    `\n    const params: any[] = [vendorId]\n    let paramIndex = 2\n\n    if (branchId) {\n      sql += ` AND po.branch_id = $${paramIndex}`\n      params.push(branchId)\n      paramIndex++\n    }\n\n    if (status) {\n      sql += ` AND po.status = $${paramIndex}`\n      params.push(status)\n      paramIndex++\n    }\n\n    sql += ` ORDER BY po.issued_at DESC LIMIT $${paramIndex}`\n    params.push(limit)\n\n    const orders = await query(sql, params)\n\n    return NextResponse.json({ \n      success: true, \n      data: orders \n    })\n  } catch (error) {\n    console.error(\"Error fetching purchase orders:\", error)\n    return NextResponse.json({ success: false, error: \"Failed to fetch purchase orders\" }, { status: 500 })\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const userId = await getSessionUserId()\n    if (!userId) {\n      return NextResponse.json({ success: false, error: \"Unauthorized\" }, { status: 401 })\n    }\n\n    const vendorId = await getUserVendorId(userId)\n    if (!vendorId) {\n      return NextResponse.json({ success: false, error: \"No vendor found for user\" }, { status: 403 })\n    }\n\n    const body = await request.json()\n    const { \n      branch_id, \n      supplier_id, \n      transporter_id,\n      expected_delivery, \n      notes, \n      items,\n      transport_cost,\n      vehicle_registration,\n      driver_name,\n      driver_phone\n    } = body\n\n    if (!branch_id) {\n      return NextResponse.json({ success: false, error: \"Branch is required\" }, { status: 400 })\n    }\n\n    if (!supplier_id) {\n      return NextResponse.json({ success: false, error: \"Supplier is required\" }, { status: 400 })\n    }\n\n    if (!items || items.length === 0) {\n      return NextResponse.json({ success: false, error: \"At least one item is required\" }, { status: 400 })\n    }\n\n    const invalidItems = items.filter((item: any) => !item.unit_price || item.unit_price <= 0)\n    if (invalidItems.length > 0) {\n      return NextResponse.json({ success: false, error: \"Unit price is required for all items\" }, { status: 400 })\n    }\n\n    const branchCheck = await query(\n      `SELECT id FROM branches WHERE id = $1 AND vendor_id = $2`,\n      [branch_id, vendorId]\n    )\n    if (!branchCheck || branchCheck.length === 0) {\n      return NextResponse.json({ success: false, error: \"Invalid branch\" }, { status: 400 })\n    }\n\n    const supplierCheck = await query(\n      `SELECT id FROM vendor_partners WHERE id = $1 AND vendor_id = $2 AND partner_type = 'supplier'`,\n      [supplier_id, vendorId]\n    )\n    if (!supplierCheck || supplierCheck.length === 0) {\n      return NextResponse.json({ success: false, error: \"Invalid supplier\" }, { status: 400 })\n    }\n\n    if (transporter_id) {\n      const transporterCheck = await query(\n        `SELECT id FROM vendor_partners WHERE id = $1 AND vendor_id = $2 AND partner_type = 'transporter'`,\n        [transporter_id, vendorId]\n      )\n      if (!transporterCheck || transporterCheck.length === 0) {\n        return NextResponse.json({ success: false, error: \"Invalid transporter\" }, { status: 400 })\n      }\n    }\n\n    const poNumber = await getNextPONumber(vendorId)\n\n    const client = await pool.connect()\n    try {\n      await client.query('BEGIN')\n\n      const orderResult = await client.query(\n        `INSERT INTO purchase_orders (\n          vendor_id, branch_id, supplier_id, transporter_id, po_number, \n          expected_delivery, notes, created_by, transport_cost,\n          vehicle_registration, driver_name, driver_phone, approval_status\n        )\n         VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, 'pending_approval')\n         RETURNING *`,\n        [\n          vendorId, branch_id, supplier_id, transporter_id || null, poNumber, \n          expected_delivery || null, notes || null, userId, transport_cost || 0,\n          vehicle_registration || null, driver_name || null, driver_phone || null\n        ]\n      )\n\n      const order = orderResult.rows[0]\n\n      for (const item of items) {\n        await client.query(\n          `INSERT INTO purchase_order_items (purchase_order_id, item_id, item_name, quantity, unit_price, total_amount)\n           VALUES ($1, $2, $3, $4, $5, $6)`,\n          [order.id, item.item_id || null, item.item_name, item.quantity, item.unit_price || null, item.total_amount || null]\n        )\n      }\n\n      await client.query('COMMIT')\n\n      return NextResponse.json({ \n        success: true, \n        data: order,\n        message: `Purchase order ${poNumber} created successfully` \n      })\n    } catch (error) {\n      await client.query('ROLLBACK')\n      throw error\n    } finally {\n      client.release()\n    }\n  } catch (error) {\n    console.error(\"Error creating purchase order:\", error)\n    return NextResponse.json({ success: false, error: \"Failed to create purchase order\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}