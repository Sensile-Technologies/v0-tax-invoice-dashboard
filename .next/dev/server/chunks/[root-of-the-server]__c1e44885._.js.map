{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/loyalty-transactions/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const branchId = searchParams.get(\"branch_id\")\n    const page = parseInt(searchParams.get(\"page\") || \"1\")\n    const pageSize = parseInt(searchParams.get(\"pageSize\") || \"50\")\n    const offset = (page - 1) * pageSize\n\n    if (!branchId) {\n      return NextResponse.json({ success: false, error: \"branch_id is required\" }, { status: 400 })\n    }\n\n    const countResult = await pool.query(\n      \"SELECT COUNT(*) FROM loyalty_transactions WHERE branch_id = $1\",\n      [branchId]\n    )\n    const total = parseInt(countResult.rows[0].count)\n\n    // Get branch-wide aggregates for dashboard cards\n    const aggregatesResult = await pool.query(\n      `SELECT \n        COALESCE(SUM(points_earned), 0) as total_points,\n        COALESCE(SUM(transaction_amount), 0) as total_revenue,\n        COUNT(DISTINCT customer_name) as unique_customers\n       FROM loyalty_transactions WHERE branch_id = $1`,\n      [branchId]\n    )\n    const aggregates = aggregatesResult.rows[0]\n\n    const result = await pool.query(\n      \"SELECT * FROM loyalty_transactions WHERE branch_id = $1 ORDER BY transaction_date DESC LIMIT $2 OFFSET $3\",\n      [branchId, pageSize, offset]\n    )\n\n    return NextResponse.json({ \n      success: true, \n      data: result.rows,\n      aggregates: {\n        totalPoints: parseFloat(aggregates.total_points) || 0,\n        totalRevenue: parseFloat(aggregates.total_revenue) || 0,\n        uniqueCustomers: parseInt(aggregates.unique_customers) || 0\n      },\n      pagination: {\n        page,\n        pageSize,\n        total,\n        totalPages: Math.ceil(total / pageSize)\n      }\n    })\n  } catch (error) {\n    console.error(\"Error fetching loyalty transactions:\", error)\n    return NextResponse.json({ success: false, error: \"Failed to fetch loyalty transactions\" }, { status: 500 })\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const { \n      branch_id, \n      customer_name, \n      customer_pin, \n      transaction_type, \n      points_earned, \n      points_redeemed, \n      transaction_amount \n    } = body\n\n    if (!branch_id || !customer_name) {\n      return NextResponse.json({ success: false, error: \"branch_id and customer_name are required\" }, { status: 400 })\n    }\n\n    const result = await pool.query(\n      `INSERT INTO loyalty_transactions (branch_id, customer_name, customer_pin, transaction_type, points_earned, points_redeemed, transaction_amount, transaction_date)\n       VALUES ($1, $2, $3, $4, $5, $6, $7, NOW())\n       RETURNING *`,\n      [branch_id, customer_name, customer_pin, transaction_type || \"purchase\", points_earned || 0, points_redeemed || 0, transaction_amount || 0]\n    )\n\n    return NextResponse.json({ success: true, data: result.rows[0] })\n  } catch (error) {\n    console.error(\"Error creating loyalty transaction:\", error)\n    return NextResponse.json({ success: false, error: \"Failed to create loyalty transaction\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;AAC5C;AAEO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,WAAW,aAAa,GAAG,CAAC;QAClC,MAAM,OAAO,SAAS,aAAa,GAAG,CAAC,WAAW;QAClD,MAAM,WAAW,SAAS,aAAa,GAAG,CAAC,eAAe;QAC1D,MAAM,SAAS,CAAC,OAAO,CAAC,IAAI;QAE5B,IAAI,CAAC,UAAU;YACb,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAO,OAAO;YAAwB,GAAG;gBAAE,QAAQ;YAAI;QAC7F;QAEA,MAAM,cAAc,MAAM,KAAK,KAAK,CAClC,kEACA;YAAC;SAAS;QAEZ,MAAM,QAAQ,SAAS,YAAY,IAAI,CAAC,EAAE,CAAC,KAAK;QAEhD,iDAAiD;QACjD,MAAM,mBAAmB,MAAM,KAAK,KAAK,CACvC,CAAC;;;;qDAI8C,CAAC,EAChD;YAAC;SAAS;QAEZ,MAAM,aAAa,iBAAiB,IAAI,CAAC,EAAE;QAE3C,MAAM,SAAS,MAAM,KAAK,KAAK,CAC7B,6GACA;YAAC;YAAU;YAAU;SAAO;QAG9B,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,MAAM,OAAO,IAAI;YACjB,YAAY;gBACV,aAAa,WAAW,WAAW,YAAY,KAAK;gBACpD,cAAc,WAAW,WAAW,aAAa,KAAK;gBACtD,iBAAiB,SAAS,WAAW,gBAAgB,KAAK;YAC5D;YACA,YAAY;gBACV;gBACA;gBACA;gBACA,YAAY,KAAK,IAAI,CAAC,QAAQ;YAChC;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,wCAAwC;QACtD,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAO,OAAO;QAAuC,GAAG;YAAE,QAAQ;QAAI;IAC5G;AACF;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EACJ,SAAS,EACT,aAAa,EACb,YAAY,EACZ,gBAAgB,EAChB,aAAa,EACb,eAAe,EACf,kBAAkB,EACnB,GAAG;QAEJ,IAAI,CAAC,aAAa,CAAC,eAAe;YAChC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAO,OAAO;YAA2C,GAAG;gBAAE,QAAQ;YAAI;QAChH;QAEA,MAAM,SAAS,MAAM,KAAK,KAAK,CAC7B,CAAC;;kBAEW,CAAC,EACb;YAAC;YAAW;YAAe;YAAc,oBAAoB;YAAY,iBAAiB;YAAG,mBAAmB;YAAG,sBAAsB;SAAE;QAG7I,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM,MAAM,OAAO,IAAI,CAAC,EAAE;QAAC;IACjE,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,uCAAuC;QACrD,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAO,OAAO;QAAuC,GAAG;YAAE,QAAQ;QAAI;IAC5G;AACF"}}]
}