{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/auth/session/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\nimport { cookies } from \"next/headers\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nexport async function GET() {\n  try {\n    const cookieStore = await cookies()\n    const sessionCookie = cookieStore.get(\"user_session\")\n\n    if (!sessionCookie) {\n      return NextResponse.json({ error: \"Not authenticated\" }, { status: 401 })\n    }\n\n    let sessionData\n    try {\n      sessionData = JSON.parse(sessionCookie.value)\n    } catch {\n      return NextResponse.json({ error: \"Invalid session\" }, { status: 401 })\n    }\n\n    if (!sessionData.id) {\n      return NextResponse.json({ error: \"Invalid session\" }, { status: 401 })\n    }\n\n    // SECURITY: Fetch role and details from database (don't trust cookie values)\n    // For staff (including directors), get vendor_id from their branch\n    const result = await pool.query(\n      `SELECT u.id, u.email, u.username, \n       COALESCE(s.role, u.role) as role,\n       COALESCE(v.id, b.vendor_id) as vendor_id, \n       COALESCE(v.name, sv.name) as vendor_name,\n       COALESCE(s.branch_id, vb.id) as branch_id, \n       COALESCE(b.name, vb.name) as branch_name,\n       COALESCE(b.bhf_id, vb.bhf_id) as bhf_id\n       FROM users u \n       LEFT JOIN vendors v ON v.email = u.email \n       LEFT JOIN staff s ON s.user_id = u.id\n       LEFT JOIN branches b ON b.id = s.branch_id\n       LEFT JOIN vendors sv ON sv.id = b.vendor_id\n       LEFT JOIN branches vb ON vb.vendor_id = v.id AND vb.is_main = true\n       WHERE u.id = $1`,\n      [sessionData.id]\n    )\n\n    if (result.rows.length === 0) {\n      return NextResponse.json({ error: \"User not found\" }, { status: 404 })\n    }\n\n    const user = result.rows[0]\n\n    return NextResponse.json({\n      success: true,\n      user: {\n        id: user.id,\n        email: user.email,\n        username: user.username,\n        role: user.role || 'vendor',\n        vendor_id: user.vendor_id,\n        vendor_name: user.vendor_name,\n        branch_id: user.branch_id,\n        branch_name: user.branch_name,\n        bhf_id: user.bhf_id\n      }\n    })\n\n  } catch (error) {\n    console.error(\"Error fetching session:\", error)\n    return NextResponse.json({ error: \"Failed to fetch session\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;AAC5C;AAEO,eAAe;IACpB,IAAI;QACF,MAAM,cAAc,MAAM,IAAA,4IAAO;QACjC,MAAM,gBAAgB,YAAY,GAAG,CAAC;QAEtC,IAAI,CAAC,eAAe;YAClB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAoB,GAAG;gBAAE,QAAQ;YAAI;QACzE;QAEA,IAAI;QACJ,IAAI;YACF,cAAc,KAAK,KAAK,CAAC,cAAc,KAAK;QAC9C,EAAE,OAAM;YACN,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAkB,GAAG;gBAAE,QAAQ;YAAI;QACvE;QAEA,IAAI,CAAC,YAAY,EAAE,EAAE;YACnB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAkB,GAAG;gBAAE,QAAQ;YAAI;QACvE;QAEA,6EAA6E;QAC7E,mEAAmE;QACnE,MAAM,SAAS,MAAM,KAAK,KAAK,CAC7B,CAAC;;;;;;;;;;;;;sBAae,CAAC,EACjB;YAAC,YAAY,EAAE;SAAC;QAGlB,IAAI,OAAO,IAAI,CAAC,MAAM,KAAK,GAAG;YAC5B,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiB,GAAG;gBAAE,QAAQ;YAAI;QACtE;QAEA,MAAM,OAAO,OAAO,IAAI,CAAC,EAAE;QAE3B,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,MAAM;gBACJ,IAAI,KAAK,EAAE;gBACX,OAAO,KAAK,KAAK;gBACjB,UAAU,KAAK,QAAQ;gBACvB,MAAM,KAAK,IAAI,IAAI;gBACnB,WAAW,KAAK,SAAS;gBACzB,aAAa,KAAK,WAAW;gBAC7B,WAAW,KAAK,SAAS;gBACzB,aAAa,KAAK,WAAW;gBAC7B,QAAQ,KAAK,MAAM;YACrB;QACF;IAEF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,2BAA2B;QACzC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA0B,GAAG;YAAE,QAAQ;QAAI;IAC/E;AACF"}}]
}