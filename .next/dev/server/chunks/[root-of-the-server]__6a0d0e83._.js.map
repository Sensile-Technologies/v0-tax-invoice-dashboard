{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/dispensers/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const branchId = searchParams.get('branch_id')\n    const tankId = searchParams.get('tank_id')\n\n    let query = 'SELECT d.*, i.item_name, t.tank_name FROM dispensers d LEFT JOIN items i ON d.item_id = i.id LEFT JOIN tanks t ON d.tank_id = t.id WHERE 1=1'\n    const params: any[] = []\n\n    if (branchId) {\n      params.push(branchId)\n      query += ` AND d.branch_id = $${params.length}`\n    }\n\n    if (tankId) {\n      params.push(tankId)\n      query += ` AND d.tank_id = $${params.length}`\n    }\n\n    query += ' ORDER BY d.dispenser_number ASC'\n\n    const result = await pool.query(query, params)\n\n    return NextResponse.json({\n      success: true,\n      data: result.rows\n    })\n\n  } catch (error: any) {\n    console.error(\"Error fetching dispensers:\", error)\n    return NextResponse.json(\n      { error: \"Failed to fetch dispensers\", details: error.message },\n      { status: 500 }\n    )\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const { branch_id, dispenser_number, fuel_type, status, tank_id, item_id } = body\n\n    if (!branch_id || !dispenser_number) {\n      return NextResponse.json(\n        { success: false, error: \"branch_id and dispenser_number are required\" },\n        { status: 400 }\n      )\n    }\n\n    let finalItemId = item_id\n\n    if (tank_id && !item_id) {\n      const tankResult = await pool.query('SELECT item_id FROM tanks WHERE id = $1', [tank_id])\n      if (tankResult.rows.length > 0 && tankResult.rows[0].item_id) {\n        finalItemId = tankResult.rows[0].item_id\n      }\n    }\n\n    const result = await pool.query(\n      `INSERT INTO dispensers (branch_id, dispenser_number, fuel_type, status, tank_id, item_id)\n       VALUES ($1, $2, $3, $4, $5, $6)\n       RETURNING *`,\n      [branch_id, dispenser_number, fuel_type || 'Petrol', status || 'active', tank_id || null, finalItemId || null]\n    )\n\n    return NextResponse.json({\n      success: true,\n      data: result.rows[0]\n    })\n\n  } catch (error: any) {\n    console.error(\"Error creating dispenser:\", error)\n    return NextResponse.json(\n      { success: false, error: \"Failed to create dispenser\", details: error.message },\n      { status: 500 }\n    )\n  }\n}\n\nexport async function PATCH(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const { id, dispenser_number, fuel_type, status, tank_id, item_id } = body\n\n    if (!id) {\n      return NextResponse.json(\n        { success: false, error: \"Dispenser id is required\" },\n        { status: 400 }\n      )\n    }\n\n    const updates: string[] = []\n    const values: any[] = []\n    let paramIndex = 1\n\n    if (dispenser_number !== undefined) {\n      updates.push(`dispenser_number = $${paramIndex}`)\n      values.push(dispenser_number)\n      paramIndex++\n    }\n\n    if (fuel_type !== undefined) {\n      updates.push(`fuel_type = $${paramIndex}`)\n      values.push(fuel_type)\n      paramIndex++\n    }\n\n    if (status !== undefined) {\n      updates.push(`status = $${paramIndex}`)\n      values.push(status)\n      paramIndex++\n    }\n\n    if (tank_id !== undefined) {\n      updates.push(`tank_id = $${paramIndex}`)\n      values.push(tank_id || null)\n      paramIndex++\n    }\n\n    if (item_id !== undefined) {\n      updates.push(`item_id = $${paramIndex}`)\n      values.push(item_id || null)\n      paramIndex++\n    }\n\n    if (updates.length === 0) {\n      return NextResponse.json(\n        { success: false, error: \"No fields to update\" },\n        { status: 400 }\n      )\n    }\n\n    updates.push(`updated_at = NOW()`)\n    values.push(id)\n\n    const result = await pool.query(\n      `UPDATE dispensers SET ${updates.join(\", \")} WHERE id = $${paramIndex} RETURNING *`,\n      values\n    )\n\n    return NextResponse.json({\n      success: true,\n      data: result.rows[0]\n    })\n\n  } catch (error: any) {\n    console.error(\"Error updating dispenser:\", error)\n    return NextResponse.json(\n      { success: false, error: \"Failed to update dispenser\", details: error.message },\n      { status: 500 }\n    )\n  }\n}\n\nexport async function DELETE(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const id = searchParams.get('id')\n\n    if (!id) {\n      return NextResponse.json(\n        { success: false, error: \"Dispenser id is required\" },\n        { status: 400 }\n      )\n    }\n\n    await pool.query('DELETE FROM dispensers WHERE id = $1', [id])\n\n    return NextResponse.json({ success: true })\n\n  } catch (error: any) {\n    console.error(\"Error deleting dispenser:\", error)\n    return NextResponse.json(\n      { success: false, error: \"Failed to delete dispenser\", details: error.message },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":"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"}}]
}