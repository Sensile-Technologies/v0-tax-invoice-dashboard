{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/stock-report/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const branchId = searchParams.get(\"branch_id\")\n    const tankId = searchParams.get(\"tank_id\")\n    const startDate = searchParams.get(\"start_date\")\n    const endDate = searchParams.get(\"end_date\")\n\n    const tanksParams: any[] = []\n    let tankParamIndex = 1\n    let tankWhereClause = \"WHERE 1=1\"\n    \n    if (branchId) {\n      tankWhereClause += ` AND t.branch_id = $${tankParamIndex}`\n      tanksParams.push(branchId)\n      tankParamIndex++\n    }\n\n    if (tankId) {\n      tankWhereClause += ` AND t.id = $${tankParamIndex}`\n      tanksParams.push(tankId)\n      tankParamIndex++\n    }\n\n    const tanksQuery = `\n      SELECT \n        t.id as tank_id,\n        t.tank_name,\n        t.fuel_type,\n        t.capacity,\n        t.current_stock,\n        b.name as branch_name,\n        b.id as branch_id\n      FROM tanks t\n      LEFT JOIN branches b ON t.branch_id = b.id\n      ${tankWhereClause}\n      ORDER BY b.name, t.tank_name\n    `\n\n    const tanksResult = await pool.query(tanksQuery, tanksParams)\n\n    const summaryWithTotals = await Promise.all(\n      tanksResult.rows.map(async (tank) => {\n        const aggParams: any[] = [tank.tank_id]\n        let aggParamIndex = 2\n        let dateFilter = \"\"\n\n        if (startDate) {\n          dateFilter += ` AND created_at >= $${aggParamIndex}`\n          aggParams.push(startDate)\n          aggParamIndex++\n        }\n        if (endDate) {\n          dateFilter += ` AND created_at <= $${aggParamIndex}`\n          aggParams.push(endDate + 'T23:59:59')\n          aggParamIndex++\n        }\n\n        const aggQuery = `\n          SELECT \n            COALESCE(SUM(CASE WHEN adjustment_type IN ('receive', 'stock_receive', 'addition') THEN quantity ELSE 0 END), 0) as total_received,\n            COALESCE(SUM(CASE WHEN adjustment_type IN ('manual_adjustment', 'increase') AND quantity > 0 THEN quantity ELSE 0 END), 0) as total_adjusted_in,\n            COALESCE(SUM(CASE WHEN adjustment_type IN ('manual_adjustment', 'decrease') OR (adjustment_type = 'increase' AND quantity < 0) THEN ABS(quantity) ELSE 0 END), 0) as total_adjusted_out,\n            COALESCE(SUM(CASE WHEN adjustment_type IN ('sale', 'deduction') THEN ABS(quantity) ELSE 0 END), 0) as total_sold,\n            COALESCE(SUM(CASE WHEN adjustment_type IN ('transfer_out', 'transfer') THEN ABS(quantity) ELSE 0 END), 0) as total_transferred_out,\n            COALESCE(SUM(CASE WHEN adjustment_type = 'transfer_in' THEN quantity ELSE 0 END), 0) as total_transferred_in,\n            COUNT(*) as movement_count\n          FROM stock_adjustments\n          WHERE tank_id = $1 ${dateFilter}\n        `\n\n        const aggResult = await pool.query(aggQuery, aggParams)\n        const agg = aggResult.rows[0] || {}\n\n        return {\n          ...tank,\n          total_received: parseFloat(agg.total_received || 0),\n          total_adjusted_in: parseFloat(agg.total_adjusted_in || 0),\n          total_adjusted_out: parseFloat(agg.total_adjusted_out || 0),\n          total_sold: parseFloat(agg.total_sold || 0),\n          total_transferred_out: parseFloat(agg.total_transferred_out || 0),\n          total_transferred_in: parseFloat(agg.total_transferred_in || 0),\n          movement_count: parseInt(agg.movement_count || 0),\n        }\n      })\n    )\n\n    const movementsParams: any[] = []\n    let movementParamIndex = 1\n    let movementWhereClause = \"WHERE 1=1\"\n\n    if (branchId) {\n      movementWhereClause += ` AND sa.branch_id = $${movementParamIndex}`\n      movementsParams.push(branchId)\n      movementParamIndex++\n    }\n\n    if (tankId) {\n      movementWhereClause += ` AND sa.tank_id = $${movementParamIndex}`\n      movementsParams.push(tankId)\n      movementParamIndex++\n    }\n\n    if (startDate) {\n      movementWhereClause += ` AND sa.created_at >= $${movementParamIndex}`\n      movementsParams.push(startDate)\n      movementParamIndex++\n    }\n\n    if (endDate) {\n      movementWhereClause += ` AND sa.created_at <= $${movementParamIndex}`\n      movementsParams.push(endDate + 'T23:59:59')\n      movementParamIndex++\n    }\n\n    const movementsQuery = `\n      SELECT \n        sa.id,\n        sa.tank_id,\n        t.tank_name,\n        t.fuel_type,\n        b.name as branch_name,\n        sa.adjustment_type,\n        sa.quantity,\n        sa.previous_stock,\n        sa.new_stock,\n        sa.reason,\n        sa.requested_by,\n        sa.approval_status,\n        sa.created_at\n      FROM stock_adjustments sa\n      LEFT JOIN tanks t ON sa.tank_id = t.id\n      LEFT JOIN branches b ON sa.branch_id = b.id\n      ${movementWhereClause}\n      ORDER BY sa.created_at DESC\n      LIMIT 100\n    `\n\n    const movementsResult = await pool.query(movementsQuery, movementsParams)\n\n    const totals = summaryWithTotals.reduce((acc, row) => ({\n      total_received: acc.total_received + row.total_received,\n      total_adjusted_in: acc.total_adjusted_in + row.total_adjusted_in,\n      total_adjusted_out: acc.total_adjusted_out + row.total_adjusted_out,\n      total_sold: acc.total_sold + row.total_sold,\n      total_transferred_out: acc.total_transferred_out + row.total_transferred_out,\n      total_transferred_in: acc.total_transferred_in + row.total_transferred_in,\n      current_stock: acc.current_stock + parseFloat(row.current_stock || 0),\n      capacity: acc.capacity + parseFloat(row.capacity || 0),\n    }), {\n      total_received: 0,\n      total_adjusted_in: 0,\n      total_adjusted_out: 0,\n      total_sold: 0,\n      total_transferred_out: 0,\n      total_transferred_in: 0,\n      current_stock: 0,\n      capacity: 0,\n    })\n\n    return NextResponse.json({\n      success: true,\n      data: {\n        summary: summaryWithTotals,\n        movements: movementsResult.rows,\n        totals\n      }\n    })\n  } catch (error) {\n    console.error(\"Error fetching stock report:\", error)\n    return NextResponse.json({ success: false, error: \"Failed to fetch stock report\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}