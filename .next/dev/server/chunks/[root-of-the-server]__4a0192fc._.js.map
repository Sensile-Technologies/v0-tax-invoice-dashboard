{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/branches/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\nimport { cookies } from \"next/headers\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nasync function getSession() {\n  const cookieStore = await cookies()\n  const sessionCookie = cookieStore.get(\"user_session\")\n  if (!sessionCookie) return null\n  try {\n    return JSON.parse(sessionCookie.value)\n  } catch {\n    return null\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const status = searchParams.get(\"status\")\n    const limit = searchParams.get(\"limit\")\n    const vendorIdParam = searchParams.get(\"vendor_id\")\n\n    let vendorId = vendorIdParam\n\n    // If no vendor_id provided, scope to user's vendor from session\n    if (!vendorId) {\n      const session = await getSession()\n      if (session?.id) {\n        // Get vendor_id from user's vendor or staff assignment\n        const userResult = await pool.query(\n          `SELECT v.id as vendor_id FROM users u\n           LEFT JOIN vendors v ON v.email = u.email\n           WHERE u.id = $1`,\n          [session.id]\n        )\n        if (userResult.rows[0]?.vendor_id) {\n          vendorId = userResult.rows[0].vendor_id\n        } else {\n          // Check staff assignment\n          const staffResult = await pool.query(\n            `SELECT b.vendor_id FROM staff s\n             JOIN branches b ON s.branch_id = b.id\n             WHERE s.user_id = $1 LIMIT 1`,\n            [session.id]\n          )\n          if (staffResult.rows[0]?.vendor_id) {\n            vendorId = staffResult.rows[0].vendor_id\n          }\n        }\n      }\n    }\n\n    let query = \"SELECT * FROM branches WHERE 1=1\"\n    const params: any[] = []\n    let paramIndex = 1\n\n    // Scope to vendor if found\n    if (vendorId) {\n      query += ` AND vendor_id = $${paramIndex}`\n      params.push(vendorId)\n      paramIndex++\n    }\n\n    if (status) {\n      query += ` AND status = $${paramIndex}`\n      params.push(status)\n      paramIndex++\n    }\n\n    query += \" ORDER BY name\"\n\n    if (limit) {\n      query += ` LIMIT $${paramIndex}`\n      params.push(parseInt(limit))\n    }\n\n    const result = await pool.query(query, params)\n\n    return NextResponse.json({ success: true, data: result.rows })\n  } catch (error) {\n    console.error(\"Error fetching branches:\", error)\n    return NextResponse.json({ success: false, error: \"Failed to fetch branches\" }, { status: 500 })\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  console.log(\"[branches/POST] Starting branch creation request\")\n  \n  let body: any\n  try {\n    body = await request.json()\n    console.log(\"[branches/POST] Request body parsed successfully, name:\", body?.name)\n  } catch (parseError: any) {\n    console.error(\"[branches/POST] Failed to parse request body:\", parseError.message)\n    return NextResponse.json(\n      { success: false, error: \"Invalid request body - could not parse JSON\" },\n      { status: 400 }\n    )\n  }\n\n  try {\n    const {\n      vendor_id,\n      user_id,\n      name,\n      location,\n      address,\n      county,\n      local_tax_office,\n      manager,\n      phone,\n      email,\n      kra_pin,\n      bhf_id,\n      storage_indices,\n      controller_id,\n      status = \"pending_onboarding\"\n    } = body\n\n    if (!name) {\n      console.log(\"[branches/POST] Missing branch name\")\n      return NextResponse.json(\n        { success: false, error: \"Branch name is required\" },\n        { status: 400 }\n      )\n    }\n\n    let resolvedVendorId = vendor_id\n    console.log(\"[branches/POST] Initial vendor_id:\", vendor_id, \"user_id:\", user_id)\n\n    if (!resolvedVendorId && user_id) {\n      console.log(\"[branches/POST] Looking up vendor_id from existing branches for user:\", user_id)\n      const userBranch = await pool.query(\n        'SELECT b.vendor_id FROM branches b WHERE b.user_id = $1 AND b.vendor_id IS NOT NULL LIMIT 1',\n        [user_id]\n      )\n      if (userBranch.rows.length > 0) {\n        resolvedVendorId = userBranch.rows[0].vendor_id\n        console.log(\"[branches/POST] Found vendor_id from existing branch:\", resolvedVendorId)\n      } else {\n        console.log(\"[branches/POST] No existing branches found for user\")\n      }\n    }\n\n    if (!resolvedVendorId && user_id) {\n      console.log(\"[branches/POST] Looking up vendor by user email\")\n      const userResult = await pool.query('SELECT email FROM users WHERE id = $1', [user_id])\n      if (userResult.rows.length > 0) {\n        const userEmail = userResult.rows[0].email\n        console.log(\"[branches/POST] User email found:\", userEmail)\n        const vendorResult = await pool.query('SELECT id FROM vendors WHERE email = $1', [userEmail])\n        if (vendorResult.rows.length > 0) {\n          resolvedVendorId = vendorResult.rows[0].id\n          console.log(\"[branches/POST] Found vendor_id from email match:\", resolvedVendorId)\n        } else {\n          console.log(\"[branches/POST] No vendor found with matching email\")\n        }\n      } else {\n        console.log(\"[branches/POST] User not found in database\")\n      }\n    }\n\n    if (!resolvedVendorId) {\n      console.log(\"[branches/POST] Could not resolve vendor_id - returning error\")\n      return NextResponse.json(\n        { success: false, error: \"Could not find vendor for this user. Please ensure your account is properly set up with a vendor.\" },\n        { status: 400 }\n      )\n    }\n\n    console.log(\"[branches/POST] Inserting branch with vendor_id:\", resolvedVendorId)\n    const result = await pool.query(\n      `INSERT INTO branches (\n        vendor_id, name, location, address, county, local_tax_office, manager,\n        phone, email, kra_pin, bhf_id, storage_indices, controller_id, status, created_at, updated_at\n      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, NOW(), NOW())\n      RETURNING *`,\n      [\n        resolvedVendorId,\n        name,\n        location || null,\n        address || null,\n        county || null,\n        local_tax_office || null,\n        manager || null,\n        phone || null,\n        email || null,\n        kra_pin || null,\n        bhf_id || '00',\n        storage_indices ? JSON.stringify(storage_indices) : null,\n        controller_id || null,\n        status\n      ]\n    )\n\n    console.log(\"[branches/POST] Branch created successfully:\", result.rows[0]?.id)\n    return NextResponse.json({ success: true, data: result.rows[0] })\n  } catch (error: any) {\n    console.error(\"[branches/POST] Error creating branch:\", error.message, error.stack)\n    return NextResponse.json(\n      { success: false, error: error.message || \"Failed to create branch\" },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":"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"}}]
}