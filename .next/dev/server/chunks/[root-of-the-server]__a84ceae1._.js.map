{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/branches/register-backend/route.ts"],"sourcesContent":["import { type NextRequest, NextResponse } from \"next/server\"\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const { branchId, name, location, county, address, organization } = body\n\n    console.log(\"[v0] Attempting backend registration with data:\", {\n      name,\n      location,\n      county,\n      address,\n    })\n\n    const authToken =\n      \"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzYxMDY3NjgyLCJpYXQiOjE3NjEwNjQwODIsImp0aSI6ImZiMTA2ZDI2YmIwMDQxNTU5NjU0NWViY2U0ZDhkNjgwIiwidXNlcl9pZCI6IjQifQ.uUI2bDV8WA00a9_CIr5DPf7njaO929MZnYbpqIhi3IY\"\n\n    const controller = new AbortController()\n    const timeoutId = setTimeout(() => controller.abort(), 10000) // 10 second timeout\n\n    try {\n      const backendResponse = await fetch(\n        \"https://flow-360-backend-x6wvex-0ad73a-147-93-155-29.traefik.me/station/create/\",\n        {\n          method: \"POST\",\n          headers: {\n            \"Content-Type\": \"application/json\",\n            Authorization: `Bearer ${authToken}`,\n          },\n          body: JSON.stringify({\n            city: location,\n            county: county || location,\n            created_at: new Date().toISOString(),\n            id: branchId,\n            is_active: true,\n            location: address || location,\n            name: name,\n            organization: organization || \"35c7be82-cc63-4e9d-ac34-a79bc2d7633b\",\n          }),\n          signal: controller.signal,\n        },\n      )\n\n      clearTimeout(timeoutId)\n\n      console.log(\"[v0] Backend response status:\", backendResponse.status)\n\n      const contentType = backendResponse.headers.get(\"content-type\")\n      let responseData: any\n\n      if (contentType?.includes(\"application/json\")) {\n        responseData = await backendResponse.json()\n      } else {\n        responseData = await backendResponse.text()\n      }\n\n      console.log(\"[v0] Backend response data:\", responseData)\n\n      if (!backendResponse.ok || (typeof responseData === \"string\" && responseData.toLowerCase().includes(\"invalid\"))) {\n        console.error(\"[Backend API Error]:\", responseData)\n        return NextResponse.json(\n          {\n            success: false,\n            error: \"Backend registration failed\",\n            details: typeof responseData === \"string\" ? responseData : JSON.stringify(responseData),\n            status: backendResponse.status,\n          },\n          { status: backendResponse.ok ? 400 : backendResponse.status },\n        )\n      }\n\n      return NextResponse.json({ success: true, data: responseData })\n    } catch (fetchError: any) {\n      clearTimeout(timeoutId)\n\n      let errorMessage = \"Network error\"\n      if (fetchError.name === \"AbortError\") {\n        errorMessage = \"Request timed out after 10 seconds\"\n      } else if (fetchError.message?.includes(\"certificate\")) {\n        errorMessage = \"SSL certificate validation failed\"\n      } else if (fetchError.message?.includes(\"ENOTFOUND\") || fetchError.message?.includes(\"getaddrinfo\")) {\n        errorMessage = \"Backend server not reachable (DNS lookup failed)\"\n      } else if (fetchError.message?.includes(\"ECONNREFUSED\")) {\n        errorMessage = \"Backend server refused connection\"\n      }\n\n      console.error(\"[Backend API Network Error]:\", errorMessage, fetchError)\n\n      return NextResponse.json(\n        {\n          success: false,\n          error: errorMessage,\n          details: fetchError.message || String(fetchError),\n          suggestion: \"Branch created locally. Backend registration can be retried later.\",\n        },\n        { status: 503 }, // Service Unavailable\n      )\n    }\n  } catch (error) {\n    console.error(\"[Backend API Exception]:\", error)\n    return NextResponse.json(\n      {\n        success: false,\n        error: \"Failed to process backend registration\",\n        details: String(error),\n      },\n      { status: 500 },\n    )\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,QAAQ,EAAE,IAAI,EAAE,QAAQ,EAAE,MAAM,EAAE,OAAO,EAAE,YAAY,EAAE,GAAG;QAEpE,QAAQ,GAAG,CAAC,mDAAmD;YAC7D;YACA;YACA;YACA;QACF;QAEA,MAAM,YACJ;QAEF,MAAM,aAAa,IAAI;QACvB,MAAM,YAAY,WAAW,IAAM,WAAW,KAAK,IAAI,OAAO,oBAAoB;;QAElF,IAAI;YACF,MAAM,kBAAkB,MAAM,MAC5B,mFACA;gBACE,QAAQ;gBACR,SAAS;oBACP,gBAAgB;oBAChB,eAAe,CAAC,OAAO,EAAE,WAAW;gBACtC;gBACA,MAAM,KAAK,SAAS,CAAC;oBACnB,MAAM;oBACN,QAAQ,UAAU;oBAClB,YAAY,IAAI,OAAO,WAAW;oBAClC,IAAI;oBACJ,WAAW;oBACX,UAAU,WAAW;oBACrB,MAAM;oBACN,cAAc,gBAAgB;gBAChC;gBACA,QAAQ,WAAW,MAAM;YAC3B;YAGF,aAAa;YAEb,QAAQ,GAAG,CAAC,iCAAiC,gBAAgB,MAAM;YAEnE,MAAM,cAAc,gBAAgB,OAAO,CAAC,GAAG,CAAC;YAChD,IAAI;YAEJ,IAAI,aAAa,SAAS,qBAAqB;gBAC7C,eAAe,MAAM,gBAAgB,IAAI;YAC3C,OAAO;gBACL,eAAe,MAAM,gBAAgB,IAAI;YAC3C;YAEA,QAAQ,GAAG,CAAC,+BAA+B;YAE3C,IAAI,CAAC,gBAAgB,EAAE,IAAK,OAAO,iBAAiB,YAAY,aAAa,WAAW,GAAG,QAAQ,CAAC,YAAa;gBAC/G,QAAQ,KAAK,CAAC,wBAAwB;gBACtC,OAAO,gJAAY,CAAC,IAAI,CACtB;oBACE,SAAS;oBACT,OAAO;oBACP,SAAS,OAAO,iBAAiB,WAAW,eAAe,KAAK,SAAS,CAAC;oBAC1E,QAAQ,gBAAgB,MAAM;gBAChC,GACA;oBAAE,QAAQ,gBAAgB,EAAE,GAAG,MAAM,gBAAgB,MAAM;gBAAC;YAEhE;YAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAM,MAAM;YAAa;QAC/D,EAAE,OAAO,YAAiB;YACxB,aAAa;YAEb,IAAI,eAAe;YACnB,IAAI,WAAW,IAAI,KAAK,cAAc;gBACpC,eAAe;YACjB,OAAO,IAAI,WAAW,OAAO,EAAE,SAAS,gBAAgB;gBACtD,eAAe;YACjB,OAAO,IAAI,WAAW,OAAO,EAAE,SAAS,gBAAgB,WAAW,OAAO,EAAE,SAAS,gBAAgB;gBACnG,eAAe;YACjB,OAAO,IAAI,WAAW,OAAO,EAAE,SAAS,iBAAiB;gBACvD,eAAe;YACjB;YAEA,QAAQ,KAAK,CAAC,gCAAgC,cAAc;YAE5D,OAAO,gJAAY,CAAC,IAAI,CACtB;gBACE,SAAS;gBACT,OAAO;gBACP,SAAS,WAAW,OAAO,IAAI,OAAO;gBACtC,YAAY;YACd,GACA;gBAAE,QAAQ;YAAI;QAElB;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,OAAO,gJAAY,CAAC,IAAI,CACtB;YACE,SAAS;YACT,OAAO;YACP,SAAS,OAAO;QAClB,GACA;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}