{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/client.ts"],"sourcesContent":["import { Pool } from 'pg';\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,\n});\n\nexport async function query<T = any>(text: string, params?: any[]): Promise<T[]> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rows as T[];\n  } finally {\n    client.release();\n  }\n}\n\nexport async function queryOne<T = any>(text: string, params?: any[]): Promise<T | null> {\n  const rows = await query<T>(text, params);\n  return rows[0] || null;\n}\n\nexport async function execute(text: string, params?: any[]): Promise<number> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rowCount || 0;\n  } finally {\n    client.release();\n  }\n}\n\nexport { pool };\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,sCAAwC,0BAAgC;AAC/E;AAEO,eAAe,MAAe,IAAY,EAAE,MAAc;IAC/D,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,IAAI;IACpB,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe,SAAkB,IAAY,EAAE,MAAc;IAClE,MAAM,OAAO,MAAM,MAAS,MAAM;IAClC,OAAO,IAAI,CAAC,EAAE,IAAI;AACpB;AAEO,eAAe,QAAQ,IAAY,EAAE,MAAc;IACxD,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,QAAQ,IAAI;IAC5B,SAAU;QACR,OAAO,OAAO;IAChB;AACF"}},
    {"offset": {"line": 108, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/index.ts"],"sourcesContent":["export * from './client';\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 122, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/supabase/server.ts"],"sourcesContent":["import { query, queryOne, execute } from '../db/client';\n\ninterface QueryResult<T = any> {\n  data: T | null;\n  error: { message: string } | null;\n}\n\ninterface QueryBuilder extends PromiseLike<QueryResult> {\n  select: (columns?: string) => QueryBuilder;\n  insert: (data: any | any[]) => Promise<QueryResult>;\n  update: (data: any) => Promise<QueryResult>;\n  delete: () => Promise<QueryResult>;\n  upsert: (data: any | any[], options?: { onConflict?: string }) => Promise<QueryResult>;\n  eq: (column: string, value: any) => QueryBuilder;\n  neq: (column: string, value: any) => QueryBuilder;\n  gt: (column: string, value: any) => QueryBuilder;\n  gte: (column: string, value: any) => QueryBuilder;\n  lt: (column: string, value: any) => QueryBuilder;\n  lte: (column: string, value: any) => QueryBuilder;\n  like: (column: string, value: any) => QueryBuilder;\n  ilike: (column: string, value: any) => QueryBuilder;\n  is: (column: string, value: any) => QueryBuilder;\n  in: (column: string, values: any[]) => QueryBuilder;\n  order: (column: string, options?: { ascending?: boolean }) => QueryBuilder;\n  limit: (count: number) => QueryBuilder;\n  single: () => QueryBuilder;\n  maybeSingle: () => QueryBuilder;\n}\n\nexport async function createClient() {\n  return {\n    from: (table: string): QueryBuilder => createQueryBuilder(table),\n    auth: createAuthClient(),\n  };\n}\n\nfunction createQueryBuilder(table: string): QueryBuilder {\n  let selectColumns = '*';\n  let whereConditions: { column: string; operator: string; value: any }[] = [];\n  let orderByColumn: string | null = null;\n  let orderDirection: 'asc' | 'desc' = 'asc';\n  let limitCount: number | null = null;\n  let singleResult = false;\n\n  const builder = {\n    select: (columns = '*') => {\n      selectColumns = columns;\n      return builder;\n    },\n    insert: async (data: any | any[]) => {\n      const rows = Array.isArray(data) ? data : [data];\n      if (rows.length === 0) return { data: [], error: null };\n      \n      const columns = Object.keys(rows[0]);\n      const values = rows.map((row, i) => \n        `(${columns.map((_, j) => `$${i * columns.length + j + 1}`).join(', ')})`\n      ).join(', ');\n      const params = rows.flatMap(row => columns.map(col => row[col]));\n      \n      try {\n        const sql = `INSERT INTO ${table} (${columns.join(', ')}) VALUES ${values} RETURNING *`;\n        const result = await query(sql, params);\n        return { data: result, error: null };\n      } catch (error: any) {\n        return { data: null, error: { message: error.message } };\n      }\n    },\n    update: async (data: any) => {\n      const columns = Object.keys(data);\n      const setClause = columns.map((col, i) => `${col} = $${i + 1}`).join(', ');\n      const params = columns.map(col => data[col]);\n      \n      let sql = `UPDATE ${table} SET ${setClause}`;\n      let paramIndex = params.length;\n      \n      if (whereConditions.length > 0) {\n        const whereClauses = whereConditions.map((cond, i) => {\n          paramIndex++;\n          return `${cond.column} ${cond.operator} $${paramIndex}`;\n        });\n        sql += ` WHERE ${whereClauses.join(' AND ')}`;\n        params.push(...whereConditions.map(c => c.value));\n      }\n      \n      sql += ' RETURNING *';\n      \n      try {\n        const result = await query(sql, params);\n        return { data: result, error: null };\n      } catch (error: any) {\n        return { data: null, error: { message: error.message } };\n      }\n    },\n    delete: async () => {\n      let sql = `DELETE FROM ${table}`;\n      const params: any[] = [];\n      \n      if (whereConditions.length > 0) {\n        const whereClauses = whereConditions.map((cond, i) => {\n          return `${cond.column} ${cond.operator} $${i + 1}`;\n        });\n        sql += ` WHERE ${whereClauses.join(' AND ')}`;\n        params.push(...whereConditions.map(c => c.value));\n      }\n      \n      sql += ' RETURNING *';\n      \n      try {\n        const result = await query(sql, params);\n        return { data: result, error: null };\n      } catch (error: any) {\n        return { data: null, error: { message: error.message } };\n      }\n    },\n    upsert: async (data: any | any[], options?: { onConflict?: string }) => {\n      const rows = Array.isArray(data) ? data : [data];\n      if (rows.length === 0) return { data: [], error: null };\n      \n      const columns = Object.keys(rows[0]);\n      const values = rows.map((row, i) => \n        `(${columns.map((_, j) => `$${i * columns.length + j + 1}`).join(', ')})`\n      ).join(', ');\n      const params = rows.flatMap(row => columns.map(col => row[col]));\n      \n      const conflictColumns = options?.onConflict || 'id';\n      const updateColumns = columns.filter(c => !conflictColumns.split(',').includes(c));\n      const updateClause = updateColumns.map(c => `${c} = EXCLUDED.${c}`).join(', ');\n      \n      try {\n        let sql = `INSERT INTO ${table} (${columns.join(', ')}) VALUES ${values}`;\n        if (updateClause) {\n          sql += ` ON CONFLICT (${conflictColumns}) DO UPDATE SET ${updateClause}`;\n        } else {\n          sql += ` ON CONFLICT (${conflictColumns}) DO NOTHING`;\n        }\n        sql += ' RETURNING *';\n        const result = await query(sql, params);\n        return { data: result, error: null };\n      } catch (error: any) {\n        return { data: null, error: { message: error.message } };\n      }\n    },\n    eq: (column: string, value: any) => {\n      whereConditions.push({ column, operator: '=', value });\n      return builder;\n    },\n    neq: (column: string, value: any) => {\n      whereConditions.push({ column, operator: '!=', value });\n      return builder;\n    },\n    gt: (column: string, value: any) => {\n      whereConditions.push({ column, operator: '>', value });\n      return builder;\n    },\n    gte: (column: string, value: any) => {\n      whereConditions.push({ column, operator: '>=', value });\n      return builder;\n    },\n    lt: (column: string, value: any) => {\n      whereConditions.push({ column, operator: '<', value });\n      return builder;\n    },\n    lte: (column: string, value: any) => {\n      whereConditions.push({ column, operator: '<=', value });\n      return builder;\n    },\n    like: (column: string, value: any) => {\n      whereConditions.push({ column, operator: 'LIKE', value });\n      return builder;\n    },\n    ilike: (column: string, value: any) => {\n      whereConditions.push({ column, operator: 'ILIKE', value });\n      return builder;\n    },\n    is: (column: string, value: any) => {\n      whereConditions.push({ column, operator: 'IS', value });\n      return builder;\n    },\n    in: (column: string, values: any[]) => {\n      whereConditions.push({ column, operator: 'IN', value: values });\n      return builder;\n    },\n    order: (column: string, options?: { ascending?: boolean }) => {\n      orderByColumn = column;\n      orderDirection = options?.ascending === false ? 'desc' : 'asc';\n      return builder;\n    },\n    limit: (count: number) => {\n      limitCount = count;\n      return builder;\n    },\n    single: () => {\n      singleResult = true;\n      limitCount = 1;\n      return builder;\n    },\n    maybeSingle: () => {\n      singleResult = true;\n      limitCount = 1;\n      return builder;\n    },\n    then: async (resolve: any, reject?: any) => {\n      try {\n        let sql = `SELECT ${selectColumns} FROM ${table}`;\n        const params: any[] = [];\n        let paramIndex = 0;\n        \n        if (whereConditions.length > 0) {\n          const whereClauses = whereConditions.map(cond => {\n            if (cond.operator === 'IN') {\n              const placeholders = cond.value.map(() => `$${++paramIndex}`).join(', ');\n              params.push(...cond.value);\n              return `${cond.column} IN (${placeholders})`;\n            } else if (cond.operator === 'IS') {\n              return `${cond.column} IS ${cond.value}`;\n            } else {\n              paramIndex++;\n              params.push(cond.value);\n              return `${cond.column} ${cond.operator} $${paramIndex}`;\n            }\n          });\n          sql += ` WHERE ${whereClauses.join(' AND ')}`;\n        }\n        \n        if (orderByColumn) {\n          sql += ` ORDER BY ${orderByColumn} ${orderDirection.toUpperCase()}`;\n        }\n        \n        if (limitCount !== null) {\n          sql += ` LIMIT ${limitCount}`;\n        }\n        \n        const result = await query(sql, params);\n        const data = singleResult ? (result[0] || null) : result;\n        resolve({ data, error: null });\n      } catch (error: any) {\n        if (reject) {\n          reject(error);\n        } else {\n          resolve({ data: null, error: { message: error.message } });\n        }\n      }\n    },\n  };\n  \n  return builder as QueryBuilder;\n}\n\nfunction createAuthClient() {\n  return {\n    getUser: async () => {\n      return { data: { user: null }, error: null };\n    },\n    getSession: async () => {\n      return { data: { session: null }, error: null };\n    },\n    signInWithPassword: async (credentials: { email: string; password: string }) => {\n      return { data: { user: null, session: null }, error: { message: 'Local auth not implemented' } };\n    },\n    signUp: async (credentials: { email: string; password: string }) => {\n      return { data: { user: null, session: null }, error: { message: 'Local auth not implemented' } };\n    },\n    signOut: async () => {\n      return { error: null };\n    },\n    onAuthStateChange: (callback: any) => {\n      return { data: { subscription: { unsubscribe: () => {} } } };\n    },\n  };\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 480, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/api-logger.ts"],"sourcesContent":["import { createClient } from \"@/lib/supabase/server\"\n\nexport interface ApiLogEntry {\n  endpoint: string\n  method: string\n  payload?: any\n  response?: any\n  statusCode?: number\n  error?: string\n  durationMs?: number\n  branchId?: string\n  externalEndpoint?: string\n}\n\nexport async function logApiCall(entry: ApiLogEntry) {\n  try {\n    const supabase = await createClient()\n\n    await supabase.from(\"api_logs\").insert({\n      endpoint: entry.endpoint,\n      method: entry.method,\n      payload: entry.payload || null,\n      response: entry.response || null,\n      status_code: entry.statusCode || null,\n      error: entry.error || null,\n      duration_ms: entry.durationMs || null,\n      branch_id: entry.branchId || null,\n      user_agent: entry.externalEndpoint || null,\n    })\n  } catch (error) {\n    console.error(\"[v0] Failed to log API call:\", error)\n  }\n}\n\nexport function createApiLogger(endpoint: string, method = \"POST\") {\n  const startTime = Date.now()\n\n  return {\n    success: async (payload: any, response: any, branchId?: string, externalEndpoint?: string) => {\n      const duration = Date.now() - startTime\n      await logApiCall({\n        endpoint,\n        method,\n        payload,\n        response,\n        statusCode: 200,\n        durationMs: duration,\n        branchId,\n        externalEndpoint,\n      })\n    },\n    error: async (payload: any, error: any, statusCode = 500, branchId?: string, externalEndpoint?: string) => {\n      const duration = Date.now() - startTime\n      await logApiCall({\n        endpoint,\n        method,\n        payload,\n        error: error?.message || String(error),\n        statusCode,\n        durationMs: duration,\n        branchId,\n        externalEndpoint,\n      })\n    },\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;;;;;;AAcO,eAAe,WAAW,KAAkB;IACjD,IAAI;QACF,MAAM,WAAW,MAAM,IAAA,2IAAY;QAEnC,MAAM,SAAS,IAAI,CAAC,YAAY,MAAM,CAAC;YACrC,UAAU,MAAM,QAAQ;YACxB,QAAQ,MAAM,MAAM;YACpB,SAAS,MAAM,OAAO,IAAI;YAC1B,UAAU,MAAM,QAAQ,IAAI;YAC5B,aAAa,MAAM,UAAU,IAAI;YACjC,OAAO,MAAM,KAAK,IAAI;YACtB,aAAa,MAAM,UAAU,IAAI;YACjC,WAAW,MAAM,QAAQ,IAAI;YAC7B,YAAY,MAAM,gBAAgB,IAAI;QACxC;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gCAAgC;IAChD;AACF;AAEO,SAAS,gBAAgB,QAAgB,EAAE,SAAS,MAAM;IAC/D,MAAM,YAAY,KAAK,GAAG;IAE1B,OAAO;QACL,SAAS,OAAO,SAAc,UAAe,UAAmB;YAC9D,MAAM,WAAW,KAAK,GAAG,KAAK;YAC9B,MAAM,WAAW;gBACf;gBACA;gBACA;gBACA;gBACA,YAAY;gBACZ,YAAY;gBACZ;gBACA;YACF;QACF;QACA,OAAO,OAAO,SAAc,OAAY,aAAa,GAAG,EAAE,UAAmB;YAC3E,MAAM,WAAW,KAAK,GAAG,KAAK;YAC9B,MAAM,WAAW;gBACf;gBACA;gBACA;gBACA,OAAO,OAAO,WAAW,OAAO;gBAChC;gBACA,YAAY;gBACZ;gBACA;YACF;QACF;IACF;AACF"}},
    {"offset": {"line": 548, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/kra-sales-api.ts"],"sourcesContent":["import { query } from \"@/lib/db\"\nimport { logApiCall } from \"@/lib/api-logger\"\n\nconst KRA_BASE_URL = \"http://20.224.40.56:8088\"\n\ninterface KraSaleData {\n  branch_id: string\n  invoice_number: string\n  receipt_number: string\n  fuel_type: string\n  quantity: number\n  unit_price: number\n  total_amount: number\n  payment_method: string\n  customer_name?: string\n  customer_pin?: string\n  sale_date: string\n  tank_id?: string\n}\n\ninterface KraResponse {\n  resultCd: string\n  resultMsg: string\n  resultDt: string\n  data?: any\n}\n\ninterface BranchConfig {\n  id: string\n  bhf_id: string\n  kra_pin: string\n  tin: string\n  device_token: string\n  server_address: string\n  server_port: string\n  invc_no: number\n}\n\nconst PAYMENT_TYPE_CODES: Record<string, string> = {\n  'cash': '01',\n  'credit': '02', \n  'mobile_money': '03',\n  'mpesa': '03',\n  'bank_transfer': '04',\n  'card': '05',\n  'cheque': '06',\n  'other': '07'\n}\n\nasync function getBranchConfig(branchId: string): Promise<BranchConfig | null> {\n  try {\n    const result = await query(`\n      SELECT id, bhf_id, kra_pin, tin, device_token, server_address, server_port, COALESCE(invc_no, 0) as invc_no\n      FROM branches\n      WHERE id = $1\n    `, [branchId])\n\n    if (result.length === 0) {\n      return null\n    }\n\n    return result[0] as BranchConfig\n  } catch (error) {\n    console.error(\"[KRA Sales API] Error fetching branch config:\", error)\n    return null\n  }\n}\n\nasync function getNextInvoiceNo(branchId: string): Promise<number> {\n  const result = await query(`\n    UPDATE branches \n    SET invc_no = COALESCE(invc_no, 0) + 1 \n    WHERE id = $1 \n    RETURNING invc_no\n  `, [branchId])\n  return result[0]?.invc_no || 1\n}\n\nasync function getTankItemInfo(branchId: string, fuelType: string, tankId?: string): Promise<any> {\n  let result\n  if (tankId) {\n    result = await query(`\n      SELECT t.*, i.item_code, i.class_code, i.item_name, i.package_unit, \n             i.quantity_unit, i.tax_type, i.sale_price, i.purchase_price,\n             fp.price as current_price\n      FROM tanks t\n      LEFT JOIN items i ON i.item_name ILIKE '%' || t.fuel_type || '%' AND i.branch_id = t.branch_id\n      LEFT JOIN fuel_prices fp ON fp.branch_id = t.branch_id AND fp.fuel_type = t.fuel_type\n      WHERE t.id = $1\n    `, [tankId])\n  } else {\n    result = await query(`\n      SELECT t.*, i.item_code, i.class_code, i.item_name, i.package_unit, \n             i.quantity_unit, i.tax_type, i.sale_price, i.purchase_price,\n             fp.price as current_price\n      FROM tanks t\n      LEFT JOIN items i ON i.item_name ILIKE '%' || t.fuel_type || '%' AND i.branch_id = t.branch_id\n      LEFT JOIN fuel_prices fp ON fp.branch_id = t.branch_id AND fp.fuel_type = t.fuel_type\n      WHERE t.branch_id = $1 AND t.fuel_type ILIKE $2 AND t.status = 'active'\n      ORDER BY t.current_stock DESC LIMIT 1\n    `, [branchId, `%${fuelType}%`])\n  }\n  \n  return result.length > 0 ? result[0] : null\n}\n\nfunction formatKraDateTime(date: Date = new Date()): string {\n  const year = date.getFullYear()\n  const month = String(date.getMonth() + 1).padStart(2, '0')\n  const day = String(date.getDate()).padStart(2, '0')\n  const hours = String(date.getHours()).padStart(2, '0')\n  const minutes = String(date.getMinutes()).padStart(2, '0')\n  const seconds = String(date.getSeconds()).padStart(2, '0')\n  return `${year}${month}${day}${hours}${minutes}${seconds}`\n}\n\nfunction formatKraDate(date: Date = new Date()): string {\n  const year = date.getFullYear()\n  const month = String(date.getMonth() + 1).padStart(2, '0')\n  const day = String(date.getDate()).padStart(2, '0')\n  return `${year}${month}${day}`\n}\n\nfunction calculateTax(amount: number, taxType: string = \"B\"): { taxblAmt: number, taxAmt: number, taxRt: number } {\n  if (taxType === \"A\") {\n    const taxRt = 16\n    const taxblAmt = amount / (1 + taxRt / 100)\n    const taxAmt = amount - taxblAmt\n    return { taxblAmt: Math.round(taxblAmt * 100) / 100, taxAmt: Math.round(taxAmt * 100) / 100, taxRt }\n  } else if (taxType === \"B\") {\n    const taxRt = 16\n    return { taxblAmt: amount, taxAmt: Math.round(amount * 0.16 * 100) / 100, taxRt }\n  } else if (taxType === \"C\") {\n    const taxRt = 8\n    return { taxblAmt: amount, taxAmt: Math.round(amount * 0.08 * 100) / 100, taxRt }\n  }\n  return { taxblAmt: amount, taxAmt: 0, taxRt: 0 }\n}\n\nexport async function callKraSaveSales(saleData: KraSaleData): Promise<{\n  success: boolean\n  kraResponse: KraResponse | null\n  error?: string\n}> {\n  const startTime = Date.now()\n  \n  try {\n    const branchConfig = await getBranchConfig(saleData.branch_id)\n    \n    if (!branchConfig) {\n      const errorMsg = \"Branch configuration not found\"\n      console.log(`[KRA Sales API] ${errorMsg}`)\n      return { success: false, kraResponse: null, error: errorMsg }\n    }\n\n    if (!branchConfig.tin) {\n      const errorMsg = \"KRA TIN not configured for this branch\"\n      console.log(`[KRA Sales API] ${errorMsg}`)\n      return { \n        success: false, \n        kraResponse: {\n          resultCd: \"CONFIG_ERROR\",\n          resultMsg: errorMsg,\n          resultDt: new Date().toISOString()\n        }, \n        error: errorMsg \n      }\n    }\n\n    const tankInfo = await getTankItemInfo(saleData.branch_id, saleData.fuel_type, saleData.tank_id)\n    const invcNo = await getNextInvoiceNo(saleData.branch_id)\n    \n    const itemCd = tankInfo?.item_code || tankInfo?.kra_item_cd || `KE2NTL0000001`\n    const itemClsCd = tankInfo?.class_code || \"5059690800\"\n    const itemNm = tankInfo?.item_name || saleData.fuel_type\n    const pkgUnitCd = tankInfo?.package_unit || \"NT\"\n    const qtyUnitCd = tankInfo?.quantity_unit || \"LT\"\n    const taxTyCd = tankInfo?.tax_type || \"B\"\n    \n    const price = saleData.unit_price || tankInfo?.current_price || tankInfo?.sale_price || 0\n    const qty = saleData.quantity || 1\n    const splyAmt = Math.round(qty * price * 100) / 100\n    \n    const { taxblAmt, taxAmt, taxRt } = calculateTax(splyAmt, taxTyCd)\n    \n    const now = new Date()\n    const cfmDt = formatKraDateTime(now)\n    const salesDt = formatKraDate(now)\n    \n    const pmtTyCd = PAYMENT_TYPE_CODES[saleData.payment_method?.toLowerCase()] || \"01\"\n    \n    const trdInvcNo = `CIV-${String(invcNo).padStart(6, '0')}`\n\n    const kraPayload = {\n      tin: branchConfig.tin,\n      bhfId: branchConfig.bhf_id || \"00\",\n      trdInvcNo: trdInvcNo,\n      invcNo: String(invcNo),\n      orgInvcNo: 0,\n      custTin: saleData.customer_pin || null,\n      custNm: saleData.customer_name || \"Walk-in Customer\",\n      salesTyCd: \"N\",\n      rcptTyCd: \"S\",\n      pmtTyCd: pmtTyCd,\n      salesSttsCd: \"02\",\n      cfmDt: cfmDt,\n      salesDt: salesDt,\n      stockRlsDt: cfmDt,\n      cnclReqDt: null,\n      cnclDt: null,\n      rfdDt: null,\n      rfdRsnCd: null,\n      totItemCnt: 1,\n      \n      taxblAmtA: taxTyCd === \"A\" ? taxblAmt.toFixed(2) : \"0.00\",\n      taxblAmtB: taxTyCd === \"B\" ? taxblAmt.toFixed(2) : \"0.00\",\n      taxblAmtC: taxTyCd === \"C\" ? taxblAmt.toFixed(2) : \"0.00\",\n      taxblAmtD: \"0.00\",\n      taxblAmtE: \"0.00\",\n      \n      taxRtA: taxTyCd === \"A\" ? taxRt.toFixed(2) : \"0.00\",\n      taxRtB: taxTyCd === \"B\" ? taxRt.toFixed(2) : \"0.00\",\n      taxRtC: taxTyCd === \"C\" ? taxRt.toFixed(2) : \"0.00\",\n      taxRtD: \"0.00\",\n      taxRtE: \"0.00\",\n      \n      taxAmtA: taxTyCd === \"A\" ? taxAmt.toFixed(2) : \"0.00\",\n      taxAmtB: taxTyCd === \"B\" ? taxAmt.toFixed(2) : \"0.00\",\n      taxAmtC: taxTyCd === \"C\" ? taxAmt.toFixed(2) : \"0.00\",\n      taxAmtD: \"0.00\",\n      taxAmtE: \"0.00\",\n      \n      totTaxblAmt: taxblAmt.toFixed(2),\n      totTaxAmt: taxAmt.toFixed(2),\n      totAmt: splyAmt.toFixed(2),\n      \n      prchrAcptcYn: \"N\",\n      remark: null,\n      regrNm: \"Admin\",\n      regrId: \"Admin\",\n      modrNm: \"Admin\",\n      modrId: \"Admin\",\n      \n      receipt: {\n        custTin: saleData.customer_pin || null,\n        custMblNo: null,\n        rcptPbctDt: null,\n        trdeNm: null,\n        adrs: null,\n        topMsg: null,\n        btmMsg: null,\n        prchrAcptcYn: \"Y\"\n      },\n      \n      itemList: [\n        {\n          itemSeq: 1,\n          itemCd: itemCd,\n          itemClsCd: itemClsCd,\n          itemNm: itemNm,\n          bcd: null,\n          pkgUnitCd: pkgUnitCd,\n          pkg: Math.ceil(qty),\n          qtyUnitCd: qtyUnitCd,\n          qty: qty,\n          prc: price,\n          splyAmt: splyAmt.toFixed(2),\n          dcRt: 0.0,\n          dcAmt: 0.0,\n          isrccCd: null,\n          isrccNm: null,\n          isrcRt: 0,\n          isrcAmt: 0,\n          taxTyCd: taxTyCd,\n          taxblAmt: taxblAmt.toFixed(2),\n          taxAmt: taxAmt.toFixed(2),\n          totAmt: splyAmt.toFixed(2)\n        }\n      ]\n    }\n\n    const kraEndpoint = `${KRA_BASE_URL}/trnsSales/saveSales`\n    \n    console.log(`[KRA Sales API] Calling endpoint: ${kraEndpoint}`)\n    console.log(`[KRA Sales API] Request payload:`, JSON.stringify(kraPayload, null, 2))\n\n    let kraResponse: KraResponse\n    let httpStatusCode = 200\n\n    try {\n      const controller = new AbortController()\n      const timeoutId = setTimeout(() => controller.abort(), 30000)\n      \n      const response = await fetch(kraEndpoint, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"Accept\": \"application/json\",\n        },\n        body: JSON.stringify(kraPayload),\n        signal: controller.signal\n      })\n\n      clearTimeout(timeoutId)\n      httpStatusCode = response.status\n      kraResponse = await response.json()\n      \n      console.log(`[KRA Sales API] HTTP Status: ${response.status}`)\n      console.log(`[KRA Sales API] KRA Result Code: ${kraResponse.resultCd}`)\n      console.log(`[KRA Sales API] KRA Result Message: ${kraResponse.resultMsg}`)\n      console.log(`[KRA Sales API] Response body:`, JSON.stringify(kraResponse, null, 2))\n    } catch (fetchError: any) {\n      httpStatusCode = 0\n      if (fetchError.name === 'AbortError') {\n        kraResponse = {\n          resultCd: \"TIMEOUT\",\n          resultMsg: \"Request timed out after 30 seconds\",\n          resultDt: new Date().toISOString()\n        }\n      } else {\n        kraResponse = {\n          resultCd: \"NETWORK_ERROR\",\n          resultMsg: fetchError.message || \"Failed to connect to KRA backend\",\n          resultDt: new Date().toISOString()\n        }\n      }\n      \n      console.log(`[KRA Sales API] Network error:`, fetchError.message)\n      console.log(`[KRA Sales API] Response (network error):`, JSON.stringify(kraResponse, null, 2))\n    }\n\n    const durationMs = Date.now() - startTime\n\n    await logApiCall({\n      endpoint: \"/trnsSales/saveSales\",\n      method: \"POST\",\n      payload: kraPayload,\n      response: kraResponse,\n      statusCode: httpStatusCode || 500,\n      durationMs,\n      branchId: saleData.branch_id,\n    })\n\n    const isSuccess = kraResponse.resultCd === \"000\" || kraResponse.resultCd === \"0\"\n    \n    return {\n      success: isSuccess,\n      kraResponse\n    }\n\n  } catch (error: any) {\n    const errorResponse: KraResponse = {\n      resultCd: \"SYSTEM_ERROR\",\n      resultMsg: error.message || \"System error calling KRA API\",\n      resultDt: new Date().toISOString()\n    }\n\n    console.error(`[KRA Sales API] System error:`, error)\n\n    const durationMs = Date.now() - startTime\n    \n    await logApiCall({\n      endpoint: \"/trnsSales/saveSales\",\n      method: \"POST\",\n      payload: { saleData, errorContext: \"System error before KRA call\" },\n      response: errorResponse,\n      statusCode: 500,\n      durationMs,\n      branchId: saleData.branch_id,\n      error: error.message\n    })\n\n    return {\n      success: false,\n      kraResponse: errorResponse,\n      error: error.message\n    }\n  }\n}\n\nexport async function callKraTestSalesEndpoint(saleData: KraSaleData): Promise<{\n  success: boolean\n  kraResponse: KraResponse | null\n  error?: string\n}> {\n  return callKraSaveSales(saleData)\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 900, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/sales/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { query } from \"@/lib/db\"\nimport { syncStockWithKRA } from \"@/lib/kra-stock-service\"\nimport { callKraSaveSales } from \"@/lib/kra-sales-api\"\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const branchId = searchParams.get('branch_id')\n    const nozzleId = searchParams.get('nozzle_id')\n    const limit = searchParams.get('limit') || '50'\n\n    let sql = 'SELECT * FROM sales WHERE 1=1'\n    const params: any[] = []\n    let paramIndex = 1\n\n    if (branchId) {\n      sql += ` AND branch_id = $${paramIndex}`\n      params.push(branchId)\n      paramIndex++\n    }\n\n    if (nozzleId) {\n      sql += ` AND nozzle_id = $${paramIndex}`\n      params.push(nozzleId)\n      paramIndex++\n    }\n\n    sql += ' ORDER BY sale_date DESC'\n    sql += ` LIMIT $${paramIndex}`\n    params.push(parseInt(limit))\n\n    const result = await query(sql, params)\n\n    return NextResponse.json({\n      success: true,\n      data: result\n    })\n\n  } catch (error: any) {\n    console.error(\"Error fetching sales:\", error)\n    return NextResponse.json(\n      { error: \"Failed to fetch sales\", details: error.message },\n      { status: 500 }\n    )\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const {\n      branch_id,\n      shift_id,\n      nozzle_id,\n      fuel_type,\n      quantity,\n      unit_price,\n      total_amount,\n      payment_method,\n      customer_name,\n      vehicle_number,\n      customer_pin,\n      invoice_number,\n      meter_reading_after,\n      transmission_status,\n      receipt_number,\n      is_loyalty_sale,\n      loyalty_customer_name,\n      loyalty_customer_pin,\n      sync_to_kra = true,\n      deduct_from_tank = true\n    } = body\n\n    if (!branch_id || !nozzle_id || !fuel_type) {\n      return NextResponse.json(\n        { error: \"Missing required fields\" },\n        { status: 400 }\n      )\n    }\n\n    const result = await query(\n      `INSERT INTO sales (\n        branch_id, shift_id, nozzle_id, fuel_type, quantity, unit_price, \n        total_amount, payment_method, customer_name, vehicle_number, customer_pin,\n        invoice_number, meter_reading_after, transmission_status, receipt_number,\n        is_loyalty_sale, loyalty_customer_name, loyalty_customer_pin, sale_date, created_at\n      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, NOW(), NOW())\n      RETURNING *`,\n      [\n        branch_id, shift_id, nozzle_id, fuel_type, quantity, unit_price,\n        total_amount, payment_method, customer_name, vehicle_number, customer_pin,\n        invoice_number, meter_reading_after, transmission_status || 'pending', receipt_number,\n        is_loyalty_sale || false, loyalty_customer_name, loyalty_customer_pin\n      ]\n    )\n\n    const sale = result[0]\n    let kraResult = null\n    let tankUpdate = null\n\n    if (quantity && quantity > 0) {\n      const tankResult = await query(\n        `SELECT * FROM tanks WHERE branch_id = $1 AND fuel_type ILIKE $2 AND status = 'active' ORDER BY current_stock DESC LIMIT 1`,\n        [branch_id, `%${fuel_type}%`]\n      )\n\n      if (tankResult.length > 0) {\n        const tank = tankResult[0]\n        \n        if (!tank.kra_item_cd) {\n          return NextResponse.json(\n            { error: `Tank \"${tank.tank_name}\" is not mapped to an item. Please map the tank to an item in the item list before selling.` },\n            { status: 400 }\n          )\n        }\n        const previousStock = tank.current_stock || 0\n        const newStock = Math.max(0, previousStock - quantity)\n\n        if (deduct_from_tank) {\n          await query(\n            `UPDATE tanks SET current_stock = $1, updated_at = NOW() WHERE id = $2`,\n            [newStock, tank.id]\n          )\n\n          tankUpdate = {\n            tankId: tank.id,\n            tankName: tank.tank_name,\n            previousStock,\n            newStock,\n            quantityDeducted: quantity\n          }\n        }\n\n        if (sync_to_kra) {\n          console.log(`[Sales API] Syncing sale of ${quantity} ${fuel_type} to KRA for branch ${branch_id}`)\n          \n          kraResult = await callKraSaveSales({\n            branch_id,\n            invoice_number: invoice_number || `INV-${Date.now().toString(36).toUpperCase()}`,\n            receipt_number: receipt_number || `RCP-${Date.now().toString(36).toUpperCase()}`,\n            fuel_type,\n            quantity,\n            unit_price: unit_price || 0,\n            total_amount: total_amount || (quantity * (unit_price || 0)),\n            payment_method: payment_method || 'cash',\n            customer_name: customer_name || 'Walk-in Customer',\n            customer_pin: customer_pin || '',\n            sale_date: new Date().toISOString(),\n            tank_id: tank.id\n          })\n\n          await query(\n            `UPDATE tanks SET kra_sync_status = $1 WHERE id = $2`,\n            [kraResult.success ? 'synced' : 'failed', tank.id]\n          )\n        }\n      }\n    }\n\n    return NextResponse.json({\n      success: true,\n      data: sale,\n      tankUpdate,\n      kraSync: kraResult ? {\n        synced: kraResult.success,\n        kraResponse: kraResult.kraResponse,\n        error: kraResult.error\n      } : null\n    })\n\n  } catch (error: any) {\n    console.error(\"Error creating sale:\", error)\n    return NextResponse.json(\n      { error: \"Failed to create sale\", details: error.message },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":"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"}}]
}