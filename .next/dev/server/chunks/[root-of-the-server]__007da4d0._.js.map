{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/branches/%5Bid%5D/intermittency-rate/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { cookies } from \"next/headers\"\nimport { Pool } from \"pg\"\n\nconst pool = new Pool({ connectionString: process.env.DATABASE_URL })\n\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const cookieStore = await cookies()\n    const sessionCookie = cookieStore.get(\"user_session\")\n    \n    if (!sessionCookie?.value) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 })\n    }\n    \n    const session = JSON.parse(sessionCookie.value)\n    const { vendor_id } = session\n    const { id: branchId } = await params\n\n    const result = await pool.query(\n      `SELECT id, name, bulk_sales_kra_percentage \n       FROM branches \n       WHERE id = $1 AND ($2::uuid IS NULL OR vendor_id = $2)`,\n      [branchId, vendor_id]\n    )\n\n    if (result.rows.length === 0) {\n      return NextResponse.json({ error: \"Branch not found\" }, { status: 404 })\n    }\n\n    return NextResponse.json({\n      success: true,\n      data: {\n        branch_id: result.rows[0].id,\n        branch_name: result.rows[0].name,\n        intermittency_rate: result.rows[0].bulk_sales_kra_percentage || 100\n      }\n    })\n\n  } catch (error: any) {\n    console.error(\"Error fetching intermittency rate:\", error)\n    return NextResponse.json({ error: error.message }, { status: 500 })\n  }\n}\n\nexport async function PUT(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const cookieStore = await cookies()\n    const sessionCookie = cookieStore.get(\"user_session\")\n    \n    if (!sessionCookie?.value) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 })\n    }\n    \n    const session = JSON.parse(sessionCookie.value)\n    const { vendor_id, role } = session\n    const { id: branchId } = await params\n\n    if (!['supervisor', 'manager', 'director', 'vendor'].includes(role)) {\n      return NextResponse.json({ error: \"Insufficient permissions\" }, { status: 403 })\n    }\n\n    const body = await request.json()\n    const { intermittency_rate } = body\n\n    if (intermittency_rate === undefined || intermittency_rate === null) {\n      return NextResponse.json({ error: \"intermittency_rate is required\" }, { status: 400 })\n    }\n\n    const rate = parseInt(intermittency_rate)\n    if (isNaN(rate) || rate < 0 || rate > 100) {\n      return NextResponse.json({ error: \"intermittency_rate must be between 0 and 100\" }, { status: 400 })\n    }\n\n    const branchCheck = await pool.query(\n      `SELECT id FROM branches WHERE id = $1 AND ($2::uuid IS NULL OR vendor_id = $2)`,\n      [branchId, vendor_id]\n    )\n\n    if (branchCheck.rows.length === 0) {\n      return NextResponse.json({ error: \"Branch not found or access denied\" }, { status: 404 })\n    }\n\n    await pool.query(\n      `UPDATE branches SET bulk_sales_kra_percentage = $1, updated_at = NOW() WHERE id = $2`,\n      [rate, branchId]\n    )\n\n    return NextResponse.json({\n      success: true,\n      message: `Intermittency rate updated to ${rate}%`,\n      data: {\n        branch_id: branchId,\n        intermittency_rate: rate\n      }\n    })\n\n  } catch (error: any) {\n    console.error(\"Error updating intermittency rate:\", error)\n    return NextResponse.json({ error: error.message }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}