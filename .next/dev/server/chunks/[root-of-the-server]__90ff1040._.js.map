{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/stock-transfers/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const branchId = searchParams.get(\"branch_id\")\n\n    let query = \"SELECT * FROM stock_transfers WHERE 1=1\"\n    const params: any[] = []\n    let paramIndex = 1\n\n    if (branchId) {\n      query += ` AND (from_branch_id = $${paramIndex} OR to_branch_id = $${paramIndex})`\n      params.push(branchId)\n      paramIndex++\n    }\n\n    query += \" ORDER BY created_at DESC\"\n\n    const result = await pool.query(query, params)\n\n    return NextResponse.json({ success: true, data: result.rows })\n  } catch (error) {\n    console.error(\"Error fetching stock transfers:\", error)\n    return NextResponse.json({ success: false, error: \"Failed to fetch stock transfers\" }, { status: 500 })\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const { \n      from_tank_id, \n      to_tank_id, \n      from_branch_id, \n      to_branch_id, \n      quantity, \n      requested_by, \n      notes, \n      approval_status \n    } = body\n\n    if (!from_tank_id || !to_tank_id || !from_branch_id) {\n      return NextResponse.json({ success: false, error: \"from_tank_id, to_tank_id, and from_branch_id are required\" }, { status: 400 })\n    }\n\n    const result = await pool.query(\n      `INSERT INTO stock_transfers (from_tank_id, to_tank_id, from_branch_id, to_branch_id, quantity, requested_by, notes, approval_status)\n       VALUES ($1, $2, $3, $4, $5, $6, $7, $8)\n       RETURNING *`,\n      [from_tank_id, to_tank_id, from_branch_id, to_branch_id || from_branch_id, quantity || 0, requested_by, notes, approval_status || \"pending\"]\n    )\n\n    return NextResponse.json({ success: true, data: result.rows[0] })\n  } catch (error) {\n    console.error(\"Error creating stock transfer:\", error)\n    return NextResponse.json({ success: false, error: \"Failed to create stock transfer\" }, { status: 500 })\n  }\n}\n\nexport async function PUT(request: NextRequest) {\n  const client = await pool.connect()\n  try {\n    const body = await request.json()\n    const { transfer_id, action, approved_by, to_previous_stock, to_new_stock } = body\n\n    if (!transfer_id || !action) {\n      return NextResponse.json({ success: false, error: \"transfer_id and action are required\" }, { status: 400 })\n    }\n\n    const transferResult = await client.query(\n      \"SELECT * FROM stock_transfers WHERE id = $1\",\n      [transfer_id]\n    )\n\n    if (transferResult.rows.length === 0) {\n      return NextResponse.json({ success: false, error: \"Transfer not found\" }, { status: 404 })\n    }\n\n    const transfer = transferResult.rows[0]\n\n    if (transfer.status === 'completed') {\n      return NextResponse.json({ success: false, error: \"Transfer already completed\" }, { status: 400 })\n    }\n\n    await client.query('BEGIN')\n\n    if (action === 'accept') {\n      // Get source tank\n      const fromTank = await client.query(\"SELECT * FROM tanks WHERE id = $1\", [transfer.from_tank_id])\n      if (fromTank.rows.length === 0) {\n        await client.query('ROLLBACK')\n        return NextResponse.json({ success: false, error: \"Source tank not found\" }, { status: 404 })\n      }\n\n      // Get destination tank\n      const toTank = await client.query(\"SELECT * FROM tanks WHERE id = $1\", [transfer.to_tank_id])\n      if (toTank.rows.length === 0) {\n        await client.query('ROLLBACK')\n        return NextResponse.json({ success: false, error: \"Destination tank not found\" }, { status: 404 })\n      }\n\n      const transferQty = parseFloat(transfer.quantity)\n      \n      // Source tank calculations\n      const fromPreviousStock = parseFloat(fromTank.rows[0].current_stock) || 0\n      \n      // Check if source tank has sufficient stock\n      if (fromPreviousStock < transferQty) {\n        await client.query('ROLLBACK')\n        return NextResponse.json({ \n          success: false, \n          error: `Insufficient stock in source tank. Available: ${fromPreviousStock.toFixed(2)}L. Transfer quantity: ${transferQty}L.` \n        }, { status: 400 })\n      }\n      \n      const fromNewStock = fromPreviousStock - transferQty\n      \n      // Destination tank calculations\n      const toPreviousStock = parseFloat(toTank.rows[0].current_stock) || 0\n      const tankCapacity = parseFloat(toTank.rows[0].capacity) || 0\n      const toNewStock = toPreviousStock + transferQty\n\n      // Check if transfer would exceed destination tank capacity (100%)\n      if (tankCapacity > 0 && toNewStock > tankCapacity) {\n        await client.query('ROLLBACK')\n        const availableSpace = tankCapacity - toPreviousStock\n        return NextResponse.json({ \n          success: false, \n          error: `Cannot accept transfer. Tank capacity is ${tankCapacity}L. Current stock: ${toPreviousStock}L. Available space: ${availableSpace.toFixed(2)}L. Transfer quantity: ${transfer.quantity}L would exceed capacity.` \n        }, { status: 400 })\n      }\n\n      // Update source tank (deduct stock)\n      await client.query(\n        \"UPDATE tanks SET current_stock = $1, updated_at = NOW() WHERE id = $2\",\n        [fromNewStock, transfer.from_tank_id]\n      )\n\n      // Update destination tank (add stock)\n      await client.query(\n        \"UPDATE tanks SET current_stock = $1, updated_at = NOW() WHERE id = $2\",\n        [toNewStock, transfer.to_tank_id]\n      )\n\n      // Insert stock_adjustments for source tank (transfer_out)\n      await client.query(\n        `INSERT INTO stock_adjustments (branch_id, tank_id, adjustment_type, quantity, previous_stock, new_stock, reason, approved_by, approval_status)\n         VALUES ($1, $2, 'transfer_out', $3, $4, $5, $6, $7, 'approved')`,\n        [transfer.from_branch_id, transfer.from_tank_id, transferQty, fromPreviousStock, fromNewStock, \n         `Transfer to ${toTank.rows[0].tank_name || 'another tank'}: ${transfer.notes || ''}`, approved_by]\n      )\n\n      // Insert stock_adjustments for destination tank (transfer_in)\n      await client.query(\n        `INSERT INTO stock_adjustments (branch_id, tank_id, adjustment_type, quantity, previous_stock, new_stock, reason, approved_by, approval_status)\n         VALUES ($1, $2, 'transfer_in', $3, $4, $5, $6, $7, 'approved')`,\n        [transfer.to_branch_id, transfer.to_tank_id, transferQty, toPreviousStock, toNewStock,\n         `Transfer from ${fromTank.rows[0].tank_name || 'another tank'}: ${transfer.notes || ''}`, approved_by]\n      )\n\n      // Update the transfer record\n      await client.query(\n        `UPDATE stock_transfers \n         SET status = 'completed', \n             approval_status = 'approved',\n             approved_by = $1, \n             approved_at = NOW(),\n             from_previous_stock = $2,\n             from_new_stock = $3,\n             to_previous_stock = $4,\n             to_new_stock = $5,\n             updated_at = NOW()\n         WHERE id = $6`,\n        [approved_by, fromPreviousStock, fromNewStock, toPreviousStock, toNewStock, transfer_id]\n      )\n\n      await client.query('COMMIT')\n\n      return NextResponse.json({ \n        success: true, \n        data: { \n          transfer_id, \n          fromPreviousStock,\n          fromNewStock,\n          toPreviousStock, \n          toNewStock, \n          quantity: transfer.quantity \n        } \n      })\n    } else if (action === 'reject') {\n      await client.query(\n        `UPDATE stock_transfers \n         SET status = 'rejected', \n             approval_status = 'rejected',\n             approved_by = $1, \n             approved_at = NOW(),\n             updated_at = NOW()\n         WHERE id = $2`,\n        [approved_by, transfer_id]\n      )\n\n      await client.query('COMMIT')\n\n      return NextResponse.json({ success: true, message: \"Transfer rejected\" })\n    } else {\n      await client.query('ROLLBACK')\n      return NextResponse.json({ success: false, error: \"Invalid action. Use 'accept' or 'reject'\" }, { status: 400 })\n    }\n  } catch (error) {\n    await client.query('ROLLBACK')\n    console.error(\"Error updating stock transfer:\", error)\n    return NextResponse.json({ success: false, error: \"Failed to update stock transfer\" }, { status: 500 })\n  } finally {\n    client.release()\n  }\n}\n"],"names":[],"mappings":"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"}}]
}