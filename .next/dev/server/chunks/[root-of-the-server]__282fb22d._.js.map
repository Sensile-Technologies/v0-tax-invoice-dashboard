{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/client.ts"],"sourcesContent":["import { Pool } from 'pg';\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,\n});\n\nexport async function query<T = any>(text: string, params?: any[]): Promise<T[]> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rows as T[];\n  } finally {\n    client.release();\n  }\n}\n\nexport async function queryOne<T = any>(text: string, params?: any[]): Promise<T | null> {\n  const rows = await query<T>(text, params);\n  return rows[0] || null;\n}\n\nexport async function execute(text: string, params?: any[]): Promise<number> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rowCount || 0;\n  } finally {\n    client.release();\n  }\n}\n\nexport async function getClient() {\n  return await pool.connect();\n}\n\nexport { pool };\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,sCAAwC,0BAAgC;AAC/E;AAEO,eAAe,MAAe,IAAY,EAAE,MAAc;IAC/D,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,IAAI;IACpB,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe,SAAkB,IAAY,EAAE,MAAc;IAClE,MAAM,OAAO,MAAM,MAAS,MAAM;IAClC,OAAO,IAAI,CAAC,EAAE,IAAI;AACpB;AAEO,eAAe,QAAQ,IAAY,EAAE,MAAc;IACxD,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,QAAQ,IAAI;IAC5B,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe;IACpB,OAAO,MAAM,KAAK,OAAO;AAC3B"}},
    {"offset": {"line": 113, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/index.ts"],"sourcesContent":["export * from './client';\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 127, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/reports/bulk-sales/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { query } from \"@/lib/db\"\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const branchId = searchParams.get(\"branch_id\")\n    const dateFrom = searchParams.get(\"date_from\")\n    const dateTo = searchParams.get(\"date_to\")\n\n    if (!branchId) {\n      return NextResponse.json({ error: \"Branch ID required\" }, { status: 400 })\n    }\n\n    let whereClause = \"WHERE s.branch_id = $1 AND s.source_system = 'meter_diff_bulk'\"\n    const params: any[] = [branchId]\n    let paramIndex = 2\n\n    if (dateFrom) {\n      whereClause += ` AND DATE(s.created_at) >= $${paramIndex}`\n      params.push(dateFrom)\n      paramIndex++\n    }\n\n    if (dateTo) {\n      whereClause += ` AND DATE(s.created_at) <= $${paramIndex}`\n      params.push(dateTo)\n      paramIndex++\n    }\n\n    const bulkSales = await query(`\n      SELECT \n        s.id,\n        s.shift_id,\n        s.nozzle_id,\n        s.fuel_type,\n        s.quantity,\n        s.unit_price,\n        s.total_amount,\n        s.invoice_number,\n        s.kra_status,\n        s.transmission_status,\n        s.created_at,\n        CONCAT('D', d.dispenser_number, '-N', n.nozzle_number) AS nozzle_name,\n        d.dispenser_number,\n        n.nozzle_number,\n        sh.start_time AS shift_start,\n        sh.end_time AS shift_end,\n        st.full_name AS cashier_name,\n        i.item_name AS item_name\n      FROM sales s\n      LEFT JOIN nozzles n ON s.nozzle_id = n.id\n      LEFT JOIN dispensers d ON n.dispenser_id = d.id\n      LEFT JOIN shifts sh ON s.shift_id = sh.id\n      LEFT JOIN staff st ON sh.staff_id = st.id\n      LEFT JOIN items i ON n.item_id = i.id\n      ${whereClause}\n      ORDER BY s.created_at DESC\n    `, params)\n\n    const summary = await query(`\n      SELECT \n        s.fuel_type,\n        COALESCE(i.item_name, s.fuel_type) AS product_name,\n        SUM(s.quantity) AS total_quantity,\n        SUM(s.total_amount) AS total_amount,\n        COUNT(s.id) AS invoice_count,\n        COUNT(CASE WHEN s.kra_status = 'success' OR s.kra_status = 'transmitted' THEN 1 END) AS kra_transmitted,\n        COUNT(CASE WHEN s.kra_status = 'pending' OR s.transmission_status = 'not_sent' THEN 1 END) AS kra_skipped\n      FROM sales s\n      LEFT JOIN nozzles n ON s.nozzle_id = n.id\n      LEFT JOIN items i ON n.item_id = i.id\n      ${whereClause}\n      GROUP BY s.fuel_type, i.item_name\n      ORDER BY i.item_name\n    `, params)\n\n    const branch = await query(`\n      SELECT name, bulk_sales_kra_percentage, controller_id, split_denominations FROM branches WHERE id = $1\n    `, [branchId])\n\n    const branchData = branch[0] || {}\n    const hasController = !!branchData.controller_id\n\n    return NextResponse.json({\n      success: true,\n      data: {\n        bulk_sales: bulkSales,\n        summary,\n        branch_name: branchData.name || \"Unknown Branch\",\n        kra_percentage: branchData.bulk_sales_kra_percentage ?? 100,\n        split_denominations: branchData.split_denominations !== false,\n        has_controller: hasController,\n        controller_id: branchData.controller_id || null,\n        totals: {\n          total_quantity: bulkSales.reduce((sum: number, s: any) => sum + Number(s.quantity || 0), 0),\n          total_amount: bulkSales.reduce((sum: number, s: any) => sum + Number(s.total_amount || 0), 0),\n          total_entries: bulkSales.length,\n          kra_transmitted: bulkSales.filter((s: any) => s.kra_status === 'success' || s.kra_status === 'transmitted').length,\n          kra_skipped: bulkSales.filter((s: any) => s.kra_status === 'pending' || s.transmission_status === 'not_sent').length\n        }\n      }\n    })\n  } catch (error) {\n    console.error(\"Error fetching bulk sales report:\", error)\n    return NextResponse.json({ error: \"Failed to fetch bulk sales report\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AAAA;;;;;;;;AAEO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,WAAW,aAAa,GAAG,CAAC;QAClC,MAAM,WAAW,aAAa,GAAG,CAAC;QAClC,MAAM,SAAS,aAAa,GAAG,CAAC;QAEhC,IAAI,CAAC,UAAU;YACb,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAqB,GAAG;gBAAE,QAAQ;YAAI;QAC1E;QAEA,IAAI,cAAc;QAClB,MAAM,SAAgB;YAAC;SAAS;QAChC,IAAI,aAAa;QAEjB,IAAI,UAAU;YACZ,eAAe,CAAC,4BAA4B,EAAE,YAAY;YAC1D,OAAO,IAAI,CAAC;YACZ;QACF;QAEA,IAAI,QAAQ;YACV,eAAe,CAAC,4BAA4B,EAAE,YAAY;YAC1D,OAAO,IAAI,CAAC;YACZ;QACF;QAEA,MAAM,YAAY,MAAM,IAAA,8HAAK,EAAC,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;MA0B7B,EAAE,YAAY;;IAEhB,CAAC,EAAE;QAEH,MAAM,UAAU,MAAM,IAAA,8HAAK,EAAC,CAAC;;;;;;;;;;;;MAY3B,EAAE,YAAY;;;IAGhB,CAAC,EAAE;QAEH,MAAM,SAAS,MAAM,IAAA,8HAAK,EAAC,CAAC;;IAE5B,CAAC,EAAE;YAAC;SAAS;QAEb,MAAM,aAAa,MAAM,CAAC,EAAE,IAAI,CAAC;QACjC,MAAM,gBAAgB,CAAC,CAAC,WAAW,aAAa;QAEhD,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,MAAM;gBACJ,YAAY;gBACZ;gBACA,aAAa,WAAW,IAAI,IAAI;gBAChC,gBAAgB,WAAW,yBAAyB,IAAI;gBACxD,qBAAqB,WAAW,mBAAmB,KAAK;gBACxD,gBAAgB;gBAChB,eAAe,WAAW,aAAa,IAAI;gBAC3C,QAAQ;oBACN,gBAAgB,UAAU,MAAM,CAAC,CAAC,KAAa,IAAW,MAAM,OAAO,EAAE,QAAQ,IAAI,IAAI;oBACzF,cAAc,UAAU,MAAM,CAAC,CAAC,KAAa,IAAW,MAAM,OAAO,EAAE,YAAY,IAAI,IAAI;oBAC3F,eAAe,UAAU,MAAM;oBAC/B,iBAAiB,UAAU,MAAM,CAAC,CAAC,IAAW,EAAE,UAAU,KAAK,aAAa,EAAE,UAAU,KAAK,eAAe,MAAM;oBAClH,aAAa,UAAU,MAAM,CAAC,CAAC,IAAW,EAAE,UAAU,KAAK,aAAa,EAAE,mBAAmB,KAAK,YAAY,MAAM;gBACtH;YACF;QACF;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qCAAqC;QACnD,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAoC,GAAG;YAAE,QAAQ;QAAI;IACzF;AACF"}}]
}