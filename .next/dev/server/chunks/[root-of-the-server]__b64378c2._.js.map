{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/client.ts"],"sourcesContent":["import { Pool } from 'pg';\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,\n});\n\nexport async function query<T = any>(text: string, params?: any[]): Promise<T[]> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rows as T[];\n  } finally {\n    client.release();\n  }\n}\n\nexport async function queryOne<T = any>(text: string, params?: any[]): Promise<T | null> {\n  const rows = await query<T>(text, params);\n  return rows[0] || null;\n}\n\nexport async function execute(text: string, params?: any[]): Promise<number> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rowCount || 0;\n  } finally {\n    client.release();\n  }\n}\n\nexport async function getClient() {\n  return await pool.connect();\n}\n\nexport { pool };\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,sCAAwC,0BAAgC;AAC/E;AAEO,eAAe,MAAe,IAAY,EAAE,MAAc;IAC/D,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,IAAI;IACpB,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe,SAAkB,IAAY,EAAE,MAAc;IAClE,MAAM,OAAO,MAAM,MAAS,MAAM;IAClC,OAAO,IAAI,CAAC,EAAE,IAAI;AACpB;AAEO,eAAe,QAAQ,IAAY,EAAE,MAAc;IACxD,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,QAAQ,IAAI;IAC5B,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe;IACpB,OAAO,MAAM,KAAK,OAAO;AAC3B"}},
    {"offset": {"line": 113, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/index.ts"],"sourcesContent":["export * from './client';\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 127, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/staff/update/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { query } from \"@/lib/db\"\nimport { cookies } from \"next/headers\"\n\nasync function getSession() {\n  const cookieStore = await cookies()\n  const sessionCookie = cookieStore.get(\"user_session\")\n  if (!sessionCookie) return null\n  try {\n    return JSON.parse(sessionCookie.value)\n  } catch {\n    return null\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const session = await getSession()\n    if (!session) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 })\n    }\n\n    const body = await request.json()\n    const { staffId, fullName, username, email, phone, role, branchId } = body\n\n    if (!staffId) {\n      return NextResponse.json({ error: \"Staff ID is required\" }, { status: 400 })\n    }\n\n    // Verify the requesting user has permission (vendor or director)\n    const userCheck = await query(\n      `SELECT u.id, COALESCE(s.role, u.role) as role, v.id as vendor_id\n       FROM users u\n       LEFT JOIN vendors v ON v.email = u.email\n       LEFT JOIN staff s ON s.user_id = u.id\n       WHERE u.id = $1`,\n      [session.id]\n    )\n\n    if (userCheck.length === 0) {\n      return NextResponse.json({ error: \"User not found\" }, { status: 404 })\n    }\n\n    const currentUser = userCheck[0]\n    if (!['vendor', 'director'].includes(currentUser.role?.toLowerCase()) && !currentUser.vendor_id) {\n      return NextResponse.json({ error: \"Only vendors and directors can update staff\" }, { status: 403 })\n    }\n\n    // Get the vendor_id for the staff member to verify ownership\n    const staffCheck = await query(\n      `SELECT s.id, s.user_id, b.vendor_id \n       FROM staff s \n       LEFT JOIN branches b ON s.branch_id = b.id \n       WHERE s.id = $1`,\n      [staffId]\n    )\n\n    if (staffCheck.length === 0) {\n      return NextResponse.json({ error: \"Staff member not found\" }, { status: 404 })\n    }\n\n    const staffMember = staffCheck[0]\n\n    // Get vendor_id for current user\n    let userVendorId = currentUser.vendor_id\n    if (!userVendorId) {\n      const vendorCheck = await query(\n        `SELECT b.vendor_id FROM branches b JOIN staff s ON s.branch_id = b.id WHERE s.user_id = $1 LIMIT 1`,\n        [session.id]\n      )\n      userVendorId = vendorCheck[0]?.vendor_id\n    }\n\n    // Verify the staff belongs to the same vendor\n    if (staffMember.vendor_id !== userVendorId) {\n      return NextResponse.json({ error: \"Access denied\" }, { status: 403 })\n    }\n\n    // Get vendor_id from new branch if branch is changing\n    let vendorId = null\n    if (branchId) {\n      const branchResult = await query(\n        `SELECT vendor_id FROM branches WHERE id = $1`,\n        [branchId]\n      )\n      if (branchResult.length > 0) {\n        vendorId = branchResult[0].vendor_id\n      }\n    }\n\n    // Update staff table - only update branch_id if explicitly provided\n    await query(\n      `UPDATE staff \n       SET full_name = COALESCE($1, full_name),\n           username = COALESCE($2, username),\n           email = COALESCE($3, email),\n           phone_number = COALESCE($4, phone_number),\n           role = COALESCE($5, role),\n           branch_id = CASE WHEN $6::text = '' OR $6 IS NULL THEN branch_id ELSE $6::uuid END,\n           vendor_id = CASE WHEN $8::text = '' OR $8 IS NULL THEN vendor_id ELSE $8::uuid END,\n           updated_at = NOW()\n       WHERE id = $7`,\n      [fullName, username, email, phone, role, branchId || '', staffId, vendorId || '']\n    )\n\n    // Update corresponding user record if exists\n    if (staffMember.user_id) {\n      await query(\n        `UPDATE users \n         SET email = COALESCE($1, email),\n             username = COALESCE($2, username),\n             phone_number = COALESCE($3, phone_number),\n             role = COALESCE($4, role),\n             updated_at = NOW()\n         WHERE id = $5`,\n        [email, username, phone, role, staffMember.user_id]\n      )\n    }\n\n    return NextResponse.json({ \n      success: true, \n      message: \"Staff member updated successfully\" \n    })\n  } catch (error: any) {\n    console.error(\"Error updating staff:\", error)\n    return NextResponse.json(\n      { error: \"Failed to update staff member\", details: error.message },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":"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"}}]
}