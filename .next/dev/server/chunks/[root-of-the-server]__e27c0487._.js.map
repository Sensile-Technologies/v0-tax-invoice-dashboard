{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/mobile/create-sale/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nexport async function POST(request: Request) {\n  try {\n    const body = await request.json()\n    const {\n      branch_id,\n      user_id,\n      nozzle_id,\n      fuel_type,\n      quantity,\n      unit_price,\n      total_amount,\n      payment_method,\n      customer_name,\n      kra_pin,\n      vehicle_number,\n      is_loyalty_customer,\n    } = body\n\n    if (!branch_id || !fuel_type || !total_amount) {\n      return NextResponse.json(\n        { error: \"Branch ID, fuel type, and amount are required\" },\n        { status: 400 }\n      )\n    }\n\n    const client = await pool.connect()\n    try {\n      await client.query('BEGIN')\n\n      const invoiceNumber = `INV-${Date.now().toString(36).toUpperCase()}`\n      const receiptNumber = `RCP-${Date.now().toString(36).toUpperCase()}`\n\n      const saleResult = await client.query(\n        `INSERT INTO sales (\n          branch_id, nozzle_id, fuel_type, quantity, \n          unit_price, total_amount, payment_method, customer_name, \n          vehicle_number, invoice_number, receipt_number, sale_date,\n          created_by\n        ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, NOW(), $12)\n        RETURNING *`,\n        [\n          branch_id,\n          nozzle_id || null,\n          fuel_type,\n          quantity,\n          unit_price,\n          total_amount,\n          payment_method || 'cash',\n          customer_name || 'Walk-in Customer',\n          vehicle_number || null,\n          invoiceNumber,\n          receiptNumber,\n          user_id || null,\n        ]\n      )\n\n      const sale = saleResult.rows[0]\n\n      const invoiceResult = await client.query(\n        `INSERT INTO invoices (\n          invoice_number,\n          branch_id,\n          customer_name,\n          customer_phone,\n          subtotal,\n          tax_amount,\n          total_amount,\n          status,\n          created_by,\n          kra_pin,\n          payment_method\n        ) VALUES ($1, $2, $3, $4, $5, $6, $7, 'paid', $8, $9, $10)\n        RETURNING *`,\n        [\n          invoiceNumber,\n          branch_id,\n          customer_name || 'Walk-in Customer',\n          null,\n          total_amount,\n          total_amount * 0.16,\n          total_amount * 1.16,\n          user_id || null,\n          kra_pin || null,\n          payment_method || 'cash',\n        ]\n      )\n\n      const invoice = invoiceResult.rows[0]\n\n      if (invoice) {\n        await client.query(\n          `INSERT INTO invoice_line_items (\n            invoice_id,\n            product_id,\n            product_name,\n            quantity,\n            unit_price,\n            discount,\n            total\n          ) VALUES ($1, $2, $3, $4, $5, $6, $7)`,\n          [\n            invoice.id,\n            nozzle_id || fuel_type,\n            fuel_type,\n            quantity,\n            unit_price,\n            0,\n            total_amount,\n          ]\n        )\n      }\n\n      if (is_loyalty_customer && customer_name) {\n        const existingCustomer = await client.query(\n          `SELECT id FROM customers WHERE name = $1 AND branch_id = $2`,\n          [customer_name, branch_id]\n        )\n\n        if (existingCustomer.rows.length === 0) {\n          await client.query(\n            `INSERT INTO customers (branch_id, name, kra_pin, is_loyalty)\n             VALUES ($1, $2, $3, true)\n             ON CONFLICT DO NOTHING`,\n            [branch_id, customer_name, kra_pin || null]\n          )\n        }\n      }\n\n      await client.query('COMMIT')\n\n      return NextResponse.json({\n        success: true,\n        sale: sale,\n        invoice: invoice,\n        invoice_number: invoiceNumber,\n        receipt_number: receiptNumber,\n      })\n    } catch (error) {\n      await client.query('ROLLBACK')\n      throw error\n    } finally {\n      client.release()\n    }\n  } catch (error) {\n    console.error(\"[Mobile Create Sale API Error]:\", error)\n    return NextResponse.json({ error: \"Failed to create sale\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;AAC5C;AAEO,eAAe,KAAK,OAAgB;IACzC,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EACJ,SAAS,EACT,OAAO,EACP,SAAS,EACT,SAAS,EACT,QAAQ,EACR,UAAU,EACV,YAAY,EACZ,cAAc,EACd,aAAa,EACb,OAAO,EACP,cAAc,EACd,mBAAmB,EACpB,GAAG;QAEJ,IAAI,CAAC,aAAa,CAAC,aAAa,CAAC,cAAc;YAC7C,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAgD,GACzD;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,SAAS,MAAM,KAAK,OAAO;QACjC,IAAI;YACF,MAAM,OAAO,KAAK,CAAC;YAEnB,MAAM,gBAAgB,CAAC,IAAI,EAAE,KAAK,GAAG,GAAG,QAAQ,CAAC,IAAI,WAAW,IAAI;YACpE,MAAM,gBAAgB,CAAC,IAAI,EAAE,KAAK,GAAG,GAAG,QAAQ,CAAC,IAAI,WAAW,IAAI;YAEpE,MAAM,aAAa,MAAM,OAAO,KAAK,CACnC,CAAC;;;;;;mBAMU,CAAC,EACZ;gBACE;gBACA,aAAa;gBACb;gBACA;gBACA;gBACA;gBACA,kBAAkB;gBAClB,iBAAiB;gBACjB,kBAAkB;gBAClB;gBACA;gBACA,WAAW;aACZ;YAGH,MAAM,OAAO,WAAW,IAAI,CAAC,EAAE;YAE/B,MAAM,gBAAgB,MAAM,OAAO,KAAK,CACtC,CAAC;;;;;;;;;;;;;mBAaU,CAAC,EACZ;gBACE;gBACA;gBACA,iBAAiB;gBACjB;gBACA;gBACA,eAAe;gBACf,eAAe;gBACf,WAAW;gBACX,WAAW;gBACX,kBAAkB;aACnB;YAGH,MAAM,UAAU,cAAc,IAAI,CAAC,EAAE;YAErC,IAAI,SAAS;gBACX,MAAM,OAAO,KAAK,CAChB,CAAC;;;;;;;;+CAQoC,CAAC,EACtC;oBACE,QAAQ,EAAE;oBACV,aAAa;oBACb;oBACA;oBACA;oBACA;oBACA;iBACD;YAEL;YAEA,IAAI,uBAAuB,eAAe;gBACxC,MAAM,mBAAmB,MAAM,OAAO,KAAK,CACzC,CAAC,2DAA2D,CAAC,EAC7D;oBAAC;oBAAe;iBAAU;gBAG5B,IAAI,iBAAiB,IAAI,CAAC,MAAM,KAAK,GAAG;oBACtC,MAAM,OAAO,KAAK,CAChB,CAAC;;mCAEsB,CAAC,EACxB;wBAAC;wBAAW;wBAAe,WAAW;qBAAK;gBAE/C;YACF;YAEA,MAAM,OAAO,KAAK,CAAC;YAEnB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,SAAS;gBACT,MAAM;gBACN,SAAS;gBACT,gBAAgB;gBAChB,gBAAgB;YAClB;QACF,EAAE,OAAO,OAAO;YACd,MAAM,OAAO,KAAK,CAAC;YACnB,MAAM;QACR,SAAU;YACR,OAAO,OAAO;QAChB;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,mCAAmC;QACjD,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAwB,GAAG;YAAE,QAAQ;QAAI;IAC7E;AACF"}}]
}