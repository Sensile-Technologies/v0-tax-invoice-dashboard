{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/client.ts"],"sourcesContent":["import { Pool } from 'pg';\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,\n});\n\nexport async function query<T = any>(text: string, params?: any[]): Promise<T[]> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rows as T[];\n  } finally {\n    client.release();\n  }\n}\n\nexport async function queryOne<T = any>(text: string, params?: any[]): Promise<T | null> {\n  const rows = await query<T>(text, params);\n  return rows[0] || null;\n}\n\nexport async function execute(text: string, params?: any[]): Promise<number> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rowCount || 0;\n  } finally {\n    client.release();\n  }\n}\n\nexport async function getClient() {\n  return await pool.connect();\n}\n\nexport { pool };\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,sCAAwC,0BAAgC;AAC/E;AAEO,eAAe,MAAe,IAAY,EAAE,MAAc;IAC/D,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,IAAI;IACpB,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe,SAAkB,IAAY,EAAE,MAAc;IAClE,MAAM,OAAO,MAAM,MAAS,MAAM;IAClC,OAAO,IAAI,CAAC,EAAE,IAAI;AACpB;AAEO,eAAe,QAAQ,IAAY,EAAE,MAAc;IACxD,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,QAAQ,IAAI;IAC5B,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe;IACpB,OAAO,MAAM,KAAK,OAAO;AAC3B"}},
    {"offset": {"line": 113, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/index.ts"],"sourcesContent":["export * from './client';\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 127, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/headquarters/purchase-orders/%5Bid%5D/approve/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { query } from \"@/lib/db\"\nimport { cookies } from \"next/headers\"\n\nasync function getSessionUser(): Promise<any | null> {\n  try {\n    const cookieStore = await cookies()\n    const sessionCookie = cookieStore.get(\"user_session\")\n    if (!sessionCookie?.value) return null\n    return JSON.parse(sessionCookie.value)\n  } catch {\n    return null\n  }\n}\n\nasync function getUserVendorId(userId: string): Promise<string | null> {\n  const userVendor = await query(\n    `SELECT v.id FROM users u \n     JOIN vendors v ON v.email = u.email \n     WHERE u.id = $1`,\n    [userId]\n  )\n  if (userVendor && userVendor.length > 0) {\n    return userVendor[0].id\n  }\n\n  const staffVendor = await query(\n    `SELECT DISTINCT b.vendor_id FROM staff s\n     JOIN branches b ON s.branch_id = b.id\n     WHERE s.user_id = $1 AND b.vendor_id IS NOT NULL`,\n    [userId]\n  )\n  if (staffVendor && staffVendor.length > 0) {\n    return staffVendor[0].vendor_id\n  }\n\n  return null\n}\n\nasync function getUserRoleAndHQAccess(userId: string, vendorId: string): Promise<{ role: string | null, hasHQAccess: boolean }> {\n  const userResult = await query(\n    `SELECT u.role, v.id as vendor_id \n     FROM users u \n     LEFT JOIN vendors v ON v.email = u.email\n     WHERE u.id = $1`,\n    [userId]\n  )\n  \n  if (userResult && userResult.length > 0) {\n    if (userResult[0].vendor_id === vendorId) {\n      return { role: userResult[0].role, hasHQAccess: true }\n    }\n    return { role: userResult[0].role, hasHQAccess: false }\n  }\n  return { role: null, hasHQAccess: false }\n}\n\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const user = await getSessionUser()\n    if (!user?.id) {\n      return NextResponse.json({ success: false, error: \"Unauthorized\" }, { status: 401 })\n    }\n\n    const vendorId = await getUserVendorId(user.id)\n    if (!vendorId) {\n      return NextResponse.json({ success: false, error: \"No vendor found for user\" }, { status: 403 })\n    }\n\n    const { role: userRole } = await getUserRoleAndHQAccess(user.id, vendorId)\n    const allowedRoles = ['vendor', 'manager', 'director', 'admin', 'owner']\n    \n    if (!userRole || !allowedRoles.includes(userRole.toLowerCase())) {\n      return NextResponse.json({ \n        success: false, \n        error: \"You don't have permission to approve purchase orders\" \n      }, { status: 403 })\n    }\n\n    const { id } = await params\n    const body = await request.json()\n    const { action, rejection_comments } = body\n\n    if (!action || !['approve', 'reject'].includes(action)) {\n      return NextResponse.json({ success: false, error: \"Invalid action\" }, { status: 400 })\n    }\n\n    const existing = await query(\n      `SELECT id, approval_status FROM purchase_orders WHERE id = $1 AND vendor_id = $2`,\n      [id, vendorId]\n    )\n\n    if (!existing || existing.length === 0) {\n      return NextResponse.json({ success: false, error: \"Purchase order not found\" }, { status: 404 })\n    }\n\n    if (existing[0].approval_status !== 'pending_approval') {\n      return NextResponse.json({ \n        success: false, \n        error: \"This purchase order has already been processed\" \n      }, { status: 400 })\n    }\n\n    if (action === 'approve') {\n      await query(\n        `UPDATE purchase_orders \n         SET approval_status = 'approved', \n             status = 'pending',\n             approved_by = $1, \n             approved_at = NOW(),\n             updated_at = NOW()\n         WHERE id = $2`,\n        [user.id, id]\n      )\n\n      return NextResponse.json({ \n        success: true, \n        message: \"Purchase order approved successfully\" \n      })\n    } else {\n      if (!rejection_comments) {\n        return NextResponse.json({ \n          success: false, \n          error: \"Rejection comments are required\" \n        }, { status: 400 })\n      }\n\n      await query(\n        `UPDATE purchase_orders \n         SET approval_status = 'rejected', \n             status = 'cancelled',\n             approved_by = $1, \n             approved_at = NOW(),\n             rejection_comments = $2,\n             updated_at = NOW()\n         WHERE id = $3`,\n        [user.id, rejection_comments, id]\n      )\n\n      return NextResponse.json({ \n        success: true, \n        message: \"Purchase order rejected\" \n      })\n    }\n  } catch (error) {\n    console.error(\"Error processing approval:\", error)\n    return NextResponse.json({ success: false, error: \"Failed to process approval\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}