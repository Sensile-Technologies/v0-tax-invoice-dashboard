{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/auth/signin/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\nimport bcrypt from \"bcryptjs\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nexport async function POST(request: Request) {\n  try {\n    const { email, password, username } = await request.json()\n\n    if (!password || (!email && !username)) {\n      return NextResponse.json(\n        { error: { message: \"Email/username and password are required\" } },\n        { status: 400 }\n      )\n    }\n\n    const client = await pool.connect()\n\n    try {\n      let user\n      if (email) {\n        const result = await client.query(\n          \"SELECT u.id, u.email, u.username, u.password_hash, u.role, v.id as vendor_id, v.name as vendor_name FROM users u LEFT JOIN vendors v ON v.email = u.email WHERE u.email = $1\",\n          [email]\n        )\n        user = result.rows[0]\n      } else {\n        const result = await client.query(\n          \"SELECT u.id, u.email, u.username, u.password_hash, u.role, v.id as vendor_id, v.name as vendor_name FROM users u LEFT JOIN vendors v ON v.email = u.email WHERE u.username = $1\",\n          [username]\n        )\n        user = result.rows[0]\n      }\n\n      if (!user) {\n        return NextResponse.json(\n          { error: { message: \"Invalid credentials\" } },\n          { status: 401 }\n        )\n      }\n\n      if (!user.password_hash) {\n        return NextResponse.json(\n          { error: { message: \"Password not set for this account\" } },\n          { status: 401 }\n        )\n      }\n\n      const isValid = await bcrypt.compare(password, user.password_hash)\n\n      if (!isValid) {\n        return NextResponse.json(\n          { error: { message: \"Invalid credentials\" } },\n          { status: 401 }\n        )\n      }\n\n      const token = crypto.randomUUID()\n\n      return NextResponse.json({\n        access_token: token,\n        refresh_token: crypto.randomUUID(),\n        user: {\n          id: user.id,\n          email: user.email,\n          username: user.username,\n          role: user.role || 'vendor',\n          vendor_id: user.vendor_id,\n          vendor_name: user.vendor_name\n        }\n      })\n    } finally {\n      client.release()\n    }\n  } catch (error) {\n    console.error(\"[API] Sign in error:\", error)\n    return NextResponse.json(\n      { error: { message: \"Failed to sign in\" } },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;AAC5C;AAEO,eAAe,KAAK,OAAgB;IACzC,IAAI;QACF,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,QAAQ,EAAE,GAAG,MAAM,QAAQ,IAAI;QAExD,IAAI,CAAC,YAAa,CAAC,SAAS,CAAC,UAAW;YACtC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;oBAAE,SAAS;gBAA2C;YAAE,GACjE;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,SAAS,MAAM,KAAK,OAAO;QAEjC,IAAI;YACF,IAAI;YACJ,IAAI,OAAO;gBACT,MAAM,SAAS,MAAM,OAAO,KAAK,CAC/B,gLACA;oBAAC;iBAAM;gBAET,OAAO,OAAO,IAAI,CAAC,EAAE;YACvB,OAAO;gBACL,MAAM,SAAS,MAAM,OAAO,KAAK,CAC/B,mLACA;oBAAC;iBAAS;gBAEZ,OAAO,OAAO,IAAI,CAAC,EAAE;YACvB;YAEA,IAAI,CAAC,MAAM;gBACT,OAAO,gJAAY,CAAC,IAAI,CACtB;oBAAE,OAAO;wBAAE,SAAS;oBAAsB;gBAAE,GAC5C;oBAAE,QAAQ;gBAAI;YAElB;YAEA,IAAI,CAAC,KAAK,aAAa,EAAE;gBACvB,OAAO,gJAAY,CAAC,IAAI,CACtB;oBAAE,OAAO;wBAAE,SAAS;oBAAoC;gBAAE,GAC1D;oBAAE,QAAQ;gBAAI;YAElB;YAEA,MAAM,UAAU,MAAM,8IAAM,CAAC,OAAO,CAAC,UAAU,KAAK,aAAa;YAEjE,IAAI,CAAC,SAAS;gBACZ,OAAO,gJAAY,CAAC,IAAI,CACtB;oBAAE,OAAO;wBAAE,SAAS;oBAAsB;gBAAE,GAC5C;oBAAE,QAAQ;gBAAI;YAElB;YAEA,MAAM,QAAQ,OAAO,UAAU;YAE/B,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,cAAc;gBACd,eAAe,OAAO,UAAU;gBAChC,MAAM;oBACJ,IAAI,KAAK,EAAE;oBACX,OAAO,KAAK,KAAK;oBACjB,UAAU,KAAK,QAAQ;oBACvB,MAAM,KAAK,IAAI,IAAI;oBACnB,WAAW,KAAK,SAAS;oBACzB,aAAa,KAAK,WAAW;gBAC/B;YACF;QACF,SAAU;YACR,OAAO,OAAO;QAChB;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,wBAAwB;QACtC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;gBAAE,SAAS;YAAoB;QAAE,GAC1C;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}