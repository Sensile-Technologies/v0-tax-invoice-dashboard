{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/reports/fiscal/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\nimport { cookies } from \"next/headers\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nexport async function GET(request: NextRequest) {\n  try {\n    // Try to get session, but don't fail if unavailable (for debugging)\n    let session: any = {}\n    try {\n      const cookieStore = await cookies()\n      const sessionCookie = cookieStore.get('user_session')\n      if (sessionCookie?.value) {\n        session = JSON.parse(sessionCookie.value)\n      }\n    } catch (e) {\n      console.log('[Fiscal] Session parse error:', e)\n    }\n\n    const { searchParams } = new URL(request.url)\n    const reportType = searchParams.get('type') || 'x'\n    const branchId = searchParams.get('branch_id') || session.branch_id\n    const fromDate = searchParams.get('from_date')\n    const toDate = searchParams.get('to_date')\n    const fromTime = searchParams.get('from_time') || '00:00:00'\n    const toTime = searchParams.get('to_time') || '23:59:59'\n    const shiftId = searchParams.get('shift_id')\n\n    if (!branchId) {\n      return NextResponse.json({ error: \"branch_id is required\" }, { status: 400 })\n    }\n\n    const branchResult = await pool.query(\n      `SELECT b.*, v.name as vendor_name, v.kra_pin as vendor_pin\n       FROM branches b\n       LEFT JOIN vendors v ON b.vendor_id = v.id\n       WHERE b.id = $1`,\n      [branchId]\n    )\n    \n    if (branchResult.rows.length === 0) {\n      return NextResponse.json({ error: \"Branch not found\" }, { status: 404 })\n    }\n    \n    const branch = branchResult.rows[0]\n\n    let dateFilter = \"\"\n    const params: any[] = [branchId]\n    let paramIndex = 2\n\n    if (shiftId) {\n      dateFilter = ` AND s.shift_id = $${paramIndex}`\n      params.push(shiftId)\n      paramIndex++\n    } else if (fromDate && toDate) {\n      const startDateTime = `${fromDate} ${fromTime}`\n      const endDateTime = `${toDate} ${toTime}`\n      dateFilter = ` AND s.sale_date >= $${paramIndex} AND s.sale_date <= $${paramIndex + 1}`\n      params.push(startDateTime, endDateTime)\n      paramIndex += 2\n    } else if (fromDate) {\n      const startDateTime = `${fromDate} ${fromTime}`\n      dateFilter = ` AND s.sale_date >= $${paramIndex}`\n      params.push(startDateTime)\n      paramIndex++\n    } else {\n      const today = new Date().toISOString().split('T')[0]\n      dateFilter = ` AND DATE(s.sale_date) = $${paramIndex}`\n      params.push(today)\n      paramIndex++\n    }\n\n    const salesQuery = `\n      SELECT \n        COALESCE(SUM(CASE WHEN NOT COALESCE(s.is_credit_note, false) THEN s.total_amount ELSE 0 END), 0) as gross_sales,\n        COALESCE(SUM(CASE WHEN COALESCE(s.is_credit_note, false) THEN s.total_amount ELSE 0 END), 0) as returns,\n        COUNT(*) FILTER (WHERE NOT COALESCE(s.is_credit_note, false)) as transaction_count,\n        COUNT(*) FILTER (WHERE COALESCE(s.is_credit_note, false)) as voided_count\n      FROM sales s\n      WHERE s.branch_id = $1 ${dateFilter}\n    `\n    const salesResult = await pool.query(salesQuery, params)\n    const salesData = salesResult.rows[0]\n\n    const paymentQuery = `\n      SELECT \n        COALESCE(s.payment_method, 'Cash') as method,\n        COALESCE(SUM(s.total_amount), 0) as amount,\n        COUNT(*) as count\n      FROM sales s\n      WHERE s.branch_id = $1 AND NOT COALESCE(s.is_credit_note, false) ${dateFilter}\n      GROUP BY s.payment_method\n      ORDER BY amount DESC\n    `\n    const paymentResult = await pool.query(paymentQuery, params)\n\n    const vatQuery = `\n      WITH sale_tax_types AS (\n        SELECT \n          s.id as sale_id,\n          s.total_amount,\n          COALESCE(\n            (SELECT i.tax_type FROM items i WHERE i.id = s.item_id LIMIT 1),\n            'B'\n          ) as tax_type\n        FROM sales s\n        WHERE s.branch_id = $1 AND NOT COALESCE(s.is_credit_note, false) ${dateFilter}\n      )\n      SELECT \n        CASE \n          WHEN tax_type = 'A' THEN 'A - Exempt'\n          WHEN tax_type = 'B' THEN 'B - 16% VAT'\n          WHEN tax_type = 'C' THEN 'C - Zero Rated'\n          WHEN tax_type = 'D' THEN 'D - Non-VAT'\n          ELSE 'B - 16% VAT'\n        END as category,\n        CASE \n          WHEN tax_type = 'B' THEN COALESCE(SUM(total_amount / 1.16), 0)\n          ELSE COALESCE(SUM(total_amount), 0)\n        END as taxable_amount,\n        CASE \n          WHEN tax_type = 'B' THEN COALESCE(SUM(total_amount - (total_amount / 1.16)), 0)\n          ELSE 0\n        END as vat_amount,\n        COALESCE(SUM(total_amount), 0) as total\n      FROM sale_tax_types\n      GROUP BY tax_type\n      ORDER BY category\n    `\n    const vatResult = await pool.query(vatQuery, params)\n\n    let vatBreakdown = vatResult.rows.map(row => ({\n      category: row.category,\n      taxableAmount: parseFloat(row.taxable_amount) || 0,\n      vatAmount: parseFloat(row.vat_amount) || 0,\n      total: parseFloat(row.total) || 0\n    }))\n\n    if (vatBreakdown.length === 0) {\n      vatBreakdown = [\n        { category: \"A - Exempt\", taxableAmount: 0, vatAmount: 0, total: 0 },\n        { category: \"B - 16% VAT\", taxableAmount: 0, vatAmount: 0, total: 0 },\n        { category: \"C - Zero Rated\", taxableAmount: 0, vatAmount: 0, total: 0 },\n        { category: \"D - Non-VAT\", taxableAmount: 0, vatAmount: 0, total: 0 }\n      ]\n    }\n\n    const grossSales = parseFloat(salesData.gross_sales) || 0\n    const returns = parseFloat(salesData.returns) || 0\n    const netSales = grossSales - returns\n\n    let shiftInfo = null\n    if (shiftId) {\n      const shiftResult = await pool.query(\n        `SELECT s.*, st.full_name as cashier_name \n         FROM shifts s \n         LEFT JOIN staff st ON s.staff_id = st.id \n         WHERE s.id = $1`,\n        [shiftId]\n      )\n      if (shiftResult.rows.length > 0) {\n        shiftInfo = shiftResult.rows[0]\n      }\n    } else {\n      const activeShiftResult = await pool.query(\n        `SELECT s.*, st.full_name as cashier_name \n         FROM shifts s \n         LEFT JOIN staff st ON s.staff_id = st.id \n         WHERE s.branch_id = $1 AND s.status = 'active'\n         ORDER BY s.start_time DESC LIMIT 1`,\n        [branchId]\n      )\n      if (activeShiftResult.rows.length > 0) {\n        shiftInfo = activeShiftResult.rows[0]\n      }\n    }\n\n    const now = new Date()\n    const reportNumber = reportType === 'z' \n      ? `Z-${now.getFullYear()}-${String(now.getMonth() + 1).padStart(3, '0')}-${String(now.getDate()).padStart(3, '0')}`\n      : `X-${now.getFullYear()}-${String(now.getMonth() + 1).padStart(3, '0')}-${String(now.getDate()).padStart(2, '0')}`\n\n    const cumulativeQuery = `\n      SELECT COALESCE(SUM(total_amount), 0) as cumulative_sales\n      FROM sales\n      WHERE branch_id = $1 AND NOT COALESCE(is_credit_note, false)\n    `\n    const cumulativeResult = await pool.query(cumulativeQuery, [branchId])\n    const cumulativeSales = parseFloat(cumulativeResult.rows[0]?.cumulative_sales) || 0\n\n    const kraTransmittedQuery = `\n      SELECT \n        COUNT(*) as kra_count,\n        COALESCE(SUM(s.total_amount), 0) as kra_gross,\n        COALESCE(SUM(CASE WHEN COALESCE(i.tax_type, 'B') = 'B' THEN s.total_amount / 1.16 ELSE s.total_amount END), 0) as kra_net,\n        COALESCE(SUM(CASE WHEN COALESCE(i.tax_type, 'B') = 'B' THEN s.total_amount - (s.total_amount / 1.16) ELSE 0 END), 0) as kra_vat\n      FROM sales s\n      LEFT JOIN items i ON s.item_id = i.id\n      WHERE s.branch_id = $1 \n        AND NOT COALESCE(s.is_credit_note, false)\n        AND (s.kra_status IN ('success', 'transmitted') OR s.transmission_status IN ('transmitted', 'sent'))\n        ${dateFilter}\n    `\n    const kraTransmittedResult = await pool.query(kraTransmittedQuery, params)\n    const kraData = kraTransmittedResult.rows[0] || {}\n    \n    const kraTransmittedSales = {\n      count: parseInt(kraData.kra_count) || 0,\n      gross: parseFloat(kraData.kra_gross) || 0,\n      net: parseFloat(kraData.kra_net) || 0,\n      vat: parseFloat(kraData.kra_vat) || 0\n    }\n\n    const reportData = {\n      reportType: reportType.toUpperCase(),\n      reportNumber,\n      fiscalNumber: branch.device_token ? `${branch.device_token}-${reportNumber}` : reportNumber,\n      date: now.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }),\n      time: now.toLocaleTimeString('en-US', { hour12: false }),\n      deviceSerial: branch.device_token || 'Not Configured',\n      branchName: branch.name,\n      vendorName: branch.vendor_name,\n      \n      cashier: shiftInfo?.cashier_name || 'N/A',\n      operator: shiftInfo?.cashier_name || 'Manager',\n      shiftStart: shiftInfo ? new Date(shiftInfo.start_time).toLocaleTimeString('en-US', { hour12: false }) : 'N/A',\n      shiftDuration: shiftInfo && shiftInfo.end_time \n        ? `${Math.round((new Date(shiftInfo.end_time).getTime() - new Date(shiftInfo.start_time).getTime()) / (1000 * 60 * 60))} hours`\n        : 'Active',\n\n      salesSummary: {\n        grossSales,\n        returns,\n        netSales\n      },\n\n      vatBreakdown,\n\n      paymentMethods: paymentResult.rows.map(row => ({\n        method: row.method || 'Cash',\n        amount: parseFloat(row.amount) || 0,\n        count: parseInt(row.count) || 0\n      })),\n\n      transactionCount: parseInt(salesData.transaction_count) || 0,\n      voidedTransactions: parseInt(salesData.voided_count) || 0,\n      voidedAmount: returns,\n\n      counters: {\n        totalTransactions: parseInt(salesData.transaction_count) || 0,\n        voidedTransactions: parseInt(salesData.voided_count) || 0,\n        cumulativeSales\n      },\n\n      kraTransmittedSales\n    }\n\n    return NextResponse.json({ success: true, data: reportData })\n\n  } catch (error: any) {\n    console.error(\"[Fiscal Report API] Error:\", error)\n    return NextResponse.json(\n      { error: \"Failed to generate fiscal report\", details: error.message },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;AAC5C;AAEO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,oEAAoE;QACpE,IAAI,UAAe,CAAC;QACpB,IAAI;YACF,MAAM,cAAc,MAAM,IAAA,4IAAO;YACjC,MAAM,gBAAgB,YAAY,GAAG,CAAC;YACtC,IAAI,eAAe,OAAO;gBACxB,UAAU,KAAK,KAAK,CAAC,cAAc,KAAK;YAC1C;QACF,EAAE,OAAO,GAAG;YACV,QAAQ,GAAG,CAAC,iCAAiC;QAC/C;QAEA,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,aAAa,aAAa,GAAG,CAAC,WAAW;QAC/C,MAAM,WAAW,aAAa,GAAG,CAAC,gBAAgB,QAAQ,SAAS;QACnE,MAAM,WAAW,aAAa,GAAG,CAAC;QAClC,MAAM,SAAS,aAAa,GAAG,CAAC;QAChC,MAAM,WAAW,aAAa,GAAG,CAAC,gBAAgB;QAClD,MAAM,SAAS,aAAa,GAAG,CAAC,cAAc;QAC9C,MAAM,UAAU,aAAa,GAAG,CAAC;QAEjC,IAAI,CAAC,UAAU;YACb,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAwB,GAAG;gBAAE,QAAQ;YAAI;QAC7E;QAEA,MAAM,eAAe,MAAM,KAAK,KAAK,CACnC,CAAC;;;sBAGe,CAAC,EACjB;YAAC;SAAS;QAGZ,IAAI,aAAa,IAAI,CAAC,MAAM,KAAK,GAAG;YAClC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAmB,GAAG;gBAAE,QAAQ;YAAI;QACxE;QAEA,MAAM,SAAS,aAAa,IAAI,CAAC,EAAE;QAEnC,IAAI,aAAa;QACjB,MAAM,SAAgB;YAAC;SAAS;QAChC,IAAI,aAAa;QAEjB,IAAI,SAAS;YACX,aAAa,CAAC,mBAAmB,EAAE,YAAY;YAC/C,OAAO,IAAI,CAAC;YACZ;QACF,OAAO,IAAI,YAAY,QAAQ;YAC7B,MAAM,gBAAgB,GAAG,SAAS,CAAC,EAAE,UAAU;YAC/C,MAAM,cAAc,GAAG,OAAO,CAAC,EAAE,QAAQ;YACzC,aAAa,CAAC,qBAAqB,EAAE,WAAW,qBAAqB,EAAE,aAAa,GAAG;YACvF,OAAO,IAAI,CAAC,eAAe;YAC3B,cAAc;QAChB,OAAO,IAAI,UAAU;YACnB,MAAM,gBAAgB,GAAG,SAAS,CAAC,EAAE,UAAU;YAC/C,aAAa,CAAC,qBAAqB,EAAE,YAAY;YACjD,OAAO,IAAI,CAAC;YACZ;QACF,OAAO;YACL,MAAM,QAAQ,IAAI,OAAO,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;YACpD,aAAa,CAAC,0BAA0B,EAAE,YAAY;YACtD,OAAO,IAAI,CAAC;YACZ;QACF;QAEA,MAAM,aAAa,CAAC;;;;;;;6BAOK,EAAE,WAAW;IACtC,CAAC;QACD,MAAM,cAAc,MAAM,KAAK,KAAK,CAAC,YAAY;QACjD,MAAM,YAAY,YAAY,IAAI,CAAC,EAAE;QAErC,MAAM,eAAe,CAAC;;;;;;uEAM6C,EAAE,WAAW;;;IAGhF,CAAC;QACD,MAAM,gBAAgB,MAAM,KAAK,KAAK,CAAC,cAAc;QAErD,MAAM,WAAW,CAAC;;;;;;;;;;yEAUmD,EAAE,WAAW;;;;;;;;;;;;;;;;;;;;;;IAsBlF,CAAC;QACD,MAAM,YAAY,MAAM,KAAK,KAAK,CAAC,UAAU;QAE7C,IAAI,eAAe,UAAU,IAAI,CAAC,GAAG,CAAC,CAAA,MAAO,CAAC;gBAC5C,UAAU,IAAI,QAAQ;gBACtB,eAAe,WAAW,IAAI,cAAc,KAAK;gBACjD,WAAW,WAAW,IAAI,UAAU,KAAK;gBACzC,OAAO,WAAW,IAAI,KAAK,KAAK;YAClC,CAAC;QAED,IAAI,aAAa,MAAM,KAAK,GAAG;YAC7B,eAAe;gBACb;oBAAE,UAAU;oBAAc,eAAe;oBAAG,WAAW;oBAAG,OAAO;gBAAE;gBACnE;oBAAE,UAAU;oBAAe,eAAe;oBAAG,WAAW;oBAAG,OAAO;gBAAE;gBACpE;oBAAE,UAAU;oBAAkB,eAAe;oBAAG,WAAW;oBAAG,OAAO;gBAAE;gBACvE;oBAAE,UAAU;oBAAe,eAAe;oBAAG,WAAW;oBAAG,OAAO;gBAAE;aACrE;QACH;QAEA,MAAM,aAAa,WAAW,UAAU,WAAW,KAAK;QACxD,MAAM,UAAU,WAAW,UAAU,OAAO,KAAK;QACjD,MAAM,WAAW,aAAa;QAE9B,IAAI,YAAY;QAChB,IAAI,SAAS;YACX,MAAM,cAAc,MAAM,KAAK,KAAK,CAClC,CAAC;;;wBAGe,CAAC,EACjB;gBAAC;aAAQ;YAEX,IAAI,YAAY,IAAI,CAAC,MAAM,GAAG,GAAG;gBAC/B,YAAY,YAAY,IAAI,CAAC,EAAE;YACjC;QACF,OAAO;YACL,MAAM,oBAAoB,MAAM,KAAK,KAAK,CACxC,CAAC;;;;2CAIkC,CAAC,EACpC;gBAAC;aAAS;YAEZ,IAAI,kBAAkB,IAAI,CAAC,MAAM,GAAG,GAAG;gBACrC,YAAY,kBAAkB,IAAI,CAAC,EAAE;YACvC;QACF;QAEA,MAAM,MAAM,IAAI;QAChB,MAAM,eAAe,eAAe,MAChC,CAAC,EAAE,EAAE,IAAI,WAAW,GAAG,CAAC,EAAE,OAAO,IAAI,QAAQ,KAAK,GAAG,QAAQ,CAAC,GAAG,KAAK,CAAC,EAAE,OAAO,IAAI,OAAO,IAAI,QAAQ,CAAC,GAAG,MAAM,GACjH,CAAC,EAAE,EAAE,IAAI,WAAW,GAAG,CAAC,EAAE,OAAO,IAAI,QAAQ,KAAK,GAAG,QAAQ,CAAC,GAAG,KAAK,CAAC,EAAE,OAAO,IAAI,OAAO,IAAI,QAAQ,CAAC,GAAG,MAAM;QAErH,MAAM,kBAAkB,CAAC;;;;IAIzB,CAAC;QACD,MAAM,mBAAmB,MAAM,KAAK,KAAK,CAAC,iBAAiB;YAAC;SAAS;QACrE,MAAM,kBAAkB,WAAW,iBAAiB,IAAI,CAAC,EAAE,EAAE,qBAAqB;QAElF,MAAM,sBAAsB,CAAC;;;;;;;;;;;QAWzB,EAAE,WAAW;IACjB,CAAC;QACD,MAAM,uBAAuB,MAAM,KAAK,KAAK,CAAC,qBAAqB;QACnE,MAAM,UAAU,qBAAqB,IAAI,CAAC,EAAE,IAAI,CAAC;QAEjD,MAAM,sBAAsB;YAC1B,OAAO,SAAS,QAAQ,SAAS,KAAK;YACtC,OAAO,WAAW,QAAQ,SAAS,KAAK;YACxC,KAAK,WAAW,QAAQ,OAAO,KAAK;YACpC,KAAK,WAAW,QAAQ,OAAO,KAAK;QACtC;QAEA,MAAM,aAAa;YACjB,YAAY,WAAW,WAAW;YAClC;YACA,cAAc,OAAO,YAAY,GAAG,GAAG,OAAO,YAAY,CAAC,CAAC,EAAE,cAAc,GAAG;YAC/E,MAAM,IAAI,kBAAkB,CAAC,SAAS;gBAAE,OAAO;gBAAQ,KAAK;gBAAW,MAAM;YAAU;YACvF,MAAM,IAAI,kBAAkB,CAAC,SAAS;gBAAE,QAAQ;YAAM;YACtD,cAAc,OAAO,YAAY,IAAI;YACrC,YAAY,OAAO,IAAI;YACvB,YAAY,OAAO,WAAW;YAE9B,SAAS,WAAW,gBAAgB;YACpC,UAAU,WAAW,gBAAgB;YACrC,YAAY,YAAY,IAAI,KAAK,UAAU,UAAU,EAAE,kBAAkB,CAAC,SAAS;gBAAE,QAAQ;YAAM,KAAK;YACxG,eAAe,aAAa,UAAU,QAAQ,GAC1C,GAAG,KAAK,KAAK,CAAC,CAAC,IAAI,KAAK,UAAU,QAAQ,EAAE,OAAO,KAAK,IAAI,KAAK,UAAU,UAAU,EAAE,OAAO,EAAE,IAAI,CAAC,OAAO,KAAK,EAAE,GAAG,MAAM,CAAC,GAC7H;YAEJ,cAAc;gBACZ;gBACA;gBACA;YACF;YAEA;YAEA,gBAAgB,cAAc,IAAI,CAAC,GAAG,CAAC,CAAA,MAAO,CAAC;oBAC7C,QAAQ,IAAI,MAAM,IAAI;oBACtB,QAAQ,WAAW,IAAI,MAAM,KAAK;oBAClC,OAAO,SAAS,IAAI,KAAK,KAAK;gBAChC,CAAC;YAED,kBAAkB,SAAS,UAAU,iBAAiB,KAAK;YAC3D,oBAAoB,SAAS,UAAU,YAAY,KAAK;YACxD,cAAc;YAEd,UAAU;gBACR,mBAAmB,SAAS,UAAU,iBAAiB,KAAK;gBAC5D,oBAAoB,SAAS,UAAU,YAAY,KAAK;gBACxD;YACF;YAEA;QACF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM,MAAM;QAAW;IAE7D,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;YAAoC,SAAS,MAAM,OAAO;QAAC,GACpE;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}