{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/fuel-prices/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const branchId = searchParams.get('branch_id')\n\n    if (!branchId) {\n      // No branch specified - return empty or all from fuel_prices table\n      const result = await pool.query('SELECT * FROM fuel_prices ORDER BY effective_date DESC')\n      return NextResponse.json({ success: true, data: result.rows })\n    }\n\n    // PRIMARY SOURCE: Get fuel prices from branch_items (what Inventory Management updates)\n    const branchItemsResult = await pool.query(\n      `SELECT DISTINCT ON (\n         CASE \n           WHEN UPPER(i.item_name) LIKE '%DIESEL%' THEN 'Diesel'\n           WHEN UPPER(i.item_name) LIKE '%PETROL%' OR UPPER(i.item_name) LIKE '%SUPER%' THEN 'Petrol'\n           WHEN UPPER(i.item_name) LIKE '%KEROSENE%' THEN 'Kerosene'\n           ELSE i.item_name\n         END\n       )\n         CASE \n           WHEN UPPER(i.item_name) LIKE '%DIESEL%' THEN 'Diesel'\n           WHEN UPPER(i.item_name) LIKE '%PETROL%' OR UPPER(i.item_name) LIKE '%SUPER%' THEN 'Petrol'\n           WHEN UPPER(i.item_name) LIKE '%KEROSENE%' THEN 'Kerosene'\n           ELSE i.item_name\n         END as fuel_type,\n         COALESCE(bi.sale_price, i.sale_price) as price,\n         bi.updated_at as effective_date,\n         $1::uuid as branch_id\n       FROM branch_items bi\n       JOIN items i ON bi.item_id = i.id\n       WHERE bi.branch_id = $1\n         AND bi.is_available = true\n         AND (UPPER(i.item_name) IN ('PETROL', 'DIESEL', 'KEROSENE', 'SUPER PETROL', 'V-POWER') \n              OR i.item_name ILIKE '%petrol%' \n              OR i.item_name ILIKE '%diesel%'\n              OR i.item_name ILIKE '%kerosene%')\n       ORDER BY \n         CASE \n           WHEN UPPER(i.item_name) LIKE '%DIESEL%' THEN 'Diesel'\n           WHEN UPPER(i.item_name) LIKE '%PETROL%' OR UPPER(i.item_name) LIKE '%SUPER%' THEN 'Petrol'\n           WHEN UPPER(i.item_name) LIKE '%KEROSENE%' THEN 'Kerosene'\n           ELSE i.item_name\n         END,\n         bi.updated_at DESC NULLS LAST`,\n      [branchId]\n    )\n\n    // If we found prices in branch_items, use those\n    if (branchItemsResult.rows.length > 0) {\n      return NextResponse.json({\n        success: true,\n        data: branchItemsResult.rows\n      })\n    }\n\n    // FALLBACK: Check legacy fuel_prices table\n    const legacyResult = await pool.query(\n      'SELECT * FROM fuel_prices WHERE branch_id = $1 ORDER BY effective_date DESC',\n      [branchId]\n    )\n\n    return NextResponse.json({\n      success: true,\n      data: legacyResult.rows\n    })\n\n  } catch (error: any) {\n    console.error(\"Error fetching fuel prices:\", error)\n    return NextResponse.json(\n      { error: \"Failed to fetch fuel prices\", details: error.message },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;AAC5C;AAEO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,WAAW,aAAa,GAAG,CAAC;QAElC,IAAI,CAAC,UAAU;YACb,mEAAmE;YACnE,MAAM,SAAS,MAAM,KAAK,KAAK,CAAC;YAChC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAM,MAAM,OAAO,IAAI;YAAC;QAC9D;QAEA,wFAAwF;QACxF,MAAM,oBAAoB,MAAM,KAAK,KAAK,CACxC,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;sCAgC+B,CAAC,EACjC;YAAC;SAAS;QAGZ,gDAAgD;QAChD,IAAI,kBAAkB,IAAI,CAAC,MAAM,GAAG,GAAG;YACrC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,SAAS;gBACT,MAAM,kBAAkB,IAAI;YAC9B;QACF;QAEA,2CAA2C;QAC3C,MAAM,eAAe,MAAM,KAAK,KAAK,CACnC,+EACA;YAAC;SAAS;QAGZ,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,MAAM,aAAa,IAAI;QACzB;IAEF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,+BAA+B;QAC7C,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;YAA+B,SAAS,MAAM,OAAO;QAAC,GAC/D;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}