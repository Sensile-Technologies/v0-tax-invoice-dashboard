{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/activity-logger.ts"],"sourcesContent":["import { Pool } from \"pg\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nexport interface ActivityLogEntry {\n  userId?: string\n  userEmail?: string\n  userName?: string\n  branchId?: string\n  branchName?: string\n  vendorId?: string\n  action: string\n  resourceType?: string\n  resourceId?: string\n  details?: Record<string, any>\n  ipAddress?: string\n  userAgent?: string\n}\n\nexport async function logActivity(entry: ActivityLogEntry): Promise<void> {\n  try {\n    await pool.query(\n      `INSERT INTO activity_logs \n        (user_id, user_email, user_name, branch_id, branch_name, vendor_id, action, resource_type, resource_id, details, ip_address, user_agent)\n       VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12)`,\n      [\n        entry.userId || null,\n        entry.userEmail || null,\n        entry.userName || null,\n        entry.branchId || null,\n        entry.branchName || null,\n        entry.vendorId || null,\n        entry.action,\n        entry.resourceType || null,\n        entry.resourceId || null,\n        entry.details ? JSON.stringify(entry.details) : null,\n        entry.ipAddress || null,\n        entry.userAgent || null\n      ]\n    )\n  } catch (error) {\n    console.error(\"[ActivityLogger] Failed to log activity:\", error)\n  }\n}\n\nexport function getClientInfo(request: Request): { ipAddress: string, userAgent: string } {\n  const forwarded = request.headers.get('x-forwarded-for')\n  const ipAddress = forwarded ? forwarded.split(',')[0].trim() : 'unknown'\n  const userAgent = request.headers.get('user-agent') || 'unknown'\n  return { ipAddress, userAgent }\n}\n"],"names":[],"mappings":";;;;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;AAC5C;AAiBO,eAAe,YAAY,KAAuB;IACvD,IAAI;QACF,MAAM,KAAK,KAAK,CACd,CAAC;;iEAE0D,CAAC,EAC5D;YACE,MAAM,MAAM,IAAI;YAChB,MAAM,SAAS,IAAI;YACnB,MAAM,QAAQ,IAAI;YAClB,MAAM,QAAQ,IAAI;YAClB,MAAM,UAAU,IAAI;YACpB,MAAM,QAAQ,IAAI;YAClB,MAAM,MAAM;YACZ,MAAM,YAAY,IAAI;YACtB,MAAM,UAAU,IAAI;YACpB,MAAM,OAAO,GAAG,KAAK,SAAS,CAAC,MAAM,OAAO,IAAI;YAChD,MAAM,SAAS,IAAI;YACnB,MAAM,SAAS,IAAI;SACpB;IAEL,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,4CAA4C;IAC5D;AACF;AAEO,SAAS,cAAc,OAAgB;IAC5C,MAAM,YAAY,QAAQ,OAAO,CAAC,GAAG,CAAC;IACtC,MAAM,YAAY,YAAY,UAAU,KAAK,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,KAAK;IAC/D,MAAM,YAAY,QAAQ,OAAO,CAAC,GAAG,CAAC,iBAAiB;IACvD,OAAO;QAAE;QAAW;IAAU;AAChC"}},
    {"offset": {"line": 117, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/auth/signin/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\nimport bcrypt from \"bcryptjs\"\nimport { logActivity, getClientInfo } from \"@/lib/activity-logger\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nexport async function POST(request: Request) {\n  try {\n    const { email, password, username, domain } = await request.json()\n\n    if (!password || (!email && !username)) {\n      return NextResponse.json(\n        { error: { message: \"Email/username and password are required\" } },\n        { status: 400 }\n      )\n    }\n\n    const client = await pool.connect()\n\n    try {\n      // Check if this is a custom vendor domain\n      let domainVendorId: string | null = null\n      if (domain) {\n        const vendorResult = await client.query(\n          `SELECT id FROM vendors WHERE custom_domain = $1 AND status = 'active'`,\n          [domain]\n        )\n        if (vendorResult.rows.length > 0) {\n          domainVendorId = vendorResult.rows[0].id\n        }\n      }\n\n      let user\n      const identifier = email || username\n\n      if (identifier && identifier.includes(\"@\")) {\n        const salesResult = await client.query(\n          \"SELECT id, name, email, phone, is_active FROM sales_people WHERE email = $1 AND is_active = true\",\n          [identifier]\n        )\n        const salesPerson = salesResult.rows[0]\n\n        if (salesPerson && salesPerson.phone) {\n          const phoneDigits = salesPerson.phone.replace(/\\D/g, '')\n          const passwordDigits = password.replace(/\\D/g, '')\n          \n          if (phoneDigits.length >= 9 && passwordDigits.length >= 9 && phoneDigits === passwordDigits) {\n            const token = crypto.randomUUID()\n            const refreshToken = crypto.randomUUID()\n            const response = NextResponse.json({\n              access_token: token,\n              refresh_token: refreshToken,\n              user: {\n                id: salesPerson.id,\n                email: salesPerson.email,\n                username: salesPerson.name,\n                role: 'sales',\n                sales_person_id: salesPerson.id,\n                sales_person_name: salesPerson.name\n              }\n            })\n            response.cookies.set('sb-access-token', token, {\n              path: '/',\n              maxAge: 60 * 60 * 24 * 7,\n              sameSite: 'none',\n              secure: true,\n              httpOnly: false\n            })\n            response.cookies.set('sb-refresh-token', refreshToken, {\n              path: '/',\n              maxAge: 60 * 60 * 24 * 30,\n              sameSite: 'none',\n              secure: true,\n              httpOnly: false\n            })\n            return response\n          }\n        }\n      }\n\n      if (email) {\n        const result = await client.query(\n          `SELECT u.id, u.email, u.username, u.password_hash, u.must_change_password,\n           COALESCE(s.role, u.role) as role,\n           COALESCE(v.id, b.vendor_id) as vendor_id, \n           COALESCE(v.name, sv.name) as vendor_name,\n           COALESCE(s.branch_id, vb.id) as branch_id, \n           COALESCE(b.name, vb.name) as branch_name,\n           COALESCE(b.bhf_id, vb.bhf_id) as bhf_id\n           FROM users u \n           LEFT JOIN vendors v ON v.email = u.email \n           LEFT JOIN staff s ON s.user_id = u.id\n           LEFT JOIN branches b ON b.id = s.branch_id\n           LEFT JOIN vendors sv ON sv.id = b.vendor_id\n           LEFT JOIN branches vb ON vb.vendor_id = v.id AND vb.is_main = true\n           WHERE u.email = $1`,\n          [email]\n        )\n        user = result.rows[0]\n      } else {\n        const result = await client.query(\n          `SELECT u.id, u.email, u.username, u.password_hash, u.must_change_password,\n           COALESCE(s.role, u.role) as role,\n           COALESCE(v.id, b.vendor_id) as vendor_id, \n           COALESCE(v.name, sv.name) as vendor_name,\n           COALESCE(s.branch_id, vb.id) as branch_id, \n           COALESCE(b.name, vb.name) as branch_name,\n           COALESCE(b.bhf_id, vb.bhf_id) as bhf_id\n           FROM users u \n           LEFT JOIN vendors v ON v.email = u.email \n           LEFT JOIN staff s ON s.user_id = u.id\n           LEFT JOIN branches b ON b.id = s.branch_id\n           LEFT JOIN vendors sv ON sv.id = b.vendor_id\n           LEFT JOIN branches vb ON vb.vendor_id = v.id AND vb.is_main = true\n           WHERE u.username = $1`,\n          [username]\n        )\n        user = result.rows[0]\n      }\n\n      if (!user) {\n        return NextResponse.json(\n          { error: { message: \"Invalid credentials\" } },\n          { status: 401 }\n        )\n      }\n\n      if (!user.password_hash) {\n        return NextResponse.json(\n          { error: { message: \"Password not set for this account\" } },\n          { status: 401 }\n        )\n      }\n\n      const isValid = await bcrypt.compare(password, user.password_hash)\n\n      if (!isValid) {\n        return NextResponse.json(\n          { error: { message: \"Invalid credentials\" } },\n          { status: 401 }\n        )\n      }\n\n      // Block cashiers from web dashboard - they can only use the mobile APK\n      if (user.role && user.role.toLowerCase() === 'cashier') {\n        return NextResponse.json(\n          { error: { message: \"Cashiers can only access the system through the mobile app. Please use the Flow360 mobile application.\" } },\n          { status: 403 }\n        )\n      }\n\n      // Block login from custom vendor domain if user doesn't belong to that vendor\n      // Admin users are exempt from this check\n      if (domainVendorId && user.vendor_id && user.vendor_id !== domainVendorId && user.role !== 'admin') {\n        return NextResponse.json(\n          { error: { message: \"Access denied. Your account is not authorized to access this domain. Please use your organization's login portal.\" } },\n          { status: 403 }\n        )\n      }\n\n      // Check if vendor's branch has been activated (device_token configured)\n      // Only applies to vendors, not admin or sales users\n      if (user.vendor_id && user.branch_id) {\n        const branchResult = await client.query(\n          \"SELECT device_token FROM branches WHERE id = $1\",\n          [user.branch_id]\n        )\n        const branch = branchResult.rows[0]\n        \n        if (!branch || !branch.device_token) {\n          return NextResponse.json(\n            { error: { message: \"Your account is pending activation. Please contact admin to complete your onboarding.\" } },\n            { status: 403 }\n          )\n        }\n      }\n\n      const token = crypto.randomUUID()\n      const refreshToken = crypto.randomUUID()\n\n      const response = NextResponse.json({\n        access_token: token,\n        refresh_token: refreshToken,\n        must_change_password: user.must_change_password || false,\n        user: {\n          id: user.id,\n          email: user.email,\n          username: user.username,\n          role: user.role || 'vendor',\n          vendor_id: user.vendor_id,\n          vendor_name: user.vendor_name,\n          branch_id: user.branch_id,\n          branch_name: user.branch_name,\n          bhf_id: user.bhf_id\n        }\n      })\n      \n      response.cookies.set('sb-access-token', token, {\n        path: '/',\n        maxAge: 60 * 60 * 24 * 7,\n        sameSite: 'none',\n        secure: true,\n        httpOnly: false\n      })\n      response.cookies.set('sb-refresh-token', refreshToken, {\n        path: '/',\n        maxAge: 60 * 60 * 24 * 30,\n        sameSite: 'none',\n        secure: true,\n        httpOnly: false\n      })\n      response.cookies.set('user_session', JSON.stringify({\n        id: user.id,\n        email: user.email,\n        vendor_id: user.vendor_id,\n        branch_id: user.branch_id,\n        role: user.role || 'vendor'\n      }), {\n        path: '/',\n        maxAge: 60 * 60 * 24 * 7,\n        sameSite: 'none',\n        secure: true,\n        httpOnly: true\n      })\n      \n      const clientInfo = getClientInfo(request)\n      logActivity({\n        userId: user.id,\n        userEmail: user.email,\n        userName: user.username,\n        branchId: user.branch_id,\n        branchName: user.branch_name,\n        vendorId: user.vendor_id,\n        action: 'LOGIN',\n        resourceType: 'auth',\n        details: { role: user.role || 'vendor' },\n        ...clientInfo\n      })\n      \n      return response\n    } finally {\n      client.release()\n    }\n  } catch (error) {\n    console.error(\"[API] Sign in error:\", error)\n    return NextResponse.json(\n      { error: { message: \"Failed to sign in\" } },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":"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"}}]
}