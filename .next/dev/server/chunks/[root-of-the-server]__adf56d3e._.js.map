{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/client.ts"],"sourcesContent":["import { Pool } from 'pg';\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,\n});\n\nexport async function query<T = any>(text: string, params?: any[]): Promise<T[]> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rows as T[];\n  } finally {\n    client.release();\n  }\n}\n\nexport async function queryOne<T = any>(text: string, params?: any[]): Promise<T | null> {\n  const rows = await query<T>(text, params);\n  return rows[0] || null;\n}\n\nexport async function execute(text: string, params?: any[]): Promise<number> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rowCount || 0;\n  } finally {\n    client.release();\n  }\n}\n\nexport { pool };\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,sCAAwC,0BAAgC;AAC/E;AAEO,eAAe,MAAe,IAAY,EAAE,MAAc;IAC/D,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,IAAI;IACpB,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe,SAAkB,IAAY,EAAE,MAAc;IAClE,MAAM,OAAO,MAAM,MAAS,MAAM;IAClC,OAAO,IAAI,CAAC,EAAE,IAAI;AACpB;AAEO,eAAe,QAAQ,IAAY,EAAE,MAAc;IACxD,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,QAAQ,IAAI;IAC5B,SAAU;QACR,OAAO,OAAO;IAChB;AACF"}},
    {"offset": {"line": 108, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/index.ts"],"sourcesContent":["export * from './client';\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 122, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/kra-stock-service.ts"],"sourcesContent":["import { query } from \"@/lib/db\"\n\nconst KRA_BASE_URL = \"http://20.224.40.56:8088\"\nconst STOCK_ENDPOINT = \"/stock/saveStockItems\"\n\nexport interface StockItem {\n  itemSeq: number\n  itemCd: string\n  itemClsCd: string\n  itemNm: string\n  bcd: string | null\n  pkgUnitCd: string\n  pkg: number\n  qtyUnitCd: string\n  qty: number\n  itemExprDt: string | null\n  prc: number\n  splyAmt: number\n  totDcAmt: number\n  taxblAmt: number\n  taxTyCd: string\n  taxAmt: number\n  totAmt: number\n}\n\nexport interface StockPayload {\n  tin: string\n  bhfId: string\n  sarNo: number\n  orgSarNo: number\n  regTyCd: string\n  custTin: string | null\n  custNm: string | null\n  custBhfId: string | null\n  sarTyCd: string\n  ocrnDt: string\n  totItemCnt: number\n  totTaxblAmt: number\n  totTaxAmt: number\n  totAmt: number\n  remark: string | null\n  regrId: string\n  regrNm: string\n  modrNm: string\n  modrId: string\n  itemList: StockItem[]\n}\n\nexport type StockMovementType = \n  | \"initial_stock\"      // Tank created with initial stock\n  | \"stock_receive\"      // Stock received into tank\n  | \"stock_adjustment\"   // Manual adjustment (gain/loss)\n  | \"stock_transfer\"     // Transfer between tanks\n  | \"sale\"               // Sale deducting from stock\n\nexport const SAR_TYPE_CODES = {\n  initial_stock: \"01\",      // Opening/Initial Stock\n  stock_receive: \"02\",      // Stock Received/Purchase\n  stock_adjustment: \"06\",   // Stock Adjustment\n  stock_transfer: \"05\",     // Stock Transfer\n  sale: \"11\"                // Sale\n}\n\nexport async function getNextSarNo(branchId: string, endpoint: string = STOCK_ENDPOINT): Promise<number> {\n  const result = await query(`\n    UPDATE branches \n    SET sr_number = COALESCE(sr_number, 0) + 1,\n        updated_at = NOW()\n    WHERE id = $1\n    RETURNING sr_number\n  `, [branchId])\n  \n  if (result.length === 0) {\n    throw new Error(`Branch ${branchId} not found`)\n  }\n  \n  return result[0].sr_number\n}\n\nexport async function getBranchKraInfo(branchId: string): Promise<{ tin: string, bhfId: string } | null> {\n  const result = await query(`\n    SELECT b.kra_pin as tin, b.bhf_id \n    FROM branches b \n    WHERE b.id = $1\n  `, [branchId])\n  \n  if (result.length === 0) return null\n  \n  const branch = result[0]\n  if (!branch.tin) {\n    const vendorResult = await query(`\n      SELECT v.kra_pin as tin \n      FROM branches b \n      JOIN vendors v ON v.id = b.vendor_id \n      WHERE b.id = $1\n    `, [branchId])\n    \n    if (vendorResult.length > 0 && vendorResult[0].tin) {\n      return { tin: vendorResult[0].tin, bhfId: branch.bhf_id || \"00\" }\n    }\n    return null\n  }\n  \n  return { tin: branch.tin, bhfId: branch.bhf_id || \"00\" }\n}\n\nexport async function getTankWithItemInfo(tankId: string): Promise<any> {\n  const result = await query(`\n    SELECT t.*, i.item_code, i.class_code, i.item_name, i.package_unit, \n           i.quantity_unit, i.tax_type, i.sale_price,\n           fp.price as current_price\n    FROM tanks t\n    LEFT JOIN items i ON i.item_name ILIKE '%' || t.fuel_type || '%' AND i.branch_id = t.branch_id\n    LEFT JOIN fuel_prices fp ON fp.branch_id = t.branch_id AND fp.fuel_type = t.fuel_type\n    WHERE t.id = $1\n  `, [tankId])\n  \n  return result.length > 0 ? result[0] : null\n}\n\nexport function formatKraDate(date: Date = new Date()): string {\n  const year = date.getFullYear()\n  const month = String(date.getMonth() + 1).padStart(2, '0')\n  const day = String(date.getDate()).padStart(2, '0')\n  return `${year}${month}${day}`\n}\n\nexport function calculateTaxAmount(taxableAmount: number, taxType: string = \"B\"): number {\n  if (taxType === \"B\") {\n    return Math.round(taxableAmount * 0.16 * 100) / 100\n  }\n  return 0\n}\n\nexport async function createStockMovementRecord(\n  branchId: string,\n  kraPayload: StockPayload,\n  kraResponse: any,\n  httpStatus: number,\n  durationMs: number\n): Promise<string> {\n  const isSuccess = kraResponse?.resultCd === \"000\" || kraResponse?.resultCd === \"0\"\n  \n  const result = await query(`\n    INSERT INTO stock_movements (\n      branch_id, tin, bhf_id, sar_no, org_sar_no, reg_ty_cd, \n      cust_tin, cust_bhf_id, cust_nm, sar_ty_cd, ocrn_dt,\n      tot_item_cnt, tot_taxbl_amt, tot_tax_amt, tot_amt, remark,\n      regr_id, regr_nm, modr_id, modr_nm,\n      kra_status, kra_response, kra_synced_at\n    ) VALUES (\n      $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11,\n      $12, $13, $14, $15, $16, $17, $18, $19, $20,\n      $21, $22, $23\n    ) RETURNING id\n  `, [\n    branchId,\n    kraPayload.tin,\n    kraPayload.bhfId,\n    kraPayload.sarNo,\n    kraPayload.orgSarNo,\n    kraPayload.regTyCd,\n    kraPayload.custTin,\n    kraPayload.custBhfId,\n    kraPayload.custNm,\n    kraPayload.sarTyCd,\n    kraPayload.ocrnDt,\n    kraPayload.totItemCnt,\n    kraPayload.totTaxblAmt,\n    kraPayload.totTaxAmt,\n    kraPayload.totAmt,\n    kraPayload.remark,\n    kraPayload.regrId,\n    kraPayload.regrNm,\n    kraPayload.modrId,\n    kraPayload.modrNm,\n    isSuccess ? \"success\" : \"failed\",\n    JSON.stringify(kraResponse),\n    isSuccess ? new Date() : null\n  ])\n  \n  return result[0].id\n}\n\nexport async function logKraApiCall(\n  endpoint: string,\n  payload: any,\n  response: any,\n  statusCode: number,\n  durationMs: number,\n  branchId: string\n): Promise<void> {\n  try {\n    await query(`\n      INSERT INTO api_logs (endpoint, method, payload, response, status_code, duration_ms, branch_id, user_agent, created_at)\n      VALUES ($1, $2, $3, $4, $5, $6, $7, $8, NOW())\n    `, [\n      endpoint,\n      \"POST\",\n      JSON.stringify(payload),\n      JSON.stringify(response),\n      statusCode,\n      durationMs,\n      branchId,\n      `${KRA_BASE_URL}${endpoint}`\n    ])\n  } catch (error) {\n    console.error(\"[KRA Stock Service] Failed to log API call:\", error)\n  }\n}\n\nexport async function syncStockWithKRA(\n  branchId: string,\n  movementType: StockMovementType,\n  items: Array<{\n    tankId: string\n    quantity: number\n    unitPrice: number\n    itemCode?: string\n    itemClassCode?: string\n    itemName?: string\n  }>,\n  options?: {\n    customerId?: string\n    customerName?: string\n    customerBhfId?: string\n    remark?: string\n  }\n): Promise<{ success: boolean; kraResponse: any; movementId?: string; error?: string }> {\n  const startTime = Date.now()\n  \n  try {\n    const kraInfo = await getBranchKraInfo(branchId)\n    if (!kraInfo) {\n      return { success: false, kraResponse: null, error: \"Branch KRA info not configured (missing KRA PIN)\" }\n    }\n    \n    const sarNo = await getNextSarNo(branchId)\n    const sarTyCd = SAR_TYPE_CODES[movementType] || \"06\"\n    \n    let totTaxblAmt = 0\n    let totTaxAmt = 0\n    let totAmt = 0\n    \n    const itemList: StockItem[] = await Promise.all(items.map(async (item, index) => {\n      let tankInfo = await getTankWithItemInfo(item.tankId)\n      \n      const itemCd = item.itemCode || tankInfo?.item_code || tankInfo?.kra_item_cd || `KE1NTXU000000${index + 1}`\n      const itemClsCd = item.itemClassCode || tankInfo?.class_code || \"5059690800\"\n      const itemNm = item.itemName || tankInfo?.item_name || tankInfo?.fuel_type || \"Fuel Item\"\n      const price = item.unitPrice || tankInfo?.current_price || tankInfo?.sale_price || 0\n      \n      const splyAmt = Math.round(item.quantity * price * 100) / 100\n      const taxAmt = calculateTaxAmount(splyAmt, tankInfo?.tax_type || \"B\")\n      \n      totTaxblAmt += splyAmt\n      totTaxAmt += taxAmt\n      totAmt += splyAmt\n      \n      return {\n        itemSeq: index + 1,\n        itemCd,\n        itemClsCd,\n        itemNm,\n        bcd: null,\n        pkgUnitCd: tankInfo?.package_unit || \"NT\",\n        pkg: Math.ceil(item.quantity),\n        qtyUnitCd: tankInfo?.quantity_unit || \"U\",\n        qty: item.quantity,\n        itemExprDt: null,\n        prc: price,\n        splyAmt,\n        totDcAmt: 0,\n        taxblAmt: splyAmt,\n        taxTyCd: tankInfo?.tax_type || \"B\",\n        taxAmt,\n        totAmt: splyAmt\n      }\n    }))\n    \n    const payload: StockPayload = {\n      tin: kraInfo.tin,\n      bhfId: kraInfo.bhfId,\n      sarNo,\n      orgSarNo: 0,\n      regTyCd: \"M\",\n      custTin: options?.customerId || null,\n      custNm: options?.customerName || null,\n      custBhfId: options?.customerBhfId || null,\n      sarTyCd,\n      ocrnDt: formatKraDate(),\n      totItemCnt: itemList.length,\n      totTaxblAmt: Math.round(totTaxblAmt * 100) / 100,\n      totTaxAmt: Math.round(totTaxAmt * 100) / 100,\n      totAmt: Math.round(totAmt * 100) / 100,\n      remark: options?.remark || null,\n      regrId: \"Admin\",\n      regrNm: \"Admin\",\n      modrNm: \"Admin\",\n      modrId: \"Admin\",\n      itemList\n    }\n    \n    console.log(`[KRA Stock Service] Syncing ${movementType} to KRA for branch ${branchId}`)\n    console.log(`[KRA Stock Service] Payload:`, JSON.stringify(payload, null, 2))\n    \n    let kraResponse: any\n    let httpStatusCode = 200\n    \n    try {\n      const controller = new AbortController()\n      const timeoutId = setTimeout(() => controller.abort(), 15000)\n      \n      const response = await fetch(`${KRA_BASE_URL}${STOCK_ENDPOINT}`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify(payload),\n        signal: controller.signal\n      })\n      \n      clearTimeout(timeoutId)\n      httpStatusCode = response.status\n      kraResponse = await response.json()\n    } catch (fetchError: any) {\n      if (fetchError.name === 'AbortError') {\n        kraResponse = {\n          resultCd: \"TIMEOUT\",\n          resultMsg: \"Request timed out after 15 seconds\",\n          resultDt: new Date().toISOString()\n        }\n      } else {\n        kraResponse = {\n          resultCd: \"NETWORK_ERROR\",\n          resultMsg: `Network error: ${fetchError.message}`,\n          resultDt: new Date().toISOString()\n        }\n      }\n      httpStatusCode = 0\n    }\n    \n    const duration = Date.now() - startTime\n    console.log(`[KRA Stock Service] Response (${duration}ms):`, JSON.stringify(kraResponse, null, 2))\n    \n    await logKraApiCall(STOCK_ENDPOINT, payload, kraResponse, httpStatusCode, duration, branchId)\n    \n    const movementId = await createStockMovementRecord(branchId, payload, kraResponse, httpStatusCode, duration)\n    \n    const isSuccess = kraResponse?.resultCd === \"000\" || kraResponse?.resultCd === \"0\"\n    \n    if (isSuccess) {\n      console.log(`[KRA Stock Service] saveStockItems successful, now calling saveStockMaster for each item`)\n      \n      for (const item of items) {\n        const stockMasterStartTime = Date.now()\n        let stockMasterResponse: any = null\n        let stockMasterStatusCode = 0\n        \n        try {\n          const tankInfo = await getTankWithItemInfo(item.tankId)\n          const tankResult = await query(`SELECT current_stock FROM tanks WHERE id = $1`, [item.tankId])\n          const currentStock = tankResult.length > 0 ? parseFloat(tankResult[0].current_stock) || 0 : 0\n          \n          const itemCd = item.itemCode || tankInfo?.item_code || tankInfo?.kra_item_cd\n          \n          if (!itemCd) {\n            console.log(`[KRA Stock Service] Skipping saveStockMaster for tank ${item.tankId} - no item code`)\n            continue\n          }\n          \n          const stockMasterPayload = {\n            tin: kraInfo.tin,\n            bhfId: kraInfo.bhfId,\n            itemCd: itemCd,\n            rsdQty: currentStock,\n            regrId: \"Admin\",\n            regrNm: \"Admin\",\n            modrNm: \"Admin\",\n            modrId: \"Admin\"\n          }\n          \n          console.log(`[KRA Stock Service] Calling saveStockMaster:`, JSON.stringify(stockMasterPayload, null, 2))\n          \n          try {\n            const stockMasterController = new AbortController()\n            const stockMasterTimeoutId = setTimeout(() => stockMasterController.abort(), 15000)\n            \n            const response = await fetch(`${KRA_BASE_URL}/stockMaster/saveStockMaster`, {\n              method: \"POST\",\n              headers: { \"Content-Type\": \"application/json\" },\n              body: JSON.stringify(stockMasterPayload),\n              signal: stockMasterController.signal\n            })\n            \n            clearTimeout(stockMasterTimeoutId)\n            stockMasterStatusCode = response.status\n            stockMasterResponse = await response.json()\n          } catch (fetchError: any) {\n            if (fetchError.name === 'AbortError') {\n              stockMasterResponse = {\n                resultCd: \"TIMEOUT\",\n                resultMsg: \"Request timed out after 15 seconds\",\n                resultDt: new Date().toISOString()\n              }\n            } else {\n              stockMasterResponse = {\n                resultCd: \"NETWORK_ERROR\",\n                resultMsg: `Network error: ${fetchError.message}`,\n                resultDt: new Date().toISOString()\n              }\n            }\n          }\n          \n          console.log(`[KRA Stock Service] saveStockMaster response for ${itemCd}:`, JSON.stringify(stockMasterResponse, null, 2))\n          \n          await logKraApiCall(\"/stockMaster/saveStockMaster\", stockMasterPayload, stockMasterResponse, stockMasterStatusCode, Date.now() - stockMasterStartTime, branchId)\n          \n        } catch (stockMasterError: any) {\n          console.error(`[KRA Stock Service] Error calling saveStockMaster for tank ${item.tankId}:`, stockMasterError.message)\n        }\n      }\n    }\n    \n    return {\n      success: isSuccess,\n      kraResponse,\n      movementId,\n      error: isSuccess ? undefined : kraResponse?.resultMsg || \"KRA sync failed\"\n    }\n    \n  } catch (error: any) {\n    console.error(\"[KRA Stock Service] Error:\", error)\n    return {\n      success: false,\n      kraResponse: null,\n      error: error.message || \"Internal error during KRA sync\"\n    }\n  }\n}\n\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 486, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/stock/receive/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { query } from \"@/lib/db\"\nimport { syncStockWithKRA } from \"@/lib/kra-stock-service\"\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const { \n      branch_id,\n      tank_id,\n      quantity,\n      unit_price,\n      supplier_name,\n      delivery_note,\n      sync_to_kra = true\n    } = body\n\n    if (!branch_id || !tank_id || !quantity) {\n      return NextResponse.json(\n        { error: \"branch_id, tank_id, and quantity are required\" },\n        { status: 400 }\n      )\n    }\n\n    if (quantity <= 0) {\n      return NextResponse.json(\n        { error: \"Quantity must be positive\" },\n        { status: 400 }\n      )\n    }\n\n    const tankResult = await query(\"SELECT * FROM tanks WHERE id = $1\", [tank_id])\n    if (tankResult.length === 0) {\n      return NextResponse.json(\n        { error: \"Tank not found\" },\n        { status: 404 }\n      )\n    }\n\n    const tank = tankResult[0]\n    const previousStock = parseFloat(tank.current_stock) || 0\n    const quantityNum = parseFloat(quantity)\n    const newStock = previousStock + quantityNum\n\n    console.log(`[Stock Receive] Tank ${tank_id}: previousStock=${previousStock}, quantity=${quantityNum}, newStock=${newStock}`)\n\n    await query(\n      `UPDATE tanks SET current_stock = $1, updated_at = NOW() WHERE id = $2`,\n      [newStock, tank_id]\n    )\n\n    const adjustmentResult = await query(\n      `INSERT INTO stock_adjustments (branch_id, tank_id, adjustment_type, quantity, previous_stock, new_stock, reason, approval_status, kra_sync_status)\n       VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9) RETURNING id`,\n      [branch_id, tank_id, 'stock_receive', quantityNum, previousStock, newStock, supplier_name ? `Received from: ${supplier_name}` : 'Stock received', 'approved', 'pending']\n    )\n    const adjustmentId = adjustmentResult[0]?.id\n\n    let kraResult = null\n    if (sync_to_kra) {\n      console.log(`[Stock Receive API] Syncing stock receive of ${quantity} for tank ${tank_id} to KRA`)\n      \n      kraResult = await syncStockWithKRA(\n        branch_id,\n        \"stock_receive\",\n        [{\n          tankId: tank_id,\n          quantity: quantity,\n          unitPrice: unit_price || 0,\n          itemCode: tank.kra_item_cd,\n          itemName: tank.fuel_type\n        }],\n        { \n          remark: delivery_note || `Stock received: ${quantity} liters`,\n          customerName: supplier_name\n        }\n      )\n\n      await query(\n        `UPDATE tanks SET kra_sync_status = $1, last_kra_synced_stock = $2 WHERE id = $3`,\n        [kraResult.success ? 'synced' : 'failed', kraResult.success ? newStock : tank.last_kra_synced_stock, tank_id]\n      )\n\n      if (adjustmentId) {\n        await query(\n          `UPDATE stock_adjustments SET kra_sync_status = $1 WHERE id = $2`,\n          [kraResult.success ? 'synced' : 'failed', adjustmentId]\n        )\n      }\n    }\n\n    return NextResponse.json({\n      success: true,\n      data: {\n        tankId: tank_id,\n        previousStock,\n        quantityReceived: quantity,\n        newStock,\n        fuelType: tank.fuel_type\n      },\n      kraSync: kraResult ? {\n        synced: kraResult.success,\n        movementId: kraResult.movementId,\n        error: kraResult.error\n      } : null\n    })\n\n  } catch (error: any) {\n    console.error(\"[Stock Receive API] Error:\", error)\n    return NextResponse.json(\n      { error: \"Failed to receive stock\", details: error.message },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AAAA;AACA;;;;;;;;;;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EACJ,SAAS,EACT,OAAO,EACP,QAAQ,EACR,UAAU,EACV,aAAa,EACb,aAAa,EACb,cAAc,IAAI,EACnB,GAAG;QAEJ,IAAI,CAAC,aAAa,CAAC,WAAW,CAAC,UAAU;YACvC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAgD,GACzD;gBAAE,QAAQ;YAAI;QAElB;QAEA,IAAI,YAAY,GAAG;YACjB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA4B,GACrC;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,aAAa,MAAM,IAAA,8HAAK,EAAC,qCAAqC;YAAC;SAAQ;QAC7E,IAAI,WAAW,MAAM,KAAK,GAAG;YAC3B,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAiB,GAC1B;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,OAAO,UAAU,CAAC,EAAE;QAC1B,MAAM,gBAAgB,WAAW,KAAK,aAAa,KAAK;QACxD,MAAM,cAAc,WAAW;QAC/B,MAAM,WAAW,gBAAgB;QAEjC,QAAQ,GAAG,CAAC,CAAC,qBAAqB,EAAE,QAAQ,gBAAgB,EAAE,cAAc,WAAW,EAAE,YAAY,WAAW,EAAE,UAAU;QAE5H,MAAM,IAAA,8HAAK,EACT,CAAC,qEAAqE,CAAC,EACvE;YAAC;YAAU;SAAQ;QAGrB,MAAM,mBAAmB,MAAM,IAAA,8HAAK,EAClC,CAAC;+DACwD,CAAC,EAC1D;YAAC;YAAW;YAAS;YAAiB;YAAa;YAAe;YAAU,gBAAgB,CAAC,eAAe,EAAE,eAAe,GAAG;YAAkB;YAAY;SAAU;QAE1K,MAAM,eAAe,gBAAgB,CAAC,EAAE,EAAE;QAE1C,IAAI,YAAY;QAChB,IAAI,aAAa;YACf,QAAQ,GAAG,CAAC,CAAC,6CAA6C,EAAE,SAAS,UAAU,EAAE,QAAQ,OAAO,CAAC;YAEjG,YAAY,MAAM,IAAA,oJAAgB,EAChC,WACA,iBACA;gBAAC;oBACC,QAAQ;oBACR,UAAU;oBACV,WAAW,cAAc;oBACzB,UAAU,KAAK,WAAW;oBAC1B,UAAU,KAAK,SAAS;gBAC1B;aAAE,EACF;gBACE,QAAQ,iBAAiB,CAAC,gBAAgB,EAAE,SAAS,OAAO,CAAC;gBAC7D,cAAc;YAChB;YAGF,MAAM,IAAA,8HAAK,EACT,CAAC,+EAA+E,CAAC,EACjF;gBAAC,UAAU,OAAO,GAAG,WAAW;gBAAU,UAAU,OAAO,GAAG,WAAW,KAAK,qBAAqB;gBAAE;aAAQ;YAG/G,IAAI,cAAc;gBAChB,MAAM,IAAA,8HAAK,EACT,CAAC,+DAA+D,CAAC,EACjE;oBAAC,UAAU,OAAO,GAAG,WAAW;oBAAU;iBAAa;YAE3D;QACF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,MAAM;gBACJ,QAAQ;gBACR;gBACA,kBAAkB;gBAClB;gBACA,UAAU,KAAK,SAAS;YAC1B;YACA,SAAS,YAAY;gBACnB,QAAQ,UAAU,OAAO;gBACzB,YAAY,UAAU,UAAU;gBAChC,OAAO,UAAU,KAAK;YACxB,IAAI;QACN;IAEF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;YAA2B,SAAS,MAAM,OAAO;QAAC,GAC3D;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}