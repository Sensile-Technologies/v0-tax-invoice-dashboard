{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/shifts/nozzle-report/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const shiftId = searchParams.get('shift_id')\n    const branchId = searchParams.get('branch_id')\n    const date = searchParams.get('date')\n    const userId = searchParams.get('user_id')\n\n    let vendorId: string | null = null\n    \n    if (userId) {\n      const userVendorResult = await pool.query(\n        `SELECT v.id as vendor_id FROM users u \n         JOIN vendors v ON v.email = u.email \n         WHERE u.id = $1`,\n        [userId]\n      )\n      if (userVendorResult.rows.length > 0) {\n        vendorId = userVendorResult.rows[0].vendor_id\n      } else {\n        const staffResult = await pool.query(\n          `SELECT DISTINCT b.vendor_id FROM staff s\n           JOIN branches b ON s.branch_id = b.id\n           WHERE s.user_id = $1 AND b.vendor_id IS NOT NULL`,\n          [userId]\n        )\n        if (staffResult.rows.length > 0) {\n          vendorId = staffResult.rows[0].vendor_id\n        }\n      }\n    }\n\n    if (shiftId) {\n      const report = await getShiftNozzleReport(shiftId, vendorId)\n      return NextResponse.json({ success: true, data: report })\n    }\n\n    if (branchId && date) {\n      const report = await getDailyNozzleReport(branchId, date, vendorId)\n      return NextResponse.json({ success: true, data: report })\n    }\n\n    return NextResponse.json(\n      { error: \"Either shift_id or (branch_id and date) are required\" },\n      { status: 400 }\n    )\n\n  } catch (error: any) {\n    console.error(\"Error fetching nozzle report:\", error)\n    return NextResponse.json(\n      { error: \"Failed to fetch nozzle report\", details: error.message },\n      { status: 500 }\n    )\n  }\n}\n\nasync function getShiftNozzleReport(shiftId: string, vendorId: string | null) {\n  const shiftQuery = `\n    SELECT s.*, b.name as branch_name, st.full_name as cashier_name\n    FROM shifts s\n    LEFT JOIN branches b ON s.branch_id = b.id\n    LEFT JOIN staff st ON s.staff_id = st.id\n    WHERE s.id = $1\n    ${vendorId ? 'AND b.vendor_id = $2' : ''}\n  `\n  const shiftParams = vendorId ? [shiftId, vendorId] : [shiftId]\n  const shiftResult = await pool.query(shiftQuery, shiftParams)\n  \n  if (shiftResult.rows.length === 0) {\n    return { shift: null, nozzles: [], totals: null }\n  }\n\n  const shift = shiftResult.rows[0]\n\n  const nozzleReadingsQuery = `\n    SELECT \n      sr.nozzle_id,\n      sr.opening_reading,\n      sr.closing_reading,\n      n.nozzle_number,\n      n.fuel_type,\n      COALESCE(d.name, 'Dispenser ' || COALESCE(n.nozzle_number::text, '')) as nozzle_name\n    FROM shift_readings sr\n    JOIN nozzles n ON sr.nozzle_id = n.id\n    LEFT JOIN dispensers d ON n.dispenser_id = d.id\n    WHERE sr.shift_id = $1 AND sr.reading_type = 'nozzle'\n  `\n  const readingsResult = await pool.query(nozzleReadingsQuery, [shiftId])\n\n  const invoicedSalesQuery = `\n    SELECT \n      nozzle_id,\n      SUM(quantity) as invoiced_quantity,\n      SUM(total_amount) as invoiced_amount\n    FROM sales\n    WHERE shift_id = $1 AND nozzle_id IS NOT NULL\n    GROUP BY nozzle_id\n  `\n  const invoicedResult = await pool.query(invoicedSalesQuery, [shiftId])\n  const invoicedMap = new Map(invoicedResult.rows.map(r => [r.nozzle_id, r]))\n\n  const nozzles = readingsResult.rows.map(reading => {\n    const openingReading = parseFloat(reading.opening_reading) || 0\n    const closingReading = parseFloat(reading.closing_reading) || 0\n    const meterDifference = closingReading - openingReading\n    \n    const invoiced = invoicedMap.get(reading.nozzle_id)\n    const invoicedQuantity = parseFloat(invoiced?.invoiced_quantity) || 0\n    const invoicedAmount = parseFloat(invoiced?.invoiced_amount) || 0\n    \n    const variance = meterDifference - invoicedQuantity\n\n    return {\n      nozzle_id: reading.nozzle_id,\n      nozzle_name: reading.nozzle_name || `Nozzle ${reading.nozzle_number}`,\n      fuel_type: reading.fuel_type,\n      opening_reading: openingReading,\n      closing_reading: closingReading,\n      meter_difference: meterDifference,\n      invoiced_quantity: invoicedQuantity,\n      invoiced_amount: invoicedAmount,\n      variance: variance\n    }\n  })\n\n  const totals = {\n    total_meter_difference: nozzles.reduce((sum, n) => sum + n.meter_difference, 0),\n    total_invoiced_quantity: nozzles.reduce((sum, n) => sum + n.invoiced_quantity, 0),\n    total_invoiced_amount: nozzles.reduce((sum, n) => sum + n.invoiced_amount, 0),\n    total_variance: nozzles.reduce((sum, n) => sum + n.variance, 0)\n  }\n\n  return {\n    shift: {\n      id: shift.id,\n      branch_name: shift.branch_name,\n      cashier_name: shift.cashier_name,\n      start_time: shift.start_time,\n      end_time: shift.end_time,\n      status: shift.status,\n      opening_cash: parseFloat(shift.opening_cash) || 0,\n      closing_cash: parseFloat(shift.closing_cash) || 0\n    },\n    nozzles,\n    totals\n  }\n}\n\nasync function getDailyNozzleReport(branchId: string, date: string, vendorId: string | null) {\n  const branchCheckQuery = vendorId \n    ? `SELECT id, name FROM branches WHERE id = $1 AND vendor_id = $2`\n    : `SELECT id, name FROM branches WHERE id = $1`\n  const branchCheckParams = vendorId ? [branchId, vendorId] : [branchId]\n  const branchResult = await pool.query(branchCheckQuery, branchCheckParams)\n  \n  if (branchResult.rows.length === 0) {\n    return { branch: null, shifts: [], nozzles: [], totals: null }\n  }\n\n  const branch = branchResult.rows[0]\n\n  const shiftsQuery = `\n    SELECT s.id, s.start_time, s.end_time, s.status, st.full_name as cashier_name\n    FROM shifts s\n    LEFT JOIN staff st ON s.staff_id = st.id\n    WHERE s.branch_id = $1 \n    AND DATE(s.start_time) = $2\n    ORDER BY s.start_time\n  `\n  const shiftsResult = await pool.query(shiftsQuery, [branchId, date])\n  const shiftIds = shiftsResult.rows.map(s => s.id)\n\n  if (shiftIds.length === 0) {\n    const nozzlesQuery = `\n      SELECT id, nozzle_number, fuel_type, initial_meter_reading,\n        COALESCE((SELECT name FROM dispensers WHERE id = nozzles.dispenser_id), 'Nozzle ' || nozzle_number) as nozzle_name\n      FROM nozzles\n      WHERE branch_id = $1 AND status = 'active'\n      ORDER BY nozzle_number\n    `\n    const nozzlesResult = await pool.query(nozzlesQuery, [branchId])\n    \n    return {\n      branch: { id: branch.id, name: branch.name },\n      date,\n      shifts: [],\n      nozzles: nozzlesResult.rows.map(n => ({\n        nozzle_id: n.id,\n        nozzle_name: n.nozzle_name,\n        fuel_type: n.fuel_type,\n        opening_reading: parseFloat(n.initial_meter_reading) || 0,\n        closing_reading: parseFloat(n.initial_meter_reading) || 0,\n        meter_difference: 0,\n        invoiced_quantity: 0,\n        invoiced_amount: 0,\n        variance: 0\n      })),\n      totals: {\n        total_meter_difference: 0,\n        total_invoiced_quantity: 0,\n        total_invoiced_amount: 0,\n        total_variance: 0\n      }\n    }\n  }\n\n  const nozzleReadingsQuery = `\n    SELECT \n      sr.nozzle_id,\n      n.nozzle_number,\n      n.fuel_type,\n      COALESCE(d.name, 'Nozzle ' || COALESCE(n.nozzle_number::text, '')) as nozzle_name,\n      MIN(sr.opening_reading) as day_opening,\n      MAX(sr.closing_reading) as day_closing\n    FROM shift_readings sr\n    JOIN nozzles n ON sr.nozzle_id = n.id\n    LEFT JOIN dispensers d ON n.dispenser_id = d.id\n    WHERE sr.shift_id = ANY($1) AND sr.reading_type = 'nozzle'\n    GROUP BY sr.nozzle_id, n.nozzle_number, n.fuel_type, d.name\n  `\n  const readingsResult = await pool.query(nozzleReadingsQuery, [shiftIds])\n\n  const invoicedSalesQuery = `\n    SELECT \n      nozzle_id,\n      SUM(quantity) as invoiced_quantity,\n      SUM(total_amount) as invoiced_amount\n    FROM sales\n    WHERE shift_id = ANY($1) AND nozzle_id IS NOT NULL\n    GROUP BY nozzle_id\n  `\n  const invoicedResult = await pool.query(invoicedSalesQuery, [shiftIds])\n  const invoicedMap = new Map(invoicedResult.rows.map(r => [r.nozzle_id, r]))\n\n  const nozzles = readingsResult.rows.map(reading => {\n    const openingReading = parseFloat(reading.day_opening) || 0\n    const closingReading = parseFloat(reading.day_closing) || 0\n    const meterDifference = closingReading - openingReading\n    \n    const invoiced = invoicedMap.get(reading.nozzle_id)\n    const invoicedQuantity = parseFloat(invoiced?.invoiced_quantity) || 0\n    const invoicedAmount = parseFloat(invoiced?.invoiced_amount) || 0\n    \n    const variance = meterDifference - invoicedQuantity\n\n    return {\n      nozzle_id: reading.nozzle_id,\n      nozzle_name: reading.nozzle_name || `Nozzle ${reading.nozzle_number}`,\n      fuel_type: reading.fuel_type,\n      opening_reading: openingReading,\n      closing_reading: closingReading,\n      meter_difference: meterDifference,\n      invoiced_quantity: invoicedQuantity,\n      invoiced_amount: invoicedAmount,\n      variance: variance\n    }\n  })\n\n  const totals = {\n    total_meter_difference: nozzles.reduce((sum, n) => sum + n.meter_difference, 0),\n    total_invoiced_quantity: nozzles.reduce((sum, n) => sum + n.invoiced_quantity, 0),\n    total_invoiced_amount: nozzles.reduce((sum, n) => sum + n.invoiced_amount, 0),\n    total_variance: nozzles.reduce((sum, n) => sum + n.variance, 0)\n  }\n\n  return {\n    branch: { id: branch.id, name: branch.name },\n    date,\n    shifts: shiftsResult.rows,\n    nozzles,\n    totals\n  }\n}\n"],"names":[],"mappings":"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"}}]
}