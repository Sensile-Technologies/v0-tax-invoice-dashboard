{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/mobile/products/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nexport async function GET(request: Request) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const branchId = searchParams.get(\"branch_id\")\n\n    if (!branchId) {\n      return NextResponse.json({ error: \"Branch ID required\" }, { status: 400 })\n    }\n\n    const client = await pool.connect()\n    try {\n      // First get the vendor_id for this branch\n      const branchResult = await client.query(\n        `SELECT vendor_id FROM branches WHERE id = $1`,\n        [branchId]\n      )\n      \n      if (branchResult.rows.length === 0) {\n        return NextResponse.json({ error: \"Branch not found\" }, { status: 404 })\n      }\n      \n      const vendorId = branchResult.rows[0].vendor_id\n\n      // Fetch items from:\n      // 1. HQ catalog (branch_id IS NULL, vendor matches) that are assigned to this branch\n      // 2. Legacy branch-specific items (branch_id matches)\n      const itemsResult = await client.query(\n        `SELECT \n          i.id, \n          i.item_code as item_cd, \n          i.item_name as item_nm, \n          COALESCE(i.class_code, 'ITEM') as item_cls_cd, \n          'L' as pkg_unit_cd, \n          'L' as qty_unit_cd,\n          COALESCE(\n            bi.sale_price,\n            (SELECT fp.price FROM fuel_prices fp \n             WHERE fp.branch_id = $1 \n             AND LOWER(fp.fuel_type) = LOWER(i.item_name)\n             AND fp.effective_date <= CURRENT_DATE\n             ORDER BY fp.effective_date DESC LIMIT 1),\n            i.sale_price,\n            0\n          ) as unit_price,\n          COALESCE(\n            (SELECT t.current_stock FROM tanks t \n             WHERE (t.kra_item_cd = i.item_code OR t.item_id = i.id)\n             AND t.branch_id = $1 \n             AND t.status = 'active' \n             LIMIT 1),\n            0\n          ) as stock_quantity,\n          COALESCE(i.status, 'active') as status\n         FROM items i\n         LEFT JOIN branch_items bi ON i.id = bi.item_id AND bi.branch_id = $1\n         WHERE (\n           -- HQ catalog items assigned to this branch\n           (i.vendor_id = $2 AND i.branch_id IS NULL AND bi.is_available = true)\n           -- OR legacy branch-specific items\n           OR i.branch_id = $1\n         )\n         AND i.status = 'active'\n         ORDER BY i.item_name ASC`,\n        [branchId, vendorId]\n      )\n\n      return NextResponse.json({\n        products: itemsResult.rows || [],\n      })\n    } finally {\n      client.release()\n    }\n  } catch (error) {\n    console.error(\"[Mobile Products API Error]:\", error)\n    return NextResponse.json({ error: \"Failed to fetch products\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;AAC5C;AAEO,eAAe,IAAI,OAAgB;IACxC,IAAI;QACF,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,WAAW,aAAa,GAAG,CAAC;QAElC,IAAI,CAAC,UAAU;YACb,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAqB,GAAG;gBAAE,QAAQ;YAAI;QAC1E;QAEA,MAAM,SAAS,MAAM,KAAK,OAAO;QACjC,IAAI;YACF,0CAA0C;YAC1C,MAAM,eAAe,MAAM,OAAO,KAAK,CACrC,CAAC,4CAA4C,CAAC,EAC9C;gBAAC;aAAS;YAGZ,IAAI,aAAa,IAAI,CAAC,MAAM,KAAK,GAAG;gBAClC,OAAO,gJAAY,CAAC,IAAI,CAAC;oBAAE,OAAO;gBAAmB,GAAG;oBAAE,QAAQ;gBAAI;YACxE;YAEA,MAAM,WAAW,aAAa,IAAI,CAAC,EAAE,CAAC,SAAS;YAE/C,oBAAoB;YACpB,qFAAqF;YACrF,sDAAsD;YACtD,MAAM,cAAc,MAAM,OAAO,KAAK,CACpC,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;iCAmCwB,CAAC,EAC1B;gBAAC;gBAAU;aAAS;YAGtB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,UAAU,YAAY,IAAI,IAAI,EAAE;YAClC;QACF,SAAU;YACR,OAAO,OAAO;QAChB;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gCAAgC;QAC9C,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA2B,GAAG;YAAE,QAAQ;QAAI;IAChF;AACF"}}]
}