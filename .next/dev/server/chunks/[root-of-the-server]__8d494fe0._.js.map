{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/auth/signup/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\nimport bcrypt from \"bcryptjs\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nexport async function POST(request: Request) {\n  try {\n    const { email, password, data, branch } = await request.json()\n\n    if (!email || !password) {\n      return NextResponse.json(\n        { error: { message: \"Email and password are required\" } },\n        { status: 400 }\n      )\n    }\n\n    const client = await pool.connect()\n\n    try {\n      await client.query(\"BEGIN\")\n\n      const existingUser = await client.query(\n        \"SELECT id FROM users WHERE email = $1\",\n        [email]\n      )\n\n      if (existingUser.rows.length > 0) {\n        await client.query(\"ROLLBACK\")\n        return NextResponse.json(\n          { error: { message: \"User with this email already exists\" } },\n          { status: 400 }\n        )\n      }\n\n      const passwordHash = await bcrypt.hash(password, 10)\n      const userId = crypto.randomUUID()\n\n      await client.query(\n        `INSERT INTO users (id, email, username, phone_number, password_hash, created_at, updated_at)\n         VALUES ($1, $2, $3, $4, $5, NOW(), NOW())`,\n        [userId, email, data?.username || null, data?.phone || null, passwordHash]\n      )\n\n      let createdBranch = null\n      let createdVendor = null\n\n      if (branch) {\n        const branchId = crypto.randomUUID()\n        const vendorId = crypto.randomUUID()\n        \n        const isHeadquarters = branch.name && (\n          branch.name.toLowerCase().includes('headquarters') || \n          branch.name.toLowerCase().includes('head office') ||\n          branch.name.toLowerCase() === 'hq'\n        )\n        const bhfId = isHeadquarters ? \"00\" : \"01\"\n\n        // Create vendor for this user with all relevant fields\n        const vendorResult = await client.query(\n          `INSERT INTO vendors (id, name, email, phone, address, kra_pin, status, billing_email, billing_address, subscription_status, created_at, updated_at)\n           VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, NOW(), NOW())\n           RETURNING *`,\n          [\n            vendorId, \n            branch.trading_name || branch.name, \n            email, \n            branch.phone || null, \n            branch.address || null, \n            branch.kra_pin || null,\n            'active',\n            email,\n            branch.address || null,\n            'active'\n          ]\n        )\n        createdVendor = vendorResult.rows[0]\n\n        const branchResult = await client.query(\n          `INSERT INTO branches (id, user_id, vendor_id, name, bhf_id, trading_name, kra_pin, location, address, county, local_tax_office, manager, email, phone, status, created_at, updated_at)\n           VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, 'active', NOW(), NOW())\n           RETURNING *`,\n          [\n            branchId,\n            userId,\n            vendorId,\n            branch.name,\n            bhfId,\n            branch.trading_name || null,\n            branch.kra_pin || null,\n            branch.location || null,\n            branch.address || null,\n            branch.county || null,\n            branch.local_tax_office || null,\n            branch.manager || null,\n            branch.email || null,\n            branch.phone || null,\n          ]\n        )\n        createdBranch = branchResult.rows[0]\n\n        const staffId = crypto.randomUUID()\n        await client.query(\n          `INSERT INTO staff (id, user_id, branch_id, full_name, username, email, phone_number, role, status, created_at, updated_at)\n           VALUES ($1, $2, $3, $4, $5, $6, $7, 'Director', 'active', NOW(), NOW())`,\n          [\n            staffId,\n            userId,\n            branchId,\n            data?.username || email.split('@')[0],\n            data?.username || email.split('@')[0],\n            email,\n            data?.phone || null,\n          ]\n        )\n      }\n\n      // Check for matching leads by phone or KRA PIN and update their stage\n      if (branch?.phone || branch?.kra_pin) {\n        const conditions = []\n        const matchParams = []\n        let paramIdx = 1\n\n        // Normalize phone: remove spaces, dashes, and common prefixes\n        if (branch.phone) {\n          const normalizedPhone = branch.phone.replace(/[\\s\\-\\(\\)]/g, '').replace(/^\\+?254/, '0')\n          conditions.push(`REGEXP_REPLACE(REGEXP_REPLACE(contact_phone, '[\\\\s\\\\-\\\\(\\\\)]', '', 'g'), '^\\\\+?254', '0') = $${paramIdx}`)\n          matchParams.push(normalizedPhone)\n          paramIdx++\n        }\n        \n        // Normalize KRA PIN: uppercase and trim\n        if (branch.kra_pin) {\n          const normalizedPin = branch.kra_pin.trim().toUpperCase()\n          conditions.push(`UPPER(TRIM(kra_pin)) = $${paramIdx}`)\n          matchParams.push(normalizedPin)\n          paramIdx++\n        }\n\n        if (conditions.length > 0) {\n          // Find matching leads in 'onboarding' stage and update to 'signed_up'\n          await client.query(\n            `UPDATE leads \n             SET stage = 'signed_up', updated_at = NOW() \n             WHERE stage = 'onboarding' AND (${conditions.join(' OR ')})`,\n            matchParams\n          )\n        }\n      }\n\n      await client.query(\"COMMIT\")\n\n      return NextResponse.json({\n        user: { id: userId, email, username: data?.username },\n        branch: createdBranch,\n        message: \"User created successfully\"\n      })\n    } catch (txError) {\n      await client.query(\"ROLLBACK\")\n      throw txError\n    } finally {\n      client.release()\n    }\n  } catch (error: any) {\n    console.error(\"[API] Sign up error:\", error)\n    return NextResponse.json(\n      { error: { message: error?.message || \"Failed to create user\", details: error?.toString() } },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":"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"}}]
}