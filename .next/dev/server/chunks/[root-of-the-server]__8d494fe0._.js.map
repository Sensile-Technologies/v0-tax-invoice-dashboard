{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/auth/signup/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\nimport bcrypt from \"bcryptjs\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nexport async function POST(request: Request) {\n  try {\n    const { email, password, data, branch } = await request.json()\n\n    if (!email || !password) {\n      return NextResponse.json(\n        { error: { message: \"Email and password are required\" } },\n        { status: 400 }\n      )\n    }\n\n    const client = await pool.connect()\n\n    try {\n      await client.query(\"BEGIN\")\n\n      const existingUser = await client.query(\n        \"SELECT id FROM users WHERE email = $1\",\n        [email]\n      )\n\n      if (existingUser.rows.length > 0) {\n        await client.query(\"ROLLBACK\")\n        return NextResponse.json(\n          { error: { message: \"User with this email already exists\" } },\n          { status: 400 }\n        )\n      }\n\n      const passwordHash = await bcrypt.hash(password, 10)\n      const userId = crypto.randomUUID()\n\n      await client.query(\n        `INSERT INTO users (id, email, username, phone_number, password_hash, created_at, updated_at)\n         VALUES ($1, $2, $3, $4, $5, NOW(), NOW())`,\n        [userId, email, data?.username || null, data?.phone || null, passwordHash]\n      )\n\n      let createdBranch = null\n\n      if (branch) {\n        const branchId = crypto.randomUUID()\n        const bhfId = \"01\"\n\n        const branchResult = await client.query(\n          `INSERT INTO branches (id, user_id, name, bhf_id, trading_name, kra_pin, location, address, county, local_tax_office, manager, email, phone, status, created_at, updated_at)\n           VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, 'active', NOW(), NOW())\n           RETURNING *`,\n          [\n            branchId,\n            userId,\n            branch.name,\n            bhfId,\n            branch.trading_name || null,\n            branch.kra_pin || null,\n            branch.location || null,\n            branch.address || null,\n            branch.county || null,\n            branch.local_tax_office || null,\n            branch.manager || null,\n            branch.email || null,\n            branch.phone || null,\n          ]\n        )\n        createdBranch = branchResult.rows[0]\n      }\n\n      await client.query(\"COMMIT\")\n\n      return NextResponse.json({\n        user: { id: userId, email, username: data?.username },\n        branch: createdBranch,\n        message: \"User created successfully\"\n      })\n    } catch (txError) {\n      await client.query(\"ROLLBACK\")\n      throw txError\n    } finally {\n      client.release()\n    }\n  } catch (error) {\n    console.error(\"[API] Sign up error:\", error)\n    return NextResponse.json(\n      { error: { message: \"Failed to create user\" } },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;AAC5C;AAEO,eAAe,KAAK,OAAgB;IACzC,IAAI;QACF,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,IAAI,EAAE,MAAM,EAAE,GAAG,MAAM,QAAQ,IAAI;QAE5D,IAAI,CAAC,SAAS,CAAC,UAAU;YACvB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;oBAAE,SAAS;gBAAkC;YAAE,GACxD;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,SAAS,MAAM,KAAK,OAAO;QAEjC,IAAI;YACF,MAAM,OAAO,KAAK,CAAC;YAEnB,MAAM,eAAe,MAAM,OAAO,KAAK,CACrC,yCACA;gBAAC;aAAM;YAGT,IAAI,aAAa,IAAI,CAAC,MAAM,GAAG,GAAG;gBAChC,MAAM,OAAO,KAAK,CAAC;gBACnB,OAAO,gJAAY,CAAC,IAAI,CACtB;oBAAE,OAAO;wBAAE,SAAS;oBAAsC;gBAAE,GAC5D;oBAAE,QAAQ;gBAAI;YAElB;YAEA,MAAM,eAAe,MAAM,8IAAM,CAAC,IAAI,CAAC,UAAU;YACjD,MAAM,SAAS,OAAO,UAAU;YAEhC,MAAM,OAAO,KAAK,CAChB,CAAC;kDACyC,CAAC,EAC3C;gBAAC;gBAAQ;gBAAO,MAAM,YAAY;gBAAM,MAAM,SAAS;gBAAM;aAAa;YAG5E,IAAI,gBAAgB;YAEpB,IAAI,QAAQ;gBACV,MAAM,WAAW,OAAO,UAAU;gBAClC,MAAM,QAAQ;gBAEd,MAAM,eAAe,MAAM,OAAO,KAAK,CACrC,CAAC;;sBAEW,CAAC,EACb;oBACE;oBACA;oBACA,OAAO,IAAI;oBACX;oBACA,OAAO,YAAY,IAAI;oBACvB,OAAO,OAAO,IAAI;oBAClB,OAAO,QAAQ,IAAI;oBACnB,OAAO,OAAO,IAAI;oBAClB,OAAO,MAAM,IAAI;oBACjB,OAAO,gBAAgB,IAAI;oBAC3B,OAAO,OAAO,IAAI;oBAClB,OAAO,KAAK,IAAI;oBAChB,OAAO,KAAK,IAAI;iBACjB;gBAEH,gBAAgB,aAAa,IAAI,CAAC,EAAE;YACtC;YAEA,MAAM,OAAO,KAAK,CAAC;YAEnB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,MAAM;oBAAE,IAAI;oBAAQ;oBAAO,UAAU,MAAM;gBAAS;gBACpD,QAAQ;gBACR,SAAS;YACX;QACF,EAAE,OAAO,SAAS;YAChB,MAAM,OAAO,KAAK,CAAC;YACnB,MAAM;QACR,SAAU;YACR,OAAO,OAAO;QAChB;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,wBAAwB;QACtC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;gBAAE,SAAS;YAAwB;QAAE,GAC9C;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}