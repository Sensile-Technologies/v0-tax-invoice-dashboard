{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/items/list/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const branchId = searchParams.get(\"branch_id\")\n    const itemType = searchParams.get(\"item_type\")\n    const excludeType = searchParams.get(\"exclude_type\")\n    const status = searchParams.get(\"status\")\n\n    if (!branchId) {\n      return NextResponse.json({ success: false, error: \"branch_id is required\" }, { status: 400 })\n    }\n\n    const branchResult = await pool.query(\n      'SELECT vendor_id FROM branches WHERE id = $1',\n      [branchId]\n    )\n\n    if (branchResult.rows.length === 0) {\n      return NextResponse.json({ success: false, error: \"Branch not found\" }, { status: 404 })\n    }\n\n    const vendorId = branchResult.rows[0].vendor_id\n\n    let query = `\n      SELECT \n        i.id,\n        i.vendor_id,\n        $1::uuid as branch_id,\n        i.item_code,\n        i.sku,\n        i.item_name,\n        i.description,\n        i.item_type,\n        i.class_code,\n        i.tax_type,\n        i.origin,\n        i.batch_number,\n        COALESCE(bi.purchase_price, i.purchase_price) as purchase_price,\n        COALESCE(bi.sale_price, i.sale_price) as sale_price,\n        i.status,\n        i.quantity_unit,\n        i.package_unit,\n        COALESCE(bi.kra_status, i.kra_status) as kra_status,\n        i.kra_response,\n        i.kra_last_synced_at,\n        i.created_at,\n        i.updated_at,\n        CASE \n          WHEN bi.id IS NOT NULL THEN 'vendor_catalog'\n          WHEN i.branch_id = $1 THEN 'branch_specific'\n          ELSE 'unknown'\n        END as item_source\n      FROM items i\n      LEFT JOIN branch_items bi ON i.id = bi.item_id AND bi.branch_id = $1 AND bi.is_available = true\n      WHERE (\n        (i.vendor_id = $2 AND i.branch_id IS NULL AND bi.id IS NOT NULL)\n        OR \n        (i.branch_id = $1)\n      )\n    `\n    \n    const params: any[] = [branchId, vendorId]\n    let paramIndex = 3\n\n    if (status) {\n      query += ` AND i.status = $${paramIndex}`\n      params.push(status)\n      paramIndex++\n    }\n\n    if (itemType) {\n      query += ` AND i.item_type = $${paramIndex}`\n      params.push(itemType)\n      paramIndex++\n    }\n\n    if (excludeType) {\n      query += ` AND i.item_type != $${paramIndex}`\n      params.push(excludeType)\n      paramIndex++\n    }\n\n    query += \" ORDER BY i.item_name\"\n\n    const result = await pool.query(query, params)\n\n    return NextResponse.json({ success: true, data: result.rows })\n  } catch (error) {\n    console.error(\"Error fetching items:\", error)\n    return NextResponse.json({ success: false, error: \"Failed to fetch items\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;AAC5C;AAEO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,WAAW,aAAa,GAAG,CAAC;QAClC,MAAM,WAAW,aAAa,GAAG,CAAC;QAClC,MAAM,cAAc,aAAa,GAAG,CAAC;QACrC,MAAM,SAAS,aAAa,GAAG,CAAC;QAEhC,IAAI,CAAC,UAAU;YACb,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAO,OAAO;YAAwB,GAAG;gBAAE,QAAQ;YAAI;QAC7F;QAEA,MAAM,eAAe,MAAM,KAAK,KAAK,CACnC,gDACA;YAAC;SAAS;QAGZ,IAAI,aAAa,IAAI,CAAC,MAAM,KAAK,GAAG;YAClC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,SAAS;gBAAO,OAAO;YAAmB,GAAG;gBAAE,QAAQ;YAAI;QACxF;QAEA,MAAM,WAAW,aAAa,IAAI,CAAC,EAAE,CAAC,SAAS;QAE/C,IAAI,QAAQ,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAoCb,CAAC;QAED,MAAM,SAAgB;YAAC;YAAU;SAAS;QAC1C,IAAI,aAAa;QAEjB,IAAI,QAAQ;YACV,SAAS,CAAC,iBAAiB,EAAE,YAAY;YACzC,OAAO,IAAI,CAAC;YACZ;QACF;QAEA,IAAI,UAAU;YACZ,SAAS,CAAC,oBAAoB,EAAE,YAAY;YAC5C,OAAO,IAAI,CAAC;YACZ;QACF;QAEA,IAAI,aAAa;YACf,SAAS,CAAC,qBAAqB,EAAE,YAAY;YAC7C,OAAO,IAAI,CAAC;YACZ;QACF;QAEA,SAAS;QAET,MAAM,SAAS,MAAM,KAAK,KAAK,CAAC,OAAO;QAEvC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM,MAAM,OAAO,IAAI;QAAC;IAC9D,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAO,OAAO;QAAwB,GAAG;YAAE,QAAQ;QAAI;IAC7F;AACF"}}]
}