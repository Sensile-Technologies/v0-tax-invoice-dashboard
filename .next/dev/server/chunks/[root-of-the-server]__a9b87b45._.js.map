{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/shifts/reconcile/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nexport async function POST(request: NextRequest) {\n  const client = await pool.connect()\n  try {\n    const body = await request.json()\n    const { shift_id, attendant_collections, expenses, banking, notes } = body\n\n    if (!shift_id) {\n      return NextResponse.json(\n        { error: \"shift_id is required\" },\n        { status: 400 }\n      )\n    }\n\n    await client.query('BEGIN')\n\n    const shiftCheck = await client.query(\n      `SELECT s.*, b.vendor_id FROM shifts s\n       JOIN branches b ON s.branch_id = b.id\n       WHERE s.id = $1`,\n      [shift_id]\n    )\n\n    if (shiftCheck.rows.length === 0) {\n      await client.query('ROLLBACK')\n      client.release()\n      return NextResponse.json(\n        { error: \"Shift not found\" },\n        { status: 404 }\n      )\n    }\n\n    const shift = shiftCheck.rows[0]\n    const branchId = shift.branch_id\n    const vendorId = shift.vendor_id\n\n    if (shift.reconciliation_status === 'reconciled') {\n      await client.query('ROLLBACK')\n      client.release()\n      return NextResponse.json(\n        { error: \"Shift has already been reconciled\" },\n        { status: 400 }\n      )\n    }\n\n    if (!attendant_collections || attendant_collections.length === 0) {\n      await client.query('ROLLBACK')\n      client.release()\n      return NextResponse.json(\n        { error: \"Attendant collections are required for reconciliation\" },\n        { status: 400 }\n      )\n    }\n\n    const hasValidCollections = attendant_collections.some((c: any) => \n      c.attendant_id && c.payments && Array.isArray(c.payments) && \n      c.payments.some((p: any) => p.amount > 0)\n    )\n    if (!hasValidCollections) {\n      await client.query('ROLLBACK')\n      client.release()\n      return NextResponse.json(\n        { error: \"At least one attendant must have collection amounts entered\" },\n        { status: 400 }\n      )\n    }\n\n    if (!banking || banking.length === 0) {\n      await client.query('ROLLBACK')\n      client.release()\n      return NextResponse.json(\n        { error: \"Banking summary is required for reconciliation\" },\n        { status: 400 }\n      )\n    }\n\n    const hasValidBanking = banking.some((b: any) => b.banking_account_id && b.amount > 0)\n    if (!hasValidBanking) {\n      await client.query('ROLLBACK')\n      client.release()\n      return NextResponse.json(\n        { error: \"At least one banking entry with a valid amount is required\" },\n        { status: 400 }\n      )\n    }\n\n    await client.query(\n      `DELETE FROM attendant_collections WHERE shift_id = $1`,\n      [shift_id]\n    )\n    \n    if (attendant_collections && attendant_collections.length > 0) {\n      for (const collection of attendant_collections) {\n        if (collection.attendant_id && collection.payments && Array.isArray(collection.payments)) {\n          for (const payment of collection.payments) {\n            if (payment.payment_method && payment.amount > 0) {\n              await client.query(\n                `INSERT INTO attendant_collections (shift_id, branch_id, staff_id, payment_method, amount, is_app_payment)\n                 VALUES ($1, $2, $3, $4, $5, false)`,\n                [shift_id, branchId, collection.attendant_id, payment.payment_method, payment.amount]\n              )\n            }\n          }\n        }\n      }\n    }\n\n    await client.query(\n      `DELETE FROM shift_expenses WHERE shift_id = $1`,\n      [shift_id]\n    )\n\n    if (expenses && expenses.length > 0) {\n      for (const expense of expenses) {\n        if (expense.expense_account_id && expense.amount > 0) {\n          const accountCheck = await client.query(\n            'SELECT id FROM expense_accounts WHERE id = $1 AND vendor_id = $2',\n            [expense.expense_account_id, vendorId]\n          )\n          if (accountCheck.rows.length === 0) {\n            console.warn(`[Reconcile] Skipping invalid expense account ${expense.expense_account_id}`)\n            continue\n          }\n          \n          await client.query(\n            `INSERT INTO shift_expenses (shift_id, branch_id, expense_account_id, amount, description)\n             VALUES ($1, $2, $3, $4, $5)`,\n            [shift_id, branchId, expense.expense_account_id, expense.amount, expense.description || null]\n          )\n        }\n      }\n    }\n\n    await client.query(\n      `DELETE FROM shift_banking WHERE shift_id = $1`,\n      [shift_id]\n    )\n\n    if (banking && banking.length > 0) {\n      for (const entry of banking) {\n        if (entry.banking_account_id && entry.amount > 0) {\n          const accountCheck = await client.query(\n            'SELECT id FROM banking_accounts WHERE id = $1 AND vendor_id = $2',\n            [entry.banking_account_id, vendorId]\n          )\n          if (accountCheck.rows.length === 0) {\n            console.warn(`[Reconcile] Skipping invalid banking account ${entry.banking_account_id}`)\n            continue\n          }\n          \n          await client.query(\n            `INSERT INTO shift_banking (shift_id, banking_account_id, amount, notes)\n             VALUES ($1, $2, $3, $4)`,\n            [shift_id, entry.banking_account_id, entry.amount, entry.notes || null]\n          )\n        }\n      }\n    }\n\n    if (notes) {\n      await client.query(\n        `UPDATE shifts SET notes = $1 WHERE id = $2`,\n        [notes, shift_id]\n      )\n    }\n\n    await client.query(\n      `UPDATE shifts SET reconciliation_status = 'reconciled', updated_at = NOW() WHERE id = $1`,\n      [shift_id]\n    )\n\n    await client.query('COMMIT')\n\n    return NextResponse.json({\n      success: true,\n      message: \"Shift reconciled successfully\"\n    })\n\n  } catch (error: any) {\n    await client.query('ROLLBACK')\n    console.error(\"Error reconciling shift:\", error)\n    return NextResponse.json(\n      { error: \"Failed to reconcile shift\", details: error.message },\n      { status: 500 }\n    )\n  } finally {\n    client.release()\n  }\n}\n"],"names":[],"mappings":"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"}}]
}