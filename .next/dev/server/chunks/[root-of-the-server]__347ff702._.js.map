{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/shifts/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const { branch_id, start_time, opening_cash, notes } = body\n\n    if (!branch_id) {\n      return NextResponse.json(\n        { error: \"Branch ID is required\" },\n        { status: 400 }\n      )\n    }\n\n    const existingShift = await pool.query(\n      `SELECT id FROM shifts WHERE branch_id = $1 AND status = 'active'`,\n      [branch_id]\n    )\n\n    if (existingShift.rows.length > 0) {\n      return NextResponse.json(\n        { error: \"An active shift already exists for this branch\" },\n        { status: 400 }\n      )\n    }\n\n    const result = await pool.query(\n      `INSERT INTO shifts (branch_id, start_time, status, opening_cash, notes, created_at)\n       VALUES ($1, $2, 'active', $3, $4, NOW())\n       RETURNING *`,\n      [branch_id, start_time || new Date().toISOString(), opening_cash || 0, notes || null]\n    )\n\n    return NextResponse.json({\n      success: true,\n      data: result.rows[0]\n    })\n\n  } catch (error: any) {\n    console.error(\"Error starting shift:\", error)\n    return NextResponse.json(\n      { error: \"Failed to start shift\", details: error.message },\n      { status: 500 }\n    )\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const branchId = searchParams.get('branch_id')\n    const status = searchParams.get('status')\n\n    let query = 'SELECT * FROM shifts WHERE 1=1'\n    const params: any[] = []\n\n    if (branchId) {\n      params.push(branchId)\n      query += ` AND branch_id = $${params.length}`\n    }\n\n    if (status) {\n      params.push(status)\n      query += ` AND status = $${params.length}`\n    }\n\n    query += ' ORDER BY created_at DESC LIMIT 1'\n\n    const result = await pool.query(query, params)\n\n    return NextResponse.json({\n      success: true,\n      data: result.rows[0] || null\n    })\n\n  } catch (error: any) {\n    console.error(\"Error fetching shift:\", error)\n    return NextResponse.json(\n      { error: \"Failed to fetch shift\", details: error.message },\n      { status: 500 }\n    )\n  }\n}\n\nexport async function PATCH(request: NextRequest) {\n  const client = await pool.connect()\n  try {\n    const body = await request.json()\n    const { id, end_time, closing_cash, total_sales, notes, status, nozzle_readings, tank_stocks } = body\n\n    if (!id) {\n      client.release()\n      return NextResponse.json(\n        { error: \"Shift ID is required\" },\n        { status: 400 }\n      )\n    }\n\n    await client.query('BEGIN')\n\n    const shiftCheck = await client.query(\n      `SELECT * FROM shifts WHERE id = $1`,\n      [id]\n    )\n\n    if (shiftCheck.rows.length === 0) {\n      await client.query('ROLLBACK')\n      client.release()\n      return NextResponse.json(\n        { error: \"Shift not found\" },\n        { status: 404 }\n      )\n    }\n\n    const currentShift = shiftCheck.rows[0]\n    const branchId = currentShift.branch_id\n    const endTimeValue = end_time || new Date().toISOString()\n\n    const nozzlesResult = await client.query(\n      `SELECT id, initial_meter_reading FROM nozzles WHERE branch_id = $1`,\n      [branchId]\n    )\n    const nozzleBaseReadings: Record<string, number> = {}\n    for (const n of nozzlesResult.rows) {\n      nozzleBaseReadings[n.id] = parseFloat(n.initial_meter_reading) || 0\n    }\n\n    const prevNozzleReadings = await client.query(\n      `SELECT nozzle_id, closing_reading FROM shift_readings \n       WHERE branch_id = $1 AND reading_type = 'nozzle' AND nozzle_id IS NOT NULL\n       ORDER BY created_at DESC`,\n      [branchId]\n    )\n    for (const r of prevNozzleReadings.rows) {\n      if (!nozzleBaseReadings[r.nozzle_id] || parseFloat(r.closing_reading) > nozzleBaseReadings[r.nozzle_id]) {\n        nozzleBaseReadings[r.nozzle_id] = parseFloat(r.closing_reading)\n      }\n    }\n\n    const tanksResult = await client.query(\n      `SELECT id, current_stock FROM tanks WHERE branch_id = $1`,\n      [branchId]\n    )\n    const tankBaseStocks: Record<string, number> = {}\n    for (const t of tanksResult.rows) {\n      tankBaseStocks[t.id] = parseFloat(t.current_stock) || 0\n    }\n\n    if (nozzle_readings && nozzle_readings.length > 0) {\n      for (const reading of nozzle_readings) {\n        if (reading.nozzle_id && !isNaN(reading.closing_reading)) {\n          const openingReading = nozzleBaseReadings[reading.nozzle_id] || 0\n          if (reading.closing_reading < openingReading) {\n            await client.query('ROLLBACK')\n            client.release()\n            return NextResponse.json(\n              { error: `Nozzle closing reading (${reading.closing_reading}) cannot be less than opening reading (${openingReading})` },\n              { status: 400 }\n            )\n          }\n        }\n      }\n    }\n\n    const result = await client.query(\n      `UPDATE shifts \n       SET end_time = $1, closing_cash = $2, total_sales = $3, notes = $4, status = $5, updated_at = NOW()\n       WHERE id = $6\n       RETURNING *`,\n      [endTimeValue, closing_cash || 0, total_sales || 0, notes || null, status || 'completed', id]\n    )\n\n    const shift = result.rows[0]\n\n    await client.query(\n      `DELETE FROM shift_readings WHERE shift_id = $1`,\n      [id]\n    )\n\n    if (nozzle_readings && nozzle_readings.length > 0) {\n      for (const reading of nozzle_readings) {\n        if (reading.nozzle_id && !isNaN(reading.closing_reading)) {\n          const openingReading = nozzleBaseReadings[reading.nozzle_id] || 0\n          await client.query(\n            `INSERT INTO shift_readings (shift_id, branch_id, reading_type, nozzle_id, opening_reading, closing_reading)\n             VALUES ($1, $2, 'nozzle', $3, $4, $5)`,\n            [id, branchId, reading.nozzle_id, openingReading, reading.closing_reading]\n          )\n        }\n      }\n    }\n\n    if (tank_stocks && tank_stocks.length > 0) {\n      for (const stock of tank_stocks) {\n        if (stock.tank_id && !isNaN(stock.closing_reading)) {\n          const openingStock = tankBaseStocks[stock.tank_id] || 0\n          const stockReceived = stock.stock_received || 0\n\n          await client.query(\n            `INSERT INTO shift_readings (shift_id, branch_id, reading_type, tank_id, opening_reading, closing_reading, stock_received)\n             VALUES ($1, $2, 'tank', $3, $4, $5, $6)`,\n            [id, branchId, stock.tank_id, openingStock, stock.closing_reading, stockReceived]\n          )\n\n          await client.query(\n            `UPDATE tanks SET current_stock = $1, updated_at = NOW() WHERE id = $2`,\n            [stock.closing_reading, stock.tank_id]\n          )\n        }\n      }\n    }\n\n    const newShiftResult = await client.query(\n      `INSERT INTO shifts (branch_id, start_time, status, opening_cash, notes, created_at)\n       VALUES ($1, $2, 'active', $3, NULL, NOW())\n       RETURNING *`,\n      [branchId, endTimeValue, closing_cash || 0]\n    )\n    const newShift = newShiftResult.rows[0]\n\n    await client.query('COMMIT')\n\n    return NextResponse.json({\n      success: true,\n      data: shift,\n      newShift: newShift\n    })\n\n  } catch (error: any) {\n    await client.query('ROLLBACK')\n    console.error(\"Error updating shift:\", error)\n    return NextResponse.json(\n      { error: \"Failed to update shift\", details: error.message },\n      { status: 500 }\n    )\n  } finally {\n    client.release()\n  }\n}\n"],"names":[],"mappings":"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"}}]
}