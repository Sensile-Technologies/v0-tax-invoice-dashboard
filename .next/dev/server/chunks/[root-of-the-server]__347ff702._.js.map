{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/shifts/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { Pool, PoolClient } from \"pg\"\nimport { callKraSaveSales } from \"@/lib/kra-sales-api\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nfunction splitIntoAmountDenominations(totalAmount: number): number[] {\n  const denominations: number[] = []\n  let remaining = totalAmount\n\n  const validDenoms = [2500, 2000, 1500, 1000, 500, 300, 200, 100]\n\n  while (remaining >= 100) {\n    const maxDenom = validDenoms.find(d => d <= remaining) || 100\n    const availableDenoms = validDenoms.filter(d => d >= 100 && d <= maxDenom && d <= remaining)\n    \n    if (availableDenoms.length === 0) break\n    \n    const randomDenom = availableDenoms[Math.floor(Math.random() * availableDenoms.length)]\n    denominations.push(randomDenom)\n    remaining -= randomDenom\n  }\n\n  if (remaining > 0 && remaining < 100 && denominations.length > 0) {\n    denominations[denominations.length - 1] += remaining\n  }\n\n  return denominations\n}\n\ninterface SaleForKra {\n  id: string\n  branch_id: string\n  invoice_number: string\n  receipt_number: string\n  fuel_type: string\n  quantity: number\n  unit_price: number\n  total_amount: number\n}\n\nasync function generateBulkSalesFromMeterDiff(\n  client: PoolClient,\n  shiftId: string,\n  branchId: string,\n  staffId: string | null,\n  branchName: string,\n  nozzleReadings: Array<{ nozzle_id: string; opening_reading: number; closing_reading: number }>\n): Promise<{ invoicesCreated: number; totalVolume: number; totalAmount: number; salesForKra: SaleForKra[] }> {\n  \n  const branchCode = branchName.substring(0, 3).toUpperCase().replace(/\\s/g, '')\n  let invoicesCreated = 0\n  let totalVolume = 0\n  let totalAmount = 0\n  let invoiceIndex = 1\n  const salesForKra: SaleForKra[] = []\n\n  for (const reading of nozzleReadings) {\n    const openingReading = parseFloat(String(reading.opening_reading)) || 0\n    const closingReading = parseFloat(String(reading.closing_reading)) || 0\n    const meterDifference = closingReading - openingReading\n\n    if (meterDifference <= 0) continue\n\n    const nozzleInfo = await client.query(\n      `SELECT i.item_name as fuel_type, n.item_id, COALESCE(bi.sale_price, 0) as sale_price\n       FROM nozzles n\n       JOIN items i ON n.item_id = i.id\n       LEFT JOIN branch_items bi ON bi.item_id = n.item_id AND bi.branch_id = $1\n       WHERE n.id = $2`,\n      [branchId, reading.nozzle_id]\n    )\n\n    if (nozzleInfo.rows.length === 0) continue\n\n    const { fuel_type, sale_price } = nozzleInfo.rows[0]\n    const unitPrice = parseFloat(sale_price) || 0\n\n    if (unitPrice <= 0) {\n      console.log(`[BULK SALES] Skipping nozzle ${reading.nozzle_id} - no price configured`)\n      continue\n    }\n\n    // Get invoiced quantity: sum of sales already created on APK for this nozzle during this shift\n    const invoicedResult = await client.query(\n      `SELECT COALESCE(SUM(quantity), 0) as invoiced_quantity\n       FROM sales\n       WHERE shift_id = $1 AND nozzle_id = $2 AND is_automated = false`,\n      [shiftId, reading.nozzle_id]\n    )\n    const invoicedQuantity = parseFloat(invoicedResult.rows[0]?.invoiced_quantity) || 0\n\n    // Bulk volume = meter difference - invoiced quantity (what was already sold via APK)\n    const bulkVolume = meterDifference - invoicedQuantity\n\n    if (bulkVolume <= 0) {\n      console.log(`[BULK SALES] Nozzle ${reading.nozzle_id}: meter diff ${meterDifference}L, invoiced ${invoicedQuantity}L, no bulk needed`)\n      continue\n    }\n\n    console.log(`[BULK SALES] Nozzle ${reading.nozzle_id}: meter diff ${meterDifference}L - invoiced ${invoicedQuantity}L = bulk ${bulkVolume}L`)\n\n    // Bulk sale = bulk volume Ã— price per litre\n    const nozzleTotalAmount = bulkVolume * unitPrice\n    const amountDenominations = splitIntoAmountDenominations(Math.floor(nozzleTotalAmount))\n\n    for (const invoiceAmount of amountDenominations) {\n      const quantity = invoiceAmount / unitPrice\n      const timestamp = Date.now().toString(36).toUpperCase()\n      const invoiceNumber = `BLK-${branchCode}-${timestamp}-${String(invoiceIndex).padStart(4, '0')}`\n      const receiptNumber = `RCP-${timestamp}-${Math.random().toString(36).substring(2, 6).toUpperCase()}`\n\n      const saleResult = await client.query(\n        `INSERT INTO sales (\n          branch_id, shift_id, staff_id, nozzle_id,\n          invoice_number, receipt_number, sale_date,\n          fuel_type, quantity, unit_price, total_amount,\n          payment_method, is_automated, source_system,\n          transmission_status, created_at\n        ) VALUES (\n          $1, $2, $3, $4, $5, $6, NOW(),\n          $7, $8, $9, $10,\n          'cash', true, 'meter_diff_bulk',\n          'pending', NOW()\n        ) RETURNING id`,\n        [branchId, shiftId, staffId, reading.nozzle_id, invoiceNumber, receiptNumber,\n         fuel_type, parseFloat(quantity.toFixed(2)), unitPrice, invoiceAmount]\n      )\n\n      salesForKra.push({\n        id: saleResult.rows[0]?.id,\n        branch_id: branchId,\n        invoice_number: invoiceNumber,\n        receipt_number: receiptNumber,\n        fuel_type,\n        quantity: parseFloat(quantity.toFixed(2)),\n        unit_price: unitPrice,\n        total_amount: invoiceAmount\n      })\n\n      invoicesCreated++\n      totalVolume += quantity\n      totalAmount += invoiceAmount\n      invoiceIndex++\n    }\n  }\n\n  console.log(`[BULK SALES] Generated ${invoicesCreated} invoices, ${totalVolume.toFixed(2)}L, KES ${totalAmount}`)\n  return { invoicesCreated, totalVolume, totalAmount, salesForKra }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const { branch_id, start_time, opening_cash, notes, staff_id, user_id } = body\n\n    if (!branch_id) {\n      return NextResponse.json(\n        { error: \"Branch ID is required\" },\n        { status: 400 }\n      )\n    }\n\n    const existingShift = await pool.query(\n      `SELECT id FROM shifts WHERE branch_id = $1 AND status = 'active'`,\n      [branch_id]\n    )\n\n    if (existingShift.rows.length > 0) {\n      return NextResponse.json(\n        { error: \"An active shift already exists for this branch\" },\n        { status: 400 }\n      )\n    }\n\n    let resolvedStaffId = staff_id\n    if (!resolvedStaffId && user_id) {\n      const staffResult = await pool.query(\n        `SELECT id FROM staff WHERE user_id = $1`,\n        [user_id]\n      )\n      if (staffResult.rows.length > 0) {\n        resolvedStaffId = staffResult.rows[0].id\n      }\n    }\n\n    const result = await pool.query(\n      `INSERT INTO shifts (branch_id, staff_id, start_time, status, opening_cash, notes, created_at)\n       VALUES ($1, $2, $3, 'active', $4, $5, NOW())\n       RETURNING *`,\n      [branch_id, resolvedStaffId || null, start_time || new Date().toISOString(), opening_cash || 0, notes || null]\n    )\n\n    return NextResponse.json({\n      success: true,\n      data: result.rows[0]\n    })\n\n  } catch (error: any) {\n    console.error(\"Error starting shift:\", error)\n    return NextResponse.json(\n      { error: \"Failed to start shift\", details: error.message },\n      { status: 500 }\n    )\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const branchId = searchParams.get('branch_id')\n    const status = searchParams.get('status')\n\n    let query = 'SELECT * FROM shifts WHERE 1=1'\n    const params: any[] = []\n\n    if (branchId) {\n      params.push(branchId)\n      query += ` AND branch_id = $${params.length}`\n    }\n\n    if (status) {\n      params.push(status)\n      query += ` AND status = $${params.length}`\n    }\n\n    query += ' ORDER BY created_at DESC LIMIT 1'\n\n    const result = await pool.query(query, params)\n\n    return NextResponse.json({\n      success: true,\n      data: result.rows[0] || null\n    })\n\n  } catch (error: any) {\n    console.error(\"Error fetching shift:\", error)\n    return NextResponse.json(\n      { error: \"Failed to fetch shift\", details: error.message },\n      { status: 500 }\n    )\n  }\n}\n\nexport async function PATCH(request: NextRequest) {\n  const client = await pool.connect()\n  try {\n    const body = await request.json()\n    const { id, end_time, total_sales, notes, status, nozzle_readings, tank_stocks, attendant_collections } = body\n\n    if (!id) {\n      client.release()\n      return NextResponse.json(\n        { error: \"Shift ID is required\" },\n        { status: 400 }\n      )\n    }\n\n    await client.query('BEGIN')\n\n    // Check if this is an active shift being ended\n    const shiftStatusCheck = await client.query(\n      `SELECT status FROM shifts WHERE id = $1`,\n      [id]\n    )\n    \n    if (shiftStatusCheck.rows.length === 0) {\n      await client.query('ROLLBACK')\n      client.release()\n      return NextResponse.json(\n        { error: \"Shift not found\" },\n        { status: 404 }\n      )\n    }\n\n    const currentStatus = shiftStatusCheck.rows[0].status\n    const targetStatus = status || 'completed'\n    \n    // Require nozzle readings when ending an active shift (transitioning to completed)\n    if (currentStatus === 'active' && targetStatus === 'completed') {\n      if (!nozzle_readings || !Array.isArray(nozzle_readings) || nozzle_readings.length === 0) {\n        await client.query('ROLLBACK')\n        client.release()\n        return NextResponse.json(\n          { error: \"Nozzle meter readings are required to end a shift. Please enter closing readings for all nozzles.\" },\n          { status: 400 }\n        )\n      }\n\n      // Get the branch_id from shift to find active nozzles\n      const shiftBranchResult = await client.query(\n        `SELECT branch_id FROM shifts WHERE id = $1`,\n        [id]\n      )\n      const shiftBranchId = shiftBranchResult.rows[0]?.branch_id\n\n      if (shiftBranchId) {\n        // Get all active nozzles for this branch\n        const activeNozzlesResult = await client.query(\n          `SELECT n.id, n.nozzle_number, i.item_name as fuel_type\n           FROM nozzles n\n           LEFT JOIN items i ON n.item_id = i.id\n           WHERE n.branch_id = $1 AND n.status = 'active'`,\n          [shiftBranchId]\n        )\n\n        const activeNozzleIds = new Set(activeNozzlesResult.rows.map((n: any) => n.id))\n        \n        const isValidNumeric = (val: any) => val !== null && val !== undefined && val !== '' && !isNaN(Number(val))\n        \n        const submittedNozzleIds = new Set(\n          nozzle_readings\n            .filter((r: any) => r.nozzle_id && isValidNumeric(r.closing_reading))\n            .map((r: any) => r.nozzle_id)\n        )\n\n        // Find nozzles that are active but missing readings\n        const missingNozzles = activeNozzlesResult.rows.filter(\n          (n: any) => !submittedNozzleIds.has(n.id)\n        )\n\n        if (missingNozzles.length > 0) {\n          const missingList = missingNozzles\n            .map((n: any) => `Nozzle ${n.nozzle_number} (${n.fuel_type || 'Unknown'})`)\n            .join(', ')\n          \n          await client.query('ROLLBACK')\n          client.release()\n          return NextResponse.json(\n            { \n              error: `Cannot close shift: missing readings for ${missingNozzles.length} active nozzle(s): ${missingList}. Please enter closing readings for all nozzles.`,\n              missingNozzles: missingNozzles.map((n: any) => ({ id: n.id, number: n.nozzle_number, fuel_type: n.fuel_type }))\n            },\n            { status: 400 }\n          )\n        }\n        \n        const nozzlesWithoutAttendants = nozzle_readings\n          .filter((r: any) => r.nozzle_id && isValidNumeric(r.closing_reading) && !r.incoming_attendant_id)\n        \n        if (nozzlesWithoutAttendants.length > 0) {\n          const missingAttendantNozzles = activeNozzlesResult.rows.filter(\n            (n: any) => nozzlesWithoutAttendants.some((r: any) => r.nozzle_id === n.id)\n          )\n          const missingList = missingAttendantNozzles\n            .map((n: any) => `Nozzle ${n.nozzle_number} (${n.fuel_type || 'Unknown'})`)\n            .join(', ')\n          \n          await client.query('ROLLBACK')\n          client.release()\n          return NextResponse.json(\n            { \n              error: `Cannot close shift: missing incoming attendant for nozzle(s): ${missingList}. Please select an incoming attendant for each nozzle.`\n            },\n            { status: 400 }\n          )\n        }\n      }\n    }\n\n    const shiftCheck = await client.query(\n      `SELECT s.*, b.name as branch_name FROM shifts s\n       JOIN branches b ON s.branch_id = b.id\n       WHERE s.id = $1`,\n      [id]\n    )\n\n    if (shiftCheck.rows.length === 0) {\n      await client.query('ROLLBACK')\n      client.release()\n      return NextResponse.json(\n        { error: \"Shift not found\" },\n        { status: 404 }\n      )\n    }\n\n    const currentShift = shiftCheck.rows[0]\n    const branchId = currentShift.branch_id\n    const branchName = currentShift.branch_name || 'BRN'\n    const staffId = currentShift.staff_id\n    const endTimeValue = end_time || new Date().toISOString()\n\n    const nozzlesResult = await client.query(\n      `SELECT id, initial_meter_reading FROM nozzles WHERE branch_id = $1`,\n      [branchId]\n    )\n    const nozzleBaseReadings: Record<string, number> = {}\n    for (const n of nozzlesResult.rows) {\n      nozzleBaseReadings[n.id] = parseFloat(n.initial_meter_reading) || 0\n    }\n\n    const prevNozzleReadings = await client.query(\n      `SELECT nozzle_id, closing_reading FROM shift_readings \n       WHERE branch_id = $1 AND reading_type = 'nozzle' AND nozzle_id IS NOT NULL\n       ORDER BY created_at DESC`,\n      [branchId]\n    )\n    for (const r of prevNozzleReadings.rows) {\n      if (!nozzleBaseReadings[r.nozzle_id] || parseFloat(r.closing_reading) > nozzleBaseReadings[r.nozzle_id]) {\n        nozzleBaseReadings[r.nozzle_id] = parseFloat(r.closing_reading)\n      }\n    }\n\n    const tanksResult = await client.query(\n      `SELECT id, current_stock FROM tanks WHERE branch_id = $1`,\n      [branchId]\n    )\n    const tankBaseStocks: Record<string, number> = {}\n    for (const t of tanksResult.rows) {\n      tankBaseStocks[t.id] = parseFloat(t.current_stock) || 0\n    }\n\n    if (nozzle_readings && nozzle_readings.length > 0) {\n      for (const reading of nozzle_readings) {\n        if (reading.nozzle_id && !isNaN(reading.closing_reading)) {\n          const openingReading = nozzleBaseReadings[reading.nozzle_id] || 0\n          if (reading.closing_reading < openingReading) {\n            await client.query('ROLLBACK')\n            client.release()\n            return NextResponse.json(\n              { error: `Nozzle closing reading (${reading.closing_reading}) cannot be less than opening reading (${openingReading})` },\n              { status: 400 }\n            )\n          }\n        }\n      }\n    }\n\n    const result = await client.query(\n      `UPDATE shifts \n       SET end_time = $1, total_sales = $2, notes = $3, status = $4, updated_at = NOW()\n       WHERE id = $5\n       RETURNING *`,\n      [endTimeValue, total_sales || 0, notes || null, status || 'completed', id]\n    )\n\n    const shift = result.rows[0]\n\n    await client.query(\n      `DELETE FROM shift_readings WHERE shift_id = $1`,\n      [id]\n    )\n\n    const savedNozzleReadings: Array<{ nozzle_id: string; opening_reading: number; closing_reading: number }> = []\n    \n    if (nozzle_readings && nozzle_readings.length > 0) {\n      for (const reading of nozzle_readings) {\n        if (reading.nozzle_id && !isNaN(reading.closing_reading)) {\n          const openingReading = nozzleBaseReadings[reading.nozzle_id] || 0\n          const incomingAttendantId = reading.incoming_attendant_id || null\n          const rtt = parseFloat(reading.rtt) || 0\n          const selfFueling = parseFloat(reading.self_fueling) || 0\n          const prepaidSale = parseFloat(reading.prepaid_sale) || 0\n          await client.query(\n            `INSERT INTO shift_readings (shift_id, branch_id, reading_type, nozzle_id, opening_reading, closing_reading, incoming_attendant_id, rtt, self_fueling, prepaid_sale)\n             VALUES ($1, $2, 'nozzle', $3, $4, $5, $6, $7, $8, $9)`,\n            [id, branchId, reading.nozzle_id, openingReading, reading.closing_reading, incomingAttendantId, rtt, selfFueling, prepaidSale]\n          )\n          savedNozzleReadings.push({\n            nozzle_id: reading.nozzle_id,\n            opening_reading: openingReading,\n            closing_reading: reading.closing_reading\n          })\n        }\n      }\n    }\n\n    let bulkSalesResult = { invoicesCreated: 0, totalVolume: 0, totalAmount: 0, salesForKra: [] as SaleForKra[] }\n    if (savedNozzleReadings.length > 0) {\n      bulkSalesResult = await generateBulkSalesFromMeterDiff(\n        client, id, branchId, staffId, branchName, savedNozzleReadings\n      )\n      \n      if (bulkSalesResult.totalAmount > 0) {\n        await client.query(\n          `UPDATE shifts SET total_sales = $1 WHERE id = $2`,\n          [bulkSalesResult.totalAmount, id]\n        )\n      }\n    }\n\n    if (tank_stocks && tank_stocks.length > 0) {\n      for (const stock of tank_stocks) {\n        const closingStock = stock.closing_stock ?? stock.closing_reading\n        if (stock.tank_id && !isNaN(closingStock)) {\n          const openingStock = tankBaseStocks[stock.tank_id] || 0\n          const stockReceived = stock.stock_received || 0\n\n          await client.query(\n            `INSERT INTO shift_readings (shift_id, branch_id, reading_type, tank_id, opening_reading, closing_reading, stock_received)\n             VALUES ($1, $2, 'tank', $3, $4, $5, $6)`,\n            [id, branchId, stock.tank_id, openingStock, closingStock, stockReceived]\n          )\n\n          await client.query(\n            `UPDATE tanks SET current_stock = $1, updated_at = NOW() WHERE id = $2`,\n            [closingStock, stock.tank_id]\n          )\n        }\n      }\n    }\n\n    await client.query(\n      `DELETE FROM attendant_collections WHERE shift_id = $1`,\n      [id]\n    )\n    \n    if (attendant_collections && attendant_collections.length > 0) {\n      for (const collection of attendant_collections) {\n        if (collection.staff_id && collection.payment_method && collection.amount > 0) {\n          await client.query(\n            `INSERT INTO attendant_collections (shift_id, branch_id, staff_id, payment_method, amount, is_app_payment)\n             VALUES ($1, $2, $3, $4, $5, false)`,\n            [id, branchId, collection.staff_id, collection.payment_method, collection.amount]\n          )\n        }\n      }\n    }\n\n    const newShiftResult = await client.query(\n      `INSERT INTO shifts (branch_id, start_time, status, opening_cash, notes, created_at)\n       VALUES ($1, $2, 'active', 0, NULL, NOW())\n       RETURNING *`,\n      [branchId, endTimeValue]\n    )\n    const newShift = newShiftResult.rows[0]\n\n    await client.query('COMMIT')\n\n    // DISABLED: Bulk sales KRA submission\n    // Bulk sales are stored locally but not sent to KRA - batch update for performance\n    if (bulkSalesResult.salesForKra.length > 0) {\n      console.log(`[BULK SALES] Created ${bulkSalesResult.salesForKra.length} invoices locally (KRA submission disabled)`)\n      const saleIds = bulkSalesResult.salesForKra.map(s => s.id)\n      await pool.query(\n        `UPDATE sales SET \n          kra_status = 'pending',\n          transmission_status = 'not_sent',\n          updated_at = NOW()\n        WHERE id = ANY($1)`,\n        [saleIds]\n      )\n    }\n\n    return NextResponse.json({\n      success: true,\n      data: shift,\n      newShift: newShift,\n      bulkSales: {\n        invoicesCreated: bulkSalesResult.invoicesCreated,\n        totalVolume: bulkSalesResult.totalVolume,\n        totalAmount: bulkSalesResult.totalAmount\n      }\n    })\n\n  } catch (error: any) {\n    await client.query('ROLLBACK')\n    console.error(\"Error updating shift:\", error)\n    return NextResponse.json(\n      { error: \"Failed to update shift\", details: error.message },\n      { status: 500 }\n    )\n  } finally {\n    client.release()\n  }\n}\n"],"names":[],"mappings":"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"}}]
}