{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/expense-accounts/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\nimport { cookies } from \"next/headers\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nasync function getSession() {\n  const cookieStore = await cookies()\n  const sessionCookie = cookieStore.get(\"user_session\")\n  if (!sessionCookie) return null\n  try {\n    return JSON.parse(sessionCookie.value)\n  } catch {\n    return null\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  const client = await pool.connect()\n  \n  try {\n    const session = await getSession()\n    if (!session) {\n      return NextResponse.json({ success: false, error: \"Unauthorized\" }, { status: 401 })\n    }\n\n    const userResult = await client.query(\n      `SELECT u.id, COALESCE(s.role, u.role) as role, v.id as vendor_id, s.branch_id\n       FROM users u\n       LEFT JOIN vendors v ON v.email = u.email\n       LEFT JOIN staff s ON s.user_id = u.id\n       WHERE u.id = $1`,\n      [session.id]\n    )\n\n    if (userResult.rows.length === 0) {\n      return NextResponse.json({ success: false, error: \"User not found\" }, { status: 404 })\n    }\n\n    const user = userResult.rows[0]\n    let vendorId = user.vendor_id\n\n    if (!vendorId && user.branch_id) {\n      const branchResult = await client.query(\n        'SELECT vendor_id FROM branches WHERE id = $1',\n        [user.branch_id]\n      )\n      vendorId = branchResult.rows[0]?.vendor_id\n    }\n\n    if (!vendorId) {\n      return NextResponse.json({ success: false, error: \"Vendor not found\" }, { status: 404 })\n    }\n\n    const result = await client.query(\n      `SELECT id, account_name, description, is_active, created_at, updated_at\n       FROM expense_accounts\n       WHERE vendor_id = $1\n       ORDER BY account_name`,\n      [vendorId]\n    )\n\n    return NextResponse.json({\n      success: true,\n      data: result.rows\n    })\n\n  } catch (error) {\n    console.error(\"Error fetching expense accounts:\", error)\n    return NextResponse.json({ success: false, error: \"Failed to fetch expense accounts\" }, { status: 500 })\n  } finally {\n    client.release()\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  const client = await pool.connect()\n  \n  try {\n    const session = await getSession()\n    if (!session) {\n      return NextResponse.json({ success: false, error: \"Unauthorized\" }, { status: 401 })\n    }\n\n    const body = await request.json()\n    const { account_name, description } = body\n\n    if (!account_name?.trim()) {\n      return NextResponse.json({ success: false, error: \"Account name is required\" }, { status: 400 })\n    }\n\n    const userResult = await client.query(\n      `SELECT u.id, COALESCE(s.role, u.role) as role, v.id as vendor_id, s.branch_id\n       FROM users u\n       LEFT JOIN vendors v ON v.email = u.email\n       LEFT JOIN staff s ON s.user_id = u.id\n       WHERE u.id = $1`,\n      [session.id]\n    )\n\n    if (userResult.rows.length === 0) {\n      return NextResponse.json({ success: false, error: \"User not found\" }, { status: 404 })\n    }\n\n    const user = userResult.rows[0]\n    let vendorId = user.vendor_id\n\n    if (!vendorId && user.branch_id) {\n      const branchResult = await client.query(\n        'SELECT vendor_id FROM branches WHERE id = $1',\n        [user.branch_id]\n      )\n      vendorId = branchResult.rows[0]?.vendor_id\n    }\n\n    if (!vendorId) {\n      return NextResponse.json({ success: false, error: \"Vendor not found\" }, { status: 404 })\n    }\n\n    const result = await client.query(\n      `INSERT INTO expense_accounts (vendor_id, account_name, description)\n       VALUES ($1, $2, $3)\n       RETURNING id, account_name, description, is_active, created_at`,\n      [vendorId, account_name.trim(), description?.trim() || null]\n    )\n\n    return NextResponse.json({\n      success: true,\n      data: result.rows[0]\n    })\n\n  } catch (error: any) {\n    console.error(\"Error creating expense account:\", error)\n    if (error.code === '23505') {\n      return NextResponse.json({ success: false, error: \"An account with this name already exists\" }, { status: 400 })\n    }\n    return NextResponse.json({ success: false, error: \"Failed to create expense account\" }, { status: 500 })\n  } finally {\n    client.release()\n  }\n}\n\nexport async function PUT(request: NextRequest) {\n  const client = await pool.connect()\n  \n  try {\n    const session = await getSession()\n    if (!session) {\n      return NextResponse.json({ success: false, error: \"Unauthorized\" }, { status: 401 })\n    }\n\n    const body = await request.json()\n    const { id, account_name, description, is_active } = body\n\n    if (!id) {\n      return NextResponse.json({ success: false, error: \"Account ID is required\" }, { status: 400 })\n    }\n\n    const userResult = await client.query(\n      `SELECT u.id, COALESCE(s.role, u.role) as role, v.id as vendor_id\n       FROM users u\n       LEFT JOIN vendors v ON v.email = u.email\n       LEFT JOIN staff s ON s.user_id = u.id\n       WHERE u.id = $1`,\n      [session.id]\n    )\n\n    if (userResult.rows.length === 0) {\n      return NextResponse.json({ success: false, error: \"User not found\" }, { status: 404 })\n    }\n\n    const user = userResult.rows[0]\n    let vendorId = user.vendor_id\n\n    if (!vendorId) {\n      const staffResult = await client.query(\n        'SELECT b.vendor_id FROM staff s JOIN branches b ON s.branch_id = b.id WHERE s.user_id = $1',\n        [session.id]\n      )\n      vendorId = staffResult.rows[0]?.vendor_id\n    }\n\n    const accountCheck = await client.query(\n      'SELECT id FROM expense_accounts WHERE id = $1 AND vendor_id = $2',\n      [id, vendorId]\n    )\n\n    if (accountCheck.rows.length === 0) {\n      return NextResponse.json({ success: false, error: \"Account not found\" }, { status: 404 })\n    }\n\n    const result = await client.query(\n      `UPDATE expense_accounts \n       SET account_name = COALESCE($2, account_name),\n           description = COALESCE($3, description),\n           is_active = COALESCE($4, is_active),\n           updated_at = NOW()\n       WHERE id = $1\n       RETURNING id, account_name, description, is_active, updated_at`,\n      [id, account_name?.trim(), description?.trim(), is_active]\n    )\n\n    return NextResponse.json({\n      success: true,\n      data: result.rows[0]\n    })\n\n  } catch (error: any) {\n    console.error(\"Error updating expense account:\", error)\n    if (error.code === '23505') {\n      return NextResponse.json({ success: false, error: \"An account with this name already exists\" }, { status: 400 })\n    }\n    return NextResponse.json({ success: false, error: \"Failed to update expense account\" }, { status: 500 })\n  } finally {\n    client.release()\n  }\n}\n\nexport async function DELETE(request: NextRequest) {\n  const client = await pool.connect()\n  \n  try {\n    const session = await getSession()\n    if (!session) {\n      return NextResponse.json({ success: false, error: \"Unauthorized\" }, { status: 401 })\n    }\n\n    const { searchParams } = new URL(request.url)\n    const id = searchParams.get('id')\n\n    if (!id) {\n      return NextResponse.json({ success: false, error: \"Account ID is required\" }, { status: 400 })\n    }\n\n    const userResult = await client.query(\n      `SELECT u.id, v.id as vendor_id\n       FROM users u\n       LEFT JOIN vendors v ON v.email = u.email\n       WHERE u.id = $1`,\n      [session.id]\n    )\n\n    const user = userResult.rows[0]\n    let vendorId = user?.vendor_id\n\n    if (!vendorId) {\n      const staffResult = await client.query(\n        'SELECT b.vendor_id FROM staff s JOIN branches b ON s.branch_id = b.id WHERE s.user_id = $1',\n        [session.id]\n      )\n      vendorId = staffResult.rows[0]?.vendor_id\n    }\n\n    const usageCheck = await client.query(\n      'SELECT COUNT(*) as count FROM shift_expenses WHERE expense_account_id = $1',\n      [id]\n    )\n\n    if (parseInt(usageCheck.rows[0].count) > 0) {\n      return NextResponse.json({ \n        success: false, \n        error: \"Cannot delete account - it has been used in shift expenses\" \n      }, { status: 400 })\n    }\n\n    await client.query(\n      'DELETE FROM expense_accounts WHERE id = $1 AND vendor_id = $2',\n      [id, vendorId]\n    )\n\n    return NextResponse.json({ success: true })\n\n  } catch (error) {\n    console.error(\"Error deleting expense account:\", error)\n    return NextResponse.json({ success: false, error: \"Failed to delete expense account\" }, { status: 500 })\n  } finally {\n    client.release()\n  }\n}\n"],"names":[],"mappings":"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"}}]
}