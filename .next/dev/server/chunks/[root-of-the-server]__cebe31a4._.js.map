{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/client.ts"],"sourcesContent":["import { Pool } from 'pg';\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,\n});\n\nexport async function query<T = any>(text: string, params?: any[]): Promise<T[]> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rows as T[];\n  } finally {\n    client.release();\n  }\n}\n\nexport async function queryOne<T = any>(text: string, params?: any[]): Promise<T | null> {\n  const rows = await query<T>(text, params);\n  return rows[0] || null;\n}\n\nexport async function execute(text: string, params?: any[]): Promise<number> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rowCount || 0;\n  } finally {\n    client.release();\n  }\n}\n\nexport { pool };\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,sCAAwC,0BAAgC;AAC/E;AAEO,eAAe,MAAe,IAAY,EAAE,MAAc;IAC/D,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,IAAI;IACpB,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe,SAAkB,IAAY,EAAE,MAAc;IAClE,MAAM,OAAO,MAAM,MAAS,MAAM;IAClC,OAAO,IAAI,CAAC,EAAE,IAAI;AACpB;AAEO,eAAe,QAAQ,IAAY,EAAE,MAAc;IACxD,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,QAAQ,IAAI;IAC5B,SAAU;QACR,OAAO,OAAO;IAChB;AACF"}},
    {"offset": {"line": 102, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/supabase/server.ts"],"sourcesContent":["import { query, queryOne, execute } from '../db/client';\n\nexport async function createClient() {\n  return {\n    from: (table: string) => createQueryBuilder(table),\n    auth: createAuthClient(),\n  };\n}\n\nfunction createQueryBuilder(table: string) {\n  let selectColumns = '*';\n  let whereConditions: { column: string; operator: string; value: any }[] = [];\n  let orderByColumn: string | null = null;\n  let orderDirection: 'asc' | 'desc' = 'asc';\n  let limitCount: number | null = null;\n  let singleResult = false;\n\n  const builder = {\n    select: (columns = '*') => {\n      selectColumns = columns;\n      return builder;\n    },\n    insert: async (data: any | any[]) => {\n      const rows = Array.isArray(data) ? data : [data];\n      if (rows.length === 0) return { data: [], error: null };\n      \n      const columns = Object.keys(rows[0]);\n      const values = rows.map((row, i) => \n        `(${columns.map((_, j) => `$${i * columns.length + j + 1}`).join(', ')})`\n      ).join(', ');\n      const params = rows.flatMap(row => columns.map(col => row[col]));\n      \n      try {\n        const sql = `INSERT INTO ${table} (${columns.join(', ')}) VALUES ${values} RETURNING *`;\n        const result = await query(sql, params);\n        return { data: result, error: null };\n      } catch (error: any) {\n        return { data: null, error: { message: error.message } };\n      }\n    },\n    update: async (data: any) => {\n      const columns = Object.keys(data);\n      const setClause = columns.map((col, i) => `${col} = $${i + 1}`).join(', ');\n      const params = columns.map(col => data[col]);\n      \n      let sql = `UPDATE ${table} SET ${setClause}`;\n      let paramIndex = params.length;\n      \n      if (whereConditions.length > 0) {\n        const whereClauses = whereConditions.map((cond, i) => {\n          paramIndex++;\n          return `${cond.column} ${cond.operator} $${paramIndex}`;\n        });\n        sql += ` WHERE ${whereClauses.join(' AND ')}`;\n        params.push(...whereConditions.map(c => c.value));\n      }\n      \n      sql += ' RETURNING *';\n      \n      try {\n        const result = await query(sql, params);\n        return { data: result, error: null };\n      } catch (error: any) {\n        return { data: null, error: { message: error.message } };\n      }\n    },\n    delete: async () => {\n      let sql = `DELETE FROM ${table}`;\n      const params: any[] = [];\n      \n      if (whereConditions.length > 0) {\n        const whereClauses = whereConditions.map((cond, i) => {\n          return `${cond.column} ${cond.operator} $${i + 1}`;\n        });\n        sql += ` WHERE ${whereClauses.join(' AND ')}`;\n        params.push(...whereConditions.map(c => c.value));\n      }\n      \n      sql += ' RETURNING *';\n      \n      try {\n        const result = await query(sql, params);\n        return { data: result, error: null };\n      } catch (error: any) {\n        return { data: null, error: { message: error.message } };\n      }\n    },\n    upsert: async (data: any | any[], options?: { onConflict?: string }) => {\n      const rows = Array.isArray(data) ? data : [data];\n      if (rows.length === 0) return { data: [], error: null };\n      \n      const columns = Object.keys(rows[0]);\n      const values = rows.map((row, i) => \n        `(${columns.map((_, j) => `$${i * columns.length + j + 1}`).join(', ')})`\n      ).join(', ');\n      const params = rows.flatMap(row => columns.map(col => row[col]));\n      \n      const conflictColumns = options?.onConflict || 'id';\n      const updateColumns = columns.filter(c => !conflictColumns.split(',').includes(c));\n      const updateClause = updateColumns.map(c => `${c} = EXCLUDED.${c}`).join(', ');\n      \n      try {\n        let sql = `INSERT INTO ${table} (${columns.join(', ')}) VALUES ${values}`;\n        if (updateClause) {\n          sql += ` ON CONFLICT (${conflictColumns}) DO UPDATE SET ${updateClause}`;\n        } else {\n          sql += ` ON CONFLICT (${conflictColumns}) DO NOTHING`;\n        }\n        sql += ' RETURNING *';\n        const result = await query(sql, params);\n        return { data: result, error: null };\n      } catch (error: any) {\n        return { data: null, error: { message: error.message } };\n      }\n    },\n    eq: (column: string, value: any) => {\n      whereConditions.push({ column, operator: '=', value });\n      return builder;\n    },\n    neq: (column: string, value: any) => {\n      whereConditions.push({ column, operator: '!=', value });\n      return builder;\n    },\n    gt: (column: string, value: any) => {\n      whereConditions.push({ column, operator: '>', value });\n      return builder;\n    },\n    gte: (column: string, value: any) => {\n      whereConditions.push({ column, operator: '>=', value });\n      return builder;\n    },\n    lt: (column: string, value: any) => {\n      whereConditions.push({ column, operator: '<', value });\n      return builder;\n    },\n    lte: (column: string, value: any) => {\n      whereConditions.push({ column, operator: '<=', value });\n      return builder;\n    },\n    like: (column: string, value: any) => {\n      whereConditions.push({ column, operator: 'LIKE', value });\n      return builder;\n    },\n    ilike: (column: string, value: any) => {\n      whereConditions.push({ column, operator: 'ILIKE', value });\n      return builder;\n    },\n    is: (column: string, value: any) => {\n      whereConditions.push({ column, operator: 'IS', value });\n      return builder;\n    },\n    in: (column: string, values: any[]) => {\n      whereConditions.push({ column, operator: 'IN', value: values });\n      return builder;\n    },\n    order: (column: string, options?: { ascending?: boolean }) => {\n      orderByColumn = column;\n      orderDirection = options?.ascending === false ? 'desc' : 'asc';\n      return builder;\n    },\n    limit: (count: number) => {\n      limitCount = count;\n      return builder;\n    },\n    single: () => {\n      singleResult = true;\n      limitCount = 1;\n      return builder;\n    },\n    maybeSingle: () => {\n      singleResult = true;\n      limitCount = 1;\n      return builder;\n    },\n    then: async (resolve: any, reject?: any) => {\n      try {\n        let sql = `SELECT ${selectColumns} FROM ${table}`;\n        const params: any[] = [];\n        let paramIndex = 0;\n        \n        if (whereConditions.length > 0) {\n          const whereClauses = whereConditions.map(cond => {\n            if (cond.operator === 'IN') {\n              const placeholders = cond.value.map(() => `$${++paramIndex}`).join(', ');\n              params.push(...cond.value);\n              return `${cond.column} IN (${placeholders})`;\n            } else if (cond.operator === 'IS') {\n              return `${cond.column} IS ${cond.value}`;\n            } else {\n              paramIndex++;\n              params.push(cond.value);\n              return `${cond.column} ${cond.operator} $${paramIndex}`;\n            }\n          });\n          sql += ` WHERE ${whereClauses.join(' AND ')}`;\n        }\n        \n        if (orderByColumn) {\n          sql += ` ORDER BY ${orderByColumn} ${orderDirection.toUpperCase()}`;\n        }\n        \n        if (limitCount !== null) {\n          sql += ` LIMIT ${limitCount}`;\n        }\n        \n        const result = await query(sql, params);\n        const data = singleResult ? (result[0] || null) : result;\n        resolve({ data, error: null });\n      } catch (error: any) {\n        if (reject) {\n          reject(error);\n        } else {\n          resolve({ data: null, error: { message: error.message } });\n        }\n      }\n    },\n  };\n  \n  return builder;\n}\n\nfunction createAuthClient() {\n  return {\n    getUser: async () => {\n      return { data: { user: null }, error: null };\n    },\n    getSession: async () => {\n      return { data: { session: null }, error: null };\n    },\n    signInWithPassword: async (credentials: { email: string; password: string }) => {\n      return { data: { user: null, session: null }, error: { message: 'Local auth not implemented' } };\n    },\n    signUp: async (credentials: { email: string; password: string }) => {\n      return { data: { user: null, session: null }, error: { message: 'Local auth not implemented' } };\n    },\n    signOut: async () => {\n      return { error: null };\n    },\n    onAuthStateChange: (callback: any) => {\n      return { data: { subscription: { unsubscribe: () => {} } } };\n    },\n  };\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 466, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/api-logger.ts"],"sourcesContent":["import { createClient } from \"@/lib/supabase/server\"\n\nexport interface ApiLogEntry {\n  endpoint: string\n  method: string\n  payload?: any\n  response?: any\n  statusCode?: number\n  error?: string\n  durationMs?: number\n  branchId?: string\n  externalEndpoint?: string\n}\n\nexport async function logApiCall(entry: ApiLogEntry) {\n  try {\n    const supabase = await createClient()\n\n    await supabase.from(\"api_logs\").insert({\n      endpoint: entry.endpoint,\n      method: entry.method,\n      payload: entry.payload || null,\n      response: entry.response || null,\n      status_code: entry.statusCode || null,\n      error: entry.error || null,\n      duration_ms: entry.durationMs || null,\n      branch_id: entry.branchId || null,\n      user_agent: entry.externalEndpoint || null,\n    })\n  } catch (error) {\n    console.error(\"[v0] Failed to log API call:\", error)\n  }\n}\n\nexport function createApiLogger(endpoint: string, method = \"POST\") {\n  const startTime = Date.now()\n\n  return {\n    success: async (payload: any, response: any, branchId?: string, externalEndpoint?: string) => {\n      const duration = Date.now() - startTime\n      await logApiCall({\n        endpoint,\n        method,\n        payload,\n        response,\n        statusCode: 200,\n        durationMs: duration,\n        branchId,\n        externalEndpoint,\n      })\n    },\n    error: async (payload: any, error: any, statusCode = 500, branchId?: string, externalEndpoint?: string) => {\n      const duration = Date.now() - startTime\n      await logApiCall({\n        endpoint,\n        method,\n        payload,\n        error: error?.message || String(error),\n        statusCode,\n        durationMs: duration,\n        branchId,\n        externalEndpoint,\n      })\n    },\n  }\n}\n"],"names":[],"mappings":";;;;;;AAAA;;;;;;AAcO,eAAe,WAAW,KAAkB;IACjD,IAAI;QACF,MAAM,WAAW,MAAM,IAAA,2IAAY;QAEnC,MAAM,SAAS,IAAI,CAAC,YAAY,MAAM,CAAC;YACrC,UAAU,MAAM,QAAQ;YACxB,QAAQ,MAAM,MAAM;YACpB,SAAS,MAAM,OAAO,IAAI;YAC1B,UAAU,MAAM,QAAQ,IAAI;YAC5B,aAAa,MAAM,UAAU,IAAI;YACjC,OAAO,MAAM,KAAK,IAAI;YACtB,aAAa,MAAM,UAAU,IAAI;YACjC,WAAW,MAAM,QAAQ,IAAI;YAC7B,YAAY,MAAM,gBAAgB,IAAI;QACxC;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,gCAAgC;IAChD;AACF;AAEO,SAAS,gBAAgB,QAAgB,EAAE,SAAS,MAAM;IAC/D,MAAM,YAAY,KAAK,GAAG;IAE1B,OAAO;QACL,SAAS,OAAO,SAAc,UAAe,UAAmB;YAC9D,MAAM,WAAW,KAAK,GAAG,KAAK;YAC9B,MAAM,WAAW;gBACf;gBACA;gBACA;gBACA;gBACA,YAAY;gBACZ,YAAY;gBACZ;gBACA;YACF;QACF;QACA,OAAO,OAAO,SAAc,OAAY,aAAa,GAAG,EAAE,UAAmB;YAC3E,MAAM,WAAW,KAAK,GAAG,KAAK;YAC9B,MAAM,WAAW;gBACf;gBACA;gBACA;gBACA,OAAO,OAAO,WAAW,OAAO;gBAChC;gBACA,YAAY;gBACZ;gBACA;YACF;QACF;IACF;AACF"}},
    {"offset": {"line": 534, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/kra/items/classifications/route.ts"],"sourcesContent":["import { createClient } from \"@/lib/supabase/server\"\nimport { NextResponse } from \"next/server\"\nimport { createApiLogger } from \"@/lib/api-logger\"\n\nexport async function POST(request: Request) {\n  const logger = createApiLogger(\"/api/kra/items/classifications\", \"POST\")\n\n  let kraPayload: any = null\n  let kraEndpoint = \"\"\n\n  try {\n    const supabase = await createClient()\n\n    let backendUrl = request.headers.get(\"x-backend-url\") || \"http://20.224.40.56:8088\"\n    backendUrl = backendUrl.replace(/\\/$/, \"\")\n\n    console.log(\"[v0] Backend URL:\", backendUrl)\n\n    const { data: branches } = await supabase\n      .from(\"branches\")\n      .select(\"id, bhf_id, name\")\n      .eq(\"name\", \"Thika Greens\")\n      .limit(1)\n      .single()\n\n    if (!branches || !branches.bhf_id) {\n      throw new Error(\"Thika Greens branch not found. Please configure it first.\")\n    }\n\n    kraPayload = {\n      tin: \"P052344628B\",\n      bhfId: branches.bhf_id,\n      lastReqDt: \"20180328000000\",\n    }\n\n    console.log(\"[v0] Pulling item classifications with payload:\", kraPayload)\n\n    kraEndpoint = `${backendUrl}/itemClass/selectItemsClass`\n    console.log(\"[v0] Calling KRA API:\", kraEndpoint)\n\n    const controller = new AbortController()\n    const timeoutId = setTimeout(() => controller.abort(), 30000)\n\n    const fetchOptions: RequestInit = {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        Accept: \"application/json\",\n      },\n      body: JSON.stringify(kraPayload),\n      signal: controller.signal,\n    }\n\n    const response = await fetch(kraEndpoint, fetchOptions).finally(() => clearTimeout(timeoutId))\n\n    const responseText = await response.text()\n    console.log(\"[v0] KRA API raw response:\", responseText.substring(0, 500))\n\n    if (responseText.trim().startsWith(\"<!DOCTYPE\") || responseText.trim().startsWith(\"<html\")) {\n      throw new Error(\n        `Backend returned HTML instead of JSON. This usually means the endpoint doesn't exist or there's a routing error. Response: ${responseText.substring(0, 200)}`,\n      )\n    }\n\n    let result\n    try {\n      result = JSON.parse(responseText)\n    } catch (parseError) {\n      throw new Error(`Failed to parse backend response as JSON: ${responseText.substring(0, 200)}`)\n    }\n\n    if (!response.ok) {\n      throw new Error(`KRA API error: ${response.status} ${response.statusText} - ${JSON.stringify(result)}`)\n    }\n\n    if (result.data && Array.isArray(result.data)) {\n      console.log(\"[v0] Saving\", result.data.length, \"item classifications to database\")\n\n      for (const item of result.data) {\n        await supabase.from(\"item_classifications\").upsert(\n          {\n            item_cls_cd: item.itemClsCd,\n            item_cls_nm: item.itemClsNm,\n            item_cls_lvl: item.itemClsLvl,\n            tax_ty_cd: item.taxTyCd,\n            mjr_tg_yn: item.mjrTgYn,\n            use_yn: item.useYn || \"Y\",\n            last_req_dt: new Date(),\n          },\n          { onConflict: \"item_cls_cd\" },\n        )\n      }\n    }\n\n    await logger.success(kraPayload, result, branches.id, kraEndpoint)\n\n    return NextResponse.json({\n      resultCd: \"000\",\n      resultMsg: \"Successfully pulled item classifications from KRA\",\n      resultDt: new Date().toISOString(),\n      data: result.data || [],\n    })\n  } catch (error: any) {\n    console.error(\"[v0] Get item classifications error:\", error.message)\n    let errorMessage = error.message\n\n    if (error.message.includes(\"fetch failed\") || error.name === \"FetchError\") {\n      errorMessage =\n        \"Failed to connect to KRA backend. Common causes:\\n\" +\n        \"1. Backend server may not be running or accessible\\n\" +\n        \"2. URL/Port configuration may be incorrect\\n\" +\n        \"3. Network/firewall may be blocking the connection\\n\" +\n        \"4. Check if backend requires HTTP or HTTPS\\n\\n\" +\n        \"Current configuration: \" +\n        kraEndpoint\n    }\n\n    const errorResponse = {\n      resultCd: \"999\",\n      resultMsg: errorMessage,\n      resultDt: new Date().toISOString(),\n      data: [],\n    }\n\n    await logger.error(kraPayload, error, 500, undefined, kraEndpoint)\n\n    return NextResponse.json(errorResponse, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}