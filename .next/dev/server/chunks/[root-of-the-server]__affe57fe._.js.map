{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/client.ts"],"sourcesContent":["import { Pool } from 'pg';\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,\n});\n\nexport async function query<T = any>(text: string, params?: any[]): Promise<T[]> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rows as T[];\n  } finally {\n    client.release();\n  }\n}\n\nexport async function queryOne<T = any>(text: string, params?: any[]): Promise<T | null> {\n  const rows = await query<T>(text, params);\n  return rows[0] || null;\n}\n\nexport async function execute(text: string, params?: any[]): Promise<number> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rowCount || 0;\n  } finally {\n    client.release();\n  }\n}\n\nexport async function getClient() {\n  return await pool.connect();\n}\n\nexport { pool };\n"],"names":[],"mappings":";;;;;;;;;;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,sCAAwC,0BAAgC;AAC/E;AAEO,eAAe,MAAe,IAAY,EAAE,MAAc;IAC/D,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,IAAI;IACpB,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe,SAAkB,IAAY,EAAE,MAAc;IAClE,MAAM,OAAO,MAAM,MAAS,MAAM;IAClC,OAAO,IAAI,CAAC,EAAE,IAAI;AACpB;AAEO,eAAe,QAAQ,IAAY,EAAE,MAAc;IACxD,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,QAAQ,IAAI;IAC5B,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe;IACpB,OAAO,MAAM,KAAK,OAAO;AAC3B"}},
    {"offset": {"line": 113, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/index.ts"],"sourcesContent":["export * from './client';\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 127, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/loyalty/bulk-redeem/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { pool } from '@/lib/db'\nimport { cookies } from 'next/headers'\n\nasync function getSession() {\n  const cookieStore = await cookies()\n  const sessionCookie = cookieStore.get(\"user_session\")\n  if (!sessionCookie) return null\n  try {\n    return JSON.parse(sessionCookie.value)\n  } catch {\n    return null\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const session = await getSession()\n    if (!session) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    }\n\n    // Only directors can view redemption data\n    if (session.role !== 'director' && session.role !== 'vendor') {\n      return NextResponse.json({ error: 'Only directors can access bulk redemption' }, { status: 403 })\n    }\n\n    const { searchParams } = new URL(request.url)\n    const branch_id = searchParams.get('branch_id')\n\n    if (!branch_id) {\n      return NextResponse.json({ error: 'branch_id is required' }, { status: 400 })\n    }\n\n    // Get all customers with their point balances for this branch\n    const customersResult = await pool.query(\n      `SELECT \n        customer_pin,\n        customer_name,\n        SUM(points_earned) as total_earned,\n        SUM(points_redeemed) as total_redeemed,\n        SUM(points_earned) - SUM(points_redeemed) as point_balance,\n        COUNT(*) as transaction_count,\n        MAX(transaction_date) as last_activity\n       FROM loyalty_transactions \n       WHERE branch_id = $1\n       GROUP BY customer_pin, customer_name\n       HAVING SUM(points_earned) - SUM(points_redeemed) > 0\n       ORDER BY point_balance DESC`,\n      [branch_id]\n    )\n\n    // Get redemption rules\n    const rulesResult = await pool.query(\n      `SELECT redemption_points_per_ksh, min_redemption_points, max_redemption_percent\n       FROM branches WHERE id = $1`,\n      [branch_id]\n    )\n    const rules = rulesResult.rows[0] || {}\n\n    // Calculate totals\n    const customers = customersResult.rows.map(row => ({\n      customer_pin: row.customer_pin,\n      customer_name: row.customer_name,\n      total_earned: parseFloat(row.total_earned) || 0,\n      total_redeemed: parseFloat(row.total_redeemed) || 0,\n      point_balance: parseFloat(row.point_balance) || 0,\n      transaction_count: parseInt(row.transaction_count) || 0,\n      last_activity: row.last_activity,\n      eligible: parseFloat(row.point_balance) >= (parseFloat(rules.min_redemption_points) || 100)\n    }))\n\n    const totalPoints = customers.reduce((sum, c) => sum + c.point_balance, 0)\n    const eligibleCount = customers.filter(c => c.eligible).length\n    const pointsPerKsh = parseFloat(rules.redemption_points_per_ksh) || 1\n    const totalValue = totalPoints / pointsPerKsh\n\n    return NextResponse.json({\n      success: true,\n      customers,\n      summary: {\n        total_customers: customers.length,\n        eligible_customers: eligibleCount,\n        total_points: totalPoints,\n        total_value: totalValue,\n        points_per_ksh: pointsPerKsh,\n        min_points: parseFloat(rules.min_redemption_points) || 100\n      }\n    })\n  } catch (error: any) {\n    console.error('Error fetching redemption data:', error)\n    return NextResponse.json({ error: error.message }, { status: 500 })\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  const client = await pool.connect()\n  try {\n    const session = await getSession()\n    if (!session) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    }\n\n    // Only directors can trigger bulk redemption\n    if (session.role !== 'director' && session.role !== 'vendor') {\n      return NextResponse.json({ error: 'Only directors can trigger bulk redemption' }, { status: 403 })\n    }\n\n    const body = await request.json()\n    const { branch_id, customer_pins, redeem_all } = body\n\n    if (!branch_id) {\n      return NextResponse.json({ error: 'branch_id is required' }, { status: 400 })\n    }\n\n    // Get redemption rules\n    const rulesResult = await pool.query(\n      `SELECT redemption_points_per_ksh, min_redemption_points\n       FROM branches WHERE id = $1`,\n      [branch_id]\n    )\n    const rules = rulesResult.rows[0] || {}\n    const pointsPerKsh = Math.max(1, parseFloat(rules.redemption_points_per_ksh) || 1)\n    const minPoints = parseFloat(rules.min_redemption_points) || 100\n\n    // Get eligible customers\n    let customersQuery = `\n      SELECT \n        customer_pin,\n        customer_name,\n        SUM(points_earned) - SUM(points_redeemed) as point_balance\n       FROM loyalty_transactions \n       WHERE branch_id = $1\n       GROUP BY customer_pin, customer_name\n       HAVING SUM(points_earned) - SUM(points_redeemed) >= $2`\n    \n    const queryParams: any[] = [branch_id, minPoints]\n    \n    if (!redeem_all && customer_pins && customer_pins.length > 0) {\n      customersQuery += ` AND customer_pin = ANY($3)`\n      queryParams.push(customer_pins)\n    }\n\n    const customersResult = await pool.query(customersQuery, queryParams)\n\n    if (customersResult.rows.length === 0) {\n      return NextResponse.json({ error: 'No eligible customers found' }, { status: 400 })\n    }\n\n    await client.query('BEGIN')\n\n    let totalRedeemed = 0\n    let totalValue = 0\n    const redemptions: any[] = []\n\n    for (const customer of customersResult.rows) {\n      const pointBalance = parseFloat(customer.point_balance)\n      const discountValue = pointBalance / pointsPerKsh\n\n      // Create redemption transaction\n      await client.query(\n        `INSERT INTO loyalty_transactions \n         (branch_id, customer_name, customer_pin, transaction_date, transaction_amount, \n          points_earned, points_redeemed, transaction_type)\n         VALUES ($1, $2, $3, NOW(), $4, 0, $5, 'redeem')`,\n        [\n          branch_id,\n          customer.customer_name,\n          customer.customer_pin,\n          discountValue,\n          pointBalance\n        ]\n      )\n\n      totalRedeemed += pointBalance\n      totalValue += discountValue\n      redemptions.push({\n        customer_name: customer.customer_name,\n        customer_pin: customer.customer_pin,\n        points_redeemed: pointBalance,\n        value: discountValue\n      })\n    }\n\n    await client.query('COMMIT')\n\n    return NextResponse.json({\n      success: true,\n      message: `Bulk redemption completed for ${redemptions.length} customers`,\n      summary: {\n        customers_processed: redemptions.length,\n        total_points_redeemed: totalRedeemed,\n        total_value: totalValue\n      },\n      redemptions\n    })\n  } catch (error: any) {\n    await client.query('ROLLBACK')\n    console.error('Error processing bulk redemption:', error)\n    return NextResponse.json({ error: error.message }, { status: 500 })\n  } finally {\n    client.release()\n  }\n}\n"],"names":[],"mappings":"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"}}]
}