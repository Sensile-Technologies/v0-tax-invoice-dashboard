{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/mobile/nozzles/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\nimport { Pool } from \"pg\"\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n})\n\nexport async function GET(request: Request) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const branchId = searchParams.get(\"branch_id\")\n\n    if (!branchId) {\n      return NextResponse.json({ error: \"Branch ID required\" }, { status: 400 })\n    }\n\n    const client = await pool.connect()\n    try {\n      // Only return nozzles that have a tank assigned (tank_id IS NOT NULL)\n      const nozzlesResult = await client.query(\n        `SELECT n.id, n.nozzle_number, i.item_name as fuel_type, n.status, d.dispenser_number\n         FROM nozzles n \n         LEFT JOIN dispensers d ON n.dispenser_id = d.id\n         JOIN items i ON n.item_id = i.id\n         WHERE n.branch_id = $1 AND n.status = 'active' AND n.tank_id IS NOT NULL\n         ORDER BY d.dispenser_number, n.nozzle_number ASC`,\n        [branchId]\n      )\n\n      // Get fuel prices from branch_items (single source of truth)\n      const branchItemsResult = await client.query(\n        `SELECT DISTINCT ON (UPPER(i.item_name))\n           i.item_name, \n           bi.sale_price as price\n         FROM branch_items bi\n         JOIN items i ON bi.item_id = i.id\n         WHERE bi.branch_id = $1\n           AND bi.is_available = true\n           AND bi.sale_price IS NOT NULL\n           AND bi.sale_price > 0\n           AND (UPPER(i.item_name) IN ('PETROL', 'DIESEL', 'KEROSENE', 'SUPER PETROL', 'V-POWER') \n                OR i.item_name ILIKE '%petrol%' \n                OR i.item_name ILIKE '%diesel%'\n                OR i.item_name ILIKE '%kerosene%')\n         ORDER BY UPPER(i.item_name), bi.updated_at DESC NULLS LAST`,\n        [branchId]\n      )\n\n      // Process branch_items results to normalized fuel types\n      const fuelPrices = branchItemsResult.rows.map(fp => {\n        const itemName = fp.item_name.toUpperCase()\n        let fuelType = fp.item_name\n        if (itemName.includes('DIESEL')) fuelType = 'Diesel'\n        else if (itemName.includes('PETROL') || itemName.includes('SUPER')) fuelType = 'Petrol'\n        else if (itemName.includes('KEROSENE')) fuelType = 'Kerosene'\n        return { fuel_type: fuelType, price: parseFloat(fp.price) }\n      })\n\n      const nozzles = nozzlesResult.rows.map(n => {\n        const fuelPrice = fuelPrices.find(fp => \n          fp.fuel_type.toUpperCase() === n.fuel_type.toUpperCase()\n        )\n        return {\n          id: n.id,\n          name: `D${n.dispenser_number || 1}N${n.nozzle_number} - ${n.fuel_type}`,\n          fuel_type: n.fuel_type,\n          status: n.status,\n          price: fuelPrice?.price || 0,\n        }\n      })\n\n      return NextResponse.json({\n        nozzles: nozzles,\n        fuel_prices: fuelPrices,\n      })\n    } finally {\n      client.release()\n    }\n  } catch (error) {\n    console.error(\"[Mobile Nozzles API Error]:\", error)\n    return NextResponse.json({ error: \"Failed to fetch nozzles\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;AAC5C;AAEO,eAAe,IAAI,OAAgB;IACxC,IAAI;QACF,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,WAAW,aAAa,GAAG,CAAC;QAElC,IAAI,CAAC,UAAU;YACb,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAqB,GAAG;gBAAE,QAAQ;YAAI;QAC1E;QAEA,MAAM,SAAS,MAAM,KAAK,OAAO;QACjC,IAAI;YACF,sEAAsE;YACtE,MAAM,gBAAgB,MAAM,OAAO,KAAK,CACtC,CAAC;;;;;yDAKgD,CAAC,EAClD;gBAAC;aAAS;YAGZ,6DAA6D;YAC7D,MAAM,oBAAoB,MAAM,OAAO,KAAK,CAC1C,CAAC;;;;;;;;;;;;;mEAa0D,CAAC,EAC5D;gBAAC;aAAS;YAGZ,wDAAwD;YACxD,MAAM,aAAa,kBAAkB,IAAI,CAAC,GAAG,CAAC,CAAA;gBAC5C,MAAM,WAAW,GAAG,SAAS,CAAC,WAAW;gBACzC,IAAI,WAAW,GAAG,SAAS;gBAC3B,IAAI,SAAS,QAAQ,CAAC,WAAW,WAAW;qBACvC,IAAI,SAAS,QAAQ,CAAC,aAAa,SAAS,QAAQ,CAAC,UAAU,WAAW;qBAC1E,IAAI,SAAS,QAAQ,CAAC,aAAa,WAAW;gBACnD,OAAO;oBAAE,WAAW;oBAAU,OAAO,WAAW,GAAG,KAAK;gBAAE;YAC5D;YAEA,MAAM,UAAU,cAAc,IAAI,CAAC,GAAG,CAAC,CAAA;gBACrC,MAAM,YAAY,WAAW,IAAI,CAAC,CAAA,KAChC,GAAG,SAAS,CAAC,WAAW,OAAO,EAAE,SAAS,CAAC,WAAW;gBAExD,OAAO;oBACL,IAAI,EAAE,EAAE;oBACR,MAAM,CAAC,CAAC,EAAE,EAAE,gBAAgB,IAAI,EAAE,CAAC,EAAE,EAAE,aAAa,CAAC,GAAG,EAAE,EAAE,SAAS,EAAE;oBACvE,WAAW,EAAE,SAAS;oBACtB,QAAQ,EAAE,MAAM;oBAChB,OAAO,WAAW,SAAS;gBAC7B;YACF;YAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;gBACvB,SAAS;gBACT,aAAa;YACf;QACF,SAAU;YACR,OAAO,OAAO;QAChB;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,+BAA+B;QAC7C,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA0B,GAAG;YAAE,QAAQ;QAAI;IAC/E;AACF"}}]
}