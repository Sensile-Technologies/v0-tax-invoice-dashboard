{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/shifts/generate-bulk-sales/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { cookies } from \"next/headers\"\nimport { Pool } from \"pg\"\n\nconst pool = new Pool({ connectionString: process.env.DATABASE_URL })\n\ninterface NozzleReading {\n  nozzle_id: string\n  opening_reading: number\n  closing_reading: number\n  fuel_type: string\n  item_id: string | null\n  sale_price: number\n}\n\nfunction splitIntoDenominations(totalVolume: number): number[] {\n  const denominations: number[] = []\n  let remaining = totalVolume\n\n  const validDenoms = [2500, 2000, 1500, 1000, 500, 300, 200, 100]\n\n  while (remaining >= 100) {\n    const maxDenom = validDenoms.find(d => d <= remaining) || 100\n    const minDenom = 100\n    \n    const availableDenoms = validDenoms.filter(d => d >= minDenom && d <= maxDenom && d <= remaining)\n    \n    if (availableDenoms.length === 0) break\n    \n    const randomDenom = availableDenoms[Math.floor(Math.random() * availableDenoms.length)]\n    denominations.push(randomDenom)\n    remaining -= randomDenom\n  }\n\n  if (remaining > 0 && remaining < 100 && denominations.length > 0) {\n    denominations[denominations.length - 1] += remaining\n    remaining = 0\n  }\n\n  return denominations\n}\n\nfunction generateInvoiceNumber(branchCode: string, index: number): string {\n  const timestamp = Date.now().toString(36).toUpperCase()\n  return `BLK-${branchCode}-${timestamp}-${String(index).padStart(4, '0')}`\n}\n\nfunction generateReceiptNumber(): string {\n  return `RCP-${Date.now().toString(36).toUpperCase()}-${Math.random().toString(36).substring(2, 6).toUpperCase()}`\n}\n\nexport async function POST(request: NextRequest) {\n  const client = await pool.connect()\n  \n  try {\n    const cookieStore = await cookies()\n    const sessionCookie = cookieStore.get(\"user_session\")\n    \n    if (!sessionCookie?.value) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 })\n    }\n    \n    const session = JSON.parse(sessionCookie.value)\n    const { user_id, vendor_id, branch_id: userBranchId } = session\n\n    const body = await request.json()\n    const { shift_id, nozzle_ids } = body\n\n    if (!shift_id) {\n      return NextResponse.json({ error: \"shift_id is required\" }, { status: 400 })\n    }\n\n    const shiftResult = await client.query(\n      `SELECT s.id, s.branch_id, s.staff_id, s.status, b.name as branch_name, b.vendor_id\n       FROM shifts s\n       JOIN branches b ON s.branch_id = b.id\n       WHERE s.id = $1`,\n      [shift_id]\n    )\n\n    if (shiftResult.rows.length === 0) {\n      return NextResponse.json({ error: \"Shift not found\" }, { status: 404 })\n    }\n\n    const shift = shiftResult.rows[0]\n\n    if (vendor_id && shift.vendor_id !== vendor_id) {\n      return NextResponse.json({ error: \"Access denied\" }, { status: 403 })\n    }\n\n    let nozzleQuery = `\n      SELECT \n        sr.nozzle_id,\n        sr.opening_reading,\n        sr.closing_reading,\n        n.fuel_type,\n        n.item_id,\n        COALESCE(bi.sale_price, i.sale_price, 0) as sale_price\n      FROM shift_readings sr\n      JOIN nozzles n ON sr.nozzle_id = n.id\n      LEFT JOIN items i ON n.item_id = i.id\n      LEFT JOIN branch_items bi ON bi.item_id = n.item_id AND bi.branch_id = $1\n      WHERE sr.shift_id = $2 AND sr.reading_type = 'nozzle'\n    `\n    const params: any[] = [shift.branch_id, shift_id]\n\n    if (nozzle_ids && nozzle_ids.length > 0) {\n      nozzleQuery += ` AND sr.nozzle_id = ANY($3)`\n      params.push(nozzle_ids)\n    }\n\n    const nozzleResult = await client.query(nozzleQuery, params)\n    const nozzleReadings: NozzleReading[] = nozzleResult.rows\n\n    if (nozzleReadings.length === 0) {\n      return NextResponse.json({ error: \"No nozzle readings found for this shift\" }, { status: 400 })\n    }\n\n    const branchCode = shift.branch_name.substring(0, 3).toUpperCase().replace(/\\s/g, '')\n    \n    await client.query('BEGIN')\n\n    const salesCreated: any[] = []\n    let invoiceIndex = 1\n\n    for (const reading of nozzleReadings) {\n      const openingReading = parseFloat(String(reading.opening_reading)) || 0\n      const closingReading = parseFloat(String(reading.closing_reading)) || 0\n      const meterDifference = closingReading - openingReading\n\n      if (meterDifference <= 0) {\n        continue\n      }\n\n      const unitPrice = parseFloat(String(reading.sale_price)) || 0\n      if (unitPrice <= 0) {\n        console.log(`Skipping nozzle ${reading.nozzle_id} - no price configured`)\n        continue\n      }\n\n      const denominations = splitIntoDenominations(meterDifference)\n\n      for (const quantity of denominations) {\n        const totalAmount = quantity * unitPrice\n        const invoiceNumber = generateInvoiceNumber(branchCode, invoiceIndex)\n        const receiptNumber = generateReceiptNumber()\n\n        const insertResult = await client.query(\n          `INSERT INTO sales (\n            branch_id, shift_id, staff_id, nozzle_id,\n            invoice_number, receipt_number, sale_date,\n            fuel_type, quantity, unit_price, total_amount,\n            payment_method, is_automated, source_system,\n            transmission_status, created_at\n          ) VALUES (\n            $1, $2, $3, $4, $5, $6, NOW(),\n            $7, $8, $9, $10,\n            'cash', true, 'meter_diff_bulk',\n            'pending', NOW()\n          ) RETURNING id, invoice_number, quantity, total_amount`,\n          [\n            shift.branch_id,\n            shift_id,\n            shift.staff_id,\n            reading.nozzle_id,\n            invoiceNumber,\n            receiptNumber,\n            reading.fuel_type,\n            quantity,\n            unitPrice,\n            totalAmount\n          ]\n        )\n\n        salesCreated.push({\n          id: insertResult.rows[0].id,\n          invoice_number: insertResult.rows[0].invoice_number,\n          fuel_type: reading.fuel_type,\n          quantity: quantity,\n          unit_price: unitPrice,\n          total_amount: totalAmount\n        })\n\n        invoiceIndex++\n      }\n    }\n\n    await client.query('COMMIT')\n\n    const totalQuantity = salesCreated.reduce((sum, s) => sum + s.quantity, 0)\n    const totalAmount = salesCreated.reduce((sum, s) => sum + s.total_amount, 0)\n\n    return NextResponse.json({\n      success: true,\n      message: `Generated ${salesCreated.length} invoices from meter difference`,\n      summary: {\n        total_invoices: salesCreated.length,\n        total_quantity: totalQuantity,\n        total_amount: totalAmount\n      },\n      sales: salesCreated\n    })\n\n  } catch (error: any) {\n    await client.query('ROLLBACK')\n    console.error(\"Error generating bulk sales:\", error)\n    return NextResponse.json({ error: error.message }, { status: 500 })\n  } finally {\n    client.release()\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const cookieStore = await cookies()\n    const sessionCookie = cookieStore.get(\"user_session\")\n    \n    if (!sessionCookie?.value) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 })\n    }\n\n    const { searchParams } = new URL(request.url)\n    const shift_id = searchParams.get(\"shift_id\")\n\n    if (!shift_id) {\n      return NextResponse.json({ error: \"shift_id is required\" }, { status: 400 })\n    }\n\n    const result = await pool.query(\n      `SELECT \n        sr.nozzle_id,\n        n.nozzle_number,\n        n.fuel_type,\n        sr.opening_reading,\n        sr.closing_reading,\n        (CAST(sr.closing_reading AS numeric) - CAST(sr.opening_reading AS numeric)) as meter_difference,\n        COALESCE(bi.sale_price, i.sale_price, 0) as sale_price,\n        (CAST(sr.closing_reading AS numeric) - CAST(sr.opening_reading AS numeric)) * COALESCE(bi.sale_price, i.sale_price, 0) as potential_sales_value\n      FROM shift_readings sr\n      JOIN nozzles n ON sr.nozzle_id = n.id\n      JOIN shifts s ON sr.shift_id = s.id\n      LEFT JOIN items i ON n.item_id = i.id\n      LEFT JOIN branch_items bi ON bi.item_id = n.item_id AND bi.branch_id = s.branch_id\n      WHERE sr.shift_id = $1 AND sr.reading_type = 'nozzle'\n      ORDER BY n.fuel_type, n.nozzle_number`,\n      [shift_id]\n    )\n\n    return NextResponse.json({\n      nozzles: result.rows,\n      total_meter_difference: result.rows.reduce((sum: number, r: any) => sum + (parseFloat(r.meter_difference) || 0), 0),\n      total_potential_value: result.rows.reduce((sum: number, r: any) => sum + (parseFloat(r.potential_sales_value) || 0), 0)\n    })\n\n  } catch (error: any) {\n    console.error(\"Error fetching shift nozzle data:\", error)\n    return NextResponse.json({ error: error.message }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}