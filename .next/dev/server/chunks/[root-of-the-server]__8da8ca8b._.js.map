{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/client.ts"],"sourcesContent":["import { Pool } from 'pg';\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,\n});\n\nexport async function query<T = any>(text: string, params?: any[]): Promise<T[]> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rows as T[];\n  } finally {\n    client.release();\n  }\n}\n\nexport async function queryOne<T = any>(text: string, params?: any[]): Promise<T | null> {\n  const rows = await query<T>(text, params);\n  return rows[0] || null;\n}\n\nexport async function execute(text: string, params?: any[]): Promise<number> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rowCount || 0;\n  } finally {\n    client.release();\n  }\n}\n\nexport { pool };\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,sCAAwC,0BAAgC;AAC/E;AAEO,eAAe,MAAe,IAAY,EAAE,MAAc;IAC/D,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,IAAI;IACpB,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe,SAAkB,IAAY,EAAE,MAAc;IAClE,MAAM,OAAO,MAAM,MAAS,MAAM;IAClC,OAAO,IAAI,CAAC,EAAE,IAAI;AACpB;AAEO,eAAe,QAAQ,IAAY,EAAE,MAAc;IACxD,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,QAAQ,IAAI;IAC5B,SAAU;QACR,OAAO,OAAO;IAChB;AACF"}},
    {"offset": {"line": 108, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/index.ts"],"sourcesContent":["export * from './client';\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 122, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/purchases/accept/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\nimport { query, pool } from \"@/lib/db\"\nimport { cookies } from \"next/headers\"\n\nasync function getSessionUser(): Promise<{ id: string; branch_id?: string } | null> {\n  try {\n    const cookieStore = await cookies()\n    const sessionCookie = cookieStore.get(\"user_session\")\n    if (!sessionCookie?.value) return null\n    \n    const session = JSON.parse(sessionCookie.value)\n    return { id: session.id, branch_id: session.branch_id }\n  } catch {\n    return null\n  }\n}\n\nasync function getUserBranchId(userId: string): Promise<string | null> {\n  const staffBranch = await query(\n    `SELECT branch_id FROM staff WHERE user_id = $1 LIMIT 1`,\n    [userId]\n  )\n  if (staffBranch && staffBranch.length > 0) {\n    return staffBranch[0].branch_id\n  }\n\n  const branchUser = await query(\n    `SELECT id FROM branches WHERE user_id = $1 LIMIT 1`,\n    [userId]\n  )\n  if (branchUser && branchUser.length > 0) {\n    return branchUser[0].id\n  }\n\n  return null\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const user = await getSessionUser()\n    if (!user) {\n      return NextResponse.json({ success: false, error: \"Unauthorized\" }, { status: 401 })\n    }\n\n    const branchId = user.branch_id || await getUserBranchId(user.id)\n\n    if (!branchId) {\n      return NextResponse.json({ success: false, error: \"No branch found for user\" }, { status: 403 })\n    }\n\n    const orders = await query(\n      `SELECT \n        po.*,\n        vp.name as supplier_name,\n        tp.name as transporter_name,\n        u.username as created_by_name,\n        (SELECT COUNT(*) FROM purchase_order_items WHERE purchase_order_id = po.id) as item_count,\n        (SELECT COALESCE(SUM(total_amount), 0) FROM purchase_order_items WHERE purchase_order_id = po.id) as total_amount\n       FROM purchase_orders po\n       LEFT JOIN vendor_partners vp ON po.supplier_id = vp.id\n       LEFT JOIN vendor_partners tp ON po.transporter_id = tp.id\n       LEFT JOIN users u ON po.created_by = u.id\n       WHERE po.branch_id = $1 AND po.status = 'pending' AND po.approval_status = 'approved'\n       ORDER BY po.issued_at DESC`,\n      [branchId]\n    )\n\n    return NextResponse.json({ success: true, data: orders })\n  } catch (error) {\n    console.error(\"Error fetching pending purchase orders:\", error)\n    return NextResponse.json({ success: false, error: \"Failed to fetch purchase orders\" }, { status: 500 })\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const user = await getSessionUser()\n    if (!user) {\n      return NextResponse.json({ success: false, error: \"Unauthorized\" }, { status: 401 })\n    }\n\n    const userBranchId = user.branch_id || await getUserBranchId(user.id)\n    if (!userBranchId) {\n      return NextResponse.json({ success: false, error: \"No branch found for user\" }, { status: 403 })\n    }\n\n    const body = await request.json()\n    const { \n      purchase_order_id, \n      bowser_volume, \n      dips_mm, \n      acceptance_timestamp,\n      tank_readings,\n      dispenser_readings,\n      remarks \n    } = body\n\n    if (!purchase_order_id) {\n      return NextResponse.json({ success: false, error: \"Purchase order ID is required\" }, { status: 400 })\n    }\n\n    if (bowser_volume === undefined || bowser_volume === null) {\n      return NextResponse.json({ success: false, error: \"Bowser volume is required\" }, { status: 400 })\n    }\n\n    const order = await query(\n      `SELECT po.*, b.id as branch_id FROM purchase_orders po \n       JOIN branches b ON po.branch_id = b.id\n       WHERE po.id = $1 AND po.status = 'pending' AND po.branch_id = $2`,\n      [purchase_order_id, userBranchId]\n    )\n\n    if (!order || order.length === 0) {\n      return NextResponse.json({ success: false, error: \"Purchase order not found or not assigned to your branch\" }, { status: 404 })\n    }\n\n    const branchId = order[0].branch_id\n\n    let totalTankVariance = 0\n    let totalDispenserVariance = 0\n\n    if (tank_readings && Array.isArray(tank_readings)) {\n      for (const reading of tank_readings) {\n        const tankDiff = (parseFloat(reading.volume_after) || 0) - (parseFloat(reading.volume_before) || 0)\n        totalTankVariance += tankDiff\n      }\n    }\n\n    if (dispenser_readings && Array.isArray(dispenser_readings)) {\n      for (const reading of dispenser_readings) {\n        const dispenserDiff = (parseFloat(reading.meter_reading_after) || 0) - (parseFloat(reading.meter_reading_before) || 0)\n        totalDispenserVariance += dispenserDiff\n      }\n    }\n\n    const bowserVol = parseFloat(bowser_volume) || 0\n    const totalVariance = (totalTankVariance + totalDispenserVariance) - bowserVol\n\n    const client = await pool.connect()\n    try {\n      await client.query('BEGIN')\n\n      const acceptanceResult = await client.query(\n        `INSERT INTO purchase_order_acceptances \n         (purchase_order_id, branch_id, accepted_by, bowser_volume, dips_mm, total_variance, remarks, acceptance_timestamp)\n         VALUES ($1, $2, $3, $4, $5, $6, $7, $8)\n         RETURNING *`,\n        [\n          purchase_order_id, \n          branchId, \n          user.id, \n          bowserVol, \n          dips_mm || null, \n          totalVariance,\n          remarks || null,\n          acceptance_timestamp || new Date().toISOString()\n        ]\n      )\n\n      const acceptanceId = acceptanceResult.rows[0].id\n\n      if (tank_readings && Array.isArray(tank_readings)) {\n        for (const reading of tank_readings) {\n          await client.query(\n            `INSERT INTO po_acceptance_tank_readings \n             (acceptance_id, tank_id, volume_before, volume_after)\n             VALUES ($1, $2, $3, $4)`,\n            [acceptanceId, reading.tank_id, reading.volume_before, reading.volume_after]\n          )\n          \n          await client.query(\n            `UPDATE tanks \n             SET current_stock = $1, updated_at = NOW()\n             WHERE id = $2 AND branch_id = $3`,\n            [parseFloat(reading.volume_after) || 0, reading.tank_id, branchId]\n          )\n        }\n      }\n\n      if (dispenser_readings && Array.isArray(dispenser_readings)) {\n        for (const reading of dispenser_readings) {\n          await client.query(\n            `INSERT INTO po_acceptance_dispenser_readings \n             (acceptance_id, dispenser_id, meter_reading_before, meter_reading_after)\n             VALUES ($1, $2, $3, $4)`,\n            [acceptanceId, reading.dispenser_id, reading.meter_reading_before, reading.meter_reading_after]\n          )\n        }\n      }\n\n      await client.query(\n        `UPDATE purchase_orders SET status = 'accepted', accepted_at = NOW(), updated_at = NOW() WHERE id = $1`,\n        [purchase_order_id]\n      )\n\n      await client.query('COMMIT')\n\n      return NextResponse.json({ \n        success: true, \n        data: {\n          acceptance: acceptanceResult.rows[0],\n          variance: totalVariance,\n          tank_variance: totalTankVariance,\n          dispenser_variance: totalDispenserVariance\n        },\n        message: \"Purchase order accepted successfully\" \n      })\n    } catch (error) {\n      await client.query('ROLLBACK')\n      throw error\n    } finally {\n      client.release()\n    }\n  } catch (error) {\n    console.error(\"Error accepting purchase order:\", error)\n    return NextResponse.json({ success: false, error: \"Failed to accept purchase order\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}