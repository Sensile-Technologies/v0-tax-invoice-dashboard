{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/client.ts"],"sourcesContent":["import { Pool } from 'pg';\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,\n});\n\nexport async function query<T = any>(text: string, params?: any[]): Promise<T[]> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rows as T[];\n  } finally {\n    client.release();\n  }\n}\n\nexport async function queryOne<T = any>(text: string, params?: any[]): Promise<T | null> {\n  const rows = await query<T>(text, params);\n  return rows[0] || null;\n}\n\nexport async function execute(text: string, params?: any[]): Promise<number> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rowCount || 0;\n  } finally {\n    client.release();\n  }\n}\n\nexport { pool };\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;;;;;AAEA,MAAM,OAAO,IAAI,4GAAI,CAAC;IACpB,kBAAkB,QAAQ,GAAG,CAAC,YAAY;IAC1C,KAAK,sCAAwC,0BAAgC;AAC/E;AAEO,eAAe,MAAe,IAAY,EAAE,MAAc;IAC/D,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,IAAI;IACpB,SAAU;QACR,OAAO,OAAO;IAChB;AACF;AAEO,eAAe,SAAkB,IAAY,EAAE,MAAc;IAClE,MAAM,OAAO,MAAM,MAAS,MAAM;IAClC,OAAO,IAAI,CAAC,EAAE,IAAI;AACpB;AAEO,eAAe,QAAQ,IAAY,EAAE,MAAc;IACxD,MAAM,SAAS,MAAM,KAAK,OAAO;IACjC,IAAI;QACF,MAAM,SAAS,MAAM,OAAO,KAAK,CAAC,MAAM;QACxC,OAAO,OAAO,QAAQ,IAAI;IAC5B,SAAU;QACR,OAAO,OAAO;IAChB;AACF"}},
    {"offset": {"line": 108, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/lib/db/index.ts"],"sourcesContent":["export * from './client';\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 122, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/headquarters/stats/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { pool, query } from '@/lib/db';\n\nasync function getUserVendorFilter(userId: string | null): Promise<{ vendorId: string | null; branchIds: string[] | null }> {\n  if (!userId) {\n    return { vendorId: null, branchIds: null };\n  }\n\n  let vendorId: string | null = null;\n  \n  const userResult = await query(\n    `SELECT v.id as vendor_id FROM users u \n     JOIN vendors v ON v.email = u.email \n     WHERE u.id = $1`,\n    [userId]\n  );\n  if (userResult && userResult.length > 0) {\n    vendorId = userResult[0].vendor_id;\n  }\n  \n  if (!vendorId) {\n    const staffResult = await query(\n      `SELECT DISTINCT b.vendor_id FROM staff s\n       JOIN branches b ON s.branch_id = b.id\n       WHERE s.user_id = $1 AND b.vendor_id IS NOT NULL`,\n      [userId]\n    );\n    if (staffResult && staffResult.length > 0) {\n      vendorId = staffResult[0].vendor_id;\n    }\n  }\n  \n  if (!vendorId) {\n    const staffBranchIds = await query(\n      `SELECT branch_id FROM staff WHERE user_id = $1`,\n      [userId]\n    );\n    if (staffBranchIds && staffBranchIds.length > 0) {\n      return { vendorId: null, branchIds: staffBranchIds.map((s: any) => s.branch_id) };\n    }\n    return { vendorId: null, branchIds: [] };\n  }\n  \n  return { vendorId, branchIds: null };\n}\n\nexport async function GET(request: Request) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const userId = searchParams.get('user_id');\n    \n    const { vendorId, branchIds } = await getUserVendorFilter(userId);\n    \n    if (userId && !vendorId && branchIds && branchIds.length === 0) {\n      return NextResponse.json({\n        totalRevenue: 0,\n        revenueGrowth: 0,\n        totalTransactions: 0,\n        totalEmployees: 0,\n        totalInventory: 0,\n        inventoryGrowth: 0,\n        branchPerformance: [],\n        monthlyRevenue: []\n      });\n    }\n\n    const today = new Date();\n    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);\n    const startOfLastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);\n    const endOfLastMonth = new Date(today.getFullYear(), today.getMonth(), 0);\n\n    let branchFilter = '';\n    let branchFilterParams: any[] = [];\n    \n    if (vendorId) {\n      branchFilter = 'AND s.branch_id IN (SELECT id FROM branches WHERE vendor_id = $2)';\n      branchFilterParams = [vendorId];\n    } else if (branchIds && branchIds.length > 0) {\n      branchFilter = 'AND s.branch_id = ANY($2::uuid[])';\n      branchFilterParams = [branchIds];\n    }\n\n    const [\n      revenueResult,\n      lastMonthRevenueResult,\n      transactionsResult,\n      employeesResult,\n      inventoryResult,\n      branchStatsResult,\n      monthlyRevenueResult\n    ] = await Promise.all([\n      pool.query(`\n        SELECT COALESCE(SUM(total_amount), 0) as total_revenue\n        FROM sales s\n        WHERE created_at >= $1 ${branchFilter}\n      `, [startOfMonth, ...branchFilterParams]),\n      \n      pool.query(`\n        SELECT COALESCE(SUM(total_amount), 0) as total_revenue\n        FROM sales s\n        WHERE created_at >= $1 AND created_at <= $2 ${branchFilter.replace('$2', '$3')}\n      `, [startOfLastMonth, endOfLastMonth, ...branchFilterParams]),\n      \n      pool.query(`\n        SELECT COUNT(*) as total_transactions\n        FROM sales s\n        WHERE created_at >= $1 ${branchFilter}\n      `, [startOfMonth, ...branchFilterParams]),\n      \n      vendorId ? pool.query(`\n        SELECT COUNT(DISTINCT u.id) as total_employees\n        FROM users u\n        JOIN staff st ON st.user_id = u.id\n        JOIN branches b ON st.branch_id = b.id\n        WHERE b.vendor_id = $1\n      `, [vendorId]) : (branchIds && branchIds.length > 0 ? pool.query(`\n        SELECT COUNT(DISTINCT u.id) as total_employees\n        FROM users u\n        JOIN staff st ON st.user_id = u.id\n        WHERE st.branch_id = ANY($1::uuid[])\n      `, [branchIds]) : pool.query(`SELECT 0 as total_employees`)),\n      \n      vendorId ? pool.query(`\n        SELECT COALESCE(SUM(current_stock), 0) as total_inventory\n        FROM tanks t\n        JOIN branches b ON t.branch_id = b.id\n        WHERE b.vendor_id = $1 AND (t.status = 'active' OR t.status IS NULL)\n      `, [vendorId]) : (branchIds && branchIds.length > 0 ? pool.query(`\n        SELECT COALESCE(SUM(current_stock), 0) as total_inventory\n        FROM tanks t\n        WHERE t.branch_id = ANY($1::uuid[]) AND (t.status = 'active' OR t.status IS NULL)\n      `, [branchIds]) : pool.query(`SELECT 0 as total_inventory`)),\n      \n      vendorId ? pool.query(`\n        SELECT \n          b.id,\n          b.name,\n          COALESCE(SUM(CASE WHEN s.created_at >= $1 THEN s.total_amount ELSE 0 END), 0) as mtd_sales,\n          0 as mtd_purchases\n        FROM branches b\n        LEFT JOIN sales s ON s.branch_id = b.id\n        WHERE b.vendor_id = $2 AND (b.status = 'active' OR b.status IS NULL)\n        GROUP BY b.id, b.name\n        ORDER BY b.name\n      `, [startOfMonth, vendorId]) : (branchIds && branchIds.length > 0 ? pool.query(`\n        SELECT \n          b.id,\n          b.name,\n          COALESCE(SUM(CASE WHEN s.created_at >= $1 THEN s.total_amount ELSE 0 END), 0) as mtd_sales,\n          0 as mtd_purchases\n        FROM branches b\n        LEFT JOIN sales s ON s.branch_id = b.id\n        WHERE b.id = ANY($2::uuid[]) AND (b.status = 'active' OR b.status IS NULL)\n        GROUP BY b.id, b.name\n        ORDER BY b.name\n      `, [startOfMonth, branchIds]) : pool.query(`SELECT NULL as id, NULL as name, 0 as mtd_sales, 0 as mtd_purchases WHERE false`)),\n      \n      vendorId ? pool.query(`\n        SELECT \n          TO_CHAR(DATE_TRUNC('month', s.created_at), 'Mon') as month,\n          COALESCE(SUM(s.total_amount), 0) as revenue\n        FROM sales s\n        JOIN branches b ON s.branch_id = b.id\n        WHERE s.created_at >= NOW() - INTERVAL '6 months' AND b.vendor_id = $1\n        GROUP BY DATE_TRUNC('month', s.created_at)\n        ORDER BY DATE_TRUNC('month', s.created_at)\n      `, [vendorId]) : (branchIds && branchIds.length > 0 ? pool.query(`\n        SELECT \n          TO_CHAR(DATE_TRUNC('month', s.created_at), 'Mon') as month,\n          COALESCE(SUM(s.total_amount), 0) as revenue\n        FROM sales s\n        WHERE s.created_at >= NOW() - INTERVAL '6 months' AND s.branch_id = ANY($1::uuid[])\n        GROUP BY DATE_TRUNC('month', s.created_at)\n        ORDER BY DATE_TRUNC('month', s.created_at)\n      `, [branchIds]) : pool.query(`SELECT NULL as month, 0 as revenue WHERE false`))\n    ]);\n\n    const currentRevenue = parseFloat(revenueResult.rows[0]?.total_revenue || 0);\n    const lastMonthRevenue = parseFloat(lastMonthRevenueResult.rows[0]?.total_revenue || 0);\n    const revenueGrowth = lastMonthRevenue > 0 \n      ? ((currentRevenue - lastMonthRevenue) / lastMonthRevenue * 100).toFixed(1)\n      : '0';\n\n    const currentInventory = parseFloat(inventoryResult.rows[0]?.total_inventory || 0);\n\n    const branchPerformance = branchStatsResult.rows.map((row: any) => ({\n      branch: row.name,\n      sales: parseFloat(row.mtd_sales) / 1000,\n      purchases: parseFloat(row.mtd_purchases) / 1000\n    }));\n\n    const monthlyRevenue = monthlyRevenueResult.rows.map((row: any) => ({\n      month: row.month,\n      revenue: parseFloat(row.revenue)\n    }));\n\n    return NextResponse.json({\n      totalRevenue: currentRevenue,\n      revenueGrowth: parseFloat(revenueGrowth),\n      totalTransactions: parseInt(transactionsResult.rows[0]?.total_transactions || 0),\n      totalEmployees: parseInt(employeesResult.rows[0]?.total_employees || 0),\n      totalInventory: Math.round(currentInventory),\n      inventoryGrowth: 0,\n      branchPerformance,\n      monthlyRevenue\n    });\n  } catch (error: any) {\n    console.error('[HQ Stats] Error:', error);\n    return NextResponse.json(\n      { error: error.message || 'Failed to fetch stats' },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}