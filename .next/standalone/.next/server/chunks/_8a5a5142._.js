module.exports=[98078,e=>e.a(async(t,a)=>{try{var r=e.i(89171),n=e.i(30056),i=e.i(39298),s=t([n,i]);[n,i]=s.then?(await s)():s;let c=new n.Pool({connectionString:process.env.DATABASE_URL});async function o(e,t,a,r,n,i){let s=n.substring(0,3).toUpperCase().replace(/\s/g,""),o=0,l=0,d=0,u=1,c=[];for(let n of i){let i=parseFloat(String(n.opening_reading))||0,_=(parseFloat(String(n.closing_reading))||0)-i;if(_<=0)continue;let p=await e.query(`SELECT n.fuel_type, n.item_id, COALESCE(bi.sale_price, 0) as sale_price
       FROM nozzles n
       LEFT JOIN items i ON n.item_id = i.id
       LEFT JOIN branch_items bi ON bi.item_id = n.item_id AND bi.branch_id = $1
       WHERE n.id = $2`,[a,n.nozzle_id]);if(0===p.rows.length)continue;let{fuel_type:h,sale_price:f}=p.rows[0],g=parseFloat(f)||0;if(g<=0){console.log(`[BULK SALES] Skipping nozzle ${n.nozzle_id} - no price configured`);continue}let E=await e.query(`SELECT COALESCE(SUM(quantity), 0) as invoiced_quantity
       FROM sales
       WHERE shift_id = $1 AND nozzle_id = $2 AND is_automated = false`,[t,n.nozzle_id]),R=parseFloat(E.rows[0]?.invoiced_quantity)||0,m=_-R;if(m<=0){console.log(`[BULK SALES] Nozzle ${n.nozzle_id}: meter diff ${_}L, invoiced ${R}L, no bulk needed`);continue}console.log(`[BULK SALES] Nozzle ${n.nozzle_id}: meter diff ${_}L - invoiced ${R}L = bulk ${m}L`);let $=m*g;for(let i of function(e){let t=[],a=e,r=[2500,2e3,1500,1e3,500,300,200,100];for(;a>=100;){let e=r.find(e=>e<=a)||100,n=r.filter(t=>t>=100&&t<=e&&t<=a);if(0===n.length)break;let i=n[Math.floor(Math.random()*n.length)];t.push(i),a-=i}return a>0&&a<100&&t.length>0&&(t[t.length-1]+=a),t}(Math.floor($))){let _=i/g,p=Date.now().toString(36).toUpperCase(),f=`BLK-${s}-${p}-${String(u).padStart(4,"0")}`,E=`RCP-${p}-${Math.random().toString(36).substring(2,6).toUpperCase()}`,R=await e.query(`INSERT INTO sales (
          branch_id, shift_id, staff_id, nozzle_id,
          invoice_number, receipt_number, sale_date,
          fuel_type, quantity, unit_price, total_amount,
          payment_method, is_automated, source_system,
          transmission_status, created_at
        ) VALUES (
          $1, $2, $3, $4, $5, $6, NOW(),
          $7, $8, $9, $10,
          'cash', true, 'meter_diff_bulk',
          'pending', NOW()
        ) RETURNING id`,[a,t,r,n.nozzle_id,f,E,h,parseFloat(_.toFixed(2)),g,i]);c.push({id:R.rows[0]?.id,branch_id:a,invoice_number:f,receipt_number:E,fuel_type:h,quantity:parseFloat(_.toFixed(2)),unit_price:g,total_amount:i}),o++,l+=_,d+=i,u++}}return console.log(`[BULK SALES] Generated ${o} invoices, ${l.toFixed(2)}L, KES ${d}`),{invoicesCreated:o,totalVolume:l,totalAmount:d,salesForKra:c}}async function l(e){try{let{branch_id:t,start_time:a,opening_cash:n,notes:i,staff_id:s,user_id:o}=await e.json();if(!t)return r.NextResponse.json({error:"Branch ID is required"},{status:400});if((await c.query("SELECT id FROM shifts WHERE branch_id = $1 AND status = 'active'",[t])).rows.length>0)return r.NextResponse.json({error:"An active shift already exists for this branch"},{status:400});let l=s;if(!l&&o){let e=await c.query("SELECT id FROM staff WHERE user_id = $1",[o]);e.rows.length>0&&(l=e.rows[0].id)}let d=await c.query(`INSERT INTO shifts (branch_id, staff_id, start_time, status, opening_cash, notes, created_at)
       VALUES ($1, $2, $3, 'active', $4, $5, NOW())
       RETURNING *`,[t,l||null,a||new Date().toISOString(),n||0,i||null]);return r.NextResponse.json({success:!0,data:d.rows[0]})}catch(e){return console.error("Error starting shift:",e),r.NextResponse.json({error:"Failed to start shift",details:e.message},{status:500})}}async function d(e){try{let{searchParams:t}=new URL(e.url),a=t.get("branch_id"),n=t.get("status"),i="SELECT * FROM shifts WHERE 1=1",s=[];a&&(s.push(a),i+=` AND branch_id = $${s.length}`),n&&(s.push(n),i+=` AND status = $${s.length}`),i+=" ORDER BY created_at DESC LIMIT 1";let o=await c.query(i,s);return r.NextResponse.json({success:!0,data:o.rows[0]||null})}catch(e){return console.error("Error fetching shift:",e),r.NextResponse.json({error:"Failed to fetch shift",details:e.message},{status:500})}}async function u(e){let t=await c.connect();try{let{id:a,end_time:n,closing_cash:s,total_sales:l,notes:d,status:u,nozzle_readings:_,tank_stocks:p}=await e.json();if(!a)return t.release(),r.NextResponse.json({error:"Shift ID is required"},{status:400});await t.query("BEGIN");let h=await t.query("SELECT status FROM shifts WHERE id = $1",[a]);if(0===h.rows.length)return await t.query("ROLLBACK"),t.release(),r.NextResponse.json({error:"Shift not found"},{status:404});let f=h.rows[0].status,g=u||"completed";if("active"===f&&"completed"===g&&(!_||!Array.isArray(_)||0===_.length))return await t.query("ROLLBACK"),t.release(),r.NextResponse.json({error:"Nozzle meter readings are required to end a shift. Please enter closing readings for all nozzles."},{status:400});let E=await t.query(`SELECT s.*, b.name as branch_name FROM shifts s
       JOIN branches b ON s.branch_id = b.id
       WHERE s.id = $1`,[a]);if(0===E.rows.length)return await t.query("ROLLBACK"),t.release(),r.NextResponse.json({error:"Shift not found"},{status:404});let R=E.rows[0],m=R.branch_id,$=R.branch_name||"BRN",w=R.staff_id,S=n||new Date().toISOString(),N=await t.query("SELECT id, initial_meter_reading FROM nozzles WHERE branch_id = $1",[m]),y={};for(let e of N.rows)y[e.id]=parseFloat(e.initial_meter_reading)||0;for(let e of(await t.query(`SELECT nozzle_id, closing_reading FROM shift_readings 
       WHERE branch_id = $1 AND reading_type = 'nozzle' AND nozzle_id IS NOT NULL
       ORDER BY created_at DESC`,[m])).rows)(!y[e.nozzle_id]||parseFloat(e.closing_reading)>y[e.nozzle_id])&&(y[e.nozzle_id]=parseFloat(e.closing_reading));let A=await t.query("SELECT id, current_stock FROM tanks WHERE branch_id = $1",[m]),v={};for(let e of A.rows)v[e.id]=parseFloat(e.current_stock)||0;if(_&&_.length>0){for(let e of _)if(e.nozzle_id&&!isNaN(e.closing_reading)){let a=y[e.nozzle_id]||0;if(e.closing_reading<a)return await t.query("ROLLBACK"),t.release(),r.NextResponse.json({error:`Nozzle closing reading (${e.closing_reading}) cannot be less than opening reading (${a})`},{status:400})}}let b=(await t.query(`UPDATE shifts 
       SET end_time = $1, closing_cash = $2, total_sales = $3, notes = $4, status = $5, updated_at = NOW()
       WHERE id = $6
       RETURNING *`,[S,s||0,l||0,d||null,u||"completed",a])).rows[0];await t.query("DELETE FROM shift_readings WHERE shift_id = $1",[a]);let C=[];if(_&&_.length>0){for(let e of _)if(e.nozzle_id&&!isNaN(e.closing_reading)){let r=y[e.nozzle_id]||0;await t.query(`INSERT INTO shift_readings (shift_id, branch_id, reading_type, nozzle_id, opening_reading, closing_reading)
             VALUES ($1, $2, 'nozzle', $3, $4, $5)`,[a,m,e.nozzle_id,r,e.closing_reading]),C.push({nozzle_id:e.nozzle_id,opening_reading:r,closing_reading:e.closing_reading})}}let T={invoicesCreated:0,totalVolume:0,totalAmount:0,salesForKra:[]};if(C.length>0&&(T=await o(t,a,m,w,$,C)).totalAmount>0&&await t.query("UPDATE shifts SET total_sales = $1 WHERE id = $2",[T.totalAmount,a]),p&&p.length>0){for(let e of p)if(e.tank_id&&!isNaN(e.closing_reading)){let r=v[e.tank_id]||0,n=e.stock_received||0;await t.query(`INSERT INTO shift_readings (shift_id, branch_id, reading_type, tank_id, opening_reading, closing_reading, stock_received)
             VALUES ($1, $2, 'tank', $3, $4, $5, $6)`,[a,m,e.tank_id,r,e.closing_reading,n]),await t.query("UPDATE tanks SET current_stock = $1, updated_at = NOW() WHERE id = $2",[e.closing_reading,e.tank_id])}}let O=(await t.query(`INSERT INTO shifts (branch_id, start_time, status, opening_cash, notes, created_at)
       VALUES ($1, $2, 'active', $3, NULL, NOW())
       RETURNING *`,[m,S,s||0])).rows[0];if(await t.query("COMMIT"),T.salesForKra.length>0)for(let e of(console.log(`[BULK SALES] Submitting ${T.salesForKra.length} sales to KRA...`),T.salesForKra))try{let t=await (0,i.callKraSaveSales)({branch_id:e.branch_id,invoice_number:e.invoice_number,receipt_number:e.receipt_number,fuel_type:e.fuel_type,quantity:e.quantity,unit_price:e.unit_price,total_amount:e.total_amount,payment_method:"cash",customer_name:"Walk-in Customer",customer_pin:"",sale_date:new Date().toISOString()}),a=t.kraResponse?.data||{},r=t.success?"success":"failed",n=t.success?"transmitted":"failed";await c.query(`UPDATE sales SET 
              kra_status = $1,
              kra_rcpt_sign = $2,
              kra_scu_id = $3,
              kra_cu_inv = $4,
              kra_internal_data = $5,
              transmission_status = $6,
              updated_at = NOW()
            WHERE id = $7`,[r,a.rcptSign||null,a.sdcId||null,a.rcptNo?`${a.sdcId||""}/${a.rcptNo}`:null,a.intrlData||null,n,e.id]),console.log(`[BULK SALES] Invoice ${e.invoice_number} - KRA ${t.success?"SUCCESS":"FAILED"}`)}catch(t){console.error(`[BULK SALES] KRA submission error for ${e.invoice_number}:`,t.message),await c.query(`UPDATE sales SET 
              kra_status = 'failed',
              kra_error = $1,
              transmission_status = 'failed',
              updated_at = NOW()
            WHERE id = $2`,[t.message||"KRA submission error",e.id])}return r.NextResponse.json({success:!0,data:b,newShift:O,bulkSales:{invoicesCreated:T.invoicesCreated,totalVolume:T.totalVolume,totalAmount:T.totalAmount}})}catch(e){return await t.query("ROLLBACK"),console.error("Error updating shift:",e),r.NextResponse.json({error:"Failed to update shift",details:e.message},{status:500})}finally{t.release()}}e.s(["GET",()=>d,"PATCH",()=>u,"POST",()=>l]),a()}catch(e){a(e)}},!1),67662,e=>e.a(async(t,a)=>{try{var r=e.i(47909),n=e.i(74017),i=e.i(96250),s=e.i(59756),o=e.i(61916),l=e.i(14444),d=e.i(37092),u=e.i(69741),c=e.i(16795),_=e.i(87718),p=e.i(95169),h=e.i(47587),f=e.i(66012),g=e.i(70101),E=e.i(26937),R=e.i(10372),m=e.i(93695);e.i(52474);var $=e.i(220),w=e.i(98078),S=t([w]);[w]=S.then?(await S)():S;let A=new r.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/shifts/route",pathname:"/api/shifts",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/shifts/route.ts",nextConfigOutput:"standalone",userland:w}),{workAsyncStorage:v,workUnitAsyncStorage:b,serverHooks:C}=A;function N(){return(0,i.patchFetch)({workAsyncStorage:v,workUnitAsyncStorage:b})}async function y(e,t,a){A.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/shifts/route";r=r.replace(/\/index$/,"")||"/";let i=await A.prepare(e,t,{srcPage:r,multiZoneDraftMode:!1});if(!i)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:w,params:S,nextConfig:N,parsedUrl:y,isDraftMode:v,prerenderManifest:b,routerServerContext:C,isOnDemandRevalidate:T,revalidateOnlyGenerated:O,resolvedPathname:L,clientReferenceManifest:z,serverActionsManifest:q}=i,x=(0,u.normalizeAppPath)(r),I=!!(b.dynamicRoutes[x]||b.routes[L]),U=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,y,!1):t.end("This page could not be found"),null);if(I&&!v){let e=!!b.routes[L],t=b.dynamicRoutes[x];if(t&&!1===t.fallback&&!e){if(N.experimental.adapterPath)return await U();throw new m.NoFallbackError}}let k=null;!I||A.isDev||v||(k=L,k="/index"===k?"/":k);let F=!0===A.isDev||!I,D=I&&!F;q&&z&&(0,l.setReferenceManifestsSingleton)({page:r,clientReferenceManifest:z,serverActionsManifest:q,serverModuleMap:(0,d.createServerModuleMap)({serverActionsManifest:q})});let M=e.method||"GET",H=(0,o.getTracer)(),P=H.getActiveScopeSpan(),K={params:S,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!N.experimental.authInterrupts},cacheComponents:!!N.cacheComponents,supportsDynamicResponse:F,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:N.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>A.onRequestError(e,t,r,C)},sharedContext:{buildId:w}},W=new c.NodeNextRequest(e),B=new c.NodeNextResponse(t),j=_.NextRequestAdapter.fromNodeNextRequest(W,(0,_.signalFromNodeResponse)(t));try{let i=async e=>A.handle(j,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=H.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=a.get("next.route");if(n){let t=`${M} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${M} ${r}`)}),l=!!(0,s.getRequestMeta)(e,"minimalMode"),d=async s=>{var o,d;let u=async({previousCacheEntry:n})=>{try{if(!l&&T&&O&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await i(s);e.fetchMetrics=K.renderOpts.fetchMetrics;let o=K.renderOpts.pendingWaitUntil;o&&a.waitUntil&&(a.waitUntil(o),o=void 0);let d=K.renderOpts.collectedTags;if(!I)return await (0,f.sendResponse)(W,B,r,K.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(r.headers);d&&(t[R.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,n=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:$.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:n}}}}catch(t){throw(null==n?void 0:n.isStale)&&await A.onRequestError(e,t,{routerKind:"App Router",routePath:r,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:T})},C),t}},c=await A.handleResponse({req:e,nextConfig:N,cacheKey:k,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:O,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:l});if(!I)return null;if((null==c||null==(o=c.value)?void 0:o.kind)!==$.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(d=c.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",T?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),v&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let _=(0,g.fromNodeOutgoingHttpHeaders)(c.value.headers);return l&&I||_.delete(R.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||_.get("Cache-Control")||_.set("Cache-Control",(0,E.getCacheControlHeader)(c.cacheControl)),await (0,f.sendResponse)(W,B,new Response(c.value.body,{headers:_,status:c.value.status||200})),null};P?await d(P):await H.withPropagatedContext(e.headers,()=>H.trace(p.BaseServerSpan.handleRequest,{spanName:`${M} ${r}`,kind:o.SpanKind.SERVER,attributes:{"http.method":M,"http.target":e.url}},d))}catch(t){if(t instanceof m.NoFallbackError||await A.onRequestError(e,t,{routerKind:"App Router",routePath:x,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:T})}),I)throw t;return await (0,f.sendResponse)(W,B,new Response(null,{status:500})),null}}e.s(["handler",()=>y,"patchFetch",()=>N,"routeModule",()=>A,"serverHooks",()=>C,"workAsyncStorage",()=>v,"workUnitAsyncStorage",()=>b]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=_8a5a5142._.js.map