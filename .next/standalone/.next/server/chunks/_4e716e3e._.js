module.exports=[66195,e=>e.a(async(t,a)=>{try{var s=e.i(89171),r=e.i(70038),n=e.i(90793),i=e.i(57902),o=e.i(65488),l=t([r,n,i]);[r,n,i]=l.then?(await l)():l;let m={cash:"01",credit:"02",mobile_money:"03",mpesa:"03",bank_transfer:"04",card:"05",cheque:"06",other:"07"};function d(e=new Date){let t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0");return`${t}${a}${s}`}function c(e){return(Math.round(100*e)/100).toFixed(2)}async function u(e){try{let{branch_id:t,amount:a,nozzle_id:r,fuel_type:l,customer_pin:u,payment_method:p,discount_type:_,discount_value:S,is_loyalty_sale:h,loyalty_customer_name:E}=await e.json();if(!t||!a||!r)return s.NextResponse.json({success:!1,error:"Missing required fields"},{status:400});let R=await (0,n.query)(`
      SELECT id, bhf_id, kra_pin, device_token, server_address, server_port, 
             COALESCE(invoice_number, 0) as invoice_number,
             COALESCE(sr_number, 0) as sr_number
      FROM branches
      WHERE id = $1
    `,[t]);if(0===R.length)return s.NextResponse.json({success:!1,error:"Branch not found"},{status:404});let v=R[0];if(!v.kra_pin)return s.NextResponse.json({success:!1,error:"KRA PIN not configured for this branch"},{status:400});let g=await (0,n.query)(`
      SELECT n.id, n.fuel_type, n.item_id,
             COALESCE(n.initial_meter_reading, 0) as initial_meter_reading,
             i.item_code, i.class_code, i.item_name, i.package_unit, i.quantity_unit, i.tax_type
      FROM nozzles n
      LEFT JOIN items i ON n.item_id = i.id
      WHERE n.id = $1
    `,[r]);if(0===g.length)return s.NextResponse.json({success:!1,error:"Nozzle not found"},{status:404});let A=g[0],C=0;if(A.item_id){let e=await (0,n.query)(`
        SELECT bi.sale_price
        FROM branch_items bi
        WHERE bi.branch_id = $1 AND bi.item_id = $2 AND bi.is_available = true
      `,[t,A.item_id]);e.length>0&&e[0].sale_price&&(C=parseFloat(e[0].sale_price))}if(C<=0&&A.fuel_type){let e=await (0,n.query)(`
        SELECT bi.sale_price, i.id as item_id, i.item_code, i.class_code, i.item_name,
               i.package_unit, i.quantity_unit, i.tax_type
        FROM branch_items bi
        JOIN items i ON bi.item_id = i.id
        WHERE bi.branch_id = $1
          AND bi.is_available = true
          AND (
            UPPER(i.item_name) = UPPER($2) 
            OR i.item_name ILIKE $3
            OR (UPPER($2) = 'PETROL' AND (UPPER(i.item_name) LIKE '%PETROL%' OR UPPER(i.item_name) LIKE '%SUPER%'))
            OR (UPPER($2) = 'DIESEL' AND UPPER(i.item_name) LIKE '%DIESEL%')
            OR (UPPER($2) = 'KEROSENE' AND UPPER(i.item_name) LIKE '%KEROSENE%')
          )
        ORDER BY bi.updated_at DESC NULLS LAST
        LIMIT 1
      `,[t,A.fuel_type,`%${A.fuel_type}%`]);if(e.length>0&&e[0].sale_price){let t=e[0];C=parseFloat(t.sale_price),A.item_id||(A={...A,item_id:t.item_id,item_code:t.item_code,class_code:t.class_code,item_name:t.item_name,package_unit:t.package_unit,quantity_unit:t.quantity_unit,tax_type:t.tax_type})}}if(!A.item_id)return s.NextResponse.json({success:!1,error:`Nozzle "${A.fuel_type}" is not mapped to an item. Please assign an item to this nozzle first.`},{status:400});if(C<=0)return s.NextResponse.json({success:!1,error:`No branch-specific price found for "${A.fuel_type}". Please go to Inventory Management and set a price for this item in branch_items.`},{status:400});let y=0;S&&S>0&&(y="percentage"===_?a*Math.min(S,100)/100:Math.min(S,a));let b=Math.max(a-y,0),f=b/C,k=(parseFloat(A.initial_meter_reading)||0)+f,x=(0,o.buildKraBaseUrl)(v.server_address,v.server_port),T={saveSales:null,saveStockItems:null,saveStockMaster:null},N=v.invoice_number+1;await (0,n.query)("UPDATE branches SET invoice_number = $1 WHERE id = $2",[N,t]);let I=`CIV-${String(N).padStart(6,"0")}`,M=new Date,w=function(e=new Date){let t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0"),r=String(e.getHours()).padStart(2,"0"),n=String(e.getMinutes()).padStart(2,"0"),i=String(e.getSeconds()).padStart(2,"0");return`${t}${a}${s}${r}${n}${i}`}(M),O=d(M),$=m[p?.toLowerCase()]||"01",P=A.item_code||"ITEM001",D=A.class_code||"15100000",U=A.item_name||l||"Fuel",q=A.package_unit||"NT",F=A.quantity_unit||"LTR",L=A.tax_type||"B",{taxblAmt:H,taxAmt:j,taxRt:K}=function(e,t="B"){if("A"===t){let t=e/1.16;return{taxblAmt:Math.round(100*t)/100,taxAmt:Math.round(100*(e-t))/100,taxRt:16}}return"B"===t?{taxblAmt:e,taxAmt:Math.round(.16*e*100)/100,taxRt:16}:"C"===t?{taxblAmt:e,taxAmt:Math.round(.08*e*100)/100,taxRt:8}:{taxblAmt:e,taxAmt:0,taxRt:0}}(b,L),B={tin:v.kra_pin,bhfId:v.bhf_id||"00",trdInvcNo:I,invcNo:String(N),orgInvcNo:0,custTin:u||null,custNm:h?E:"Walk-in Customer",salesTyCd:"N",rcptTyCd:"S",pmtTyCd:$,salesSttsCd:"02",cfmDt:w,salesDt:O,stockRlsDt:w,cnclReqDt:null,cnclDt:null,rfdDt:null,rfdRsnCd:null,totItemCnt:1,taxblAmtA:"A"===L?c(H):"0.00",taxblAmtB:"B"===L?c(H):"0.00",taxblAmtC:"C"===L?c(H):"0.00",taxblAmtD:"0.00",taxblAmtE:"0.00",taxRtA:"A"===L?c(K):"0.00",taxRtB:"B"===L?c(K):"0.00",taxRtC:"C"===L?c(K):"0.00",taxRtD:"0.00",taxRtE:"0.00",taxAmtA:"A"===L?c(j):"0.00",taxAmtB:"B"===L?c(j):"0.00",taxAmtC:"C"===L?c(j):"0.00",taxAmtD:"0.00",taxAmtE:"0.00",totTaxblAmt:c(H),totTaxAmt:c(j),totAmt:c(b),prchrAcptcYn:"N",remark:null,regrNm:"Admin",regrId:"Admin",modrNm:"Admin",modrId:"Admin",receipt:{custTin:u||null,custMblNo:null,rcptPbctDt:null,trdeNm:null,adrs:null,topMsg:null,btmMsg:null,prchrAcptcYn:"Y"},itemList:[{itemSeq:1,itemCd:P,itemClsCd:D,itemNm:U,bcd:null,pkgUnitCd:q,pkg:1,qtyUnitCd:F,qty:parseFloat(f.toFixed(2)),prc:C,splyAmt:c(b),dcRt:y>0?parseFloat((y/a*100).toFixed(2)):0,dcAmt:y,isrccCd:null,isrccNm:null,isrcRt:0,isrcAmt:0,taxTyCd:L,taxblAmt:c(H),taxAmt:c(j),totAmt:c(b)}]},W=Date.now();try{let e=new AbortController,a=setTimeout(()=>e.abort(),3e4),s=await fetch(`${x}/trnsSales/saveSales`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...v.device_token?{DeviceSerialNo:v.device_token}:{}},body:JSON.stringify(B),signal:e.signal});clearTimeout(a),T.saveSales=await s.json(),await (0,i.logApiCall)({endpoint:"/trnsSales/saveSales",method:"POST",payload:B,response:T.saveSales,statusCode:s.status,durationMs:Date.now()-W,branchId:t,externalEndpoint:`${x}/trnsSales/saveSales`})}catch(e){T.saveSales={resultCd:"AbortError"===e.name?"TIMEOUT":"NETWORK_ERROR",resultMsg:e.message||"Failed to connect to KRA",resultDt:new Date().toISOString()},await (0,i.logApiCall)({endpoint:"/trnsSales/saveSales",method:"POST",payload:B,response:T.saveSales,statusCode:0,durationMs:Date.now()-W,branchId:t,error:e.message,externalEndpoint:`${x}/trnsSales/saveSales`})}if(T.saveSales?.resultCd!=="000"&&T.saveSales?.resultCd!=="0")return s.NextResponse.json({success:!1,invoiceNumber:I,error:T.saveSales?.resultMsg||"Failed to save sales to KRA",responses:{saveSales:T.saveSales,saveStockItems:null,saveStockMaster:null},summary:{saveSales:T.saveSales?.resultMsg||"Failed",saveStockItems:"Skipped - saveSales failed",saveStockMaster:"Skipped - saveSales failed"}});let z=v.sr_number+1;await (0,n.query)("UPDATE branches SET sr_number = $1 WHERE id = $2",[z,t]);let Y=await (0,n.query)(`
      SELECT id FROM shifts 
      WHERE branch_id = $1 AND status = 'active' 
      ORDER BY start_time DESC LIMIT 1
    `,[t]),J=Y.length>0?Y[0].id:null,V=T.saveSales?.data||{};await (0,n.query)(`INSERT INTO sales (
        branch_id, shift_id, nozzle_id, fuel_type, quantity, unit_price, 
        total_amount, payment_method, customer_name, customer_pin,
        invoice_number, transmission_status, meter_reading_after,
        is_loyalty_sale, loyalty_customer_name, loyalty_customer_pin, 
        sale_date, created_at,
        kra_status, kra_rcpt_sign, kra_scu_id, kra_cu_inv
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, NOW(), NOW(), $17, $18, $19, $20)`,[t,J,r,l||A.fuel_type,f,C,b,p||"cash",h?E:"Walk-in Customer",u||null,I,"transmitted",k,h||!1,h?E:null,h?u:null,"success",V.rcptSign||null,V.sdcId||null,V.curRcptNo||null]),await (0,n.query)("UPDATE nozzles SET initial_meter_reading = $1, updated_at = NOW() WHERE id = $2",[k,r]);let G=Math.round(f*C*100)/100,X=Math.round(.16*G*100)/100,Q={tin:v.kra_pin,bhfId:v.bhf_id||"00",sarNo:z,orgSarNo:0,regTyCd:"M",custTin:null,custNm:null,custBhfId:null,sarTyCd:"11",ocrnDt:d(),totItemCnt:1,totTaxblAmt:c(G),totTaxAmt:c(X),totAmt:c(G),remark:null,regrId:"Admin",regrNm:"Admin",modrNm:"Admin",modrId:"Admin",itemList:[{itemSeq:1,itemCd:P,itemClsCd:D,itemNm:U,bcd:null,pkgUnitCd:q,pkg:Math.ceil(f),qtyUnitCd:F,qty:parseFloat(f.toFixed(2)),itemExprDt:null,prc:C,splyAmt:c(G),totDcAmt:0,taxblAmt:c(G),taxTyCd:L,taxAmt:c(X),totAmt:c(G)}]};W=Date.now();try{let e=new AbortController,a=setTimeout(()=>e.abort(),15e3),s=await fetch(`${x}/stock/saveStockItems`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(Q),signal:e.signal});clearTimeout(a),T.saveStockItems=await s.json(),await (0,i.logApiCall)({endpoint:"/stock/saveStockItems",method:"POST",payload:Q,response:T.saveStockItems,statusCode:s.status,durationMs:Date.now()-W,branchId:t,externalEndpoint:`${x}/stock/saveStockItems`})}catch(e){T.saveStockItems={resultCd:"AbortError"===e.name?"TIMEOUT":"NETWORK_ERROR",resultMsg:e.message||"Failed to connect to KRA",resultDt:new Date().toISOString()},await (0,i.logApiCall)({endpoint:"/stock/saveStockItems",method:"POST",payload:Q,response:T.saveStockItems,statusCode:0,durationMs:Date.now()-W,branchId:t,error:e.message,externalEndpoint:`${x}/stock/saveStockItems`})}let Z=await (0,n.query)(`
      SELECT current_stock FROM tanks
      WHERE branch_id = $1 AND (kra_item_cd = $2 OR UPPER(fuel_type) = UPPER($3))
      LIMIT 1
    `,[t,P,U]),ee=Z.length>0&&parseFloat(Z[0].current_stock)||0,et={tin:v.kra_pin,bhfId:v.bhf_id||"00",itemCd:P,rsdQty:ee,regrId:"Admin",regrNm:"Admin",modrNm:"Admin",modrId:"Admin"};W=Date.now();try{let e=new AbortController,a=setTimeout(()=>e.abort(),15e3),s=await fetch(`${x}/stockMaster/saveStockMaster`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(et),signal:e.signal});clearTimeout(a),T.saveStockMaster=await s.json(),await (0,i.logApiCall)({endpoint:"/stockMaster/saveStockMaster",method:"POST",payload:et,response:T.saveStockMaster,statusCode:s.status,durationMs:Date.now()-W,branchId:t,externalEndpoint:`${x}/stockMaster/saveStockMaster`})}catch(e){T.saveStockMaster={resultCd:"AbortError"===e.name?"TIMEOUT":"NETWORK_ERROR",resultMsg:e.message||"Failed to connect to KRA",resultDt:new Date().toISOString()},await (0,i.logApiCall)({endpoint:"/stockMaster/saveStockMaster",method:"POST",payload:et,response:T.saveStockMaster,statusCode:0,durationMs:Date.now()-W,branchId:t,error:e.message,externalEndpoint:`${x}/stockMaster/saveStockMaster`})}let ea=T.saveStockItems?.resultCd==="000"||T.saveStockItems?.resultCd==="0",es=T.saveStockMaster?.resultCd==="000"||T.saveStockMaster?.resultCd==="0";return s.NextResponse.json({success:!0,invoiceNumber:I,responses:{saveSales:T.saveSales,saveStockItems:T.saveStockItems,saveStockMaster:T.saveStockMaster},summary:{saveSales:"Success",saveStockItems:ea?"Success":T.saveStockItems?.resultMsg||"Failed",saveStockMaster:es?"Success":T.saveStockMaster?.resultMsg||"Failed"}})}catch(e){return console.error("[Issue Invoice API] Error:",e),s.NextResponse.json({success:!1,error:e.message||"Failed to issue invoice"},{status:500})}}e.s(["POST",()=>u]),a()}catch(e){a(e)}},!1),53753,e=>e.a(async(t,a)=>{try{var s=e.i(47909),r=e.i(74017),n=e.i(96250),i=e.i(59756),o=e.i(61916),l=e.i(14444),d=e.i(37092),c=e.i(69741),u=e.i(16795),m=e.i(87718),p=e.i(95169),_=e.i(47587),S=e.i(66012),h=e.i(70101),E=e.i(26937),R=e.i(10372),v=e.i(93695);e.i(52474);var g=e.i(220),A=e.i(66195),C=t([A]);[A]=C.then?(await C)():C;let f=new s.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/kra/issue-invoice/route",pathname:"/api/kra/issue-invoice",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/kra/issue-invoice/route.ts",nextConfigOutput:"standalone",userland:A}),{workAsyncStorage:k,workUnitAsyncStorage:x,serverHooks:T}=f;function y(){return(0,n.patchFetch)({workAsyncStorage:k,workUnitAsyncStorage:x})}async function b(e,t,a){f.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let s="/api/kra/issue-invoice/route";s=s.replace(/\/index$/,"")||"/";let n=await f.prepare(e,t,{srcPage:s,multiZoneDraftMode:!1});if(!n)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:A,params:C,nextConfig:y,parsedUrl:b,isDraftMode:k,prerenderManifest:x,routerServerContext:T,isOnDemandRevalidate:N,revalidateOnlyGenerated:I,resolvedPathname:M,clientReferenceManifest:w,serverActionsManifest:O}=n,$=(0,c.normalizeAppPath)(s),P=!!(x.dynamicRoutes[$]||x.routes[M]),D=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,b,!1):t.end("This page could not be found"),null);if(P&&!k){let e=!!x.routes[M],t=x.dynamicRoutes[$];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await D();throw new v.NoFallbackError}}let U=null;!P||f.isDev||k||(U=M,U="/index"===U?"/":U);let q=!0===f.isDev||!P,F=P&&!q;O&&w&&(0,l.setReferenceManifestsSingleton)({page:s,clientReferenceManifest:w,serverActionsManifest:O,serverModuleMap:(0,d.createServerModuleMap)({serverActionsManifest:O})});let L=e.method||"GET",H=(0,o.getTracer)(),j=H.getActiveScopeSpan(),K={params:C,prerenderManifest:x,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,s)=>f.onRequestError(e,t,s,T)},sharedContext:{buildId:A}},B=new u.NodeNextRequest(e),W=new u.NodeNextResponse(t),z=m.NextRequestAdapter.fromNodeNextRequest(B,(0,m.signalFromNodeResponse)(t));try{let n=async e=>f.handle(z,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=H.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${L} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${L} ${s}`)}),l=!!(0,i.getRequestMeta)(e,"minimalMode"),d=async i=>{var o,d;let c=async({previousCacheEntry:r})=>{try{if(!l&&N&&I&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await n(i);e.fetchMetrics=K.renderOpts.fetchMetrics;let o=K.renderOpts.pendingWaitUntil;o&&a.waitUntil&&(a.waitUntil(o),o=void 0);let d=K.renderOpts.collectedTags;if(!P)return await (0,S.sendResponse)(B,W,s,K.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(s.headers);d&&(t[R.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,r=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==r?void 0:r.isStale)&&await f.onRequestError(e,t,{routerKind:"App Router",routePath:s,routeType:"route",revalidateReason:(0,_.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:N})},T),t}},u=await f.handleResponse({req:e,nextConfig:y,cacheKey:U,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:x,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:I,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:l});if(!P)return null;if((null==u||null==(o=u.value)?void 0:o.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",N?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),k&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,h.fromNodeOutgoingHttpHeaders)(u.value.headers);return l&&P||m.delete(R.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,E.getCacheControlHeader)(u.cacheControl)),await (0,S.sendResponse)(B,W,new Response(u.value.body,{headers:m,status:u.value.status||200})),null};j?await d(j):await H.withPropagatedContext(e.headers,()=>H.trace(p.BaseServerSpan.handleRequest,{spanName:`${L} ${s}`,kind:o.SpanKind.SERVER,attributes:{"http.method":L,"http.target":e.url}},d))}catch(t){if(t instanceof v.NoFallbackError||await f.onRequestError(e,t,{routerKind:"App Router",routePath:$,routeType:"route",revalidateReason:(0,_.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:N})}),P)throw t;return await (0,S.sendResponse)(B,W,new Response(null,{status:500})),null}}e.s(["handler",()=>b,"patchFetch",()=>y,"routeModule",()=>f,"serverHooks",()=>T,"workAsyncStorage",()=>k,"workUnitAsyncStorage",()=>x]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=_4e716e3e._.js.map