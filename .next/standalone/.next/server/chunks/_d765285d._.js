module.exports=[29747,e=>e.a(async(t,a)=>{try{var r=e.i(89171),n=e.i(30056),i=e.i(39298),s=t([n,i]);[n,i]=s.then?(await s)():s;let o=new n.Pool({connectionString:process.env.DATABASE_URL});async function l(e){try{let t=await e.json();console.log("[Mobile Create Sale] Request body:",JSON.stringify(t,null,2));let{branch_id:a,user_id:n,nozzle_id:s,fuel_type:l,quantity:u,unit_price:c,total_amount:d,payment_method:_,customer_name:p,kra_pin:m,vehicle_number:E,is_loyalty_customer:h,loyalty_customer_name:R,loyalty_customer_pin:b}=t;if(!a||!l||!d)return console.log("[Mobile Create Sale] Missing required fields - branch_id:",a,"fuel_type:",l,"total_amount:",d),r.NextResponse.json({error:`Missing required fields: branch_id=${a}, fuel_type=${l}, total_amount=${d}`},{status:400});let y=await o.connect();try{let e=await y.query(`SELECT id, invoice_number, kra_status, kra_cu_inv, kra_rcpt_sign, kra_internal_data,
                customer_name, customer_pin, is_loyalty_sale, loyalty_customer_name, loyalty_customer_pin
         FROM sales 
         WHERE branch_id = $1 
           AND fuel_type = $2 
           AND total_amount = $3 
           AND created_at > NOW() - INTERVAL '60 seconds'
           AND kra_status = 'success'
         ORDER BY created_at DESC 
         LIMIT 1`,[a,l,d]);if(e.rows.length>0){let t=e.rows[0];console.log("[Mobile Create Sale] Duplicate sale detected, returning existing:",t.id);let n=(await y.query("SELECT name, address, phone, kra_pin, bhf_id FROM branches WHERE id = $1",[a])).rows[0]||{},i=t.is_loyalty_sale&&t.loyalty_customer_name||t.customer_name,s=t.is_loyalty_sale&&t.loyalty_customer_pin||t.customer_pin;return r.NextResponse.json({success:!0,sale_id:t.id,duplicate:!0,message:"Sale already submitted to KRA within the last 60 seconds",invoice_number:t.invoice_number,kra_success:!0,print_data:{invoice_number:t.kra_cu_inv||t.invoice_number,receipt_no:t.kra_cu_inv?.split("/")[1]||null,cu_serial_number:t.kra_cu_inv?.split("/")[0]||null,cu_invoice_no:t.kra_cu_inv||null,intrl_data:t.kra_internal_data||null,branch_name:n.name||null,branch_address:n.address||null,branch_phone:n.phone||null,branch_pin:n.kra_pin||null,receipt_signature:t.kra_rcpt_sign||null,bhf_id:n.bhf_id||"03",customer_name:i||null,customer_pin:s||null,is_loyalty_customer:t.is_loyalty_sale||!1}})}let t=await y.query(`SELECT id, tank_name, kra_item_cd FROM tanks 
         WHERE branch_id = $1 AND fuel_type ILIKE $2 AND status = 'active' 
         ORDER BY current_stock DESC LIMIT 1`,[a,`%${l}%`]);if(t.rows.length>0&&!t.rows[0].kra_item_cd)return r.NextResponse.json({error:`Tank "${t.rows[0].tank_name}" is not mapped to an item. Please map the tank to an item in the item list before selling.`},{status:400});let o=await y.query(`SELECT bi.sale_price 
         FROM items i
         JOIN branch_items bi ON i.id = bi.item_id AND bi.branch_id = $1
         WHERE bi.is_available = true
           AND bi.sale_price IS NOT NULL
           AND bi.sale_price > 0
           AND (UPPER(i.item_name) = UPPER($2) OR i.item_name ILIKE $3)
         ORDER BY bi.updated_at DESC NULLS LAST LIMIT 1`,[a,l,`%${l}%`]),u=o.rows.length>0?parseFloat(o.rows[0].sale_price):c,w=d/u;console.log(`[Mobile Create Sale] Price from items table: ${u}, Calculated quantity: ${w}`);let $=await y.query("SELECT id FROM shifts WHERE branch_id = $1 AND status = 'active' ORDER BY created_at DESC LIMIT 1",[a]),N=$.rows[0]?.id||null,f=null;if(n){let e=await y.query("SELECT id FROM staff WHERE user_id = $1 AND branch_id = $2 LIMIT 1",[n,a]);f=e.rows[0]?.id||null}await y.query("BEGIN");let g=`INV-${Date.now().toString(36).toUpperCase()}`,S=`RCP-${Date.now().toString(36).toUpperCase()}`,C=null;if(s&&w>0){let e=await y.query("SELECT initial_meter_reading FROM nozzles WHERE id = $1",[s]);e.rows.length>0&&(C=(parseFloat(e.rows[0].initial_meter_reading)||0)+w,await y.query("UPDATE nozzles SET initial_meter_reading = $1, updated_at = NOW() WHERE id = $2",[C,s]))}let v=(await y.query(`INSERT INTO sales (
          branch_id, nozzle_id, fuel_type, quantity, 
          unit_price, total_amount, payment_method, customer_name, 
          vehicle_number, invoice_number, receipt_number, sale_date,
          customer_pin, is_loyalty_sale, loyalty_customer_name, loyalty_customer_pin,
          meter_reading_after, shift_id, staff_id
        ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, NOW(), $12, $13, $14, $15, $16, $17, $18)
        RETURNING *`,[a,s||null,l,w,u,d,_||"cash",p||"Walk-in Customer",E||null,g,S,m||null,h||!1,R||(h?p:null),b||(h?m:null),C,N,f])).rows[0];if(h&&p&&"Walk-in Customer"!==p){let e=await y.query("SELECT id FROM customers WHERE cust_nm = $1 AND branch_id = $2",[p,a]);if(0===e.rows.length){let e=await y.query("SELECT kra_pin, bhf_id FROM branches WHERE id = $1",[a]),t=e.rows[0]?.kra_pin||"",r=e.rows[0]?.bhf_id||"00",n=`CUST-${Date.now().toString(36).toUpperCase()}`;await y.query(`INSERT INTO customers (branch_id, tin, bhf_id, cust_nm, cust_tin, cust_no, use_yn)
             VALUES ($1, $2, $3, $4, $5, $6, 'Y')
             ON CONFLICT DO NOTHING`,[a,t,r,p,m||"",n])}}if(t.rows.length>0&&w>0){let e=t.rows[0].id;await y.query("UPDATE tanks SET current_stock = GREATEST(0, current_stock - $1), updated_at = NOW() WHERE id = $2",[w,e]),console.log(`[Mobile Create Sale] Reduced tank ${e} stock by ${w} liters`)}await y.query("COMMIT");let A=(await y.query("SELECT name, address, phone, kra_pin, bhf_id FROM branches WHERE id = $1",[a])).rows[0]||{},T=await y.query(`SELECT i.item_code FROM items i
         LEFT JOIN branch_items bi ON i.id = bi.item_id AND bi.branch_id = $1
         WHERE (i.branch_id = $1 OR (i.branch_id IS NULL AND bi.branch_id = $1))
         AND i.item_name ILIKE $2 LIMIT 1`,[a,`%${l}%`]),O=T.rows[0]?.item_code||null;console.log("[Mobile Create Sale] Sale created successfully, calling KRA endpoint...");let I=m||b||"",k=R||p||"Walk-in Customer";if(h&&!I&&(R||p)){let e=R||p,t=await y.query(`SELECT c.cust_tin, c.cust_nm FROM customers c
           INNER JOIN customer_branches cb ON c.id = cb.customer_id
           WHERE cb.branch_id = $1 AND cb.status = 'active' AND c.cust_nm = $2
           LIMIT 1`,[a,e]);t.rows.length>0&&(I=t.rows[0].cust_tin||"",k=t.rows[0].cust_nm||p,console.log(`[Mobile Create Sale] Found loyalty customer PIN from DB: ${I}`))}console.log(`[Mobile Create Sale] is_loyalty_customer: ${h}, customer_pin for KRA: ${I}`);let D=await (0,i.callKraSaveSales)({branch_id:a,invoice_number:g,receipt_number:S,fuel_type:l,quantity:w,unit_price:u,total_amount:d,payment_method:_||"cash",customer_name:k,customer_pin:I,sale_date:new Date().toISOString(),tank_id:t.rows.length>0?t.rows[0].id:void 0});console.log("[Mobile Create Sale] KRA API Response:",JSON.stringify(D,null,2));let M=D.kraResponse?.data||{},L=D.success?"success":"failed";return await y.query(`UPDATE sales SET 
          kra_status = $1,
          kra_rcpt_sign = $2,
          kra_scu_id = $3,
          kra_cu_inv = $4,
          kra_internal_data = $5,
          customer_pin = COALESCE(customer_pin, $7::text),
          loyalty_customer_pin = CASE WHEN is_loyalty_sale THEN COALESCE(loyalty_customer_pin, $7::text) ELSE loyalty_customer_pin END,
          updated_at = NOW()
        WHERE id = $6`,[L,M.rcptSign||null,M.sdcId||null,M.rcptNo?`${M.sdcId||""}/${M.rcptNo}`:null,M.intrlData||null,v.id,I||null]),r.NextResponse.json({success:!0,sale_id:v.id,sale:{...v,kra_status:L},invoice_number:g,receipt_number:S,kra_response:D.kraResponse,kra_success:D.success,print_data:{invoice_number:M.rcptNo?`${M.sdcId||""}/${M.rcptNo}`:g,receipt_no:M.rcptNo?.toString()||null,cu_serial_number:M.sdcId||null,cu_invoice_no:M.rcptNo?`${M.sdcId||""}/${M.rcptNo}`:null,intrl_data:M.intrlData||null,branch_name:A.name||null,branch_address:A.address||null,branch_phone:A.phone||null,branch_pin:A.kra_pin||null,item_code:O,receipt_signature:M.rcptSign||null,bhf_id:A.bhf_id||"03",customer_name:k,customer_pin:I||null,is_loyalty_customer:h||!1}})}catch(e){throw await y.query("ROLLBACK"),e}finally{y.release()}}catch(e){return console.error("[Mobile Create Sale API Error]:",e),r.NextResponse.json({error:e.message||"Failed to create sale"},{status:500})}}e.s(["POST",()=>l]),a()}catch(e){a(e)}},!1),46375,e=>e.a(async(t,a)=>{try{var r=e.i(47909),n=e.i(74017),i=e.i(96250),s=e.i(59756),l=e.i(61916),o=e.i(14444),u=e.i(37092),c=e.i(69741),d=e.i(16795),_=e.i(87718),p=e.i(95169),m=e.i(47587),E=e.i(66012),h=e.i(70101),R=e.i(26937),b=e.i(10372),y=e.i(93695);e.i(52474);var w=e.i(220),$=e.i(29747),N=t([$]);[$]=N.then?(await N)():N;let S=new r.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/mobile/create-sale/route",pathname:"/api/mobile/create-sale",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/mobile/create-sale/route.ts",nextConfigOutput:"standalone",userland:$}),{workAsyncStorage:C,workUnitAsyncStorage:v,serverHooks:A}=S;function f(){return(0,i.patchFetch)({workAsyncStorage:C,workUnitAsyncStorage:v})}async function g(e,t,a){S.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/mobile/create-sale/route";r=r.replace(/\/index$/,"")||"/";let i=await S.prepare(e,t,{srcPage:r,multiZoneDraftMode:!1});if(!i)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:$,params:N,nextConfig:f,parsedUrl:g,isDraftMode:C,prerenderManifest:v,routerServerContext:A,isOnDemandRevalidate:T,revalidateOnlyGenerated:O,resolvedPathname:I,clientReferenceManifest:k,serverActionsManifest:D}=i,M=(0,c.normalizeAppPath)(r),L=!!(v.dynamicRoutes[M]||v.routes[I]),q=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,g,!1):t.end("This page could not be found"),null);if(L&&!C){let e=!!v.routes[I],t=v.dynamicRoutes[M];if(t&&!1===t.fallback&&!e){if(f.experimental.adapterPath)return await q();throw new y.NoFallbackError}}let x=null;!L||S.isDev||C||(x=I,x="/index"===x?"/":x);let P=!0===S.isDev||!L,H=L&&!P;D&&k&&(0,o.setReferenceManifestsSingleton)({page:r,clientReferenceManifest:k,serverActionsManifest:D,serverModuleMap:(0,u.createServerModuleMap)({serverActionsManifest:D})});let U=e.method||"GET",F=(0,l.getTracer)(),W=F.getActiveScopeSpan(),K={params:N,prerenderManifest:v,renderOpts:{experimental:{authInterrupts:!!f.experimental.authInterrupts},cacheComponents:!!f.cacheComponents,supportsDynamicResponse:P,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:f.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>S.onRequestError(e,t,r,A)},sharedContext:{buildId:$}},j=new d.NodeNextRequest(e),B=new d.NodeNextResponse(t),z=_.NextRequestAdapter.fromNodeNextRequest(j,(0,_.signalFromNodeResponse)(t));try{let i=async e=>S.handle(z,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=F.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=a.get("next.route");if(n){let t=`${U} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${r}`)}),o=!!(0,s.getRequestMeta)(e,"minimalMode"),u=async s=>{var l,u;let c=async({previousCacheEntry:n})=>{try{if(!o&&T&&O&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await i(s);e.fetchMetrics=K.renderOpts.fetchMetrics;let l=K.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let u=K.renderOpts.collectedTags;if(!L)return await (0,E.sendResponse)(j,B,r,K.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(r.headers);u&&(t[b.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=b.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,n=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=b.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:n}}}}catch(t){throw(null==n?void 0:n.isStale)&&await S.onRequestError(e,t,{routerKind:"App Router",routePath:r,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:T})},A),t}},d=await S.handleResponse({req:e,nextConfig:f,cacheKey:x,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:v,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:O,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:o});if(!L)return null;if((null==d||null==(l=d.value)?void 0:l.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(u=d.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",T?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let _=(0,h.fromNodeOutgoingHttpHeaders)(d.value.headers);return o&&L||_.delete(b.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||_.get("Cache-Control")||_.set("Cache-Control",(0,R.getCacheControlHeader)(d.cacheControl)),await (0,E.sendResponse)(j,B,new Response(d.value.body,{headers:_,status:d.value.status||200})),null};W?await u(W):await F.withPropagatedContext(e.headers,()=>F.trace(p.BaseServerSpan.handleRequest,{spanName:`${U} ${r}`,kind:l.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},u))}catch(t){if(t instanceof y.NoFallbackError||await S.onRequestError(e,t,{routerKind:"App Router",routePath:M,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:T})}),L)throw t;return await (0,E.sendResponse)(j,B,new Response(null,{status:500})),null}}e.s(["handler",()=>g,"patchFetch",()=>f,"routeModule",()=>S,"serverHooks",()=>A,"workAsyncStorage",()=>C,"workUnitAsyncStorage",()=>v]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=_d765285d._.js.map