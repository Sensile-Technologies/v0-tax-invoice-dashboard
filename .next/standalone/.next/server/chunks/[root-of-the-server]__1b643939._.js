module.exports=[18622,(t,e,r)=>{e.exports=t.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(t,e,r)=>{e.exports=t.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(t,e,r)=>{e.exports=t.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(t,e,r)=>{e.exports=t.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},70406,(t,e,r)=>{e.exports=t.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},93695,(t,e,r)=>{e.exports=t.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},30056,t=>t.a(async(e,r)=>{try{let e=await t.y("pg");t.n(e),r()}catch(t){r(t)}},!0),90793,t=>t.a(async(e,r)=>{try{var n=t.i(30056),s=e([n]);[n]=s.then?(await s)():s;let i=new n.Pool({connectionString:process.env.DATABASE_URL,ssl:{rejectUnauthorized:!1}});async function a(t,e){let r=await i.connect();try{return(await r.query(t,e)).rows}finally{r.release()}}async function o(){return await i.connect()}t.s(["getClient",()=>o,"pool",()=>i,"query",()=>a]),r()}catch(t){r(t)}},!1),70038,t=>t.a(async(e,r)=>{try{var n=t.i(90793),s=e([n]);[n]=s.then?(await s)():s,t.s([]),r()}catch(t){r(t)}},!1),65488,t=>{"use strict";function e(t,e){let r="8088";if(!t)return`http://5.189.171.160:${e||r}`;let n=t.trim();return(/^https?:\/\//i.test(n)&&(n=n.replace(/^https?:\/\//i,"")),n=n.replace(/\/+$/,""),/:\d+$/.test(n))?`http://${n}`:`http://${n}:${e||r}`}t.s(["buildKraBaseUrl",()=>e])},83376,t=>t.a(async(e,r)=>{try{var n=t.i(70038),s=t.i(90793),a=t.i(65488),o=e([n,s]);[n,s]=o.then?(await o)():o,process.env.KRA_VSCU_URL;let p="/stock/saveStockItems";async function i(t){let e=await (0,s.query)(`
    SELECT b.kra_pin as tin, b.bhf_id,
           COALESCE(b.server_address, '5.189.171.160') as server_address,
           COALESCE(b.server_port, '8088') as server_port
    FROM branches b
    WHERE b.id = $1
  `,[t]);if(0===e.length)return null;let r=e[0];if(!r.tin){let e=await (0,s.query)(`
      SELECT v.kra_pin as tin 
      FROM branches b 
      JOIN vendors v ON v.id = b.vendor_id 
      WHERE b.id = $1
    `,[t]);return e.length>0&&e[0].tin?{tin:e[0].tin,bhfId:r.bhf_id||"00",serverAddress:r.server_address,serverPort:r.server_port}:null}return{tin:r.tin,bhfId:r.bhf_id||"00",serverAddress:r.server_address,serverPort:r.server_port}}let _={initial_stock:"01",stock_receive:"02",stock_adjustment:"06",stock_transfer:"05",sale:"11"};async function c(t,e=p){let r=await (0,s.query)(`
    UPDATE branches 
    SET sr_number = COALESCE(sr_number, 0) + 1,
        updated_at = NOW()
    WHERE id = $1
    RETURNING sr_number
  `,[t]);if(0===r.length)throw Error(`Branch ${t} not found`);return r[0].sr_number}async function l(t){let e=await (0,s.query)(`
    SELECT t.*, i.item_code, i.class_code, i.item_name, i.package_unit, 
           i.quantity_unit, i.tax_type, i.sale_price, i.purchase_price,
           fp.price as current_price
    FROM tanks t
    LEFT JOIN items i ON i.item_name ILIKE '%' || t.fuel_type || '%' AND i.branch_id = t.branch_id
    LEFT JOIN fuel_prices fp ON fp.branch_id = t.branch_id AND fp.fuel_type = t.fuel_type
    WHERE t.id = $1
  `,[t]);return e.length>0?e[0]:null}async function d(t,e,r,n,a){let o=r?.resultCd==="000"||r?.resultCd==="0";return(await (0,s.query)(`
    INSERT INTO stock_movements (
      branch_id, tin, bhf_id, sar_no, org_sar_no, reg_ty_cd, 
      cust_tin, cust_bhf_id, cust_nm, sar_ty_cd, ocrn_dt,
      tot_item_cnt, tot_taxbl_amt, tot_tax_amt, tot_amt, remark,
      regr_id, regr_nm, modr_id, modr_nm,
      kra_status, kra_response, kra_synced_at
    ) VALUES (
      $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11,
      $12, $13, $14, $15, $16, $17, $18, $19, $20,
      $21, $22, $23
    ) RETURNING id
  `,[t,e.tin,e.bhfId,e.sarNo,e.orgSarNo,e.regTyCd,e.custTin,e.custBhfId,e.custNm,e.sarTyCd,e.ocrnDt,e.totItemCnt,e.totTaxblAmt,e.totTaxAmt,e.totAmt,e.remark,e.regrId,e.regrNm,e.modrId,e.modrNm,o?"success":"failed",JSON.stringify(r),o?new Date:null]))[0].id}async function u(t,e,r,n,a,o,i){try{let n=r?.resultCd==="000"||r?.resultCd==="0";await (0,s.query)(`
      INSERT INTO branch_logs (branch_id, log_type, endpoint, request_payload, response_payload, status)
      VALUES ($1, $2, $3, $4, $5, $6)
    `,[o,"kra_stock_sync",t,JSON.stringify(e),JSON.stringify(r),n?"success":"error"])}catch(t){console.error("[KRA Stock Service] Failed to log API call:",t)}}async function m(t,e,r,n){let o=Date.now();try{let m,y=await i(t);if(!y)return{success:!1,kraResponse:null,error:"Branch KRA info not configured (missing KRA PIN)"};let g={tin:y.tin,bhfId:y.bhfId},f=(0,a.buildKraBaseUrl)(y.serverAddress,y.serverPort),h=await c(t),S=_[e]||"06",k=0,b=0,$=0,v=await Promise.all(r.map(async(t,r)=>{let n=await l(t.tankId),s=t.itemCode||n?.item_code||n?.kra_item_cd||`KE1NTXU000000${r+1}`,a=t.itemClassCode||n?.class_code||"5059690800",o=t.itemName||n?.item_name||n?.fuel_type||"Fuel Item",i=t.unitPrice||("stock_receive"===e?n?.purchase_price:n?.current_price)||n?.sale_price||0,c=Math.round(t.quantity*i*100)/100,d=function(t,e="B"){return"B"===e?Math.round(.16*t*100)/100:0}(c,n?.tax_type||"B");return k+=c,b+=d,$+=c,{itemSeq:r+1,itemCd:s,itemClsCd:a,itemNm:o,bcd:null,pkgUnitCd:n?.package_unit||"NT",pkg:Math.ceil(t.quantity),qtyUnitCd:n?.quantity_unit||"U",qty:t.quantity,itemExprDt:null,prc:i,splyAmt:c,totDcAmt:0,taxblAmt:c,taxTyCd:n?.tax_type||"B",taxAmt:d,totAmt:c}})),A={tin:g.tin,bhfId:g.bhfId,sarNo:h,orgSarNo:0,regTyCd:"M",custTin:n?.customerId||null,custNm:n?.customerName||null,custBhfId:n?.customerBhfId||null,sarTyCd:S,ocrnDt:function(t=new Date){let e=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0");return`${e}${r}${n}`}(),totItemCnt:v.length,totTaxblAmt:Math.round(100*k)/100,totTaxAmt:Math.round(100*b)/100,totAmt:Math.round(100*$)/100,remark:n?.remark||null,regrId:"Admin",regrNm:"Admin",modrNm:"Admin",modrId:"Admin",itemList:v};console.log(`[KRA Stock Service] Syncing ${e} to KRA for branch ${t}`),console.log("[KRA Stock Service] Payload:",JSON.stringify(A,null,2));let E=200;try{let t=new AbortController,e=setTimeout(()=>t.abort(),15e3),r=await fetch(`${f}${p}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(A),signal:t.signal});clearTimeout(e),E=r.status,m=await r.json()}catch(t){m="AbortError"===t.name?{resultCd:"TIMEOUT",resultMsg:"Request timed out after 15 seconds",resultDt:new Date().toISOString()}:{resultCd:"NETWORK_ERROR",resultMsg:`Network error: ${t.message}`,resultDt:new Date().toISOString()},E=0}let I=Date.now()-o;console.log(`[KRA Stock Service] Response (${I}ms):`,JSON.stringify(m,null,2)),await u(p,A,m,E,I,t,f);let w=await d(t,A,m,E,I),x=m?.resultCd==="000"||m?.resultCd==="0";if(x)for(let e of(console.log("[KRA Stock Service] saveStockItems successful, now calling saveStockMaster for each item"),r)){let r=Date.now(),n=null,a=0;try{let o=await l(e.tankId),i=await (0,s.query)("SELECT current_stock FROM tanks WHERE id = $1",[e.tankId]),c=i.length>0&&parseFloat(i[0].current_stock)||0,d=e.itemCode||o?.item_code||o?.kra_item_cd;if(!d){console.log(`[KRA Stock Service] Skipping saveStockMaster for tank ${e.tankId} - no item code`);continue}let m={tin:g.tin,bhfId:g.bhfId,itemCd:d,rsdQty:c,regrId:"Admin",regrNm:"Admin",modrNm:"Admin",modrId:"Admin"};console.log("[KRA Stock Service] Calling saveStockMaster:",JSON.stringify(m,null,2));try{let t=new AbortController,e=setTimeout(()=>t.abort(),15e3),r=await fetch(`${f}/stockMaster/saveStockMaster`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(m),signal:t.signal});clearTimeout(e),a=r.status,n=await r.json()}catch(t){n="AbortError"===t.name?{resultCd:"TIMEOUT",resultMsg:"Request timed out after 15 seconds",resultDt:new Date().toISOString()}:{resultCd:"NETWORK_ERROR",resultMsg:`Network error: ${t.message}`,resultDt:new Date().toISOString()}}console.log(`[KRA Stock Service] saveStockMaster response for ${d}:`,JSON.stringify(n,null,2)),await u("/stockMaster/saveStockMaster",m,n,a,Date.now()-r,t,f)}catch(t){console.error(`[KRA Stock Service] Error calling saveStockMaster for tank ${e.tankId}:`,t.message)}}return{success:x,kraResponse:m,movementId:w,error:x?void 0:m?.resultMsg||"KRA sync failed"}}catch(t){return console.error("[KRA Stock Service] Error:",t),{success:!1,kraResponse:null,error:t.message||"Internal error during KRA sync"}}}t.s(["syncStockWithKRA",()=>m]),r()}catch(t){r(t)}},!1)];

//# sourceMappingURL=%5Broot-of-the-server%5D__1b643939._.js.map