module.exports=[68776,e=>e.a(async(t,r)=>{try{var a=e.i(89171),n=e.i(70038),s=e.i(90793),o=e.i(93458),i=t([n,s]);async function u(e){let t=await (0,s.query)(`SELECT v.id FROM users u 
     JOIN vendors v ON v.email = u.email 
     WHERE u.id = $1`,[e]);if(t&&t.length>0)return t[0].id;let r=await (0,s.query)(`SELECT DISTINCT b.vendor_id FROM staff s
     JOIN branches b ON s.branch_id = b.id
     WHERE s.user_id = $1 AND b.vendor_id IS NOT NULL`,[e]);if(r&&r.length>0)return r[0].vendor_id;let a=await (0,s.query)("SELECT DISTINCT vendor_id FROM branches WHERE user_id = $1 AND vendor_id IS NOT NULL",[e]);return a&&a.length>0?a[0].vendor_id:null}async function l(){try{let e=(await (0,o.cookies)()).get("user_session");if(!e?.value)return null;return JSON.parse(e.value).id||null}catch{return null}}async function d(e){let t=await s.pool.connect();try{await t.query("BEGIN");let r=await t.query(`INSERT INTO vendor_po_sequences (vendor_id, next_po_number)
       VALUES ($1, 2)
       ON CONFLICT (vendor_id) 
       DO UPDATE SET next_po_number = vendor_po_sequences.next_po_number + 1
       RETURNING next_po_number - 1 as current_number`,[e]);await t.query("COMMIT");let a=r.rows[0].current_number;return`PO-${String(a).padStart(5,"0")}`}catch(e){throw await t.query("ROLLBACK"),e}finally{t.release()}}async function c(e){try{let t=await l();if(!t)return a.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let r=await u(t);if(!r)return a.NextResponse.json({success:!1,error:"No vendor found for user"},{status:403});let{searchParams:n}=new URL(e.url),o=n.get("branch_id"),i=n.get("status"),d=parseInt(n.get("limit")||"100"),c=`
      SELECT 
        po.*,
        b.name as branch_name,
        vp.name as supplier_name,
        tp.name as transporter_name,
        u.username as created_by_name,
        au.username as approved_by_name,
        (SELECT COUNT(*) FROM purchase_order_items WHERE purchase_order_id = po.id) as item_count,
        (SELECT COALESCE(SUM(total_amount), 0) FROM purchase_order_items WHERE purchase_order_id = po.id) as total_amount
      FROM purchase_orders po
      LEFT JOIN branches b ON po.branch_id = b.id
      LEFT JOIN vendor_partners vp ON po.supplier_id = vp.id
      LEFT JOIN vendor_partners tp ON po.transporter_id = tp.id
      LEFT JOIN users u ON po.created_by = u.id
      LEFT JOIN users au ON po.approved_by = au.id
      WHERE po.vendor_id = $1
    `,p=[r],h=2;o&&(c+=` AND po.branch_id = $${h}`,p.push(o),h++),i&&(c+=` AND po.status = $${h}`,p.push(i),h++),c+=` ORDER BY po.issued_at DESC LIMIT $${h}`,p.push(d);let _=await (0,s.query)(c,p);return a.NextResponse.json({success:!0,data:_})}catch(e){return console.error("Error fetching purchase orders:",e),a.NextResponse.json({success:!1,error:"Failed to fetch purchase orders"},{status:500})}}async function p(e){try{let t=await l();if(!t)return a.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let r=await u(t);if(!r)return a.NextResponse.json({success:!1,error:"No vendor found for user"},{status:403});let{branch_id:n,supplier_id:o,transporter_id:i,expected_delivery:c,notes:p,items:h,transport_cost:_,vehicle_registration:R,driver_name:E,driver_phone:v}=await e.json();if(!n)return a.NextResponse.json({success:!1,error:"Branch is required"},{status:400});if(!o)return a.NextResponse.json({success:!1,error:"Supplier is required"},{status:400});if(!h||0===h.length)return a.NextResponse.json({success:!1,error:"At least one item is required"},{status:400});if(h.filter(e=>!e.unit_price||e.unit_price<=0).length>0)return a.NextResponse.json({success:!1,error:"Unit price is required for all items"},{status:400});let N=await (0,s.query)("SELECT id FROM branches WHERE id = $1 AND vendor_id = $2",[n,r]);if(!N||0===N.length)return a.NextResponse.json({success:!1,error:"Invalid branch"},{status:400});let f=await (0,s.query)("SELECT id FROM vendor_partners WHERE id = $1 AND vendor_id = $2 AND partner_type = 'supplier'",[o,r]);if(!f||0===f.length)return a.NextResponse.json({success:!1,error:"Invalid supplier"},{status:400});if(i){let e=await (0,s.query)("SELECT id FROM vendor_partners WHERE id = $1 AND vendor_id = $2 AND partner_type = 'transporter'",[i,r]);if(!e||0===e.length)return a.NextResponse.json({success:!1,error:"Invalid transporter"},{status:400})}let m=await d(r),y=await s.pool.connect();try{await y.query("BEGIN");let e=(await y.query(`INSERT INTO purchase_orders (
          vendor_id, branch_id, supplier_id, transporter_id, po_number, 
          expected_delivery, notes, created_by, transport_cost,
          vehicle_registration, driver_name, driver_phone, approval_status
        )
         VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, 'pending_approval')
         RETURNING *`,[r,n,o,i||null,m,c||null,p||null,t,_||0,R||null,E||null,v||null])).rows[0];for(let t of h)await y.query(`INSERT INTO purchase_order_items (purchase_order_id, item_id, item_name, quantity, unit_price, total_amount)
           VALUES ($1, $2, $3, $4, $5, $6)`,[e.id,t.item_id||null,t.item_name,t.quantity,t.unit_price||null,t.total_amount||null]);return await y.query("COMMIT"),a.NextResponse.json({success:!0,data:e,message:`Purchase order ${m} created successfully`})}catch(e){throw await y.query("ROLLBACK"),e}finally{y.release()}}catch(e){return console.error("Error creating purchase order:",e),a.NextResponse.json({success:!1,error:"Failed to create purchase order"},{status:500})}}[n,s]=i.then?(await i)():i,e.s(["GET",()=>c,"POST",()=>p]),r()}catch(e){r(e)}},!1),96345,e=>e.a(async(t,r)=>{try{var a=e.i(47909),n=e.i(74017),s=e.i(96250),o=e.i(59756),i=e.i(61916),u=e.i(14444),l=e.i(37092),d=e.i(69741),c=e.i(16795),p=e.i(87718),h=e.i(95169),_=e.i(47587),R=e.i(66012),E=e.i(70101),v=e.i(26937),N=e.i(10372),f=e.i(93695);e.i(52474);var m=e.i(220),y=e.i(68776),w=t([y]);[y]=w.then?(await w)():w;let C=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/headquarters/purchase-orders/route",pathname:"/api/headquarters/purchase-orders",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/headquarters/purchase-orders/route.ts",nextConfigOutput:"standalone",userland:y}),{workAsyncStorage:g,workUnitAsyncStorage:b,serverHooks:x}=C;function O(){return(0,s.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:b})}async function T(e,t,r){C.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let a="/api/headquarters/purchase-orders/route";a=a.replace(/\/index$/,"")||"/";let s=await C.prepare(e,t,{srcPage:a,multiZoneDraftMode:!1});if(!s)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:y,params:w,nextConfig:O,parsedUrl:T,isDraftMode:g,prerenderManifest:b,routerServerContext:x,isOnDemandRevalidate:S,revalidateOnlyGenerated:I,resolvedPathname:A,clientReferenceManifest:$,serverActionsManifest:q}=s,L=(0,d.normalizeAppPath)(a),M=!!(b.dynamicRoutes[L]||b.routes[A]),U=async()=>((null==x?void 0:x.render404)?await x.render404(e,t,T,!1):t.end("This page could not be found"),null);if(M&&!g){let e=!!b.routes[A],t=b.dynamicRoutes[L];if(t&&!1===t.fallback&&!e){if(O.experimental.adapterPath)return await U();throw new f.NoFallbackError}}let D=null;!M||C.isDev||g||(D=A,D="/index"===D?"/":D);let P=!0===C.isDev||!M,H=M&&!P;q&&$&&(0,u.setReferenceManifestsSingleton)({page:a,clientReferenceManifest:$,serverActionsManifest:q,serverModuleMap:(0,l.createServerModuleMap)({serverActionsManifest:q})});let F=e.method||"GET",j=(0,i.getTracer)(),k=j.getActiveScopeSpan(),B={params:w,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!O.experimental.authInterrupts},cacheComponents:!!O.cacheComponents,supportsDynamicResponse:P,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:O.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>C.onRequestError(e,t,a,x)},sharedContext:{buildId:y}},W=new c.NodeNextRequest(e),K=new c.NodeNextResponse(t),G=p.NextRequestAdapter.fromNodeNextRequest(W,(0,p.signalFromNodeResponse)(t));try{let s=async e=>C.handle(G,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=j.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==h.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${F} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${F} ${a}`)}),u=!!(0,o.getRequestMeta)(e,"minimalMode"),l=async o=>{var i,l;let d=async({previousCacheEntry:n})=>{try{if(!u&&S&&I&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await s(o);e.fetchMetrics=B.renderOpts.fetchMetrics;let i=B.renderOpts.pendingWaitUntil;i&&r.waitUntil&&(r.waitUntil(i),i=void 0);let l=B.renderOpts.collectedTags;if(!M)return await (0,R.sendResponse)(W,K,a,B.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,E.toNodeOutgoingHttpHeaders)(a.headers);l&&(t[N.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=N.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,n=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=N.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:m.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==n?void 0:n.isStale)&&await C.onRequestError(e,t,{routerKind:"App Router",routePath:a,routeType:"route",revalidateReason:(0,_.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:S})},x),t}},c=await C.handleResponse({req:e,nextConfig:O,cacheKey:D,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:S,revalidateOnlyGenerated:I,responseGenerator:d,waitUntil:r.waitUntil,isMinimalMode:u});if(!M)return null;if((null==c||null==(i=c.value)?void 0:i.kind)!==m.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});u||t.setHeader("x-nextjs-cache",S?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),g&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,E.fromNodeOutgoingHttpHeaders)(c.value.headers);return u&&M||p.delete(N.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,v.getCacheControlHeader)(c.cacheControl)),await (0,R.sendResponse)(W,K,new Response(c.value.body,{headers:p,status:c.value.status||200})),null};k?await l(k):await j.withPropagatedContext(e.headers,()=>j.trace(h.BaseServerSpan.handleRequest,{spanName:`${F} ${a}`,kind:i.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},l))}catch(t){if(t instanceof f.NoFallbackError||await C.onRequestError(e,t,{routerKind:"App Router",routePath:L,routeType:"route",revalidateReason:(0,_.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:S})}),M)throw t;return await (0,R.sendResponse)(W,K,new Response(null,{status:500})),null}}e.s(["handler",()=>T,"patchFetch",()=>O,"routeModule",()=>C,"serverHooks",()=>x,"workAsyncStorage",()=>g,"workUnitAsyncStorage",()=>b]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=_764198c9._.js.map