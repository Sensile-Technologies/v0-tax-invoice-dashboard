module.exports=[87690,e=>e.a(async(t,a)=>{try{var r=e.i(89171),s=e.i(70038),n=e.i(90793),i=e.i(39298),o=t([s,n,i]);async function l(e){try{let{searchParams:t}=new URL(e.url),a=t.get("branch_id"),s=t.get("shift_id"),i=t.get("nozzle_id"),o=t.get("date"),l=t.get("date_from"),u=t.get("date_to"),d=parseInt(t.get("page")||"1"),c=parseInt(t.get("limit")||"20"),p="true"===t.get("export"),_="WHERE 1=1",h=[],R=1;a&&(_+=` AND branch_id = $${R}`,h.push(a),R++),s&&(_+=` AND shift_id = $${R}`,h.push(s),R++),i&&(_+=` AND nozzle_id = $${R}`,h.push(i),R++),o&&(_+=` AND DATE(sale_date) = $${R}`,h.push(o),R++),l&&(_+=` AND DATE(sale_date) >= $${R}`,h.push(l),R++),u&&(_+=` AND DATE(sale_date) <= $${R}`,h.push(u),R++);let E=t.get("is_automated");"true"===E?_+=" AND is_automated = true":"false"===E&&(_+=" AND (is_automated = false OR is_automated IS NULL)");let m=t.get("transmission_status");m&&"all"!==m&&(_+=` AND transmission_status = $${R}`,h.push(m),R++);let $=t.get("start_date"),f=t.get("end_date");$&&(_+=` AND DATE(sale_date) >= $${R}`,h.push($),R++),f&&(_+=` AND DATE(sale_date) <= $${R}`,h.push(f),R++);let g=await (0,n.query)(`SELECT COUNT(*) as count FROM sales ${_}`,h),y=parseInt(g[0]?.count||"0"),N=`SELECT * FROM sales ${_} ORDER BY sale_date DESC`;if(!p){let e=(d-1)*c;N+=` LIMIT $${R} OFFSET $${R+1}`,h.push(c,e)}let v=await (0,n.query)(N,h);return r.NextResponse.json({success:!0,sales:v,data:v,totalCount:y,page:d,limit:c,totalPages:Math.ceil(y/c)})}catch(e){return console.error("Error fetching sales:",e),r.NextResponse.json({error:"Failed to fetch sales",details:e.message},{status:500})}}async function u(e){try{let{branch_id:t,shift_id:a,nozzle_id:s,fuel_type:o,quantity:l,unit_price:u,total_amount:d,payment_method:c,customer_name:p,vehicle_number:_,customer_pin:h,invoice_number:R,meter_reading_after:E,transmission_status:m,receipt_number:$,is_loyalty_sale:f,loyalty_customer_name:g,loyalty_customer_pin:y,staff_id:N,sync_to_kra:v=!0,deduct_from_tank:A=!0}=await e.json();if(!t||!s||!o)return r.NextResponse.json({error:"Missing required fields"},{status:400});let w=(await (0,n.query)(`INSERT INTO sales (
        branch_id, shift_id, nozzle_id, fuel_type, quantity, unit_price, 
        total_amount, payment_method, customer_name, vehicle_number, customer_pin,
        invoice_number, meter_reading_after, transmission_status, receipt_number,
        is_loyalty_sale, loyalty_customer_name, loyalty_customer_pin, staff_id, sale_date, created_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, NOW(), NOW())
      RETURNING *`,[t,a,s,o,l,u,d,c,p,_,h,R,E,m||"pending",$,f||!1,g,y,N||null]))[0],T=null,k=null;if(l&&l>0){let e=await (0,n.query)("SELECT * FROM tanks WHERE branch_id = $1 AND fuel_type ILIKE $2 AND status = 'active' ORDER BY current_stock DESC LIMIT 1",[t,`%${o}%`]);if(e.length>0){let a=e[0];if(!a.kra_item_cd)return r.NextResponse.json({error:`Tank "${a.tank_name}" is not mapped to an item. Please map the tank to an item in the item list before selling.`},{status:400});let s=a.current_stock||0,_=Math.max(0,s-l);if(A&&(await (0,n.query)("UPDATE tanks SET current_stock = $1, updated_at = NOW() WHERE id = $2",[_,a.id]),k={tankId:a.id,tankName:a.tank_name,previousStock:s,newStock:_,quantityDeducted:l}),v){console.log(`[Sales API] Syncing sale of ${l} ${o} to KRA for branch ${t}`);let e=f&&y?y:h||"",r=f&&g?g:p||"Walk-in Customer";if(T=await (0,i.callKraSaveSales)({branch_id:t,invoice_number:R||`INV-${Date.now().toString(36).toUpperCase()}`,receipt_number:$||`RCP-${Date.now().toString(36).toUpperCase()}`,fuel_type:o,quantity:l,unit_price:u||0,total_amount:d||l*(u||0),payment_method:c||"cash",customer_name:r,customer_pin:e,sale_date:new Date().toISOString(),tank_id:a.id}),await (0,n.query)("UPDATE tanks SET kra_sync_status = $1 WHERE id = $2",[T.success?"synced":"failed",a.id]),T.success&&T.kraResponse?.data){let e=T.kraResponse.data;await (0,n.query)(`UPDATE sales SET 
                kra_status = 'success',
                kra_rcpt_sign = $1,
                kra_scu_id = $2,
                kra_cu_inv = $3,
                kra_internal_data = $4,
                transmission_status = 'transmitted'
              WHERE id = $5`,[e.rcptSign||"",e.sdcId||"",`${e.sdcId}/${e.rcptNo}`,e.intrlData||"",w.id]),w.kra_status="success",w.kra_rcpt_sign=e.rcptSign,w.kra_scu_id=e.sdcId,w.kra_cu_inv=`${e.sdcId}/${e.rcptNo}`,w.kra_internal_data=e.intrlData}else T.success||(await (0,n.query)("UPDATE sales SET kra_status = 'failed', kra_error = $1 WHERE id = $2",[T.error||"Unknown error",w.id]),w.kra_status="failed")}}}return r.NextResponse.json({success:!0,data:w,tankUpdate:k,kraSync:T?{synced:T.success,kraResponse:T.kraResponse,error:T.error}:null})}catch(e){return console.error("Error creating sale:",e),r.NextResponse.json({error:"Failed to create sale",details:e.message},{status:500})}}[s,n,i]=o.then?(await o)():o,e.s(["GET",()=>l,"POST",()=>u]),a()}catch(e){a(e)}},!1),62352,e=>e.a(async(t,a)=>{try{var r=e.i(47909),s=e.i(74017),n=e.i(96250),i=e.i(59756),o=e.i(61916),l=e.i(14444),u=e.i(37092),d=e.i(69741),c=e.i(16795),p=e.i(87718),_=e.i(95169),h=e.i(47587),R=e.i(66012),E=e.i(70101),m=e.i(26937),$=e.i(10372),f=e.i(93695);e.i(52474);var g=e.i(220),y=e.i(87690),N=t([y]);[y]=N.then?(await N)():N;let w=new r.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/sales/route",pathname:"/api/sales",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/sales/route.ts",nextConfigOutput:"standalone",userland:y}),{workAsyncStorage:T,workUnitAsyncStorage:k,serverHooks:C}=w;function v(){return(0,n.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:k})}async function A(e,t,a){w.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/sales/route";r=r.replace(/\/index$/,"")||"/";let n=await w.prepare(e,t,{srcPage:r,multiZoneDraftMode:!1});if(!n)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:y,params:N,nextConfig:v,parsedUrl:A,isDraftMode:T,prerenderManifest:k,routerServerContext:C,isOnDemandRevalidate:D,revalidateOnlyGenerated:S,resolvedPathname:x,clientReferenceManifest:I,serverActionsManifest:O}=n,b=(0,d.normalizeAppPath)(r),P=!!(k.dynamicRoutes[b]||k.routes[x]),U=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,A,!1):t.end("This page could not be found"),null);if(P&&!T){let e=!!k.routes[x],t=k.dynamicRoutes[b];if(t&&!1===t.fallback&&!e){if(v.experimental.adapterPath)return await U();throw new f.NoFallbackError}}let q=null;!P||w.isDev||T||(q=x,q="/index"===q?"/":q);let M=!0===w.isDev||!P,H=P&&!M;O&&I&&(0,l.setReferenceManifestsSingleton)({page:r,clientReferenceManifest:I,serverActionsManifest:O,serverModuleMap:(0,u.createServerModuleMap)({serverActionsManifest:O})});let F=e.method||"GET",L=(0,o.getTracer)(),j=L.getActiveScopeSpan(),W={params:N,prerenderManifest:k,renderOpts:{experimental:{authInterrupts:!!v.experimental.authInterrupts},cacheComponents:!!v.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:v.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>w.onRequestError(e,t,r,C)},sharedContext:{buildId:y}},K=new c.NodeNextRequest(e),z=new c.NodeNextResponse(t),B=p.NextRequestAdapter.fromNodeNextRequest(K,(0,p.signalFromNodeResponse)(t));try{let n=async e=>w.handle(B,W).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=L.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==_.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=a.get("next.route");if(s){let t=`${F} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${F} ${r}`)}),l=!!(0,i.getRequestMeta)(e,"minimalMode"),u=async i=>{var o,u;let d=async({previousCacheEntry:s})=>{try{if(!l&&D&&S&&!s)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await n(i);e.fetchMetrics=W.renderOpts.fetchMetrics;let o=W.renderOpts.pendingWaitUntil;o&&a.waitUntil&&(a.waitUntil(o),o=void 0);let u=W.renderOpts.collectedTags;if(!P)return await (0,R.sendResponse)(K,z,r,W.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,E.toNodeOutgoingHttpHeaders)(r.headers);u&&(t[$.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==W.renderOpts.collectedRevalidate&&!(W.renderOpts.collectedRevalidate>=$.INFINITE_CACHE)&&W.renderOpts.collectedRevalidate,s=void 0===W.renderOpts.collectedExpire||W.renderOpts.collectedExpire>=$.INFINITE_CACHE?void 0:W.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:s}}}}catch(t){throw(null==s?void 0:s.isStale)&&await w.onRequestError(e,t,{routerKind:"App Router",routePath:r,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:D})},C),t}},c=await w.handleResponse({req:e,nextConfig:v,cacheKey:q,routeKind:s.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:k,isRoutePPREnabled:!1,isOnDemandRevalidate:D,revalidateOnlyGenerated:S,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:l});if(!P)return null;if((null==c||null==(o=c.value)?void 0:o.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(u=c.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",D?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),T&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,E.fromNodeOutgoingHttpHeaders)(c.value.headers);return l&&P||p.delete($.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,m.getCacheControlHeader)(c.cacheControl)),await (0,R.sendResponse)(K,z,new Response(c.value.body,{headers:p,status:c.value.status||200})),null};j?await u(j):await L.withPropagatedContext(e.headers,()=>L.trace(_.BaseServerSpan.handleRequest,{spanName:`${F} ${r}`,kind:o.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},u))}catch(t){if(t instanceof f.NoFallbackError||await w.onRequestError(e,t,{routerKind:"App Router",routePath:b,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:D})}),P)throw t;return await (0,R.sendResponse)(K,z,new Response(null,{status:500})),null}}e.s(["handler",()=>A,"patchFetch",()=>v,"routeModule",()=>w,"serverHooks",()=>C,"workAsyncStorage",()=>T,"workUnitAsyncStorage",()=>k]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=_3594b056._.js.map