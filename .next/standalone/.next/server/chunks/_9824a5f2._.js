module.exports=[54124,e=>e.a(async(t,r)=>{try{var s=e.i(89171),n=e.i(30056),a=e.i(93458),i=t([n]);[n]=i.then?(await i)():i;let p=new n.Pool({connectionString:process.env.DATABASE_URL});async function o(){let e=(await (0,a.cookies)()).get("user_session");if(!e)return null;try{return JSON.parse(e.value)}catch{return null}}async function u(e){try{let t=await o();if(!t)return s.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let{searchParams:r}=new URL(e.url),n=r.get("branchId");if(!n)return s.NextResponse.json({success:!1,error:"Branch ID required"},{status:400});let a=await p.connect();try{let e=await a.query(`SELECT u.id, COALESCE(s.role, u.role) as role, v.id as vendor_id, s.branch_id
         FROM users u
         LEFT JOIN vendors v ON v.email = u.email
         LEFT JOIN staff s ON s.user_id = u.id
         WHERE u.id = $1`,[t.id]);if(0===e.rows.length)return s.NextResponse.json({success:!1,error:"User not found"},{status:404});let r=e.rows[0],i=r.vendor_id||(await a.query("SELECT vendor_id FROM branches b JOIN staff s ON s.branch_id = b.id WHERE s.user_id = $1 LIMIT 1",[t.id])).rows[0]?.vendor_id,o=await a.query("SELECT id, vendor_id FROM branches WHERE id = $1",[n]);if(0===o.rows.length)return s.NextResponse.json({success:!1,error:"Branch not found"},{status:404});let u=o.rows[0];if(u.vendor_id!==i)return s.NextResponse.json({success:!1,error:"Access denied"},{status:403});if(["supervisor","manager"].includes(r.role)&&r.branch_id!==n)return s.NextResponse.json({success:!1,error:"Access denied to this branch"},{status:403});let d=await a.query(`SELECT 
          i.id as item_id,
          i.item_code,
          i.item_name,
          i.item_type,
          i.class_code,
          i.tax_type,
          i.origin,
          i.quantity_unit,
          i.package_unit,
          i.status as item_status,
          bi.id as branch_item_id,
          bi.sale_price as branch_sale_price,
          bi.purchase_price as branch_purchase_price,
          bi.is_available,
          bi.kra_status,
          bi.kra_last_synced_at,
          CASE WHEN bi.id IS NOT NULL THEN true ELSE false END as is_assigned
        FROM items i
        LEFT JOIN branch_items bi ON i.id = bi.item_id AND bi.branch_id = $1
        WHERE i.status = 'active' 
          AND (
            (i.vendor_id = $2 AND i.branch_id IS NULL)
            OR i.branch_id = $1
          )
        ORDER BY i.item_name`,[n,u.vendor_id]);return s.NextResponse.json({success:!0,items:d.rows})}finally{a.release()}}catch(e){return console.error("Error fetching branch items:",e),s.NextResponse.json({success:!1,error:"Failed to fetch items"},{status:500})}}async function d(e){let t=await p.connect();try{let r=await o();if(!r)return s.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let{branchId:n,itemId:a,salePrice:i,purchasePrice:u}=await e.json();if(!n||!a||void 0===i)return s.NextResponse.json({success:!1,error:"Missing required fields"},{status:400});let d=await t.query(`SELECT u.id, COALESCE(s.role, u.role) as role, v.id as vendor_id, s.branch_id
       FROM users u
       LEFT JOIN vendors v ON v.email = u.email
       LEFT JOIN staff s ON s.user_id = u.id
       WHERE u.id = $1`,[r.id]);if(0===d.rows.length)return s.NextResponse.json({success:!1,error:"User not found"},{status:404});let c=d.rows[0],l=c.vendor_id||(await t.query("SELECT vendor_id FROM branches b JOIN staff s ON s.branch_id = b.id WHERE s.user_id = $1 LIMIT 1",[r.id])).rows[0]?.vendor_id,p=await t.query("SELECT id, vendor_id FROM branches WHERE id = $1",[n]);if(0===p.rows.length)return s.NextResponse.json({success:!1,error:"Branch not found"},{status:404});if(p.rows[0].vendor_id!==l)return s.NextResponse.json({success:!1,error:"Access denied"},{status:403});if(["supervisor","manager"].includes(c.role)&&c.branch_id!==n)return s.NextResponse.json({success:!1,error:"Access denied to this branch"},{status:403});let h=await t.query("SELECT id, vendor_id, branch_id FROM items WHERE id = $1",[a]);if(0===h.rows.length)return s.NextResponse.json({success:!1,error:"Item not found"},{status:404});let E=h.rows[0];if(E.vendor_id!==l&&E.branch_id!==n)return s.NextResponse.json({success:!1,error:"Item not found"},{status:404});let R=await t.query(`INSERT INTO branch_items (branch_id, item_id, sale_price, purchase_price, is_available)
       VALUES ($1, $2, $3, $4, true)
       ON CONFLICT (branch_id, item_id) 
       DO UPDATE SET sale_price = $3, purchase_price = $4, updated_at = NOW()
       RETURNING *`,[n,a,i,u||null]);return s.NextResponse.json({success:!0,branchItem:R.rows[0],message:"Item price assigned to branch"})}catch(e){return console.error("Error assigning branch item:",e),s.NextResponse.json({success:!1,error:"Failed to assign item"},{status:500})}finally{t.release()}}async function c(e){let t=await p.connect();try{let r=await o();if(!r)return s.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let{branchItemId:n,salePrice:a,purchasePrice:i,isAvailable:u}=await e.json();if(!n)return s.NextResponse.json({success:!1,error:"Branch item ID required"},{status:400});let d=await t.query(`SELECT u.id, COALESCE(s.role, u.role) as role, v.id as vendor_id, s.branch_id
       FROM users u
       LEFT JOIN vendors v ON v.email = u.email
       LEFT JOIN staff s ON s.user_id = u.id
       WHERE u.id = $1`,[r.id]);if(0===d.rows.length)return s.NextResponse.json({success:!1,error:"User not found"},{status:404});let c=d.rows[0],l=c.vendor_id||(await t.query("SELECT vendor_id FROM branches b JOIN staff s ON s.branch_id = b.id WHERE s.user_id = $1 LIMIT 1",[r.id])).rows[0]?.vendor_id,p=await t.query(`SELECT bi.*, b.vendor_id 
       FROM branch_items bi 
       JOIN branches b ON bi.branch_id = b.id 
       WHERE bi.id = $1`,[n]);if(0===p.rows.length)return s.NextResponse.json({success:!1,error:"Branch item not found"},{status:404});let h=p.rows[0];if(h.vendor_id!==l)return s.NextResponse.json({success:!1,error:"Access denied"},{status:403});if(["supervisor","manager"].includes(c.role)&&c.branch_id!==h.branch_id)return s.NextResponse.json({success:!1,error:"Access denied to this branch"},{status:403});let E=await t.query(`UPDATE branch_items SET
        sale_price = COALESCE($1, sale_price),
        purchase_price = COALESCE($2, purchase_price),
        is_available = COALESCE($3, is_available),
        updated_at = NOW()
      WHERE id = $4
      RETURNING *`,[a,i,u,n]);return s.NextResponse.json({success:!0,branchItem:E.rows[0]})}catch(e){return console.error("Error updating branch item:",e),s.NextResponse.json({success:!1,error:"Failed to update item"},{status:500})}finally{t.release()}}async function l(e){let t=await p.connect();try{let r=await o();if(!r)return s.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let{searchParams:n}=new URL(e.url),a=n.get("id");if(!a)return s.NextResponse.json({success:!1,error:"Branch item ID required"},{status:400});let i=await t.query(`SELECT u.id, COALESCE(s.role, u.role) as role, v.id as vendor_id, s.branch_id
       FROM users u
       LEFT JOIN vendors v ON v.email = u.email
       LEFT JOIN staff s ON s.user_id = u.id
       WHERE u.id = $1`,[r.id]);if(0===i.rows.length)return s.NextResponse.json({success:!1,error:"User not found"},{status:404});let u=i.rows[0].vendor_id||(await t.query("SELECT vendor_id FROM branches b JOIN staff s ON s.branch_id = b.id WHERE s.user_id = $1 LIMIT 1",[r.id])).rows[0]?.vendor_id,d=await t.query(`SELECT bi.*, b.vendor_id 
       FROM branch_items bi 
       JOIN branches b ON bi.branch_id = b.id 
       WHERE bi.id = $1`,[a]);if(0===d.rows.length)return s.NextResponse.json({success:!1,error:"Branch item not found"},{status:404});if(d.rows[0].vendor_id!==u)return s.NextResponse.json({success:!1,error:"Access denied"},{status:403});return await t.query("DELETE FROM branch_items WHERE id = $1",[a]),s.NextResponse.json({success:!0,message:"Item removed from branch"})}catch(e){return console.error("Error removing branch item:",e),s.NextResponse.json({success:!1,error:"Failed to remove item"},{status:500})}finally{t.release()}}e.s(["DELETE",()=>l,"GET",()=>u,"POST",()=>d,"PUT",()=>c]),r()}catch(e){r(e)}},!1),98e3,e=>e.a(async(t,r)=>{try{var s=e.i(47909),n=e.i(74017),a=e.i(96250),i=e.i(59756),o=e.i(61916),u=e.i(14444),d=e.i(37092),c=e.i(69741),l=e.i(16795),p=e.i(87718),h=e.i(95169),E=e.i(47587),R=e.i(66012),_=e.i(70101),b=e.i(26937),f=e.i(10372),N=e.i(93695);e.i(52474);var v=e.i(220),m=e.i(54124),w=t([m]);[m]=w.then?(await w)():w;let g=new s.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/branch-items/route",pathname:"/api/branch-items",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/branch-items/route.ts",nextConfigOutput:"standalone",userland:m}),{workAsyncStorage:y,workUnitAsyncStorage:C,serverHooks:x}=g;function O(){return(0,a.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:C})}async function T(e,t,r){g.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let s="/api/branch-items/route";s=s.replace(/\/index$/,"")||"/";let a=await g.prepare(e,t,{srcPage:s,multiZoneDraftMode:!1});if(!a)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:m,params:w,nextConfig:O,parsedUrl:T,isDraftMode:y,prerenderManifest:C,routerServerContext:x,isOnDemandRevalidate:I,revalidateOnlyGenerated:A,resolvedPathname:S,clientReferenceManifest:L,serverActionsManifest:j}=a,F=(0,c.normalizeAppPath)(s),q=!!(C.dynamicRoutes[F]||C.routes[S]),M=async()=>((null==x?void 0:x.render404)?await x.render404(e,t,T,!1):t.end("This page could not be found"),null);if(q&&!y){let e=!!C.routes[S],t=C.dynamicRoutes[F];if(t&&!1===t.fallback&&!e){if(O.experimental.adapterPath)return await M();throw new N.NoFallbackError}}let $=null;!q||g.isDev||y||($=S,$="/index"===$?"/":$);let H=!0===g.isDev||!q,U=q&&!H;j&&L&&(0,u.setReferenceManifestsSingleton)({page:s,clientReferenceManifest:L,serverActionsManifest:j,serverModuleMap:(0,d.createServerModuleMap)({serverActionsManifest:j})});let P=e.method||"GET",D=(0,o.getTracer)(),W=D.getActiveScopeSpan(),k={params:w,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!O.experimental.authInterrupts},cacheComponents:!!O.cacheComponents,supportsDynamicResponse:H,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:O.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,s)=>g.onRequestError(e,t,s,x)},sharedContext:{buildId:m}},J=new l.NodeNextRequest(e),B=new l.NodeNextResponse(t),K=p.NextRequestAdapter.fromNodeNextRequest(J,(0,p.signalFromNodeResponse)(t));try{let a=async e=>g.handle(K,k).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=D.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==h.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${P} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${P} ${s}`)}),u=!!(0,i.getRequestMeta)(e,"minimalMode"),d=async i=>{var o,d;let c=async({previousCacheEntry:n})=>{try{if(!u&&I&&A&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await a(i);e.fetchMetrics=k.renderOpts.fetchMetrics;let o=k.renderOpts.pendingWaitUntil;o&&r.waitUntil&&(r.waitUntil(o),o=void 0);let d=k.renderOpts.collectedTags;if(!q)return await (0,R.sendResponse)(J,B,s,k.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,_.toNodeOutgoingHttpHeaders)(s.headers);d&&(t[f.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==k.renderOpts.collectedRevalidate&&!(k.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&k.renderOpts.collectedRevalidate,n=void 0===k.renderOpts.collectedExpire||k.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:k.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==n?void 0:n.isStale)&&await g.onRequestError(e,t,{routerKind:"App Router",routePath:s,routeType:"route",revalidateReason:(0,E.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:I})},x),t}},l=await g.handleResponse({req:e,nextConfig:O,cacheKey:$,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:I,revalidateOnlyGenerated:A,responseGenerator:c,waitUntil:r.waitUntil,isMinimalMode:u});if(!q)return null;if((null==l||null==(o=l.value)?void 0:o.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(d=l.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});u||t.setHeader("x-nextjs-cache",I?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),y&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,_.fromNodeOutgoingHttpHeaders)(l.value.headers);return u&&q||p.delete(f.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,b.getCacheControlHeader)(l.cacheControl)),await (0,R.sendResponse)(J,B,new Response(l.value.body,{headers:p,status:l.value.status||200})),null};W?await d(W):await D.withPropagatedContext(e.headers,()=>D.trace(h.BaseServerSpan.handleRequest,{spanName:`${P} ${s}`,kind:o.SpanKind.SERVER,attributes:{"http.method":P,"http.target":e.url}},d))}catch(t){if(t instanceof N.NoFallbackError||await g.onRequestError(e,t,{routerKind:"App Router",routePath:F,routeType:"route",revalidateReason:(0,E.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:I})}),q)throw t;return await (0,R.sendResponse)(J,B,new Response(null,{status:500})),null}}e.s(["handler",()=>T,"patchFetch",()=>O,"routeModule",()=>g,"serverHooks",()=>x,"workAsyncStorage",()=>y,"workUnitAsyncStorage",()=>C]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=_9824a5f2._.js.map