{"version":3,"sources":["../../../lib/kra-stock-sync.ts","../../../lib/kra-sales-api.ts"],"sourcesContent":["import { query } from \"@/lib/db\"\nimport { logApiCall } from \"@/lib/api-logger\"\nimport { buildKraBaseUrl } from \"@/lib/kra-url-helper\"\n\nconst DEFAULT_KRA_URL = process.env.KRA_VSCU_URL || \"http://5.189.171.160:8088\"\n\ninterface BranchKraConfig {\n  tin: string\n  bhfId: string\n  serverAddress: string\n  serverPort: string\n}\n\nasync function getBranchKraConfig(branchId: string): Promise<BranchKraConfig | null> {\n  const result = await query(`\n    SELECT b.kra_pin as tin, b.bhf_id, \n           COALESCE(b.server_address, '5.189.171.160') as server_address, \n           COALESCE(b.server_port, '8088') as server_port\n    FROM branches b\n    WHERE b.id = $1\n  `, [branchId])\n  \n  if (result.length === 0 || !result[0].tin) return null\n  return { \n    tin: result[0].tin, \n    bhfId: result[0].bhf_id || \"00\",\n    serverAddress: result[0].server_address,\n    serverPort: result[0].server_port\n  }\n}\n\ninterface StockSyncItem {\n  itemCode: string\n  itemClassCode: string\n  itemName: string\n  packageUnit: string\n  quantityUnit: string\n  quantity: number\n  unitPrice: number\n  taxType: string\n}\n\ninterface StockSyncResult {\n  success: boolean\n  saveStockItemsResponse?: any\n  saveStockMasterResponses?: any[]\n  error?: string\n}\n\nasync function getBranchKraInfo(branchId: string): Promise<{ tin: string, bhfId: string } | null> {\n  const result = await query(`\n    SELECT kra_pin as tin, bhf_id \n    FROM branches \n    WHERE id = $1\n  `, [branchId])\n  \n  if (result.length === 0 || !result[0].tin) return null\n  return { tin: result[0].tin, bhfId: result[0].bhf_id || \"00\" }\n}\n\nasync function getNextSarNo(branchId: string): Promise<number> {\n  const result = await query(`\n    UPDATE branches \n    SET sr_number = COALESCE(sr_number, 0) + 1,\n        updated_at = NOW()\n    WHERE id = $1\n    RETURNING sr_number\n  `, [branchId])\n  \n  if (result.length === 0) {\n    throw new Error(`Branch ${branchId} not found`)\n  }\n  \n  return result[0].sr_number\n}\n\nfunction formatKraDate(date: Date = new Date()): string {\n  const year = date.getFullYear()\n  const month = String(date.getMonth() + 1).padStart(2, '0')\n  const day = String(date.getDate()).padStart(2, '0')\n  return `${year}${month}${day}`\n}\n\nfunction toFixed2(num: number): string {\n  return (Math.round(num * 100) / 100).toFixed(2)\n}\n\nfunction calculateTaxAmount(amount: number, taxType: string = \"B\"): number {\n  if (taxType === \"B\") {\n    return Math.round(amount * 0.16 * 100) / 100\n  } else if (taxType === \"A\") {\n    return Math.round((amount / 1.16) * 0.16 * 100) / 100\n  } else if (taxType === \"C\") {\n    return Math.round(amount * 0.08 * 100) / 100\n  }\n  return 0\n}\n\nasync function callSaveStockItems(\n  branchId: string,\n  sarTyCd: string,\n  items: StockSyncItem[]\n): Promise<{ success: boolean; response: any; sarNo: number }> {\n  const startTime = Date.now()\n  \n  const kraConfig = await getBranchKraConfig(branchId)\n  if (!kraConfig) {\n    return { \n      success: false, \n      response: { resultCd: \"CONFIG_ERROR\", resultMsg: \"Branch KRA info not configured\" },\n      sarNo: 0 \n    }\n  }\n  \n  const kraInfo = { tin: kraConfig.tin, bhfId: kraConfig.bhfId }\n  const kraBaseUrl = buildKraBaseUrl(kraConfig.serverAddress, kraConfig.serverPort)\n  \n  const sarNo = await getNextSarNo(branchId)\n  \n  let totTaxblAmt = 0\n  let totTaxAmt = 0\n  let totAmt = 0\n  \n  const itemList = items.map((item, index) => {\n    const splyAmt = Math.round(item.quantity * item.unitPrice * 100) / 100\n    const taxAmt = calculateTaxAmount(splyAmt, item.taxType)\n    \n    totTaxblAmt += splyAmt\n    totTaxAmt += taxAmt\n    totAmt += splyAmt\n    \n    return {\n      itemSeq: index + 1,\n      itemCd: item.itemCode,\n      itemClsCd: item.itemClassCode || \"15100000\",\n      itemNm: item.itemName,\n      bcd: null,\n      pkgUnitCd: item.packageUnit || \"NT\",\n      pkg: Math.ceil(item.quantity),\n      qtyUnitCd: item.quantityUnit || \"LTR\",\n      qty: parseFloat(item.quantity.toFixed(2)),\n      itemExprDt: null,\n      prc: item.unitPrice,\n      splyAmt: toFixed2(splyAmt),\n      totDcAmt: 0,\n      taxblAmt: toFixed2(splyAmt),\n      taxTyCd: item.taxType || \"B\",\n      taxAmt: toFixed2(taxAmt),\n      totAmt: toFixed2(splyAmt)\n    }\n  })\n  \n  const payload = {\n    tin: kraInfo.tin,\n    bhfId: kraInfo.bhfId,\n    sarNo,\n    orgSarNo: 0,\n    regTyCd: \"M\",\n    custTin: null,\n    custNm: null,\n    custBhfId: null,\n    sarTyCd,\n    ocrnDt: formatKraDate(),\n    totItemCnt: itemList.length,\n    totTaxblAmt: toFixed2(totTaxblAmt),\n    totTaxAmt: toFixed2(totTaxAmt),\n    totAmt: toFixed2(totAmt),\n    remark: null,\n    regrId: \"Admin\",\n    regrNm: \"Admin\",\n    modrNm: \"Admin\",\n    modrId: \"Admin\",\n    itemList\n  }\n  \n  console.log(`[KRA Stock Sync] Calling saveStockItems with sarTyCd=${sarTyCd}`)\n  console.log(`[KRA Stock Sync] Payload:`, JSON.stringify(payload, null, 2))\n  \n  let response: any\n  let httpStatus = 200\n  \n  try {\n    const controller = new AbortController()\n    const timeoutId = setTimeout(() => controller.abort(), 15000)\n    \n    const res = await fetch(`${kraBaseUrl}/stock/saveStockItems`, {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify(payload),\n      signal: controller.signal\n    })\n    \n    clearTimeout(timeoutId)\n    httpStatus = res.status\n    response = await res.json()\n  } catch (fetchError: any) {\n    response = {\n      resultCd: fetchError.name === 'AbortError' ? \"TIMEOUT\" : \"NETWORK_ERROR\",\n      resultMsg: fetchError.message || \"Failed to connect to KRA\",\n      resultDt: new Date().toISOString()\n    }\n    httpStatus = 0\n  }\n  \n  const duration = Date.now() - startTime\n  console.log(`[KRA Stock Sync] saveStockItems response (${duration}ms):`, JSON.stringify(response, null, 2))\n  \n  await logApiCall({\n    endpoint: \"/stock/saveStockItems\",\n    method: \"POST\",\n    payload,\n    response,\n    statusCode: httpStatus,\n    durationMs: duration,\n    branchId,\n    externalEndpoint: `${kraBaseUrl}/stock/saveStockItems`\n  })\n  \n  const isSuccess = response?.resultCd === \"000\" || response?.resultCd === \"0\"\n  return { success: isSuccess, response, sarNo }\n}\n\nasync function callSaveStockMaster(\n  branchId: string,\n  itemCode: string\n): Promise<{ success: boolean; response: any }> {\n  const startTime = Date.now()\n  \n  const kraConfig = await getBranchKraConfig(branchId)\n  if (!kraConfig) {\n    return { \n      success: false, \n      response: { resultCd: \"CONFIG_ERROR\", resultMsg: \"Branch KRA info not configured\" }\n    }\n  }\n  \n  const kraInfo = { tin: kraConfig.tin, bhfId: kraConfig.bhfId }\n  const kraBaseUrl = buildKraBaseUrl(kraConfig.serverAddress, kraConfig.serverPort)\n  \n  const tankResult = await query(`\n    SELECT t.current_stock \n    FROM tanks t\n    JOIN items i ON UPPER(t.fuel_type) = UPPER(i.item_name) AND i.branch_id = t.branch_id\n    WHERE i.item_code = $1 AND t.branch_id = $2\n    LIMIT 1\n  `, [itemCode, branchId])\n  \n  const currentStock = tankResult.length > 0 ? parseFloat(tankResult[0].current_stock) || 0 : 0\n  \n  const payload = {\n    tin: kraInfo.tin,\n    bhfId: kraInfo.bhfId,\n    itemCd: itemCode,\n    rsdQty: currentStock,\n    regrId: \"Admin\",\n    regrNm: \"Admin\",\n    modrNm: \"Admin\",\n    modrId: \"Admin\"\n  }\n  \n  console.log(`[KRA Stock Sync] Calling saveStockMaster for item ${itemCode}`)\n  console.log(`[KRA Stock Sync] Payload:`, JSON.stringify(payload, null, 2))\n  \n  let response: any\n  let httpStatus = 200\n  \n  try {\n    const controller = new AbortController()\n    const timeoutId = setTimeout(() => controller.abort(), 15000)\n    \n    const res = await fetch(`${kraBaseUrl}/stockMaster/saveStockMaster`, {\n      method: \"POST\",\n      headers: { \"Content-Type\": \"application/json\" },\n      body: JSON.stringify(payload),\n      signal: controller.signal\n    })\n    \n    clearTimeout(timeoutId)\n    httpStatus = res.status\n    response = await res.json()\n  } catch (fetchError: any) {\n    response = {\n      resultCd: fetchError.name === 'AbortError' ? \"TIMEOUT\" : \"NETWORK_ERROR\",\n      resultMsg: fetchError.message || \"Failed to connect to KRA\",\n      resultDt: new Date().toISOString()\n    }\n    httpStatus = 0\n  }\n  \n  const duration = Date.now() - startTime\n  console.log(`[KRA Stock Sync] saveStockMaster response for ${itemCode} (${duration}ms):`, JSON.stringify(response, null, 2))\n  \n  await logApiCall({\n    endpoint: \"/stockMaster/saveStockMaster\",\n    method: \"POST\",\n    payload,\n    response,\n    statusCode: httpStatus,\n    durationMs: duration,\n    branchId,\n    externalEndpoint: `${kraBaseUrl}/stockMaster/saveStockMaster`\n  })\n  \n  const isSuccess = response?.resultCd === \"000\" || response?.resultCd === \"0\"\n  return { success: isSuccess, response }\n}\n\nexport async function syncStockAfterSale(\n  branchId: string,\n  items: StockSyncItem[]\n): Promise<StockSyncResult> {\n  try {\n    console.log(`[KRA Stock Sync] Starting stock sync after sale for branch ${branchId}`)\n    \n    const stockItemsResult = await callSaveStockItems(branchId, \"11\", items)\n    \n    if (!stockItemsResult.success) {\n      console.log(`[KRA Stock Sync] saveStockItems failed, skipping saveStockMaster`)\n      return {\n        success: false,\n        saveStockItemsResponse: stockItemsResult.response,\n        error: stockItemsResult.response?.resultMsg || \"saveStockItems failed\"\n      }\n    }\n    \n    const stockMasterResponses: any[] = []\n    for (const item of items) {\n      const masterResult = await callSaveStockMaster(branchId, item.itemCode)\n      stockMasterResponses.push({\n        itemCode: item.itemCode,\n        ...masterResult\n      })\n    }\n    \n    console.log(`[KRA Stock Sync] Stock sync after sale completed successfully`)\n    return {\n      success: true,\n      saveStockItemsResponse: stockItemsResult.response,\n      saveStockMasterResponses: stockMasterResponses\n    }\n    \n  } catch (error: any) {\n    console.error(`[KRA Stock Sync] Error during stock sync after sale:`, error)\n    return {\n      success: false,\n      error: error.message || \"Internal error during stock sync\"\n    }\n  }\n}\n\nexport async function syncStockAfterCreditNote(\n  branchId: string,\n  items: StockSyncItem[]\n): Promise<StockSyncResult> {\n  try {\n    console.log(`[KRA Stock Sync] Starting stock sync after credit note for branch ${branchId}`)\n    \n    const stockItemsResult = await callSaveStockItems(branchId, \"03\", items)\n    \n    if (!stockItemsResult.success) {\n      console.log(`[KRA Stock Sync] saveStockItems failed for credit note, skipping saveStockMaster`)\n      return {\n        success: false,\n        saveStockItemsResponse: stockItemsResult.response,\n        error: stockItemsResult.response?.resultMsg || \"saveStockItems failed\"\n      }\n    }\n    \n    const stockMasterResponses: any[] = []\n    for (const item of items) {\n      const masterResult = await callSaveStockMaster(branchId, item.itemCode)\n      stockMasterResponses.push({\n        itemCode: item.itemCode,\n        ...masterResult\n      })\n    }\n    \n    console.log(`[KRA Stock Sync] Stock sync after credit note completed successfully`)\n    return {\n      success: true,\n      saveStockItemsResponse: stockItemsResult.response,\n      saveStockMasterResponses: stockMasterResponses\n    }\n    \n  } catch (error: any) {\n    console.error(`[KRA Stock Sync] Error during stock sync after credit note:`, error)\n    return {\n      success: false,\n      error: error.message || \"Internal error during stock sync\"\n    }\n  }\n}\n","import { query } from \"@/lib/db\"\nimport { logApiCall } from \"@/lib/api-logger\"\nimport { syncStockAfterSale, syncStockAfterCreditNote } from \"@/lib/kra-stock-sync\"\nimport { buildKraBaseUrl } from \"@/lib/kra-url-helper\"\n\nconst DEFAULT_KRA_URL = process.env.KRA_VSCU_URL || \"http://5.189.171.160:8088\"\n\ninterface KraSaleData {\n  branch_id: string\n  invoice_number: string\n  receipt_number: string\n  fuel_type: string\n  quantity: number\n  unit_price: number\n  total_amount: number\n  payment_method: string\n  customer_name?: string\n  customer_pin?: string\n  sale_date: string\n  tank_id?: string\n}\n\ninterface KraResponse {\n  resultCd: string\n  resultMsg: string\n  resultDt: string\n  data?: any\n}\n\ninterface BranchConfig {\n  id: string\n  bhf_id: string\n  kra_pin: string\n  device_token: string\n  server_address: string\n  server_port: string\n  invoice_number: number\n}\n\nconst PAYMENT_TYPE_CODES: Record<string, string> = {\n  'cash': '01',\n  'credit': '02', \n  'mobile_money': '03',\n  'mpesa': '03',\n  'bank_transfer': '04',\n  'card': '05',\n  'cheque': '06',\n  'other': '07'\n}\n\nasync function getBranchConfig(branchId: string): Promise<BranchConfig | null> {\n  try {\n    const result = await query(`\n      SELECT id, bhf_id, kra_pin, device_token, server_address, server_port, COALESCE(invoice_number, 0) as invoice_number\n      FROM branches\n      WHERE id = $1\n    `, [branchId])\n\n    if (result.length === 0) {\n      return null\n    }\n\n    return result[0] as BranchConfig\n  } catch (error) {\n    console.error(\"[KRA Sales API] Error fetching branch config:\", error)\n    return null\n  }\n}\n\nasync function getNextInvoiceNo(branchId: string): Promise<number> {\n  const result = await query(`\n    UPDATE branches \n    SET invoice_number = COALESCE(invoice_number, 0) + 1 \n    WHERE id = $1 \n    RETURNING invoice_number\n  `, [branchId])\n  return result[0]?.invoice_number || 1\n}\n\nasync function getItemInfoByFuelType(branchId: string, fuelType: string): Promise<any> {\n  // Query supports both HQ-assigned items (via branch_items) and legacy branch-specific items\n  const result = await query(`\n    SELECT i.item_code, i.class_code, i.item_name, i.package_unit, \n           i.quantity_unit, i.tax_type, \n           COALESCE(bi.sale_price, i.sale_price) as sale_price, \n           COALESCE(bi.purchase_price, i.purchase_price) as purchase_price\n    FROM items i\n    LEFT JOIN branch_items bi ON i.id = bi.item_id AND bi.branch_id = $1\n    WHERE (i.branch_id = $1 OR (i.branch_id IS NULL AND bi.branch_id = $1))\n    AND (UPPER(i.item_name) = UPPER($2) OR i.item_name ILIKE $3)\n    ORDER BY i.created_at DESC\n    LIMIT 1\n  `, [branchId, fuelType, `%${fuelType}%`])\n  \n  return result.length > 0 ? result[0] : null\n}\n\nfunction formatKraDateTime(date: Date = new Date()): string {\n  const year = date.getFullYear()\n  const month = String(date.getMonth() + 1).padStart(2, '0')\n  const day = String(date.getDate()).padStart(2, '0')\n  const hours = String(date.getHours()).padStart(2, '0')\n  const minutes = String(date.getMinutes()).padStart(2, '0')\n  const seconds = String(date.getSeconds()).padStart(2, '0')\n  return `${year}${month}${day}${hours}${minutes}${seconds}`\n}\n\nfunction formatKraDate(date: Date = new Date()): string {\n  const year = date.getFullYear()\n  const month = String(date.getMonth() + 1).padStart(2, '0')\n  const day = String(date.getDate()).padStart(2, '0')\n  return `${year}${month}${day}`\n}\n\nfunction toFixed2(num: number): string {\n  return (Math.round(num * 100) / 100).toFixed(2)\n}\n\nfunction calculateTax(amount: number, taxType: string = \"B\"): { taxblAmt: number, taxAmt: number, taxRt: number } {\n  if (taxType === \"A\") {\n    const taxRt = 16\n    const taxblAmt = amount / (1 + taxRt / 100)\n    const taxAmt = amount - taxblAmt\n    return { taxblAmt: Math.round(taxblAmt * 100) / 100, taxAmt: Math.round(taxAmt * 100) / 100, taxRt }\n  } else if (taxType === \"B\") {\n    const taxRt = 16\n    return { taxblAmt: amount, taxAmt: Math.round(amount * 0.16 * 100) / 100, taxRt }\n  } else if (taxType === \"C\") {\n    const taxRt = 8\n    return { taxblAmt: amount, taxAmt: Math.round(amount * 0.08 * 100) / 100, taxRt }\n  } else if (taxType === \"D\" || taxType === \"E\") {\n    return { taxblAmt: 0, taxAmt: 0, taxRt: 0 }\n  }\n  return { taxblAmt: amount, taxAmt: 0, taxRt: 0 }\n}\n\nexport async function callKraSaveSales(saleData: KraSaleData): Promise<{\n  success: boolean\n  kraResponse: KraResponse | null\n  error?: string\n}> {\n  const startTime = Date.now()\n  \n  try {\n    const branchConfig = await getBranchConfig(saleData.branch_id)\n    \n    if (!branchConfig) {\n      const errorMsg = \"Branch configuration not found\"\n      console.log(`[KRA Sales API] ${errorMsg}`)\n      return { success: false, kraResponse: null, error: errorMsg }\n    }\n\n    if (!branchConfig.kra_pin) {\n      const errorMsg = \"KRA PIN not configured for this branch\"\n      console.log(`[KRA Sales API] ${errorMsg}`)\n      return { \n        success: false, \n        kraResponse: {\n          resultCd: \"CONFIG_ERROR\",\n          resultMsg: errorMsg,\n          resultDt: new Date().toISOString()\n        }, \n        error: errorMsg \n      }\n    }\n\n    const itemInfo = await getItemInfoByFuelType(saleData.branch_id, saleData.fuel_type)\n    const invcNo = await getNextInvoiceNo(saleData.branch_id)\n    \n    if (!itemInfo) {\n      const errorMsg = `No item found for fuel type: ${saleData.fuel_type}`\n      console.log(`[KRA Sales API] ${errorMsg}`)\n      return { \n        success: false, \n        kraResponse: {\n          resultCd: \"ITEM_NOT_FOUND\",\n          resultMsg: errorMsg,\n          resultDt: new Date().toISOString()\n        }, \n        error: errorMsg \n      }\n    }\n    \n    const itemCd = itemInfo.item_code\n    const itemClsCd = itemInfo.class_code || \"15100000\"\n    const itemNm = itemInfo.item_name\n    const pkgUnitCd = itemInfo.package_unit || \"NT\"\n    const qtyUnitCd = itemInfo.quantity_unit || \"LTR\"\n    const taxTyCd = itemInfo.tax_type || \"B\"\n    \n    const prc = Number(itemInfo.sale_price) || 0\n    const qty = saleData.quantity\n    const totAmt = qty * prc\n    \n    console.log(`[KRA Sales API] Item lookup: ${itemNm}, item_code: ${itemCd}, sale_price from DB: ${prc}, qty: ${qty}, totAmt: ${totAmt}`)\n    \n    const { taxblAmt, taxAmt, taxRt } = calculateTax(totAmt, taxTyCd)\n    \n    const now = new Date()\n    const cfmDt = formatKraDateTime(now)\n    const salesDt = formatKraDate(now)\n    \n    const pmtTyCd = PAYMENT_TYPE_CODES[saleData.payment_method?.toLowerCase()] || \"01\"\n    \n    const trdInvcNo = `CIV-${String(invcNo).padStart(6, '0')}`\n\n    const kraPayload = {\n      tin: branchConfig.kra_pin,\n      bhfId: branchConfig.bhf_id || \"00\",\n      trdInvcNo: trdInvcNo,\n      invcNo: String(invcNo),\n      orgInvcNo: 0,\n      custTin: saleData.customer_pin || null,\n      custNm: saleData.customer_name || \"Walk-in Customer\",\n      salesTyCd: \"N\",\n      rcptTyCd: \"S\",\n      pmtTyCd: pmtTyCd,\n      salesSttsCd: \"02\",\n      cfmDt: cfmDt,\n      salesDt: salesDt,\n      stockRlsDt: cfmDt,\n      cnclReqDt: null,\n      cnclDt: null,\n      rfdDt: null,\n      rfdRsnCd: null,\n      totItemCnt: 1,\n      \n      taxblAmtA: taxTyCd === \"A\" ? toFixed2(taxblAmt) : \"0.00\",\n      taxblAmtB: taxTyCd === \"B\" ? toFixed2(taxblAmt) : \"0.00\",\n      taxblAmtC: taxTyCd === \"C\" ? toFixed2(taxblAmt) : \"0.00\",\n      taxblAmtD: \"0.00\",\n      taxblAmtE: \"0.00\",\n      \n      taxRtA: taxTyCd === \"A\" ? toFixed2(taxRt) : \"0.00\",\n      taxRtB: taxTyCd === \"B\" ? toFixed2(taxRt) : \"0.00\",\n      taxRtC: taxTyCd === \"C\" ? toFixed2(taxRt) : \"0.00\",\n      taxRtD: \"0.00\",\n      taxRtE: \"0.00\",\n      \n      taxAmtA: taxTyCd === \"A\" ? toFixed2(taxAmt) : \"0.00\",\n      taxAmtB: taxTyCd === \"B\" ? toFixed2(taxAmt) : \"0.00\",\n      taxAmtC: taxTyCd === \"C\" ? toFixed2(taxAmt) : \"0.00\",\n      taxAmtD: \"0.00\",\n      taxAmtE: \"0.00\",\n      \n      totTaxblAmt: toFixed2(taxblAmt),\n      totTaxAmt: toFixed2(taxAmt),\n      totAmt: toFixed2(totAmt),\n      \n      prchrAcptcYn: \"N\",\n      remark: null,\n      regrNm: \"Admin\",\n      regrId: \"Admin\",\n      modrNm: \"Admin\",\n      modrId: \"Admin\",\n      \n      receipt: {\n        custTin: saleData.customer_pin || null,\n        custMblNo: null,\n        rcptPbctDt: null,\n        trdeNm: null,\n        adrs: null,\n        topMsg: null,\n        btmMsg: null,\n        prchrAcptcYn: \"Y\"\n      },\n      \n      itemList: [\n        {\n          itemSeq: 1,\n          itemCd: itemCd,\n          itemClsCd: itemClsCd,\n          itemNm: itemNm,\n          bcd: null,\n          pkgUnitCd: pkgUnitCd,\n          pkg: 1,\n          qtyUnitCd: qtyUnitCd,\n          qty: parseFloat(qty.toFixed(2)),\n          prc: prc,\n          splyAmt: toFixed2(qty),\n          dcRt: 0.0,\n          dcAmt: 0.0,\n          isrccCd: null,\n          isrccNm: null,\n          isrcRt: 0,\n          isrcAmt: 0,\n          taxTyCd: taxTyCd,\n          taxblAmt: toFixed2(taxblAmt),\n          taxAmt: toFixed2(taxAmt),\n          totAmt: toFixed2(totAmt)\n        }\n      ]\n    }\n\n    const kraBaseUrl = buildKraBaseUrl(branchConfig.server_address, branchConfig.server_port)\n    const kraEndpoint = `${kraBaseUrl}/trnsSales/saveSales`\n    \n    console.log(`[KRA Sales API] Calling endpoint: ${kraEndpoint}`)\n    console.log(`[KRA Sales API] Request payload:`, JSON.stringify(kraPayload, null, 2))\n\n    let kraResponse: KraResponse\n    let httpStatusCode = 200\n\n    try {\n      const controller = new AbortController()\n      const timeoutId = setTimeout(() => controller.abort(), 30000)\n      \n      const response = await fetch(kraEndpoint, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"Accept\": \"application/json\",\n          ...(branchConfig.device_token ? { \"DeviceSerialNo\": branchConfig.device_token } : {})\n        },\n        body: JSON.stringify(kraPayload),\n        signal: controller.signal\n      })\n\n      clearTimeout(timeoutId)\n      httpStatusCode = response.status\n      kraResponse = await response.json()\n      \n      console.log(`[KRA Sales API] HTTP Status: ${response.status}`)\n      console.log(`[KRA Sales API] KRA Result Code: ${kraResponse.resultCd}`)\n      console.log(`[KRA Sales API] KRA Result Message: ${kraResponse.resultMsg}`)\n      console.log(`[KRA Sales API] Response body:`, JSON.stringify(kraResponse, null, 2))\n    } catch (fetchError: any) {\n      httpStatusCode = 0\n      if (fetchError.name === 'AbortError') {\n        kraResponse = {\n          resultCd: \"TIMEOUT\",\n          resultMsg: \"Request timed out after 30 seconds\",\n          resultDt: new Date().toISOString()\n        }\n      } else {\n        kraResponse = {\n          resultCd: \"NETWORK_ERROR\",\n          resultMsg: fetchError.message || \"Failed to connect to KRA backend\",\n          resultDt: new Date().toISOString()\n        }\n      }\n      \n      console.log(`[KRA Sales API] Network error:`, fetchError.message)\n      console.log(`[KRA Sales API] Response (network error):`, JSON.stringify(kraResponse, null, 2))\n    }\n\n    const durationMs = Date.now() - startTime\n    const isSuccess = kraResponse.resultCd === \"000\" || kraResponse.resultCd === \"0\"\n\n    await logApiCall({\n      endpoint: \"/trnsSales/saveSales\",\n      method: \"POST\",\n      payload: kraPayload,\n      response: kraResponse,\n      statusCode: httpStatusCode || 500,\n      durationMs,\n      branchId: saleData.branch_id,\n      externalEndpoint: kraEndpoint\n    })\n\n    if (isSuccess) {\n      console.log(`[KRA Sales API] saveSales successful, now syncing stock with KRA`)\n      \n      try {\n        const stockSyncResult = await syncStockAfterSale(saleData.branch_id, [{\n          itemCode: itemCd,\n          itemClassCode: itemClsCd,\n          itemName: itemNm,\n          packageUnit: pkgUnitCd,\n          quantityUnit: qtyUnitCd,\n          quantity: qty,\n          unitPrice: prc,\n          taxType: taxTyCd\n        }])\n        \n        if (stockSyncResult.success) {\n          console.log(`[KRA Sales API] Stock sync completed successfully`)\n        } else {\n          console.log(`[KRA Sales API] Stock sync failed: ${stockSyncResult.error}`)\n        }\n      } catch (stockError: any) {\n        console.error(`[KRA Sales API] Error during stock sync:`, stockError.message)\n      }\n    }\n    \n    return {\n      success: isSuccess,\n      kraResponse\n    }\n\n  } catch (error: any) {\n    const errorResponse: KraResponse = {\n      resultCd: \"SYSTEM_ERROR\",\n      resultMsg: error.message || \"System error calling KRA API\",\n      resultDt: new Date().toISOString()\n    }\n\n    console.error(`[KRA Sales API] System error:`, error)\n\n    const durationMs = Date.now() - startTime\n    \n    await logApiCall({\n      endpoint: \"/trnsSales/saveSales\",\n      method: \"POST\",\n      payload: { saleData, errorContext: \"System error before KRA call\" },\n      response: errorResponse,\n      statusCode: 500,\n      durationMs,\n      branchId: saleData.branch_id,\n      error: error.message,\n      externalEndpoint: `${DEFAULT_KRA_URL}/trnsSales/saveSales`\n    })\n\n    return {\n      success: false,\n      kraResponse: errorResponse,\n      error: error.message\n    }\n  }\n}\n\nexport async function callKraTestSalesEndpoint(saleData: KraSaleData): Promise<{\n  success: boolean\n  kraResponse: KraResponse | null\n  error?: string\n}> {\n  return callKraSaveSales(saleData)\n}\n\ninterface CreditNoteData {\n  branch_id: string\n  original_sale_id: string\n  original_invoice_no: number\n  refund_reason_code: string\n  customer_tin?: string\n  customer_name?: string\n  items: Array<{\n    item_code: string\n    item_class_code: string\n    item_name: string\n    package_unit: string\n    quantity_unit: string\n    quantity: number\n    price: number\n    tax_type: string\n  }>\n}\n\nconst REFUND_REASON_CODES: Record<string, string> = {\n  'defective': '01',\n  'wrong_item': '02',\n  'customer_request': '03',\n  'price_error': '04',\n  'duplicate': '05',\n  'other': '06'\n}\n\nexport async function callKraCreditNote(creditNoteData: CreditNoteData): Promise<{\n  success: boolean\n  kraResponse: KraResponse | null\n  creditNoteNumber?: string\n  invcNo?: number\n  error?: string\n}> {\n  const startTime = Date.now()\n  \n  try {\n    const branchConfig = await getBranchConfig(creditNoteData.branch_id)\n    \n    if (!branchConfig) {\n      return { success: false, kraResponse: null, error: \"Branch configuration not found\" }\n    }\n\n    if (!branchConfig.kra_pin) {\n      return { \n        success: false, \n        kraResponse: {\n          resultCd: \"CONFIG_ERROR\",\n          resultMsg: \"KRA PIN not configured for this branch\",\n          resultDt: new Date().toISOString()\n        }, \n        error: \"KRA PIN not configured\" \n      }\n    }\n\n    const invcNo = await getNextInvoiceNo(creditNoteData.branch_id)\n    const trdInvcNo = `CR${invcNo}`\n    \n    const now = new Date()\n    const cfmDt = formatKraDateTime(now)\n    const salesDt = formatKraDate(now)\n    \n    const rfdRsnCd = REFUND_REASON_CODES[creditNoteData.refund_reason_code?.toLowerCase()] || \"06\"\n    \n    let totTaxblAmtB = 0\n    let totTaxAmtB = 0\n    let totAmt = 0\n    \n    const itemList = creditNoteData.items.map((item, index) => {\n      const splyAmt = item.quantity * item.price\n      const taxblAmt = splyAmt / 1.16\n      const taxAmt = splyAmt - taxblAmt\n      \n      totTaxblAmtB += taxblAmt\n      totTaxAmtB += taxAmt\n      totAmt += splyAmt\n      \n      return {\n        itemSeq: index + 1,\n        itemCd: item.item_code,\n        itemClsCd: item.item_class_code || \"99013001\",\n        itemNm: item.item_name,\n        bcd: null,\n        pkgUnitCd: item.package_unit || \"BF\",\n        pkg: item.quantity,\n        qtyUnitCd: item.quantity_unit || \"L\",\n        qty: item.quantity,\n        prc: item.price,\n        splyAmt: toFixed2(splyAmt),\n        dcRt: 0.0,\n        dcAmt: 0.0,\n        isrccCd: null,\n        isrccNm: null,\n        isrcRt: null,\n        isrcAmt: null,\n        taxTyCd: item.tax_type || \"B\",\n        taxblAmt: toFixed2(taxblAmt),\n        taxAmt: toFixed2(taxAmt),\n        totAmt: toFixed2(splyAmt)\n      }\n    })\n\n    const kraPayload = {\n      tin: branchConfig.kra_pin,\n      bhfId: branchConfig.bhf_id || \"00\",\n      trdInvcNo: trdInvcNo,\n      invcNo: invcNo,\n      orgInvcNo: creditNoteData.original_invoice_no,\n      custTin: creditNoteData.customer_tin || null,\n      custNm: creditNoteData.customer_name || \"Walk-in Customer\",\n      salesTyCd: \"N\",\n      rcptTyCd: \"R\",\n      pmtTyCd: \"01\",\n      salesSttsCd: \"02\",\n      cfmDt: cfmDt,\n      salesDt: salesDt,\n      stockRlsDt: cfmDt,\n      cnclReqDt: null,\n      cnclDt: null,\n      rfdDt: cfmDt,\n      rfdRsnCd: rfdRsnCd,\n      totItemCnt: itemList.length,\n      taxblAmtA: \"0.00\",\n      taxblAmtB: toFixed2(totTaxblAmtB),\n      taxblAmtC: \"0.00\",\n      taxblAmtD: \"0.00\",\n      taxblAmtE: \"0.00\",\n      taxRtA: \"0.00\",\n      taxRtB: \"16.00\",\n      taxRtC: \"0.00\",\n      taxRtD: \"0.00\",\n      taxRtE: \"0.00\",\n      taxAmtA: \"0.00\",\n      taxAmtB: toFixed2(totTaxAmtB),\n      taxAmtC: \"0.00\",\n      taxAmtD: \"0.00\",\n      taxAmtE: \"0.00\",\n      totTaxblAmt: toFixed2(totTaxblAmtB),\n      totTaxAmt: toFixed2(totTaxAmtB),\n      totAmt: toFixed2(totAmt),\n      prchrAcptcYn: \"N\",\n      remark: null,\n      regrNm: \"Admin\",\n      regrId: \"Admin\",\n      modrNm: \"Admin\",\n      modrId: \"Admin\",\n      receipt: {\n        custTin: creditNoteData.customer_tin || null,\n        custMblNo: null,\n        rcptPbctDt: cfmDt,\n        trdeNm: null,\n        adrs: null,\n        topMsg: null,\n        btmMsg: null,\n        prchrAcptcYn: \"N\"\n      },\n      itemList: itemList\n    }\n\n    const kraBaseUrl = buildKraBaseUrl(branchConfig.server_address, branchConfig.server_port)\n    const kraEndpoint = `${kraBaseUrl}/trnsSales/saveSales`\n    \n    console.log(`[KRA Credit Note API] Calling endpoint: ${kraEndpoint}`)\n    console.log(`[KRA Credit Note API] Request payload:`, JSON.stringify(kraPayload, null, 2))\n\n    let kraResponse: KraResponse\n    let httpStatusCode = 200\n\n    try {\n      const controller = new AbortController()\n      const timeoutId = setTimeout(() => controller.abort(), 30000)\n      \n      const response = await fetch(kraEndpoint, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"Accept\": \"application/json\",\n          ...(branchConfig.device_token ? { \"DeviceSerialNo\": branchConfig.device_token } : {})\n        },\n        body: JSON.stringify(kraPayload),\n        signal: controller.signal\n      })\n\n      clearTimeout(timeoutId)\n      httpStatusCode = response.status\n      kraResponse = await response.json()\n      \n      console.log(`[KRA Credit Note API] HTTP Status: ${response.status}`)\n      console.log(`[KRA Credit Note API] Response:`, JSON.stringify(kraResponse, null, 2))\n    } catch (fetchError: any) {\n      httpStatusCode = 0\n      kraResponse = {\n        resultCd: fetchError.name === 'AbortError' ? \"TIMEOUT\" : \"NETWORK_ERROR\",\n        resultMsg: fetchError.message || \"Failed to connect to KRA backend\",\n        resultDt: new Date().toISOString()\n      }\n      console.log(`[KRA Credit Note API] Network error:`, fetchError.message)\n    }\n\n    const durationMs = Date.now() - startTime\n\n    await logApiCall({\n      endpoint: \"/trnsSales/saveSales\",\n      method: \"POST\",\n      payload: kraPayload,\n      response: kraResponse,\n      statusCode: httpStatusCode || 500,\n      durationMs,\n      branchId: creditNoteData.branch_id,\n      externalEndpoint: kraEndpoint\n    })\n\n    const isSuccess = kraResponse.resultCd === \"000\" || kraResponse.resultCd === \"0\"\n    \n    if (isSuccess) {\n      console.log(`[KRA Credit Note API] saveSales successful for credit note, now syncing stock with KRA`)\n      \n      try {\n        const stockItems = creditNoteData.items.map(item => ({\n          itemCode: item.item_code,\n          itemClassCode: item.item_class_code,\n          itemName: item.item_name,\n          packageUnit: item.package_unit,\n          quantityUnit: item.quantity_unit,\n          quantity: item.quantity,\n          unitPrice: item.price,\n          taxType: item.tax_type\n        }))\n        \n        const stockSyncResult = await syncStockAfterCreditNote(creditNoteData.branch_id, stockItems)\n        \n        if (stockSyncResult.success) {\n          console.log(`[KRA Credit Note API] Stock sync completed successfully for credit note`)\n        } else {\n          console.log(`[KRA Credit Note API] Stock sync failed for credit note: ${stockSyncResult.error}`)\n        }\n      } catch (stockError: any) {\n        console.error(`[KRA Credit Note API] Error during stock sync for credit note:`, stockError.message)\n      }\n    }\n    \n    return {\n      success: isSuccess,\n      kraResponse,\n      creditNoteNumber: trdInvcNo,\n      invcNo: invcNo\n    }\n\n  } catch (error: any) {\n    console.error(`[KRA Credit Note API] System error:`, error)\n    return {\n      success: false,\n      kraResponse: {\n        resultCd: \"SYSTEM_ERROR\",\n        resultMsg: error.message || \"System error calling KRA API\",\n        resultDt: new Date().toISOString()\n      },\n      error: error.message\n    }\n  }\n}\n"],"names":[],"mappings":"8CAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,oBAWA,eAAe,EAAmB,CAAgB,EAChD,IAAM,EAAS,MAAM,CAAA,EAAA,EAAA,KAAA,AAAK,EAAC,CAAC;;;;;;EAM5B,CAAC,CAAE,CAAC,EAAS,SAEb,AAAI,AAAkB,KAAK,CAAhB,MAAM,EAAW,CAAM,CAAC,EAAE,CAAC,GAAG,CAClC,CADoC,AAEzC,IAAK,CAAM,CAAC,EAAE,CAAC,GAAG,CAClB,MAAO,CAAM,CAAC,EAAE,CAAC,MAAM,EAAI,KAC3B,cAAe,CAAM,CAAC,EAAE,CAAC,cAAc,CACvC,WAAY,CAAM,CAAC,EAAE,CAAC,WACxB,AADmC,EALe,IAOpD,CA+BA,eAAe,EAAa,CAAgB,EAC1C,IAAM,EAAS,MAAM,CAAA,EAAA,EAAA,KAAA,AAAK,EAAC,CAAC;;;;;;EAM5B,CAAC,CAAE,CAAC,EAAS,EAEb,GAAsB,GAAG,CAArB,EAAO,MAAM,CACf,MAAM,AAAI,MAAM,CAAC,OAAO,EAAE,EAAS,UAAU,CAAC,EAGhD,OAAO,CAAM,CAAC,EAAE,CAAC,SAAS,AAC5B,CASA,SAAS,EAAS,CAAW,EAC3B,MAAO,AAAC,MAAK,KAAK,CAAO,IAAN,GAAa,GAAA,CAAG,CAAE,OAAO,CAAC,EAC/C,CAaA,eAAe,EACb,CAAgB,CAChB,CAAe,CACf,CAAsB,EAEtB,IA2EI,EA3EE,EAAY,KAAK,GAAG,GAEpB,EAAY,MAAM,EAAmB,GAC3C,GAAI,CAAC,EACH,MAAO,CACL,EAFY,OAEH,EACT,SAAU,CAAE,SAAU,eAAgB,UAAW,gCAAiC,EAClF,MAAO,CACT,EAGF,IAAM,EAAU,CAAE,IAAK,EAAU,GAAG,CAAE,MAAO,EAAU,KAAM,AAAD,EACtD,EAAa,CAAA,EAAA,EAAA,eAAA,AAAe,EAAC,EAAU,aAAa,CAAE,EAAU,UAAU,EAE1E,EAAQ,MAAM,EAAa,GAE7B,EAAc,EACd,EAAY,EACZ,EAAS,EAEP,EAAW,EAAM,GAAG,CAAC,CAAC,EAAM,KAChC,IAAM,EAAU,KAAK,KAAK,CAAC,EAAK,QAAQ,CAAG,EAAK,SAAS,CAAG,KAAO,IAC7D,EAtCV,AAsCmB,SAtCS,AAAnB,CAAiC,CAAE,EAAkB,GAAG,QAC/D,AAAgB,KAAK,CAAjB,EACK,KAAK,KAAK,CAAU,IAAT,EAAgB,KAAO,IACpB,KAAK,CAAjB,EACF,KAAK,KAAK,GAAW,KAAT,EAAiB,EAAc,IAC7B,CADsB,IACjB,CAAjB,EACF,KAAK,KAAK,CAAU,AAAT,MAAgB,KAAO,IAEpC,CACT,EA6BsC,EAAS,EAAK,OAAO,EAMvD,OAJA,GAAe,EACf,GAAa,EACb,GAAU,EAEH,CACL,QAAS,EAAQ,EACjB,OAAQ,EAAK,QAAQ,CACrB,UAAW,EAAK,aAAa,EAAI,WACjC,OAAQ,EAAK,QAAQ,CACrB,IAAK,KACL,UAAW,EAAK,WAAW,EAAI,KAC/B,IAAK,KAAK,IAAI,CAAC,EAAK,QAAQ,EAC5B,UAAW,EAAK,YAAY,EAAI,MAChC,IAAK,WAAW,EAAK,QAAQ,CAAC,OAAO,CAAC,IACtC,WAAY,KACZ,IAAK,EAAK,SAAS,CACnB,QAAS,EAAS,GAClB,SAAU,EACV,SAAU,EAAS,GACnB,QAAS,EAAK,OAAO,EAAI,IACzB,OAAQ,EAAS,GACjB,OAAQ,EAAS,EACnB,CACF,GAEM,EAAU,CACd,IAAK,EAAQ,GAAG,CAChB,MAAO,EAAQ,KAAK,OACpB,EACA,SAAU,EACV,QAAS,IACT,QAAS,KACT,OAAQ,KACR,UAAW,aACX,EACA,OAtFJ,AAsFY,SAtFH,AAAc,EAAa,IAAI,IAAM,EAC5C,IAAM,EAAO,EAAK,WAAW,GACvB,EAAQ,OAAO,EAAK,QAAQ,GAAK,GAAG,QAAQ,CAAC,EAAG,KAChD,EAAM,OAAO,EAAK,OAAO,IAAI,QAAQ,CAAC,EAAG,KAC/C,MAAO,CAAA,EAAG,EAAA,EAAO,EAAA,EAAQ,EAAA,CAAK,AAChC,IAkFI,WAAY,EAAS,MAAM,CAC3B,YAAa,EAAS,GACtB,UAAW,EAAS,GACpB,OAAQ,EAAS,GACjB,OAAQ,KACR,OAAQ,QACR,OAAQ,QACR,OAAQ,QACR,OAAQ,iBACR,CACF,EAEA,QAAQ,GAAG,CAAC,CAAC,qDAAqD,EAAE,EAAA,CAAS,EAC7E,QAAQ,GAAG,CAAC,CAAC,yBAAyB,CAAC,CAAE,KAAK,SAAS,CAAC,EAAS,KAAM,IAGvE,IAAI,EAAa,IAEjB,GAAI,CACF,IAAM,EAAa,IAAI,gBACjB,EAAY,WAAW,IAAM,EAAW,KAAK,GAAI,MAEjD,EAAM,MAAM,MAAM,CAAA,EAAG,EAAW,qBAAqB,CAAC,CAAE,CAC5D,OAAQ,OACR,QAAS,CAAE,eAAgB,kBAAmB,EAC9C,KAAM,KAAK,SAAS,CAAC,GACrB,OAAQ,EAAW,MAAM,AAC3B,GAEA,aAAa,GACb,EAAa,EAAI,MAAM,CACvB,EAAW,MAAM,EAAI,IAAI,EAC3B,CAAE,MAAO,EAAiB,CACxB,EAAW,CACT,SAA8B,eAApB,EAAW,IAAI,CAAoB,UAAY,gBACzD,UAAW,EAAW,OAAO,EAAI,2BACjC,SAAU,IAAI,OAAO,WAAW,EAClC,EACA,EAAa,CACf,CAEA,IAAM,EAAW,KAAK,GAAG,GAAK,EAe9B,OAdA,QAAQ,GAAG,CAAC,CAAC,0CAA0C,EAAE,EAAS,IAAI,CAAC,CAAE,KAAK,SAAS,CAAC,EAAU,KAAM,IAExG,MAAM,CAAA,EAAA,EAAA,UAAA,AAAU,EAAC,CACf,SAAU,wBACV,OAAQ,eACR,WACA,EACA,WAAY,EACZ,WAAY,WACZ,EACA,iBAAkB,CAAA,EAAG,EAAW,qBAAqB,CAAC,AACxD,GAGO,CAAE,QADS,CACA,EADU,WAAa,OAAS,GAAU,WAAa,aAC5C,QAAU,CAAM,CAC/C,CAEA,eAAe,EACb,CAAgB,CAChB,CAAgB,EAEhB,IAqCI,EArCE,EAAY,KAAK,GAAG,GAEpB,EAAY,MAAM,EAAmB,GAC3C,GAAI,CAAC,EACH,MAAO,CACL,EAFY,OAEH,EACT,SAAU,CAAE,SAAU,eAAgB,UAAW,gCAAiC,CACpF,EAGF,IAAM,EAAU,CAAE,IAAK,EAAU,GAAG,CAAE,MAAO,EAAU,KAAK,AAAC,EACvD,EAAa,CAAA,EAAA,EAAA,eAAA,AAAe,EAAC,EAAU,aAAa,CAAE,EAAU,UAAU,EAE1E,EAAa,MAAM,CAAA,EAAA,EAAA,KAAA,AAAK,EAAC,CAAC;;;;;;EAMhC,CAAC,CAAE,CAAC,EAAU,EAAS,EAEjB,EAAe,EAAW,MAAM,CAAG,GAAI,WAAW,CAAU,CAAC,EAAE,CAAC,aAAa,GAAK,EAElF,EAFsF,AAE5E,CACd,IAAK,EAAQ,GAAG,CAChB,MAAO,EAAQ,KAAK,CACpB,OAAQ,EACR,OAAQ,EACR,OAAQ,QACR,OAAQ,QACR,OAAQ,QACR,OAAQ,OACV,EAEA,QAAQ,GAAG,CAAC,CAAC,kDAAkD,EAAE,EAAA,CAAU,EAC3E,QAAQ,GAAG,CAAC,CAAC,yBAAyB,CAAC,CAAE,KAAK,SAAS,CAAC,EAAS,KAAM,IAGvE,IAAI,EAAa,IAEjB,GAAI,CACF,IAAM,EAAa,IAAI,gBACjB,EAAY,WAAW,IAAM,EAAW,KAAK,GAAI,MAEjD,EAAM,MAAM,MAAM,CAAA,EAAG,EAAW,4BAA4B,CAAC,CAAE,CACnE,OAAQ,OACR,QAAS,CAAE,eAAgB,kBAAmB,EAC9C,KAAM,KAAK,SAAS,CAAC,GACrB,OAAQ,EAAW,MAAM,AAC3B,GAEA,aAAa,GACb,EAAa,EAAI,MAAM,CACvB,EAAW,MAAM,EAAI,IAAI,EAC3B,CAAE,MAAO,EAAiB,CACxB,EAAW,CACT,SAA8B,eAApB,EAAW,IAAI,CAAoB,UAAY,gBACzD,UAAW,EAAW,OAAO,EAAI,2BACjC,SAAU,IAAI,OAAO,WAAW,EAClC,EACA,EAAa,CACf,CAEA,IAAM,EAAW,KAAK,GAAG,GAAK,EAe9B,OAdA,QAAQ,GAAG,CAAC,CAAC,8CAA8C,EAAE,EAAS,EAAE,EAAE,EAAS,IAAI,CAAC,CAAE,KAAK,SAAS,CAAC,EAAU,KAAM,IAEzH,MAAM,CAAA,EAAA,EAAA,UAAA,AAAU,EAAC,CACf,SAAU,+BACV,OAAQ,OACR,mBACA,EACA,WAAY,EACZ,WAAY,WACZ,EACA,iBAAkB,CAAA,EAAG,EAAW,4BAA4B,CAAC,AAC/D,GAGO,CAAE,QADS,CACA,EADU,WAAa,OAAS,GAAU,WAAa,aAC5C,CAAS,CACxC,CAEO,eAAe,EACpB,CAAgB,CAChB,CAAsB,EAEtB,GAAI,CACF,QAAQ,GAAG,CAAC,CAAC,2DAA2D,EAAE,EAAA,CAAU,EAEpF,IAAM,EAAmB,MAAM,EAAmB,EAAU,KAAM,GAElE,GAAI,CAAC,EAAiB,OAAO,CAE3B,CAF6B,MAC7B,QAAQ,GAAG,CAAC,CAAC,gEAAgE,CAAC,EACvE,CACL,SAAS,EACT,uBAAwB,EAAiB,QAAQ,CACjD,MAAO,EAAiB,QAAQ,EAAE,WAAa,uBACjD,EAGF,IAAM,EAA8B,EAAE,CACtC,IAAK,IAAM,KAAQ,EAAO,CACxB,IAAM,EAAe,MAAM,EAAoB,EAAU,EAAK,QAAQ,EACtE,EAAqB,IAAI,CAAC,CACxB,SAAU,EAAK,QAAQ,CACvB,GAAG,CAAY,AACjB,EACF,CAGA,OADA,QAAQ,GAAG,CAAC,CAAC,6DAA6D,CAAC,EACpE,CACL,SAAS,EACT,uBAAwB,EAAiB,QAAQ,CACjD,yBAA0B,CAC5B,CAEF,CAAE,MAAO,EAAY,CAEnB,OADA,QAAQ,KAAK,CAAC,CAAC,oDAAoD,CAAC,CAAE,GAC/D,CACL,SAAS,EACT,MAAO,EAAM,OAAO,EAAI,kCAC1B,CACF,CACF,CAEO,eAAe,EACpB,CAAgB,CAChB,CAAsB,EAEtB,GAAI,CACF,QAAQ,GAAG,CAAC,CAAC,kEAAkE,EAAE,EAAA,CAAU,EAE3F,IAAM,EAAmB,MAAM,EAAmB,EAAU,KAAM,GAElE,GAAI,CAAC,EAAiB,OAAO,CAE3B,CAF6B,MAC7B,QAAQ,GAAG,CAAC,CAAC,gFAAgF,CAAC,EACvF,CACL,SAAS,EACT,uBAAwB,EAAiB,QAAQ,CACjD,MAAO,EAAiB,QAAQ,EAAE,WAAa,uBACjD,EAGF,IAAM,EAA8B,EAAE,CACtC,IAAK,IAAM,KAAQ,EAAO,CACxB,IAAM,EAAe,MAAM,EAAoB,EAAU,EAAK,QAAQ,EACtE,EAAqB,IAAI,CAAC,CACxB,SAAU,EAAK,QAAQ,CACvB,GAAG,CAAY,AACjB,EACF,CAGA,OADA,QAAQ,GAAG,CAAC,CAAC,oEAAoE,CAAC,EAC3E,CACL,SAAS,EACT,uBAAwB,EAAiB,QAAQ,CACjD,yBAA0B,CAC5B,CAEF,CAAE,MAAO,EAAY,CAEnB,OADA,QAAQ,KAAK,CAAC,CAAC,2DAA2D,CAAC,CAAE,GACtE,CACL,SAAS,EACT,MAAO,EAAM,OAAO,EAAI,kCAC1B,CACF,CACF,8BAnYwB,QAAQ,GAAG,CAAC,YAAY,IAAI,sHCJpD,IAAA,EAAA,EAAA,CAAA,CAAA,OAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,qDAEA,IAAM,EAAkB,QAAQ,GAAG,CAAC,YAAY,EAAI,4BAkC9C,EAA6C,CACjD,KAAQ,KACR,OAAU,KACV,aAAgB,KAChB,MAAS,KACT,cAAiB,KACjB,KAAQ,KACR,OAAU,KACV,MAAS,IACX,EAEA,eAAe,EAAgB,CAAgB,EAC7C,GAAI,CACF,IAAM,EAAS,MAAM,CAAA,EAAA,EAAA,KAAA,AAAK,EAAC,CAAC;;;;IAI5B,CAAC,CAAE,CAAC,EAAS,EAEb,GAAsB,GAAG,CAArB,EAAO,MAAM,CACf,OAAO,KAGT,OAAO,CAAM,CAAC,EAAE,AAClB,CAAE,MAAO,EAAO,CAEd,OADA,QAAQ,KAAK,CAAC,gDAAiD,GACxD,IACT,CACF,CAEA,eAAe,EAAiB,CAAgB,EAC9C,IAAM,EAAS,MAAM,CAAA,EAAA,EAAA,KAAA,AAAK,EAAC,CAAC;;;;;EAK5B,CAAC,CAAE,CAAC,EAAS,EACb,OAAO,CAAM,CAAC,EAAE,EAAE,gBAAkB,CACtC,CAEA,eAAe,EAAsB,CAAgB,CAAE,CAAgB,EAErE,IAAM,EAAS,MAAM,CAAA,EAAA,EAAA,KAAA,AAAK,EAAC,CAAC;;;;;;;;;;;EAW5B,CAAC,CAAE,CAAC,EAAU,EAAU,CAAC,CAAC,EAAE,EAAS,CAAC,CAAC,CAAC,EAExC,OAAO,EAAO,MAAM,CAAG,EAAI,CAAM,CAAC,EAAE,CAAG,IACzC,CAEA,SAAS,EAAkB,EAAa,IAAI,IAAM,EAChD,IAAM,EAAO,EAAK,WAAW,GACvB,EAAQ,OAAO,EAAK,QAAQ,GAAK,GAAG,QAAQ,CAAC,EAAG,KAChD,EAAM,OAAO,EAAK,OAAO,IAAI,QAAQ,CAAC,EAAG,KACzC,EAAQ,OAAO,EAAK,QAAQ,IAAI,QAAQ,CAAC,EAAG,KAC5C,EAAU,OAAO,EAAK,UAAU,IAAI,QAAQ,CAAC,EAAG,KAChD,EAAU,OAAO,EAAK,UAAU,IAAI,QAAQ,CAAC,EAAG,KACtD,MAAO,CAAA,EAAG,EAAA,EAAO,EAAA,EAAQ,EAAA,EAAM,EAAA,EAAQ,EAAA,EAAU,EAAA,CAAS,AAC5D,CAEA,SAAS,EAAc,EAAa,IAAI,IAAM,EAC5C,IAAM,EAAO,EAAK,WAAW,GACvB,EAAQ,OAAO,EAAK,QAAQ,GAAK,GAAG,QAAQ,CAAC,EAAG,KAChD,EAAM,OAAO,EAAK,OAAO,IAAI,QAAQ,CAAC,EAAG,KAC/C,MAAO,CAAA,EAAG,EAAA,EAAO,EAAA,EAAQ,EAAA,CAAK,AAChC,CAEA,SAAS,EAAS,CAAW,EAC3B,MAAO,AAAC,MAAK,KAAK,CAAO,IAAN,GAAa,GAAA,CAAG,CAAE,OAAO,CAAC,EAC/C,CAoBO,eAAe,EAAiB,CAAqB,EAK1D,IAAM,EAAY,KAAK,GAAG,GAE1B,GAAI,CACF,IA4JI,EA5JE,EAAe,MAAM,EAAgB,EAAS,SAAS,EAE7D,GAAI,CAAC,EAAc,CACjB,IAAM,EAAW,iCAEjB,OADA,QAAQ,GAAG,CAAC,CAAC,gBAAgB,EAAE,EAAA,CAAU,EAClC,CAAE,SAAS,EAAO,YAAa,KAAM,MAAO,CAAS,CAC9D,CAEA,GAAI,CAAC,EAAa,OAAO,CAAE,CACzB,IAAM,EAAW,yCAEjB,OADA,QAAQ,GAAG,CAAC,CAAC,gBAAgB,EAAE,EAAA,CAAU,EAClC,CACL,SAAS,EACT,YAAa,CACX,SAAU,eACV,UAAW,EACX,SAAU,IAAI,OAAO,WAAW,EAClC,EACA,MAAO,CACT,CACF,CAEA,IAAM,EAAW,MAAM,EAAsB,EAAS,SAAS,CAAE,EAAS,SAAS,EAC7E,EAAS,MAAM,EAAiB,EAAS,SAAS,EAExD,GAAI,CAAC,EAAU,CACb,IAAM,EAAW,CAAC,6BAA6B,EAAE,EAAS,SAAS,CAAA,CAAE,CAErE,OADA,QAAQ,GAAG,CAAC,CAAC,gBAAgB,EAAE,EAAA,CAAU,EAClC,CACL,SAAS,EACT,YAAa,CACX,SAAU,iBACV,UAAW,EACX,SAAU,IAAI,OAAO,WAAW,EAClC,EACA,MAAO,CACT,CACF,CAEA,IAAM,EAAS,EAAS,SAAS,CAC3B,EAAY,EAAS,UAAU,EAAI,WACnC,EAAS,EAAS,SAAS,CAC3B,EAAY,EAAS,YAAY,EAAI,KACrC,EAAY,EAAS,aAAa,EAAI,MACtC,EAAU,EAAS,QAAQ,EAAI,IAE/B,EAAM,OAAO,EAAS,UAAU,GAAK,EACrC,EAAM,EAAS,QAAQ,CACvB,EAAS,EAAM,EAErB,QAAQ,GAAG,CAAC,CAAC,6BAA6B,EAAE,EAAO,aAAa,EAAE,EAAO,sBAAsB,EAAE,EAAI,OAAO,EAAE,EAAI,UAAU,EAAE,EAAA,CAAQ,EAEtI,GAAM,UAAE,CAAQ,QAAE,CAAM,CAAE,OAAK,CAAE,CA9ErC,AA8EwC,SA9E/B,AAAa,CAAc,CAAE,EAAkB,GAAG,EACzD,GAAgB,MAAZ,EAAiB,CAEnB,IAAM,EAAW,EAAU,IAAI,CAE/B,EAF0B,IAEnB,CAFgC,AAE9B,GAFiC,MAEvB,KAAK,KAAK,CAAY,IAAX,GAAkB,IAAK,OAAQ,KAAK,KAAK,CAAC,AAAS,KADlE,EAAS,CAAA,GACgE,IAAK,MAH/E,EAGqF,CACrG,OAAO,AAAgB,KAAK,CAAjB,EAEF,CAAE,SAAU,EAAQ,OAAQ,KAAK,KAAK,CAAU,IAAT,EAAgB,KAAO,IAAK,MAD5D,EACkE,EACvE,AAAY,KAAK,GAEnB,CAAE,SAAU,EAAQ,OAAQ,KAAK,KAAK,CAAU,IAAT,EAAgB,KAAO,IAAK,MAD5D,CACkE,EACvE,AAAY,SAAmB,KAAK,CAAjB,EACrB,CAAE,SAAU,EAAG,OAAQ,EAAG,MAAO,CAAE,EAErC,CAAE,SAAU,EAAQ,OAAQ,EAAG,MAAO,CAAE,CACjD,EA8DqD,EAAQ,GAEnD,EAAM,IAAI,KACV,EAAQ,EAAkB,GAC1B,EAAU,EAAc,GAExB,EAAU,CAAkB,CAAC,EAAS,cAAc,EAAE,cAAc,EAAI,KAExE,EAAY,CAAC,IAAI,EAAE,OAAO,GAAQ,QAAQ,CAAC,EAAG,KAAA,CAAM,CAEpD,EAAa,CACjB,IAAK,EAAa,OAAO,CACzB,MAAO,EAAa,MAAM,EAAI,KAC9B,UAAW,EACX,OAAQ,OAAO,GACf,UAAW,EACX,QAAS,EAAS,YAAY,EAAI,KAClC,OAAQ,EAAS,aAAa,EAAI,mBAClC,UAAW,IACX,SAAU,IACV,QAAS,EACT,YAAa,KACb,MAAO,EACP,QAAS,EACT,WAAY,EACZ,UAAW,KACX,OAAQ,KACR,MAAO,KACP,SAAU,KACV,WAAY,EAEZ,UAAuB,MAAZ,EAAkB,EAAS,GAAY,OAClD,UAAuB,MAAZ,EAAkB,EAAS,GAAY,OAClD,UAAuB,MAAZ,EAAkB,EAAS,GAAY,OAClD,UAAW,OACX,UAAW,OAEX,OAAoB,MAAZ,EAAkB,EAAS,GAAS,OAC5C,OAAQ,AAAY,QAAM,EAAS,GAAS,OAC5C,OAAoB,MAAZ,EAAkB,EAAS,GAAS,OAC5C,OAAQ,OACR,OAAQ,OAER,QAAqB,MAAZ,EAAkB,EAAS,GAAU,OAC9C,QAAqB,MAAZ,EAAkB,EAAS,GAAU,OAC9C,QAAS,AAAY,QAAM,EAAS,GAAU,OAC9C,QAAS,OACT,QAAS,OAET,YAAa,EAAS,GACtB,UAAW,EAAS,GACpB,OAAQ,EAAS,GAEjB,aAAc,IACd,OAAQ,KACR,OAAQ,QACR,OAAQ,QACR,OAAQ,QACR,OAAQ,QAER,QAAS,CACP,QAAS,EAAS,YAAY,EAAI,KAClC,UAAW,KACX,WAAY,KACZ,OAAQ,KACR,KAAM,KACN,OAAQ,KACR,OAAQ,KACR,aAAc,GAChB,EAEA,SAAU,CACR,CACE,QAAS,EACT,OAAQ,EACR,UAAW,EACX,OAAQ,EACR,IAAK,KACL,UAAW,EACX,IAAK,EACL,UAAW,EACX,IAAK,WAAW,EAAI,OAAO,CAAC,IAC5B,IAAK,EACL,QAAS,EAAS,GAClB,KAAM,EACN,MAAO,EACP,QAAS,KACT,QAAS,KACT,OAAQ,EACR,QAAS,EACT,QAAS,EACT,SAAU,EAAS,GACnB,OAAQ,EAAS,GACjB,OAAQ,EAAS,EACnB,EACD,AACH,EAEM,EAAa,CAAA,EAAA,EAAA,eAAA,AAAe,EAAC,EAAa,cAAc,CAAE,EAAa,WAAW,EAClF,EAAc,CAAA,EAAG,EAAW,oBAAoB,CAAC,CAEvD,QAAQ,GAAG,CAAC,CAAC,kCAAkC,EAAE,EAAA,CAAa,EAC9D,QAAQ,GAAG,CAAC,CAAC,gCAAgC,CAAC,CAAE,KAAK,SAAS,CAAC,EAAY,KAAM,IAGjF,IAAI,EAAiB,IAErB,GAAI,CACF,IAAM,EAAa,IAAI,gBACjB,EAAY,WAAW,IAAM,EAAW,KAAK,GAAI,KAEjD,EAAW,MAAM,MAAM,EAAa,CACxC,OAAQ,OACR,QAAS,CACP,eAAgB,mBAChB,OAAU,mBACV,GAAI,EAAa,YAAY,CAAG,CAAE,eAAkB,EAAa,YAAY,AAAC,EAAI,CAAC,CAAC,AACtF,EACA,KAAM,KAAK,SAAS,CAAC,GACrB,OAAQ,EAAW,MAAM,AAC3B,GAEA,aAAa,GACb,EAAiB,EAAS,MAAM,CAChC,EAAc,MAAM,EAAS,IAAI,GAEjC,QAAQ,GAAG,CAAC,CAAC,6BAA6B,EAAE,EAAS,MAAM,CAAA,CAAE,EAC7D,QAAQ,GAAG,CAAC,CAAC,iCAAiC,EAAE,EAAY,QAAQ,CAAA,CAAE,EACtE,QAAQ,GAAG,CAAC,CAAC,oCAAoC,EAAE,EAAY,SAAS,CAAA,CAAE,EAC1E,QAAQ,GAAG,CAAC,CAAC,8BAA8B,CAAC,CAAE,KAAK,SAAS,CAAC,EAAa,KAAM,GAClF,CAAE,MAAO,EAAiB,CACxB,EAAiB,EAEf,EADsB,cAAc,CAAlC,EAAW,IAAI,CACH,CACZ,SAAU,UACV,UAAW,qCACX,SAAU,IAAI,OAAO,WAAW,EAClC,EAEc,CACZ,SAAU,gBACV,UAAW,EAAW,OAAO,EAAI,mCACjC,SAAU,IAAI,OAAO,WAAW,EAClC,EAGF,QAAQ,GAAG,CAAC,CAAC,8BAA8B,CAAC,CAAE,EAAW,OAAO,EAChE,QAAQ,GAAG,CAAC,CAAC,yCAAyC,CAAC,CAAE,KAAK,SAAS,CAAC,EAAa,KAAM,GAC7F,CAEA,IAAM,EAAa,KAAK,GAAG,GAAK,EAC1B,EAAqC,QAAzB,EAAY,QAAQ,EAAuC,MAAzB,EAAY,QAAQ,CAaxE,GAXA,MAAM,CAAA,EAAA,EAAA,UAAA,AAAU,EAAC,CACf,SAAU,uBACV,OAAQ,OACR,QAAS,EACT,SAAU,EACV,WAAY,GAAkB,eAC9B,EACA,SAAU,EAAS,SAAS,CAC5B,iBAAkB,CACpB,GAEI,EAAW,CACb,QAAQ,GAAG,CAAC,CAAC,gEAAgE,CAAC,EAE9E,GAAI,CACF,IAAM,EAAkB,MAAM,CAAA,EAAA,EAAA,kBAAA,AAAkB,EAAC,EAAS,SAAS,CAAE,CAAC,CACpE,SAAU,EACV,cAAe,EACf,SAAU,EACV,YAAa,EACb,aAAc,EACd,SAAU,EACV,UAAW,EACX,QAAS,CACX,EAAE,EAEE,EAAgB,OAAO,CACzB,CAD2B,OACnB,GAAG,CAAC,CAAC,iDAAiD,CAAC,EAE/D,QAAQ,GAAG,CAAC,CAAC,mCAAmC,EAAE,EAAgB,KAAK,CAAA,CAAE,CAE7E,CAAE,MAAO,EAAiB,CACxB,QAAQ,KAAK,CAAC,CAAC,wCAAwC,CAAC,CAAE,EAAW,OAAO,CAC9E,CACF,CAEA,MAAO,CACL,QAAS,cACT,CACF,CAEF,CAAE,MAAO,EAAY,CACnB,IAAM,EAA6B,CACjC,SAAU,eACV,UAAW,EAAM,OAAO,EAAI,+BAC5B,SAAU,IAAI,OAAO,WAAW,EAClC,EAEA,QAAQ,KAAK,CAAC,CAAC,6BAA6B,CAAC,CAAE,GAE/C,IAAM,EAAa,KAAK,GAAG,GAAK,EAchC,OAZA,MAAM,CAAA,EAAA,EAAA,UAAA,AAAU,EAAC,CACf,SAAU,uBACV,OAAQ,OACR,QAAS,UAAE,EAAU,aAAc,8BAA+B,EAClE,SAAU,EACV,WAAY,eACZ,EACA,SAAU,EAAS,SAAS,CAC5B,MAAO,EAAM,OAAO,CACpB,iBAAkB,CAAA,EAAG,EAAgB,oBAAoB,CAC3D,AAD4D,GAGrD,CACL,SAAS,EACT,YAAa,EACb,MAAO,EAAM,OAAO,AACtB,CACF,CACF,CAEO,eAAe,EAAyB,CAAqB,EAKlE,OAAO,EAAiB,EAC1B,CAqBA,IAAM,EAA8C,CAClD,UAAa,KACb,WAAc,KACd,iBAAoB,KACpB,YAAe,KACf,UAAa,KACb,MAAS,IACX,EAEO,eAAe,EAAkB,CAA8B,EAOpE,IAAM,EAAY,KAAK,GAAG,GAE1B,GAAI,CACF,IAgII,EAhIE,EAAe,MAAM,EAAgB,EAAe,SAAS,EAEnE,GAAI,CAAC,EACH,MAAO,CAAE,KADQ,IACC,EAAO,YAAa,KAAM,MAAO,gCAAiC,EAGtF,GAAI,CAAC,EAAa,OAAO,CACvB,CADyB,KAClB,CACL,QAAS,GACT,YAAa,CACX,SAAU,eACV,UAAW,yCACX,SAAU,IAAI,OAAO,WAAW,EAClC,EACA,MAAO,wBACT,EAGF,IAAM,EAAS,MAAM,EAAiB,EAAe,SAAS,EACxD,EAAY,CAAC,EAAE,EAAE,EAAA,CAAQ,CAEzB,EAAM,IAAI,KACV,EAAQ,EAAkB,GAC1B,EAAU,EAAc,GAExB,EAAW,CAAmB,CAAC,EAAe,kBAAkB,EAAE,cAAc,EAAI,KAEtF,EAAe,EACf,EAAa,EACb,EAAS,EAEP,EAAW,EAAe,KAAK,CAAC,GAAG,CAAC,CAAC,EAAM,KAC/C,IAAM,EAAU,EAAK,QAAQ,CAAG,EAAK,KAAK,CACpC,EAAW,EAAU,KACrB,EAAS,EAAU,EAMzB,OAJA,GAAgB,EAChB,GAAc,EACd,GAAU,EAEH,CACL,QAAS,EAAQ,EACjB,OAAQ,EAAK,SAAS,CACtB,UAAW,EAAK,eAAe,EAAI,WACnC,OAAQ,EAAK,SAAS,CACtB,IAAK,KACL,UAAW,EAAK,YAAY,EAAI,KAChC,IAAK,EAAK,QAAQ,CAClB,UAAW,EAAK,aAAa,EAAI,IACjC,IAAK,EAAK,QAAQ,CAClB,IAAK,EAAK,KAAK,CACf,QAAS,EAAS,GAClB,KAAM,EACN,MAAO,EACP,QAAS,KACT,QAAS,KACT,OAAQ,KACR,QAAS,KACT,QAAS,EAAK,QAAQ,EAAI,IAC1B,SAAU,EAAS,GACnB,OAAQ,EAAS,GACjB,OAAQ,EAAS,EACnB,CACF,GAEM,EAAa,CACjB,IAAK,EAAa,OAAO,CACzB,MAAO,EAAa,MAAM,EAAI,KAC9B,UAAW,EACX,OAAQ,EACR,UAAW,EAAe,mBAAmB,CAC7C,QAAS,EAAe,YAAY,EAAI,KACxC,OAAQ,EAAe,aAAa,EAAI,mBACxC,UAAW,IACX,SAAU,IACV,QAAS,KACT,YAAa,KACb,MAAO,EACP,QAAS,EACT,WAAY,EACZ,UAAW,KACX,OAAQ,KACR,MAAO,EACP,SAAU,EACV,WAAY,EAAS,MAAM,CAC3B,UAAW,OACX,UAAW,EAAS,GACpB,UAAW,OACX,UAAW,OACX,UAAW,OACX,OAAQ,OACR,OAAQ,QACR,OAAQ,OACR,OAAQ,OACR,OAAQ,OACR,QAAS,OACT,QAAS,EAAS,GAClB,QAAS,OACT,QAAS,OACT,QAAS,OACT,YAAa,EAAS,GACtB,UAAW,EAAS,GACpB,OAAQ,EAAS,GACjB,aAAc,IACd,OAAQ,KACR,OAAQ,QACR,OAAQ,QACR,OAAQ,QACR,OAAQ,QACR,QAAS,CACP,QAAS,EAAe,YAAY,EAAI,KACxC,UAAW,KACX,WAAY,EACZ,OAAQ,KACR,KAAM,KACN,OAAQ,KACR,OAAQ,KACR,aAAc,GAChB,EACA,SAAU,CACZ,EAEM,EAAa,CAAA,EAAA,EAAA,eAAA,AAAe,EAAC,EAAa,cAAc,CAAE,EAAa,WAAW,EAClF,EAAc,CAAA,EAAG,EAAW,oBAAoB,CAAC,CAEvD,QAAQ,GAAG,CAAC,CAAC,wCAAwC,EAAE,EAAA,CAAa,EACpE,QAAQ,GAAG,CAAC,CAAC,sCAAsC,CAAC,CAAE,KAAK,SAAS,CAAC,EAAY,KAAM,IAGvF,IAAI,EAAiB,IAErB,GAAI,CACF,IAAM,EAAa,IAAI,gBACjB,EAAY,WAAW,IAAM,EAAW,KAAK,GAAI,KAEjD,EAAW,MAAM,MAAM,EAAa,CACxC,OAAQ,OACR,QAAS,CACP,eAAgB,mBAChB,OAAU,mBACV,GAAI,EAAa,YAAY,CAAG,CAAE,eAAkB,EAAa,YAAa,AAAD,EAAK,CAAC,CAAC,AACtF,EACA,KAAM,KAAK,SAAS,CAAC,GACrB,OAAQ,EAAW,MAAM,AAC3B,GAEA,aAAa,GACb,EAAiB,EAAS,MAAM,CAChC,EAAc,MAAM,EAAS,IAAI,GAEjC,QAAQ,GAAG,CAAC,CAAC,mCAAmC,EAAE,EAAS,MAAM,CAAA,CAAE,EACnE,QAAQ,GAAG,CAAC,CAAC,+BAA+B,CAAC,CAAE,KAAK,SAAS,CAAC,EAAa,KAAM,GACnF,CAAE,MAAO,EAAiB,CACxB,EAAiB,EACjB,EAAc,CACZ,SAA8B,eAApB,EAAW,IAAI,CAAoB,UAAY,gBACzD,UAAW,EAAW,OAAO,EAAI,mCACjC,SAAU,IAAI,OAAO,WAAW,EAClC,EACA,QAAQ,GAAG,CAAC,CAAC,oCAAoC,CAAC,CAAE,EAAW,OAAO,CACxE,CAEA,IAAM,EAAa,KAAK,GAAG,GAAK,CAEhC,OAAM,CAAA,EAAA,EAAA,UAAA,AAAU,EAAC,CACf,SAAU,uBACV,OAAQ,OACR,QAAS,EACT,SAAU,EACV,WAAY,GAAkB,eAC9B,EACA,SAAU,EAAe,SAAS,CAClC,iBAAkB,CACpB,GAEA,IAAM,EAAY,AAAyB,UAAb,QAAQ,EAAuC,MAAzB,EAAY,QAAQ,CAExE,GAAI,EAAW,CACb,QAAQ,GAAG,CAAC,CAAC,sFAAsF,CAAC,EAEpG,GAAI,CACF,IAAM,EAAa,EAAe,KAAK,CAAC,GAAG,CAAC,IAAS,CACnD,EADkD,OACxC,EAAK,SAAS,CACxB,cAAe,EAAK,eAAe,CACnC,SAAU,EAAK,SAAS,CACxB,YAAa,EAAK,YAAY,CAC9B,aAAc,EAAK,aAAa,CAChC,SAAU,EAAK,QAAQ,CACvB,UAAW,EAAK,KAAK,CACrB,QAAS,EAAK,QAAQ,CACxB,CAAC,EAEK,EAAkB,MAAM,CAAA,EAAA,EAAA,wBAAA,AAAwB,EAAC,EAAe,SAAS,CAAE,GAE7E,EAAgB,OAAO,CACzB,CAD2B,OACnB,GAAG,CAAC,CAAC,uEAAuE,CAAC,EAErF,QAAQ,GAAG,CAAC,CAAC,yDAAyD,EAAE,EAAgB,KAAK,CAAA,CAAE,CAEnG,CAAE,MAAO,EAAiB,CACxB,QAAQ,KAAK,CAAC,CAAC,8DAA8D,CAAC,CAAE,EAAW,OAAO,CACpG,CACF,CAEA,MAAO,CACL,QAAS,cACT,EACA,iBAAkB,EAClB,OAAQ,CACV,CAEF,CAAE,MAAO,EAAY,CAEnB,OADA,QAAQ,KAAK,CAAC,CAAC,mCAAmC,CAAC,CAAE,GAC9C,CACL,SAAS,EACT,YAAa,CACX,SAAU,eACV,UAAW,EAAM,OAAO,EAAI,+BAC5B,SAAU,IAAI,OAAO,WAAW,EAClC,EACA,MAAO,EAAM,OAAO,AACtB,CACF,CACF"}