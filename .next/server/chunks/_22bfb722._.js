module.exports=[82650,e=>e.a(async(t,a)=>{try{var r=e.i(89171),n=e.i(70038),o=e.i(90793),i=e.i(39298),s=t([n,o,i]);async function l(e){try{let t=await (0,o.query)(`
      SELECT id, name FROM branches 
      WHERE controller_id = $1
      LIMIT 1
    `,[e]),a=t.rows||t;if(a&&a.length>0)return console.log(`[PUMP CALLBACK] Found branch for controller ${e}: ${a[0].name}`),a[0];return console.log(`[PUMP CALLBACK] No branch found for controller ${e}`),null}catch(e){return console.error("[PUMP CALLBACK] Error finding branch by controller_id:",e.message),null}}async function c(e,t){try{let a=await l(e);if(a){let r=await (0,o.query)(`
        SELECT 
          m.id, m.pts_id, m.fuel_grade_id, m.fuel_grade_name, m.item_id,
          i.item_name, i.item_code, $2::uuid as branch_id,
          bi.sale_price
        FROM pump_fuel_grade_mappings m
        JOIN items i ON m.item_id = i.id
        LEFT JOIN branch_items bi ON i.id = bi.item_id AND bi.branch_id = $2 AND bi.is_available = true
        WHERE m.fuel_grade_id = $1 AND m.is_active = true AND m.item_id IS NOT NULL
          AND (m.pts_id IS NULL OR m.pts_id = $3)
        ORDER BY CASE WHEN m.pts_id = $3 THEN 0 ELSE 1 END
        LIMIT 1
      `,[t,a.id,e]),n=r.rows||r;if(n&&n.length>0){let e=n[0];return console.log(`[PUMP CALLBACK] Found mapping for fuel grade ${t} using branch ${a.name}`),e.sale_price||console.log(`[PUMP CALLBACK] WARNING: No branch_items price configured for item ${e.item_name} at branch ${a.id}`),{...e,branch_id:a.id}}}let r=await (0,o.query)(`
      SELECT 
        m.id, m.pts_id, m.fuel_grade_id, m.fuel_grade_name, m.item_id,
        i.item_name, i.item_code, i.branch_id,
        bi.sale_price
      FROM pump_fuel_grade_mappings m
      JOIN items i ON m.item_id = i.id
      LEFT JOIN branch_items bi ON i.id = bi.item_id AND bi.branch_id = i.branch_id AND bi.is_available = true
      WHERE m.pts_id = $1 AND m.fuel_grade_id = $2 AND m.is_active = true 
        AND m.item_id IS NOT NULL AND i.branch_id IS NOT NULL
      LIMIT 1
    `,[e,t]),n=r.rows||r;if(n&&n.length>0){let e=n[0];return console.log(`[PUMP CALLBACK] Found controller-specific mapping for fuel grade ${t} with branch ${e.branch_id}`),e.sale_price||console.log(`[PUMP CALLBACK] WARNING: No branch_items price configured for item ${e.item_name}`),e}if(!a)return console.log(`[PUMP CALLBACK] No branch found for controller ${e} and no branch-specific mapping available`),null;return console.log(`[PUMP CALLBACK] No mapping found for fuel grade ${t}`),null}catch(e){return console.error("[PUMP CALLBACK] Error finding fuel grade mapping:",e.message),null}}async function d(e,t,a){try{console.log(`[PUMP CALLBACK] Checking fuel grade mapping for fuel grade ID: ${t.FuelGradeId}`);let r=await c(e,t.FuelGradeId);if(!r)return void console.log("[PUMP CALLBACK] No fuel grade mapping found - skipping KRA sale creation");console.log(`[PUMP CALLBACK] Found mapping: ${r.fuel_grade_name} -> ${r.item_name} (Branch: ${r.branch_id})`);let n=await (0,o.query)(`
      SELECT id, tank_name, kra_item_cd FROM tanks 
      WHERE branch_id = $1 AND fuel_type ILIKE $2 AND status = 'active' 
      ORDER BY current_stock DESC LIMIT 1
    `,[r.branch_id,`%${r.item_name}%`]),s=(n.rows||n)[0];s||console.log(`[PUMP CALLBACK] No active tank found for ${r.item_name} in branch ${r.branch_id}`);let l=`PTS-${e}-${t.Transaction}`,d=`RCP-${Date.now().toString(36).toUpperCase()}`,u=t.Price||r.sale_price,p=t.Volume||0;if(!u||u<=0){console.error(`[PUMP CALLBACK] ERROR: No valid price available for ${r.item_name}`),console.error(`[PUMP CALLBACK] Callback price: ${t.Price}, Branch items price: ${r.sale_price}`),console.error("[PUMP CALLBACK] Please configure pricing in Inventory Management for this item at this branch");return}let m=t.Amount||p*u;console.log("[PUMP CALLBACK] Creating KRA sale:"),console.log(`  - Invoice: ${l}`),console.log(`  - Fuel: ${r.item_name}`),console.log(`  - Quantity: ${p}L @ KES ${u}`),console.log(`  - Total: KES ${m}`);let _=await (0,i.callKraSaveSales)({branch_id:r.branch_id,invoice_number:l,receipt_number:d,fuel_type:r.item_name,quantity:p,unit_price:u,total_amount:m,payment_method:"cash",customer_name:"Walk-in Customer",customer_pin:"",sale_date:new Date().toISOString(),tank_id:s?.id||null}),g=await (0,o.query)(`
      INSERT INTO sales (
        branch_id, fuel_type, quantity, unit_price, total_amount,
        payment_method, customer_name, invoice_number, receipt_number,
        transmission_status, kra_status, is_automated, source_system, sale_date, created_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, NOW(), NOW())
      RETURNING id
    `,[r.branch_id,r.item_name,p,u,m,"cash","Walk-in Customer (PTS)",l,d,_.success?"transmitted":"pending",_.success?"success":"pending",!0,"PTS"]),P=(g.rows||g)[0]?.id;if(await (0,o.query)(`
      UPDATE pump_transactions SET processed = true, sale_id = $1 WHERE id = $2
    `,[P,a]),_.success&&_.kraResponse?.data){let e=_.kraResponse.data;await (0,o.query)(`
        UPDATE sales SET 
          kra_rcpt_sign = $1, kra_scu_id = $2, kra_cu_inv = $3, kra_internal_data = $4
        WHERE id = $5
      `,[e.rcptSign||"",e.sdcId||"",`${e.sdcId}/${e.rcptNo}`,e.intrlData||"",P]),console.log(`[PUMP CALLBACK] KRA sale created successfully - Receipt: ${e.rcptNo}`)}else console.log(`[PUMP CALLBACK] KRA sale pending - ${_.error||"No KRA response"}`);s&&p>0&&(await (0,o.query)(`
        UPDATE tanks SET current_stock = GREATEST(0, current_stock - $1), updated_at = NOW() WHERE id = $2
      `,[p,s.id]),console.log(`[PUMP CALLBACK] Deducted ${p}L from tank ${s.tank_name}`))}catch(e){console.error("[PUMP CALLBACK] Error creating KRA sale:",e.message)}}async function u(e){try{let t=await e.json();console.log("=".repeat(60)),console.log("[PUMP CALLBACK] Received payload at:",new Date().toISOString()),console.log("[PUMP CALLBACK] Protocol:",t.Protocol),console.log("[PUMP CALLBACK] PtsId:",t.PtsId),console.log("[PUMP CALLBACK] Packets count:",t.Packets?.length||0),console.log("[PUMP CALLBACK] Full payload:",JSON.stringify(t,null,2)),console.log("=".repeat(60));let a=[];for(let e of t.Packets||[])a.push({Id:e.Id,Message:"OK",Type:e.Type});let n={Protocol:t.Protocol||"jsonPTS",Packets:a},i=await (0,o.query)(`
      INSERT INTO pump_callback_events (pts_id, raw_request, raw_response)
      VALUES ($1, $2, $3)
      RETURNING id
    `,[t.PtsId,JSON.stringify(t),JSON.stringify(n)]),s=(i.rows||i)[0]?.id;for(let e of t.Packets||[])if(console.log(`[PUMP CALLBACK] Processing packet Id: ${e.Id}, Type: ${e.Type}`),"UploadPumpTransaction"===e.Type&&e.Data){let a=e.Data;console.log("[PUMP CALLBACK] Transaction details:"),console.log(`  - Pump: ${a.Pump}, Nozzle: ${a.Nozzle}`),console.log(`  - Fuel: ${a.FuelGradeName} (ID: ${a.FuelGradeId})`),console.log(`  - Volume: ${a.Volume}L, Amount: KES ${a.Amount}`),console.log(`  - Price: KES ${a.Price}`),console.log(`  - Transaction ID: ${a.Transaction}`),console.log(`  - DateTime: ${a.DateTime}`);try{let r=await (0,o.query)(`
            INSERT INTO pump_transactions (
              packet_id, pts_id, pump_number, nozzle_number, 
              fuel_grade_id, fuel_grade_name, transaction_id,
              volume, tc_volume, price, amount,
              total_volume, total_amount, tag, user_id,
              configuration_id, transaction_start, transaction_end,
              callback_event_id, raw_packet, created_at
            ) VALUES (
              $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, NOW()
            )
            ON CONFLICT (pts_id, transaction_id) DO UPDATE SET
              callback_event_id = EXCLUDED.callback_event_id,
              raw_packet = EXCLUDED.raw_packet
            RETURNING id, processed
          `,[e.Id,t.PtsId,a.Pump,a.Nozzle,a.FuelGradeId,a.FuelGradeName,a.Transaction,a.Volume,a.TCVolume,a.Price,a.Amount,a.TotalVolume,a.TotalAmount,a.Tag,a.UserId,a.ConfigurationId,a.DateTimeStart,a.DateTime,s,JSON.stringify(e)]),n=(r.rows||r)[0],i=n?.id,l=n?.processed===!0;console.log(`[PUMP CALLBACK] Transaction ${a.Transaction} saved to database (id: ${i})`),l?console.log(`[PUMP CALLBACK] Transaction ${a.Transaction} already processed, skipping KRA sale creation`):await d(t.PtsId,a,i)}catch(e){console.error("[PUMP CALLBACK] Database error:",e.message)}}return console.log("[PUMP CALLBACK] Sending response:",JSON.stringify(n,null,2)),console.log("=".repeat(60)),r.NextResponse.json(n)}catch(e){return console.error("[PUMP CALLBACK] Error processing callback:",e.message),console.error("[PUMP CALLBACK] Stack:",e.stack),r.NextResponse.json({Protocol:"jsonPTS",Packets:[{Id:0,Message:"ERROR",Type:"Error"}]},{status:500})}}async function p(){return r.NextResponse.json({status:"active",endpoint:"/api/pump-callback",description:"Pump transaction callback endpoint for automated sales",expectedPayload:{Protocol:"jsonPTS",PtsId:"string",Packets:[{Id:"number",Type:"UploadPumpTransaction",Data:{Pump:"number",Nozzle:"number",FuelGradeName:"string",Volume:"number",Amount:"number"}}]}})}[n,o,i]=s.then?(await s)():s,e.s(["GET",()=>p,"POST",()=>u]),a()}catch(e){a(e)}},!1),19794,e=>e.a(async(t,a)=>{try{var r=e.i(47909),n=e.i(74017),o=e.i(96250),i=e.i(59756),s=e.i(61916),l=e.i(14444),c=e.i(37092),d=e.i(69741),u=e.i(16795),p=e.i(87718),m=e.i(95169),_=e.i(47587),g=e.i(66012),P=e.i(70101),A=e.i(26937),C=e.i(10372),h=e.i(93695);e.i(52474);var f=e.i(220),$=e.i(82650),E=t([$]);[$]=E.then?(await E)():E;let N=new r.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/pump-callback/route",pathname:"/api/pump-callback",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/pump-callback/route.ts",nextConfigOutput:"standalone",userland:$}),{workAsyncStorage:b,workUnitAsyncStorage:T,serverHooks:y}=N;function R(){return(0,o.patchFetch)({workAsyncStorage:b,workUnitAsyncStorage:T})}async function L(e,t,a){N.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/pump-callback/route";r=r.replace(/\/index$/,"")||"/";let o=await N.prepare(e,t,{srcPage:r,multiZoneDraftMode:!1});if(!o)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:$,params:E,nextConfig:R,parsedUrl:L,isDraftMode:b,prerenderManifest:T,routerServerContext:y,isOnDemandRevalidate:v,revalidateOnlyGenerated:I,resolvedPathname:U,clientReferenceManifest:w,serverActionsManifest:S}=o,k=(0,d.normalizeAppPath)(r),M=!!(T.dynamicRoutes[k]||T.routes[U]),O=async()=>((null==y?void 0:y.render404)?await y.render404(e,t,L,!1):t.end("This page could not be found"),null);if(M&&!b){let e=!!T.routes[U],t=T.dynamicRoutes[k];if(t&&!1===t.fallback&&!e){if(R.experimental.adapterPath)return await O();throw new h.NoFallbackError}}let K=null;!M||N.isDev||b||(K=U,K="/index"===K?"/":K);let D=!0===N.isDev||!M,B=M&&!D;S&&w&&(0,l.setReferenceManifestsSingleton)({page:r,clientReferenceManifest:w,serverActionsManifest:S,serverModuleMap:(0,c.createServerModuleMap)({serverActionsManifest:S})});let x=e.method||"GET",F=(0,s.getTracer)(),q=F.getActiveScopeSpan(),H={params:E,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!R.experimental.authInterrupts},cacheComponents:!!R.cacheComponents,supportsDynamicResponse:D,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:R.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r)=>N.onRequestError(e,t,r,y)},sharedContext:{buildId:$}},W=new u.NodeNextRequest(e),G=new u.NodeNextResponse(t),j=p.NextRequestAdapter.fromNodeNextRequest(W,(0,p.signalFromNodeResponse)(t));try{let o=async e=>N.handle(j,H).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=F.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=a.get("next.route");if(n){let t=`${x} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${x} ${r}`)}),l=!!(0,i.getRequestMeta)(e,"minimalMode"),c=async i=>{var s,c;let d=async({previousCacheEntry:n})=>{try{if(!l&&v&&I&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await o(i);e.fetchMetrics=H.renderOpts.fetchMetrics;let s=H.renderOpts.pendingWaitUntil;s&&a.waitUntil&&(a.waitUntil(s),s=void 0);let c=H.renderOpts.collectedTags;if(!M)return await (0,g.sendResponse)(W,G,r,H.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,P.toNodeOutgoingHttpHeaders)(r.headers);c&&(t[C.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==H.renderOpts.collectedRevalidate&&!(H.renderOpts.collectedRevalidate>=C.INFINITE_CACHE)&&H.renderOpts.collectedRevalidate,n=void 0===H.renderOpts.collectedExpire||H.renderOpts.collectedExpire>=C.INFINITE_CACHE?void 0:H.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:n}}}}catch(t){throw(null==n?void 0:n.isStale)&&await N.onRequestError(e,t,{routerKind:"App Router",routePath:r,routeType:"route",revalidateReason:(0,_.getRevalidateReason)({isStaticGeneration:B,isOnDemandRevalidate:v})},y),t}},u=await N.handleResponse({req:e,nextConfig:R,cacheKey:K,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:v,revalidateOnlyGenerated:I,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:l});if(!M)return null;if((null==u||null==(s=u.value)?void 0:s.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(c=u.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",v?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),b&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,P.fromNodeOutgoingHttpHeaders)(u.value.headers);return l&&M||p.delete(C.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,A.getCacheControlHeader)(u.cacheControl)),await (0,g.sendResponse)(W,G,new Response(u.value.body,{headers:p,status:u.value.status||200})),null};q?await c(q):await F.withPropagatedContext(e.headers,()=>F.trace(m.BaseServerSpan.handleRequest,{spanName:`${x} ${r}`,kind:s.SpanKind.SERVER,attributes:{"http.method":x,"http.target":e.url}},c))}catch(t){if(t instanceof h.NoFallbackError||await N.onRequestError(e,t,{routerKind:"App Router",routePath:k,routeType:"route",revalidateReason:(0,_.getRevalidateReason)({isStaticGeneration:B,isOnDemandRevalidate:v})}),M)throw t;return await (0,g.sendResponse)(W,G,new Response(null,{status:500})),null}}e.s(["handler",()=>L,"patchFetch",()=>R,"routeModule",()=>N,"serverHooks",()=>y,"workAsyncStorage",()=>b,"workUnitAsyncStorage",()=>T]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=_22bfb722._.js.map