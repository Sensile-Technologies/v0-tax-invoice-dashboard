module.exports=[69580,e=>e.a(async(t,r)=>{try{var s=e.i(89171),n=e.i(30056),a=e.i(93458),i=t([n]);[n]=i.then?(await i)():i;let c=new n.Pool({connectionString:process.env.DATABASE_URL});async function o(){let e=(await (0,a.cookies)()).get("user_session");if(!e)return null;try{return JSON.parse(e.value)}catch{return null}}async function u(e){try{let e=await o();if(!e)return s.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let t=await c.connect();try{let r=await t.query(`SELECT u.id, u.role as user_role, s.role as staff_role, v.id as vendor_id
         FROM users u
         LEFT JOIN vendors v ON v.email = u.email
         LEFT JOIN staff s ON s.user_id = u.id
         LEFT JOIN branches b ON b.id = s.branch_id
         WHERE u.id = $1`,[e.id]);if(0===r.rows.length)return s.NextResponse.json({success:!1,error:"User not found"},{status:404});let n=r.rows[0],a=n.vendor_id||(await t.query("SELECT vendor_id FROM branches b JOIN staff s ON s.branch_id = b.id WHERE s.user_id = $1 LIMIT 1",[e.id])).rows[0]?.vendor_id;if(!(["director","vendor"].includes(n.user_role)||n.staff_role&&"director"===n.staff_role.toLowerCase()))return s.NextResponse.json({success:!1,error:"Access denied. HQ access required."},{status:403});if(!a)return s.NextResponse.json({success:!1,error:"Vendor not found"},{status:404});let i=await t.query(`SELECT i.*, 
         b.name as branch_name,
         (SELECT COUNT(*) FROM branch_items bi WHERE bi.item_id = i.id) as assigned_branches
         FROM items i 
         LEFT JOIN branches b ON i.branch_id = b.id
         WHERE i.vendor_id = $1 OR i.branch_id IN (SELECT id FROM branches WHERE vendor_id = $1)
         ORDER BY i.created_at DESC`,[a]);return s.NextResponse.json({success:!0,items:i.rows})}finally{t.release()}}catch(e){return console.error("Error fetching HQ items:",e),s.NextResponse.json({success:!1,error:"Failed to fetch items"},{status:500})}}async function d(e){let t=await c.connect();try{let r,n=await o();if(!n)return s.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let a=await t.query(`SELECT u.id, u.role as user_role, s.role as staff_role, v.id as vendor_id
       FROM users u
       LEFT JOIN vendors v ON v.email = u.email
       LEFT JOIN staff s ON s.user_id = u.id
       WHERE u.id = $1`,[n.id]);if(0===a.rows.length)return s.NextResponse.json({success:!1,error:"User not found"},{status:404});let i=a.rows[0],u=i.vendor_id||(await t.query("SELECT vendor_id FROM branches b JOIN staff s ON s.branch_id = b.id WHERE s.user_id = $1 LIMIT 1",[n.id])).rows[0]?.vendor_id;if(!(["director","vendor"].includes(i.user_role)||i.staff_role&&"director"===i.staff_role.toLowerCase()))return s.NextResponse.json({success:!1,error:"Access denied. Only HQ can create items."},{status:403});if(!u)return s.NextResponse.json({success:!1,error:"Vendor not found"},{status:404});let{itemName:d,description:l,itemType:c,classCode:p,taxType:E,origin:R,batchNumber:h,sku:f,quantityUnit:v,packageUnit:w}=await e.json();if(!d||!c||!p||!E||!R||!v||!w)return s.NextResponse.json({success:!1,error:"Missing required fields"},{status:400});await t.query("BEGIN");let N=await t.query("SELECT item_count FROM vendors WHERE id = $1 FOR UPDATE",[u]);if(0===N.rows.length)return await t.query("ROLLBACK"),s.NextResponse.json({success:!1,error:"Vendor not found"},{status:404});let _=(N.rows[0].item_count||0)+1,m=(r=String(_).padStart(7,"0"),`${R}${c}${w}${v}${r}`);if((await t.query("SELECT id FROM items WHERE item_code = $1 AND vendor_id = $2",[m,u])).rows.length>0)return await t.query("ROLLBACK"),s.NextResponse.json({success:!1,error:"Item code already exists. Please try again."},{status:409});let O=await t.query(`INSERT INTO items (
        vendor_id, branch_id, item_code, item_name, description,
        item_type, class_code, tax_type, origin, batch_number,
        sku, quantity_unit, package_unit,
        status, created_at, updated_at
      ) VALUES (
        $1, NULL, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12,
        'active', NOW(), NOW()
      ) RETURNING *`,[u,m,d,l||null,c,p,E,R,h||null,f||null,v,w]);return await t.query("UPDATE vendors SET item_count = $1 WHERE id = $2",[_,u]),await t.query("COMMIT"),s.NextResponse.json({success:!0,item:O.rows[0],itemCode:m,message:`Item created successfully with code: ${m}`})}catch(e){return await t.query("ROLLBACK"),console.error("Error creating HQ item:",e),s.NextResponse.json({success:!1,error:"Failed to create item"},{status:500})}finally{t.release()}}async function l(e){let t=await c.connect();try{let r=await o();if(!r)return s.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let n=await t.query(`SELECT u.id, COALESCE(s.role, u.role) as role, v.id as vendor_id
       FROM users u
       LEFT JOIN vendors v ON v.email = u.email
       LEFT JOIN staff s ON s.user_id = u.id
       WHERE u.id = $1`,[r.id]);if(0===n.rows.length)return s.NextResponse.json({success:!1,error:"User not found"},{status:404});let a=n.rows[0],i=a.vendor_id||(await t.query("SELECT vendor_id FROM branches b JOIN staff s ON s.branch_id = b.id WHERE s.user_id = $1 LIMIT 1",[r.id])).rows[0]?.vendor_id;if(!["director","vendor"].includes(a.role))return s.NextResponse.json({success:!1,error:"Access denied. Only HQ can edit items."},{status:403});if(!i)return s.NextResponse.json({success:!1,error:"Vendor not found"},{status:404});let{id:u,itemName:d,description:l,status:c}=await e.json();if(!u)return s.NextResponse.json({success:!1,error:"Item ID required"},{status:400});let p=await t.query("SELECT id FROM items WHERE id = $1 AND vendor_id = $2",[u,i]);if(0===p.rows.length)return s.NextResponse.json({success:!1,error:"Item not found"},{status:404});let E=await t.query(`UPDATE items SET
        item_name = COALESCE($1, item_name),
        description = COALESCE($2, description),
        status = COALESCE($3, status),
        updated_at = NOW()
      WHERE id = $4 AND vendor_id = $5
      RETURNING *`,[d,l,c,u,i]);return s.NextResponse.json({success:!0,item:E.rows[0]})}catch(e){return console.error("Error updating HQ item:",e),s.NextResponse.json({success:!1,error:"Failed to update item"},{status:500})}finally{t.release()}}e.s(["GET",()=>u,"POST",()=>d,"PUT",()=>l]),r()}catch(e){r(e)}},!1),84501,e=>e.a(async(t,r)=>{try{var s=e.i(47909),n=e.i(74017),a=e.i(96250),i=e.i(59756),o=e.i(61916),u=e.i(14444),d=e.i(37092),l=e.i(69741),c=e.i(16795),p=e.i(87718),E=e.i(95169),R=e.i(47587),h=e.i(66012),f=e.i(70101),v=e.i(26937),w=e.i(10372),N=e.i(93695);e.i(52474);var _=e.i(220),m=e.i(69580),O=t([m]);[m]=O.then?(await O)():O;let T=new s.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/headquarters/items/route",pathname:"/api/headquarters/items",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/headquarters/items/route.ts",nextConfigOutput:"standalone",userland:m}),{workAsyncStorage:x,workUnitAsyncStorage:g,serverHooks:b}=T;function y(){return(0,a.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:g})}async function C(e,t,r){T.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let s="/api/headquarters/items/route";s=s.replace(/\/index$/,"")||"/";let a=await T.prepare(e,t,{srcPage:s,multiZoneDraftMode:!1});if(!a)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:m,params:O,nextConfig:y,parsedUrl:C,isDraftMode:x,prerenderManifest:g,routerServerContext:b,isOnDemandRevalidate:A,revalidateOnlyGenerated:S,resolvedPathname:$,clientReferenceManifest:I,serverActionsManifest:L}=a,q=(0,l.normalizeAppPath)(s),H=!!(g.dynamicRoutes[q]||g.routes[$]),M=async()=>((null==b?void 0:b.render404)?await b.render404(e,t,C,!1):t.end("This page could not be found"),null);if(H&&!x){let e=!!g.routes[$],t=g.dynamicRoutes[q];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await M();throw new N.NoFallbackError}}let j=null;!H||T.isDev||x||(j=$,j="/index"===j?"/":j);let F=!0===T.isDev||!H,U=H&&!F;L&&I&&(0,u.setReferenceManifestsSingleton)({page:s,clientReferenceManifest:I,serverActionsManifest:L,serverModuleMap:(0,d.createServerModuleMap)({serverActionsManifest:L})});let P=e.method||"GET",D=(0,o.getTracer)(),W=D.getActiveScopeSpan(),k={params:O,prerenderManifest:g,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:F,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,s)=>T.onRequestError(e,t,s,b)},sharedContext:{buildId:m}},J=new c.NodeNextRequest(e),B=new c.NodeNextResponse(t),K=p.NextRequestAdapter.fromNodeNextRequest(J,(0,p.signalFromNodeResponse)(t));try{let a=async e=>T.handle(K,k).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=D.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==E.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${P} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${P} ${s}`)}),u=!!(0,i.getRequestMeta)(e,"minimalMode"),d=async i=>{var o,d;let l=async({previousCacheEntry:n})=>{try{if(!u&&A&&S&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await a(i);e.fetchMetrics=k.renderOpts.fetchMetrics;let o=k.renderOpts.pendingWaitUntil;o&&r.waitUntil&&(r.waitUntil(o),o=void 0);let d=k.renderOpts.collectedTags;if(!H)return await (0,h.sendResponse)(J,B,s,k.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(s.headers);d&&(t[w.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==k.renderOpts.collectedRevalidate&&!(k.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&k.renderOpts.collectedRevalidate,n=void 0===k.renderOpts.collectedExpire||k.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:k.renderOpts.collectedExpire;return{value:{kind:_.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==n?void 0:n.isStale)&&await T.onRequestError(e,t,{routerKind:"App Router",routePath:s,routeType:"route",revalidateReason:(0,R.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:A})},b),t}},c=await T.handleResponse({req:e,nextConfig:y,cacheKey:j,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:g,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:S,responseGenerator:l,waitUntil:r.waitUntil,isMinimalMode:u});if(!H)return null;if((null==c||null==(o=c.value)?void 0:o.kind)!==_.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(d=c.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});u||t.setHeader("x-nextjs-cache",A?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,f.fromNodeOutgoingHttpHeaders)(c.value.headers);return u&&H||p.delete(w.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,v.getCacheControlHeader)(c.cacheControl)),await (0,h.sendResponse)(J,B,new Response(c.value.body,{headers:p,status:c.value.status||200})),null};W?await d(W):await D.withPropagatedContext(e.headers,()=>D.trace(E.BaseServerSpan.handleRequest,{spanName:`${P} ${s}`,kind:o.SpanKind.SERVER,attributes:{"http.method":P,"http.target":e.url}},d))}catch(t){if(t instanceof N.NoFallbackError||await T.onRequestError(e,t,{routerKind:"App Router",routePath:q,routeType:"route",revalidateReason:(0,R.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:A})}),H)throw t;return await (0,h.sendResponse)(J,B,new Response(null,{status:500})),null}}e.s(["handler",()=>C,"patchFetch",()=>y,"routeModule",()=>T,"serverHooks",()=>b,"workAsyncStorage",()=>x,"workUnitAsyncStorage",()=>g]),r()}catch(e){r(e)}},!1)];

//# sourceMappingURL=_c95be4e9._.js.map