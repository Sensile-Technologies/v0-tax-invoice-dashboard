module.exports=[99745,t=>t.a(async(e,r)=>{try{var n=t.i(70038),s=t.i(90793),o=t.i(57902),a=e([n,s,o]);[n,s,o]=a.then?(await a)():a;let S="http://20.224.40.56:8088";async function l(t){let e=await (0,s.query)(`
    SELECT kra_pin as tin, bhf_id 
    FROM branches 
    WHERE id = $1
  `,[t]);return 0!==e.length&&e[0].tin?{tin:e[0].tin,bhfId:e[0].bhf_id||"00"}:null}async function c(t){let e=await (0,s.query)(`
    UPDATE branches 
    SET sr_number = COALESCE(sr_number, 0) + 1,
        updated_at = NOW()
    WHERE id = $1
    RETURNING sr_number
  `,[t]);if(0===e.length)throw Error(`Branch ${t} not found`);return e[0].sr_number}function i(t){return(Math.round(100*t)/100).toFixed(2)}async function u(t,e,r){let n,s=Date.now(),a=await l(t);if(!a)return{success:!1,response:{resultCd:"CONFIG_ERROR",resultMsg:"Branch KRA info not configured"},sarNo:0};let u=await c(t),d=0,m=0,A=0,g=r.map((t,e)=>{let r=Math.round(t.quantity*t.unitPrice*100)/100,n=function(t,e="B"){return"B"===e?Math.round(.16*t*100)/100:"A"===e?Math.round(t/1.16*16)/100:"C"===e?Math.round(.08*t*100)/100:0}(r,t.taxType);return d+=r,m+=n,A+=r,{itemSeq:e+1,itemCd:t.itemCode,itemClsCd:t.itemClassCode||"15100000",itemNm:t.itemName,bcd:null,pkgUnitCd:t.packageUnit||"NT",pkg:Math.ceil(t.quantity),qtyUnitCd:t.quantityUnit||"LTR",qty:parseFloat(t.quantity.toFixed(2)),itemExprDt:null,prc:t.unitPrice,splyAmt:i(r),totDcAmt:0,taxblAmt:i(r),taxTyCd:t.taxType||"B",taxAmt:i(n),totAmt:i(r)}}),p={tin:a.tin,bhfId:a.bhfId,sarNo:u,orgSarNo:0,regTyCd:"M",custTin:null,custNm:null,custBhfId:null,sarTyCd:e,ocrnDt:function(t=new Date){let e=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0");return`${e}${r}${n}`}(),totItemCnt:g.length,totTaxblAmt:i(d),totTaxAmt:i(m),totAmt:i(A),remark:null,regrId:"Admin",regrNm:"Admin",modrNm:"Admin",modrId:"Admin",itemList:g};console.log(`[KRA Stock Sync] Calling saveStockItems with sarTyCd=${e}`),console.log("[KRA Stock Sync] Payload:",JSON.stringify(p,null,2));let R=200;try{let t=new AbortController,e=setTimeout(()=>t.abort(),15e3),r=await fetch(`${S}/stock/saveStockItems`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p),signal:t.signal});clearTimeout(e),R=r.status,n=await r.json()}catch(t){n={resultCd:"AbortError"===t.name?"TIMEOUT":"NETWORK_ERROR",resultMsg:t.message||"Failed to connect to KRA",resultDt:new Date().toISOString()},R=0}let y=Date.now()-s;return console.log(`[KRA Stock Sync] saveStockItems response (${y}ms):`,JSON.stringify(n,null,2)),await (0,o.logApiCall)({endpoint:"/stock/saveStockItems",method:"POST",payload:p,response:n,statusCode:R,durationMs:y,branchId:t,externalEndpoint:`${S}/stock/saveStockItems`}),{success:n?.resultCd==="000"||n?.resultCd==="0",response:n,sarNo:u}}async function d(t,e){let r,n=Date.now(),a=await l(t);if(!a)return{success:!1,response:{resultCd:"CONFIG_ERROR",resultMsg:"Branch KRA info not configured"}};let c=await (0,s.query)(`
    SELECT t.current_stock 
    FROM tanks t
    JOIN items i ON UPPER(t.fuel_type) = UPPER(i.item_name) AND i.branch_id = t.branch_id
    WHERE i.item_code = $1 AND t.branch_id = $2
    LIMIT 1
  `,[e,t]),i=c.length>0&&parseFloat(c[0].current_stock)||0,u={tin:a.tin,bhfId:a.bhfId,itemCd:e,rsdQty:i,regrId:"Admin",regrNm:"Admin",modrNm:"Admin",modrId:"Admin"};console.log(`[KRA Stock Sync] Calling saveStockMaster for item ${e}`),console.log("[KRA Stock Sync] Payload:",JSON.stringify(u,null,2));let d=200;try{let t=new AbortController,e=setTimeout(()=>t.abort(),15e3),n=await fetch(`${S}/stockMaster/saveStockMaster`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(u),signal:t.signal});clearTimeout(e),d=n.status,r=await n.json()}catch(t){r={resultCd:"AbortError"===t.name?"TIMEOUT":"NETWORK_ERROR",resultMsg:t.message||"Failed to connect to KRA",resultDt:new Date().toISOString()},d=0}let m=Date.now()-n;return console.log(`[KRA Stock Sync] saveStockMaster response for ${e} (${m}ms):`,JSON.stringify(r,null,2)),await (0,o.logApiCall)({endpoint:"/stockMaster/saveStockMaster",method:"POST",payload:u,response:r,statusCode:d,durationMs:m,branchId:t,externalEndpoint:`${S}/stockMaster/saveStockMaster`}),{success:r?.resultCd==="000"||r?.resultCd==="0",response:r}}async function m(t,e){try{console.log(`[KRA Stock Sync] Starting stock sync after sale for branch ${t}`);let r=await u(t,"11",e);if(!r.success)return console.log("[KRA Stock Sync] saveStockItems failed, skipping saveStockMaster"),{success:!1,saveStockItemsResponse:r.response,error:r.response?.resultMsg||"saveStockItems failed"};let n=[];for(let r of e){let e=await d(t,r.itemCode);n.push({itemCode:r.itemCode,...e})}return console.log("[KRA Stock Sync] Stock sync after sale completed successfully"),{success:!0,saveStockItemsResponse:r.response,saveStockMasterResponses:n}}catch(t){return console.error("[KRA Stock Sync] Error during stock sync after sale:",t),{success:!1,error:t.message||"Internal error during stock sync"}}}async function A(t,e){try{console.log(`[KRA Stock Sync] Starting stock sync after credit note for branch ${t}`);let r=await u(t,"03",e);if(!r.success)return console.log("[KRA Stock Sync] saveStockItems failed for credit note, skipping saveStockMaster"),{success:!1,saveStockItemsResponse:r.response,error:r.response?.resultMsg||"saveStockItems failed"};let n=[];for(let r of e){let e=await d(t,r.itemCode);n.push({itemCode:r.itemCode,...e})}return console.log("[KRA Stock Sync] Stock sync after credit note completed successfully"),{success:!0,saveStockItemsResponse:r.response,saveStockMasterResponses:n}}catch(t){return console.error("[KRA Stock Sync] Error during stock sync after credit note:",t),{success:!1,error:t.message||"Internal error during stock sync"}}}t.s(["syncStockAfterCreditNote",()=>A,"syncStockAfterSale",()=>m]),r()}catch(t){r(t)}},!1),39298,t=>t.a(async(e,r)=>{try{var n=t.i(70038),s=t.i(90793),o=t.i(57902),a=t.i(99745),l=e([n,s,o,a]);[n,s,o,a]=l.then?(await l)():l;let R="http://20.224.40.56:8088",y={cash:"01",credit:"02",mobile_money:"03",mpesa:"03",bank_transfer:"04",card:"05",cheque:"06",other:"07"};async function c(t){try{let e=await (0,s.query)(`
      SELECT id, bhf_id, kra_pin, device_token, server_address, server_port, COALESCE(invoice_number, 0) as invoice_number
      FROM branches
      WHERE id = $1
    `,[t]);if(0===e.length)return null;return e[0]}catch(t){return console.error("[KRA Sales API] Error fetching branch config:",t),null}}async function i(t){let e=await (0,s.query)(`
    UPDATE branches 
    SET invoice_number = COALESCE(invoice_number, 0) + 1 
    WHERE id = $1 
    RETURNING invoice_number
  `,[t]);return e[0]?.invoice_number||1}async function u(t,e){let r=await (0,s.query)(`
    SELECT item_code, class_code, item_name, package_unit, 
           quantity_unit, tax_type, sale_price, purchase_price
    FROM items
    WHERE branch_id = $1 
    AND (UPPER(item_name) = UPPER($2) OR item_name ILIKE $3)
    ORDER BY created_at DESC
    LIMIT 1
  `,[t,e,`%${e}%`]);return r.length>0?r[0]:null}function d(t=new Date){let e=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0"),s=String(t.getHours()).padStart(2,"0"),o=String(t.getMinutes()).padStart(2,"0"),a=String(t.getSeconds()).padStart(2,"0");return`${e}${r}${n}${s}${o}${a}`}function m(t=new Date){let e=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0");return`${e}${r}${n}`}function A(t){return(Math.round(100*t)/100).toFixed(2)}async function S(t){let e=Date.now();try{let r,n=await c(t.branch_id);if(!n){let t="Branch configuration not found";return console.log(`[KRA Sales API] ${t}`),{success:!1,kraResponse:null,error:t}}if(!n.kra_pin){let t="KRA PIN not configured for this branch";return console.log(`[KRA Sales API] ${t}`),{success:!1,kraResponse:{resultCd:"CONFIG_ERROR",resultMsg:t,resultDt:new Date().toISOString()},error:t}}let s=await u(t.branch_id,t.fuel_type),l=await i(t.branch_id);if(!s){let e=`No item found for fuel type: ${t.fuel_type}`;return console.log(`[KRA Sales API] ${e}`),{success:!1,kraResponse:{resultCd:"ITEM_NOT_FOUND",resultMsg:e,resultDt:new Date().toISOString()},error:e}}let S=s.item_code,g=s.class_code||"15100000",p=s.item_name,C=s.package_unit||"NT",f=s.quantity_unit||"LTR",h=s.tax_type||"B",k=Number(s.sale_price)||0,_=t.quantity,I=_*k;console.log(`[KRA Sales API] Item lookup: ${p}, item_code: ${S}, sale_price from DB: ${k}, qty: ${_}, totAmt: ${I}`);let{taxblAmt:b,taxAmt:N,taxRt:E}=function(t,e="B"){if("A"===e){let e=t/1.16;return{taxblAmt:Math.round(100*e)/100,taxAmt:Math.round(100*(t-e))/100,taxRt:16}}return"B"===e?{taxblAmt:t,taxAmt:Math.round(.16*t*100)/100,taxRt:16}:"C"===e?{taxblAmt:t,taxAmt:Math.round(.08*t*100)/100,taxRt:8}:"D"===e||"E"===e?{taxblAmt:0,taxAmt:0,taxRt:0}:{taxblAmt:t,taxAmt:0,taxRt:0}}(I,h),T=new Date,x=d(T),w=m(T),D=y[t.payment_method?.toLowerCase()]||"01",O=`CIV-${String(l).padStart(6,"0")}`,K={tin:n.kra_pin,bhfId:n.bhf_id||"00",trdInvcNo:O,invcNo:String(l),orgInvcNo:0,custTin:t.customer_pin||null,custNm:t.customer_name||"Walk-in Customer",salesTyCd:"N",rcptTyCd:"S",pmtTyCd:D,salesSttsCd:"02",cfmDt:x,salesDt:w,stockRlsDt:x,cnclReqDt:null,cnclDt:null,rfdDt:null,rfdRsnCd:null,totItemCnt:1,taxblAmtA:"A"===h?A(b):"0.00",taxblAmtB:"B"===h?A(b):"0.00",taxblAmtC:"C"===h?A(b):"0.00",taxblAmtD:"0.00",taxblAmtE:"0.00",taxRtA:"A"===h?A(E):"0.00",taxRtB:"B"===h?A(E):"0.00",taxRtC:"C"===h?A(E):"0.00",taxRtD:"0.00",taxRtE:"0.00",taxAmtA:"A"===h?A(N):"0.00",taxAmtB:"B"===h?A(N):"0.00",taxAmtC:"C"===h?A(N):"0.00",taxAmtD:"0.00",taxAmtE:"0.00",totTaxblAmt:A(b),totTaxAmt:A(N),totAmt:A(I),prchrAcptcYn:"N",remark:null,regrNm:"Admin",regrId:"Admin",modrNm:"Admin",modrId:"Admin",receipt:{custTin:t.customer_pin||null,custMblNo:null,rcptPbctDt:null,trdeNm:null,adrs:null,topMsg:null,btmMsg:null,prchrAcptcYn:"Y"},itemList:[{itemSeq:1,itemCd:S,itemClsCd:g,itemNm:p,bcd:null,pkgUnitCd:C,pkg:1,qtyUnitCd:f,qty:parseFloat(_.toFixed(2)),prc:k,splyAmt:A(_),dcRt:0,dcAmt:0,isrccCd:null,isrccNm:null,isrcRt:0,isrcAmt:0,taxTyCd:h,taxblAmt:A(b),taxAmt:A(N),totAmt:A(I)}]},M=`${R}/trnsSales/saveSales`;console.log(`[KRA Sales API] Calling endpoint: ${M}`),console.log("[KRA Sales API] Request payload:",JSON.stringify(K,null,2));let P=200;try{let t=new AbortController,e=setTimeout(()=>t.abort(),3e4),n=await fetch(M,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(K),signal:t.signal});clearTimeout(e),P=n.status,r=await n.json(),console.log(`[KRA Sales API] HTTP Status: ${n.status}`),console.log(`[KRA Sales API] KRA Result Code: ${r.resultCd}`),console.log(`[KRA Sales API] KRA Result Message: ${r.resultMsg}`),console.log("[KRA Sales API] Response body:",JSON.stringify(r,null,2))}catch(t){P=0,r="AbortError"===t.name?{resultCd:"TIMEOUT",resultMsg:"Request timed out after 30 seconds",resultDt:new Date().toISOString()}:{resultCd:"NETWORK_ERROR",resultMsg:t.message||"Failed to connect to KRA backend",resultDt:new Date().toISOString()},console.log("[KRA Sales API] Network error:",t.message),console.log("[KRA Sales API] Response (network error):",JSON.stringify(r,null,2))}let $=Date.now()-e;await (0,o.logApiCall)({endpoint:"/trnsSales/saveSales",method:"POST",payload:K,response:r,statusCode:P||500,durationMs:$,branchId:t.branch_id,externalEndpoint:M});let v="000"===r.resultCd||"0"===r.resultCd;if(v){console.log("[KRA Sales API] saveSales successful, now syncing stock with KRA");try{let e=await (0,a.syncStockAfterSale)(t.branch_id,[{itemCode:S,itemClassCode:g,itemName:p,packageUnit:C,quantityUnit:f,quantity:_,unitPrice:k,taxType:h}]);e.success?console.log("[KRA Sales API] Stock sync completed successfully"):console.log(`[KRA Sales API] Stock sync failed: ${e.error}`)}catch(t){console.error("[KRA Sales API] Error during stock sync:",t.message)}}return{success:v,kraResponse:r}}catch(s){let r={resultCd:"SYSTEM_ERROR",resultMsg:s.message||"System error calling KRA API",resultDt:new Date().toISOString()};console.error("[KRA Sales API] System error:",s);let n=Date.now()-e;return await (0,o.logApiCall)({endpoint:"/trnsSales/saveSales",method:"POST",payload:{saleData:t,errorContext:"System error before KRA call"},response:r,statusCode:500,durationMs:n,branchId:t.branch_id,error:s.message,externalEndpoint:`${R}/trnsSales/saveSales`}),{success:!1,kraResponse:r,error:s.message}}}async function g(t){return S(t)}let C={defective:"01",wrong_item:"02",customer_request:"03",price_error:"04",duplicate:"05",other:"06"};async function p(t){let e=Date.now();try{let r,n=await c(t.branch_id);if(!n)return{success:!1,kraResponse:null,error:"Branch configuration not found"};if(!n.kra_pin)return{success:!1,kraResponse:{resultCd:"CONFIG_ERROR",resultMsg:"KRA PIN not configured for this branch",resultDt:new Date().toISOString()},error:"KRA PIN not configured"};let s=await i(t.branch_id),l=`CR${s}`,u=new Date,S=d(u),g=m(u),p=C[t.refund_reason_code?.toLowerCase()]||"06",y=0,f=0,h=0,k=t.items.map((t,e)=>{let r=t.quantity*t.price,n=r/1.16,s=r-n;return y+=n,f+=s,h+=r,{itemSeq:e+1,itemCd:t.item_code,itemClsCd:t.item_class_code||"99013001",itemNm:t.item_name,bcd:null,pkgUnitCd:t.package_unit||"BF",pkg:t.quantity,qtyUnitCd:t.quantity_unit||"L",qty:t.quantity,prc:t.price,splyAmt:A(r),dcRt:0,dcAmt:0,isrccCd:null,isrccNm:null,isrcRt:null,isrcAmt:null,taxTyCd:t.tax_type||"B",taxblAmt:A(n),taxAmt:A(s),totAmt:A(r)}}),_={tin:n.kra_pin,bhfId:n.bhf_id||"00",trdInvcNo:l,invcNo:s,orgInvcNo:t.original_invoice_no,custTin:t.customer_tin||null,custNm:t.customer_name||"Walk-in Customer",salesTyCd:"N",rcptTyCd:"R",pmtTyCd:"01",salesSttsCd:"02",cfmDt:S,salesDt:g,stockRlsDt:S,cnclReqDt:null,cnclDt:null,rfdDt:S,rfdRsnCd:p,totItemCnt:k.length,taxblAmtA:"0.00",taxblAmtB:A(y),taxblAmtC:"0.00",taxblAmtD:"0.00",taxblAmtE:"0.00",taxRtA:"0.00",taxRtB:"16.00",taxRtC:"0.00",taxRtD:"0.00",taxRtE:"0.00",taxAmtA:"0.00",taxAmtB:A(f),taxAmtC:"0.00",taxAmtD:"0.00",taxAmtE:"0.00",totTaxblAmt:A(y),totTaxAmt:A(f),totAmt:A(h),prchrAcptcYn:"N",remark:null,regrNm:"Admin",regrId:"Admin",modrNm:"Admin",modrId:"Admin",receipt:{custTin:t.customer_tin||null,custMblNo:null,rcptPbctDt:S,trdeNm:null,adrs:null,topMsg:null,btmMsg:null,prchrAcptcYn:"N"},itemList:k},I=`${R}/trnsSales/saveSales`;console.log(`[KRA Credit Note API] Calling endpoint: ${I}`),console.log("[KRA Credit Note API] Request payload:",JSON.stringify(_,null,2));let b=200;try{let t=new AbortController,e=setTimeout(()=>t.abort(),3e4),n=await fetch(I,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(_),signal:t.signal});clearTimeout(e),b=n.status,r=await n.json(),console.log(`[KRA Credit Note API] HTTP Status: ${n.status}`),console.log("[KRA Credit Note API] Response:",JSON.stringify(r,null,2))}catch(t){b=0,r={resultCd:"AbortError"===t.name?"TIMEOUT":"NETWORK_ERROR",resultMsg:t.message||"Failed to connect to KRA backend",resultDt:new Date().toISOString()},console.log("[KRA Credit Note API] Network error:",t.message)}let N=Date.now()-e;await (0,o.logApiCall)({endpoint:"/trnsSales/saveSales",method:"POST",payload:_,response:r,statusCode:b||500,durationMs:N,branchId:t.branch_id,externalEndpoint:I});let E="000"===r.resultCd||"0"===r.resultCd;if(E){console.log("[KRA Credit Note API] saveSales successful for credit note, now syncing stock with KRA");try{let e=t.items.map(t=>({itemCode:t.item_code,itemClassCode:t.item_class_code,itemName:t.item_name,packageUnit:t.package_unit,quantityUnit:t.quantity_unit,quantity:t.quantity,unitPrice:t.price,taxType:t.tax_type})),r=await (0,a.syncStockAfterCreditNote)(t.branch_id,e);r.success?console.log("[KRA Credit Note API] Stock sync completed successfully for credit note"):console.log(`[KRA Credit Note API] Stock sync failed for credit note: ${r.error}`)}catch(t){console.error("[KRA Credit Note API] Error during stock sync for credit note:",t.message)}}return{success:E,kraResponse:r,creditNoteNumber:l,invcNo:s}}catch(t){return console.error("[KRA Credit Note API] System error:",t),{success:!1,kraResponse:{resultCd:"SYSTEM_ERROR",resultMsg:t.message||"System error calling KRA API",resultDt:new Date().toISOString()},error:t.message}}}t.s(["callKraCreditNote",()=>p,"callKraSaveSales",()=>S,"callKraTestSalesEndpoint",()=>g]),r()}catch(t){r(t)}},!1)];

//# sourceMappingURL=lib_71866a19._.js.map