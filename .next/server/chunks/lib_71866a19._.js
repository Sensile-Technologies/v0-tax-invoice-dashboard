module.exports=[99745,t=>t.a(async(e,r)=>{try{var s=t.i(70038),n=t.i(90793),o=t.i(57902),a=t.i(65488),l=e([s,n,o]);async function i(t){let e=await (0,n.query)(`
    SELECT b.kra_pin as tin, b.bhf_id, 
           COALESCE(b.server_address, '5.189.171.160') as server_address, 
           COALESCE(b.server_port, '8088') as server_port
    FROM branches b
    WHERE b.id = $1
  `,[t]);return 0!==e.length&&e[0].tin?{tin:e[0].tin,bhfId:e[0].bhf_id||"00",serverAddress:e[0].server_address,serverPort:e[0].server_port}:null}async function c(t){let e=await (0,n.query)(`
    UPDATE branches 
    SET sr_number = COALESCE(sr_number, 0) + 1,
        updated_at = NOW()
    WHERE id = $1
    RETURNING sr_number
  `,[t]);if(0===e.length)throw Error(`Branch ${t} not found`);return e[0].sr_number}function u(t){return(Math.round(100*t)/100).toFixed(2)}async function d(t,e,r){let s,n=Date.now(),l=await i(t);if(!l)return{success:!1,response:{resultCd:"CONFIG_ERROR",resultMsg:"Branch KRA info not configured"},sarNo:0};let d={tin:l.tin,bhfId:l.bhfId},m=(0,a.buildKraBaseUrl)(l.serverAddress,l.serverPort),A=await c(t),S=0,g=0,p=0,R=r.map((t,e)=>{let r=Math.round(t.quantity*t.unitPrice*100)/100,s=function(t,e="B"){return"B"===e?Math.round(.16*t*100)/100:"A"===e?Math.round(t/1.16*16)/100:"C"===e?Math.round(.08*t*100)/100:0}(r,t.taxType);return S+=r,g+=s,p+=r,{itemSeq:e+1,itemCd:t.itemCode,itemClsCd:t.itemClassCode||"15100000",itemNm:t.itemName,bcd:null,pkgUnitCd:t.packageUnit||"NT",pkg:Math.ceil(t.quantity),qtyUnitCd:t.quantityUnit||"LTR",qty:parseFloat(t.quantity.toFixed(2)),itemExprDt:null,prc:t.unitPrice,splyAmt:u(r),totDcAmt:0,taxblAmt:u(r),taxTyCd:t.taxType||"B",taxAmt:u(s),totAmt:u(r)}}),y={tin:d.tin,bhfId:d.bhfId,sarNo:A,orgSarNo:0,regTyCd:"M",custTin:null,custNm:null,custBhfId:null,sarTyCd:e,ocrnDt:function(t=new Date){let e=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0");return`${e}${r}${s}`}(),totItemCnt:R.length,totTaxblAmt:u(S),totTaxAmt:u(g),totAmt:u(p),remark:null,regrId:"Admin",regrNm:"Admin",modrNm:"Admin",modrId:"Admin",itemList:R};console.log(`[KRA Stock Sync] Calling saveStockItems with sarTyCd=${e}`),console.log("[KRA Stock Sync] Payload:",JSON.stringify(y,null,2));let C=200;try{let t=new AbortController,e=setTimeout(()=>t.abort(),15e3),r=await fetch(`${m}/stock/saveStockItems`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(y),signal:t.signal});clearTimeout(e),C=r.status,s=await r.json()}catch(t){s={resultCd:"AbortError"===t.name?"TIMEOUT":"NETWORK_ERROR",resultMsg:t.message||"Failed to connect to KRA",resultDt:new Date().toISOString()},C=0}let f=Date.now()-n;return console.log(`[KRA Stock Sync] saveStockItems response (${f}ms):`,JSON.stringify(s,null,2)),await (0,o.logApiCall)({endpoint:"/stock/saveStockItems",method:"POST",payload:y,response:s,statusCode:C,durationMs:f,branchId:t,externalEndpoint:`${m}/stock/saveStockItems`}),{success:s?.resultCd==="000"||s?.resultCd==="0",response:s,sarNo:A}}async function m(t,e){let r,s=Date.now(),l=await i(t);if(!l)return{success:!1,response:{resultCd:"CONFIG_ERROR",resultMsg:"Branch KRA info not configured"}};let c={tin:l.tin,bhfId:l.bhfId},u=(0,a.buildKraBaseUrl)(l.serverAddress,l.serverPort),d=await (0,n.query)(`
    SELECT t.current_stock 
    FROM tanks t
    JOIN items i ON UPPER(t.fuel_type) = UPPER(i.item_name) AND i.branch_id = t.branch_id
    WHERE i.item_code = $1 AND t.branch_id = $2
    LIMIT 1
  `,[e,t]),m=d.length>0&&parseFloat(d[0].current_stock)||0,A={tin:c.tin,bhfId:c.bhfId,itemCd:e,rsdQty:m,regrId:"Admin",regrNm:"Admin",modrNm:"Admin",modrId:"Admin"};console.log(`[KRA Stock Sync] Calling saveStockMaster for item ${e}`),console.log("[KRA Stock Sync] Payload:",JSON.stringify(A,null,2));let S=200;try{let t=new AbortController,e=setTimeout(()=>t.abort(),15e3),s=await fetch(`${u}/stockMaster/saveStockMaster`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(A),signal:t.signal});clearTimeout(e),S=s.status,r=await s.json()}catch(t){r={resultCd:"AbortError"===t.name?"TIMEOUT":"NETWORK_ERROR",resultMsg:t.message||"Failed to connect to KRA",resultDt:new Date().toISOString()},S=0}let g=Date.now()-s;return console.log(`[KRA Stock Sync] saveStockMaster response for ${e} (${g}ms):`,JSON.stringify(r,null,2)),await (0,o.logApiCall)({endpoint:"/stockMaster/saveStockMaster",method:"POST",payload:A,response:r,statusCode:S,durationMs:g,branchId:t,externalEndpoint:`${u}/stockMaster/saveStockMaster`}),{success:r?.resultCd==="000"||r?.resultCd==="0",response:r}}async function A(t,e){try{console.log(`[KRA Stock Sync] Starting stock sync after sale for branch ${t}`);let r=await d(t,"11",e);if(!r.success)return console.log("[KRA Stock Sync] saveStockItems failed, skipping saveStockMaster"),{success:!1,saveStockItemsResponse:r.response,error:r.response?.resultMsg||"saveStockItems failed"};let s=[];for(let r of e){let e=await m(t,r.itemCode);s.push({itemCode:r.itemCode,...e})}return console.log("[KRA Stock Sync] Stock sync after sale completed successfully"),{success:!0,saveStockItemsResponse:r.response,saveStockMasterResponses:s}}catch(t){return console.error("[KRA Stock Sync] Error during stock sync after sale:",t),{success:!1,error:t.message||"Internal error during stock sync"}}}async function S(t,e){try{console.log(`[KRA Stock Sync] Starting stock sync after credit note for branch ${t}`);let r=await d(t,"03",e);if(!r.success)return console.log("[KRA Stock Sync] saveStockItems failed for credit note, skipping saveStockMaster"),{success:!1,saveStockItemsResponse:r.response,error:r.response?.resultMsg||"saveStockItems failed"};let s=[];for(let r of e){let e=await m(t,r.itemCode);s.push({itemCode:r.itemCode,...e})}return console.log("[KRA Stock Sync] Stock sync after credit note completed successfully"),{success:!0,saveStockItemsResponse:r.response,saveStockMasterResponses:s}}catch(t){return console.error("[KRA Stock Sync] Error during stock sync after credit note:",t),{success:!1,error:t.message||"Internal error during stock sync"}}}[s,n,o]=l.then?(await l)():l,process.env.KRA_VSCU_URL,t.s(["syncStockAfterCreditNote",()=>S,"syncStockAfterSale",()=>A]),r()}catch(t){r(t)}},!1),39298,t=>t.a(async(e,r)=>{try{var s=t.i(70038),n=t.i(90793),o=t.i(57902),a=t.i(99745),l=t.i(65488),i=e([s,n,o,a]);[s,n,o,a]=i.then?(await i)():i;let y=process.env.KRA_VSCU_URL||"http://5.189.171.160:8088",C={cash:"01",credit:"02",mobile_money:"03",mpesa:"03",bank_transfer:"04",card:"05",cheque:"06",other:"07"};async function c(t){try{let e=await (0,n.query)(`
      SELECT id, bhf_id, kra_pin, device_token, server_address, server_port, COALESCE(invoice_number, 0) as invoice_number
      FROM branches
      WHERE id = $1
    `,[t]);if(0===e.length)return null;return e[0]}catch(t){return console.error("[KRA Sales API] Error fetching branch config:",t),null}}async function u(t){let e=await (0,n.query)(`
    UPDATE branches 
    SET invoice_number = COALESCE(invoice_number, 0) + 1 
    WHERE id = $1 
    RETURNING invoice_number
  `,[t]);return e[0]?.invoice_number||1}async function d(t,e){let r=await (0,n.query)(`
    SELECT i.item_code, i.class_code, i.item_name, i.package_unit, 
           i.quantity_unit, i.tax_type, 
           COALESCE(bi.sale_price, i.sale_price) as sale_price, 
           COALESCE(bi.purchase_price, i.purchase_price) as purchase_price
    FROM items i
    LEFT JOIN branch_items bi ON i.id = bi.item_id AND bi.branch_id = $1
    WHERE (i.branch_id = $1 OR (i.branch_id IS NULL AND bi.branch_id = $1))
    AND (UPPER(i.item_name) = UPPER($2) OR i.item_name ILIKE $3)
    ORDER BY i.created_at DESC
    LIMIT 1
  `,[t,e,`%${e}%`]);return r.length>0?r[0]:null}function m(t=new Date){let e=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0"),n=String(t.getHours()).padStart(2,"0"),o=String(t.getMinutes()).padStart(2,"0"),a=String(t.getSeconds()).padStart(2,"0");return`${e}${r}${s}${n}${o}${a}`}function A(t=new Date){let e=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0");return`${e}${r}${s}`}function S(t){return(Math.round(100*t)/100).toFixed(2)}async function g(t){let e=Date.now();try{let r,s=await c(t.branch_id);if(!s){let t="Branch configuration not found";return console.log(`[KRA Sales API] ${t}`),{success:!1,kraResponse:null,error:t}}if(!s.kra_pin){let t="KRA PIN not configured for this branch";return console.log(`[KRA Sales API] ${t}`),{success:!1,kraResponse:{resultCd:"CONFIG_ERROR",resultMsg:t,resultDt:new Date().toISOString()},error:t}}let n=await d(t.branch_id,t.fuel_type),i=await u(t.branch_id);if(!n){let e=`No item found for fuel type: ${t.fuel_type}`;return console.log(`[KRA Sales API] ${e}`),{success:!1,kraResponse:{resultCd:"ITEM_NOT_FOUND",resultMsg:e,resultDt:new Date().toISOString()},error:e}}let g=n.item_code,p=n.class_code||"15100000",R=n.item_name,y=n.package_unit||"NT",f=n.quantity_unit||"LTR",_=n.tax_type||"B",h=Number(n.sale_price)||0,b=t.quantity,k=b*h;console.log(`[KRA Sales API] Item lookup: ${R}, item_code: ${g}, sale_price from DB: ${h}, qty: ${b}, totAmt: ${k}`);let{taxblAmt:I,taxAmt:N,taxRt:E}=function(t,e="B"){if("A"===e){let e=t/1.16;return{taxblAmt:Math.round(100*e)/100,taxAmt:Math.round(100*(t-e))/100,taxRt:16}}return"B"===e?{taxblAmt:t,taxAmt:Math.round(.16*t*100)/100,taxRt:16}:"C"===e?{taxblAmt:t,taxAmt:Math.round(.08*t*100)/100,taxRt:8}:"D"===e||"E"===e?{taxblAmt:0,taxAmt:0,taxRt:0}:{taxblAmt:t,taxAmt:0,taxRt:0}}(k,_),T=new Date,x=m(T),v=A(T),w=C[t.payment_method?.toLowerCase()]||"01",O=`CIV-${String(i).padStart(6,"0")}`,D={tin:s.kra_pin,bhfId:s.bhf_id||"00",trdInvcNo:O,invcNo:String(i),orgInvcNo:0,custTin:t.customer_pin||null,custNm:t.customer_name||"Walk-in Customer",salesTyCd:"N",rcptTyCd:"S",pmtTyCd:w,salesSttsCd:"02",cfmDt:x,salesDt:v,stockRlsDt:x,cnclReqDt:null,cnclDt:null,rfdDt:null,rfdRsnCd:null,totItemCnt:1,taxblAmtA:"A"===_?S(I):"0.00",taxblAmtB:"B"===_?S(I):"0.00",taxblAmtC:"C"===_?S(I):"0.00",taxblAmtD:"0.00",taxblAmtE:"0.00",taxRtA:"A"===_?S(E):"0.00",taxRtB:"B"===_?S(E):"0.00",taxRtC:"C"===_?S(E):"0.00",taxRtD:"0.00",taxRtE:"0.00",taxAmtA:"A"===_?S(N):"0.00",taxAmtB:"B"===_?S(N):"0.00",taxAmtC:"C"===_?S(N):"0.00",taxAmtD:"0.00",taxAmtE:"0.00",totTaxblAmt:S(I),totTaxAmt:S(N),totAmt:S(k),prchrAcptcYn:"N",remark:null,regrNm:"Admin",regrId:"Admin",modrNm:"Admin",modrId:"Admin",receipt:{custTin:t.customer_pin||null,custMblNo:null,rcptPbctDt:null,trdeNm:null,adrs:null,topMsg:null,btmMsg:null,prchrAcptcYn:"Y"},itemList:[{itemSeq:1,itemCd:g,itemClsCd:p,itemNm:R,bcd:null,pkgUnitCd:y,pkg:1,qtyUnitCd:f,qty:parseFloat(b.toFixed(2)),prc:h,splyAmt:S(b),dcRt:0,dcAmt:0,isrccCd:null,isrccNm:null,isrcRt:0,isrcAmt:0,taxTyCd:_,taxblAmt:S(I),taxAmt:S(N),totAmt:S(k)}]},K=(0,l.buildKraBaseUrl)(s.server_address,s.server_port),M=`${K}/trnsSales/saveSales`;console.log(`[KRA Sales API] Calling endpoint: ${M}`),console.log("[KRA Sales API] Request payload:",JSON.stringify(D,null,2));let P=200;try{let t=new AbortController,e=setTimeout(()=>t.abort(),3e4),n=await fetch(M,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...s.device_token?{DeviceSerialNo:s.device_token}:{}},body:JSON.stringify(D),signal:t.signal});clearTimeout(e),P=n.status,r=await n.json(),console.log(`[KRA Sales API] HTTP Status: ${n.status}`),console.log(`[KRA Sales API] KRA Result Code: ${r.resultCd}`),console.log(`[KRA Sales API] KRA Result Message: ${r.resultMsg}`),console.log("[KRA Sales API] Response body:",JSON.stringify(r,null,2))}catch(t){P=0,r="AbortError"===t.name?{resultCd:"TIMEOUT",resultMsg:"Request timed out after 30 seconds",resultDt:new Date().toISOString()}:{resultCd:"NETWORK_ERROR",resultMsg:t.message||"Failed to connect to KRA backend",resultDt:new Date().toISOString()},console.log("[KRA Sales API] Network error:",t.message),console.log("[KRA Sales API] Response (network error):",JSON.stringify(r,null,2))}let $=Date.now()-e,q="000"===r.resultCd||"0"===r.resultCd;if(await (0,o.logApiCall)({endpoint:"/trnsSales/saveSales",method:"POST",payload:D,response:r,statusCode:P||500,durationMs:$,branchId:t.branch_id,externalEndpoint:M}),q){console.log("[KRA Sales API] saveSales successful, now syncing stock with KRA");try{let e=await (0,a.syncStockAfterSale)(t.branch_id,[{itemCode:g,itemClassCode:p,itemName:R,packageUnit:y,quantityUnit:f,quantity:b,unitPrice:h,taxType:_}]);e.success?console.log("[KRA Sales API] Stock sync completed successfully"):console.log(`[KRA Sales API] Stock sync failed: ${e.error}`)}catch(t){console.error("[KRA Sales API] Error during stock sync:",t.message)}}return{success:q,kraResponse:r}}catch(n){let r={resultCd:"SYSTEM_ERROR",resultMsg:n.message||"System error calling KRA API",resultDt:new Date().toISOString()};console.error("[KRA Sales API] System error:",n);let s=Date.now()-e;return await (0,o.logApiCall)({endpoint:"/trnsSales/saveSales",method:"POST",payload:{saleData:t,errorContext:"System error before KRA call"},response:r,statusCode:500,durationMs:s,branchId:t.branch_id,error:n.message,externalEndpoint:`${y}/trnsSales/saveSales`}),{success:!1,kraResponse:r,error:n.message}}}async function p(t){return g(t)}let f={defective:"01",wrong_item:"02",customer_request:"03",price_error:"04",duplicate:"05",other:"06"};async function R(t){let e=Date.now();try{let r,s=await c(t.branch_id);if(!s)return{success:!1,kraResponse:null,error:"Branch configuration not found"};if(!s.kra_pin)return{success:!1,kraResponse:{resultCd:"CONFIG_ERROR",resultMsg:"KRA PIN not configured for this branch",resultDt:new Date().toISOString()},error:"KRA PIN not configured"};let n=await u(t.branch_id),i=`CR${n}`,d=new Date,g=m(d),p=A(d),R=f[t.refund_reason_code?.toLowerCase()]||"06",y=0,C=0,_=0,h=t.items.map((t,e)=>{let r=t.quantity*t.price,s=r/1.16,n=r-s;return y+=s,C+=n,_+=r,{itemSeq:e+1,itemCd:t.item_code,itemClsCd:t.item_class_code||"99013001",itemNm:t.item_name,bcd:null,pkgUnitCd:t.package_unit||"BF",pkg:t.quantity,qtyUnitCd:t.quantity_unit||"L",qty:t.quantity,prc:t.price,splyAmt:S(r),dcRt:0,dcAmt:0,isrccCd:null,isrccNm:null,isrcRt:null,isrcAmt:null,taxTyCd:t.tax_type||"B",taxblAmt:S(s),taxAmt:S(n),totAmt:S(r)}}),b={tin:s.kra_pin,bhfId:s.bhf_id||"00",trdInvcNo:i,invcNo:n,orgInvcNo:t.original_invoice_no,custTin:t.customer_tin||null,custNm:t.customer_name||"Walk-in Customer",salesTyCd:"N",rcptTyCd:"R",pmtTyCd:"01",salesSttsCd:"02",cfmDt:g,salesDt:p,stockRlsDt:g,cnclReqDt:null,cnclDt:null,rfdDt:g,rfdRsnCd:R,totItemCnt:h.length,taxblAmtA:"0.00",taxblAmtB:S(y),taxblAmtC:"0.00",taxblAmtD:"0.00",taxblAmtE:"0.00",taxRtA:"0.00",taxRtB:"16.00",taxRtC:"0.00",taxRtD:"0.00",taxRtE:"0.00",taxAmtA:"0.00",taxAmtB:S(C),taxAmtC:"0.00",taxAmtD:"0.00",taxAmtE:"0.00",totTaxblAmt:S(y),totTaxAmt:S(C),totAmt:S(_),prchrAcptcYn:"N",remark:null,regrNm:"Admin",regrId:"Admin",modrNm:"Admin",modrId:"Admin",receipt:{custTin:t.customer_tin||null,custMblNo:null,rcptPbctDt:g,trdeNm:null,adrs:null,topMsg:null,btmMsg:null,prchrAcptcYn:"N"},itemList:h},k=(0,l.buildKraBaseUrl)(s.server_address,s.server_port),I=`${k}/trnsSales/saveSales`;console.log(`[KRA Credit Note API] Calling endpoint: ${I}`),console.log("[KRA Credit Note API] Request payload:",JSON.stringify(b,null,2));let N=200;try{let t=new AbortController,e=setTimeout(()=>t.abort(),3e4),n=await fetch(I,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json",...s.device_token?{DeviceSerialNo:s.device_token}:{}},body:JSON.stringify(b),signal:t.signal});clearTimeout(e),N=n.status,r=await n.json(),console.log(`[KRA Credit Note API] HTTP Status: ${n.status}`),console.log("[KRA Credit Note API] Response:",JSON.stringify(r,null,2))}catch(t){N=0,r={resultCd:"AbortError"===t.name?"TIMEOUT":"NETWORK_ERROR",resultMsg:t.message||"Failed to connect to KRA backend",resultDt:new Date().toISOString()},console.log("[KRA Credit Note API] Network error:",t.message)}let E=Date.now()-e;await (0,o.logApiCall)({endpoint:"/trnsSales/saveSales",method:"POST",payload:b,response:r,statusCode:N||500,durationMs:E,branchId:t.branch_id,externalEndpoint:I});let T="000"===r.resultCd||"0"===r.resultCd;if(T){console.log("[KRA Credit Note API] saveSales successful for credit note, now syncing stock with KRA");try{let e=t.items.map(t=>({itemCode:t.item_code,itemClassCode:t.item_class_code,itemName:t.item_name,packageUnit:t.package_unit,quantityUnit:t.quantity_unit,quantity:t.quantity,unitPrice:t.price,taxType:t.tax_type})),r=await (0,a.syncStockAfterCreditNote)(t.branch_id,e);r.success?console.log("[KRA Credit Note API] Stock sync completed successfully for credit note"):console.log(`[KRA Credit Note API] Stock sync failed for credit note: ${r.error}`)}catch(t){console.error("[KRA Credit Note API] Error during stock sync for credit note:",t.message)}}return{success:T,kraResponse:r,creditNoteNumber:i,invcNo:n}}catch(t){return console.error("[KRA Credit Note API] System error:",t),{success:!1,kraResponse:{resultCd:"SYSTEM_ERROR",resultMsg:t.message||"System error calling KRA API",resultDt:new Date().toISOString()},error:t.message}}}t.s(["callKraCreditNote",()=>R,"callKraSaveSales",()=>g,"callKraTestSalesEndpoint",()=>p]),r()}catch(t){r(t)}},!1)];

//# sourceMappingURL=lib_71866a19._.js.map