{"version":3,"sources":["../../../lib/db/client.ts","../../../lib/db/index.ts","../../../lib/kra-url-helper.ts","../../../lib/api-logger.ts"],"sourcesContent":["import { Pool } from 'pg';\n\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  ssl: process.env.NODE_ENV === 'production' ? { rejectUnauthorized: false } : false,\n});\n\nexport async function query<T = any>(text: string, params?: any[]): Promise<T[]> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rows as T[];\n  } finally {\n    client.release();\n  }\n}\n\nexport async function queryOne<T = any>(text: string, params?: any[]): Promise<T | null> {\n  const rows = await query<T>(text, params);\n  return rows[0] || null;\n}\n\nexport async function execute(text: string, params?: any[]): Promise<number> {\n  const client = await pool.connect();\n  try {\n    const result = await client.query(text, params);\n    return result.rowCount || 0;\n  } finally {\n    client.release();\n  }\n}\n\nexport async function getClient() {\n  return await pool.connect();\n}\n\nexport { pool };\n","export * from './client';\n","export function buildKraBaseUrl(\n  serverAddress: string | null | undefined,\n  serverPort: string | null | undefined\n): string {\n  const DEFAULT_SERVER = '5.189.171.160'\n  const DEFAULT_PORT = '8088'\n  \n  if (!serverAddress) {\n    return `http://${DEFAULT_SERVER}:${serverPort || DEFAULT_PORT}`\n  }\n  \n  let address = serverAddress.trim()\n  \n  const hasScheme = /^https?:\\/\\//i.test(address)\n  if (hasScheme) {\n    address = address.replace(/^https?:\\/\\//i, '')\n  }\n  \n  address = address.replace(/\\/+$/, '')\n  \n  const hasPort = /:\\d+$/.test(address)\n  \n  if (hasPort) {\n    return `http://${address}`\n  }\n  \n  return `http://${address}:${serverPort || DEFAULT_PORT}`\n}\n","import { query } from \"@/lib/db\"\n\nexport interface ApiLogEntry {\n  endpoint: string\n  method: string\n  payload?: any\n  response?: any\n  statusCode?: number\n  error?: string\n  durationMs?: number\n  branchId?: string\n  externalEndpoint?: string\n  logType?: string\n}\n\nfunction deriveLogType(endpoint: string): string {\n  if (endpoint.includes('saveSales')) return 'kra_save_sales'\n  if (endpoint.includes('saveStockItems')) return 'kra_stock_items'\n  if (endpoint.includes('saveStockMaster')) return 'kra_stock_master'\n  if (endpoint.includes('selectInitInfo')) return 'kra_initialize'\n  if (endpoint.includes('saveItem')) return 'kra_save_item'\n  return 'kra_api'\n}\n\nfunction deriveStatus(response: any, statusCode?: number, error?: string): string {\n  if (error) return 'error'\n  if (!response) return 'error'\n  if (response.resultCd === '000' || response.resultCd === '0') return 'success'\n  if (statusCode && statusCode >= 200 && statusCode < 300 && !response.resultCd) return 'success'\n  return 'error'\n}\n\nexport async function logApiCall(entry: ApiLogEntry) {\n  if (!entry.branchId) {\n    console.warn(\"[API Logger] No branchId provided, skipping log\")\n    return\n  }\n\n  try {\n    const logType = entry.logType || deriveLogType(entry.endpoint)\n    const status = deriveStatus(entry.response, entry.statusCode, entry.error)\n\n    console.log(`[API Logger] Logging ${entry.endpoint} for branch ${entry.branchId} with status ${status}`)\n\n    await query(`\n      INSERT INTO branch_logs (branch_id, log_type, endpoint, request_payload, response_payload, status)\n      VALUES ($1, $2, $3, $4, $5, $6)\n    `, [\n      entry.branchId,\n      logType,\n      entry.endpoint,\n      JSON.stringify(entry.payload || {}),\n      JSON.stringify(entry.response || { error: entry.error }),\n      status\n    ])\n    \n    console.log(`[API Logger] Successfully logged ${entry.endpoint}`)\n  } catch (error) {\n    console.error(\"[API Logger] Failed to log API call:\", error)\n    console.error(\"[API Logger] Entry was:\", JSON.stringify({\n      branchId: entry.branchId,\n      endpoint: entry.endpoint,\n      statusCode: entry.statusCode\n    }))\n  }\n}\n\nexport function createApiLogger(endpoint: string, method = \"POST\") {\n  const startTime = Date.now()\n\n  return {\n    success: async (payload: any, response: any, branchId?: string, externalEndpoint?: string) => {\n      const duration = Date.now() - startTime\n      await logApiCall({\n        endpoint,\n        method,\n        payload,\n        response,\n        statusCode: 200,\n        durationMs: duration,\n        branchId,\n        externalEndpoint,\n      })\n    },\n    error: async (payload: any, error: any, statusCode = 500, branchId?: string, externalEndpoint?: string) => {\n      const duration = Date.now() - startTime\n      await logApiCall({\n        endpoint,\n        method,\n        payload,\n        error: error?.message || String(error),\n        statusCode,\n        durationMs: duration,\n        branchId,\n        externalEndpoint,\n      })\n    },\n  }\n}\n"],"names":[],"mappings":"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"}